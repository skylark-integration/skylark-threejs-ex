/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
!function(e,t){var r=t.define,require=t.require,a="function"==typeof r&&r.amd,n=!a&&"undefined"!=typeof exports;if(!a&&!r){var i={};r=t.define=function(e,t,r){"function"==typeof r?(i[e]={factory:r,deps:t.map(function(t){return function(e,t){if("."!==e[0])return e;var r=t.split("/"),a=e.split("/");r.pop();for(var n=0;n<a.length;n++)"."!=a[n]&&(".."==a[n]?r.pop():r.push(a[n]));return r.join("/")}(t,e)}),resolved:!1,exports:null},require(e)):i[e]={factory:null,resolved:!0,exports:r}},require=t.require=function(e){if(!i.hasOwnProperty(e))throw new Error("Module "+e+" has not been defined");var module=i[e];if(!module.resolved){var r=[];module.deps.forEach(function(e){r.push(require(e))}),module.exports=module.factory.apply(t,r)||null,module.resolved=!0}return module.exports}}if(!r)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(e,require){e("skylark-threejs-ex/shaders/CopyShader",["skylark-threejs"],function(e){return e.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tgl_FragColor = opacity * texel;","}"].join("\n")},e.CopyShader}),e("skylark-threejs-ex/shaders/BokehShader",["skylark-threejs"],function(e){return e.BokehShader={defines:{DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{tColor:{value:null},tDepth:{value:null},focus:{value:1},aspect:{value:1},aperture:{value:.025},maxblur:{value:1},nearClip:{value:1},farClip:{value:1e3}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","varying vec2 vUv;","uniform sampler2D tColor;","uniform sampler2D tDepth;","uniform float maxblur;","uniform float aperture;","uniform float nearClip;","uniform float farClip;","uniform float focus;","uniform float aspect;","#include <packing>","float getDepth( const in vec2 screenPosition ) {","\t#if DEPTH_PACKING == 1","\treturn unpackRGBAToDepth( texture2D( tDepth, screenPosition ) );","\t#else","\treturn texture2D( tDepth, screenPosition ).x;","\t#endif","}","float getViewZ( const in float depth ) {","\t#if PERSPECTIVE_CAMERA == 1","\treturn perspectiveDepthToViewZ( depth, nearClip, farClip );","\t#else","\treturn orthographicDepthToViewZ( depth, nearClip, farClip );","\t#endif","}","void main() {","\tvec2 aspectcorrect = vec2( 1.0, aspect );","\tfloat viewZ = getViewZ( getDepth( vUv ) );","\tfloat factor = ( focus + viewZ );","\tvec2 dofblur = vec2 ( clamp( factor * aperture, -maxblur, maxblur ) );","\tvec2 dofblur9 = dofblur * 0.9;","\tvec2 dofblur7 = dofblur * 0.7;","\tvec2 dofblur4 = dofblur * 0.4;","\tvec4 col = vec4( 0.0 );","\tcol += texture2D( tColor, vUv.xy );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur7 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur7 );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur7 );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur7 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur4 );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","\tcol += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","\tcol += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur4 );","\tgl_FragColor = col / 41.0;","\tgl_FragColor.a = 1.0;","}"].join("\n")},e.BokehShader}),e("skylark-threejs-ex/shaders/SAOShader",["skylark-threejs"],function(e){return e.SAOShader={defines:{NUM_SAMPLES:7,NUM_RINGS:4,NORMAL_TEXTURE:0,DIFFUSE_TEXTURE:0,DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},tDiffuse:{value:null},tNormal:{value:null},size:{value:new e.Vector2(512,512)},cameraNear:{value:1},cameraFar:{value:100},cameraProjectionMatrix:{value:new e.Matrix4},cameraInverseProjectionMatrix:{value:new e.Matrix4},scale:{value:1},intensity:{value:.1},bias:{value:.5},minResolution:{value:0},kernelRadius:{value:100},randomSeed:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","varying vec2 vUv;","#if DIFFUSE_TEXTURE == 1","uniform sampler2D tDiffuse;","#endif","uniform sampler2D tDepth;","#if NORMAL_TEXTURE == 1","uniform sampler2D tNormal;","#endif","uniform float cameraNear;","uniform float cameraFar;","uniform mat4 cameraProjectionMatrix;","uniform mat4 cameraInverseProjectionMatrix;","uniform float scale;","uniform float intensity;","uniform float bias;","uniform float kernelRadius;","uniform float minResolution;","uniform vec2 size;","uniform float randomSeed;","// RGBA depth","#include <packing>","vec4 getDefaultColor( const in vec2 screenPosition ) {","\t#if DIFFUSE_TEXTURE == 1","\treturn texture2D( tDiffuse, vUv );","\t#else","\treturn vec4( 1.0 );","\t#endif","}","float getDepth( const in vec2 screenPosition ) {","\t#if DEPTH_PACKING == 1","\treturn unpackRGBAToDepth( texture2D( tDepth, screenPosition ) );","\t#else","\treturn texture2D( tDepth, screenPosition ).x;","\t#endif","}","float getViewZ( const in float depth ) {","\t#if PERSPECTIVE_CAMERA == 1","\treturn perspectiveDepthToViewZ( depth, cameraNear, cameraFar );","\t#else","\treturn orthographicDepthToViewZ( depth, cameraNear, cameraFar );","\t#endif","}","vec3 getViewPosition( const in vec2 screenPosition, const in float depth, const in float viewZ ) {","\tfloat clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];","\tvec4 clipPosition = vec4( ( vec3( screenPosition, depth ) - 0.5 ) * 2.0, 1.0 );","\tclipPosition *= clipW; // unprojection.","\treturn ( cameraInverseProjectionMatrix * clipPosition ).xyz;","}","vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPosition ) {","\t#if NORMAL_TEXTURE == 1","\treturn unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );","\t#else","\treturn normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );","\t#endif","}","float scaleDividedByCameraFar;","float minResolutionMultipliedByCameraFar;","float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {","\tvec3 viewDelta = sampleViewPosition - centerViewPosition;","\tfloat viewDistance = length( viewDelta );","\tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;","\treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - bias) / (1.0 + pow2( scaledScreenDistance ) );","}","// moving costly divides into consts","const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );","const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );","float getAmbientOcclusion( const in vec3 centerViewPosition ) {","\t// precompute some variables require in getOcclusion.","\tscaleDividedByCameraFar = scale / cameraFar;","\tminResolutionMultipliedByCameraFar = minResolution * cameraFar;","\tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUv );","\t// jsfiddle that shows sample pattern: https://jsfiddle.net/a16ff1p7/","\tfloat angle = rand( vUv + randomSeed ) * PI2;","\tvec2 radius = vec2( kernelRadius * INV_NUM_SAMPLES ) / size;","\tvec2 radiusStep = radius;","\tfloat occlusionSum = 0.0;","\tfloat weightSum = 0.0;","\tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {","\t\tvec2 sampleUv = vUv + vec2( cos( angle ), sin( angle ) ) * radius;","\t\tradius += radiusStep;","\t\tangle += ANGLE_STEP;","\t\tfloat sampleDepth = getDepth( sampleUv );","\t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {","\t\t\tcontinue;","\t\t}","\t\tfloat sampleViewZ = getViewZ( sampleDepth );","\t\tvec3 sampleViewPosition = getViewPosition( sampleUv, sampleDepth, sampleViewZ );","\t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );","\t\tweightSum += 1.0;","\t}","\tif( weightSum == 0.0 ) discard;","\treturn occlusionSum * ( intensity / weightSum );","}","void main() {","\tfloat centerDepth = getDepth( vUv );","\tif( centerDepth >= ( 1.0 - EPSILON ) ) {","\t\tdiscard;","\t}","\tfloat centerViewZ = getViewZ( centerDepth );","\tvec3 viewPosition = getViewPosition( vUv, centerDepth, centerViewZ );","\tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );","\tgl_FragColor = getDefaultColor( vUv );","\tgl_FragColor.xyz *=  1.0 - ambientOcclusion;","}"].join("\n")},e.SAOShader}),e("skylark-threejs-ex/shaders/DepthLimitedBlurShader",["skylark-threejs"],function(e){return e.DepthLimitedBlurShader={defines:{KERNEL_RADIUS:4,DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{tDiffuse:{value:null},size:{value:new e.Vector2(512,512)},sampleUvOffsets:{value:[new e.Vector2(0,0)]},sampleWeights:{value:[1]},tDepth:{value:null},cameraNear:{value:10},cameraFar:{value:1e3},depthCutoff:{value:10}},vertexShader:["#include <common>","uniform vec2 size;","varying vec2 vUv;","varying vec2 vInvSize;","void main() {","\tvUv = uv;","\tvInvSize = 1.0 / size;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","#include <packing>","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","uniform float cameraNear;","uniform float cameraFar;","uniform float depthCutoff;","uniform vec2 sampleUvOffsets[ KERNEL_RADIUS + 1 ];","uniform float sampleWeights[ KERNEL_RADIUS + 1 ];","varying vec2 vUv;","varying vec2 vInvSize;","float getDepth( const in vec2 screenPosition ) {","\t#if DEPTH_PACKING == 1","\treturn unpackRGBAToDepth( texture2D( tDepth, screenPosition ) );","\t#else","\treturn texture2D( tDepth, screenPosition ).x;","\t#endif","}","float getViewZ( const in float depth ) {","\t#if PERSPECTIVE_CAMERA == 1","\treturn perspectiveDepthToViewZ( depth, cameraNear, cameraFar );","\t#else","\treturn orthographicDepthToViewZ( depth, cameraNear, cameraFar );","\t#endif","}","void main() {","\tfloat depth = getDepth( vUv );","\tif( depth >= ( 1.0 - EPSILON ) ) {","\t\tdiscard;","\t}","\tfloat centerViewZ = -getViewZ( depth );","\tbool rBreak = false, lBreak = false;","\tfloat weightSum = sampleWeights[0];","\tvec4 diffuseSum = texture2D( tDiffuse, vUv ) * weightSum;","\tfor( int i = 1; i <= KERNEL_RADIUS; i ++ ) {","\t\tfloat sampleWeight = sampleWeights[i];","\t\tvec2 sampleUvOffset = sampleUvOffsets[i] * vInvSize;","\t\tvec2 sampleUv = vUv + sampleUvOffset;","\t\tfloat viewZ = -getViewZ( getDepth( sampleUv ) );","\t\tif( abs( viewZ - centerViewZ ) > depthCutoff ) rBreak = true;","\t\tif( ! rBreak ) {","\t\t\tdiffuseSum += texture2D( tDiffuse, sampleUv ) * sampleWeight;","\t\t\tweightSum += sampleWeight;","\t\t}","\t\tsampleUv = vUv - sampleUvOffset;","\t\tviewZ = -getViewZ( getDepth( sampleUv ) );","\t\tif( abs( viewZ - centerViewZ ) > depthCutoff ) lBreak = true;","\t\tif( ! lBreak ) {","\t\t\tdiffuseSum += texture2D( tDiffuse, sampleUv ) * sampleWeight;","\t\t\tweightSum += sampleWeight;","\t\t}","\t}","\tgl_FragColor = diffuseSum / weightSum;","}"].join("\n")},e.BlurShaderUtils={createSampleWeights:function(e,t){for(var r=function(e,t){return Math.exp(-e*e/(t*t*2))/(Math.sqrt(2*Math.PI)*t)},a=[],n=0;n<=e;n++)a.push(r(n,t));return a},createSampleOffsets:function(e,t){for(var r=[],a=0;a<=e;a++)r.push(t.clone().multiplyScalar(a));return r},configure:function(t,r,a,n){t.defines.KERNEL_RADIUS=r,t.uniforms.sampleUvOffsets.value=e.BlurShaderUtils.createSampleOffsets(r,n),t.uniforms.sampleWeights.value=e.BlurShaderUtils.createSampleWeights(r,a),t.needsUpdate=!0}},e.DepthLimitedBlurShader}),e("skylark-threejs-ex/shaders/UnpackDepthRGBAShader",["skylark-threejs"],function(e){return e.UnpackDepthRGBAShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","#include <packing>","void main() {","\tfloat depth = 1.0 - unpackRGBAToDepth( texture2D( tDiffuse, vUv ) );","\tgl_FragColor = vec4( vec3( depth ), opacity );","}"].join("\n")},e.UnpackDepthRGBAShader}),e("skylark-threejs-ex/shaders/ConvolutionShader",["skylark-threejs"],function(e){return e.ConvolutionShader={defines:{KERNEL_SIZE_FLOAT:"25.0",KERNEL_SIZE_INT:"25"},uniforms:{tDiffuse:{value:null},uImageIncrement:{value:new e.Vector2(.001953125,0)},cKernel:{value:[]}},vertexShader:["uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","\tvUv = uv - ( ( KERNEL_SIZE_FLOAT - 1.0 ) / 2.0 ) * uImageIncrement;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cKernel[ KERNEL_SIZE_INT ];","uniform sampler2D tDiffuse;","uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","\tvec2 imageCoord = vUv;","\tvec4 sum = vec4( 0.0, 0.0, 0.0, 0.0 );","\tfor( int i = 0; i < KERNEL_SIZE_INT; i ++ ) {","\t\tsum += texture2D( tDiffuse, imageCoord ) * cKernel[ i ];","\t\timageCoord += uImageIncrement;","\t}","\tgl_FragColor = sum;","}"].join("\n"),buildKernel:function(e){function t(e,t){return Math.exp(-e*e/(2*t*t))}var r,a,n,i,o=2*Math.ceil(3*e)+1;for(o>25&&(o=25),i=.5*(o-1),a=new Array(o),n=0,r=0;r<o;++r)a[r]=t(r-i,e),n+=a[r];for(r=0;r<o;++r)a[r]/=n;return a}},e.ConvolutionShader}),e("skylark-threejs-ex/shaders/LuminosityHighPassShader",["skylark-threejs"],function(e){return e.LuminosityHighPassShader={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new e.Color(0)},defaultOpacity:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec3 defaultColor;","uniform float defaultOpacity;","uniform float luminosityThreshold;","uniform float smoothWidth;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tvec3 luma = vec3( 0.299, 0.587, 0.114 );","\tfloat v = dot( texel.xyz, luma );","\tvec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );","\tfloat alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );","\tgl_FragColor = mix( outputColor, texel, alpha );","}"].join("\n")},e.LuminosityHighPassShader}),e("skylark-threejs-ex/shaders/FXAAShader",["skylark-threejs"],function(e){return e.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new e.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","","uniform sampler2D tDiffuse;","","uniform vec2 resolution;","","varying vec2 vUv;","","// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)","","//----------------------------------------------------------------------------------","// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag","// SDK Version: v3.00","// Email:       gameworks@nvidia.com","// Site:        http://developer.nvidia.com/","//","// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.","//","// Redistribution and use in source and binary forms, with or without","// modification, are permitted provided that the following conditions","// are met:","//  * Redistributions of source code must retain the above copyright","//    notice, this list of conditions and the following disclaimer.","//  * Redistributions in binary form must reproduce the above copyright","//    notice, this list of conditions and the following disclaimer in the","//    documentation and/or other materials provided with the distribution.","//  * Neither the name of NVIDIA CORPORATION nor the names of its","//    contributors may be used to endorse or promote products derived","//    from this software without specific prior written permission.","//","// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY","// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE","// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR","// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR","// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,","// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,","// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR","// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY","// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT","// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE","// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.","//","//----------------------------------------------------------------------------------","","#define FXAA_PC 1","#define FXAA_GLSL_100 1","#define FXAA_QUALITY_PRESET 12","","#define FXAA_GREEN_AS_LUMA 1","","/*--------------------------------------------------------------------------*/","#ifndef FXAA_PC_CONSOLE","    //","    // The console algorithm for PC is included","    // for developers targeting really low spec machines.","    // Likely better to just run FXAA_PC, and use a really low preset.","    //","    #define FXAA_PC_CONSOLE 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_120","    #define FXAA_GLSL_120 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_130","    #define FXAA_GLSL_130 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_3","    #define FXAA_HLSL_3 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_4","    #define FXAA_HLSL_4 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_5","    #define FXAA_HLSL_5 0","#endif","/*==========================================================================*/","#ifndef FXAA_GREEN_AS_LUMA","    //","    // For those using non-linear color,","    // and either not able to get luma in alpha, or not wanting to,","    // this enables FXAA to run using green as a proxy for luma.","    // So with this enabled, no need to pack luma in alpha.","    //","    // This will turn off AA on anything which lacks some amount of green.","    // Pure red and blue or combination of only R and B, will get no AA.","    //","    // Might want to lower the settings for both,","    //    fxaaConsoleEdgeThresholdMin","    //    fxaaQualityEdgeThresholdMin","    // In order to insure AA does not get turned off on colors","    // which contain a minor amount of green.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_GREEN_AS_LUMA 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_EARLY_EXIT","    //","    // Controls algorithm's early exit path.","    // On PS3 turning this ON adds 2 cycles to the shader.","    // On 360 turning this OFF adds 10ths of a millisecond to the shader.","    // Turning this off on console will result in a more blurry image.","    // So this defaults to on.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_EARLY_EXIT 1","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_DISCARD","    //","    // Only valid for PC OpenGL currently.","    // Probably will not work when FXAA_GREEN_AS_LUMA = 1.","    //","    // 1 = Use discard on pixels which don't need AA.","    //     For APIs which enable concurrent TEX+ROP from same surface.","    // 0 = Return unchanged color on pixels which don't need AA.","    //","    #define FXAA_DISCARD 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_FAST_PIXEL_OFFSET","    //","    // Used for GLSL 120 only.","    //","    // 1 = GL API supports fast pixel offsets","    // 0 = do not use fast pixel offsets","    //","    #ifdef GL_EXT_gpu_shader4","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifndef FXAA_FAST_PIXEL_OFFSET","        #define FXAA_FAST_PIXEL_OFFSET 0","    #endif","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GATHER4_ALPHA","    //","    // 1 = API supports gather4 on alpha channel.","    // 0 = API does not support gather4 on alpha channel.","    //","    #if (FXAA_HLSL_5 == 1)","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifndef FXAA_GATHER4_ALPHA","        #define FXAA_GATHER4_ALPHA 0","    #endif","#endif","","","/*============================================================================","                        FXAA QUALITY - TUNING KNOBS","------------------------------------------------------------------------------","NOTE the other tuning knobs are now in the shader function inputs!","============================================================================*/","#ifndef FXAA_QUALITY_PRESET","    //","    // Choose the quality preset.","    // This needs to be compiled into the shader as it effects code.","    // Best option to include multiple presets is to","    // in each shader define the preset, then include this file.","    //","    // OPTIONS","    // -----------------------------------------------------------------------","    // 10 to 15 - default medium dither (10=fastest, 15=highest quality)","    // 20 to 29 - less dither, more expensive (20=fastest, 29=highest quality)","    // 39       - no dither, very expensive","    //","    // NOTES","    // -----------------------------------------------------------------------","    // 12 = slightly faster then FXAA 3.9 and higher edge quality (default)","    // 13 = about same speed as FXAA 3.9 and better than 12","    // 23 = closest to FXAA 3.9 visually and performance wise","    //  _ = the lowest digit is directly related to performance","    // _  = the highest digit is directly related to style","    //","    #define FXAA_QUALITY_PRESET 12","#endif","","","/*============================================================================","","                           FXAA QUALITY - PRESETS","","============================================================================*/","","/*============================================================================","                     FXAA QUALITY - MEDIUM DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 10)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 3.0","    #define FXAA_QUALITY_P2 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 11)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 3.0","    #define FXAA_QUALITY_P3 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 12)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 4.0","    #define FXAA_QUALITY_P4 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 13)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 4.0","    #define FXAA_QUALITY_P5 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 14)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 4.0","    #define FXAA_QUALITY_P6 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 15)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 12.0","#endif","","/*============================================================================","                     FXAA QUALITY - LOW DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 20)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 2.0","    #define FXAA_QUALITY_P2 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 21)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 22)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 23)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 24)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 3.0","    #define FXAA_QUALITY_P6 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 25)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 26)","    #define FXAA_QUALITY_PS 9","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 4.0","    #define FXAA_QUALITY_P8 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 27)","    #define FXAA_QUALITY_PS 10","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 4.0","    #define FXAA_QUALITY_P9 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 28)","    #define FXAA_QUALITY_PS 11","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 4.0","    #define FXAA_QUALITY_P10 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 29)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","/*============================================================================","                     FXAA QUALITY - EXTREME QUALITY","============================================================================*/","#if (FXAA_QUALITY_PRESET == 39)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.0","    #define FXAA_QUALITY_P2 1.0","    #define FXAA_QUALITY_P3 1.0","    #define FXAA_QUALITY_P4 1.0","    #define FXAA_QUALITY_P5 1.5","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","","","/*============================================================================","","                                API PORTING","","============================================================================*/","#if (FXAA_GLSL_100 == 1) || (FXAA_GLSL_120 == 1) || (FXAA_GLSL_130 == 1)","    #define FxaaBool bool","    #define FxaaDiscard discard","    #define FxaaFloat float","    #define FxaaFloat2 vec2","    #define FxaaFloat3 vec3","    #define FxaaFloat4 vec4","    #define FxaaHalf float","    #define FxaaHalf2 vec2","    #define FxaaHalf3 vec3","    #define FxaaHalf4 vec4","    #define FxaaInt2 ivec2","    #define FxaaSat(x) clamp(x, 0.0, 1.0)","    #define FxaaTex sampler2D","#else","    #define FxaaBool bool","    #define FxaaDiscard clip(-1)","    #define FxaaFloat float","    #define FxaaFloat2 float2","    #define FxaaFloat3 float3","    #define FxaaFloat4 float4","    #define FxaaHalf half","    #define FxaaHalf2 half2","    #define FxaaHalf3 half3","    #define FxaaHalf4 half4","    #define FxaaSat(x) saturate(x)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_100 == 1)","  #define FxaaTexTop(t, p) texture2D(t, p, 0.0)","  #define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), 0.0)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_120 == 1)","    // Requires,","    //  #version 120","    // And at least,","    //  #extension GL_EXT_gpu_shader4 : enable","    //  (or set FXAA_FAST_PIXEL_OFFSET 1 to work like DX9)","    #define FxaaTexTop(t, p) texture2DLod(t, p, 0.0)","    #if (FXAA_FAST_PIXEL_OFFSET == 1)","        #define FxaaTexOff(t, p, o, r) texture2DLodOffset(t, p, 0.0, o)","    #else","        #define FxaaTexOff(t, p, o, r) texture2DLod(t, p + (o * r), 0.0)","    #endif","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_130 == 1)",'    // Requires "#version 130" or better',"    #define FxaaTexTop(t, p) textureLod(t, p, 0.0)","    #define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_3 == 1)","    #define FxaaInt2 float2","    #define FxaaTex sampler2D","    #define FxaaTexTop(t, p) tex2Dlod(t, float4(p, 0.0, 0.0))","    #define FxaaTexOff(t, p, o, r) tex2Dlod(t, float4(p + (o * r), 0, 0))","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_4 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_5 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","    #define FxaaTexAlpha4(t, p) t.tex.GatherAlpha(t.smpl, p)","    #define FxaaTexOffAlpha4(t, p, o) t.tex.GatherAlpha(t.smpl, p, o)","    #define FxaaTexGreen4(t, p) t.tex.GatherGreen(t.smpl, p)","    #define FxaaTexOffGreen4(t, p, o) t.tex.GatherGreen(t.smpl, p, o)","#endif","","","/*============================================================================","                   GREEN AS LUMA OPTION SUPPORT FUNCTION","============================================================================*/","#if (FXAA_GREEN_AS_LUMA == 0)","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.w; }","#else","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.y; }","#endif","","","","","/*============================================================================","","                             FXAA3 QUALITY - PC","","============================================================================*/","#if (FXAA_PC == 1)","/*--------------------------------------------------------------------------*/","FxaaFloat4 FxaaPixelShader(","    //","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy} = center of pixel","    FxaaFloat2 pos,","    //","    // Used only for FXAA Console, and not used on the 360 version.","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy_} = upper left of pixel","    // {_zw} = lower right of pixel","    FxaaFloat4 fxaaConsolePosPos,","    //","    // Input color texture.","    // {rgb_} = color in linear or perceptual color space","    // if (FXAA_GREEN_AS_LUMA == 0)","    //     {__a} = luma in perceptual color space (not linear)","    FxaaTex tex,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 2nd sampler.","    // This sampler needs to have an exponent bias of -1.","    FxaaTex fxaaConsole360TexExpBiasNegOne,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 3nd sampler.","    // This sampler needs to have an exponent bias of -2.","    FxaaTex fxaaConsole360TexExpBiasNegTwo,","    //","    // Only used on FXAA Quality.","    // This must be from a constant/uniform.","    // {x_} = 1.0/screenWidthInPixels","    // {_y} = 1.0/screenHeightInPixels","    FxaaFloat2 fxaaQualityRcpFrame,","    //","    // Only used on FXAA Console.","    // This must be from a constant/uniform.","    // This effects sub-pixel AA quality and inversely sharpness.","    //   Where N ranges between,","    //     N = 0.50 (default)","    //     N = 0.33 (sharper)","    // {x__} = -N/screenWidthInPixels","    // {_y_} = -N/screenHeightInPixels","    // {_z_} =  N/screenWidthInPixels","    // {__w} =  N/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt,","    //","    // Only used on FXAA Console.","    // Not used on 360, but used on PS3 and PC.","    // This must be from a constant/uniform.","    // {x__} = -2.0/screenWidthInPixels","    // {_y_} = -2.0/screenHeightInPixels","    // {_z_} =  2.0/screenWidthInPixels","    // {__w} =  2.0/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt2,","    //","    // Only used on FXAA Console.","    // Only used on 360 in place of fxaaConsoleRcpFrameOpt2.","    // This must be from a constant/uniform.","    // {x__} =  8.0/screenWidthInPixels","    // {_y_} =  8.0/screenHeightInPixels","    // {_z_} = -4.0/screenWidthInPixels","    // {__w} = -4.0/screenHeightInPixels","    FxaaFloat4 fxaaConsole360RcpFrameOpt2,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_SUBPIX define.","    // It is here now to allow easier tuning.","    // Choose the amount of sub-pixel aliasing removal.","    // This can effect sharpness.","    //   1.00 - upper limit (softer)","    //   0.75 - default amount of filtering","    //   0.50 - lower limit (sharper, less sub-pixel aliasing removal)","    //   0.25 - almost off","    //   0.00 - completely off","    FxaaFloat fxaaQualitySubpix,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // The minimum amount of local contrast required to apply algorithm.","    //   0.333 - too little (faster)","    //   0.250 - low quality","    //   0.166 - default","    //   0.125 - high quality","    //   0.063 - overkill (slower)","    FxaaFloat fxaaQualityEdgeThreshold,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    //   0.0833 - upper limit (default, the start of visible unfiltered edges)","    //   0.0625 - high quality (faster)","    //   0.0312 - visible limit (slower)","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaQualityEdgeThresholdMin,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_SHARPNESS define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_SHARPNESS for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only three safe values here: 2 and 4 and 8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // For all other platforms can be a non-power of two.","    //   8.0 is sharper (default!!!)","    //   4.0 is softer","    //   2.0 is really soft (good only for vector graphics inputs)","    FxaaFloat fxaaConsoleEdgeSharpness,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_THRESHOLD for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only two safe values here: 1/4 and 1/8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // The console setting has a different mapping than the quality setting.","    // Other platforms can use other values.","    //   0.125 leaves less aliasing, but is softer (default!!!)","    //   0.25 leaves more aliasing, and is sharper","    FxaaFloat fxaaConsoleEdgeThreshold,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    // The console setting has a different mapping than the quality setting.","    // This only applies when FXAA_EARLY_EXIT is 1.","    // This does not apply to PS3,","    // PS3 was simplified to avoid more shader instructions.","    //   0.06 - faster but more aliasing in darks","    //   0.05 - default","    //   0.04 - slower and less aliasing in darks","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaConsoleEdgeThresholdMin,","    //","    // Extra constants for 360 FXAA Console only.","    // Use zeros or anything else for other platforms.","    // These must be in physical constant registers and NOT immediates.","    // Immediates will result in compiler un-optimizing.","    // {xyzw} = float4(1.0, -1.0, 0.25, -0.25)","    FxaaFloat4 fxaaConsole360ConstDir",") {","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posM;","    posM.x = pos.x;","    posM.y = pos.y;","    #if (FXAA_GATHER4_ALPHA == 1)","        #if (FXAA_DISCARD == 0)","            FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","            #if (FXAA_GREEN_AS_LUMA == 0)","                #define lumaM rgbyM.w","            #else","                #define lumaM rgbyM.y","            #endif","        #endif","        #if (FXAA_GREEN_AS_LUMA == 0)","            FxaaFloat4 luma4A = FxaaTexAlpha4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffAlpha4(tex, posM, FxaaInt2(-1, -1));","        #else","            FxaaFloat4 luma4A = FxaaTexGreen4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffGreen4(tex, posM, FxaaInt2(-1, -1));","        #endif","        #if (FXAA_DISCARD == 1)","            #define lumaM luma4A.w","        #endif","        #define lumaE luma4A.z","        #define lumaS luma4A.x","        #define lumaSE luma4A.y","        #define lumaNW luma4B.w","        #define lumaN luma4B.z","        #define lumaW luma4B.x","    #else","        FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","        #if (FXAA_GREEN_AS_LUMA == 0)","            #define lumaM rgbyM.w","        #else","            #define lumaM rgbyM.y","        #endif","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 0.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 0.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 0), fxaaQualityRcpFrame.xy));","        #endif","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat maxSM = max(lumaS, lumaM);","    FxaaFloat minSM = min(lumaS, lumaM);","    FxaaFloat maxESM = max(lumaE, maxSM);","    FxaaFloat minESM = min(lumaE, minSM);","    FxaaFloat maxWN = max(lumaN, lumaW);","    FxaaFloat minWN = min(lumaN, lumaW);","    FxaaFloat rangeMax = max(maxWN, maxESM);","    FxaaFloat rangeMin = min(minWN, minESM);","    FxaaFloat rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;","    FxaaFloat range = rangeMax - rangeMin;","    FxaaFloat rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);","    FxaaBool earlyExit = range < rangeMaxClamped;","/*--------------------------------------------------------------------------*/","    if(earlyExit)","        #if (FXAA_DISCARD == 1)","            FxaaDiscard;","        #else","            return rgbyM;","        #endif","/*--------------------------------------------------------------------------*/","    #if (FXAA_GATHER4_ALPHA == 0)","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 1.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","        #endif","    #else","        FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(1, -1), fxaaQualityRcpFrame.xy));","        FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNS = lumaN + lumaS;","    FxaaFloat lumaWE = lumaW + lumaE;","    FxaaFloat subpixRcpRange = 1.0/range;","    FxaaFloat subpixNSWE = lumaNS + lumaWE;","    FxaaFloat edgeHorz1 = (-2.0 * lumaM) + lumaNS;","    FxaaFloat edgeVert1 = (-2.0 * lumaM) + lumaWE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNESE = lumaNE + lumaSE;","    FxaaFloat lumaNWNE = lumaNW + lumaNE;","    FxaaFloat edgeHorz2 = (-2.0 * lumaE) + lumaNESE;","    FxaaFloat edgeVert2 = (-2.0 * lumaN) + lumaNWNE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNWSW = lumaNW + lumaSW;","    FxaaFloat lumaSWSE = lumaSW + lumaSE;","    FxaaFloat edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);","    FxaaFloat edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);","    FxaaFloat edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;","    FxaaFloat edgeVert3 = (-2.0 * lumaS) + lumaSWSE;","    FxaaFloat edgeHorz = abs(edgeHorz3) + edgeHorz4;","    FxaaFloat edgeVert = abs(edgeVert3) + edgeVert4;","/*--------------------------------------------------------------------------*/","    FxaaFloat subpixNWSWNESE = lumaNWSW + lumaNESE;","    FxaaFloat lengthSign = fxaaQualityRcpFrame.x;","    FxaaBool horzSpan = edgeHorz >= edgeVert;","    FxaaFloat subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;","/*--------------------------------------------------------------------------*/","    if(!horzSpan) lumaN = lumaW;","    if(!horzSpan) lumaS = lumaE;","    if(horzSpan) lengthSign = fxaaQualityRcpFrame.y;","    FxaaFloat subpixB = (subpixA * (1.0/12.0)) - lumaM;","/*--------------------------------------------------------------------------*/","    FxaaFloat gradientN = lumaN - lumaM;","    FxaaFloat gradientS = lumaS - lumaM;","    FxaaFloat lumaNN = lumaN + lumaM;","    FxaaFloat lumaSS = lumaS + lumaM;","    FxaaBool pairN = abs(gradientN) >= abs(gradientS);","    FxaaFloat gradient = max(abs(gradientN), abs(gradientS));","    if(pairN) lengthSign = -lengthSign;","    FxaaFloat subpixC = FxaaSat(abs(subpixB) * subpixRcpRange);","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posB;","    posB.x = posM.x;","    posB.y = posM.y;","    FxaaFloat2 offNP;","    offNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;","    offNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;","    if(!horzSpan) posB.x += lengthSign * 0.5;","    if( horzSpan) posB.y += lengthSign * 0.5;","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posN;","    posN.x = posB.x - offNP.x * FXAA_QUALITY_P0;","    posN.y = posB.y - offNP.y * FXAA_QUALITY_P0;","    FxaaFloat2 posP;","    posP.x = posB.x + offNP.x * FXAA_QUALITY_P0;","    posP.y = posB.y + offNP.y * FXAA_QUALITY_P0;","    FxaaFloat subpixD = ((-2.0)*subpixC) + 3.0;","    FxaaFloat lumaEndN = FxaaLuma(FxaaTexTop(tex, posN));","    FxaaFloat subpixE = subpixC * subpixC;","    FxaaFloat lumaEndP = FxaaLuma(FxaaTexTop(tex, posP));","/*--------------------------------------------------------------------------*/","    if(!pairN) lumaNN = lumaSS;","    FxaaFloat gradientScaled = gradient * 1.0/4.0;","    FxaaFloat lumaMM = lumaM - lumaNN * 0.5;","    FxaaFloat subpixF = subpixD * subpixE;","    FxaaBool lumaMLTZero = lumaMM < 0.0;","/*--------------------------------------------------------------------------*/","    lumaEndN -= lumaNN * 0.5;","    lumaEndP -= lumaNN * 0.5;","    FxaaBool doneN = abs(lumaEndN) >= gradientScaled;","    FxaaBool doneP = abs(lumaEndP) >= gradientScaled;","    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P1;","    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P1;","    FxaaBool doneNP = (!doneN) || (!doneP);","    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P1;","    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P1;","/*--------------------------------------------------------------------------*/","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P2;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P2;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P2;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P2;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 3)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P3;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P3;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P3;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P3;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 4)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P4;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P4;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P4;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P4;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 5)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P5;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P5;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P5;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P5;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 6)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P6;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P6;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P6;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P6;","/*--------------------------------------------------------------------------*/","                        #if (FXAA_QUALITY_PS > 7)","                        if(doneNP) {","                            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                            doneN = abs(lumaEndN) >= gradientScaled;","                            doneP = abs(lumaEndP) >= gradientScaled;","                            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P7;","                            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P7;","                            doneNP = (!doneN) || (!doneP);","                            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P7;","                            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P7;","/*--------------------------------------------------------------------------*/","    #if (FXAA_QUALITY_PS > 8)","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P8;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P8;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P8;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P8;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 9)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P9;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P9;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P9;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P9;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 10)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P10;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P10;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P10;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P10;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 11)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P11;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P11;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P11;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P11;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 12)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P12;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P12;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P12;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P12;","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","    #endif","/*--------------------------------------------------------------------------*/","                        }","                        #endif","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","/*--------------------------------------------------------------------------*/","    FxaaFloat dstN = posM.x - posN.x;","    FxaaFloat dstP = posP.x - posM.x;","    if(!horzSpan) dstN = posM.y - posN.y;","    if(!horzSpan) dstP = posP.y - posM.y;","/*--------------------------------------------------------------------------*/","    FxaaBool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;","    FxaaFloat spanLength = (dstP + dstN);","    FxaaBool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;","    FxaaFloat spanLengthRcp = 1.0/spanLength;","/*--------------------------------------------------------------------------*/","    FxaaBool directionN = dstN < dstP;","    FxaaFloat dst = min(dstN, dstP);","    FxaaBool goodSpan = directionN ? goodSpanN : goodSpanP;","    FxaaFloat subpixG = subpixF * subpixF;","    FxaaFloat pixelOffset = (dst * (-spanLengthRcp)) + 0.5;","    FxaaFloat subpixH = subpixG * fxaaQualitySubpix;","/*--------------------------------------------------------------------------*/","    FxaaFloat pixelOffsetGood = goodSpan ? pixelOffset : 0.0;","    FxaaFloat pixelOffsetSubpix = max(pixelOffsetGood, subpixH);","    if(!horzSpan) posM.x += pixelOffsetSubpix * lengthSign;","    if( horzSpan) posM.y += pixelOffsetSubpix * lengthSign;","    #if (FXAA_DISCARD == 1)","        return FxaaTexTop(tex, posM);","    #else","        return FxaaFloat4(FxaaTexTop(tex, posM).xyz, lumaM);","    #endif","}","/*==========================================================================*/","#endif","","void main() {","  gl_FragColor = FxaaPixelShader(","    vUv,","    vec4(0.0),","    tDiffuse,","    tDiffuse,","    tDiffuse,","    resolution,","    vec4(0.0),","    vec4(0.0),","    vec4(0.0),","    0.75,","    0.166,","    0.0833,","    0.0,","    0.0,","    0.0,","    vec4(0.0)","  );","","  // TODO avoid querying texture twice for same texel","  gl_FragColor.a = texture2D(tDiffuse, vUv).a;","}"].join("\n")},e.FXAAShader}),e("skylark-threejs-ex/shaders/SSAOShader",["skylark-threejs"],function(e){return e.SSAOShader={defines:{PERSPECTIVE_CAMERA:1,KERNEL_SIZE:32},uniforms:{tDiffuse:{value:null},tNormal:{value:null},tDepth:{value:null},tNoise:{value:null},kernel:{value:null},cameraNear:{value:null},cameraFar:{value:null},resolution:{value:new e.Vector2},cameraProjectionMatrix:{value:new e.Matrix4},cameraInverseProjectionMatrix:{value:new e.Matrix4},kernelRadius:{value:8},minDistance:{value:.005},maxDistance:{value:.05}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tDepth;","uniform sampler2D tNoise;","uniform vec3 kernel[ KERNEL_SIZE ];","uniform vec2 resolution;","uniform float cameraNear;","uniform float cameraFar;","uniform mat4 cameraProjectionMatrix;","uniform mat4 cameraInverseProjectionMatrix;","uniform float kernelRadius;","uniform float minDistance;","uniform float maxDistance;","varying vec2 vUv;","#include <packing>","float getDepth( const in vec2 screenPosition ) {","\treturn texture2D( tDepth, screenPosition ).x;","}","float getLinearDepth( const in vec2 screenPosition ) {","\t#if PERSPECTIVE_CAMERA == 1","\t\tfloat fragCoordZ = texture2D( tDepth, screenPosition ).x;","\t\tfloat viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );","\t\treturn viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );","\t#else","\t\treturn texture2D( depthSampler, coord ).x;","\t#endif","}","float getViewZ( const in float depth ) {","\t#if PERSPECTIVE_CAMERA == 1","\t\treturn perspectiveDepthToViewZ( depth, cameraNear, cameraFar );","\t#else","\t\treturn orthographicDepthToViewZ( depth, cameraNear, cameraFar );","\t#endif","}","vec3 getViewPosition( const in vec2 screenPosition, const in float depth, const in float viewZ ) {","\tfloat clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];","\tvec4 clipPosition = vec4( ( vec3( screenPosition, depth ) - 0.5 ) * 2.0, 1.0 );","\tclipPosition *= clipW; // unprojection.","\treturn ( cameraInverseProjectionMatrix * clipPosition ).xyz;","}","vec3 getViewNormal( const in vec2 screenPosition ) {","\treturn unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );","}","void main() {","\tfloat depth = getDepth( vUv );","\tfloat viewZ = getViewZ( depth );","\tvec3 viewPosition = getViewPosition( vUv, depth, viewZ );","\tvec3 viewNormal = getViewNormal( vUv );"," vec2 noiseScale = vec2( resolution.x / 4.0, resolution.y / 4.0 );","\tvec3 random = texture2D( tNoise, vUv * noiseScale ).xyz;","\tvec3 tangent = normalize( random - viewNormal * dot( random, viewNormal ) );","\tvec3 bitangent = cross( viewNormal, tangent );","\tmat3 kernelMatrix = mat3( tangent, bitangent, viewNormal );"," float occlusion = 0.0;"," for ( int i = 0; i < KERNEL_SIZE; i ++ ) {","\t\tvec3 sampleVector = kernelMatrix * kernel[ i ];","\t\tvec3 samplePoint = viewPosition + ( sampleVector * kernelRadius );","\t\tvec4 samplePointNDC = cameraProjectionMatrix * vec4( samplePoint, 1.0 );","\t\tsamplePointNDC /= samplePointNDC.w;","\t\tvec2 samplePointUv = samplePointNDC.xy * 0.5 + 0.5;","\t\tfloat realDepth = getLinearDepth( samplePointUv );","\t\tfloat sampleDepth = viewZToOrthographicDepth( samplePoint.z, cameraNear, cameraFar );","\t\tfloat delta = sampleDepth - realDepth;","\t\tif ( delta > minDistance && delta < maxDistance ) {","\t\t\tocclusion += 1.0;","\t\t}","\t}","\tocclusion = clamp( occlusion / float( KERNEL_SIZE ), 0.0, 1.0 );","\tgl_FragColor = vec4( vec3( 1.0 - occlusion ), 1.0 );","}"].join("\n")},e.SSAODepthShader={defines:{PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDepth;","uniform float cameraNear;","uniform float cameraFar;","varying vec2 vUv;","#include <packing>","float getLinearDepth( const in vec2 screenPosition ) {","\t#if PERSPECTIVE_CAMERA == 1","\t\tfloat fragCoordZ = texture2D( tDepth, screenPosition ).x;","\t\tfloat viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );","\t\treturn viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );","\t#else","\t\treturn texture2D( depthSampler, coord ).x;","\t#endif","}","void main() {","\tfloat depth = getLinearDepth( vUv );","\tgl_FragColor = vec4( vec3( 1.0 - depth ), 1.0 );","}"].join("\n")},e.SSAOBlurShader={uniforms:{tDiffuse:{value:null},resolution:{value:new e.Vector2}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","void main() {","\tvec2 texelSize = ( 1.0 / resolution );","\tfloat result = 0.0;","\tfor ( int i = - 2; i <= 2; i ++ ) {","\t\tfor ( int j = - 2; j <= 2; j ++ ) {","\t\t\tvec2 offset = ( vec2( float( i ), float( j ) ) ) * texelSize;","\t\t\tresult += texture2D( tDiffuse, vUv + offset ).r;","\t\t}","\t}","\tgl_FragColor = vec4( vec3( result / ( 5.0 * 5.0 ) ), 1.0 );","}"].join("\n")},e.SSAOShader}),e("skylark-threejs-ex/shaders/FilmShader",["skylark-threejs"],function(e){return e.FilmShader={uniforms:{tDiffuse:{value:null},time:{value:0},nIntensity:{value:.5},sIntensity:{value:.05},sCount:{value:4096},grayscale:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","uniform float time;","uniform bool grayscale;","uniform float nIntensity;","uniform float sIntensity;","uniform float sCount;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 cTextureScreen = texture2D( tDiffuse, vUv );","\tfloat dx = rand( vUv + time );","\tvec3 cResult = cTextureScreen.rgb + cTextureScreen.rgb * clamp( 0.1 + dx, 0.0, 1.0 );","\tvec2 sc = vec2( sin( vUv.y * sCount ), cos( vUv.y * sCount ) );","\tcResult += cTextureScreen.rgb * vec3( sc.x, sc.y, sc.x ) * sIntensity;","\tcResult = cTextureScreen.rgb + clamp( nIntensity, 0.0,1.0 ) * ( cResult - cTextureScreen.rgb );","\tif( grayscale ) {","\t\tcResult = vec3( cResult.r * 0.3 + cResult.g * 0.59 + cResult.b * 0.11 );","\t}","\tgl_FragColor =  vec4( cResult, cTextureScreen.a );","}"].join("\n")},e.FilmShader}),e("skylark-threejs-ex/shaders/DotScreenShader",["skylark-threejs"],function(e){return e.DotScreenShader={uniforms:{tDiffuse:{value:null},tSize:{value:new e.Vector2(256,256)},center:{value:new e.Vector2(.5,.5)},angle:{value:1.57},scale:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec2 center;","uniform float angle;","uniform float scale;","uniform vec2 tSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float pattern() {","\tfloat s = sin( angle ), c = cos( angle );","\tvec2 tex = vUv * tSize - center;","\tvec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;","\treturn ( sin( point.x ) * sin( point.y ) ) * 4.0;","}","void main() {","\tvec4 color = texture2D( tDiffuse, vUv );","\tfloat average = ( color.r + color.g + color.b ) / 3.0;","\tgl_FragColor = vec4( vec3( average * 10.0 - 5.0 + pattern() ), color.a );","}"].join("\n")},e.DotScreenShader}),e("skylark-threejs-ex/shaders/LuminosityShader",["skylark-threejs"],function(e){return e.LuminosityShader={uniforms:{tDiffuse:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tfloat l = linearToRelativeLuminance( texel.rgb );","\tgl_FragColor = vec4( l, l, l, texel.w );","}"].join("\n")},e.LuminosityShader}),e("skylark-threejs-ex/shaders/SobelOperatorShader",["skylark-threejs"],function(e){return e.SobelOperatorShader={uniforms:{tDiffuse:{value:null},resolution:{value:new e.Vector2}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","void main() {","\tvec2 texel = vec2( 1.0 / resolution.x, 1.0 / resolution.y );","\tconst mat3 Gx = mat3( -1, -2, -1, 0, 0, 0, 1, 2, 1 );","\tconst mat3 Gy = mat3( -1, 0, 1, -2, 0, 2, -1, 0, 1 );","\tfloat tx0y0 = texture2D( tDiffuse, vUv + texel * vec2( -1, -1 ) ).r;","\tfloat tx0y1 = texture2D( tDiffuse, vUv + texel * vec2( -1,  0 ) ).r;","\tfloat tx0y2 = texture2D( tDiffuse, vUv + texel * vec2( -1,  1 ) ).r;","\tfloat tx1y0 = texture2D( tDiffuse, vUv + texel * vec2(  0, -1 ) ).r;","\tfloat tx1y1 = texture2D( tDiffuse, vUv + texel * vec2(  0,  0 ) ).r;","\tfloat tx1y2 = texture2D( tDiffuse, vUv + texel * vec2(  0,  1 ) ).r;","\tfloat tx2y0 = texture2D( tDiffuse, vUv + texel * vec2(  1, -1 ) ).r;","\tfloat tx2y1 = texture2D( tDiffuse, vUv + texel * vec2(  1,  0 ) ).r;","\tfloat tx2y2 = texture2D( tDiffuse, vUv + texel * vec2(  1,  1 ) ).r;","\tfloat valueGx = Gx[0][0] * tx0y0 + Gx[1][0] * tx1y0 + Gx[2][0] * tx2y0 + ","\t\tGx[0][1] * tx0y1 + Gx[1][1] * tx1y1 + Gx[2][1] * tx2y1 + ","\t\tGx[0][2] * tx0y2 + Gx[1][2] * tx1y2 + Gx[2][2] * tx2y2; ","\tfloat valueGy = Gy[0][0] * tx0y0 + Gy[1][0] * tx1y0 + Gy[2][0] * tx2y0 + ","\t\tGy[0][1] * tx0y1 + Gy[1][1] * tx1y1 + Gy[2][1] * tx2y1 + ","\t\tGy[0][2] * tx0y2 + Gy[1][2] * tx1y2 + Gy[2][2] * tx2y2; ","\tfloat G = sqrt( ( valueGx * valueGx ) + ( valueGy * valueGy ) );","\tgl_FragColor = vec4( vec3( G ), 1 );","}"].join("\n")},e.SobelOperatorShader}),e("skylark-threejs-ex/shaders/ColorifyShader",["skylark-threejs"],function(e){return e.ColorifyShader={uniforms:{tDiffuse:{value:null},color:{value:new e.Color(16777215)}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tvec3 luma = vec3( 0.299, 0.587, 0.114 );","\tfloat v = dot( texel.xyz, luma );","\tgl_FragColor = vec4( v * color, texel.w );","}"].join("\n")},e.ColorifyShader}),e("skylark-threejs-ex/shaders/ToneMapShader",["skylark-threejs"],function(e){return e.ToneMapShader={uniforms:{tDiffuse:{value:null},averageLuminance:{value:1},luminanceMap:{value:null},maxLuminance:{value:16},minLuminance:{value:.01},middleGrey:{value:.6}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform float middleGrey;","uniform float minLuminance;","uniform float maxLuminance;","#ifdef ADAPTED_LUMINANCE","\tuniform sampler2D luminanceMap;","#else","\tuniform float averageLuminance;","#endif","vec3 ToneMap( vec3 vColor ) {","\t#ifdef ADAPTED_LUMINANCE","\t\tfloat fLumAvg = texture2D(luminanceMap, vec2(0.5, 0.5)).r;","\t#else","\t\tfloat fLumAvg = averageLuminance;","\t#endif","\tfloat fLumPixel = linearToRelativeLuminance( vColor );","\tfloat fLumScaled = (fLumPixel * middleGrey) / max( minLuminance, fLumAvg );","\tfloat fLumCompressed = (fLumScaled * (1.0 + (fLumScaled / (maxLuminance * maxLuminance)))) / (1.0 + fLumScaled);","\treturn fLumCompressed * vColor;","}","void main() {","\tvec4 texel = texture2D( tDiffuse, vUv );","\tgl_FragColor = vec4( ToneMap( texel.xyz ), texel.w );","}"].join("\n")},e.ToneMapShader}),e("skylark-threejs-ex/shaders/TechnicolorShader",["skylark-threejs"],function(e){return e.TechnicolorShader={uniforms:{tDiffuse:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","\tvec4 tex = texture2D( tDiffuse, vec2( vUv.x, vUv.y ) );","\tvec4 newTex = vec4(tex.r, (tex.g + tex.b) * .5, (tex.g + tex.b) * .5, 1.0);","\tgl_FragColor = newTex;","}"].join("\n")},e.TechnicolorShader}),e("skylark-threejs-ex/shaders/HueSaturationShader",["skylark-threejs"],function(e){return e.HueSaturationShader={uniforms:{tDiffuse:{value:null},hue:{value:0},saturation:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float hue;","uniform float saturation;","varying vec2 vUv;","void main() {","\tgl_FragColor = texture2D( tDiffuse, vUv );","\tfloat angle = hue * 3.14159265;","\tfloat s = sin(angle), c = cos(angle);","\tvec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;","\tfloat len = length(gl_FragColor.rgb);","\tgl_FragColor.rgb = vec3(","\t\tdot(gl_FragColor.rgb, weights.xyz),","\t\tdot(gl_FragColor.rgb, weights.zxy),","\t\tdot(gl_FragColor.rgb, weights.yzx)","\t);","\tfloat average = (gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3.0;","\tif (saturation > 0.0) {","\t\tgl_FragColor.rgb += (average - gl_FragColor.rgb) * (1.0 - 1.0 / (1.001 - saturation));","\t} else {","\t\tgl_FragColor.rgb += (average - gl_FragColor.rgb) * (-saturation);","\t}","}"].join("\n")},e.HueSaturationShader}),e("skylark-threejs-ex/postprocessing/Pass",["skylark-threejs"],function(e){var t,r,a;return e.Pass=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1},Object.assign(e.Pass.prototype,{setSize:function(){},render:function(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),e.Pass.FullScreenQuad=(t=new e.OrthographicCamera(-1,1,1,-1,0,1),r=new e.PlaneBufferGeometry(2,2),a=function(t){this._mesh=new e.Mesh(r,t)},Object.defineProperty(a.prototype,"material",{get:function(){return this._mesh.material},set:function(e){this._mesh.material=e}}),Object.assign(a.prototype,{dispose:function(){this._mesh.geometry.dispose()},render:function(e){e.render(this._mesh,t)}}),a),e.Pass}),e("skylark-threejs-ex/postprocessing/ShaderPass",["skylark-threejs","./Pass"],function(e){return e.ShaderPass=function(t,r){e.Pass.call(this),this.textureID=void 0!==r?r:"tDiffuse",t instanceof e.ShaderMaterial?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=e.UniformsUtils.clone(t.uniforms),this.material=new e.ShaderMaterial({defines:Object.assign({},t.defines),uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this.fsQuad=new e.Pass.FullScreenQuad(this.material)},e.ShaderPass.prototype=Object.assign(Object.create(e.Pass.prototype),{constructor:e.ShaderPass,render:function(e,t,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}}),e.ShaderPass}),e("skylark-threejs-ex/postprocessing/MaskPass",["skylark-threejs","./Pass"],function(e,t){return e.MaskPass=function(t,r){e.Pass.call(this),this.scene=t,this.camera=r,this.clear=!0,this.needsSwap=!1,this.inverse=!1},e.MaskPass.prototype=Object.assign(Object.create(e.Pass.prototype),{constructor:e.MaskPass,render:function(e,t,r){var a,n,i=e.getContext(),o=e.state;o.buffers.color.setMask(!1),o.buffers.depth.setMask(!1),o.buffers.color.setLocked(!0),o.buffers.depth.setLocked(!0),this.inverse?(a=0,n=1):(a=1,n=0),o.buffers.stencil.setTest(!0),o.buffers.stencil.setOp(i.REPLACE,i.REPLACE,i.REPLACE),o.buffers.stencil.setFunc(i.ALWAYS,a,4294967295),o.buffers.stencil.setClear(n),o.buffers.stencil.setLocked(!0),e.setRenderTarget(r),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),o.buffers.color.setLocked(!1),o.buffers.depth.setLocked(!1),o.buffers.stencil.setLocked(!1),o.buffers.stencil.setFunc(i.EQUAL,1,4294967295),o.buffers.stencil.setOp(i.KEEP,i.KEEP,i.KEEP),o.buffers.stencil.setLocked(!0)}}),e.ClearMaskPass=function(){e.Pass.call(this),this.needsSwap=!1},e.ClearMaskPass.prototype=Object.create(e.Pass.prototype),Object.assign(e.ClearMaskPass.prototype,{render:function(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}),e.MaskPass}),e("skylark-threejs-ex/postprocessing/EffectComposer",["skylark-threejs","../shaders/CopyShader","./ShaderPass","./MaskPass"],function(e){return e.EffectComposer=function(t,r){if(this.renderer=t,void 0===r){var a={minFilter:e.LinearFilter,magFilter:e.LinearFilter,format:e.RGBAFormat,stencilBuffer:!1},n=t.getSize(new e.Vector2);this._pixelRatio=t.getPixelRatio(),this._width=n.width,this._height=n.height,(r=new e.WebGLRenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio,a)).texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=r.width,this._height=r.height;this.renderTarget1=r,this.renderTarget2=r.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],void 0===e.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),void 0===e.ShaderPass&&console.error("THREE.EffectComposer relies on THREE.ShaderPass"),this.copyPass=new e.ShaderPass(e.CopyShader),this.clock=new e.Clock},Object.assign(e.EffectComposer.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)},insertPass:function(e,t){this.passes.splice(t,0,e)},isLastEnabledPass:function(e){for(var t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0},render:function(t){void 0===t&&(t=this.clock.getDelta());var r,a,n=this.renderer.getRenderTarget(),i=!1,o=this.passes.length;for(a=0;a<o;a++)if(!1!==(r=this.passes[a]).enabled){if(r.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(a),r.render(this.renderer,this.writeBuffer,this.readBuffer,t,i),r.needsSwap){if(i){var s=this.renderer.getContext(),l=this.renderer.state.buffers.stencil;l.setFunc(s.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,t),l.setFunc(s.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==e.MaskPass&&(r instanceof e.MaskPass?i=!0:r instanceof e.ClearMaskPass&&(i=!1))}this.renderer.setRenderTarget(n)},reset:function(t){if(void 0===t){var r=this.renderer.getSize(new e.Vector2);this._pixelRatio=this.renderer.getPixelRatio(),this._width=r.width,this._height=r.height,(t=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this._width=e,this._height=t;var r=this._width*this._pixelRatio,a=this._height*this._pixelRatio;this.renderTarget1.setSize(r,a),this.renderTarget2.setSize(r,a);for(var n=0;n<this.passes.length;n++)this.passes[n].setSize(r,a)},setPixelRatio:function(e){this._pixelRatio=e,this.setSize(this._width,this._height)}}),e.EffectComposer}),e("skylark-threejs-ex/postprocessing/RenderPass",["skylark-threejs","./Pass"],function(e,t){return e.RenderPass=function(t,r,a,n,i){e.Pass.call(this),this.scene=t,this.camera=r,this.overrideMaterial=a,this.clearColor=n,this.clearAlpha=void 0!==i?i:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1},e.RenderPass.prototype=Object.assign(Object.create(e.Pass.prototype),{constructor:e.RenderPass,render:function(e,t,r){var a,n,i,o=e.autoClear;e.autoClear=!1,void 0!==this.overrideMaterial&&(i=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(a=e.getClearColor().getHex(),n=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:r),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(a,n),void 0!==this.overrideMaterial&&(this.scene.overrideMaterial=i),e.autoClear=o}}),e.RenderPass}),e("skylark-threejs-ex/curves/NURBSUtils",["skylark-threejs"],function(e){return e.NURBSUtils={findSpan:function(e,t,r){var a=r.length-e-1;if(t>=r[a])return a-1;if(t<=r[e])return e;for(var n=e,i=a,o=Math.floor((n+i)/2);t<r[o]||t>=r[o+1];)t<r[o]?i=o:n=o,o=Math.floor((n+i)/2);return o},calcBasisFunctions:function(e,t,r,a){var n=[],i=[],o=[];n[0]=1;for(var s=1;s<=r;++s){i[s]=t-a[e+1-s],o[s]=a[e+s]-t;for(var l=0,u=0;u<s;++u){var c=o[u+1],f=i[s-u],d=n[u]/(c+f);n[u]=l+c*d,l=f*d}n[s]=l}return n},calcBSplinePoint:function(t,r,a,n){for(var i=this.findSpan(t,n,r),o=this.calcBasisFunctions(i,n,t,r),s=new e.Vector4(0,0,0,0),l=0;l<=t;++l){var u=a[i-t+l],c=o[l],f=u.w*c;s.x+=u.x*f,s.y+=u.y*f,s.z+=u.z*f,s.w+=u.w*c}return s},calcBasisFunctionDerivatives:function(e,t,r,a,n){for(var i=[],o=0;o<=r;++o)i[o]=0;for(var s=[],o=0;o<=a;++o)s[o]=i.slice(0);for(var l=[],o=0;o<=r;++o)l[o]=i.slice(0);l[0][0]=1;for(var u=i.slice(0),c=i.slice(0),f=1;f<=r;++f){u[f]=t-n[e+1-f],c[f]=n[e+f]-t;for(var d=0,h=0;h<f;++h){var p=c[h+1],m=u[f-h];l[f][h]=p+m;var v=l[h][f-1]/l[f][h];l[h][f]=d+p*v,d=m*v}l[f][f]=d}for(var f=0;f<=r;++f)s[0][f]=l[f][r];for(var h=0;h<=r;++h){for(var g=0,y=1,x=[],o=0;o<=r;++o)x[o]=i.slice(0);x[0][0]=1;for(var A=1;A<=a;++A){var b=0,T=h-A,w=r-A;h>=A&&(x[y][0]=x[g][0]/l[w+1][T],b=x[y][0]*l[T][w]);for(var F=T>=-1?1:-T,_=h-1<=w?A-1:r-h,f=F;f<=_;++f)x[y][f]=(x[g][f]-x[g][f-1])/l[w+1][T+f],b+=x[y][f]*l[T+f][w];h<=w&&(x[y][A]=-x[g][A-1]/l[w+1][h],b+=x[y][A]*l[h][w]),s[A][h]=b;var f=g;g=y,y=f}}for(var h=r,A=1;A<=a;++A){for(var f=0;f<=r;++f)s[A][f]*=h;h*=r-A}return s},calcBSplineDerivatives:function(t,r,a,n,i){for(var o=i<t?i:t,s=[],l=this.findSpan(t,n,r),u=this.calcBasisFunctionDerivatives(l,n,t,o,r),c=[],f=0;f<a.length;++f){var d=a[f].clone(),h=d.w;d.x*=h,d.y*=h,d.z*=h,c[f]=d}for(var p=0;p<=o;++p){for(var d=c[l-t].clone().multiplyScalar(u[p][0]),m=1;m<=t;++m)d.add(c[l-t+m].clone().multiplyScalar(u[p][m]));s[p]=d}for(var p=o+1;p<=i+1;++p)s[p]=new e.Vector4(0,0,0);return s},calcKoverI:function(e,t){for(var r=1,a=2;a<=e;++a)r*=a;for(var n=1,a=2;a<=t;++a)n*=a;for(var a=2;a<=e-t;++a)n*=a;return r/n},calcRationalCurveDerivatives:function(t){for(var r=t.length,a=[],n=[],i=0;i<r;++i){var o=t[i];a[i]=new e.Vector3(o.x,o.y,o.z),n[i]=o.w}for(var s=[],l=0;l<r;++l){for(var u=a[l].clone(),i=1;i<=l;++i)u.sub(s[l-i].clone().multiplyScalar(this.calcKoverI(l,i)*n[i]));s[l]=u.divideScalar(n[0])}return s},calcNURBSDerivatives:function(e,t,r,a,n){var i=this.calcBSplineDerivatives(e,t,r,a,n);return this.calcRationalCurveDerivatives(i)},calcSurfacePoint:function(t,r,a,n,i,o,s,l){for(var u=this.findSpan(t,o,a),c=this.findSpan(r,s,n),f=this.calcBasisFunctions(u,o,t,a),d=this.calcBasisFunctions(c,s,r,n),h=[],p=0;p<=r;++p){h[p]=new e.Vector4(0,0,0,0);for(var m=0;m<=t;++m){var v=i[u-t+m][c-r+p].clone(),g=v.w;v.x*=g,v.y*=g,v.z*=g,h[p].add(v.multiplyScalar(f[m]))}}for(var y=new e.Vector4(0,0,0,0),p=0;p<=r;++p)y.add(h[p].multiplyScalar(d[p]));y.divideScalar(y.w),l.set(y.x,y.y,y.z)}},e.NURBSUtils}),e("skylark-threejs-ex/curves/NURBSCurve",["skylark-threejs","./NURBSUtils"],function(e){return e.NURBSCurve=function(t,r,a,n,i){e.Curve.call(this),this.degree=t,this.knots=r,this.controlPoints=[],this.startKnot=n||0,this.endKnot=i||this.knots.length-1;for(var o=0;o<a.length;++o){var s=a[o];this.controlPoints[o]=new e.Vector4(s.x,s.y,s.z,s.w)}},e.NURBSCurve.prototype=Object.create(e.Curve.prototype),e.NURBSCurve.prototype.constructor=e.NURBSCurve,e.NURBSCurve.prototype.getPoint=function(t){var r=this.knots[this.startKnot]+t*(this.knots[this.endKnot]-this.knots[this.startKnot]),a=e.NURBSUtils.calcBSplinePoint(this.degree,this.knots,this.controlPoints,r);return 1!=a.w&&a.divideScalar(a.w),new e.Vector3(a.x,a.y,a.z)},e.NURBSCurve.prototype.getTangent=function(t){var r=this.knots[0]+t*(this.knots[this.knots.length-1]-this.knots[0]),a=e.NURBSUtils.calcNURBSDerivatives(this.degree,this.knots,this.controlPoints,r,1),n=a[1].clone();return n.normalize(),n},e.NURBSCurve}),e("skylark-threejs-ex/curves/NURBSSurface",["skylark-threejs","./NURBSUtils"],function(e){return e.NURBSSurface=function(t,r,a,n,i){this.degree1=t,this.degree2=r,this.knots1=a,this.knots2=n,this.controlPoints=[];for(var o=a.length-t-1,s=n.length-r-1,l=0;l<o;++l){this.controlPoints[l]=[];for(var u=0;u<s;++u){var c=i[l][u];this.controlPoints[l][u]=new e.Vector4(c.x,c.y,c.z,c.w)}}},e.NURBSSurface.prototype={constructor:e.NURBSSurface,getPoint:function(t,r,a){var n=this.knots1[0]+t*(this.knots1[this.knots1.length-1]-this.knots1[0]),i=this.knots2[0]+r*(this.knots2[this.knots2.length-1]-this.knots2[0]);e.NURBSUtils.calcSurfacePoint(this.degree1,this.degree2,this.knots1,this.knots2,this.controlPoints,n,i,a)}},e.NURBSSurface}),e("skylark-threejs-ex/objects/Lensflare",["skylark-threejs"],function(e){var t,r,a;return e.Lensflare=function(){e.Mesh.call(this,e.Lensflare.Geometry,new e.MeshBasicMaterial({opacity:0,transparent:!0})),this.type="Lensflare",this.frustumCulled=!1,this.renderOrder=1/0;var t=new e.Vector3,r=new e.Vector3,a=new e.DataTexture(new Uint8Array(768),16,16,e.RGBFormat);a.minFilter=e.NearestFilter,a.magFilter=e.NearestFilter,a.wrapS=e.ClampToEdgeWrapping,a.wrapT=e.ClampToEdgeWrapping;var n=new e.DataTexture(new Uint8Array(768),16,16,e.RGBFormat);n.minFilter=e.NearestFilter,n.magFilter=e.NearestFilter,n.wrapS=e.ClampToEdgeWrapping,n.wrapT=e.ClampToEdgeWrapping;var i=e.Lensflare.Geometry,o=new e.RawShaderMaterial({uniforms:{scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","attribute vec3 position;","void main() {","\tgl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","void main() {","\tgl_FragColor = vec4( 1.0, 0.0, 1.0, 1.0 );","}"].join("\n"),depthTest:!0,depthWrite:!1,transparent:!1}),s=new e.RawShaderMaterial({uniforms:{map:{value:a},scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","attribute vec3 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","\tvUV = uv;","\tgl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","varying vec2 vUV;","void main() {","\tgl_FragColor = texture2D( map, vUV );","}"].join("\n"),depthTest:!1,depthWrite:!1,transparent:!1}),l=new e.Mesh(i,o),u=[],c=e.LensflareElement.Shader,f=new e.RawShaderMaterial({uniforms:{map:{value:null},occlusionMap:{value:n},color:{value:new e.Color(16777215)},scale:{value:new e.Vector2},screenPosition:{value:new e.Vector3}},vertexShader:c.vertexShader,fragmentShader:c.fragmentShader,blending:e.AdditiveBlending,transparent:!0,depthWrite:!1}),d=new e.Mesh(i,f);this.addElement=function(e){u.push(e)};var h=new e.Vector2,p=new e.Vector2,m=new e.Box2,v=new e.Vector4;this.onBeforeRender=function(e,c,g){e.getCurrentViewport(v);var y=v.w/v.z,x=v.z/2,A=v.w/2,b=16/v.w;if(h.set(b*y,b),m.min.set(v.x,v.y),m.max.set(v.x+(v.z-16),v.y+(v.w-16)),r.setFromMatrixPosition(this.matrixWorld),r.applyMatrix4(g.matrixWorldInverse),!(r.z>0)&&(t.copy(r).applyMatrix4(g.projectionMatrix),p.x=v.x+t.x*x+x-8,p.y=v.y+t.y*A+A-8,m.containsPoint(p))){e.copyFramebufferToTexture(p,a);var T=o.uniforms;T.scale.value=h,T.screenPosition.value=t,e.renderBufferDirect(g,null,i,o,l,null),e.copyFramebufferToTexture(p,n);var T=s.uniforms;T.scale.value=h,T.screenPosition.value=t,e.renderBufferDirect(g,null,i,s,l,null);for(var w=2*-t.x,F=2*-t.y,_=0,E=u.length;_<E;_++){var L=u[_],T=f.uniforms;T.color.value.copy(L.color),T.map.value=L.texture,T.screenPosition.value.x=t.x+w*L.distance,T.screenPosition.value.y=t.y+F*L.distance;var b=L.size/v.w,y=v.w/v.z;T.scale.value.set(b*y,b),f.uniformsNeedUpdate=!0,e.renderBufferDirect(g,null,i,f,d,null)}}},this.dispose=function(){o.dispose(),s.dispose(),f.dispose(),a.dispose(),n.dispose();for(var e=0,t=u.length;e<t;e++)u[e].texture.dispose()}},e.Lensflare.prototype=Object.create(e.Mesh.prototype),e.Lensflare.prototype.constructor=e.Lensflare,e.Lensflare.prototype.isLensflare=!0,e.LensflareElement=function(t,r,a,n){this.texture=t,this.size=r||1,this.distance=a||0,this.color=n||new e.Color(16777215)},e.LensflareElement.Shader={uniforms:{map:{value:null},occlusionMap:{value:null},color:{value:null},scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform sampler2D occlusionMap;","attribute vec3 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","\tvUV = uv;","\tvec2 pos = position.xy;","\tvec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","\tvVisibility =        visibility.r / 9.0;","\tvVisibility *= 1.0 - visibility.g / 9.0;","\tvVisibility *=       visibility.b / 9.0;","\tgl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","\tvec4 texture = texture2D( map, vUV );","\ttexture.a *= vVisibility;","\tgl_FragColor = texture;","\tgl_FragColor.rgb *= color;","}"].join("\n")},e.Lensflare.Geometry=(t=new e.BufferGeometry,r=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,1,1,0,1,1,-1,1,0,0,1]),a=new e.InterleavedBuffer(r,5),t.setIndex([0,1,2,0,2,3]),t.setAttribute("position",new e.InterleavedBufferAttribute(a,3,0,!1)),t.setAttribute("uv",new e.InterleavedBufferAttribute(a,2,3,!1)),t),e.Lensflare}),e("skylark-threejs-ex/objects/Reflector",["skylark-threejs"],function(e){return e.Reflector=function(t,r){e.Mesh.call(this,t),this.type="Reflector";var a=this,n=void 0!==(r=r||{}).color?new e.Color(r.color):new e.Color(8355711),i=r.textureWidth||512,o=r.textureHeight||512,s=r.clipBias||0,l=r.shader||e.Reflector.ReflectorShader,u=void 0!==r.recursion?r.recursion:0,c=void 0!==r.encoding?r.encoding:e.LinearEncoding,f=new e.Plane,d=new e.Vector3,h=new e.Vector3,p=new e.Vector3,m=new e.Matrix4,v=new e.Vector3(0,0,-1),g=new e.Vector4,y=new e.Vector3,x=new e.Vector3,A=new e.Vector4,b=new e.Matrix4,T=new e.PerspectiveCamera,w={minFilter:e.LinearFilter,magFilter:e.LinearFilter,format:e.RGBFormat,stencilBuffer:!1,encoding:c},F=new e.WebGLRenderTarget(i,o,w);e.MathUtils.isPowerOfTwo(i)&&e.MathUtils.isPowerOfTwo(o)||(F.texture.generateMipmaps=!1);var _=new e.ShaderMaterial({uniforms:e.UniformsUtils.clone(l.uniforms),fragmentShader:l.fragmentShader,vertexShader:l.vertexShader});_.uniforms.tDiffuse.value=F.texture,_.uniforms.color.value=n,_.uniforms.textureMatrix.value=b,this.material=_,this.onBeforeRender=function(e,t,r){if("recursion"in r.userData){if(r.userData.recursion===u)return;r.userData.recursion++}if(h.setFromMatrixPosition(a.matrixWorld),p.setFromMatrixPosition(r.matrixWorld),m.extractRotation(a.matrixWorld),d.set(0,0,1),d.applyMatrix4(m),y.subVectors(h,p),!(y.dot(d)>0)){y.reflect(d).negate(),y.add(h),m.extractRotation(r.matrixWorld),v.set(0,0,-1),v.applyMatrix4(m),v.add(p),x.subVectors(h,v),x.reflect(d).negate(),x.add(h),T.position.copy(y),T.up.set(0,1,0),T.up.applyMatrix4(m),T.up.reflect(d),T.lookAt(x),T.far=r.far,T.updateMatrixWorld(),T.projectionMatrix.copy(r.projectionMatrix),T.userData.recursion=0,b.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),b.multiply(T.projectionMatrix),b.multiply(T.matrixWorldInverse),b.multiply(a.matrixWorld),f.setFromNormalAndCoplanarPoint(d,h),f.applyMatrix4(T.matrixWorldInverse),g.set(f.normal.x,f.normal.y,f.normal.z,f.constant);var n=T.projectionMatrix;A.x=(Math.sign(g.x)+n.elements[8])/n.elements[0],A.y=(Math.sign(g.y)+n.elements[9])/n.elements[5],A.z=-1,A.w=(1+n.elements[10])/n.elements[14],g.multiplyScalar(2/g.dot(A)),n.elements[2]=g.x,n.elements[6]=g.y,n.elements[10]=g.z+1-s,n.elements[14]=g.w,a.visible=!1;var i=e.getRenderTarget(),o=e.xr.enabled,l=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(F),!1===e.autoClear&&e.clear(),e.render(t,T),e.xr.enabled=o,e.shadowMap.autoUpdate=l,e.setRenderTarget(i);var c=r.viewport;void 0!==c&&e.state.viewport(c),a.visible=!0}},this.getRenderTarget=function(){return F}},e.Reflector.prototype=Object.create(e.Mesh.prototype),e.Reflector.prototype.constructor=e.Reflector,e.Reflector.ReflectorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:["uniform mat4 textureMatrix;","varying vec4 vUv;","void main() {","\tvUv = textureMatrix * vec4( position, 1.0 );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D tDiffuse;","varying vec4 vUv;","float blendOverlay( float base, float blend ) {","\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );","}","vec3 blendOverlay( vec3 base, vec3 blend ) {","\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );","}","void main() {","\tvec4 base = texture2DProj( tDiffuse, vUv );","\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );","}"].join("\n")},e.Reflector}),e("skylark-threejs-ex/objects/Refractor",["skylark-threejs"],function(e){return e.Refractor=function(t,r){e.Mesh.call(this,t),this.type="Refractor";var a=this,n=void 0!==(r=r||{}).color?new e.Color(r.color):new e.Color(8355711),i=r.textureWidth||512,o=r.textureHeight||512,s=r.clipBias||0,l=r.shader||e.Refractor.RefractorShader,u=void 0!==r.encoding?r.encoding:e.LinearEncoding,c=new e.PerspectiveCamera;c.matrixAutoUpdate=!1,c.userData.refractor=!0;var f=new e.Plane,d=new e.Matrix4,h={minFilter:e.LinearFilter,magFilter:e.LinearFilter,format:e.RGBFormat,stencilBuffer:!1,encoding:u},p=new e.WebGLRenderTarget(i,o,h);e.MathUtils.isPowerOfTwo(i)&&e.MathUtils.isPowerOfTwo(o)||(p.texture.generateMipmaps=!1),this.material=new e.ShaderMaterial({uniforms:e.UniformsUtils.clone(l.uniforms),vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,transparent:!0}),this.material.uniforms.color.value=n,this.material.uniforms.tDiffuse.value=p.texture,this.material.uniforms.textureMatrix.value=d;var m,v,g,y,x,A,b,T,w=(m=new e.Vector3,v=new e.Vector3,g=new e.Matrix4,y=new e.Vector3,x=new e.Vector3,function(e){return m.setFromMatrixPosition(a.matrixWorld),v.setFromMatrixPosition(e.matrixWorld),y.subVectors(m,v),g.extractRotation(a.matrixWorld),x.set(0,0,1),x.applyMatrix4(g),y.dot(x)<0}),F=function(){var t=new e.Vector3,r=new e.Vector3,n=new e.Quaternion,i=new e.Vector3;return function(){a.matrixWorld.decompose(r,n,i),t.set(0,0,1).applyQuaternion(n).normalize(),t.negate(),f.setFromNormalAndCoplanarPoint(t,r)}}(),_=(A=new e.Plane,b=new e.Vector4,T=new e.Vector4,function(e){c.matrixWorld.copy(e.matrixWorld),c.matrixWorldInverse.getInverse(c.matrixWorld),c.projectionMatrix.copy(e.projectionMatrix),c.far=e.far,A.copy(f),A.applyMatrix4(c.matrixWorldInverse),b.set(A.normal.x,A.normal.y,A.normal.z,A.constant);var t=c.projectionMatrix;T.x=(Math.sign(b.x)+t.elements[8])/t.elements[0],T.y=(Math.sign(b.y)+t.elements[9])/t.elements[5],T.z=-1,T.w=(1+t.elements[10])/t.elements[14],b.multiplyScalar(2/b.dot(T)),t.elements[2]=b.x,t.elements[6]=b.y,t.elements[10]=b.z+1-s,t.elements[14]=b.w});this.onBeforeRender=function(e,t,r){!0!==r.userData.refractor&&!0!=!w(r)&&(F(),function(e){d.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),d.multiply(e.projectionMatrix),d.multiply(e.matrixWorldInverse),d.multiply(a.matrixWorld)}(r),_(r),function(e,t,r){a.visible=!1;var n=e.getRenderTarget(),i=e.xr.enabled,o=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(p),!1===e.autoClear&&e.clear();e.render(t,c),e.xr.enabled=i,e.shadowMap.autoUpdate=o,e.setRenderTarget(n);var s=r.viewport;void 0!==s&&e.state.viewport(s);a.visible=!0}(e,t,r))},this.getRenderTarget=function(){return p}},e.Refractor.prototype=Object.create(e.Mesh.prototype),e.Refractor.prototype.constructor=e.Refractor,e.Refractor.RefractorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:["uniform mat4 textureMatrix;","varying vec4 vUv;","void main() {","\tvUv = textureMatrix * vec4( position, 1.0 );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D tDiffuse;","varying vec4 vUv;","float blendOverlay( float base, float blend ) {","\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );","}","vec3 blendOverlay( vec3 base, vec3 blend ) {","\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );","}","void main() {","\tvec4 base = texture2DProj( tDiffuse, vUv );","\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );","}"].join("\n")},e.Refractor}),e("skylark-threejs-ex/loaders/TTFLoader",["skylark-threejs"],function(e){return e.TTFLoader=function(t){e.Loader.call(this,t),this.reversed=!1},e.TTFLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.TTFLoader,load:function(t,r,a,n){var i=this,o=new e.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.load(t,function(e){r(i.parse(e))},a,n)},parse:function(e){function t(e){var t,r=[];e.forEach(function(e){"m"===e.type.toLowerCase()?(t=[e],r.push(t)):"z"!==e.type.toLowerCase()&&t.push(e)});var a=[];return r.forEach(function(e){var t={type:"m",x:e[e.length-1].x,y:e[e.length-1].y};a.push(t);for(var r=e.length-1;r>0;r--){var n=e[r],t={type:n.type};void 0!==n.x2&&void 0!==n.y2?(t.x1=n.x2,t.y1=n.y2,t.x2=n.x1,t.y2=n.y1):void 0!==n.x1&&void 0!==n.y1&&(t.x1=n.x1,t.y1=n.y1),t.x=e[r-1].x,t.y=e[r-1].y,a.push(t)}}),a}return"undefined"==typeof opentype?(console.warn("THREE.TTFLoader: The loader requires opentype.js. Make sure it's included before using the loader."),null):function(e,r){for(var a=Math.round,n={},i=1e5/(72*(e.unitsPerEm||2048)),o=e.encoding.cmap.glyphIndexMap,s=Object.keys(o),l=0;l<s.length;l++){var u=s[l],c=e.glyphs.glyphs[o[u]];if(void 0!==u){var f={ha:a(c.advanceWidth*i),x_min:a(c.xMin*i),x_max:a(c.xMax*i),o:""};r&&(c.path.commands=t(c.path.commands)),c.path.commands.forEach(function(e){"c"===e.type.toLowerCase()&&(e.type="b"),f.o+=e.type.toLowerCase()+" ",void 0!==e.x&&void 0!==e.y&&(f.o+=a(e.x*i)+" "+a(e.y*i)+" "),void 0!==e.x1&&void 0!==e.y1&&(f.o+=a(e.x1*i)+" "+a(e.y1*i)+" "),void 0!==e.x2&&void 0!==e.y2&&(f.o+=a(e.x2*i)+" "+a(e.y2*i)+" ")}),n[String.fromCodePoint(c.unicode)]=f}}return{glyphs:n,familyName:e.getEnglishName("fullName"),ascender:a(e.ascender*i),descender:a(e.descender*i),underlinePosition:e.tables.post.underlinePosition,underlineThickness:e.tables.post.underlineThickness,boundingBox:{xMin:e.tables.head.xMin,xMax:e.tables.head.xMax,yMin:e.tables.head.yMin,yMax:e.tables.head.yMax},resolution:1e3,original_font_information:e.tables.name}}(opentype.parse(e),this.reversed)}}),e.TTFLoader}),e("skylark-threejs-ex/loaders/3MFLoader",["skylark-threejs"],function(e){return e.ThreeMFLoader=function(t){e.Loader.call(this,t),this.availableExtensions=[]},e.ThreeMFLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.ThreeMFLoader,load:function(t,r,a,n){var i=this,o=new e.FileLoader(i.manager);o.setPath(i.path),o.setResponseType("arraybuffer"),o.load(t,function(e){r(i.parse(e))},a,n)},parse:function(t){var r=this,a=new e.TextureLoader(this.manager);function n(e){for(var t=[],r=(new DOMParser).parseFromString(e,"application/xml"),a=r.querySelectorAll("Relationship"),n=0;n<a.length;n++){var i=a[n],o={target:i.getAttribute("Target"),id:i.getAttribute("Id"),type:i.getAttribute("Type")};t.push(o)}return t}function i(e){for(var t={id:e.getAttribute("id"),basematerials:[]},r=e.querySelectorAll("base"),a=0;a<r.length;a++){var n=r[a],i=u(n);i.index=a,t.basematerials.push(i)}return t}function o(e){for(var t={id:e.getAttribute("id"),texid:e.getAttribute("texid"),displaypropertiesid:e.getAttribute("displaypropertiesid")},r=e.querySelectorAll("tex2coord"),a=[],n=0;n<r.length;n++){var i=r[n],o=i.getAttribute("u"),s=i.getAttribute("v");a.push(parseFloat(o),parseFloat(s))}return t.uvs=new Float32Array(a),t}function s(t){for(var r={id:t.getAttribute("id"),displaypropertiesid:t.getAttribute("displaypropertiesid")},a=t.querySelectorAll("color"),n=[],i=new e.Color,o=0;o<a.length;o++){var s=a[o],l=s.getAttribute("color");i.setStyle(l.substring(0,7)),i.convertSRGBToLinear(),n.push(i.r,i.g,i.b)}return r.colors=new Float32Array(n),r}function l(e){for(var t={id:e.getAttribute("id")},r=e.querySelectorAll("pbmetallic"),a=[],n=0;n<r.length;n++){var i=r[n];a.push({name:i.getAttribute("name"),metallicness:parseFloat(i.getAttribute("metallicness")),roughness:parseFloat(i.getAttribute("roughness"))})}return t.data=a,t}function u(e){var t={};return t.name=e.getAttribute("name"),t.displaycolor=e.getAttribute("displaycolor"),t.displaypropertiesid=e.getAttribute("displaypropertiesid"),t}function c(e){var t={};t.objectId=e.getAttribute("objectid");var r=e.getAttribute("transform");return r&&(t.transform=f(r)),t}function f(t){var r=[];t.split(" ").forEach(function(e){r.push(parseFloat(e))});var a=new e.Matrix4;return a.set(r[0],r[3],r[6],r[9],r[1],r[4],r[7],r[10],r[2],r[5],r[8],r[11],0,0,0,1),a}function d(e){var t={type:e.getAttribute("type")},r=e.getAttribute("id");r&&(t.id=r);var a=e.getAttribute("pid");a&&(t.pid=a);var n=e.getAttribute("pindex");n&&(t.pindex=n);var i=e.getAttribute("thumbnail");i&&(t.thumbnail=i);var o=e.getAttribute("partnumber");o&&(t.partnumber=o);var s=e.getAttribute("name");s&&(t.name=s);var l=e.querySelector("mesh");l&&(t.mesh=function(e){for(var t={},r=[],a=e.querySelectorAll("vertices vertex"),n=0;n<a.length;n++){var i=a[n],o=i.getAttribute("x"),s=i.getAttribute("y"),l=i.getAttribute("z");r.push(parseFloat(o),parseFloat(s),parseFloat(l))}t.vertices=new Float32Array(r);for(var u=[],c=[],f=e.querySelectorAll("triangles triangle"),n=0;n<f.length;n++){var d=f[n],h=d.getAttribute("v1"),p=d.getAttribute("v2"),m=d.getAttribute("v3"),v=d.getAttribute("p1"),g=d.getAttribute("p2"),y=d.getAttribute("p3"),x=d.getAttribute("pid"),A={};A.v1=parseInt(h,10),A.v2=parseInt(p,10),A.v3=parseInt(m,10),c.push(A.v1,A.v2,A.v3),v&&(A.p1=parseInt(v,10)),g&&(A.p2=parseInt(g,10)),y&&(A.p3=parseInt(y,10)),x&&(A.pid=x),0<Object.keys(A).length&&u.push(A)}return t.triangleProperties=u,t.triangles=new Uint32Array(c),t}(l));var u=e.querySelector("components");return u&&(t.components=function(e){for(var t=[],r=e.querySelectorAll("component"),a=0;a<r.length;a++){var n=r[a],i=c(n);t.push(i)}return t}(u)),t}function h(e){var t={unit:e.getAttribute("unit")||"millimeter"},r=e.querySelectorAll("metadata");r&&(t.metadata=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r],n=a.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(n)&&(t[n]=a.textContent)}return t}(r));var a=e.querySelector("resources");a&&(t.resources=function(e){for(var t={basematerials:{}},r=e.querySelectorAll("basematerials"),a=0;a<r.length;a++){var n=r[a],u=i(n);t.basematerials[u.id]=u}t.texture2d={};for(var c=e.querySelectorAll("texture2d"),a=0;a<c.length;a++){var f=c[a],h=(p=f,void 0,{id:(p=f).getAttribute("id"),path:p.getAttribute("path"),contenttype:p.getAttribute("contenttype"),tilestyleu:p.getAttribute("tilestyleu"),tilestylev:p.getAttribute("tilestylev"),filter:p.getAttribute("filter")});t.texture2d[h.id]=h}var p;t.colorgroup={};for(var m=e.querySelectorAll("colorgroup"),a=0;a<m.length;a++){var v=m[a],g=s(v);t.colorgroup[g.id]=g}t.pbmetallicdisplayproperties={};for(var y=e.querySelectorAll("pbmetallicdisplayproperties"),a=0;a<y.length;a++){var x=y[a],A=l(x);t.pbmetallicdisplayproperties[A.id]=A}t.texture2dgroup={};for(var b=e.querySelectorAll("texture2dgroup"),a=0;a<b.length;a++){var T=b[a],w=o(T);t.texture2dgroup[w.id]=w}t.object={};for(var F=e.querySelectorAll("object"),a=0;a<F.length;a++){var _=F[a],E=d(_);t.object[E.id]=E}return t}(a));var n=e.querySelector("build");return n&&(t.build=function(e){for(var t=[],r=e.querySelectorAll("item"),a=0;a<r.length;a++){var n=r[a],i={objectId:n.getAttribute("objectid")},o=n.getAttribute("transform");o&&(i.transform=f(o)),t.push(i)}return t}(n)),t}function p(t,r,n,i){var o=t.texid,s=n.resources.texture2d,l=s[o];if(l){var u=i[l.path],c=l.contenttype,f=new Blob([u],{type:c}),d=URL.createObjectURL(f),h=a.load(d,function(){URL.revokeObjectURL(d)});switch(h.encoding=e.sRGBEncoding,l.tilestyleu){case"wrap":h.wrapS=e.RepeatWrapping;break;case"mirror":h.wrapS=e.MirroredRepeatWrapping;break;case"none":case"clamp":h.wrapS=e.ClampToEdgeWrapping;break;default:h.wrapS=e.RepeatWrapping}switch(l.tilestylev){case"wrap":h.wrapT=e.RepeatWrapping;break;case"mirror":h.wrapT=e.MirroredRepeatWrapping;break;case"none":case"clamp":h.wrapT=e.ClampToEdgeWrapping;break;default:h.wrapT=e.RepeatWrapping}switch(l.filter){case"auto":h.magFilter=e.LinearFilter,h.minFilter=e.LinearMipmapLinearFilter;break;case"linear":h.magFilter=e.LinearFilter,h.minFilter=e.LinearFilter;break;case"nearest":h.magFilter=e.NearestFilter,h.minFilter=e.NearestFilter;break;default:h.magFilter=e.LinearFilter,h.minFilter=e.LinearMipmapLinearFilter}return h}return null}function m(t,r,a,n,i,o){for(var s=o.pindex,l={},u=0,c=r.length;u<c;u++){var f=r[u],d=void 0!==f.p1?f.p1:s;void 0===l[d]&&(l[d]=[]),l[d].push(f)}for(var h=Object.keys(l),p=[],u=0,c=h.length;u<c;u++){for(var m=h[u],v=l[m],g=t.basematerials[m],y=b(g,E,a,i,o,T),x=new e.BufferGeometry,A=[],w=n.vertices,F=0,_=v.length;F<_;F++){var f=v[F];A.push(w[3*f.v1+0]),A.push(w[3*f.v1+1]),A.push(w[3*f.v1+2]),A.push(w[3*f.v2+0]),A.push(w[3*f.v2+1]),A.push(w[3*f.v2+2]),A.push(w[3*f.v3+0]),A.push(w[3*f.v3+1]),A.push(w[3*f.v3+2])}x.setAttribute("position",new e.Float32BufferAttribute(A,3));var L=new e.Mesh(x,y);p.push(L)}return p}function v(t,r,a,n,i,o){for(var s=new e.BufferGeometry,l=[],u=[],c=n.vertices,f=t.uvs,d=0,h=r.length;d<h;d++){var m=r[d];l.push(c[3*m.v1+0]),l.push(c[3*m.v1+1]),l.push(c[3*m.v1+2]),l.push(c[3*m.v2+0]),l.push(c[3*m.v2+1]),l.push(c[3*m.v2+2]),l.push(c[3*m.v3+0]),l.push(c[3*m.v3+1]),l.push(c[3*m.v3+2]),u.push(f[2*m.p1+0]),u.push(f[2*m.p1+1]),u.push(f[2*m.p2+0]),u.push(f[2*m.p2+1]),u.push(f[2*m.p3+0]),u.push(f[2*m.p3+1])}s.setAttribute("position",new e.Float32BufferAttribute(l,3)),s.setAttribute("uv",new e.Float32BufferAttribute(u,2));var v=b(t,E,a,i,o,p),g=new e.MeshPhongMaterial({map:v,flatShading:!0}),y=new e.Mesh(s,g);return y}function g(t,r,a,n){for(var i=new e.BufferGeometry,o=[],s=[],l=n.vertices,u=t.colors,c=0,f=r.length;c<f;c++){var d=r[c],h=d.v1,p=d.v2,m=d.v3;o.push(l[3*h+0]),o.push(l[3*h+1]),o.push(l[3*h+2]),o.push(l[3*p+0]),o.push(l[3*p+1]),o.push(l[3*p+2]),o.push(l[3*m+0]),o.push(l[3*m+1]),o.push(l[3*m+2]);var v=d.p1,g=d.p2,y=d.p3;s.push(u[3*v+0]),s.push(u[3*v+1]),s.push(u[3*v+2]),s.push(u[3*(g||v)+0]),s.push(u[3*(g||v)+1]),s.push(u[3*(g||v)+2]),s.push(u[3*(y||v)+0]),s.push(u[3*(y||v)+1]),s.push(u[3*(y||v)+2])}i.setAttribute("position",new e.Float32BufferAttribute(o,3)),i.setAttribute("color",new e.Float32BufferAttribute(s,3));var x=new e.MeshPhongMaterial({vertexColors:!0,flatShading:!0}),A=new e.Mesh(i,x);return A}function y(t){var r=new e.BufferGeometry;r.setIndex(new e.BufferAttribute(t.triangles,1)),r.setAttribute("position",new e.BufferAttribute(t.vertices,3));var a=new e.MeshPhongMaterial({color:11184895,flatShading:!0}),n=new e.Mesh(r,a);return n}function x(e,t){return void 0!==t.resources.texture2dgroup[e]?"texture":void 0!==t.resources.basematerials[e]?"material":void 0!==t.resources.colorgroup[e]?"vertexColors":"default"===e?"default":void 0}function A(t,r,a,n,i){for(var o=new e.Group,s=function(e,t,r){for(var a={},n=t.triangleProperties,i=r.pid,o=0,s=n.length;o<s;o++){var l=n[o],u=void 0!==l.pid?l.pid:i;void 0===u&&(u="default"),void 0===a[u]&&(a[u]=[]),a[u].push(l)}return a}(0,t,i),l=function(e,t,r,a,n){for(var i=Object.keys(e),o=[],s=0,l=i.length;s<l;s++){var u=i[s],c=e[u],f=x(u,t);switch(f){case"material":for(var d=t.resources.basematerials[u],h=m(d,c,t,r,a,n),p=0,A=h.length;p<A;p++)o.push(h[p]);break;case"texture":var b=t.resources.texture2dgroup[u];o.push(v(b,c,t,r,a,n));break;case"vertexColors":var T=t.resources.colorgroup[u];o.push(g(T,c,t,r));break;case"default":o.push(y(r));break;default:console.error("THREE.3MFLoader: Unsupported resource type.")}}return o}(s,a,t,n,i),u=0,c=l.length;u<c;u++)o.add(l[u]);return o}function b(e,t,r,a,n,i){return void 0!==e.build?e.build:(e.build=i(e,t,r,a,n),e.build)}function T(t,r,a){var n,i=t.displaypropertiesid,o=a.resources.pbmetallicdisplayproperties;if(null!==i&&void 0!==o[i]){var s=o[i],l=s.data[t.index];n=new e.MeshStandardMaterial({flatShading:!0,roughness:l.roughness,metalness:l.metallicness})}else n=new e.MeshPhongMaterial({flatShading:!0});n.name=t.name;var u=t.displaycolor,c=u.substring(0,7);return n.color.setStyle(c),n.color.convertSRGBToLinear(),9===u.length&&(n.opacity=parseInt(u.charAt(7)+u.charAt(8),16)/255),n}function w(t,r,a,n){for(var i=new e.Group,o=0;o<t.length;o++){var s=t[o],l=r[s.objectId];void 0===l&&(F(s.objectId,r,a,n),l=r[s.objectId]);var u=l.clone(),c=s.transform;c&&u.applyMatrix4(c),i.add(u)}return i}function F(e,t,a,n){var i=a.resources.object[e];if(i.mesh){var o=i.mesh,s=a.extensions,l=a.xml;!function(e,t,a){if(!e)return;for(var n=[],i=Object.keys(e),o=0;o<i.length;o++)for(var s=i[o],l=0;l<r.availableExtensions.length;l++){var u=r.availableExtensions[l];u.ns===s&&n.push(u)}for(var o=0;o<n.length;o++){var u=n[o];u.apply(a,e[u.ns],t)}}(s,o,l),t[i.id]=b(o,t,a,n,i,A)}else{var u=i.components;t[i.id]=b(u,t,a,n,i,w)}}var _=function(t){var r,a,i,o,s=null,l=null,u=[],c=[],f=[],d=[],p={},m={};try{s=new JSZip(t)}catch(e){if(e instanceof ReferenceError)return console.error("THREE.3MFLoader: jszip missing and file is compressed."),null}for(l in s.files)l.match(/\_rels\/.rels$/)?r=l:l.match(/3D\/_rels\/.*\.model\.rels$/)?a=l:l.match(/^3D\/.*\.model$/)?u.push(l):l.match(/^3D\/Metadata\/.*\.xml$/)?c.push(l):l.match(/^3D\/Textures?\/.*/)?f.push(l):l.match(/^3D\/Other\/.*/)&&d.push(l);var v=new Uint8Array(s.file(r).asArrayBuffer()),g=e.LoaderUtils.decodeText(v);if(i=n(g),a){var v=new Uint8Array(s.file(a).asArrayBuffer()),g=e.LoaderUtils.decodeText(v);o=n(g)}for(var y=0;y<u.length;y++){var x=u[y],A=new Uint8Array(s.file(x).asArrayBuffer()),b=e.LoaderUtils.decodeText(A),T=(new DOMParser).parseFromString(b,"application/xml");"model"!==T.documentElement.nodeName.toLowerCase()&&console.error("THREE.3MFLoader: Error loading 3MF - no 3MF document found: ",x);for(var w=T.querySelector("model"),F={},y=0;y<w.attributes.length;y++){var _=w.attributes[y];_.name.match(/^xmlns:(.+)$/)&&(F[_.value]=RegExp.$1)}var E=h(w);E.xml=w,0<Object.keys(F).length&&(E.extensions=F),p[x]=E}for(var y=0;y<f.length;y++){var L=f[y];m[L]=s.file(L).asArrayBuffer()}return{rels:i,modelRels:o,model:p,printTicket:{},texture:m,other:{}}}(t),E=function(e){var t=e.model,r=e.modelRels,a={},n=Object.keys(t),i={};if(r)for(var o=0,s=r.length;o<s;o++){var l=r[o],u=l.target.substring(1);e.texture[u]&&(i[l.target]=e.texture[u])}for(var o=0;o<n.length;o++)for(var c=n[o],f=t[c],d=Object.keys(f.resources.object),h=0;h<d.length;h++){var p=d[h];F(p,a,f,i)}return a}(_);return function(t,r){for(var a=new e.Group,n=r.rels[0],i=r.model[n.target.substring(1)].build,o=0;o<i.length;o++){var s=i[o],l=t[s.objectId],u=s.transform;u&&l.applyMatrix4(u),a.add(l)}return a}(E,_)},addExtension:function(e){this.availableExtensions.push(e)}}),e.ThreeMFLoader}),e("skylark-threejs-ex/loaders/AMFLoader",["skylark-threejs"],function(e){return e.AMFLoader=function(t){e.Loader.call(this,t)},e.AMFLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.AMFLoader,load:function(t,r,a,n){var i=this,o=new e.FileLoader(i.manager);o.setPath(i.path),o.setResponseType("arraybuffer"),o.load(t,function(e){r(i.parse(e))},a,n)},parse:function(t){function r(t){for(var r="AMF Material",n=t.attributes.id.textContent,i={r:1,g:1,b:1,a:1},o=null,s=0;s<t.childNodes.length;s++){var l=t.childNodes[s];"metadata"===l.nodeName&&void 0!==l.attributes.type?"name"===l.attributes.type.value&&(r=l.textContent):"color"===l.nodeName&&(i=a(l))}return o=new e.MeshPhongMaterial({flatShading:!0,color:new e.Color(i.r,i.g,i.b),name:r}),1!==i.a&&(o.transparent=!0,o.opacity=i.a),{id:n,material:o}}function a(e){for(var t={r:1,g:1,b:1,a:1},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];"r"===a.nodeName?t.r=a.textContent:"g"===a.nodeName?t.g=a.textContent:"b"===a.nodeName?t.b=a.textContent:"a"===a.nodeName&&(t.a=a.textContent)}return t}function n(e){var t={name:"",triangles:[],materialid:null},r=e.firstElementChild;for(void 0!==e.attributes.materialid&&(t.materialId=e.attributes.materialid.nodeValue);r;){if("metadata"===r.nodeName)void 0!==r.attributes.type&&"name"===r.attributes.type.value&&(t.name=r.textContent);else if("triangle"===r.nodeName){var a=r.getElementsByTagName("v1")[0].textContent,n=r.getElementsByTagName("v2")[0].textContent,i=r.getElementsByTagName("v3")[0].textContent;t.triangles.push(a,n,i)}r=r.nextElementSibling}return t}function i(e){for(var t=[],r=[],a=e.firstElementChild;a;){if("vertex"===a.nodeName)for(var n=a.firstElementChild;n;){if("coordinates"===n.nodeName){var i=n.getElementsByTagName("x")[0].textContent,o=n.getElementsByTagName("y")[0].textContent,s=n.getElementsByTagName("z")[0].textContent;t.push(i,o,s)}else if("normal"===n.nodeName){var l=n.getElementsByTagName("nx")[0].textContent,u=n.getElementsByTagName("ny")[0].textContent,c=n.getElementsByTagName("nz")[0].textContent;r.push(l,u,c)}n=n.nextElementSibling}a=a.nextElementSibling}return{vertices:t,normals:r}}function o(e){for(var t=e.attributes.id.textContent,r={name:"amfobject",meshes:[]},o=null,s=e.firstElementChild;s;){if("metadata"===s.nodeName)void 0!==s.attributes.type&&"name"===s.attributes.type.value&&(r.name=s.textContent);else if("color"===s.nodeName)o=a(s);else if("mesh"===s.nodeName){for(var l=s.firstElementChild,u={vertices:[],normals:[],volumes:[],color:o};l;){if("vertices"===l.nodeName){var c=i(l);u.normals=u.normals.concat(c.normals),u.vertices=u.vertices.concat(c.vertices)}else"volume"===l.nodeName&&u.volumes.push(n(l));l=l.nextElementSibling}r.meshes.push(u)}s=s.nextElementSibling}return{id:t,obj:r}}var s,l,u=function(t){var r=new DataView(t);if("PK"===String.fromCharCode(r.getUint8(0),r.getUint8(1))){var a=null,n=null;console.log("THREE.AMFLoader: Loading Zip");try{a=new JSZip(t)}catch(e){if(e instanceof ReferenceError)return console.log("THREE.AMFLoader: jszip missing and file is compressed."),null}for(n in a.files)if(".amf"===n.toLowerCase().substr(-4))break;console.log("THREE.AMFLoader: Trying to load file asset: "+n),r=new DataView(a.file(n).asArrayBuffer())}var i=e.LoaderUtils.decodeText(r),o=(new DOMParser).parseFromString(i,"application/xml");if("amf"!==o.documentElement.nodeName.toLowerCase())return console.log("THREE.AMFLoader: Error loading AMF - no AMF document found."),null;return o}(t),c="",f="",d=function(e){var t=1,r="millimeter";void 0!==e.documentElement.attributes.unit&&(r=e.documentElement.attributes.unit.value.toLowerCase());var a={millimeter:1,inch:25.4,feet:304.8,meter:1e3,micron:.001};void 0!==a[r]&&(t=a[r]);return console.log("THREE.AMFLoader: Unit scale: "+t),t}(u),h={},p={},m=u.documentElement.childNodes;for(s=0;s<m.length;s++){var v=m[s];if("metadata"===v.nodeName)void 0!==v.attributes.type&&("name"===v.attributes.type.value?c=v.textContent:"author"===v.attributes.type.value&&(f=v.textContent));else if("material"===v.nodeName){var g=r(v);h[g.id]=g.material}else if("object"===v.nodeName){var y=o(v);p[y.id]=y.obj}}var x=new e.Group,A=new e.MeshPhongMaterial({color:11184895,flatShading:!0});for(var b in x.name=c,x.userData.author=f,x.userData.loader="AMF",p){var T=p[b],w=T.meshes,F=new e.Group;for(F.name=T.name||"",s=0;s<w.length;s++){var _=A,E=w[s],L=new e.Float32BufferAttribute(E.vertices,3),S=null;if(E.normals.length&&(S=new e.Float32BufferAttribute(E.normals,3)),E.color){var M=E.color;(_=A.clone()).color=new e.Color(M.r,M.g,M.b),1!==M.a&&(_.transparent=!0,_.opacity=M.a)}var P=E.volumes;for(l=0;l<P.length;l++){var N=P[l],I=new e.BufferGeometry,k=_;I.setIndex(N.triangles),I.setAttribute("position",L.clone()),S&&I.setAttribute("normal",S.clone()),void 0!==h[N.materialId]&&(k=h[N.materialId]),I.scale(d,d,d),F.add(new e.Mesh(I,k.clone()))}}x.add(F)}return x}}),e.AMFLoader}),e("skylark-threejs-ex/loaders/AssimpLoader",["skylark-threejs"],function(e){return e.AssimpLoader=function(t){e.Loader.call(this,t)},e.AssimpLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.AssimpLoader,load:function(t,r,a,n){var i=this,o=""===i.path?e.LoaderUtils.extractUrlBase(t):i.path,s=new e.FileLoader(this.manager);s.setPath(i.path),s.setResponseType("arraybuffer"),s.load(t,function(e){r(i.parse(e,o))},a,n)},parse:function(t,r){var a=new e.TextureLoader(this.manager);a.setPath(this.resourcePath||r).setCrossOrigin(this.crossOrigin);var n={KeyFrame:function(t,r){this.time=t,this.matrix=r.clone(),this.position=new e.Vector3,this.quaternion=new e.Quaternion,this.scale=new e.Vector3(1,1,1),this.matrix.decompose(this.position,this.quaternion,this.scale),this.clone=function(){var e=new n.KeyFrame(this.time,this.matrix);return e},this.lerp=function(e,t){t-=this.time;var r=e.time-this.time,a=t/r,i=1-a,o=this.position,s=this.quaternion,l=e.position,u=e.quaternion;return n.KeyFrame.tempAniPos.x=o.x*i+l.x*a,n.KeyFrame.tempAniPos.y=o.y*i+l.y*a,n.KeyFrame.tempAniPos.z=o.z*i+l.z*a,n.KeyFrame.tempAniQuat.set(s.x,s.y,s.z,s.w),n.KeyFrame.tempAniQuat.slerp(u,a),n.KeyFrame.tempAniMatrix.compose(n.KeyFrame.tempAniPos,n.KeyFrame.tempAniQuat,n.KeyFrame.tempAniScale)}}};n.KeyFrame.tempAniPos=new e.Vector3,n.KeyFrame.tempAniQuat=new e.Quaternion,n.KeyFrame.tempAniScale=new e.Vector3(1,1,1),n.KeyFrame.tempAniMatrix=new e.Matrix4,n.KeyFrameTrack=function(){this.keys=[],this.target=null,this.time=0,this.length=0,this._accelTable={},this.fps=20,this.addKey=function(e){this.keys.push(e)},this.init=function(){if(this.sortKeys(),this.keys.length>0?this.length=this.keys[this.keys.length-1].time:this.length=0,this.fps)for(var e=0;e<this.length*this.fps;e++)for(var t=0;t<this.keys.length;t++){if(this.keys[t].time==e){this._accelTable[e]=t;break}if(this.keys[t].time<e/this.fps&&this.keys[t+1]&&this.keys[t+1].time>=e/this.fps){this._accelTable[e]=t;break}}},this.parseFromThree=function(e){var t=e.fps;this.target=e.node;for(var r=e.hierarchy[0].keys,a=0;a<r.length;a++)this.addKey(new n.KeyFrame(a/t||r[a].time,r[a].targets[0].data));this.init()},this.parseFromCollada=function(e){for(var t=e.keys,r=this.fps,a=0;a<t.length;a++)this.addKey(new n.KeyFrame(a/r||t[a].time,t[a].matrix));this.init()},this.sortKeys=function(){this.keys.sort(this.keySortFunc)},this.keySortFunc=function(e,t){return e.time-t.time},this.clone=function(){var e=new n.KeyFrameTrack;e.target=this.target,e.time=this.time,e.length=this.length;for(var t=0;t<this.keys.length;t++)e.addKey(this.keys[t].clone());return e.init(),e},this.reTarget=function(e,t){t||(t=n.TrackTargetNodeNameCompare),this.target=t(e,this.target)},this.keySearchAccel=function(e){return e*=this.fps,e=Math.floor(e),this._accelTable[e]||0},this.setTime=function(e){e=Math.abs(e),this.length&&(e=e%this.length+.05);for(var t=null,r=null,a=this.keySearchAccel(e);a<this.keys.length;a++){if(this.keys[a].time==e){t=this.keys[a],r=this.keys[a];break}if(this.keys[a].time<e&&this.keys[a+1]&&this.keys[a+1].time>e){t=this.keys[a],r=this.keys[a+1];break}if(this.keys[a].time<e&&a==this.keys.length-1){t=this.keys[a],(r=this.keys[0].clone()).time+=this.length+.05;break}}return t&&r&&t!==r?(this.target.matrixAutoUpdate=!1,this.target.matrix.copy(t.lerp(r,e)),void(this.target.matrixWorldNeedsUpdate=!0)):t&&r&&t==r?(this.target.matrixAutoUpdate=!1,this.target.matrix.copy(t.matrix),void(this.target.matrixWorldNeedsUpdate=!0)):void 0}},n.TrackTargetNodeNameCompare=function(e,t){return function e(t,r){if(t.name==r)return t;for(var a=0;a<t.children.length;a++){var n=e(t.children[a],r);if(n)return n}return null}(e,t.name)},n.Animation=function(){this.tracks=[],this.length=0,this.addTrack=function(e){this.tracks.push(e),this.length=Math.max(e.length,this.length)},this.setTime=function(e){this.time=e;for(var t=0;t<this.tracks.length;t++)this.tracks[t].setTime(e)},this.clone=function(e,t){t||(t=n.TrackTargetNodeNameCompare);var r=new n.Animation;r.target=e;for(var a=0;a<this.tracks.length;a++){var i=this.tracks[a].clone();i.reTarget(e,t),r.addTrack(i)}return r}};var i=4660,o=4661,s=4662,l=4663,u=4664,c=4665,f=4666,d=4667,h=4668,p=4669,m=4670,v=1,g=2,y=4,x=256,A=65536,b=1,T=4,w=1,F=3,_=1,E=6,L=8,S=10,M=4;function P(e){return x<<e}function N(e){return A<<e}function I(t,r){var a=new e.Bone;for(var n in a.matrix.copy(t.matrix),a.matrixWorld.copy(t.matrixWorld),a.position.copy(t.position),a.quaternion.copy(t.quaternion),a.scale.copy(t.scale),r.nodeCount++,a.name="bone_"+t.name+r.nodeCount.toString(),r.nodeToBoneMap[t.name]||(r.nodeToBoneMap[t.name]=[]),r.nodeToBoneMap[t.name].push(a),t.children){var i=I(t.children[n],r);a.add(i)}return a}function k(e,t){for(var r=[],a=0;a<e.length;a++)r.push({i:e[a],w:t[a]});for(r.sort(function(e,t){return t.w-e.w});r.length<4;)r.push({i:0,w:0});r.length>4&&(r.length=4);for(var n=0,a=0;a<4;a++)n+=r[a].w*r[a].w;n=Math.sqrt(n);for(var a=0;a<4;a++)r[a].w=r[a].w/n,e[a]=r[a].i,t[a]=r[a].w}function R(e,t){if(0==e.name.indexOf("bone_"+t))return e;for(var r in e.children){var a=R(e.children[r],t);if(a)return a}}function C(){this.mPrimitiveTypes=0,this.mNumVertices=0,this.mNumFaces=0,this.mNumBones=0,this.mMaterialIndex=0,this.mVertices=[],this.mNormals=[],this.mTangents=[],this.mBitangents=[],this.mColors=[[]],this.mTextureCoords=[[]],this.mFaces=[],this.mBones=[],this.hookupSkeletons=function(t){if(0!=this.mBones.length){for(var r=[],a=[],n=t.findNode(this.mBones[0].mName);n.mParent&&n.mParent.isBone;)n=n.mParent;var i=n.toTHREE(t),o=I(i,t);this.threeNode.add(o);for(var s=0;s<this.mBones.length;s++){var l=R(o,this.mBones[s].mName);if(l){var u=l;r.push(u),a.push(this.mBones[s].mOffsetMatrix.toTHREE())}else{var n=t.findNode(this.mBones[s].mName);if(!n)return;var i=n.toTHREE(t),o=I(i,t);this.threeNode.add(o);var l=R(o,this.mBones[s].mName),u=l;r.push(u),a.push(this.mBones[s].mOffsetMatrix.toTHREE())}}var c=new e.Skeleton(r,a);this.threeNode.bind(c,new e.Matrix4),this.threeNode.material.skinning=!0}},this.toTHREE=function(t){if(this.threeNode)return this.threeNode;var r,a,n=new e.BufferGeometry;if(r=t.mMaterials[this.mMaterialIndex]?t.mMaterials[this.mMaterialIndex].toTHREE(t):new e.MeshLambertMaterial,n.setIndex(new e.BufferAttribute(new Uint32Array(this.mIndexArray),1)),n.setAttribute("position",new e.BufferAttribute(this.mVertexBuffer,3)),this.mNormalBuffer&&this.mNormalBuffer.length>0&&n.setAttribute("normal",new e.BufferAttribute(this.mNormalBuffer,3)),this.mColorBuffer&&this.mColorBuffer.length>0&&n.setAttribute("color",new e.BufferAttribute(this.mColorBuffer,4)),this.mTexCoordsBuffers[0]&&this.mTexCoordsBuffers[0].length>0&&n.setAttribute("uv",new e.BufferAttribute(new Float32Array(this.mTexCoordsBuffers[0]),2)),this.mTexCoordsBuffers[1]&&this.mTexCoordsBuffers[1].length>0&&n.setAttribute("uv1",new e.BufferAttribute(new Float32Array(this.mTexCoordsBuffers[1]),2)),this.mTangentBuffer&&this.mTangentBuffer.length>0&&n.setAttribute("tangents",new e.BufferAttribute(this.mTangentBuffer,3)),this.mBitangentBuffer&&this.mBitangentBuffer.length>0&&n.setAttribute("bitangents",new e.BufferAttribute(this.mBitangentBuffer,3)),this.mBones.length>0){for(var i=[],o=[],s=0;s<this.mBones.length;s++)for(var l=0;l<this.mBones[s].mWeights.length;l++){var u=this.mBones[s].mWeights[l];u&&(i[u.mVertexId]||(i[u.mVertexId]=[]),o[u.mVertexId]||(o[u.mVertexId]=[]),i[u.mVertexId].push(u.mWeight),o[u.mVertexId].push(parseInt(s)))}for(var s in o)k(o[s],i[s]);for(var c=[],f=[],s=0;s<i.length;s++)for(var l=0;l<4;l++)i[s]&&o[s]?(c.push(i[s][l]),f.push(o[s][l])):(c.push(0),f.push(0));n.setAttribute("skinWeight",new e.BufferAttribute(new Float32Array(c),M)),n.setAttribute("skinIndex",new e.BufferAttribute(new Float32Array(f),M))}return 0==this.mBones.length&&(a=new e.Mesh(n,r)),this.mBones.length>0&&(a=new e.SkinnedMesh(n,r)).normalizeSkinWeights(),this.threeNode=a,a}}function U(){this.mNumIndices=0,this.mIndices=[]}function O(){this.data=[],this.toString=function(){var e="";return this.data.forEach(function(t){e+=String.fromCharCode(t)}),e.replace(/[^\x20-\x7E]+/g,"")}}function D(){this.mName="",this.mTransformation=[],this.mNumChildren=0,this.mNumMeshes=0,this.mMeshes=[],this.mChildren=[],this.toTHREE=function(t){if(this.threeNode)return this.threeNode;var r=new e.Object3D;r.name=this.mName,r.matrix=this.mTransformation.toTHREE();for(var a=0;a<this.mChildren.length;a++)r.add(this.mChildren[a].toTHREE(t));for(var a=0;a<this.mMeshes.length;a++)r.add(t.mMeshes[this.mMeshes[a]].toTHREE(t));return this.threeNode=r,r.matrix.decompose(r.position,r.quaternion,r.scale),r}}function B(){this.mName="",this.mNumWeights=0,this.mOffsetMatrix=0}function j(){this.mKey="",this.mSemantic=0,this.mIndex=0,this.mData=[],this.mDataLength=0,this.mType=0,this.dataAsColor=function(){var t=new Uint8Array(this.mData).buffer,r=new DataView(t),a=r.getFloat32(0,!0),n=r.getFloat32(4,!0),i=r.getFloat32(8,!0);return new e.Color(a,n,i)},this.dataAsFloat=function(){var e=new Uint8Array(this.mData).buffer,t=new DataView(e),r=t.getFloat32(0,!0);return r},this.dataAsBool=function(){var e=new Uint8Array(this.mData).buffer,t=new DataView(e),r=t.getFloat32(0,!0);return!!r},this.dataAsString=function(){var e=new O;return e.data=this.mData,e.toString()},this.dataAsMap=function(){var e=new O;e.data=this.mData;var t=e.toString();return-1!=(t=t.replace(/\\/g,"/")).indexOf("/")&&(t=t.substr(t.lastIndexOf("/")+1)),a.load(t)}}var G={"?mat.name":"name","$mat.shadingm":"shading","$mat.twosided":"twoSided","$mat.wireframe":"wireframe","$clr.ambient":"ambient","$clr.diffuse":"color","$clr.specular":"specular","$clr.emissive":"emissive","$clr.transparent":"transparent","$clr.reflective":"reflect","$mat.shininess":"shininess","$mat.reflectivity":"reflectivity","$mat.refracti":"refraction","$tex.file":"map"},V={"?mat.name":"string","$mat.shadingm":"bool","$mat.twosided":"bool","$mat.wireframe":"bool","$clr.ambient":"color","$clr.diffuse":"color","$clr.specular":"color","$clr.emissive":"color","$clr.transparent":"color","$clr.reflective":"color","$mat.shininess":"float","$mat.reflectivity":"float","$mat.refracti":"float","$tex.file":"map"};function X(){this.mNumAllocated=0,this.mNumProperties=0,this.mProperties=[],this.toTHREE=function(){for(var t=new e.MeshPhongMaterial,r=0;r<this.mProperties.length;r++)if("float"==V[this.mProperties[r].mKey]&&(t[G[this.mProperties[r].mKey]]=this.mProperties[r].dataAsFloat()),"color"==V[this.mProperties[r].mKey]&&(t[G[this.mProperties[r].mKey]]=this.mProperties[r].dataAsColor()),"bool"==V[this.mProperties[r].mKey]&&(t[G[this.mProperties[r].mKey]]=this.mProperties[r].dataAsBool()),"string"==V[this.mProperties[r].mKey]&&(t[G[this.mProperties[r].mKey]]=this.mProperties[r].dataAsString()),"map"==V[this.mProperties[r].mKey]){var a=this.mProperties[r];a.mSemantic==_&&(t.map=this.mProperties[r].dataAsMap()),a.mSemantic==E&&(t.normalMap=this.mProperties[r].dataAsMap()),a.mSemantic==S&&(t.lightMap=this.mProperties[r].dataAsMap()),a.mSemantic==L&&(t.alphaMap=this.mProperties[r].dataAsMap())}return t.ambient.r=.53,t.ambient.g=.53,t.ambient.b=.53,t.color.r=1,t.color.g=1,t.color.b=1,t}}function H(t,r,a){var n=new e.Vector3,i=1-a;return n.x=t.x*a+r.x*i,n.y=t.y*a+r.y*i,n.z=t.z*a+r.z*i,n}function z(e,t,r){return e.clone().slerp(t,1-r)}function Y(e,t,r,a){if(1==e.length)return e[0].mValue.toTHREE();for(var n=1/0,i=null,o=null,s=0;s<e.length;s++){var l=Math.abs(e[s].mTime-t);l<n&&e[s].mTime<=t&&(n=l,i=e[s],o=e[s+1])}if(i){if(o){var u=o.mTime-i.mTime,c=i.mTime-t,f=c/u;return a(i.mValue.toTHREE(),o.mValue.toTHREE(),f)}(o=e[0].clone()).mTime+=r;var u=o.mTime-i.mTime,c=i.mTime-t,f=c/u;return a(i.mValue.toTHREE(),o.mValue.toTHREE(),f)}return null}function Q(){this.mNodeName="",this.mNumPositionKeys=0,this.mNumRotationKeys=0,this.mNumScalingKeys=0,this.mPositionKeys=[],this.mRotationKeys=[],this.mScalingKeys=[],this.mPreState="",this.mPostState="",this.init=function(e){function t(t){t.mTime/=e}e||(e=1),this.mPositionKeys.forEach(t),this.mRotationKeys.forEach(t),this.mScalingKeys.forEach(t)},this.sortKeys=function(){function e(e,t){return e.mTime-t.mTime}this.mPositionKeys.sort(e),this.mRotationKeys.sort(e),this.mScalingKeys.sort(e)},this.getLength=function(){return Math.max(Math.max.apply(null,this.mPositionKeys.map(function(e){return e.mTime})),Math.max.apply(null,this.mRotationKeys.map(function(e){return e.mTime})),Math.max.apply(null,this.mScalingKeys.map(function(e){return e.mTime})))},this.toTHREE=function(t){this.sortKeys();for(var r=this.getLength(),a=new n.KeyFrameTrack,i=0;i<r;i+=.05){var o=new e.Matrix4,s=i,l=Y(this.mPositionKeys,s,r,H),u=Y(this.mScalingKeys,s,r,H),c=Y(this.mRotationKeys,s,r,z);o.compose(l,c,u);var f=new n.KeyFrame(s,o);a.addKey(f)}a.target=t.findNode(this.mNodeName).toTHREE();var d=[a];if(t.nodeToBoneMap[this.mNodeName])for(var i=0;i<t.nodeToBoneMap[this.mNodeName].length;i++){var h=a.clone();h.target=t.nodeToBoneMap[this.mNodeName][i],d.push(h)}return d}}function W(){this.mName="",this.mDuration=0,this.mTicksPerSecond=0,this.mNumChannels=0,this.mChannels=[],this.toTHREE=function(e){var t=new n.Animation;for(var r in this.mChannels){this.mChannels[r].init(this.mTicksPerSecond);var a=this.mChannels[r].toTHREE(e);for(var i in a)a[i].init(),t.addTrack(a[i])}return t.length=Math.max.apply(null,t.tracks.map(function(e){return e.length})),t}}function K(){this.mWidth=0,this.mHeight=0,this.texAchFormatHint=[],this.pcData=[]}function q(){this.mName="",this.mType=0,this.mAttenuationConstant=0,this.mAttenuationLinear=0,this.mAttenuationQuadratic=0,this.mAngleInnerCone=0,this.mAngleOuterCone=0,this.mColorDiffuse=null,this.mColorSpecular=null,this.mColorAmbient=null}function $(){this.mName="",this.mPosition=null,this.mLookAt=null,this.mUp=null,this.mHorizontalFOV=0,this.mClipPlaneNear=0,this.mClipPlaneFar=0,this.mAspect=0}var Z=!0;function J(e){var t=e.getFloat32(e.readOffset,Z);return e.readOffset+=4,t}function ee(e){var t=e.getFloat64(e.readOffset,Z);return e.readOffset+=8,t}function te(e){var t=e.getUint8(e.readOffset);return e.readOffset+=1,t}function re(e){var t=e.getUint16(e.readOffset,Z);return e.readOffset+=2,t}function ae(e){var t=e.getUint32(e.readOffset,Z);return e.readOffset+=4,t}function ne(e){var t=e.getUint32(e.readOffset,Z);return e.readOffset+=4,t}function ie(t){var r=new function(){this.x=0,this.y=0,this.z=0,this.toTHREE=function(){return new e.Vector3(this.x,this.y,this.z)}};return r.x=J(t),r.y=J(t),r.z=J(t),r}function oe(t){var r=new function(){this.r=0,this.g=0,this.b=0,this.a=0,this.toTHREE=function(){return new e.Color(this.r,this.g,this.b)}};return r.r=J(t),r.g=J(t),r.b=J(t),r}function se(t){var r=new function(){this.x=0,this.y=0,this.z=0,this.w=0,this.toTHREE=function(){return new e.Quaternion(this.x,this.y,this.z,this.w)}};return r.w=J(t),r.x=J(t),r.y=J(t),r.z=J(t),r}function le(e){var t=new O,r=ae(e);return e.ReadBytes(t.data,1,r),t.toString()}function ue(e){var t=new function(){this.mVertexId=0,this.mWeight=0};return t.mVertexId=ae(e),t.mWeight=J(e),t}function ce(t){for(var r=new function(){this.elements=[[],[],[],[]],this.toTHREE=function(){for(var t=new e.Matrix4,r=0;r<4;++r)for(var a=0;a<4;++a)t.elements[4*r+a]=this.elements[a][r];return t}},a=0;a<4;++a)for(var n=0;n<4;++n)r.elements[a][n]=J(t);return r}function fe(e){var t=new function(){this.mTime=0,this.mValue=null};return t.mTime=ee(e),t.mValue=ie(e),t}function de(e){var t=new function(){this.mTime=0,this.mValue=null};return t.mTime=ee(e),t.mValue=se(e),t}function he(e,t,r){for(var a=0;a<r;a++)t[a]=fe(e)}function pe(e,t,r){return e.Seek(sizeof(t)*r,Se)}function me(e){if(!e)throw"asset failed"}function ve(e,t){var r=ne(e);return me(r==f),ne(e),t.mName=le(e),t.mNumWeights=ae(e),t.mOffsetMatrix=ce(e),Ee?pe(e,t.mWeights,t.mNumWeights):(t.mWeights=[],function(e,t,r){for(var a=0;a<r;a++)t[a]=ue(e)}(e,t.mWeights,t.mNumWeights)),t}function ge(e,t){var r=ne(e);me(r==l),ne(e),t.mPrimitiveTypes=ae(e),t.mNumVertices=ae(e),t.mNumFaces=ae(e),t.mNumBones=ae(e),t.mMaterialIndex=ae(e),t.mNumUVComponents=[];var a=ae(e);a&v&&(Ee?pe(e,t.mVertices,t.mNumVertices):(t.mVertices=[],t.mVertexBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,Se))),a&g&&(Ee?pe(e,t.mNormals,t.mNumVertices):(t.mNormals=[],t.mNormalBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,Se))),a&y&&(Ee?(pe(e,t.mTangents,t.mNumVertices),pe(e,t.mBitangents,t.mNumVertices)):(t.mTangents=[],t.mTangentBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,Se),t.mBitangents=[],t.mBitangentBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,Se)));for(var n=0;n<b&&a&N(n);++n)Ee?pe(e,t.mColors[n],t.mNumVertices):(t.mColors[n]=[],t.mColorBuffer=e.subArray32(e.readOffset,e.readOffset+4*t.mNumVertices*4),e.Seek(4*t.mNumVertices*4,Se));t.mTexCoordsBuffers=[];for(var n=0;n<T&&a&P(n);++n)if(t.mNumUVComponents[n]=ae(e),Ee)pe(e,t.mTextureCoords[n],t.mNumVertices);else{t.mTextureCoords[n]=[],t.mTexCoordsBuffers[n]=[];for(var i=0;i<t.mNumVertices;i++)t.mTexCoordsBuffers[n].push(J(e)),t.mTexCoordsBuffers[n].push(J(e)),J(e)}if(Ee)ae(e);else{t.mFaces=[],t.mIndexArray=[];for(var o=0;o<t.mNumFaces;++o){var s=t.mFaces[o]=new U;s.mNumIndices=re(e),s.mIndices=[];for(var u=0;u<s.mNumIndices;++u)t.mNumVertices<65536?s.mIndices[u]=re(e):s.mIndices[u]=ae(e);if(3===s.mNumIndices)t.mIndexArray.push(s.mIndices[0]),t.mIndexArray.push(s.mIndices[1]),t.mIndexArray.push(s.mIndices[2]);else{if(4!==s.mNumIndices)throw new Error("Sorry, can't currently triangulate polys. Use the triangulate preprocessor in Assimp.");t.mIndexArray.push(s.mIndices[0]),t.mIndexArray.push(s.mIndices[1]),t.mIndexArray.push(s.mIndices[2]),t.mIndexArray.push(s.mIndices[2]),t.mIndexArray.push(s.mIndices[3]),t.mIndexArray.push(s.mIndices[0])}}}if(t.mNumBones){t.mBones=[];for(var u=0;u<t.mNumBones;++u)t.mBones[u]=new B,ve(e,t.mBones[u])}}function ye(e,t){var r=ne(e);me(r==m),ne(e),t.mKey=le(e),t.mSemantic=ae(e),t.mIndex=ae(e),t.mDataLength=ae(e),t.mType=ae(e),t.mData=[],e.ReadBytes(t.mData,1,t.mDataLength)}function xe(e,t){var r=ne(e);if(me(r==p),ne(e),t.mNumAllocated=t.mNumProperties=ae(e),t.mNumProperties){t.mProperties&&delete t.mProperties,t.mProperties=[];for(var a=0;a<t.mNumProperties;++a)t.mProperties[a]=new j,ye(e,t.mProperties[a])}}function Ae(e,t){var r=ne(e);me(r==u),ne(e),t.mNodeName=le(e),t.mNumPositionKeys=ae(e),t.mNumRotationKeys=ae(e),t.mNumScalingKeys=ae(e),t.mPreState=ae(e),t.mPostState=ae(e),t.mNumPositionKeys&&(Ee?pe(e,t.mPositionKeys,t.mNumPositionKeys):(t.mPositionKeys=[],he(e,t.mPositionKeys,t.mNumPositionKeys))),t.mNumRotationKeys&&(Ee?pe(e,t.mRotationKeys,t.mNumRotationKeys):(t.mRotationKeys=[],function(e,t,r){for(var a=0;a<r;a++)t[a]=de(e)}(e,t.mRotationKeys,t.mNumRotationKeys))),t.mNumScalingKeys&&(Ee?pe(e,t.mScalingKeys,t.mNumScalingKeys):(t.mScalingKeys=[],he(e,t.mScalingKeys,t.mNumScalingKeys)))}function be(e,t){var r=ne(e);if(me(r==d),ne(e),t.mName=le(e),t.mDuration=ee(e),t.mTicksPerSecond=ee(e),t.mNumChannels=ae(e),t.mNumChannels){t.mChannels=[];for(var a=0;a<t.mNumChannels;++a)t.mChannels[a]=new Q,Ae(e,t.mChannels[a])}}function Te(e,t){var r=ne(e);me(r==s),ne(e),t.mWidth=ae(e),t.mHeight=ae(e),e.ReadBytes(t.achFormatHint,1,4),Ee||(t.mHeight?(t.pcData=[],e.ReadBytes(t.pcData,1,t.mWidth*t.mHeight*4)):(t.pcData=[],e.ReadBytes(t.pcData,1,t.mWidth)))}function we(e,t){var r=ne(e);me(r==o),ne(e),t.mName=le(e),t.mType=ae(e),t.mType!=w&&(t.mAttenuationConstant=J(e),t.mAttenuationLinear=J(e),t.mAttenuationQuadratic=J(e)),t.mColorDiffuse=oe(e),t.mColorSpecular=oe(e),t.mColorAmbient=oe(e),t.mType==F&&(t.mAngleInnerCone=J(e),t.mAngleOuterCone=J(e))}function Fe(e,t){var r=ne(e);me(r==i),ne(e),t.mName=le(e),t.mPosition=ie(e),t.mLookAt=ie(e),t.mUp=ie(e),t.mHorizontalFOV=J(e),t.mClipPlaneNear=J(e),t.mClipPlaneFar=J(e),t.mAspect=J(e)}function _e(e,t){var r=ne(e);if(me(r==c),ne(e),t.mFlags=ae(e),t.mNumMeshes=ae(e),t.mNumMaterials=ae(e),t.mNumAnimations=ae(e),t.mNumTextures=ae(e),t.mNumLights=ae(e),t.mNumCameras=ae(e),t.mRootNode=new D,t.mRootNode=function e(t,r,a){var n=ne(t);me(n==h);ne(t);var i=new D;i.mParent=r;i.mDepth=a;i.mName=le(t);i.mTransformation=ce(t);i.mNumChildren=ae(t);i.mNumMeshes=ae(t);if(i.mNumMeshes){i.mMeshes=[];for(var o=0;o<i.mNumMeshes;++o)i.mMeshes[o]=ae(t)}if(i.mNumChildren){i.mChildren=[];for(var o=0;o<i.mNumChildren;++o){var s=e(t,i,a++);i.mChildren[o]=s}}return i}(e,null,0),t.mNumMeshes){t.mMeshes=[];for(var a=0;a<t.mNumMeshes;++a)t.mMeshes[a]=new C,ge(e,t.mMeshes[a])}if(t.mNumMaterials){t.mMaterials=[];for(var a=0;a<t.mNumMaterials;++a)t.mMaterials[a]=new X,xe(e,t.mMaterials[a])}if(t.mNumAnimations){t.mAnimations=[];for(var a=0;a<t.mNumAnimations;++a)t.mAnimations[a]=new W,be(e,t.mAnimations[a])}if(t.mNumTextures){t.mTextures=[];for(var a=0;a<t.mNumTextures;++a)t.mTextures[a]=new K,Te(e,t.mTextures[a])}if(t.mNumLights){t.mLights=[];for(var a=0;a<t.mNumLights;++a)t.mLights[a]=new q,we(e,t.mLights[a])}if(t.mNumCameras){t.mCameras=[];for(var a=0;a<t.mNumCameras;++a)t.mCameras[a]=new $,Fe(e,t.mCameras[a])}}var Ee,Le,Se=0,Me=1;return function(e){var t=new function(){this.versionMajor=0,this.versionMinor=0,this.versionRevision=0,this.compileFlags=0,this.mFlags=0,this.mNumMeshes=0,this.mNumMaterials=0,this.mNumAnimations=0,this.mNumTextures=0,this.mNumLights=0,this.mNumCameras=0,this.mRootNode=null,this.mMeshes=[],this.mMaterials=[],this.mAnimations=[],this.mLights=[],this.mCameras=[],this.nodeToBoneMap={},this.findNode=function(e,t){if(t||(t=this.mRootNode),t.mName==e)return t;for(var r=0;r<t.mChildren.length;r++){var a=this.findNode(e,t.mChildren[r]);if(a)return a}return null},this.toTHREE=function(){this.nodeCount=0,function(e){for(var t in e.mMeshes){var r=e.mMeshes[t];for(var a in r.mBones){var n=e.findNode(r.mBones[a].mName);n&&(n.isBone=!0)}}}(this);var e=this.mRootNode.toTHREE(this);for(var t in this.mMeshes)this.mMeshes[t].hookupSkeletons(this);if(this.mAnimations.length>0)var r=this.mAnimations[0].toTHREE(this);return{object:e,animation:r}}},r=new DataView(e);if(function(e){e.readOffset=0,e.Seek=function(t,r){r==Se&&(e.readOffset+=t),r==Me&&(e.readOffset=t)},e.ReadBytes=function(e,t,r){for(var a=t*r,n=0;n<a;n++)e[n]=te(this)},e.subArray32=function(e,t){var r=this.buffer,a=r.slice(e,t);return new Float32Array(a)},e.subArrayUint16=function(e,t){var r=this.buffer,a=r.slice(e,t);return new Uint16Array(a)},e.subArrayUint8=function(e,t){var r=this.buffer,a=r.slice(e,t);return new Uint8Array(a)},e.subArrayUint32=function(e,t){var r=this.buffer,a=r.slice(e,t);return new Uint32Array(a)}}(r),r.Seek(44,Se),t.versionMajor=ae(r),t.versionMinor=ae(r),t.versionRevision=ae(r),t.compileFlags=ae(r),Ee=re(r)>0,Le=re(r)>0,Ee)throw"Shortened binaries are not supported!";if(r.Seek(256,Se),r.Seek(128,Se),r.Seek(64,Se),Le){var a=ne(r),n=r.FileSize()-r.Tell(),i=[];r.Read(i,1,n);var o=[];uncompress(o,a,i,n);var s=new ArrayBuffer(o);_e(s,t)}else _e(r,t);return t.toTHREE()}(t)}}),e.AssimpLoader}),e("skylark-threejs-ex/loaders/TGALoader",["skylark-threejs"],function(e){return e.TGALoader=function(t){e.Loader.call(this,t)},e.TGALoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.TGALoader,load:function(t,r,a,n){var i=this,o=new e.Texture,s=new e.FileLoader(this.manager);return s.setResponseType("arraybuffer"),s.setPath(this.path),s.load(t,function(e){o.image=i.parse(e),o.needsUpdate=!0,void 0!==r&&r(o)},a,n),o},parse:function(e){var t=0,r=1,a=2,n=3,i=9,o=10,s=11,l=48,u=4,c=0,f=1,d=2,h=3;e.length<19&&console.error("THREE.TGALoader: Not enough data to contain header.");var p=new Uint8Array(e),m=0,v={id_length:p[m++],colormap_type:p[m++],image_type:p[m++],colormap_index:p[m++]|p[m++]<<8,colormap_length:p[m++]|p[m++]<<8,colormap_size:p[m++],origin:[p[m++]|p[m++]<<8,p[m++]|p[m++]<<8],width:p[m++]|p[m++]<<8,height:p[m++]|p[m++]<<8,pixel_size:p[m++],flags:p[m++]};!function(e){switch(e.image_type){case r:case i:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case a:case n:case o:case s:e.colormap_type&&console.error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case t:console.error("THREE.TGALoader: No data.");default:console.error('THREE.TGALoader: Invalid type "%s".',e.image_type)}(e.width<=0||e.height<=0)&&console.error("THREE.TGALoader: Invalid image size.");8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('THREE.TGALoader: Invalid pixel size "%s".',e.pixel_size)}(v),v.id_length+m>e.length&&console.error("THREE.TGALoader: No data."),m+=v.id_length;var g=!1,y=!1,x=!1;switch(v.image_type){case i:g=!0,y=!0;break;case r:y=!0;break;case o:g=!0;break;case a:break;case s:g=!0,x=!0;break;case n:x=!0}var A="undefined"!=typeof OffscreenCanvas,b=A?new OffscreenCanvas(v.width,v.height):document.createElement("canvas");b.width=v.width,b.height=v.height;var T=b.getContext("2d"),w=T.createImageData(v.width,v.height),F=function(e,t,r,a,n){var i,o,s,l;o=r.pixel_size>>3,s=r.width*r.height*o,t&&(l=n.subarray(a,a+=r.colormap_length*(r.colormap_size>>3)));if(e){var u,c,f;i=new Uint8Array(s);for(var d=0,h=new Uint8Array(o);d<s;)if(u=n[a++],c=1+(127&u),128&u){for(f=0;f<o;++f)h[f]=n[a++];for(f=0;f<c;++f)i.set(h,d+f*o);d+=o*c}else{for(c*=o,f=0;f<c;++f)i[d+f]=n[a++];d+=c}}else i=n.subarray(a,a+=t?r.width*r.height:s);return{pixel_data:i,palettes:l}}(g,y,v,m,p);!function(e,t,r,a,n){var i,o,s,p,m,g;switch((v.flags&l)>>u){default:case d:i=0,s=1,m=t,o=0,p=1,g=r;break;case c:i=0,s=1,m=t,o=r-1,p=-1,g=-1;break;case h:i=t-1,s=-1,m=-1,o=0,p=1,g=r;break;case f:i=t-1,s=-1,m=-1,o=r-1,p=-1,g=-1}if(x)switch(v.pixel_size){case 8:!function(e,t,r,a,n,i,o,s){var l,u,c,f=0,d=v.width;for(c=t;c!==a;c+=r)for(u=n;u!==o;u+=i,f++)l=s[f],e[4*(u+d*c)+0]=l,e[4*(u+d*c)+1]=l,e[4*(u+d*c)+2]=l,e[4*(u+d*c)+3]=255}(e,o,p,g,i,s,m,a);break;case 16:!function(e,t,r,a,n,i,o,s){var l,u,c=0,f=v.width;for(u=t;u!==a;u+=r)for(l=n;l!==o;l+=i,c+=2)e[4*(l+f*u)+0]=s[c+0],e[4*(l+f*u)+1]=s[c+0],e[4*(l+f*u)+2]=s[c+0],e[4*(l+f*u)+3]=s[c+1]}(e,o,p,g,i,s,m,a);break;default:console.error("THREE.TGALoader: Format not supported.")}else switch(v.pixel_size){case 8:!function(e,t,r,a,n,i,o,s,l){var u,c,f,d=l,h=0,p=v.width;for(f=t;f!==a;f+=r)for(c=n;c!==o;c+=i,h++)u=s[h],e[4*(c+p*f)+3]=255,e[4*(c+p*f)+2]=d[3*u+0],e[4*(c+p*f)+1]=d[3*u+1],e[4*(c+p*f)+0]=d[3*u+2]}(e,o,p,g,i,s,m,a,n);break;case 16:!function(e,t,r,a,n,i,o,s){var l,u,c,f=0,d=v.width;for(c=t;c!==a;c+=r)for(u=n;u!==o;u+=i,f+=2)l=s[f+0]+(s[f+1]<<8),e[4*(u+d*c)+0]=(31744&l)>>7,e[4*(u+d*c)+1]=(992&l)>>2,e[4*(u+d*c)+2]=(31&l)>>3,e[4*(u+d*c)+3]=32768&l?0:255}(e,o,p,g,i,s,m,a);break;case 24:!function(e,t,r,a,n,i,o,s){var l,u,c=0,f=v.width;for(u=t;u!==a;u+=r)for(l=n;l!==o;l+=i,c+=3)e[4*(l+f*u)+3]=255,e[4*(l+f*u)+2]=s[c+0],e[4*(l+f*u)+1]=s[c+1],e[4*(l+f*u)+0]=s[c+2]}(e,o,p,g,i,s,m,a);break;case 32:!function(e,t,r,a,n,i,o,s){var l,u,c=0,f=v.width;for(u=t;u!==a;u+=r)for(l=n;l!==o;l+=i,c+=4)e[4*(l+f*u)+2]=s[c+0],e[4*(l+f*u)+1]=s[c+1],e[4*(l+f*u)+0]=s[c+2],e[4*(l+f*u)+3]=s[c+3]}(e,o,p,g,i,s,m,a);break;default:console.error("THREE.TGALoader: Format not supported.")}}(w.data,v.width,v.height,F.pixel_data,F.palettes);return T.putImageData(w,0,0),A?b.transferToImageBitmap():b}}),e.TGALoader}),e("skylark-threejs-ex/loaders/ColladaLoader",["skylark-threejs","./TGALoader"],function(e,t){return e.ColladaLoader=function(t){e.Loader.call(this,t)},e.ColladaLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.ColladaLoader,load:function(t,r,a,n){var i=this,o=""===i.path?e.LoaderUtils.extractUrlBase(t):i.path,s=new e.FileLoader(i.manager);s.setPath(i.path),s.load(t,function(e){r(i.parse(e,o))},a,n)},options:{set convertUpAxis(e){console.warn("THREE.ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},parse:function(t,r){function a(e,t){for(var r=[],a=e.childNodes,n=0,i=a.length;n<i;n++){var o=a[n];o.nodeName===t&&r.push(o)}return r}function n(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=t[a];return r}function i(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=parseFloat(t[a]);return r}function o(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=parseInt(t[a]);return r}function s(e){return e.substring(1)}function l(e){return 0===Object.keys(e).length}function u(e,t,r,n){var i=a(e,t)[0];if(void 0!==i)for(var o=a(i,r),s=0;s<o.length;s++)n(o[s])}function c(e,t){for(var r in e){var a=e[r];a.build=t(e[r])}}function f(e,t){return void 0!==e.build?e.build:(e.build=t(e),e.build)}function d(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=s(n.getAttribute("source")),o=n.getAttribute("semantic");t.inputs[o]=i}}return t}function h(e){var t={},r=e.getAttribute("target"),a=r.split("/"),n=a.shift(),i=a.shift(),o=-1!==i.indexOf("("),l=-1!==i.indexOf(".");if(l)a=i.split("."),i=a.shift(),t.member=a.shift();else if(o){var u=i.split("(");i=u.shift();for(var c=0;c<u.length;c++)u[c]=parseInt(u[c].replace(/\)/,""));t.indices=u}return t.id=n,t.sid=i,t.arraySyntax=o,t.memberSyntax=l,t.sampler=s(e.getAttribute("source")),t}function p(e){var t=[],r=e.channels,a=e.samplers,n=e.sources;for(var i in r)if(r.hasOwnProperty(i)){var o=r[i],s=a[o.sampler],l=s.inputs.INPUT,u=s.inputs.OUTPUT,c=n[l],f=n[u],d=v(o,c,f);A(d,t)}return t}function m(e){return f(We.animations[e],p)}function v(e,t,r){var a,n,i,o,s,l,u=We.nodes[e.id],c=ke(u.id),f=u.transforms[e.sid],d=u.matrix.clone().transpose(),h={};switch(f){case"matrix":for(i=0,o=t.array.length;i<o;i++)if(a=t.array[i],n=i*r.stride,void 0===h[a]&&(h[a]={}),!0===e.arraySyntax){var p=r.array[n],m=e.indices[0]+4*e.indices[1];h[a][m]=p}else for(s=0,l=r.stride;s<l;s++)h[a][s]=r.array[n+s];break;case"translate":case"rotate":case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',f)}var v=function(e,t){var r=[];for(var a in e)r.push({time:parseFloat(a),value:e[a]});r.sort(function(e,t){return e.time-t.time});for(var n=0;n<16;n++)b(r,n,t.elements[n]);return r}(h,d),g={name:c.uuid,keyframes:v};return g}var g=new e.Vector3,y=new e.Vector3,x=new e.Quaternion;function A(t,r){for(var a=t.keyframes,n=t.name,i=[],o=[],s=[],l=[],u=0,c=a.length;u<c;u++){var f=a[u],d=f.time,h=f.value;Te.fromArray(h).transpose(),Te.decompose(g,x,y),i.push(d),o.push(g.x,g.y,g.z),s.push(x.x,x.y,x.z,x.w),l.push(y.x,y.y,y.z)}return o.length>0&&r.push(new e.VectorKeyframeTrack(n+".position",i,o)),s.length>0&&r.push(new e.QuaternionKeyframeTrack(n+".quaternion",i,s)),l.length>0&&r.push(new e.VectorKeyframeTrack(n+".scale",i,l)),r}function b(e,t,r){var a,n,i,o=!0;for(n=0,i=e.length;n<i;n++)void 0===(a=e[n]).value[t]?a.value[t]=null:o=!1;if(!0===o)for(n=0,i=e.length;n<i;n++)(a=e[n]).value[t]=r;else!function(e,t){for(var r,a,n=0,i=e.length;n<i;n++){var o=e[n];if(null===o.value[t]){if(r=T(e,n,t),a=w(e,n,t),null===r){o.value[t]=a.value[t];continue}if(null===a){o.value[t]=r.value[t];continue}F(o,r,a,t)}}}(e,t)}function T(e,t,r){for(;t>=0;){var a=e[t];if(null!==a.value[r])return a;t--}return null}function w(e,t,r){for(;t<e.length;){var a=e[t];if(null!==a.value[r])return a;t++}return null}function F(e,t,r,a){r.time-t.time!=0?e.value[a]=(e.time-t.time)*(r.value[a]-t.value[a])/(r.time-t.time)+t.value[a]:e.value[a]=t.value[a]}function _(t){for(var r=[],a=t.name,n=t.end-t.start||-1,i=t.animations,o=0,s=i.length;o<s;o++)for(var l=m(i[o]),u=0,c=l.length;u<c;u++)r.push(l[u]);return new e.AnimationClip(a,n,r)}function E(e){return f(We.clips[e],_)}function L(e){for(var t={sources:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"bind_shape_matrix":t.bindShapeMatrix=i(n.textContent);break;case"source":var o=n.getAttribute("id");t.sources[o]=ae(n);break;case"joints":t.joints=S(n);break;case"vertex_weights":t.vertexWeights=M(n)}}return t}function S(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=n.getAttribute("semantic"),o=s(n.getAttribute("source"));t.inputs[i]=o}}return t}function M(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=n.getAttribute("semantic"),l=s(n.getAttribute("source")),u=parseInt(n.getAttribute("offset"));t.inputs[i]={id:l,offset:u};break;case"vcount":t.vcount=o(n.textContent);break;case"v":t.v=o(n.textContent)}}return t}function P(t){var r={id:t.id},a=We.geometries[r.id];return void 0!==t.skin&&(r.skin=function(t){var r,a,n,i={joints:[],indices:{array:[],stride:4},weights:{array:[],stride:4}},o=t.sources,s=t.vertexWeights,l=s.vcount,u=s.v,c=s.inputs.JOINT.offset,f=s.inputs.WEIGHT.offset,d=t.sources[t.joints.inputs.JOINT],h=t.sources[t.joints.inputs.INV_BIND_MATRIX],p=o[s.inputs.WEIGHT.id].array,m=0;for(r=0,n=l.length;r<n;r++){var v=l[r],g=[];for(a=0;a<v;a++){var y=u[m+c],x=u[m+f],A=p[x];g.push({index:y,weight:A}),m+=2}for(g.sort(F),a=0;a<4;a++){var b=g[a];void 0!==b?(i.indices.array.push(b.index),i.weights.array.push(b.weight)):(i.indices.array.push(0),i.weights.array.push(0))}}t.bindShapeMatrix?i.bindMatrix=(new e.Matrix4).fromArray(t.bindShapeMatrix).transpose():i.bindMatrix=(new e.Matrix4).identity();for(r=0,n=d.array.length;r<n;r++){var T=d.array[r],w=(new e.Matrix4).fromArray(h.array,r*h.stride).transpose();i.joints.push({name:T,boneInverse:w})}return i;function F(e,t){return t.weight-e.weight}}(t.skin),a.sources.skinIndices=r.skin.indices,a.sources.skinWeights=r.skin.weights),r}function N(e){return void 0!==e.build?e.build:e.init_from}function I(e){var t=We.images[e];return void 0!==t?f(t,N):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",e),null)}function k(e){for(var t={surfaces:{},samplers:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"newparam":R(n,t);break;case"technique":t.technique=O(n);break;case"extra":t.extra=X(n)}}return t}function R(e,t){for(var r=e.getAttribute("sid"),a=0,n=e.childNodes.length;a<n;a++){var i=e.childNodes[a];if(1===i.nodeType)switch(i.nodeName){case"surface":t.surfaces[r]=C(i);break;case"sampler2D":t.samplers[r]=U(i)}}}function C(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"init_from":t.init_from=n.textContent}}return t}function U(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"source":t.source=n.textContent}}return t}function O(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"constant":case"lambert":case"blinn":case"phong":t.type=n.nodeName,t.parameters=D(n)}}return t}function D(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":t[n.nodeName]=B(n);break;case"transparent":t[n.nodeName]={opaque:n.getAttribute("opaque"),data:B(n)}}}return t}function B(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"color":t[n.nodeName]=i(n.textContent);break;case"float":t[n.nodeName]=parseFloat(n.textContent);break;case"texture":t[n.nodeName]={id:n.getAttribute("texture"),extra:j(n)}}}return t}function j(e){for(var t={technique:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"extra":G(n,t)}}return t}function G(e,t){for(var r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"technique":V(n,t)}}}function V(e,t){for(var r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t.technique[n.nodeName]=parseFloat(n.textContent);break;case"wrapU":case"wrapV":"TRUE"===n.textContent.toUpperCase()?t.technique[n.nodeName]=1:"FALSE"===n.textContent.toUpperCase()?t.technique[n.nodeName]=0:t.technique[n.nodeName]=parseInt(n.textContent)}}}function X(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"technique":t.technique=H(n)}}return t}function H(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"double_sided":t[n.nodeName]=parseInt(n.textContent)}}return t}function z(e){return e}function Y(t){var r,a,n=(r=t.url,f(We.effects[r],z)),i=n.profile.technique,o=n.profile.extra;switch(i.type){case"phong":case"blinn":a=new e.MeshPhongMaterial;break;case"lambert":a=new e.MeshLambertMaterial;break;default:a=new e.MeshBasicMaterial}function s(t){var r=n.profile.samplers[t.id],a=null;if(void 0!==r){var i=n.profile.surfaces[r.source];a=I(i.init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),a=I(t.id);if(null!==a){var o=function(e){var t,r=e.slice(2+(e.lastIndexOf(".")-1>>>0));switch(r=r.toLowerCase()){case"tga":t=Ve;break;default:t=He}return t}(a);if(void 0!==o){var s=o.load(a),u=t.extra;if(void 0!==u&&void 0!==u.technique&&!1===l(u.technique)){var c=u.technique;s.wrapS=c.wrapU?e.RepeatWrapping:e.ClampToEdgeWrapping,s.wrapT=c.wrapV?e.RepeatWrapping:e.ClampToEdgeWrapping,s.offset.set(c.offsetU||0,c.offsetV||0),s.repeat.set(c.repeatU||1,c.repeatV||1)}else s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping;return s}return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",a),null}return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",t.id),null}a.name=t.name||"";var u=i.parameters;for(var c in u){var d=u[c];switch(c){case"diffuse":d.color&&a.color.fromArray(d.color),d.texture&&(a.map=s(d.texture));break;case"specular":d.color&&a.specular&&a.specular.fromArray(d.color),d.texture&&(a.specularMap=s(d.texture));break;case"bump":d.texture&&(a.normalMap=s(d.texture));break;case"ambient":d.texture&&(a.lightMap=s(d.texture));break;case"shininess":d.float&&a.shininess&&(a.shininess=d.float);break;case"emission":d.color&&a.emissive&&a.emissive.fromArray(d.color),d.texture&&(a.emissiveMap=s(d.texture))}}var h=u.transparent,p=u.transparency;if(void 0===p&&h&&(p={float:1}),void 0===h&&p&&(h={opaque:"A_ONE",data:{color:[1,1,1,1]}}),h&&p)if(h.data.texture)a.transparent=!0;else{var m=h.data.color;switch(h.opaque){case"A_ONE":a.opacity=m[3]*p.float;break;case"RGB_ZERO":a.opacity=1-m[0]*p.float;break;case"A_ZERO":a.opacity=1-m[3]*p.float;break;case"RGB_ONE":a.opacity=m[0]*p.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',h.opaque)}a.opacity<1&&(a.transparent=!0)}return void 0!==o&&void 0!==o.technique&&1===o.technique.double_sided&&(a.side=e.DoubleSide),a}function Q(e){return f(We.materials[e],Y)}function W(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"technique_common":return K(r)}}return{}}function K(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"perspective":case"orthographic":t.technique=a.nodeName,t.parameters=q(a)}}return t}function q(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[a.nodeName]=parseFloat(a.textContent)}}return t}function $(t){var r;switch(t.optics.technique){case"perspective":r=new e.PerspectiveCamera(t.optics.parameters.yfov,t.optics.parameters.aspect_ratio,t.optics.parameters.znear,t.optics.parameters.zfar);break;case"orthographic":var a=t.optics.parameters.ymag,n=t.optics.parameters.xmag,i=t.optics.parameters.aspect_ratio;n=void 0===n?a*i:n,a=void 0===a?n/i:a,n*=.5,a*=.5,r=new e.OrthographicCamera(-n,n,a,-a,t.optics.parameters.znear,t.optics.parameters.zfar);break;default:r=new e.PerspectiveCamera}return r.name=t.name||"",r}function Z(e){var t=We.cameras[e];return void 0!==t?f(t,$):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",e),null)}function J(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=n.nodeName,t.parameters=ee(n)}}return t}function ee(t){for(var r={},a=0,n=t.childNodes.length;a<n;a++){var o=t.childNodes[a];if(1===o.nodeType)switch(o.nodeName){case"color":var s=i(o.textContent);r.color=(new e.Color).fromArray(s);break;case"falloff_angle":r.falloffAngle=parseFloat(o.textContent);break;case"quadratic_attenuation":var l=parseFloat(o.textContent);r.distance=l?Math.sqrt(1/l):0}}return r}function te(t){var r;switch(t.technique){case"directional":r=new e.DirectionalLight;break;case"point":r=new e.PointLight;break;case"spot":r=new e.SpotLight;break;case"ambient":r=new e.AmbientLight}return t.parameters.color&&r.color.copy(t.parameters.color),t.parameters.distance&&(r.distance=t.parameters.distance),r}function re(e){var t=We.lights[e];return void 0!==t?f(t,te):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",e),null)}function ae(e){for(var t={array:[],stride:3},r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1===o.nodeType)switch(o.nodeName){case"float_array":t.array=i(o.textContent);break;case"Name_array":t.array=n(o.textContent);break;case"technique_common":var s=a(o,"accessor")[0];void 0!==s&&(t.stride=parseInt(s.getAttribute("stride")))}}return t}function ne(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];1===a.nodeType&&(t[a.getAttribute("semantic")]=s(a.getAttribute("source")))}return t}function ie(e){for(var t={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0,hasUV:!1},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=s(n.getAttribute("source")),l=n.getAttribute("semantic"),u=parseInt(n.getAttribute("offset")),c=parseInt(n.getAttribute("set")),f=c>0?l+c:l;t.inputs[f]={id:i,offset:u},t.stride=Math.max(t.stride,u+1),"TEXCOORD"===l&&(t.hasUV=!0);break;case"vcount":t.vcount=o(n.textContent);break;case"p":t.p=o(n.textContent)}}return t}function oe(e){for(var t=0,r=0,a=e.length;r<a;r++){var n=e[r];!0===n.hasUV&&t++}t>0&&t<e.length&&(e.uvsNeedsFix=!0)}function se(e){var t={},r=e.sources,a=e.vertices,n=e.primitives;if(0===n.length)return{};var i=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r];void 0===t[a.type]&&(t[a.type]=[]),t[a.type].push(a)}return t}(n);for(var o in i){var s=i[o];oe(s),t[o]=le(s,r,a)}return t}function le(t,r,a){for(var n={},i={array:[],stride:0},o={array:[],stride:0},s={array:[],stride:0},l={array:[],stride:0},u={array:[],stride:0},c={array:[],stride:4},f={array:[],stride:4},d=new e.BufferGeometry,h=[],p=0,m=0;m<t.length;m++){var v=t[m],g=v.inputs,y=0;switch(v.type){case"lines":case"linestrips":y=2*v.count;break;case"triangles":y=3*v.count;break;case"polylist":for(var x=0;x<v.count;x++){var A=v.vcount[x];switch(A){case 3:y+=3;break;case 4:y+=6;break;default:y+=3*(A-2)}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",v.type)}for(var b in d.addGroup(p,y,m),p+=y,v.material&&h.push(v.material),g){var T=g[b];switch(b){case"VERTEX":for(var w in a){var F=a[w];switch(w){case"POSITION":var _=i.array.length;if(ue(v,r[F],T.offset,i.array),i.stride=r[F].stride,r.skinWeights&&r.skinIndices&&(ue(v,r.skinIndices,T.offset,c.array),ue(v,r.skinWeights,T.offset,f.array)),!1===v.hasUV&&!0===t.uvsNeedsFix)for(var y=(i.array.length-_)/i.stride,E=0;E<y;E++)s.array.push(0,0);break;case"NORMAL":ue(v,r[F],T.offset,o.array),o.stride=r[F].stride;break;case"COLOR":ue(v,r[F],T.offset,u.array),u.stride=r[F].stride;break;case"TEXCOORD":ue(v,r[F],T.offset,s.array),s.stride=r[F].stride;break;case"TEXCOORD1":ue(v,r[F],T.offset,l.array),s.stride=r[F].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',w)}}break;case"NORMAL":ue(v,r[T.id],T.offset,o.array),o.stride=r[T.id].stride;break;case"COLOR":ue(v,r[T.id],T.offset,u.array),u.stride=r[T.id].stride;break;case"TEXCOORD":ue(v,r[T.id],T.offset,s.array),s.stride=r[T.id].stride;break;case"TEXCOORD1":ue(v,r[T.id],T.offset,l.array),l.stride=r[T.id].stride}}}return i.array.length>0&&d.setAttribute("position",new e.Float32BufferAttribute(i.array,i.stride)),o.array.length>0&&d.setAttribute("normal",new e.Float32BufferAttribute(o.array,o.stride)),u.array.length>0&&d.setAttribute("color",new e.Float32BufferAttribute(u.array,u.stride)),s.array.length>0&&d.setAttribute("uv",new e.Float32BufferAttribute(s.array,s.stride)),l.array.length>0&&d.setAttribute("uv2",new e.Float32BufferAttribute(l.array,l.stride)),c.array.length>0&&d.setAttribute("skinIndex",new e.Float32BufferAttribute(c.array,c.stride)),f.array.length>0&&d.setAttribute("skinWeight",new e.Float32BufferAttribute(f.array,f.stride)),n.data=d,n.type=t[0].type,n.materialKeys=h,n}function ue(e,t,r,a){var n=e.p,i=e.stride,o=e.vcount;function s(e){for(var t=n[e+r]*u,i=t+u;t<i;t++)a.push(l[t])}var l=t.array,u=t.stride;if(void 0!==e.vcount)for(var c=0,f=0,d=o.length;f<d;f++){var h=o[f];if(4===h){var p=c+0*i,m=c+1*i,v=c+2*i,g=c+3*i;s(p),s(m),s(g),s(m),s(v),s(g)}else if(3===h){var p=c+0*i,m=c+1*i,v=c+2*i;s(p),s(m),s(v)}else if(h>4)for(var y=1,x=h-2;y<=x;y++){var p=c+0*i,m=c+i*y,v=c+i*(y+1);s(p),s(m),s(v)}c+=i*h}else for(var f=0,d=n.length;f<d;f+=i)s(f)}function ce(e){return f(We.geometries[e],se)}function fe(e){return void 0!==e.build?e.build:e}function de(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"joint":t.joints[a.getAttribute("sid")]=he(a);break;case"link":t.links.push(me(a))}}}function he(e){for(var t,r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"prismatic":case"revolute":t=pe(a)}}return t}function pe(t,r){for(var r={sid:t.getAttribute("sid"),name:t.getAttribute("name")||"",axis:new e.Vector3,limits:{min:0,max:0},type:t.nodeName,static:!1,zeroPosition:0,middlePosition:0},a=0;a<t.childNodes.length;a++){var n=t.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"axis":var o=i(n.textContent);r.axis.fromArray(o);break;case"limits":var s=n.getElementsByTagName("max")[0],l=n.getElementsByTagName("min")[0];r.limits.max=parseFloat(s.textContent),r.limits.min=parseFloat(l.textContent)}}return r.limits.min>=r.limits.max&&(r.static=!0),r.middlePosition=(r.limits.min+r.limits.max)/2,r}function me(e){for(var t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"attachment_full":t.attachments.push(ve(a));break;case"matrix":case"translate":case"rotate":t.transforms.push(ge(a))}}return t}function ve(e){for(var t={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"link":t.links.push(me(a));break;case"matrix":case"translate":case"rotate":t.transforms.push(ge(a))}}return t}function ge(t){var r={type:t.nodeName},a=i(t.textContent);switch(r.type){case"matrix":r.obj=new e.Matrix4,r.obj.fromArray(a).transpose();break;case"translate":r.obj=new e.Vector3,r.obj.fromArray(a);break;case"rotate":r.obj=new e.Vector3,r.obj.fromArray(a),r.angle=e.MathUtils.degToRad(a[3])}return r}function ye(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"technique_common":xe(a,t)}}}function xe(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"inertia":t.inertia=i(a.textContent);break;case"mass":t.mass=i(a.textContent)[0]}}}function Ae(e){for(var t={target:e.getAttribute("target").split("/").pop()},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"axis":var n=a.getElementsByTagName("param")[0];t.axis=n.textContent;var i=t.axis.split("inst_").pop().split("axis")[0];t.jointIndex=i.substr(0,i.length-1)}}return t}function be(e){return void 0!==e.build?e.build:e}var Te=new e.Matrix4,we=new e.Vector3;function Fe(t){for(var r={name:t.getAttribute("name")||"",type:t.getAttribute("type"),id:t.getAttribute("id"),sid:t.getAttribute("sid"),matrix:new e.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},a=0;a<t.childNodes.length;a++){var n=t.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"node":r.nodes.push(n.getAttribute("id")),Fe(n);break;case"instance_camera":r.instanceCameras.push(s(n.getAttribute("url")));break;case"instance_controller":r.instanceControllers.push(_e(n));break;case"instance_light":r.instanceLights.push(s(n.getAttribute("url")));break;case"instance_geometry":r.instanceGeometries.push(_e(n));break;case"instance_node":r.instanceNodes.push(s(n.getAttribute("url")));break;case"matrix":var o=i(n.textContent);r.matrix.multiply(Te.fromArray(o).transpose()),r.transforms[n.getAttribute("sid")]=n.nodeName;break;case"translate":var o=i(n.textContent);we.fromArray(o),r.matrix.multiply(Te.makeTranslation(we.x,we.y,we.z)),r.transforms[n.getAttribute("sid")]=n.nodeName;break;case"rotate":var o=i(n.textContent),l=e.MathUtils.degToRad(o[3]);r.matrix.multiply(Te.makeRotationAxis(we.fromArray(o),l)),r.transforms[n.getAttribute("sid")]=n.nodeName;break;case"scale":var o=i(n.textContent);r.matrix.scale(we.fromArray(o)),r.transforms[n.getAttribute("sid")]=n.nodeName;break;case"extra":break;default:console.log(n)}}return Ie(r.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",r.id):We.nodes[r.id]=r,r}function _e(e){for(var t={id:s(e.getAttribute("url")),materials:{},skeletons:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"bind_material":for(var n=a.getElementsByTagName("instance_material"),i=0;i<n.length;i++){var o=n[i],l=o.getAttribute("symbol"),u=o.getAttribute("target");t.materials[l]=s(u)}break;case"skeleton":t.skeletons.push(s(a.textContent))}}return t}function Ee(t,r){var a,n,i,o=[],s=[];for(a=0;a<t.length;a++){var l=t[a];if(Ie(l))Le(h=ke(l),r,o);else if(i=l,void 0!==We.visualScenes[i])for(var u=We.visualScenes[l],c=u.children,f=0;f<c.length;f++){var d=c[f];if("JOINT"===d.type){var h=ke(d.id);Le(h,r,o)}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",l)}for(a=0;a<r.length;a++)for(f=0;f<o.length;f++)if((n=o[f]).bone.name===r[a].name){s[a]=n,n.processed=!0;break}for(a=0;a<o.length;a++)!1===(n=o[a]).processed&&(s.push(n),n.processed=!0);var p=[],m=[];for(a=0;a<s.length;a++)n=s[a],p.push(n.bone),m.push(n.boneInverse);return new e.Skeleton(p,m)}function Le(t,r,a){t.traverse(function(t){if(!0===t.isBone){for(var n,i=0;i<r.length;i++){var o=r[i];if(o.name===t.name){n=o.boneInverse;break}}void 0===n&&(n=new e.Matrix4),a.push({bone:t,boneInverse:n,processed:!1})}})}function Se(t){for(var r,a=[],n=t.matrix,i=t.nodes,o=t.type,s=t.instanceCameras,l=t.instanceControllers,u=t.instanceLights,c=t.instanceGeometries,d=t.instanceNodes,h=0,p=i.length;h<p;h++)a.push(ke(i[h]));for(var h=0,p=s.length;h<p;h++){var m=Z(s[h]);null!==m&&a.push(m.clone())}for(var h=0,p=l.length;h<p;h++)for(var v=l[h],g=(r=v.id,f(We.controllers[r],P)),y=ce(g.id),x=Ne(y,v.materials),A=v.skeletons,b=g.skin.joints,T=Ee(A,b),w=0,F=x.length;w<F;w++){var _=x[w];_.isSkinnedMesh&&(_.bind(T,g.skin.bindMatrix),_.normalizeSkinWeights()),a.push(_)}for(var h=0,p=u.length;h<p;h++){var E=re(u[h]);null!==E&&a.push(E.clone())}for(var h=0,p=c.length;h<p;h++)for(var v=c[h],y=ce(v.id),x=Ne(y,v.materials),w=0,F=x.length;w<F;w++)a.push(x[w]);for(var h=0,p=d.length;h<p;h++)a.push(ke(d[h]).clone());if(0===i.length&&1===a.length)_=a[0];else{_="JOINT"===o?new e.Bone:new e.Group;for(var h=0;h<a.length;h++)_.add(a[h])}return""===_.name&&(_.name="JOINT"===o?t.sid:t.name),_.matrix.copy(n),_.matrix.decompose(_.position,_.quaternion,_.scale),_}var Me=new e.MeshBasicMaterial({color:16711935});function Pe(e,t){for(var r=[],a=0,n=e.length;a<n;a++){var i=t[e[a]];void 0===i?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",e[a]),r.push(Me)):r.push(Q(i))}return r}function Ne(t,r){var a=[];for(var n in t){var i=t[n],o=Pe(i.materialKeys,r);0===o.length&&("lines"===n||"linestrips"===n?o.push(new e.LineBasicMaterial):o.push(new e.MeshPhongMaterial));var s=void 0!==i.data.attributes.skinIndex;if(s)for(var l=0,u=o.length;l<u;l++)o[l].skinning=!0;var c,f=1===o.length?o[0]:o;switch(n){case"lines":c=new e.LineSegments(i.data,f);break;case"linestrips":c=new e.Line(i.data,f);break;case"triangles":case"polylist":c=s?new e.SkinnedMesh(i.data,f):new e.Mesh(i.data,f)}a.push(c)}return a}function Ie(e){return void 0!==We.nodes[e]}function ke(e){return f(We.nodes[e],Se)}function Re(t){var r=new e.Group;r.name=t.name;for(var a=t.children,n=0;n<a.length;n++){var i=a[n];r.add(ke(i.id))}return r}function Ce(e){return f(We.visualScenes[e],Re)}if(0===t.length)return{scene:new e.Scene};var Ue=(new DOMParser).parseFromString(t,"application/xml"),Oe=a(Ue,"COLLADA")[0],De=Ue.getElementsByTagName("parsererror")[0];if(void 0!==De){var Be,je=a(De,"div")[0];return Be=je?je.textContent:function(e){var t="",r=[e];for(;r.length;){var a=r.shift();a.nodeType===Node.TEXT_NODE?t+=a.textContent:(t+="\n",r.push.apply(r,a.childNodes))}return t.trim()}(De),console.error("THREE.ColladaLoader: Failed to parse collada file.\n",Be),null}var Ge=Oe.getAttribute("version");console.log("THREE.ColladaLoader: File version",Ge);var Ve,Xe=function(e){return{unit:function(e){return void 0!==e&&!0===e.hasAttribute("meter")?parseFloat(e.getAttribute("meter")):1}(a(e,"unit")[0]),upAxis:function(e){return void 0!==e?e.textContent:"Y_UP"}(a(e,"up_axis")[0])}}(a(Oe,"asset")[0]),He=new e.TextureLoader(this.manager);He.setPath(this.resourcePath||r).setCrossOrigin(this.crossOrigin),e.TGALoader&&(Ve=new e.TGALoader(this.manager)).setPath(this.resourcePath||r);var ze=[],Ye={},Qe=0,We={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};u(Oe,"library_animations","animation",function(e){for(var t={sources:{},samplers:{},channels:{}},r=0,a=e.childNodes.length;r<a;r++){var n,i=e.childNodes[r];if(1===i.nodeType)switch(i.nodeName){case"source":n=i.getAttribute("id"),t.sources[n]=ae(i);break;case"sampler":n=i.getAttribute("id"),t.samplers[n]=d(i);break;case"channel":n=i.getAttribute("target"),t.channels[n]=h(i);break;default:console.log(i)}}We.animations[e.getAttribute("id")]=t}),u(Oe,"library_animation_clips","animation_clip",function(e){for(var t={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"instance_animation":t.animations.push(s(n.getAttribute("url")))}}We.clips[e.getAttribute("id")]=t}),u(Oe,"library_controllers","controller",function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"skin":t.id=s(n.getAttribute("source")),t.skin=L(n);break;case"morph":t.id=s(n.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.")}}We.controllers[e.getAttribute("id")]=t}),u(Oe,"library_images","image",function(e){var t={init_from:a(e,"init_from")[0].textContent};We.images[e.getAttribute("id")]=t}),u(Oe,"library_effects","effect",function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"profile_COMMON":t.profile=k(n)}}We.effects[e.getAttribute("id")]=t}),u(Oe,"library_materials","material",function(e){for(var t={name:e.getAttribute("name")},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"instance_effect":t.url=s(n.getAttribute("url"))}}We.materials[e.getAttribute("id")]=t}),u(Oe,"library_cameras","camera",function(e){for(var t={name:e.getAttribute("name")},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"optics":t.optics=W(n)}}We.cameras[e.getAttribute("id")]=t}),u(Oe,"library_lights","light",function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"technique_common":t=J(n)}}We.lights[e.getAttribute("id")]=t}),u(Oe,"library_geometries","geometry",function(e){var t={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},r=a(e,"mesh")[0];if(void 0===r)return;for(var n=0;n<r.childNodes.length;n++){var i=r.childNodes[n];if(1===i.nodeType){var o=i.getAttribute("id");switch(i.nodeName){case"source":t.sources[o]=ae(i);break;case"vertices":t.vertices=ne(i);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",i.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":t.primitives.push(ie(i));break;default:console.log(i)}}}We.geometries[e.getAttribute("id")]=t}),u(Oe,"library_nodes","node",Fe),u(Oe,"library_visual_scenes","visual_scene",function(e){var t={name:e.getAttribute("name"),children:[]};!function(e){for(var t=e.getElementsByTagName("node"),r=0;r<t.length;r++){var a=t[r];!1===a.hasAttribute("id")&&a.setAttribute("id","three_default_"+Qe++)}}(e);for(var r=a(e,"node"),n=0;n<r.length;n++)t.children.push(Fe(r[n]));We.visualScenes[e.getAttribute("id")]=t}),u(Oe,"library_kinematics_models","kinematics_model",function(e){for(var t={name:e.getAttribute("name")||"",joints:{},links:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"technique_common":de(a,t)}}We.kinematicsModels[e.getAttribute("id")]=t}),u(Oe,"library_physics_models","physics_model",function(e){for(var t={name:e.getAttribute("name")||"",rigidBodies:{}},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"rigid_body":t.rigidBodies[a.getAttribute("name")]={},ye(a,t.rigidBodies[a.getAttribute("name")])}}We.physicsModels[e.getAttribute("id")]=t}),u(Oe,"scene","instance_kinematics_scene",function(e){for(var t={bindJointAxis:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"bind_joint_axis":t.bindJointAxis.push(Ae(a))}}We.kinematicsScenes[s(e.getAttribute("url"))]=t}),c(We.animations,p),c(We.clips,_),c(We.controllers,P),c(We.images,N),c(We.effects,z),c(We.materials,Y),c(We.cameras,$),c(We.lights,te),c(We.geometries,se),c(We.visualScenes,Re),function(){var t=We.clips;if(!0===l(t)){if(!1===l(We.animations)){var r=[];for(var a in We.animations)for(var n=m(a),i=0,o=n.length;i<o;i++)r.push(n[i]);ze.push(new e.AnimationClip("default",-1,r))}}else for(var a in t)ze.push(E(a))}(),function(){var t=Object.keys(We.kinematicsModels)[0],r=Object.keys(We.kinematicsScenes)[0],a=Object.keys(We.visualScenes)[0];if(void 0===t||void 0===r)return;for(var n=(v=t,f(We.kinematicsModels[v],fe)),o=function(e){return f(We.kinematicsScenes[e],be)}(r),s=Ce(a),l=o.bindJointAxis,u={},c=0,d=l.length;c<d;c++){var h=l[c],p=Oe.querySelector('[sid="'+h.target+'"]');if(p){var m=p.parentElement;g(h.jointIndex,m)}}var v;function g(t,r){var a=r.getAttribute("name"),o=n.joints[t];s.traverse(function(n){n.name===a&&(u[t]={object:n,transforms:function(t){for(var r=[],a=Oe.querySelector('[id="'+t.id+'"]'),n=0;n<a.childNodes.length;n++){var o=a.childNodes[n];if(1===o.nodeType)switch(o.nodeName){case"matrix":var s=i(o.textContent),l=(new e.Matrix4).fromArray(s).transpose();r.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:l});break;case"translate":case"scale":var s=i(o.textContent),u=(new e.Vector3).fromArray(s);r.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:u});break;case"rotate":var s=i(o.textContent),u=(new e.Vector3).fromArray(s),c=e.MathUtils.degToRad(s[3]);r.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:u,angle:c})}}return r}(r),joint:o,position:o.zeroPosition})})}var y=new e.Matrix4;Ye={joints:n&&n.joints,getJointValue:function(e){var t=u[e];if(t)return t.position;console.warn("THREE.ColladaLoader: Joint "+e+" doesn't exist.")},setJointValue:function(t,r){var a=u[t];if(a){var n=a.joint;if(r>n.limits.max||r<n.limits.min)console.warn("THREE.ColladaLoader: Joint "+t+" value "+r+" outside of limits (min: "+n.limits.min+", max: "+n.limits.max+").");else if(n.static)console.warn("THREE.ColladaLoader: Joint "+t+" is static.");else{var i=a.object,o=n.axis,s=a.transforms;Te.identity();for(var l=0;l<s.length;l++){var c=s[l];if(c.sid&&-1!==c.sid.indexOf(t))switch(n.type){case"revolute":Te.multiply(y.makeRotationAxis(o,e.MathUtils.degToRad(r)));break;case"prismatic":Te.multiply(y.makeTranslation(o.x*r,o.y*r,o.z*r));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+n.type)}else switch(c.type){case"matrix":Te.multiply(c.obj);break;case"translate":Te.multiply(y.makeTranslation(c.obj.x,c.obj.y,c.obj.z));break;case"scale":Te.scale(c.obj);break;case"rotate":Te.multiply(y.makeRotationAxis(c.obj,c.angle))}}i.matrix.copy(Te),i.matrix.decompose(i.position,i.quaternion,i.scale),u[t].position=r}}else console.log("THREE.ColladaLoader: "+t+" does not exist.")}}}();var Ke=function(e){return Ce(s(a(e,"instance_visual_scene")[0].getAttribute("url")))}(a(Oe,"scene")[0]);return"Z_UP"===Xe.upAxis&&Ke.quaternion.setFromEuler(new e.Euler(-Math.PI/2,0,0)),Ke.scale.multiplyScalar(Xe.unit),{animations:ze,kinematics:Ye,library:We,scene:Ke}}}),e.ColladaLoader}),e("skylark-threejs-ex/loaders/DRACOLoader",["skylark-threejs"],function(e){return e.DRACOLoader=function(t){e.Loader.call(this,t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}},e.DRACOLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.DRACOLoader,setDecoderPath:function(e){return this.decoderPath=e,this},setDecoderConfig:function(e){return this.decoderConfig=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(t,r,a,n){var i=new e.FileLoader(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),"use-credentials"===this.crossOrigin&&i.setWithCredentials(!0),i.load(t,e=>{var t={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,t).then(r).catch(n)},a,n)},decodeDracoFile:function(e,t,r,a){var n={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:a||this.defaultAttributeTypes,useUniqueIDs:!!r};this.decodeGeometry(e,n).then(t)},decodeGeometry:function(t,r){for(var a in r.attributeTypes){var n=r.attributeTypes[a];void 0!==n.BYTES_PER_ELEMENT&&(r.attributeTypes[a]=n.name)}var i,o=JSON.stringify(r);if(e.DRACOLoader.taskCache.has(t)){var s=e.DRACOLoader.taskCache.get(t);if(s.key===o)return s.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var l=this.workerNextTaskID++,u=t.byteLength,c=this._getWorker(l,u).then(e=>(i=e,new Promise((e,a)=>{i._callbacks[l]={resolve:e,reject:a},i.postMessage({type:"decode",id:l,taskConfig:r,buffer:t},[t])}))).then(e=>this._createGeometry(e.geometry));return c.finally(()=>{i&&l&&this._releaseTask(i,l)}),e.DRACOLoader.taskCache.set(t,{key:o,promise:c}),c},_createGeometry:function(t){var r=new e.BufferGeometry;t.index&&r.setIndex(new e.BufferAttribute(t.index.array,1));for(var a=0;a<t.attributes.length;a++){var n=t.attributes[a],i=n.name,o=n.array,s=n.itemSize;r.setAttribute(i,new e.BufferAttribute(o,s))}return r},_loadLibrary:function(t,r){var a=new e.FileLoader(this.manager);return a.setPath(this.decoderPath),a.setResponseType(r),new Promise((e,r)=>{a.load(t,e,void 0,r)})},preload:function(){return this._initDecoder(),this},_initDecoder:function(){if(this.decoderPending)return this.decoderPending;var t="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,r=[];return t?r.push(this._loadLibrary("draco_decoder.js","text")):(r.push(this._loadLibrary("draco_wasm_wrapper.js","text")),r.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(r).then(r=>{var a=r[0];t||(this.decoderConfig.wasmBinary=r[1]);var n=e.DRACOLoader.DRACOWorker.toString(),i=["/* draco decoder */",a,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i]))}),this.decoderPending},_getWorker:function(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){var r=new Worker(this.workerSourceURL);r._callbacks={},r._taskCosts={},r._taskLoad=0,r.postMessage({type:"init",decoderConfig:this.decoderConfig}),r.onmessage=function(e){var t=e.data;switch(t.type){case"decode":r._callbacks[t.id].resolve(t);break;case"error":r._callbacks[t.id].reject(t);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+t.type+'"')}},this.workerPool.push(r)}else this.workerPool.sort(function(e,t){return e._taskLoad>t._taskLoad?-1:1});var r=this.workerPool[this.workerPool.length-1];return r._taskCosts[e]=t,r._taskLoad+=t,r})},_releaseTask:function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]},debug:function(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))},dispose:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),e.DRACOLoader.DRACOWorker=function(){var e,t;function r(e,t,r,a,n,i){var o,s,l=i.num_components(),u=r.num_points(),c=u*l;switch(n){case Float32Array:o=new e.DracoFloat32Array,t.GetAttributeFloatForAllPoints(r,i,o),s=new Float32Array(c);break;case Int8Array:o=new e.DracoInt8Array,t.GetAttributeInt8ForAllPoints(r,i,o),s=new Int8Array(c);break;case Int16Array:o=new e.DracoInt16Array,t.GetAttributeInt16ForAllPoints(r,i,o),s=new Int16Array(c);break;case Int32Array:o=new e.DracoInt32Array,t.GetAttributeInt32ForAllPoints(r,i,o),s=new Int32Array(c);break;case Uint8Array:o=new e.DracoUInt8Array,t.GetAttributeUInt8ForAllPoints(r,i,o),s=new Uint8Array(c);break;case Uint16Array:o=new e.DracoUInt16Array,t.GetAttributeUInt16ForAllPoints(r,i,o),s=new Uint16Array(c);break;case Uint32Array:o=new e.DracoUInt32Array,t.GetAttributeUInt32ForAllPoints(r,i,o),s=new Uint32Array(c);break;default:throw new Error("THREE.DRACOLoader: Unexpected attribute type.")}for(var f=0;f<c;f++)s[f]=o.GetValue(f);return e.destroy(o),{name:a,array:s,itemSize:l}}onmessage=function(a){var n=a.data;switch(n.type){case"init":e=n.decoderConfig,t=new Promise(function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)});break;case"decode":var i=n.buffer,o=n.taskConfig;t.then(module=>{var e=module.draco,t=new e.Decoder,a=new e.DecoderBuffer;a.Init(new Int8Array(i),i.byteLength);try{var s=function(e,t,a,n){var i,o,s=n.attributeIDs,l=n.attributeTypes,u=t.GetEncodedGeometryType(a);if(u===e.TRIANGULAR_MESH)i=new e.Mesh,o=t.DecodeBufferToMesh(a,i);else{if(u!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");i=new e.PointCloud,o=t.DecodeBufferToPointCloud(a,i)}if(!o.ok()||0===i.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+o.error_msg());var c={index:null,attributes:[]};for(var f in s){var d,h,p=self[l[f]];if(n.useUniqueIDs)h=s[f],d=t.GetAttributeByUniqueId(i,h);else{if(-1===(h=t.GetAttributeId(i,e[s[f]])))continue;d=t.GetAttribute(i,h)}c.attributes.push(r(e,t,i,f,p,d))}if(u===e.TRIANGULAR_MESH){for(var m=i.num_faces(),v=3*m,g=new Uint32Array(v),y=new e.DracoInt32Array,x=0;x<m;++x){t.GetFaceFromMesh(i,x,y);for(var A=0;A<3;++A)g[3*x+A]=y.GetValue(A)}c.index={array:g,itemSize:1},e.destroy(y)}return e.destroy(i),c}(e,t,a,o),l=s.attributes.map(e=>e.array.buffer);s.index&&l.push(s.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:s},l)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}finally{e.destroy(a),e.destroy(t)}})}}},e.DRACOLoader.taskCache=new WeakMap,e.DRACOLoader.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},e.DRACOLoader.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},e.DRACOLoader.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},e.DRACOLoader.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")},e.DRACOLoader}),e("skylark-threejs-ex/loaders/FBXLoader",["skylark-threejs","../curves/NURBSCurve"],function(e,t,r){return e.FBXLoader=function(){var t,a,n;function i(t){e.Loader.call(this,t)}function o(e,t){this.textureLoader=e,this.manager=t}function s(){}function l(){}function u(){}function c(){}function f(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function d(){}function h(e){var t=e.match(/FBXVersion: (\d+)/);if(t){var r=parseInt(t[1]);return r}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function p(e){return e/46186158e3}i.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:i,load:function(t,r,a,n){var i=this,o=""===i.path?e.LoaderUtils.extractUrlBase(t):i.path,s=new e.FileLoader(this.manager);s.setPath(i.path),s.setResponseType("arraybuffer"),s.load(t,function(e){try{r(i.parse(e,o))}catch(e){setTimeout(function(){n&&n(e),i.manager.itemError(t)},0)}},a,n)},parse:function(r,a){if(s="Kaydara FBX Binary  \0",(i=r).byteLength>=s.length&&s===T(i,0,s.length))t=(new c).parse(r);else{var n=T(r);if(!function(e){var t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],r=0;function a(t){var a=e[t-1];return e=e.slice(r+t),r++,a}for(var n=0;n<t.length;++n){var i=a(1);if(i===t[n])return!1}return!0}(n))throw new Error("THREE.FBXLoader: Unknown format.");if(h(n)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+h(n));t=(new u).parse(n)}var i,s,l=new e.TextureLoader(this.manager).setPath(this.resourcePath||a).setCrossOrigin(this.crossOrigin);return new o(l,this.manager).parse(t)}}),o.prototype={constructor:o,parse:function(){a=this.parseConnections();var e=this.parseImages(),t=this.parseTextures(e),r=this.parseMaterials(t),i=this.parseDeformers(),o=(new s).parse(i);return this.parseScene(i,o,r),n},parseConnections:function(){var e=new Map;if("Connections"in t){var r=t.Connections.connections;r.forEach(function(t){var r=t[0],a=t[1],n=t[2];e.has(r)||e.set(r,{parents:[],children:[]});var i={ID:a,relationship:n};e.get(r).parents.push(i),e.has(a)||e.set(a,{parents:[],children:[]});var o={ID:r,relationship:n};e.get(a).children.push(o)})}return e},parseImages:function(){var e={},r={};if("Video"in t.Objects){var a=t.Objects.Video;for(var n in a){var i=a[n],o=parseInt(n);if(e[o]=i.RelativeFilename||i.Filename,"Content"in i){var s=i.Content instanceof ArrayBuffer&&i.Content.byteLength>0,l="string"==typeof i.Content&&""!==i.Content;if(s||l){var u=this.parseImage(a[n]);r[i.RelativeFilename||i.Filename]=u}}}}for(var o in e){var c=e[o];void 0!==r[c]?e[o]=r[c]:e[o]=e[o].split("\\").pop()}return e},parseImage:function(e){var t,r=e.Content,a=e.RelativeFilename||e.Filename,n=a.slice(a.lastIndexOf(".")+1).toLowerCase();switch(n){case"bmp":t="image/bmp";break;case"jpg":case"jpeg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",a),t="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+n+'" is not supported.')}if("string"==typeof r)return"data:"+t+";base64,"+r;var i=new Uint8Array(r);return window.URL.createObjectURL(new Blob([i],{type:t}))},parseTextures:function(e){var r=new Map;if("Texture"in t.Objects){var a=t.Objects.Texture;for(var n in a){var i=this.parseTexture(a[n],e);r.set(parseInt(n),i)}}return r},parseTexture:function(t,r){var a=this.loadTexture(t,r);a.ID=t.id,a.name=t.attrName;var n=t.WrapModeU,i=t.WrapModeV,o=void 0!==n?n.value:0,s=void 0!==i?i.value:0;if(a.wrapS=0===o?e.RepeatWrapping:e.ClampToEdgeWrapping,a.wrapT=0===s?e.RepeatWrapping:e.ClampToEdgeWrapping,"Scaling"in t){var l=t.Scaling.value;a.repeat.x=l[0],a.repeat.y=l[1]}return a},loadTexture:function(t,r){var n,i,o=this.textureLoader.path,s=a.get(t.id).children;void 0!==s&&s.length>0&&void 0!==r[s[0].ID]&&(0!==(n=r[s[0].ID]).indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));var l=t.FileName.slice(-3).toLowerCase();if("tga"===l){var u=this.manager.getHandler(".tga");null===u?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",t.RelativeFilename),i=new e.Texture):i=u.load(n)}else"psd"===l?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",t.RelativeFilename),i=new e.Texture):i=this.textureLoader.load(n);return this.textureLoader.setPath(o),i},parseMaterials:function(e){var r=new Map;if("Material"in t.Objects){var a=t.Objects.Material;for(var n in a){var i=this.parseMaterial(a[n],e);null!==i&&r.set(parseInt(n),i)}}return r},parseMaterial:function(t,r){var n=t.id,i=t.attrName,o=t.ShadingModel;if("object"==typeof o&&(o=o.value),!a.has(n))return null;var s,l=this.parseParameters(t,r,n);switch(o.toLowerCase()){case"phong":s=new e.MeshPhongMaterial;break;case"lambert":s=new e.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',o),s=new e.MeshPhongMaterial}return s.setValues(l),s.name=i,s},parseParameters:function(t,r,n){var i={};t.BumpFactor&&(i.bumpScale=t.BumpFactor.value),t.Diffuse?i.color=(new e.Color).fromArray(t.Diffuse.value):t.DiffuseColor&&"Color"===t.DiffuseColor.type&&(i.color=(new e.Color).fromArray(t.DiffuseColor.value)),t.DisplacementFactor&&(i.displacementScale=t.DisplacementFactor.value),t.Emissive?i.emissive=(new e.Color).fromArray(t.Emissive.value):t.EmissiveColor&&"Color"===t.EmissiveColor.type&&(i.emissive=(new e.Color).fromArray(t.EmissiveColor.value)),t.EmissiveFactor&&(i.emissiveIntensity=parseFloat(t.EmissiveFactor.value)),t.Opacity&&(i.opacity=parseFloat(t.Opacity.value)),i.opacity<1&&(i.transparent=!0),t.ReflectionFactor&&(i.reflectivity=t.ReflectionFactor.value),t.Shininess&&(i.shininess=t.Shininess.value),t.Specular?i.specular=(new e.Color).fromArray(t.Specular.value):t.SpecularColor&&"Color"===t.SpecularColor.type&&(i.specular=(new e.Color).fromArray(t.SpecularColor.value));var o=this;return a.get(n).children.forEach(function(t){var a=t.relationship;switch(a){case"Bump":i.bumpMap=o.getTexture(r,t.ID);break;case"Maya|TEX_ao_map":i.aoMap=o.getTexture(r,t.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":i.map=o.getTexture(r,t.ID),i.map.encoding=e.sRGBEncoding;break;case"DisplacementColor":i.displacementMap=o.getTexture(r,t.ID);break;case"EmissiveColor":i.emissiveMap=o.getTexture(r,t.ID),i.emissiveMap.encoding=e.sRGBEncoding;break;case"NormalMap":case"Maya|TEX_normal_map":i.normalMap=o.getTexture(r,t.ID);break;case"ReflectionColor":i.envMap=o.getTexture(r,t.ID),i.envMap.mapping=e.EquirectangularReflectionMapping,i.envMap.encoding=e.sRGBEncoding;break;case"SpecularColor":i.specularMap=o.getTexture(r,t.ID),i.specularMap.encoding=e.sRGBEncoding;break;case"TransparentColor":i.alphaMap=o.getTexture(r,t.ID),i.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",a)}}),i},getTexture:function(e,r){return"LayeredTexture"in t.Objects&&r in t.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),r=a.get(r).children[0].ID),e.get(r)},parseDeformers:function(){var e={},r={};if("Deformer"in t.Objects){var n=t.Objects.Deformer;for(var i in n){var o=n[i],s=a.get(parseInt(i));if("Skin"===o.attrType){var l=this.parseSkeleton(s,n);l.ID=i,s.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),l.geometryID=s.parents[0].ID,e[i]=l}else if("BlendShape"===o.attrType){var u={id:i};u.rawTargets=this.parseMorphTargets(s,n),u.id=i,s.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),r[i]=u}}}return{skeletons:e,morphTargets:r}},parseSkeleton:function(t,r){var a=[];return t.children.forEach(function(t){var n=r[t.ID];if("Cluster"===n.attrType){var i={ID:t.ID,indices:[],weights:[],transformLink:(new e.Matrix4).fromArray(n.TransformLink.a)};"Indexes"in n&&(i.indices=n.Indexes.a,i.weights=n.Weights.a),a.push(i)}}),{rawBones:a,bones:[]}},parseMorphTargets:function(e,t){for(var r=[],n=0;n<e.children.length;n++){var i=e.children[n],o=t[i.ID],s={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if("BlendShapeChannel"!==o.attrType)return;s.geoID=a.get(parseInt(i.ID)).children.filter(function(e){return void 0===e.relationship})[0].ID,r.push(s)}return r},parseScene:function(r,i,o){n=new e.Group;var s=this.parseModels(r.skeletons,i,o),u=t.Objects.Model,c=this;s.forEach(function(e){var t=u[e.ID];c.setLookAtProperties(e,t);var r=a.get(e.ID).parents;r.forEach(function(t){var r=s.get(t.ID);void 0!==r&&r.add(e)}),null===e.parent&&n.add(e)}),this.bindSkeleton(r.skeletons,i,s),this.createAmbientLight(),this.setupMorphMaterials(),n.traverse(function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrixWorld=e.parent.matrix);var t=x(e.userData.transformData);e.applyMatrix4(t)}});var f=(new l).parse();1===n.children.length&&n.children[0].isGroup&&(n.children[0].animations=f,n=n.children[0]),n.animations=f},parseModels:function(r,n,i){var o=new Map,s=t.Objects.Model;for(var l in s){var u=parseInt(l),c=s[l],f=a.get(u),d=this.buildSkeleton(f,r,u,c.attrName);if(!d){switch(c.attrType){case"Camera":d=this.createCamera(f);break;case"Light":d=this.createLight(f);break;case"Mesh":d=this.createMesh(f,n,i);break;case"NurbsCurve":d=this.createCurve(f,n);break;case"LimbNode":case"Root":d=new e.Bone;break;case"Null":default:d=new e.Group}d.name=c.attrName?e.PropertyBinding.sanitizeNodeName(c.attrName):"",d.ID=u}this.getTransformData(d,c),o.set(u,d)}return o},buildSkeleton:function(t,r,a,n){var i=null;return t.parents.forEach(function(t){for(var o in r){var s=r[o];s.rawBones.forEach(function(r,o){if(r.ID===t.ID){var l=i;(i=new e.Bone).matrixWorld.copy(r.transformLink),i.name=n?e.PropertyBinding.sanitizeNodeName(n):"",i.ID=a,s.bones[o]=i,null!==l&&i.add(l)}})}}),i},createCamera:function(r){var a,n;if(r.children.forEach(function(e){var r=t.Objects.NodeAttribute[e.ID];void 0!==r&&(n=r)}),void 0===n)a=new e.Object3D;else{var i=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(i=1);var o=1;void 0!==n.NearPlane&&(o=n.NearPlane.value/1e3);var s=1e3;void 0!==n.FarPlane&&(s=n.FarPlane.value/1e3);var l=window.innerWidth,u=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(l=n.AspectWidth.value,u=n.AspectHeight.value);var c=l/u,f=45;void 0!==n.FieldOfView&&(f=n.FieldOfView.value);var d=n.FocalLength?n.FocalLength.value:null;switch(i){case 0:a=new e.PerspectiveCamera(f,c,o,s),null!==d&&a.setFocalLength(d);break;case 1:a=new e.OrthographicCamera(-l/2,l/2,u/2,-u/2,o,s);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+i+"."),a=new e.Object3D}}return a},createLight:function(r){var a,n;if(r.children.forEach(function(e){var r=t.Objects.NodeAttribute[e.ID];void 0!==r&&(n=r)}),void 0===n)a=new e.Object3D;else{var i;i=void 0===n.LightType?0:n.LightType.value;var o=16777215;void 0!==n.Color&&(o=(new e.Color).fromArray(n.Color.value));var s=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(s=0);var l=0;void 0!==n.FarAttenuationEnd&&(l=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);switch(i){case 0:a=new e.PointLight(o,s,l,1);break;case 1:a=new e.DirectionalLight(o,s);break;case 2:var u=Math.PI/3;void 0!==n.InnerAngle&&(u=e.MathUtils.degToRad(n.InnerAngle.value));var c=0;void 0!==n.OuterAngle&&(c=e.MathUtils.degToRad(n.OuterAngle.value),c=Math.max(c,1)),a=new e.SpotLight(o,s,l,u,c,1);break;default:console.warn("THREE.FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a THREE.PointLight."),a=new e.PointLight(o,s)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(a.castShadow=!0)}return a},createMesh:function(t,r,a){var n,i=null,o=null,s=[];return t.children.forEach(function(e){r.has(e.ID)&&(i=r.get(e.ID)),a.has(e.ID)&&s.push(a.get(e.ID))}),s.length>1?o=s:s.length>0?o=s[0]:(o=new e.MeshPhongMaterial({color:13421772}),s.push(o)),"color"in i.attributes&&s.forEach(function(e){e.vertexColors=!0}),i.FBX_Deformer?(s.forEach(function(e){e.skinning=!0}),(n=new e.SkinnedMesh(i,o)).normalizeSkinWeights()):n=new e.Mesh(i,o),n},createCurve:function(t,r){var a=t.children.reduce(function(e,t){return r.has(t.ID)&&(e=r.get(t.ID)),e},null),n=new e.LineBasicMaterial({color:3342591,linewidth:1});return new e.Line(a,n)},getTransformData:function(e,t){var r={};"InheritType"in t&&(r.inheritType=parseInt(t.InheritType.value)),r.eulerOrder="RotationOrder"in t?A(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(r.translation=t.Lcl_Translation.value),"PreRotation"in t&&(r.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(r.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(r.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(r.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(r.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(r.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(r.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(r.rotationPivot=t.RotationPivot.value),e.userData.transformData=r},setLookAtProperties:function(r,i){if("LookAtProperty"in i){var o=a.get(r.ID).children;o.forEach(function(a){if("LookAtProperty"===a.relationship){var i=t.Objects.Model[a.ID];if("Lcl_Translation"in i){var o=i.Lcl_Translation.value;void 0!==r.target?(r.target.position.fromArray(o),n.add(r.target)):r.lookAt((new e.Vector3).fromArray(o))}}})}},bindSkeleton:function(t,r,n){var i=this.parsePoseNodes();for(var o in t){var s=t[o],l=a.get(parseInt(s.ID)).parents;l.forEach(function(t){if(r.has(t.ID)){var o=t.ID,l=a.get(o);l.parents.forEach(function(t){if(n.has(t.ID)){var r=n.get(t.ID);r.bind(new e.Skeleton(s.bones),i[t.ID])}})}})}},parsePoseNodes:function(){var r={};if("Pose"in t.Objects){var a=t.Objects.Pose;for(var n in a)if("BindPose"===a[n].attrType){var i=a[n].PoseNode;Array.isArray(i)?i.forEach(function(t){r[t.Node]=(new e.Matrix4).fromArray(t.Matrix.a)}):r[i.Node]=(new e.Matrix4).fromArray(i.Matrix.a)}}return r},createAmbientLight:function(){if("GlobalSettings"in t&&"AmbientColor"in t.GlobalSettings){var r=t.GlobalSettings.AmbientColor.value,a=r[0],i=r[1],o=r[2];if(0!==a||0!==i||0!==o){var s=new e.Color(a,i,o);n.add(new e.AmbientLight(s,1))}}},setupMorphMaterials:function(){var e=this;n.traverse(function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach(function(r,a){e.setupMorphMaterial(t,r,a)}):e.setupMorphMaterial(t,t.material))})},setupMorphMaterial:function(e,t,r){var a=e.uuid,i=t.uuid,o=!1;if(n.traverse(function(e){e.isMesh&&(Array.isArray(e.material)?e.material.forEach(function(t){t.uuid===i&&e.uuid!==a&&(o=!0)}):e.material.uuid===i&&e.uuid!==a&&(o=!0))}),!0===o){var s=t.clone();s.morphTargets=!0,void 0===r?e.material=s:e.material[r]=s}else t.morphTargets=!0}},s.prototype={constructor:s,parse:function(e){var r=new Map;if("Geometry"in t.Objects){var n=t.Objects.Geometry;for(var i in n){var o=a.get(parseInt(i)),s=this.parseGeometry(o,n[i],e);r.set(parseInt(i),s)}}return r},parseGeometry:function(e,t,r){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,r);case"NurbsCurve":return this.parseNurbsGeometry(t)}},parseMeshGeometry:function(e,r,a){var n=a.skeletons,i=[],o=e.parents.map(function(e){return t.Objects.Model[e.ID]});if(0!==o.length){var s=e.children.reduce(function(e,t){return void 0!==n[t.ID]&&(e=n[t.ID]),e},null);e.children.forEach(function(e){void 0!==a.morphTargets[e.ID]&&i.push(a.morphTargets[e.ID])});var l=o[0],u={};"RotationOrder"in l&&(u.eulerOrder=A(l.RotationOrder.value)),"InheritType"in l&&(u.inheritType=parseInt(l.InheritType.value)),"GeometricTranslation"in l&&(u.translation=l.GeometricTranslation.value),"GeometricRotation"in l&&(u.rotation=l.GeometricRotation.value),"GeometricScaling"in l&&(u.scale=l.GeometricScaling.value);var c=x(u);return this.genGeometry(r,s,i,c)}},genGeometry:function(t,r,a,n){var i=new e.BufferGeometry;t.attrName&&(i.name=t.attrName);var o=this.parseGeoNode(t,r),s=this.genBuffers(o),l=new e.Float32BufferAttribute(s.vertex,3);if(l.applyMatrix4(n),i.setAttribute("position",l),s.colors.length>0&&i.setAttribute("color",new e.Float32BufferAttribute(s.colors,3)),r&&(i.setAttribute("skinIndex",new e.Uint16BufferAttribute(s.weightsIndices,4)),i.setAttribute("skinWeight",new e.Float32BufferAttribute(s.vertexWeights,4)),i.FBX_Deformer=r),s.normal.length>0){var u=(new e.Matrix3).getNormalMatrix(n),c=new e.Float32BufferAttribute(s.normal,3);c.applyNormalMatrix(u),i.setAttribute("normal",c)}if(s.uvs.forEach(function(t,r){var a="uv"+(r+1).toString();0===r&&(a="uv"),i.setAttribute(a,new e.Float32BufferAttribute(s.uvs[r],2))}),o.material&&"AllSame"!==o.material.mappingType){var f=s.materialIndex[0],d=0;if(s.materialIndex.forEach(function(e,t){e!==f&&(i.addGroup(d,t-d,f),f=e,d=t)}),i.groups.length>0){var h=i.groups[i.groups.length-1],p=h.start+h.count;p!==s.materialIndex.length&&i.addGroup(p,s.materialIndex.length-p,f)}0===i.groups.length&&i.addGroup(0,s.materialIndex.length,s.materialIndex[0])}return this.addMorphTargets(i,t,a,n),i},parseGeoNode:function(e,t){var r={};if(r.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],r.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(r.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(r.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(r.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){r.uv=[];for(var a=0;e.LayerElementUV[a];)r.uv.push(this.parseUVs(e.LayerElementUV[a])),a++}return r.weightTable={},null!==t&&(r.skeleton=t,t.rawBones.forEach(function(e,t){e.indices.forEach(function(a,n){void 0===r.weightTable[a]&&(r.weightTable[a]=[]),r.weightTable[a].push({id:t,weight:e.weights[n]})})})),r},genBuffers:function(e){var t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},r=0,a=0,n=!1,i=[],o=[],s=[],l=[],u=[],c=[],f=this;return e.vertexIndices.forEach(function(d,h){var p=!1;d<0&&(d^=-1,p=!0);var m=[],g=[];if(i.push(3*d,3*d+1,3*d+2),e.color){var y=v(h,r,d,e.color);s.push(y[0],y[1],y[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach(function(e){g.push(e.weight),m.push(e.id)}),g.length>4){n||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),n=!0);var x=[0,0,0,0],A=[0,0,0,0];g.forEach(function(e,t){var r=e,a=m[t];A.forEach(function(e,t,n){if(r>e){n[t]=r,r=e;var i=x[t];x[t]=a,a=i}})}),m=x,g=A}for(;g.length<4;)g.push(0),m.push(0);for(var b=0;b<4;++b)u.push(g[b]),c.push(m[b])}if(e.normal){var y=v(h,r,d,e.normal);o.push(y[0],y[1],y[2])}if(e.material&&"AllSame"!==e.material.mappingType)var T=v(h,r,d,e.material)[0];e.uv&&e.uv.forEach(function(e,t){var a=v(h,r,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(a[0]),l[t].push(a[1])}),a++,p&&(f.genFace(t,e,i,T,o,s,l,u,c,a),r++,a=0,i=[],o=[],s=[],l=[],u=[],c=[])}),t},genFace:function(e,t,r,a,n,i,o,s,l,u){for(var c=2;c<u;c++)e.vertex.push(t.vertexPositions[r[0]]),e.vertex.push(t.vertexPositions[r[1]]),e.vertex.push(t.vertexPositions[r[2]]),e.vertex.push(t.vertexPositions[r[3*(c-1)]]),e.vertex.push(t.vertexPositions[r[3*(c-1)+1]]),e.vertex.push(t.vertexPositions[r[3*(c-1)+2]]),e.vertex.push(t.vertexPositions[r[3*c]]),e.vertex.push(t.vertexPositions[r[3*c+1]]),e.vertex.push(t.vertexPositions[r[3*c+2]]),t.skeleton&&(e.vertexWeights.push(s[0]),e.vertexWeights.push(s[1]),e.vertexWeights.push(s[2]),e.vertexWeights.push(s[3]),e.vertexWeights.push(s[4*(c-1)]),e.vertexWeights.push(s[4*(c-1)+1]),e.vertexWeights.push(s[4*(c-1)+2]),e.vertexWeights.push(s[4*(c-1)+3]),e.vertexWeights.push(s[4*c]),e.vertexWeights.push(s[4*c+1]),e.vertexWeights.push(s[4*c+2]),e.vertexWeights.push(s[4*c+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(c-1)]),e.weightsIndices.push(l[4*(c-1)+1]),e.weightsIndices.push(l[4*(c-1)+2]),e.weightsIndices.push(l[4*(c-1)+3]),e.weightsIndices.push(l[4*c]),e.weightsIndices.push(l[4*c+1]),e.weightsIndices.push(l[4*c+2]),e.weightsIndices.push(l[4*c+3])),t.color&&(e.colors.push(i[0]),e.colors.push(i[1]),e.colors.push(i[2]),e.colors.push(i[3*(c-1)]),e.colors.push(i[3*(c-1)+1]),e.colors.push(i[3*(c-1)+2]),e.colors.push(i[3*c]),e.colors.push(i[3*c+1]),e.colors.push(i[3*c+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(a),e.materialIndex.push(a),e.materialIndex.push(a)),t.normal&&(e.normal.push(n[0]),e.normal.push(n[1]),e.normal.push(n[2]),e.normal.push(n[3*(c-1)]),e.normal.push(n[3*(c-1)+1]),e.normal.push(n[3*(c-1)+2]),e.normal.push(n[3*c]),e.normal.push(n[3*c+1]),e.normal.push(n[3*c+2])),t.uv&&t.uv.forEach(function(t,r){void 0===e.uvs[r]&&(e.uvs[r]=[]),e.uvs[r].push(o[r][0]),e.uvs[r].push(o[r][1]),e.uvs[r].push(o[r][2*(c-1)]),e.uvs[r].push(o[r][2*(c-1)+1]),e.uvs[r].push(o[r][2*c]),e.uvs[r].push(o[r][2*c+1])})},addMorphTargets:function(e,r,a,n){if(0!==a.length){e.morphTargetsRelative=!0,e.morphAttributes.position=[];var i=this;a.forEach(function(a){a.rawTargets.forEach(function(a){var o=t.Objects.Geometry[a.geoID];void 0!==o&&i.genMorphGeometry(e,r,o,n,a.name)})})}},genMorphGeometry:function(t,r,a,n,i){for(var o=void 0!==r.PolygonVertexIndex?r.PolygonVertexIndex.a:[],s=void 0!==a.Vertices?a.Vertices.a:[],l=void 0!==a.Indexes?a.Indexes.a:[],u=3*t.attributes.position.count,c=new Float32Array(u),f=0;f<l.length;f++){var d=3*l[f];c[d]=s[3*f],c[d+1]=s[3*f+1],c[d+2]=s[3*f+2]}var h={vertexIndices:o,vertexPositions:c},p=this.genBuffers(h),m=new e.Float32BufferAttribute(p.vertex,3);m.name=i||a.attrName,m.applyMatrix4(n),t.morphAttributes.position.push(m)},parseNormals:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,a=e.Normals.a,n=[];return"IndexToDirect"===r&&("NormalIndex"in e?n=e.NormalIndex.a:"NormalsIndex"in e&&(n=e.NormalsIndex.a)),{dataSize:3,buffer:a,indices:n,mappingType:t,referenceType:r}},parseUVs:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,a=e.UV.a,n=[];return"IndexToDirect"===r&&(n=e.UVIndex.a),{dataSize:2,buffer:a,indices:n,mappingType:t,referenceType:r}},parseVertexColors:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,a=e.Colors.a,n=[];return"IndexToDirect"===r&&(n=e.ColorIndex.a),{dataSize:4,buffer:a,indices:n,mappingType:t,referenceType:r}},parseMaterialIndices:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};for(var a=e.Materials.a,n=[],i=0;i<a.length;++i)n.push(i);return{dataSize:1,buffer:a,indices:n,mappingType:t,referenceType:r}},parseNurbsGeometry:function(t){if(void 0===e.NURBSCurve)return console.error("THREE.FBXLoader: The loader relies on THREE.NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new e.BufferGeometry;var r=parseInt(t.Order);if(isNaN(r))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",t.Order,t.id),new e.BufferGeometry;for(var a,n,i=r-1,o=t.KnotVector.a,s=[],l=t.Points.a,u=0,c=l.length;u<c;u+=4)s.push((new e.Vector4).fromArray(l,u));if("Closed"===t.Form)s.push(s[0]);else if("Periodic"===t.Form){a=i,n=o.length-1-a;for(var u=0;u<i;++u)s.push(s[u])}var f=new e.NURBSCurve(i,o,s,a,n),d=f.getPoints(7*s.length),h=new Float32Array(3*d.length);d.forEach(function(e,t){e.toArray(h,3*t)});var p=new e.BufferGeometry;return p.setAttribute("position",new e.BufferAttribute(h,3)),p}},l.prototype={constructor:l,parse:function(){var e=[],t=this.parseClips();if(void 0!==t)for(var r in t){var a=t[r],n=this.addClip(a);e.push(n)}return e},parseClips:function(){if(void 0!==t.Objects.AnimationCurve){var e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);var r=this.parseAnimationLayers(e),a=this.parseAnimStacks(r);return a}},parseAnimationCurveNodes:function(){var e=t.Objects.AnimationCurveNode,r=new Map;for(var a in e){var n=e[a];if(null!==n.attrName.match(/S|R|T|DeformPercent/)){var i={id:n.id,attr:n.attrName,curves:{}};r.set(i.id,i)}}return r},parseAnimationCurves:function(e){var r=t.Objects.AnimationCurve;for(var n in r){var i={id:r[n].id,times:r[n].KeyTime.a.map(p),values:r[n].KeyValueFloat.a},o=a.get(i.id);if(void 0!==o){var s=o.parents[0].ID,l=o.parents[0].relationship;l.match(/X/)?e.get(s).curves.x=i:l.match(/Y/)?e.get(s).curves.y=i:l.match(/Z/)?e.get(s).curves.z=i:l.match(/d|DeformPercent/)&&e.has(s)&&(e.get(s).curves.morph=i)}}},parseAnimationLayers:function(r){var i=t.Objects.AnimationLayer,o=new Map;for(var s in i){var l=[],u=a.get(parseInt(s));if(void 0!==u){var c=u.children;c.forEach(function(i,o){if(r.has(i.ID)){var s=r.get(i.ID);if(void 0!==s.curves.x||void 0!==s.curves.y||void 0!==s.curves.z){if(void 0===l[o]){var u=a.get(i.ID).parents.filter(function(e){return void 0!==e.relationship})[0].ID;if(void 0!==u){var c=t.Objects.Model[u.toString()],f={modelName:c.attrName?e.PropertyBinding.sanitizeNodeName(c.attrName):"",ID:c.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};n.traverse(function(e){e.ID===c.id&&(f.transform=e.matrix,e.userData.transformData&&(f.eulerOrder=e.userData.transformData.eulerOrder))}),f.transform||(f.transform=new e.Matrix4),"PreRotation"in c&&(f.preRotation=c.PreRotation.value),"PostRotation"in c&&(f.postRotation=c.PostRotation.value),l[o]=f}}l[o]&&(l[o][s.attr]=s)}else if(void 0!==s.curves.morph){if(void 0===l[o]){var d=a.get(i.ID).parents.filter(function(e){return void 0!==e.relationship})[0].ID,h=a.get(d).parents[0].ID,p=a.get(h).parents[0].ID,u=a.get(p).parents[0].ID,c=t.Objects.Model[u],f={modelName:c.attrName?e.PropertyBinding.sanitizeNodeName(c.attrName):"",morphName:t.Objects.Deformer[d].attrName};l[o]=f}l[o][s.attr]=s}}}),o.set(parseInt(s),l)}}return o},parseAnimStacks:function(e){var r=t.Objects.AnimationStack,n={};for(var i in r){var o=a.get(parseInt(i)).children;o.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var s=e.get(o[0].ID);n[i]={name:r[i].attrName,layer:s}}return n},addClip:function(t){var r=[],a=this;return t.layer.forEach(function(e){r=r.concat(a.generateTracks(e))}),new e.AnimationClip(t.name,-1,r)},generateTracks:function(t){var r=[],a=new e.Vector3,n=new e.Quaternion,i=new e.Vector3;if(t.transform&&t.transform.decompose(a,n,i),a=a.toArray(),n=(new e.Euler).setFromQuaternion(n,t.eulerOrder).toArray(),i=i.toArray(),void 0!==t.T&&Object.keys(t.T.curves).length>0){var o=this.generateVectorTrack(t.modelName,t.T.curves,a,"position");void 0!==o&&r.push(o)}if(void 0!==t.R&&Object.keys(t.R.curves).length>0){var s=this.generateRotationTrack(t.modelName,t.R.curves,n,t.preRotation,t.postRotation,t.eulerOrder);void 0!==s&&r.push(s)}if(void 0!==t.S&&Object.keys(t.S.curves).length>0){var l=this.generateVectorTrack(t.modelName,t.S.curves,i,"scale");void 0!==l&&r.push(l)}if(void 0!==t.DeformPercent){var u=this.generateMorphTrack(t);void 0!==u&&r.push(u)}return r},generateVectorTrack:function(t,r,a,n){var i=this.getTimesForAllAxes(r),o=this.getKeyframeTrackValues(i,r,a);return new e.VectorKeyframeTrack(t+"."+n,i,o)},generateRotationTrack:function(t,r,a,n,i,o){void 0!==r.x&&(this.interpolateRotations(r.x),r.x.values=r.x.values.map(e.MathUtils.degToRad)),void 0!==r.y&&(this.interpolateRotations(r.y),r.y.values=r.y.values.map(e.MathUtils.degToRad)),void 0!==r.z&&(this.interpolateRotations(r.z),r.z.values=r.z.values.map(e.MathUtils.degToRad));var s=this.getTimesForAllAxes(r),l=this.getKeyframeTrackValues(s,r,a);void 0!==n&&((n=n.map(e.MathUtils.degToRad)).push(o),n=(new e.Euler).fromArray(n),n=(new e.Quaternion).setFromEuler(n)),void 0!==i&&((i=i.map(e.MathUtils.degToRad)).push(o),i=(new e.Euler).fromArray(i),i=(new e.Quaternion).setFromEuler(i).inverse());for(var u=new e.Quaternion,c=new e.Euler,f=[],d=0;d<l.length;d+=3)c.set(l[d],l[d+1],l[d+2],o),u.setFromEuler(c),void 0!==n&&u.premultiply(n),void 0!==i&&u.multiply(i),u.toArray(f,d/3*4);return new e.QuaternionKeyframeTrack(t+".quaternion",s,f)},generateMorphTrack:function(t){var r=t.DeformPercent.curves.morph,a=r.values.map(function(e){return e/100}),i=n.getObjectByName(t.modelName).morphTargetDictionary[t.morphName];return new e.NumberKeyframeTrack(t.modelName+".morphTargetInfluences["+i+"]",r.times,a)},getTimesForAllAxes:function(e){var t=[];return void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort(function(e,t){return e-t}).filter(function(e,t,r){return r.indexOf(e)==t})},getKeyframeTrackValues:function(e,t,r){var a=r,n=[],i=-1,o=-1,s=-1;return e.forEach(function(e){if(t.x&&(i=t.x.times.indexOf(e)),t.y&&(o=t.y.times.indexOf(e)),t.z&&(s=t.z.times.indexOf(e)),-1!==i){var r=t.x.values[i];n.push(r),a[0]=r}else n.push(a[0]);if(-1!==o){var l=t.y.values[o];n.push(l),a[1]=l}else n.push(a[1]);if(-1!==s){var u=t.z.values[s];n.push(u),a[2]=u}else n.push(a[2])}),n},interpolateRotations:function(e){for(var t=1;t<e.values.length;t++){var r=e.values[t-1],a=e.values[t]-r,n=Math.abs(a);if(n>=180){for(var i=n/180,o=a/i,s=r+o,l=e.times[t-1],u=e.times[t]-l,c=u/i,f=l+c,d=[],h=[];f<e.times[t];)d.push(f),f+=c,h.push(s),s+=o;e.times=w(e.times,t,d),e.values=w(e.values,t,h)}}}},u.prototype={constructor:u,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(e){this.currentIndent=0,this.allNodes=new d,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var t=this,r=e.split(/[\r\n]+/);return r.forEach(function(e,a){var n=e.match(/^[\s\t]*;/),i=e.match(/^[\s\t]*$/);if(!n&&!i){var o=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),s=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");o?t.parseNodeBegin(e,o):s?t.parseNodeProperty(e,s,r[++a]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)}}),this.allNodes},parseNodeBegin:function(e,t){var r=t[1].trim().replace(/^"/,"").replace(/"$/,""),a=t[2].split(",").map(function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")}),n={name:r},i=this.parseNodeAttr(a),o=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(r,n):r in o?("PoseNode"===r?o.PoseNode.push(n):void 0!==o[r].id&&(o[r]={},o[r][o[r].id]=o[r]),""!==i.id&&(o[r][i.id]=n)):"number"==typeof i.id?(o[r]={},o[r][i.id]=n):"Properties70"!==r&&(o[r]="PoseNode"===r?[n]:n),"number"==typeof i.id&&(n.id=i.id),""!==i.name&&(n.attrName=i.name),""!==i.type&&(n.attrType=i.type),this.pushStack(n)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var r="",a="";return e.length>1&&(r=e[1].replace(/^(\w+)::/,""),a=e[2]),{id:t,name:r,type:a}},parseNodeProperty:function(e,t,r){var a=t[1].replace(/^"/,"").replace(/"$/,"").trim(),n=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===a&&","===n&&(n=r.replace(/"/g,"").replace(/,$/,"").trim());var i=this.getCurrentNode(),o=i.name;if("Properties70"!==o){if("C"===a){var s=n.split(",").slice(1),l=parseInt(s[0]),u=parseInt(s[1]),c=n.split(",").slice(3);c=c.map(function(e){return e.trim().replace(/^"/,"")}),a="connections",function(e,t){for(var r=0,a=e.length,n=t.length;r<n;r++,a++)e[a]=t[r]}(n=[l,u],c),void 0===i[a]&&(i[a]=[])}"Node"===a&&(i.id=n),a in i&&Array.isArray(i[a])?i[a].push(n):"a"!==a?i[a]=n:i.a=n,this.setCurrentProp(i,a),"a"===a&&","!==n.slice(-1)&&(i.a=b(n))}else this.parseNodeSpecialProperty(e,a,n)},parseNodePropertyContinued:function(e){var t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=b(t.a))},parseNodeSpecialProperty:function(e,t,r){var a=r.split('",').map(function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")}),n=a[0],i=a[1],o=a[2],s=a[3],l=a[4];switch(i){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=b(l)}this.getPrevNode()[n]={type:i,type2:o,flag:s,value:l},this.setCurrentProp(this.getPrevNode(),n)}},c.prototype={constructor:c,parse:function(e){var t=new f(e);t.skip(23);var r=t.getUint32();console.log("THREE.FBXLoader: FBX binary version: "+r);for(var a=new d;!this.endOfContent(t);){var n=this.parseNode(t,r);null!==n&&a.add(n.name,n)}return a},endOfContent:function(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()},parseNode:function(e,t){var r={},a=t>=7500?e.getUint64():e.getUint32(),n=t>=7500?e.getUint64():e.getUint32(),i=(t>=7500?e.getUint64():e.getUint32(),e.getUint8()),o=e.getString(i);if(0===a)return null;for(var s=[],l=0;l<n;l++)s.push(this.parseProperty(e));var u=s.length>0?s[0]:"",c=s.length>1?s[1]:"",f=s.length>2?s[2]:"";for(r.singleProperty=1===n&&e.getOffset()===a;a>e.getOffset();){var d=this.parseNode(e,t);null!==d&&this.parseSubNode(o,r,d)}return r.propertyList=s,"number"==typeof u&&(r.id=u),""!==c&&(r.attrName=c),""!==f&&(r.attrType=f),""!==o&&(r.name=o),r},parseSubNode:function(e,t,r){if(!0===r.singleProperty){var a=r.propertyList[0];Array.isArray(a)?(t[r.name]=r,r.a=a):t[r.name]=a}else if("Connections"===e&&"C"===r.name){var n=[];r.propertyList.forEach(function(e,t){0!==t&&n.push(e)}),void 0===t.connections&&(t.connections=[]),t.connections.push(n)}else if("Properties70"===r.name){var i=Object.keys(r);i.forEach(function(e){t[e]=r[e]})}else if("Properties70"===e&&"P"===r.name){var o,s=r.propertyList[0],l=r.propertyList[1],u=r.propertyList[2],c=r.propertyList[3];0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),0===l.indexOf("Lcl ")&&(l=l.replace("Lcl ","Lcl_")),o="Color"===l||"ColorRGB"===l||"Vector"===l||"Vector3D"===l||0===l.indexOf("Lcl_")?[r.propertyList[4],r.propertyList[5],r.propertyList[6]]:r.propertyList[4],t[s]={type:l,type2:u,flag:c,value:o}}else void 0===t[r.name]?"number"==typeof r.id?(t[r.name]={},t[r.name][r.id]=r):t[r.name]=r:"PoseNode"===r.name?(Array.isArray(t[r.name])||(t[r.name]=[t[r.name]]),t[r.name].push(r)):void 0===t[r.name][r.id]&&(t[r.name][r.id]=r)},parseProperty:function(e){var t=e.getString(1);switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var a=e.getUint32();return e.getArrayBuffer(a);case"S":var a=e.getUint32();return e.getString(a);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var n=e.getUint32(),i=e.getUint32(),o=e.getUint32();if(0===i)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}void 0===r&&console.error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var s=new r.Inflate(new Uint8Array(e.getArrayBuffer(o))),l=new f(s.decompress().buffer);switch(t){case"b":case"c":return l.getBooleanArray(n);case"d":return l.getFloat64Array(n);case"f":return l.getFloat32Array(n);case"i":return l.getInt32Array(n);case"l":return l.getInt64Array(n)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}},f.prototype={constructor:f,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1==(1&this.getUint8())},getBooleanArray:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getBoolean());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt32());return t},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,4294967295===(e=4294967295&~e)&&(t=t+1&4294967295),-(4294967296*t+(e=e+1&4294967295))):4294967296*t+e},getInt64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt64());return t},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat64());return t},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getString:function(t){for(var r=[],a=0;a<t;a++)r[a]=this.getUint8();var n=r.indexOf(0);return n>=0&&(r=r.slice(0,n)),e.LoaderUtils.decodeText(new Uint8Array(r))}},d.prototype={constructor:d,add:function(e,t){this[e]=t}};var m=[];function v(e,t,r,a){var n;switch(a.mappingType){case"ByPolygonVertex":n=e;break;case"ByPolygon":n=t;break;case"ByVertice":n=r;break;case"AllSame":n=a.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+a.mappingType)}"IndexToDirect"===a.referenceType&&(n=a.indices[n]);var i=n*a.dataSize,o=i+a.dataSize;return function(e,t,r,a){for(var n=r,i=0;n<a;n++,i++)e[i]=t[n];return e}(m,a.buffer,i,o)}var g=new e.Euler,y=new e.Vector3;function x(t){var r=new e.Matrix4,a=new e.Matrix4,n=new e.Matrix4,i=new e.Matrix4,o=new e.Matrix4,s=new e.Matrix4,l=new e.Matrix4,u=new e.Matrix4,c=new e.Matrix4,f=new e.Matrix4,d=new e.Matrix4,h=t.inheritType?t.inheritType:0;if(t.translation&&r.setPosition(y.fromArray(t.translation)),t.preRotation){var p=t.preRotation.map(e.MathUtils.degToRad);p.push(t.eulerOrder),a.makeRotationFromEuler(g.fromArray(p))}if(t.rotation){var p=t.rotation.map(e.MathUtils.degToRad);p.push(t.eulerOrder),n.makeRotationFromEuler(g.fromArray(p))}if(t.postRotation){var p=t.postRotation.map(e.MathUtils.degToRad);p.push(t.eulerOrder),i.makeRotationFromEuler(g.fromArray(p))}t.scale&&o.scale(y.fromArray(t.scale)),t.scalingOffset&&l.setPosition(y.fromArray(t.scalingOffset)),t.scalingPivot&&s.setPosition(y.fromArray(t.scalingPivot)),t.rotationOffset&&u.setPosition(y.fromArray(t.rotationOffset)),t.rotationPivot&&c.setPosition(y.fromArray(t.rotationPivot)),t.parentMatrixWorld&&(f=t.parentMatrixWorld);var m=a.multiply(n).multiply(i),v=new e.Matrix4;f.extractRotation(v);var x,A,b,T,w=new e.Matrix4;if(w.copyPosition(f),b=w.getInverse(w).multiply(f),A=v.getInverse(v).multiply(b),x=o,0===h)T=v.multiply(m).multiply(A).multiply(x);else if(1===h)T=v.multiply(A).multiply(m).multiply(x);else{var F=(new e.Matrix4).copy(o),_=A.multiply(F.getInverse(F));T=v.multiply(m).multiply(_).multiply(x)}var E=r.multiply(u).multiply(c).multiply(a).multiply(n).multiply(i).multiply(c.getInverse(c)).multiply(l).multiply(s).multiply(o).multiply(s.getInverse(s)),L=(new e.Matrix4).copyPosition(E),S=f.multiply(L);return d.copyPosition(S),E=d.multiply(T)}function A(e){var t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function b(e){var t=e.split(",").map(function(e){return parseFloat(e)});return t}function T(t,r,a){return void 0===r&&(r=0),void 0===a&&(a=t.byteLength),e.LoaderUtils.decodeText(new Uint8Array(t,r,a))}function w(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}return i}(),e.FBXLoader}),e("skylark-threejs-ex/loaders/GCodeLoader",["skylark-threejs"],function(e){return e.GCodeLoader=function(t){e.Loader.call(this,t),this.splitLayer=!1},e.GCodeLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.GCodeLoader,load:function(t,r,a,n){var i=this,o=new e.FileLoader(i.manager);o.setPath(i.path),o.load(t,function(e){r(i.parse(e))},a,n)},parse:function(t){var r={x:0,y:0,z:0,e:0,f:0,extruding:!1,relative:!1},a=[],n=void 0,i=new e.LineBasicMaterial({color:16711680});i.name="path";var o=new e.LineBasicMaterial({color:65280});function s(e){n={vertex:[],pathVertex:[],z:e.z},a.push(n)}function l(e,t){void 0===n&&s(e),v.extruding?(n.vertex.push(e.x,e.y,e.z),n.vertex.push(t.x,t.y,t.z)):(n.pathVertex.push(e.x,e.y,e.z),n.pathVertex.push(t.x,t.y,t.z))}function u(e,t){return r.relative?t:t-e}function c(e,t){return r.relative?e+t:t}o.name="extruded";for(var f=t.replace(/;.+/g,"").split("\n"),d=0;d<f.length;d++){var h=f[d].split(" "),p=h[0].toUpperCase(),m={};if(h.splice(1).forEach(function(e){if(void 0!==e[0]){var t=e[0].toLowerCase(),r=parseFloat(e.substring(1));m[t]=r}}),"G0"===p||"G1"===p){var v={x:void 0!==m.x?c(r.x,m.x):r.x,y:void 0!==m.y?c(r.y,m.y):r.y,z:void 0!==m.z?c(r.z,m.z):r.z,e:void 0!==m.e?c(r.e,m.e):r.e,f:void 0!==m.f?c(r.f,m.f):r.f};u(r.e,v.e)>0&&(v.extruding=u(r.e,v.e)>0,void 0!=n&&v.z==n.z||s(v)),l(r,v),r=v}else if("G2"===p||"G3"===p);else if("G90"===p)r.relative=!1;else if("G91"===p)r.relative=!0;else if("G92"===p){var v=r;v.x=void 0!==m.x?m.x:v.x,v.y=void 0!==m.y?m.y:v.y,v.z=void 0!==m.z?m.z:v.z,v.e=void 0!==m.e?m.e:v.e,r=v}}function g(t,r){var a=new e.BufferGeometry;a.setAttribute("position",new e.Float32BufferAttribute(t,3));var n=new e.LineSegments(a,r?o:i);n.name="layer"+d,y.add(n)}var y=new e.Group;if(y.name="gcode",this.splitLayer)for(var d=0;d<a.length;d++){var x=a[d];g(x.vertex,!0),g(x.pathVertex,!1)}else{for(var A=[],b=[],d=0;d<a.length;d++){var x=a[d];A=A.concat(x.vertex),b=b.concat(x.pathVertex)}g(A,!0),g(b,!1)}return y.quaternion.setFromEuler(new e.Euler(-Math.PI/2,0,0)),y}}),e.GCodeLoader}),e("skylark-threejs-ex/loaders/GLTFLoader",["skylark-threejs"],function(e){return e.GLTFLoader=function(){function t(t){e.Loader.call(this,t),this.dracoLoader=null,this.ddsLoader=null}t.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:t,load:function(t,r,a,n){var i,o=this;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:e.LoaderUtils.extractUrlBase(t),o.manager.itemStart(t);var s=function(e){n?n(e):console.error(e),o.manager.itemError(t),o.manager.itemEnd(t)},l=new e.FileLoader(o.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),"use-credentials"===o.crossOrigin&&l.setWithCredentials(!0),l.load(t,function(e){try{o.parse(e,i,function(e){r(e),o.manager.itemEnd(t)},s)}catch(e){s(e)}},a,s)},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(e){return this.ddsLoader=e,this},parse:function(t,d,m,v){var g,y={};if("string"==typeof t)g=t;else{var x=e.LoaderUtils.decodeText(new Uint8Array(t,0,4));if(x===s){try{y[r.KHR_BINARY_GLTF]=new function(t){this.name=r.KHR_BINARY_GLTF,this.content=null,this.body=null;var a=new DataView(t,0,l);if(this.header={magic:e.LoaderUtils.decodeText(new Uint8Array(t.slice(0,4))),version:a.getUint32(4,!0),length:a.getUint32(8,!0)},this.header.magic!==s)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");var n=new DataView(t,l),i=0;for(;i<n.byteLength;){var o=n.getUint32(i,!0);i+=4;var c=n.getUint32(i,!0);if(i+=4,c===u.JSON){var f=new Uint8Array(t,l+i,o);this.content=e.LoaderUtils.decodeText(f)}else if(c===u.BIN){var d=l+i;this.body=t.slice(d,d+o)}i+=o}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}(t)}catch(e){return void(v&&v(e))}g=y[r.KHR_BINARY_GLTF].content}else g=e.LoaderUtils.decodeText(new Uint8Array(t))}var A=JSON.parse(g);if(void 0===A.asset||A.asset.version[0]<2)v&&v(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{if(A.extensionsUsed)for(var b=0;b<A.extensionsUsed.length;++b){var T=A.extensionsUsed[b],w=A.extensionsRequired||[];switch(T){case r.KHR_LIGHTS_PUNCTUAL:y[T]=new n(A);break;case r.KHR_MATERIALS_CLEARCOAT:y[T]=new o;break;case r.KHR_MATERIALS_UNLIT:y[T]=new i;break;case r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:y[T]=new h;break;case r.KHR_DRACO_MESH_COMPRESSION:y[T]=new c(A,this.dracoLoader);break;case r.MSFT_TEXTURE_DDS:y[T]=new a(this.ddsLoader);break;case r.KHR_TEXTURE_TRANSFORM:y[T]=new f;break;case r.KHR_MESH_QUANTIZATION:y[T]=new p;break;default:w.indexOf(T)>=0&&console.warn('THREE.GLTFLoader: Unknown extension "'+T+'".')}}var F=new k(A,y,{path:d||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager});F.parse(m,v)}}});var r={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function a(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing THREE.DDSLoader");this.name=r.MSFT_TEXTURE_DDS,this.ddsLoader=e}function n(e){this.name=r.KHR_LIGHTS_PUNCTUAL;var t=e.extensions&&e.extensions[r.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function i(){this.name=r.KHR_MATERIALS_UNLIT}function o(){this.name=r.KHR_MATERIALS_CLEARCOAT}n.prototype.loadLight=function(t){var r,a=this.lightDefs[t],n=new e.Color(16777215);void 0!==a.color&&n.fromArray(a.color);var i=void 0!==a.range?a.range:0;switch(a.type){case"directional":(r=new e.DirectionalLight(n)).target.position.set(0,0,-1),r.add(r.target);break;case"point":(r=new e.PointLight(n)).distance=i;break;case"spot":(r=new e.SpotLight(n)).distance=i,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,r.angle=a.spot.outerConeAngle,r.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,r.target.position.set(0,0,-1),r.add(r.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+a.type+'".')}return r.position.set(0,0,0),r.decay=2,void 0!==a.intensity&&(r.intensity=a.intensity),r.name=a.name||"light_"+t,Promise.resolve(r)},i.prototype.getMaterialType=function(){return e.MeshBasicMaterial},i.prototype.extendParams=function(t,r,a){var n=[];t.color=new e.Color(1,1,1),t.opacity=1;var i=r.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){var o=i.baseColorFactor;t.color.fromArray(o),t.opacity=o[3]}void 0!==i.baseColorTexture&&n.push(a.assignTexture(t,"map",i.baseColorTexture))}return Promise.all(n)},o.prototype.getMaterialType=function(){return e.MeshPhysicalMaterial},o.prototype.extendParams=function(t,r,a){var n=[],i=r.extensions[this.name];if(void 0!==i.clearcoatFactor&&(t.clearcoat=i.clearcoatFactor),void 0!==i.clearcoatTexture&&n.push(a.assignTexture(t,"clearcoatMap",i.clearcoatTexture)),void 0!==i.clearcoatRoughnessFactor&&(t.clearcoatRoughness=i.clearcoatRoughnessFactor),void 0!==i.clearcoatRoughnessTexture&&n.push(a.assignTexture(t,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),void 0!==i.clearcoatNormalTexture&&(n.push(a.assignTexture(t,"clearcoatNormalMap",i.clearcoatNormalTexture)),void 0!==i.clearcoatNormalTexture.scale)){var o=i.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new e.Vector2(o,o)}return Promise.all(n)};var s="glTF",l=12,u={JSON:1313821514,BIN:5130562};function c(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=r.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function f(){this.name=r.KHR_TEXTURE_TRANSFORM}function d(t){e.MeshStandardMaterial.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var r=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),a=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),i=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),o=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 );// 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),s={specular:{value:(new e.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=s,this.onBeforeCompile=function(e){for(var t in s)e.uniforms[t]=s[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;"),e.fragmentShader=e.fragmentShader.replace("uniform float metalness;","uniform float glossiness;"),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_pars_fragment>",r),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_pars_fragment>",a),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_fragment>",n),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_fragment>",i),e.fragmentShader=e.fragmentShader.replace("#include <lights_physical_fragment>",o)},Object.defineProperties(this,{specular:{get:function(){return s.specular.value},set:function(e){s.specular.value=e}},specularMap:{get:function(){return s.specularMap.value},set:function(e){s.specularMap.value=e}},glossiness:{get:function(){return s.glossiness.value},set:function(e){s.glossiness.value=e}},glossinessMap:{get:function(){return s.glossinessMap.value},set:function(e){s.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_ROUGHNESSMAP=""):(delete this.defines.USE_ROUGHNESSMAP,delete this.defines.USE_GLOSSINESSMAP)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(t)}function h(){return{name:r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return d},extendParams:function(t,r,a){var n=r.extensions[this.name];t.color=new e.Color(1,1,1),t.opacity=1;var i=[];if(Array.isArray(n.diffuseFactor)){var o=n.diffuseFactor;t.color.fromArray(o),t.opacity=o[3]}if(void 0!==n.diffuseTexture&&i.push(a.assignTexture(t,"map",n.diffuseTexture)),t.emissive=new e.Color(0,0,0),t.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,t.specular=new e.Color(1,1,1),Array.isArray(n.specularFactor)&&t.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var s=n.specularGlossinessTexture;i.push(a.assignTexture(t,"glossinessMap",s)),i.push(a.assignTexture(t,"specularMap",s))}return Promise.all(i)},createMaterial:function(t){var r=new d(t);return r.fog=!0,r.color=t.color,r.map=void 0===t.map?null:t.map,r.lightMap=null,r.lightMapIntensity=1,r.aoMap=void 0===t.aoMap?null:t.aoMap,r.aoMapIntensity=1,r.emissive=t.emissive,r.emissiveIntensity=1,r.emissiveMap=void 0===t.emissiveMap?null:t.emissiveMap,r.bumpMap=void 0===t.bumpMap?null:t.bumpMap,r.bumpScale=1,r.normalMap=void 0===t.normalMap?null:t.normalMap,r.normalMapType=e.TangentSpaceNormalMap,t.normalScale&&(r.normalScale=t.normalScale),r.displacementMap=null,r.displacementScale=1,r.displacementBias=0,r.specularMap=void 0===t.specularMap?null:t.specularMap,r.specular=t.specular,r.glossinessMap=void 0===t.glossinessMap?null:t.glossinessMap,r.glossiness=t.glossiness,r.alphaMap=null,r.envMap=void 0===t.envMap?null:t.envMap,r.envMapIntensity=1,r.refractionRatio=.98,r}}}function p(){this.name=r.KHR_MESH_QUANTIZATION}function m(t,r,a,n){e.Interpolant.call(this,t,r,a,n)}c.prototype.decodePrimitive=function(e,t){var r=this.json,a=this.dracoLoader,n=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,o={},s={},l={};for(var u in i){var c=b[u]||u.toLowerCase();o[c]=i[u]}for(u in e.attributes){var c=b[u]||u.toLowerCase();if(void 0!==i[u]){var f=r.accessors[e.attributes[u]],d=g[f.componentType];l[c]=d,s[c]=!0===f.normalized}}return t.getDependency("bufferView",n).then(function(e){return new Promise(function(t){a.decodeDracoFile(e,function(e){for(var r in e.attributes){var a=e.attributes[r],n=s[r];void 0!==n&&(a.normalized=n)}t(e)},o,l)})})},f.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},d.prototype=Object.create(e.MeshStandardMaterial.prototype),d.prototype.constructor=d,d.prototype.copy=function(t){return e.MeshStandardMaterial.prototype.copy.call(this,t),this.specularMap=t.specularMap,this.specular.copy(t.specular),this.glossinessMap=t.glossinessMap,this.glossiness=t.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},m.prototype=Object.create(e.Interpolant.prototype),m.prototype.constructor=m,m.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,a=this.valueSize,n=e*a*3+a,i=0;i!==a;i++)t[i]=r[n+i];return t},m.prototype.beforeStart_=m.prototype.copySampleValue_,m.prototype.afterEnd_=m.prototype.copySampleValue_,m.prototype.interpolate_=function(e,t,r,a){for(var n=this.resultBuffer,i=this.sampleValues,o=this.valueSize,s=2*o,l=3*o,u=a-t,c=(r-t)/u,f=c*c,d=f*c,h=e*l,p=h-l,m=-2*d+3*f,v=d-f,g=1-m,y=v-f+c,x=0;x!==o;x++){var A=i[p+x+o],b=i[p+x+s]*u,T=i[h+x+o],w=i[h+x]*u;n[x]=g*A+y*b+m*T+v*w}return n};var v={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},g={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},y={9728:e.NearestFilter,9729:e.LinearFilter,9984:e.NearestMipmapNearestFilter,9985:e.LinearMipmapNearestFilter,9986:e.NearestMipmapLinearFilter,9987:e.LinearMipmapLinearFilter},x={33071:e.ClampToEdgeWrapping,33648:e.MirroredRepeatWrapping,10497:e.RepeatWrapping},A={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},b={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},T={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},w={CUBICSPLINE:void 0,LINEAR:e.InterpolateLinear,STEP:e.InterpolateDiscrete},F={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"},_={"image/png":e.RGBAFormat,"image/jpeg":e.RGBFormat};function E(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:t+e)}function L(t){return void 0===t.DefaultMaterial&&(t.DefaultMaterial=new e.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:e.FrontSide})),t.DefaultMaterial}function S(e,t,r){for(var a in r.extensions)void 0===e[a]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[a]=r.extensions[a])}function M(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function P(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,a=t.weights.length;r<a;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(var r=0,a=n.length;r<a;r++)e.morphTargetDictionary[n[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function N(e){var t=e.extensions&&e.extensions[r.KHR_DRACO_MESH_COMPRESSION];return t?"draco:"+t.bufferView+":"+t.indices+":"+I(t.attributes):e.indices+":"+I(e.attributes)+":"+e.mode}function I(e){for(var t="",r=Object.keys(e).sort(),a=0,n=r.length;a<n;a++)t+=r[a]+":"+e[r[a]]+";";return t}function k(t,r,a){this.json=t||{},this.extensions=r||{},this.options=a||{},this.cache=new function(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}},this.primitiveCache={},this.textureLoader=new e.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new e.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function R(t,r,a){var n=r.attributes,i=[];function o(e,r){return a.getDependency("accessor",e).then(function(e){t.setAttribute(r,e)})}for(var s in n){var l=b[s]||s.toLowerCase();l in t.attributes||i.push(o(n[s],l))}if(void 0!==r.indices&&!t.index){var u=a.getDependency("accessor",r.indices).then(function(e){t.setIndex(e)});i.push(u)}return M(t,r),function(t,r,a){var n=r.attributes,i=new e.Box3;if(void 0===n.POSITION)return;var o=a.json.accessors[n.POSITION],s=o.min,l=o.max;if(void 0===s||void 0===l)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");i.set(new e.Vector3(s[0],s[1],s[2]),new e.Vector3(l[0],l[1],l[2]));var u=r.targets;if(void 0!==u){for(var c=new e.Vector3,f=new e.Vector3,d=0,h=u.length;d<h;d++){var p=u[d];if(void 0!==p.POSITION){var o=a.json.accessors[p.POSITION],s=o.min,l=o.max;void 0!==s&&void 0!==l?(f.setX(Math.max(Math.abs(s[0]),Math.abs(l[0]))),f.setY(Math.max(Math.abs(s[1]),Math.abs(l[1]))),f.setZ(Math.max(Math.abs(s[2]),Math.abs(l[2]))),c.max(f)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(c)}t.boundingBox=i;var m=new e.Sphere;i.getCenter(m.center),m.radius=i.min.distanceTo(i.max)/2,t.boundingSphere=m}(t,r,a),Promise.all(i).then(function(){return void 0!==r.targets?function(e,t,r){for(var a=!1,n=!1,i=0,o=t.length;i<o;i++){var s=t[i];if(void 0!==s.POSITION&&(a=!0),void 0!==s.NORMAL&&(n=!0),a&&n)break}if(!a&&!n)return Promise.resolve(e);for(var l=[],u=[],i=0,o=t.length;i<o;i++){var s=t[i];if(a){var c=void 0!==s.POSITION?r.getDependency("accessor",s.POSITION):e.attributes.position;l.push(c)}if(n){var c=void 0!==s.NORMAL?r.getDependency("accessor",s.NORMAL):e.attributes.normal;u.push(c)}}return Promise.all([Promise.all(l),Promise.all(u)]).then(function(t){var r=t[0],i=t[1];return a&&(e.morphAttributes.position=r),n&&(e.morphAttributes.normal=i),e.morphTargetsRelative=!0,e})}(t,r.targets,a):t})}function C(t,r){var a=t.getIndex();if(null===a){var n=[],i=t.getAttribute("position");if(void 0===i)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),t;for(var o=0;o<i.count;o++)n.push(o);t.setIndex(n),a=t.getIndex()}var s=a.count-2,l=[];if(r===e.TriangleFanDrawMode)for(var o=1;o<=s;o++)l.push(a.getX(0)),l.push(a.getX(o)),l.push(a.getX(o+1));else for(var o=0;o<s;o++)o%2==0?(l.push(a.getX(o)),l.push(a.getX(o+1)),l.push(a.getX(o+2))):(l.push(a.getX(o+2)),l.push(a.getX(o+1)),l.push(a.getX(o)));l.length/3!==s&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var u=t.clone();return u.setIndex(l),u}return k.prototype.parse=function(e,t){var r=this,a=this.json,n=this.extensions;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then(function(t){var i={scene:t[0][a.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:a.asset,parser:r,userData:{}};S(n,i,a),M(i,a),e(i)}).catch(t)},k.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],a={},n={},i=0,o=t.length;i<o;i++)for(var s=t[i].joints,l=0,u=s.length;l<u;l++)e[s[l]].isBone=!0;for(var c=0,f=e.length;c<f;c++){var d=e[c];void 0!==d.mesh&&(void 0===a[d.mesh]&&(a[d.mesh]=n[d.mesh]=0),a[d.mesh]++,void 0!==d.skin&&(r[d.mesh].isSkinnedMesh=!0))}this.json.meshReferences=a,this.json.meshUses=n},k.prototype.getDependency=function(e,t){var a=e+":"+t,n=this.cache.get(a);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this.loadMesh(t);break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this.loadBufferView(t);break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this.loadMaterial(t);break;case"texture":n=this.loadTexture(t);break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;case"light":n=this.extensions[r.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(a,n)}return n},k.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,a=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(a.map(function(t,a){return r.getDependency(e,a)})),this.cache.add(e,t)}return t},k.prototype.loadBuffer=function(e){var t=this.json.buffers[e],a=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[r.KHR_BINARY_GLTF].body);var n=this.options;return new Promise(function(e,r){a.load(E(t.uri,n.path),e,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})},k.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){var r=t.byteLength||0,a=t.byteOffset||0;return e.slice(a,a+r)})},k.prototype.loadAccessor=function(t){var r=this,a=this.json,n=this.json.accessors[t];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(t){var i,o,s=t[0],l=A[n.type],u=g[n.componentType],c=u.BYTES_PER_ELEMENT,f=c*l,d=n.byteOffset||0,h=void 0!==n.bufferView?a.bufferViews[n.bufferView].byteStride:void 0,p=!0===n.normalized;if(h&&h!==f){var m=Math.floor(d/h),v="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+m+":"+n.count,y=r.cache.get(v);y||(i=new u(s,m*h,n.count*h/c),y=new e.InterleavedBuffer(i,h/c),r.cache.add(v,y)),o=new e.InterleavedBufferAttribute(y,l,d%h/c,p)}else i=null===s?new u(n.count*l):new u(s,d,n.count*l),o=new e.BufferAttribute(i,l,p);if(void 0!==n.sparse){var x=A.SCALAR,b=g[n.sparse.indices.componentType],T=n.sparse.indices.byteOffset||0,w=n.sparse.values.byteOffset||0,F=new b(t[1],T,n.sparse.count*x),_=new u(t[2],w,n.sparse.count*l);null!==s&&(o=new e.BufferAttribute(o.array.slice(),o.itemSize,o.normalized));for(var E=0,L=F.length;E<L;E++){var S=F[E];if(o.setX(S,_[E*l]),l>=2&&o.setY(S,_[E*l+1]),l>=3&&o.setZ(S,_[E*l+2]),l>=4&&o.setW(S,_[E*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return o})},k.prototype.loadTexture=function(t){var a,n=this,i=this.json,o=this.options,s=this.textureLoader,l=self.URL||self.webkitURL,u=i.textures[t],c=u.extensions||{},f=(a=c[r.MSFT_TEXTURE_DDS]?i.images[c[r.MSFT_TEXTURE_DDS].source]:i.images[u.source]).uri,d=!1;return void 0!==a.bufferView&&(f=n.getDependency("bufferView",a.bufferView).then(function(e){d=!0;var t=new Blob([e],{type:a.mimeType});return f=l.createObjectURL(t)})),Promise.resolve(f).then(function(e){var t=o.manager.getHandler(e);return t||(t=c[r.MSFT_TEXTURE_DDS]?n.extensions[r.MSFT_TEXTURE_DDS].ddsLoader:s),new Promise(function(r,a){t.load(E(e,o.path),r,void 0,a)})}).then(function(t){!0===d&&l.revokeObjectURL(f),t.flipY=!1,u.name&&(t.name=u.name),a.mimeType in _&&(t.format=_[a.mimeType]);var r=i.samplers||{},n=r[u.sampler]||{};return t.magFilter=y[n.magFilter]||e.LinearFilter,t.minFilter=y[n.minFilter]||e.LinearMipmapLinearFilter,t.wrapS=x[n.wrapS]||e.RepeatWrapping,t.wrapT=x[n.wrapT]||e.RepeatWrapping,t})},k.prototype.assignTexture=function(t,a,n){var i=this;return this.getDependency("texture",n.index).then(function(o){if(!o.isCompressedTexture)switch(a){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":o.format=e.RGBFormat}if(void 0===n.texCoord||0==n.texCoord||"aoMap"===a&&1==n.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+a+" not yet supported."),i.extensions[r.KHR_TEXTURE_TRANSFORM]){var s=void 0!==n.extensions?n.extensions[r.KHR_TEXTURE_TRANSFORM]:void 0;s&&(o=i.extensions[r.KHR_TEXTURE_TRANSFORM].extendTexture(o,s))}t[a]=o})},k.prototype.assignFinalMaterial=function(t){var r=t.geometry,a=t.material,n=void 0!==r.attributes.tangent,i=void 0!==r.attributes.color,o=void 0===r.attributes.normal,s=!0===t.isSkinnedMesh,l=Object.keys(r.morphAttributes).length>0,u=l&&void 0!==r.morphAttributes.normal;if(t.isPoints){var c="PointsMaterial:"+a.uuid,f=this.cache.get(c);f||(f=new e.PointsMaterial,e.Material.prototype.copy.call(f,a),f.color.copy(a.color),f.map=a.map,f.sizeAttenuation=!1,this.cache.add(c,f)),a=f}else if(t.isLine){var c="LineBasicMaterial:"+a.uuid,d=this.cache.get(c);d||(d=new e.LineBasicMaterial,e.Material.prototype.copy.call(d,a),d.color.copy(a.color),this.cache.add(c,d)),a=d}if(n||i||o||s||l){var c="ClonedMaterial:"+a.uuid+":";a.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),s&&(c+="skinning:"),n&&(c+="vertex-tangents:"),i&&(c+="vertex-colors:"),o&&(c+="flat-shading:"),l&&(c+="morph-targets:"),u&&(c+="morph-normals:");var h=this.cache.get(c);h||(h=a.clone(),s&&(h.skinning=!0),n&&(h.vertexTangents=!0),i&&(h.vertexColors=!0),o&&(h.flatShading=!0),l&&(h.morphTargets=!0),u&&(h.morphNormals=!0),this.cache.add(c,h)),a=h}a.aoMap&&void 0===r.attributes.uv2&&void 0!==r.attributes.uv&&r.setAttribute("uv2",new e.BufferAttribute(r.attributes.uv.array,2)),a.normalScale&&!n&&(a.normalScale.y=-a.normalScale.y),a.clearcoatNormalScale&&!n&&(a.clearcoatNormalScale.y=-a.clearcoatNormalScale.y),t.material=a},k.prototype.loadMaterial=function(t){var a,n=this.json,i=this.extensions,o=n.materials[t],s={},l=o.extensions||{},u=[];if(l[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var c=i[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];a=c.getMaterialType(),u.push(c.extendParams(s,o,this))}else if(l[r.KHR_MATERIALS_UNLIT]){var f=i[r.KHR_MATERIALS_UNLIT];a=f.getMaterialType(),u.push(f.extendParams(s,o,this))}else{a=e.MeshStandardMaterial;var h=o.pbrMetallicRoughness||{};if(s.color=new e.Color(1,1,1),s.opacity=1,Array.isArray(h.baseColorFactor)){var p=h.baseColorFactor;s.color.fromArray(p),s.opacity=p[3]}void 0!==h.baseColorTexture&&u.push(this.assignTexture(s,"map",h.baseColorTexture)),s.metalness=void 0!==h.metallicFactor?h.metallicFactor:1,s.roughness=void 0!==h.roughnessFactor?h.roughnessFactor:1,void 0!==h.metallicRoughnessTexture&&(u.push(this.assignTexture(s,"metalnessMap",h.metallicRoughnessTexture)),u.push(this.assignTexture(s,"roughnessMap",h.metallicRoughnessTexture)))}!0===o.doubleSided&&(s.side=e.DoubleSide);var m=o.alphaMode||F.OPAQUE;if(m===F.BLEND?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,m===F.MASK&&(s.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&a!==e.MeshBasicMaterial&&(u.push(this.assignTexture(s,"normalMap",o.normalTexture)),s.normalScale=new e.Vector2(1,1),void 0!==o.normalTexture.scale&&s.normalScale.set(o.normalTexture.scale,o.normalTexture.scale)),void 0!==o.occlusionTexture&&a!==e.MeshBasicMaterial&&(u.push(this.assignTexture(s,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(s.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&a!==e.MeshBasicMaterial&&(s.emissive=(new e.Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&a!==e.MeshBasicMaterial&&u.push(this.assignTexture(s,"emissiveMap",o.emissiveTexture)),l[r.KHR_MATERIALS_CLEARCOAT]){var v=i[r.KHR_MATERIALS_CLEARCOAT];a=v.getMaterialType(),u.push(v.extendParams(s,{extensions:l},this))}return Promise.all(u).then(function(){var t;return t=a===d?i[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(s):new a(s),o.name&&(t.name=o.name),t.map&&(t.map.encoding=e.sRGBEncoding),t.emissiveMap&&(t.emissiveMap.encoding=e.sRGBEncoding),M(t,o),o.extensions&&S(i,t,o),t})},k.prototype.loadGeometries=function(t){var a=this,n=this.extensions,i=this.primitiveCache;function o(e){return n[r.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,a).then(function(t){return R(t,e,a)})}for(var s=[],l=0,u=t.length;l<u;l++){var c,f=t[l],d=N(f),h=i[d];if(h)s.push(h.promise);else c=f.extensions&&f.extensions[r.KHR_DRACO_MESH_COMPRESSION]?o(f):R(new e.BufferGeometry,f,a),i[d]={primitive:f,promise:c},s.push(c)}return Promise.all(s)},k.prototype.loadMesh=function(t){for(var r=this,a=this.json,n=a.meshes[t],i=n.primitives,o=[],s=0,l=i.length;s<l;s++){var u=void 0===i[s].material?L(this.cache):this.getDependency("material",i[s].material);o.push(u)}return o.push(r.loadGeometries(i)),Promise.all(o).then(function(a){for(var o=a.slice(0,a.length-1),s=a[a.length-1],l=[],u=0,c=s.length;u<c;u++){var f,d=s[u],h=i[u],p=o[u];if(h.mode===v.TRIANGLES||h.mode===v.TRIANGLE_STRIP||h.mode===v.TRIANGLE_FAN||void 0===h.mode)!0!==(f=!0===n.isSkinnedMesh?new e.SkinnedMesh(d,p):new e.Mesh(d,p)).isSkinnedMesh||f.geometry.attributes.skinWeight.normalized||f.normalizeSkinWeights(),h.mode===v.TRIANGLE_STRIP?f.geometry=C(f.geometry,e.TriangleStripDrawMode):h.mode===v.TRIANGLE_FAN&&(f.geometry=C(f.geometry,e.TriangleFanDrawMode));else if(h.mode===v.LINES)f=new e.LineSegments(d,p);else if(h.mode===v.LINE_STRIP)f=new e.Line(d,p);else if(h.mode===v.LINE_LOOP)f=new e.LineLoop(d,p);else{if(h.mode!==v.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);f=new e.Points(d,p)}Object.keys(f.geometry.morphAttributes).length>0&&P(f,n),f.name=n.name||"mesh_"+t,s.length>1&&(f.name+="_"+u),M(f,n),r.assignFinalMaterial(f),l.push(f)}if(1===l.length)return l[0];for(var m=new e.Group,u=0,c=l.length;u<c;u++)m.add(l[u]);return m})},k.prototype.loadCamera=function(t){var r,a=this.json.cameras[t],n=a[a.type];if(n)return"perspective"===a.type?r=new e.PerspectiveCamera(e.MathUtils.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===a.type&&(r=new e.OrthographicCamera(n.xmag/-2,n.xmag/2,n.ymag/2,n.ymag/-2,n.znear,n.zfar)),a.name&&(r.name=a.name),M(r,a),Promise.resolve(r);console.warn("THREE.GLTFLoader: Missing camera parameters.")},k.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then(function(e){return r.inverseBindMatrices=e,r})},k.prototype.loadAnimation=function(t){for(var r=this.json,a=r.animations[t],n=[],i=[],o=[],s=[],l=[],u=0,c=a.channels.length;u<c;u++){var f=a.channels[u],d=a.samplers[f.sampler],h=f.target,p=void 0!==h.node?h.node:h.id,v=void 0!==a.parameters?a.parameters[d.input]:d.input,g=void 0!==a.parameters?a.parameters[d.output]:d.output;n.push(this.getDependency("node",p)),i.push(this.getDependency("accessor",v)),o.push(this.getDependency("accessor",g)),s.push(d),l.push(h)}return Promise.all([Promise.all(n),Promise.all(i),Promise.all(o),Promise.all(s),Promise.all(l)]).then(function(r){for(var n=r[0],i=r[1],o=r[2],s=r[3],l=r[4],u=[],c=0,f=n.length;c<f;c++){var d=n[c],h=i[c],p=o[c],v=s[c],g=l[c];if(void 0!==d){var y;switch(d.updateMatrix(),d.matrixAutoUpdate=!0,T[g.path]){case T.weights:y=e.NumberKeyframeTrack;break;case T.rotation:y=e.QuaternionKeyframeTrack;break;case T.position:case T.scale:default:y=e.VectorKeyframeTrack}var x=d.name?d.name:d.uuid,A=void 0!==v.interpolation?w[v.interpolation]:e.InterpolateLinear,b=[];T[g.path]===T.weights?d.traverse(function(e){!0===e.isMesh&&e.morphTargetInfluences&&b.push(e.name?e.name:e.uuid)}):b.push(x);var F=p.array;if(p.normalized){var _;if(F.constructor===Int8Array)_=1/127;else if(F.constructor===Uint8Array)_=1/255;else if(F.constructor==Int16Array)_=1/32767;else{if(F.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");_=1/65535}for(var E=new Float32Array(F.length),L=0,S=F.length;L<S;L++)E[L]=F[L]*_;F=E}for(var L=0,S=b.length;L<S;L++){var M=new y(b[L]+"."+T[g.path],h.array,F,A);"CUBICSPLINE"===v.interpolation&&(M.createInterpolant=function(e){return new m(this.times,this.values,this.getValueSize()/3,e)},M.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),u.push(M)}}}var P=a.name?a.name:"animation_"+t;return new e.AnimationClip(P,void 0,u)})},k.prototype.loadNode=function(t){var a,n=this.json,i=this.extensions,o=this,s=n.meshReferences,l=n.meshUses,u=n.nodes[t];return(a=[],void 0!==u.mesh&&a.push(o.getDependency("mesh",u.mesh).then(function(e){var t;if(s[u.mesh]>1){var r=l[u.mesh]++;(t=e.clone()).name+="_instance_"+r}else t=e;return void 0!==u.weights&&t.traverse(function(e){if(e.isMesh)for(var t=0,r=u.weights.length;t<r;t++)e.morphTargetInfluences[t]=u.weights[t]}),t})),void 0!==u.camera&&a.push(o.getDependency("camera",u.camera)),u.extensions&&u.extensions[r.KHR_LIGHTS_PUNCTUAL]&&void 0!==u.extensions[r.KHR_LIGHTS_PUNCTUAL].light&&a.push(o.getDependency("light",u.extensions[r.KHR_LIGHTS_PUNCTUAL].light)),Promise.all(a)).then(function(t){var r;if((r=!0===u.isBone?new e.Bone:t.length>1?new e.Group:1===t.length?t[0]:new e.Object3D)!==t[0])for(var a=0,n=t.length;a<n;a++)r.add(t[a]);if(u.name&&(r.userData.name=u.name,r.name=e.PropertyBinding.sanitizeNodeName(u.name)),M(r,u),u.extensions&&S(i,r,u),void 0!==u.matrix){var o=new e.Matrix4;o.fromArray(u.matrix),r.applyMatrix4(o)}else void 0!==u.translation&&r.position.fromArray(u.translation),void 0!==u.rotation&&r.quaternion.fromArray(u.rotation),void 0!==u.scale&&r.scale.fromArray(u.scale);return r})},k.prototype.loadScene=function(){function t(r,a,n,i){var o=n.nodes[r];return i.getDependency("node",r).then(function(t){return void 0===o.skin?t:i.getDependency("skin",o.skin).then(function(e){for(var t=[],a=0,n=(r=e).joints.length;a<n;a++)t.push(i.getDependency("node",r.joints[a]));return Promise.all(t)}).then(function(a){return t.traverse(function(t){if(t.isMesh){for(var n=[],i=[],o=0,s=a.length;o<s;o++){var l=a[o];if(l){n.push(l);var u=new e.Matrix4;void 0!==r.inverseBindMatrices&&u.fromArray(r.inverseBindMatrices.array,16*o),i.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',r.joints[o])}t.bind(new e.Skeleton(n,i),t.matrixWorld)}}),t});var r}).then(function(e){a.add(e);var r=[];if(o.children)for(var s=o.children,l=0,u=s.length;l<u;l++){var c=s[l];r.push(t(c,e,n,i))}return Promise.all(r)})}return function(r){var a=this.json,n=this.extensions,i=this.json.scenes[r],o=new e.Group;i.name&&(o.name=i.name),M(o,i),i.extensions&&S(n,o,i);for(var s=i.nodes||[],l=[],u=0,c=s.length;u<c;u++)l.push(t(s[u],o,a,this));return Promise.all(l).then(function(){return o})}}(),t}(),e.GLTFLoader}),e("skylark-threejs-ex/loaders/MTLLoader",["skylark-threejs"],function(e){return e.MTLLoader=function(t){e.Loader.call(this,t)},e.MTLLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.MTLLoader,load:function(t,r,a,n){var i=this,o=""===this.path?e.LoaderUtils.extractUrlBase(t):this.path,s=new e.FileLoader(this.manager);s.setPath(this.path),s.load(t,function(e){r(i.parse(e,o))},a,n)},setMaterialOptions:function(e){return this.materialOptions=e,this},parse:function(t,r){for(var a=t.split("\n"),n={},i=/\s+/,o={},s=0;s<a.length;s++){var l=a[s];if(0!==(l=l.trim()).length&&"#"!==l.charAt(0)){var u=l.indexOf(" "),c=u>=0?l.substring(0,u):l;c=c.toLowerCase();var f=u>=0?l.substring(u+1):"";if(f=f.trim(),"newmtl"===c)n={name:f},o[f]=n;else if("ka"===c||"kd"===c||"ks"===c||"ke"===c){var d=f.split(i,3);n[c]=[parseFloat(d[0]),parseFloat(d[1]),parseFloat(d[2])]}else n[c]=f}}var h=new e.MTLLoader.MaterialCreator(this.resourcePath||r,this.materialOptions);return h.setCrossOrigin(this.crossOrigin),h.setManager(this.manager),h.setMaterials(o),h}}),e.MTLLoader.MaterialCreator=function(t,r){this.baseUrl=t||"",this.options=r,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:e.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:e.RepeatWrapping},e.MTLLoader.MaterialCreator.prototype={constructor:e.MTLLoader.MaterialCreator,crossOrigin:"anonymous",setCrossOrigin:function(e){return this.crossOrigin=e,this},setManager:function(e){this.manager=e},setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t={};for(var r in e){var a=e[r],n={};for(var i in t[r]=n,a){var o=!0,s=a[i],l=i.toLowerCase();switch(l){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(s=[s[0]/255,s[1]/255,s[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===s[0]&&0===s[1]&&0===s[2]&&(o=!1)}o&&(n[l]=s)}}return t},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray},create:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(t){var r=this,a=this.materialsInfo[t],n={name:t,side:this.side};function i(e,t){if(!n[e]){var a,i,o=r.getTextureParams(t,n),s=r.loadTexture((a=r.baseUrl,"string"!=typeof(i=o.url)||""===i?"":/^https?:\/\//i.test(i)?i:a+i));s.repeat.copy(o.scale),s.offset.copy(o.offset),s.wrapS=r.wrap,s.wrapT=r.wrap,n[e]=s}}for(var o in a){var s,l=a[o];if(""!==l)switch(o.toLowerCase()){case"kd":n.color=(new e.Color).fromArray(l);break;case"ks":n.specular=(new e.Color).fromArray(l);break;case"ke":n.emissive=(new e.Color).fromArray(l);break;case"map_kd":i("map",l);break;case"map_ks":i("specularMap",l);break;case"map_ke":i("emissiveMap",l);break;case"norm":i("normalMap",l);break;case"map_bump":case"bump":i("bumpMap",l);break;case"map_d":i("alphaMap",l),n.transparent=!0;break;case"ns":n.shininess=parseFloat(l);break;case"d":(s=parseFloat(l))<1&&(n.opacity=s,n.transparent=!0);break;case"tr":s=parseFloat(l),this.options&&this.options.invertTrProperty&&(s=1-s),s>0&&(n.opacity=1-s,n.transparent=!0)}}return this.materials[t]=new e.MeshPhongMaterial(n),this.materials[t]},getTextureParams:function(t,r){var a,n={scale:new e.Vector2(1,1),offset:new e.Vector2(0,0)},i=t.split(/\s+/);return(a=i.indexOf("-bm"))>=0&&(r.bumpScale=parseFloat(i[a+1]),i.splice(a,2)),(a=i.indexOf("-s"))>=0&&(n.scale.set(parseFloat(i[a+1]),parseFloat(i[a+2])),i.splice(a,4)),(a=i.indexOf("-o"))>=0&&(n.offset.set(parseFloat(i[a+1]),parseFloat(i[a+2])),i.splice(a,4)),n.url=i.join(" ").trim(),n},loadTexture:function(t,r,a,n,i){var o,s=void 0!==this.manager?this.manager:e.DefaultLoadingManager,l=s.getHandler(t);return null===l&&(l=new e.TextureLoader(s)),l.setCrossOrigin&&l.setCrossOrigin(this.crossOrigin),o=l.load(t,a,n,i),void 0!==r&&(o.mapping=r),o}},e.MTLLoader}),e("skylark-threejs-ex/loaders/OBJLoader",["skylark-threejs"],function(e){return e.OBJLoader=function(){var t=/^[og]\s*(.+)?/,r=/^mtllib /,a=/^usemtl /,n=/^usemap /;function i(t){e.Loader.call(this,t),this.materials=null}return i.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:i,load:function(t,r,a,n){var i=this,o=new e.FileLoader(i.manager);o.setPath(this.path),o.load(t,function(e){r(i.parse(e))},a,n)},setMaterials:function(e){return this.materials=e,this},parse:function(i){var o=new function(){var e={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materials:{},materialLibraries:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);var r=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:!1!==t,geometry:{vertices:[],normals:[],colors:[],uvs:[]},materials:[],smooth:!0,startMaterial:function(e,t){var r=this._finalize(!1);r&&(r.inherited||r.groupCount<=0)&&this.materials.splice(r.index,1);var a={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&t.length>0?t[t.length-1]:"",smooth:void 0!==r?r.smooth:this.smooth,groupStart:void 0!==r?r.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){var t={index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return t.clone=this.clone.bind(t),t}};return this.materials.push(a),a},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(e){var t=this.currentMaterial();if(t&&-1===t.groupEnd&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e&&this.materials.length>1)for(var r=this.materials.length-1;r>=0;r--)this.materials[r].groupCount<=0&&this.materials.splice(r,1);return e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},r&&r.name&&"function"==typeof r.clone){var a=r.clone(0);a.inherited=!0,this.object.materials.push(a)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(e,t){var r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseNormalIndex:function(e,t){var r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseUVIndex:function(e,t){var r=parseInt(e,10);return 2*(r>=0?r-1:r+t/2)},addVertex:function(e,t,r){var a=this.vertices,n=this.object.geometry.vertices;n.push(a[e+0],a[e+1],a[e+2]),n.push(a[t+0],a[t+1],a[t+2]),n.push(a[r+0],a[r+1],a[r+2])},addVertexPoint:function(e){var t=this.vertices,r=this.object.geometry.vertices;r.push(t[e+0],t[e+1],t[e+2])},addVertexLine:function(e){var t=this.vertices,r=this.object.geometry.vertices;r.push(t[e+0],t[e+1],t[e+2])},addNormal:function(e,t,r){var a=this.normals,n=this.object.geometry.normals;n.push(a[e+0],a[e+1],a[e+2]),n.push(a[t+0],a[t+1],a[t+2]),n.push(a[r+0],a[r+1],a[r+2])},addColor:function(e,t,r){var a=this.colors,n=this.object.geometry.colors;n.push(a[e+0],a[e+1],a[e+2]),n.push(a[t+0],a[t+1],a[t+2]),n.push(a[r+0],a[r+1],a[r+2])},addUV:function(e,t,r){var a=this.uvs,n=this.object.geometry.uvs;n.push(a[e+0],a[e+1]),n.push(a[t+0],a[t+1]),n.push(a[r+0],a[r+1])},addUVLine:function(e){var t=this.uvs,r=this.object.geometry.uvs;r.push(t[e+0],t[e+1])},addFace:function(e,t,r,a,n,i,o,s,l){var u=this.vertices.length,c=this.parseVertexIndex(e,u),f=this.parseVertexIndex(t,u),d=this.parseVertexIndex(r,u);if(this.addVertex(c,f,d),this.colors.length>0&&this.addColor(c,f,d),void 0!==a&&""!==a){var h=this.uvs.length;c=this.parseUVIndex(a,h),f=this.parseUVIndex(n,h),d=this.parseUVIndex(i,h),this.addUV(c,f,d)}if(void 0!==o&&""!==o){var p=this.normals.length;c=this.parseNormalIndex(o,p),f=o===s?c:this.parseNormalIndex(s,p),d=o===l?c:this.parseNormalIndex(l,p),this.addNormal(c,f,d)}},addPointGeometry:function(e){this.object.geometry.type="Points";for(var t=this.vertices.length,r=0,a=e.length;r<a;r++)this.addVertexPoint(this.parseVertexIndex(e[r],t))},addLineGeometry:function(e,t){this.object.geometry.type="Line";for(var r=this.vertices.length,a=this.uvs.length,n=0,i=e.length;n<i;n++)this.addVertexLine(this.parseVertexIndex(e[n],r));for(var o=0,i=t.length;o<i;o++)this.addUVLine(this.parseUVIndex(t[o],a))}};return e.startObject("",!1),e};-1!==i.indexOf("\r\n")&&(i=i.replace(/\r\n/g,"\n")),-1!==i.indexOf("\\\n")&&(i=i.replace(/\\\n/g,""));for(var s=i.split("\n"),l="",u="",c=[],f="function"==typeof"".trimLeft,d=0,h=s.length;d<h;d++)if(l=s[d],l=f?l.trimLeft():l.trim(),0!==l.length&&"#"!==(u=l.charAt(0)))if("v"===u){var p=l.split(/\s+/);switch(p[0]){case"v":o.vertices.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3])),p.length>=7&&o.colors.push(parseFloat(p[4]),parseFloat(p[5]),parseFloat(p[6]));break;case"vn":o.normals.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]));break;case"vt":o.uvs.push(parseFloat(p[1]),parseFloat(p[2]))}}else if("f"===u){for(var m=l.substr(1).trim(),v=m.split(/\s+/),g=[],y=0,x=v.length;y<x;y++){var A=v[y];if(A.length>0){var b=A.split("/");g.push(b)}}for(var T=g[0],y=1,x=g.length-1;y<x;y++){var w=g[y],F=g[y+1];o.addFace(T[0],w[0],F[0],T[1],w[1],F[1],T[2],w[2],F[2])}}else if("l"===u){var _=l.substring(1).trim().split(" "),E=[],L=[];if(-1===l.indexOf("/"))E=_;else for(var S=0,M=_.length;S<M;S++){var P=_[S].split("/");""!==P[0]&&E.push(P[0]),""!==P[1]&&L.push(P[1])}o.addLineGeometry(E,L)}else if("p"===u){var m=l.substr(1).trim(),N=m.split(" ");o.addPointGeometry(N)}else if(null!==(c=t.exec(l))){var I=(" "+c[0].substr(1).trim()).substr(1);o.startObject(I)}else if(a.test(l))o.object.startMaterial(l.substring(7).trim(),o.materialLibraries);else if(r.test(l))o.materialLibraries.push(l.substring(7).trim());else if(n.test(l))console.warn('THREE.OBJLoader: Rendering identifier "usemap" not supported. Textures must be defined in MTL files.');else if("s"===u){if((c=l.split(" ")).length>1){var k=c[1].trim().toLowerCase();o.object.smooth="0"!==k&&"off"!==k}else o.object.smooth=!0;var R=o.object.currentMaterial();R&&(R.smooth=o.object.smooth)}else{if("\0"===l)continue;console.warn('THREE.OBJLoader: Unexpected line: "'+l+'"')}o.finalize();var C=new e.Group;C.materialLibraries=[].concat(o.materialLibraries);for(var d=0,h=o.objects.length;d<h;d++){var U=o.objects[d],O=U.geometry,D=U.materials,B="Line"===O.type,j="Points"===O.type,G=!1;if(0!==O.vertices.length){var V=new e.BufferGeometry;V.setAttribute("position",new e.Float32BufferAttribute(O.vertices,3)),O.normals.length>0?V.setAttribute("normal",new e.Float32BufferAttribute(O.normals,3)):V.computeVertexNormals(),O.colors.length>0&&(G=!0,V.setAttribute("color",new e.Float32BufferAttribute(O.colors,3))),O.uvs.length>0&&V.setAttribute("uv",new e.Float32BufferAttribute(O.uvs,2));for(var X,H=[],z=0,Y=D.length;z<Y;z++){var Q=D[z],W=Q.name+"_"+Q.smooth+"_"+G,R=o.materials[W];if(null!==this.materials)if(R=this.materials.create(Q.name),!B||!R||R instanceof e.LineBasicMaterial){if(j&&R&&!(R instanceof e.PointsMaterial)){var K=new e.PointsMaterial({size:10,sizeAttenuation:!1});e.Material.prototype.copy.call(K,R),K.color.copy(R.color),K.map=R.map,R=K}}else{var q=new e.LineBasicMaterial;e.Material.prototype.copy.call(q,R),q.color.copy(R.color),R=q}void 0===R&&((R=B?new e.LineBasicMaterial:j?new e.PointsMaterial({size:1,sizeAttenuation:!1}):new e.MeshPhongMaterial).name=Q.name,R.flatShading=!Q.smooth,R.vertexColors=G,o.materials[W]=R),H.push(R)}if(H.length>1){for(var z=0,Y=D.length;z<Y;z++){var Q=D[z];V.addGroup(Q.groupStart,Q.groupCount,z)}X=B?new e.LineSegments(V,H):j?new e.Points(V,H):new e.Mesh(V,H)}else X=B?new e.LineSegments(V,H[0]):j?new e.Points(V,H[0]):new e.Mesh(V,H[0]);X.name=U.name,C.add(X)}}return C}}),i}(),e.OBJLoader}),e("skylark-threejs-ex/loaders/PCDLoader",["skylark-threejs"],function(e){return e.PCDLoader=function(t){e.Loader.call(this,t),this.littleEndian=!0},e.PCDLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.PCDLoader,load:function(t,r,a,n){var i=this,o=new e.FileLoader(i.manager);o.setPath(i.path),o.setResponseType("arraybuffer"),o.load(t,function(e){try{r(i.parse(e,t))}catch(e){if(!n)throw e;n(e)}},a,n)},parse:function(t,r){var a=e.LoaderUtils.decodeText(new Uint8Array(t)),n=function(e){var t={},r=e.search(/[\r\n]DATA\s(\S*)\s/i),a=/[\r\n]DATA\s(\S*)\s/i.exec(e.substr(r-1));t.data=a[1],t.headerLen=a[0].length+r,t.str=e.substr(0,t.headerLen),t.str=t.str.replace(/\#.*/gi,""),t.version=/VERSION (.*)/i.exec(t.str),t.fields=/FIELDS (.*)/i.exec(t.str),t.size=/SIZE (.*)/i.exec(t.str),t.type=/TYPE (.*)/i.exec(t.str),t.count=/COUNT (.*)/i.exec(t.str),t.width=/WIDTH (.*)/i.exec(t.str),t.height=/HEIGHT (.*)/i.exec(t.str),t.viewpoint=/VIEWPOINT (.*)/i.exec(t.str),t.points=/POINTS (.*)/i.exec(t.str),null!==t.version&&(t.version=parseFloat(t.version[1]));null!==t.fields&&(t.fields=t.fields[1].split(" "));null!==t.type&&(t.type=t.type[1].split(" "));null!==t.width&&(t.width=parseInt(t.width[1]));null!==t.height&&(t.height=parseInt(t.height[1]));null!==t.viewpoint&&(t.viewpoint=t.viewpoint[1]);null!==t.points&&(t.points=parseInt(t.points[1],10));null===t.points&&(t.points=t.width*t.height);null!==t.size&&(t.size=t.size[1].split(" ").map(function(e){return parseInt(e,10)}));if(null!==t.count)t.count=t.count[1].split(" ").map(function(e){return parseInt(e,10)});else{t.count=[];for(var n=0,i=t.fields.length;n<i;n++)t.count.push(1)}t.offset={};for(var o=0,n=0,i=t.fields.length;n<i;n++)"ascii"===t.data?t.offset[t.fields[n]]=n:(t.offset[t.fields[n]]=o,o+=t.size[n]);return t.rowSize=o,t}(a),i=[],o=[],s=[];if("ascii"===n.data)for(var l=n.offset,u=a.substr(n.headerLen),c=u.split("\n"),f=0,d=c.length;f<d;f++)if(""!==c[f]){var h=c[f].split(" ");if(void 0!==l.x&&(i.push(parseFloat(h[l.x])),i.push(parseFloat(h[l.y])),i.push(parseFloat(h[l.z]))),void 0!==l.rgb){var p=parseFloat(h[l.rgb]),m=p>>16&255,v=p>>8&255,g=p>>0&255;s.push(m/255,v/255,g/255)}void 0!==l.normal_x&&(o.push(parseFloat(h[l.normal_x])),o.push(parseFloat(h[l.normal_y])),o.push(parseFloat(h[l.normal_z])))}if("binary_compressed"===n.data)for(var y=new Uint32Array(t.slice(n.headerLen,n.headerLen+8)),x=y[0],A=y[1],b=function(e,t){var r,a,n,i=e.length,o=new Uint8Array(t),s=0,l=0;do{if((r=e[s++])<32){if(l+ ++r>t)throw new Error("Output buffer is not large enough");if(s+r>i)throw new Error("Invalid compressed data");do{o[l++]=e[s++]}while(--r)}else{if(a=r>>5,n=l-((31&r)<<8)-1,s>=i)throw new Error("Invalid compressed data");if(7===a&&(a+=e[s++],s>=i))throw new Error("Invalid compressed data");if(n-=e[s++],l+a+2>t)throw new Error("Output buffer is not large enough");if(n<0)throw new Error("Invalid compressed data");if(n>=l)throw new Error("Invalid compressed data");do{o[l++]=o[n++]}while(2+--a)}}while(s<i);return o}(new Uint8Array(t,n.headerLen+8,x),A),T=new DataView(b.buffer),l=n.offset,f=0;f<n.points;f++)void 0!==l.x&&(i.push(T.getFloat32(n.points*l.x+n.size[0]*f,this.littleEndian)),i.push(T.getFloat32(n.points*l.y+n.size[1]*f,this.littleEndian)),i.push(T.getFloat32(n.points*l.z+n.size[2]*f,this.littleEndian))),void 0!==l.rgb&&(s.push(T.getUint8(n.points*l.rgb+n.size[3]*f+0)/255),s.push(T.getUint8(n.points*l.rgb+n.size[3]*f+1)/255),s.push(T.getUint8(n.points*l.rgb+n.size[3]*f+2)/255)),void 0!==l.normal_x&&(o.push(T.getFloat32(n.points*l.normal_x+n.size[4]*f,this.littleEndian)),o.push(T.getFloat32(n.points*l.normal_y+n.size[5]*f,this.littleEndian)),o.push(T.getFloat32(n.points*l.normal_z+n.size[6]*f,this.littleEndian)));if("binary"===n.data)for(var T=new DataView(t,n.headerLen),l=n.offset,f=0,w=0;f<n.points;f++,w+=n.rowSize)void 0!==l.x&&(i.push(T.getFloat32(w+l.x,this.littleEndian)),i.push(T.getFloat32(w+l.y,this.littleEndian)),i.push(T.getFloat32(w+l.z,this.littleEndian))),void 0!==l.rgb&&(s.push(T.getUint8(w+l.rgb+2)/255),s.push(T.getUint8(w+l.rgb+1)/255),s.push(T.getUint8(w+l.rgb+0)/255)),void 0!==l.normal_x&&(o.push(T.getFloat32(w+l.normal_x,this.littleEndian)),o.push(T.getFloat32(w+l.normal_y,this.littleEndian)),o.push(T.getFloat32(w+l.normal_z,this.littleEndian)));var F=new e.BufferGeometry;i.length>0&&F.setAttribute("position",new e.Float32BufferAttribute(i,3)),o.length>0&&F.setAttribute("normal",new e.Float32BufferAttribute(o,3)),s.length>0&&F.setAttribute("color",new e.Float32BufferAttribute(s,3)),F.computeBoundingSphere();var _=new e.PointsMaterial({size:.005});s.length>0?_.vertexColors=!0:_.color.setHex(16777215*Math.random());var E=new e.Points(F,_),L=r.split("").reverse().join("");return L=(L=/([^\/]*)/.exec(L))[1].split("").reverse().join(""),E.name=L,E}}),e.PCDLoader}),e("skylark-threejs-ex/loaders/PLYLoader",["skylark-threejs"],function(e){return e.PLYLoader=function(t){e.Loader.call(this,t),this.propertyNameMapping={}},e.PLYLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.PLYLoader,load:function(t,r,a,n){var i=this,o=new e.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.load(t,function(e){r(i.parse(e))},a,n)},setPropertyNameMapping:function(e){this.propertyNameMapping=e},parse:function(t){function r(e){var t="",r=0,a=/ply([\s\S]*)end_header\r?\n/.exec(e);null!==a&&(t=a[1],r=a[0].length);var n,i,o,s={comments:[],elements:[],headerLength:r},l=t.split("\n");function u(e,t){var r={type:e[0]};return"list"===r.type?(r.name=e[3],r.countType=e[1],r.itemType=e[2]):r.name=e[1],r.name in t&&(r.name=t[r.name]),r}for(var c=0;c<l.length;c++){var d=l[c];if(""!==(d=d.trim()))switch(o=d.split(/\s+/),i=o.shift(),d=o.join(" "),i){case"format":s.format=o[0],s.version=o[1];break;case"comment":s.comments.push(d);break;case"element":void 0!==n&&s.elements.push(n),(n={}).name=o[0],n.count=parseInt(o[1]),n.properties=[];break;case"property":n.properties.push(u(o,f.propertyNameMapping));break;default:console.log("unhandled",i,o)}}return void 0!==n&&s.elements.push(n),s}function a(e,t){switch(t){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}}function n(e,t){for(var r=t.split(/\s+/),n={},i=0;i<e.length;i++)if("list"===e[i].type){for(var o=[],s=a(r.shift(),e[i].countType),l=0;l<s;l++)o.push(a(r.shift(),e[i].itemType));n[e[i].name]=o}else n[e[i].name]=a(r.shift(),e[i].type);return n}function i(e,t){var r,a={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[]},i="";null!==(r=/end_header\s([\s\S]*)$/.exec(e))&&(i=r[1]);for(var l=i.split("\n"),u=0,c=0,f=0;f<l.length;f++){var d=l[f];if(""!==(d=d.trim())){c>=t.elements[u].count&&(u++,c=0);var h=n(t.elements[u].properties,d);s(a,t.elements[u].name,h),c++}}return o(a)}function o(t){var r=new e.BufferGeometry;return t.indices.length>0&&r.setIndex(t.indices),r.setAttribute("position",new e.Float32BufferAttribute(t.vertices,3)),t.normals.length>0&&r.setAttribute("normal",new e.Float32BufferAttribute(t.normals,3)),t.uvs.length>0&&r.setAttribute("uv",new e.Float32BufferAttribute(t.uvs,2)),t.colors.length>0&&r.setAttribute("color",new e.Float32BufferAttribute(t.colors,3)),t.faceVertexUvs.length>0&&(r=r.toNonIndexed()).setAttribute("uv",new e.Float32BufferAttribute(t.faceVertexUvs,2)),r.computeBoundingSphere(),r}function s(e,t,r){if("vertex"===t)e.vertices.push(r.x,r.y,r.z),"nx"in r&&"ny"in r&&"nz"in r&&e.normals.push(r.nx,r.ny,r.nz),"s"in r&&"t"in r&&e.uvs.push(r.s,r.t),"red"in r&&"green"in r&&"blue"in r&&e.colors.push(r.red/255,r.green/255,r.blue/255);else if("face"===t){var a=r.vertex_indices||r.vertex_index,n=r.texcoord;3===a.length?(e.indices.push(a[0],a[1],a[2]),n&&6===n.length&&(e.faceVertexUvs.push(n[0],n[1]),e.faceVertexUvs.push(n[2],n[3]),e.faceVertexUvs.push(n[4],n[5]))):4===a.length&&(e.indices.push(a[0],a[1],a[3]),e.indices.push(a[1],a[2],a[3]))}}function l(e,t,r,a){switch(r){case"int8":case"char":return[e.getInt8(t),1];case"uint8":case"uchar":return[e.getUint8(t),1];case"int16":case"short":return[e.getInt16(t,a),2];case"uint16":case"ushort":return[e.getUint16(t,a),2];case"int32":case"int":return[e.getInt32(t,a),4];case"uint32":case"uint":return[e.getUint32(t,a),4];case"float32":case"float":return[e.getFloat32(t,a),4];case"float64":case"double":return[e.getFloat64(t,a),8]}}function u(e,t,r,a){for(var n,i={},o=0,s=0;s<r.length;s++)if("list"===r[s].type){var u=[],c=(n=l(e,t+o,r[s].countType,a))[0];o+=n[1];for(var f=0;f<c;f++)n=l(e,t+o,r[s].itemType,a),u.push(n[0]),o+=n[1];i[r[s].name]=u}else n=l(e,t+o,r[s].type,a),i[r[s].name]=n[0],o+=n[1];return[i,o]}var c,f=this;if(t instanceof ArrayBuffer){var d=e.LoaderUtils.decodeText(new Uint8Array(t)),h=r(d);c="ascii"===h.format?i(d,h):function(e,t){for(var r,a={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[]},n="binary_little_endian"===t.format,i=new DataView(e,t.headerLength),l=0,c=0;c<t.elements.length;c++)for(var f=0;f<t.elements[c].count;f++){r=u(i,l,t.elements[c].properties,n),l+=r[1];var d=r[0];s(a,t.elements[c].name,d)}return o(a)}(t,h)}else c=i(t,r(t));return c}}),e.PLYLoader}),e("skylark-threejs-ex/loaders/PRWMLoader",["skylark-threejs"],function(e){return e.PRWMLoader=function(){var t=null;function r(){if(null===t){var e=new ArrayBuffer(2),r=new Uint8Array(e),a=new Uint16Array(e);r[0]=170,r[1]=187,t=43707===a[0]}return t}var a=[null,Float32Array,null,Int8Array,Int16Array,null,Int32Array,Uint8Array,Uint16Array,null,Uint32Array],n={Uint16Array:"getUint16",Uint32Array:"getUint32",Int16Array:"getInt16",Int32Array:"getInt32",Float32Array:"getFloat32",Float64Array:"getFloat64"};function i(e,t,a,i,o){var s,l=t.BYTES_PER_ELEMENT;if(o===r()||1===l)s=new t(e,a,i);else{var u=new DataView(e,a,i*l),c=n[t.name],f=!o,d=0;for(s=new t(i);d<i;d++)s[d]=u[c](d*l,f)}return s}function o(t){e.Loader.call(this,t)}return o.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:o,load:function(t,a,n,i){var o=this,s=new e.FileLoader(o.manager);s.setPath(o.path),s.setResponseType("arraybuffer"),t=t.replace(/\*/g,r()?"be":"le"),s.load(t,function(e){a(o.parse(e))},n,i)},parse:function(t){var r,n,o=function(e){var t=new Uint8Array(e),r=t[0],n=t[1],o=!!(n>>7&1),s=n>>6&1,l=1==(n>>5&1),u=31&n,c=0,f=0;l?(c=(t[2]<<16)+(t[3]<<8)+t[4],f=(t[5]<<16)+(t[6]<<8)+t[7]):(c=t[2]+(t[3]<<8)+(t[4]<<16),f=t[5]+(t[6]<<8)+(t[7]<<16));if(0===r)throw new Error("PRWM decoder: Invalid format version: 0");if(1!==r)throw new Error("PRWM decoder: Unsupported format version: "+r);if(!o){if(0!==s)throw new Error("PRWM decoder: Indices type must be set to 0 for non-indexed geometries");if(0!==f)throw new Error("PRWM decoder: Number of indices must be set to 0 for non-indexed geometries")}var d,h,p,m,v,g,y,x,A=8,b={};for(x=0;x<u;x++){for(d="";A<t.length&&(h=t[A],A++,0!==h);)d+=String.fromCharCode(h);n=t[A],p=n>>7&1,m=1+(n>>4&3),v=a[15&n],A++,A=4*Math.ceil(A/4),g=i(e,v,A,m*c,l),A+=v.BYTES_PER_ELEMENT*m*c,b[d]={type:p,cardinality:m,values:g}}A=4*Math.ceil(A/4),y=null,o&&(y=i(e,1===s?Uint32Array:Uint16Array,A,f,l));return{version:r,attributes:b,indices:y}}(t),s=Object.keys(o.attributes),l=new e.BufferGeometry;for(n=0;n<s.length;n++)r=o.attributes[s[n]],l.setAttribute(s[n],new e.BufferAttribute(r.values,r.cardinality,r.normalized));return null!==o.indices&&l.setIndex(new e.BufferAttribute(o.indices,1)),l}}),o.isBigEndianPlatform=function(){return r()},o}(),e.PRWMLoader}),e("skylark-threejs-ex/loaders/STLLoader",["skylark-threejs"],function(e){return e.STLLoader=function(t){e.Loader.call(this,t)},e.STLLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.STLLoader,load:function(t,r,a,n){var i=this,o=new e.FileLoader(i.manager);o.setPath(i.path),o.setResponseType("arraybuffer"),o.load(t,function(e){try{r(i.parse(e))}catch(e){n&&n(e)}},a,n)},parse:function(t){function r(e,t,r){for(var a=0,n=e.length;a<n;a++)if(e[a]!==t.getUint8(r+a,!1))return!1;return!0}var a=function(e){if("string"==typeof e){for(var t=new Uint8Array(e.length),r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t.buffer||t}return e}(t);return function(e){var t,a;if(a=new DataView(e),50,t=a.getUint32(80,!0),84+50*t===a.byteLength)return!0;for(var n=[115,111,108,105,100],i=0;i<5;i++)if(r(n,a,i))return!1;return!0}(a)?function(t){for(var r,a,n,i,o,s,l,u,c=new DataView(t),f=c.getUint32(80,!0),d=!1,h=0;h<70;h++)1129270351==c.getUint32(h,!1)&&82==c.getUint8(h+4)&&61==c.getUint8(h+5)&&(d=!0,i=new Float32Array(3*f*3),o=c.getUint8(h+6)/255,s=c.getUint8(h+7)/255,l=c.getUint8(h+8)/255,u=c.getUint8(h+9)/255);for(var p=new e.BufferGeometry,m=new Float32Array(3*f*3),v=new Float32Array(3*f*3),g=0;g<f;g++){var y=84+50*g,x=c.getFloat32(y,!0),A=c.getFloat32(y+4,!0),b=c.getFloat32(y+8,!0);if(d){var T=c.getUint16(y+48,!0);0==(32768&T)?(r=(31&T)/31,a=(T>>5&31)/31,n=(T>>10&31)/31):(r=o,a=s,n=l)}for(var w=1;w<=3;w++){var F=y+12*w,_=3*g*3+3*(w-1);m[_]=c.getFloat32(F,!0),m[_+1]=c.getFloat32(F+4,!0),m[_+2]=c.getFloat32(F+8,!0),v[_]=x,v[_+1]=A,v[_+2]=b,d&&(i[_]=r,i[_+1]=a,i[_+2]=n)}}p.setAttribute("position",new e.BufferAttribute(m,3)),p.setAttribute("normal",new e.BufferAttribute(v,3)),d&&(p.setAttribute("color",new e.BufferAttribute(i,3)),p.hasColors=!0,p.alpha=u);return p}(a):function(t){var r,a=new e.BufferGeometry,n=/solid([\s\S]*?)endsolid/g,i=/facet([\s\S]*?)endfacet/g,o=0,s=/[\s]+([+-]?(?:\d*)(?:\.\d*)?(?:[eE][+-]?\d+)?)/.source,l=new RegExp("vertex"+s+s+s,"g"),u=new RegExp("normal"+s+s+s,"g"),c=[],f=[],d=new e.Vector3,h=0,p=0,m=0;for(;null!==(r=n.exec(t));){p=m;for(var v=r[0];null!==(r=i.exec(v));){for(var g=0,y=0,x=r[0];null!==(r=u.exec(x));)d.x=parseFloat(r[1]),d.y=parseFloat(r[2]),d.z=parseFloat(r[3]),y++;for(;null!==(r=l.exec(x));)c.push(parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3])),f.push(d.x,d.y,d.z),g++,m++;1!==y&&console.error("THREE.STLLoader: Something isn't right with the normal of face number "+o),3!==g&&console.error("THREE.STLLoader: Something isn't right with the vertices of face number "+o),o++}var A=p,b=m-p;a.addGroup(A,b,h),h++}return a.setAttribute("position",new e.Float32BufferAttribute(c,3)),a.setAttribute("normal",new e.Float32BufferAttribute(f,3)),a}(function(t){if("string"!=typeof t)return e.LoaderUtils.decodeText(new Uint8Array(t));return t}(t))}}),e.STLLoader}),e("skylark-threejs-ex/loaders/SVGLoader",["skylark-threejs"],function(e){var t,r,a,n,i,o,s,l,u,c,f,d,h,p,m,v,g;return e.SVGLoader=function(t){e.Loader.call(this,t),this.defaultDPI=90,this.defaultUnit="px"},e.SVGLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.SVGLoader,load:function(t,r,a,n){var i=this,o=new e.FileLoader(i.manager);o.setPath(i.path),o.load(t,function(e){r(i.parse(e))},a,n)},parse:function(t){var r=this;function a(e,t,r,a,i,o,s,l){a=a*Math.PI/180,t=Math.abs(t),r=Math.abs(r);var u=(s.x-l.x)/2,c=(s.y-l.y)/2,f=Math.cos(a)*u+Math.sin(a)*c,d=-Math.sin(a)*u+Math.cos(a)*c,h=t*t,p=r*r,m=f*f,v=d*d,g=m/h+v/p;if(g>1){var y=Math.sqrt(g);h=(t*=y)*t,p=(r*=y)*r}var x=h*v+p*m,A=(h*p-x)/x,b=Math.sqrt(Math.max(0,A));i===o&&(b=-b);var T=b*t*d/r,w=-b*r*f/t,F=Math.cos(a)*T-Math.sin(a)*w+(s.x+l.x)/2,_=Math.sin(a)*T+Math.cos(a)*w+(s.y+l.y)/2,E=n(1,0,(f-T)/t,(d-w)/r),L=n((f-T)/t,(d-w)/r,(-f-T)/t,(-d-w)/r)%(2*Math.PI);e.currentPath.absellipse(F,_,t,r,E,E+L,0===o,a)}function n(e,t,r,a){var n=e*r+t*a,i=Math.sqrt(e*e+t*t)*Math.sqrt(r*r+a*a),o=Math.acos(Math.max(-1,Math.min(1,n/i)));return e*a-t*r<0&&(o=-o),o}function i(e,t){function r(r,a,n){void 0===n&&(n=function(e){return e}),e.hasAttribute(r)&&(t[a]=n(e.getAttribute(r))),e.style&&""!==e.style[r]&&(t[a]=n(e.style[r]))}function a(e){return Math.max(0,Math.min(1,c(e)))}function n(e){return Math.max(0,c(e))}return t=Object.assign({},t),r("fill","fill"),r("fill-opacity","fillOpacity",a),r("stroke","stroke"),r("stroke-opacity","strokeOpacity",a),r("stroke-width","strokeWidth",n),r("stroke-linejoin","strokeLineJoin"),r("stroke-linecap","strokeLineCap"),r("stroke-miterlimit","strokeMiterLimit",n),t}function o(e,t){return e-(t-e)}function s(e){for(var t=e.split(/[\s,]+|(?=\s?[+\-])/),r=0;r<t.length;r++){var a=t[r];if(a.indexOf(".")!==a.lastIndexOf("."))for(var n=a.split("."),i=2;i<n.length;i++)t.splice(r+i-1,0,"0."+n[i]);t[r]=c(a)}return t}var l=["mm","cm","in","pt","pc","px"],u={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function c(e){var t="px";if("string"==typeof e||e instanceof String)for(var a=0,n=l.length;a<n;a++){var i=l[a];if(e.endsWith(i)){t=i,e=e.substring(0,e.length-i.length);break}}var o=void 0;return"px"===t&&"px"!==r.defaultUnit?o=u.in[r.defaultUnit]/r.defaultDPI:(o=u[t][r.defaultUnit])<0&&(o=u[t].in*r.defaultDPI),o*parseFloat(e)}function f(t){if(!t.hasAttribute("transform"))return null;var r=function(t){for(var r=new e.Matrix3,a=v,n=t.getAttribute("transform").split(")"),i=n.length-1;i>=0;i--){var o=n[i].trim();if(""!==o){var l=o.indexOf("("),u=o.length;if(l>0&&l<u){var c=o.substr(0,l),f=s(o.substr(l+1,u-l-1));switch(a.identity(),c){case"translate":if(f.length>=1){var d=f[0],h=d;f.length>=2&&(h=f[1]),a.translate(d,h)}break;case"rotate":if(f.length>=1){var p=0,m=0,A=0;p=-f[0]*Math.PI/180,f.length>=3&&(m=f[1],A=f[2]),g.identity().translate(-m,-A),y.identity().rotate(p),x.multiplyMatrices(y,g),g.identity().translate(m,A),a.multiplyMatrices(g,x)}break;case"scale":if(f.length>=1){var b=f[0],T=b;f.length>=2&&(T=f[1]),a.scale(b,T)}break;case"skewX":1===f.length&&a.set(1,Math.tan(f[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===f.length&&a.set(1,0,0,Math.tan(f[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===f.length&&a.set(f[0],f[2],f[4],f[1],f[3],f[5],0,0,1)}}r.premultiply(a)}}return r}(t);return m.length>0&&r.premultiply(m[m.length-1]),T.copy(r),m.push(r),r}function d(e){var t=e.elements;return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function h(e){var t=e.elements;return Math.sqrt(t[3]*t[3]+t[4]*t[4])}var p=[],m=[],v=new e.Matrix3,g=new e.Matrix3,y=new e.Matrix3,x=new e.Matrix3,A=new e.Vector2,b=new e.Vector3,T=new e.Matrix3,w=(new DOMParser).parseFromString(t,"image/svg+xml");!function t(r,n){if(1!==r.nodeType)return;var l=f(r);var u=null;switch(r.nodeName){case"svg":break;case"g":n=i(r,n);break;case"path":n=i(r,n),r.hasAttribute("d")&&(u=function(t){for(var r=new e.ShapePath,n=new e.Vector2,i=new e.Vector2,l=new e.Vector2,u=!0,c=!1,f=t.getAttribute("d").match(/[a-df-z][^a-df-z]*/gi),d=0,h=f.length;d<h;d++){var p=f[d],m=p.charAt(0),v=p.substr(1).trim();switch(!0===u&&(c=!0,u=!1),m){case"M":for(var g=s(v),y=0,x=g.length;y<x;y+=2)n.x=g[y+0],n.y=g[y+1],i.x=n.x,i.y=n.y,0===y?r.moveTo(n.x,n.y):r.lineTo(n.x,n.y),0===y&&!0===c&&l.copy(n);break;case"H":for(var g=s(v),y=0,x=g.length;y<x;y++)n.x=g[y],i.x=n.x,i.y=n.y,r.lineTo(n.x,n.y),0===y&&!0===c&&l.copy(n);break;case"V":for(var g=s(v),y=0,x=g.length;y<x;y++)n.y=g[y],i.x=n.x,i.y=n.y,r.lineTo(n.x,n.y),0===y&&!0===c&&l.copy(n);break;case"L":for(var g=s(v),y=0,x=g.length;y<x;y+=2)n.x=g[y+0],n.y=g[y+1],i.x=n.x,i.y=n.y,r.lineTo(n.x,n.y),0===y&&!0===c&&l.copy(n);break;case"C":for(var g=s(v),y=0,x=g.length;y<x;y+=6)r.bezierCurveTo(g[y+0],g[y+1],g[y+2],g[y+3],g[y+4],g[y+5]),i.x=g[y+2],i.y=g[y+3],n.x=g[y+4],n.y=g[y+5],0===y&&!0===c&&l.copy(n);break;case"S":for(var g=s(v),y=0,x=g.length;y<x;y+=4)r.bezierCurveTo(o(n.x,i.x),o(n.y,i.y),g[y+0],g[y+1],g[y+2],g[y+3]),i.x=g[y+0],i.y=g[y+1],n.x=g[y+2],n.y=g[y+3],0===y&&!0===c&&l.copy(n);break;case"Q":for(var g=s(v),y=0,x=g.length;y<x;y+=4)r.quadraticCurveTo(g[y+0],g[y+1],g[y+2],g[y+3]),i.x=g[y+0],i.y=g[y+1],n.x=g[y+2],n.y=g[y+3],0===y&&!0===c&&l.copy(n);break;case"T":for(var g=s(v),y=0,x=g.length;y<x;y+=2){var A=o(n.x,i.x),b=o(n.y,i.y);r.quadraticCurveTo(A,b,g[y+0],g[y+1]),i.x=A,i.y=b,n.x=g[y+0],n.y=g[y+1],0===y&&!0===c&&l.copy(n)}break;case"A":for(var g=s(v),y=0,x=g.length;y<x;y+=7){var T=n.clone();n.x=g[y+5],n.y=g[y+6],i.x=n.x,i.y=n.y,a(r,g[y],g[y+1],g[y+2],g[y+3],g[y+4],T,n),0===y&&!0===c&&l.copy(n)}break;case"m":for(var g=s(v),y=0,x=g.length;y<x;y+=2)n.x+=g[y+0],n.y+=g[y+1],i.x=n.x,i.y=n.y,0===y?r.moveTo(n.x,n.y):r.lineTo(n.x,n.y),0===y&&!0===c&&l.copy(n);break;case"h":for(var g=s(v),y=0,x=g.length;y<x;y++)n.x+=g[y],i.x=n.x,i.y=n.y,r.lineTo(n.x,n.y),0===y&&!0===c&&l.copy(n);break;case"v":for(var g=s(v),y=0,x=g.length;y<x;y++)n.y+=g[y],i.x=n.x,i.y=n.y,r.lineTo(n.x,n.y),0===y&&!0===c&&l.copy(n);break;case"l":for(var g=s(v),y=0,x=g.length;y<x;y+=2)n.x+=g[y+0],n.y+=g[y+1],i.x=n.x,i.y=n.y,r.lineTo(n.x,n.y),0===y&&!0===c&&l.copy(n);break;case"c":for(var g=s(v),y=0,x=g.length;y<x;y+=6)r.bezierCurveTo(n.x+g[y+0],n.y+g[y+1],n.x+g[y+2],n.y+g[y+3],n.x+g[y+4],n.y+g[y+5]),i.x=n.x+g[y+2],i.y=n.y+g[y+3],n.x+=g[y+4],n.y+=g[y+5],0===y&&!0===c&&l.copy(n);break;case"s":for(var g=s(v),y=0,x=g.length;y<x;y+=4)r.bezierCurveTo(o(n.x,i.x),o(n.y,i.y),n.x+g[y+0],n.y+g[y+1],n.x+g[y+2],n.y+g[y+3]),i.x=n.x+g[y+0],i.y=n.y+g[y+1],n.x+=g[y+2],n.y+=g[y+3],0===y&&!0===c&&l.copy(n);break;case"q":for(var g=s(v),y=0,x=g.length;y<x;y+=4)r.quadraticCurveTo(n.x+g[y+0],n.y+g[y+1],n.x+g[y+2],n.y+g[y+3]),i.x=n.x+g[y+0],i.y=n.y+g[y+1],n.x+=g[y+2],n.y+=g[y+3],0===y&&!0===c&&l.copy(n);break;case"t":for(var g=s(v),y=0,x=g.length;y<x;y+=2){var A=o(n.x,i.x),b=o(n.y,i.y);r.quadraticCurveTo(A,b,n.x+g[y+0],n.y+g[y+1]),i.x=A,i.y=b,n.x=n.x+g[y+0],n.y=n.y+g[y+1],0===y&&!0===c&&l.copy(n)}break;case"a":for(var g=s(v),y=0,x=g.length;y<x;y+=7){var T=n.clone();n.x+=g[y+5],n.y+=g[y+6],i.x=n.x,i.y=n.y,a(r,g[y],g[y+1],g[y+2],g[y+3],g[y+4],T,n),0===y&&!0===c&&l.copy(n)}break;case"Z":case"z":r.currentPath.autoClose=!0,r.currentPath.curves.length>0&&(n.copy(l),r.currentPath.currentPoint.copy(n),u=!0);break;default:console.warn(p)}c=!1}return r}(r));break;case"rect":n=i(r,n),u=function(t){var r=c(t.getAttribute("x")||0),a=c(t.getAttribute("y")||0),n=c(t.getAttribute("rx")||0),i=c(t.getAttribute("ry")||0),o=c(t.getAttribute("width")),s=c(t.getAttribute("height")),l=new e.ShapePath;l.moveTo(r+2*n,a),l.lineTo(r+o-2*n,a),(0!==n||0!==i)&&l.bezierCurveTo(r+o,a,r+o,a,r+o,a+2*i);l.lineTo(r+o,a+s-2*i),(0!==n||0!==i)&&l.bezierCurveTo(r+o,a+s,r+o,a+s,r+o-2*n,a+s);l.lineTo(r+2*n,a+s),(0!==n||0!==i)&&l.bezierCurveTo(r,a+s,r,a+s,r,a+s-2*i);l.lineTo(r,a+2*i),(0!==n||0!==i)&&l.bezierCurveTo(r,a,r,a,r+2*n,a);return l}(r);break;case"polygon":n=i(r,n),u=function(t){var r=new e.ShapePath,a=0;return t.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,function(e,t,n){var i=c(t),o=c(n);0===a?r.moveTo(i,o):r.lineTo(i,o),a++}),r.currentPath.autoClose=!0,r}(r);break;case"polyline":n=i(r,n),u=function(t){var r=new e.ShapePath,a=0;return t.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,function(e,t,n){var i=c(t),o=c(n);0===a?r.moveTo(i,o):r.lineTo(i,o),a++}),r.currentPath.autoClose=!1,r}(r);break;case"circle":n=i(r,n),u=function(t){var r=c(t.getAttribute("cx")),a=c(t.getAttribute("cy")),n=c(t.getAttribute("r")),i=new e.Path;i.absarc(r,a,n,0,2*Math.PI);var o=new e.ShapePath;return o.subPaths.push(i),o}(r);break;case"ellipse":n=i(r,n),u=function(t){var r=c(t.getAttribute("cx")),a=c(t.getAttribute("cy")),n=c(t.getAttribute("rx")),i=c(t.getAttribute("ry")),o=new e.Path;o.absellipse(r,a,n,i,0,2*Math.PI);var s=new e.ShapePath;return s.subPaths.push(o),s}(r);break;case"line":n=i(r,n),u=function(t){var r=c(t.getAttribute("x1")),a=c(t.getAttribute("y1")),n=c(t.getAttribute("x2")),i=c(t.getAttribute("y2")),o=new e.ShapePath;return o.moveTo(r,a),o.lineTo(n,i),o.currentPath.autoClose=!1,o}(r);break;default:console.log(r)}u&&(void 0!==n.fill&&"none"!==n.fill&&u.color.setStyle(n.fill),function(e,t){function r(e){b.set(e.x,e.y,1).applyMatrix3(t),e.set(b.x,b.y)}for(var a=function(e){return 0!==e.elements[1]||0!==e.elements[3]}(t),n=e.subPaths,i=0,o=n.length;i<o;i++)for(var s=n[i],l=s.curves,u=0;u<l.length;u++){var c=l[u];c.isLineCurve?(r(c.v1),r(c.v2)):c.isCubicBezierCurve?(r(c.v0),r(c.v1),r(c.v2),r(c.v3)):c.isQuadraticBezierCurve?(r(c.v0),r(c.v1),r(c.v2)):c.isEllipseCurve&&(a&&console.warn("SVGLoader: Elliptic arc or ellipse rotation or skewing is not implemented."),A.set(c.aX,c.aY),r(A),c.aX=A.x,c.aY=A.y,c.xRadius*=d(t),c.yRadius*=h(t))}}(u,T),p.push(u),u.userData={node:r,style:n});var v=r.childNodes;for(var g=0;g<v.length;g++)t(v[g],n);l&&(m.pop(),m.length>0?T.copy(m[m.length-1]):T.identity())}(w.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4});var F={paths:p,xml:w.documentElement};return F}}),e.SVGLoader.getStrokeStyle=function(e,t,r,a,n){return e=void 0!==e?e:1,{strokeColor:t=void 0!==t?t:"#000",strokeWidth:e,strokeLineJoin:r=void 0!==r?r:"miter",strokeLineCap:a=void 0!==a?a:"butt",strokeMiterLimit:n=void 0!==n?n:4}},e.SVGLoader.pointsToStroke=function(t,r,a,n){var i=[],o=[],s=[];if(0===e.SVGLoader.pointsToStrokeWithBuffers(t,r,a,n,i,o,s))return null;var l=new e.BufferGeometry;return l.setAttribute("position",new e.Float32BufferAttribute(i,3)),l.setAttribute("normal",new e.Float32BufferAttribute(o,3)),l.setAttribute("uv",new e.Float32BufferAttribute(s,2)),l},e.SVGLoader.pointsToStrokeWithBuffers=(t=new e.Vector2,r=new e.Vector2,a=new e.Vector2,n=new e.Vector2,i=new e.Vector2,o=new e.Vector2,s=new e.Vector2,l=new e.Vector2,u=new e.Vector2,c=new e.Vector2,f=new e.Vector2,d=new e.Vector2,h=new e.Vector2,p=new e.Vector2,m=new e.Vector2,v=new e.Vector2,g=new e.Vector2,function(e,y,x,A,b,T,w,F){x=void 0!==x?x:12,A=void 0!==A?A:.001,F=void 0!==F?F:0;var _=(e=function(e){for(var t=!1,r=1,a=e.length-1;r<a;r++)if(e[r].distanceTo(e[r+1])<A){t=!0;break}if(!t)return e;var n=[];n.push(e[0]);for(var r=1,a=e.length-1;r<a;r++)e[r].distanceTo(e[r+1])>=A&&n.push(e[r]);return n.push(e[e.length-1]),n}(e)).length;if(_<2)return 0;var E,L,S,M,P,N=e[0].equals(e[_-1]),I=e[0],k=y.strokeWidth/2,R=1/(_-1),C=0,U=!1,O=0,D=3*F,B=2*F;$(e[0],e[1],t).multiplyScalar(k),l.copy(e[0]).sub(t),u.copy(e[0]).add(t),c.copy(l),f.copy(u);for(var j=1;j<_;j++){E=e[j],L=j===_-1?N?e[1]:void 0:e[j+1];var G=t;$(I,E,G),a.copy(G).multiplyScalar(k),d.copy(E).sub(a),h.copy(E).add(a);var V=C+R;if(S=!1,void 0!==L){$(E,L,r),a.copy(r).multiplyScalar(k),p.copy(E).sub(a),m.copy(E).add(a),M=!0,a.subVectors(L,I),G.dot(a)<0&&(M=!1),1===j&&(U=M),a.subVectors(L,E),a.normalize();var X=Math.abs(G.dot(a));if(0!==X){var H=k/X;a.multiplyScalar(-H),n.subVectors(E,I),i.copy(n).setLength(H).add(a),v.copy(i).negate();var z=i.length(),Y=n.length();n.divideScalar(Y),o.subVectors(L,E);var Q=o.length();switch(o.divideScalar(Q),n.dot(v)<Y&&o.dot(v)<Q&&(S=!0),g.copy(i).add(E),v.add(E),P=!1,S?M?(m.copy(v),h.copy(v)):(p.copy(v),d.copy(v)):ee(),y.strokeLineJoin){case"bevel":te(M,S,V);break;case"round":re(M,S),M?J(E,d,p,V,0):J(E,m,h,V,1);break;case"miter":case"miter-clip":default:var W=k*y.strokeMiterLimit/z;if(W<1){if("miter-clip"!==y.strokeLineJoin){te(M,S,V);break}re(M,S),M?(o.subVectors(g,d).multiplyScalar(W).add(d),s.subVectors(g,p).multiplyScalar(W).add(p),Z(d,V,0),Z(o,V,0),Z(E,V,.5),Z(E,V,.5),Z(o,V,0),Z(s,V,0),Z(E,V,.5),Z(s,V,0),Z(p,V,0)):(o.subVectors(g,h).multiplyScalar(W).add(h),s.subVectors(g,m).multiplyScalar(W).add(m),Z(h,V,1),Z(o,V,1),Z(E,V,.5),Z(E,V,.5),Z(o,V,1),Z(s,V,1),Z(E,V,.5),Z(s,V,1),Z(m,V,1))}else S?(M?(Z(u,C,1),Z(l,C,0),Z(g,V,0),Z(u,C,1),Z(g,V,0),Z(v,V,1)):(Z(u,C,1),Z(l,C,0),Z(g,V,1),Z(l,C,0),Z(v,V,0),Z(g,V,1)),M?p.copy(g):m.copy(g)):M?(Z(d,V,0),Z(g,V,0),Z(E,V,.5),Z(E,V,.5),Z(g,V,0),Z(p,V,0)):(Z(h,V,1),Z(g,V,1),Z(E,V,.5),Z(E,V,.5),Z(g,V,1),Z(m,V,1)),P=!0}}else ee()}else ee();N||j!==_-1||ae(e[0],c,f,M,!0,C),C=V,I=E,l.copy(p),u.copy(m)}if(N){if(S&&b){var K=g,q=v;U!==M&&(K=v,q=g),M?(P||U)&&(q.toArray(b,0),q.toArray(b,9),P&&K.toArray(b,3)):!P&&U||(q.toArray(b,3),q.toArray(b,9),P&&K.toArray(b,0))}}else ae(E,d,h,M,!1,V);return O;function $(e,t,r){return r.subVectors(t,e),r.set(-r.y,r.x).normalize()}function Z(e,t,r){b&&(b[D]=e.x,b[D+1]=e.y,b[D+2]=0,T&&(T[D]=0,T[D+1]=0,T[D+2]=1),D+=3,w&&(w[B]=t,w[B+1]=r,B+=2)),O+=3}function J(e,i,o,s,l){t.copy(i).sub(e).normalize(),r.copy(o).sub(e).normalize();var u=Math.PI,c=t.dot(r);Math.abs(c)<1&&(u=Math.abs(Math.acos(c))),u/=x,a.copy(i);for(var f=0,d=x-1;f<d;f++)n.copy(a).rotateAround(e,u),Z(a,s,l),Z(n,s,l),Z(e,s,.5),a.copy(n);Z(n,s,l),Z(o,s,l),Z(e,s,.5)}function ee(){Z(u,C,1),Z(l,C,0),Z(d,V,0),Z(u,C,1),Z(d,V,1),Z(h,V,0)}function te(e,t,r){t?e?(Z(u,C,1),Z(l,C,0),Z(d,V,0),Z(u,C,1),Z(d,V,0),Z(v,V,1),Z(d,r,0),Z(p,r,0),Z(v,r,.5)):(Z(u,C,1),Z(l,C,0),Z(h,V,1),Z(l,C,0),Z(v,V,0),Z(h,V,1),Z(h,r,1),Z(m,r,0),Z(v,r,.5)):e?(Z(d,r,0),Z(p,r,0),Z(E,r,.5)):(Z(h,r,1),Z(m,r,0),Z(E,r,.5))}function re(e,t){t&&(e?(Z(u,C,1),Z(l,C,0),Z(d,V,0),Z(u,C,1),Z(d,V,0),Z(v,V,1),Z(d,C,0),Z(E,V,.5),Z(v,V,1),Z(E,V,.5),Z(p,C,0),Z(v,V,1)):(Z(u,C,1),Z(l,C,0),Z(h,V,1),Z(l,C,0),Z(v,V,0),Z(h,V,1),Z(h,C,1),Z(v,V,0),Z(E,V,.5),Z(E,V,.5),Z(v,V,0),Z(m,C,1)))}function ae(e,i,o,s,l,u){switch(y.strokeLineCap){case"round":l?J(e,o,i,u,.5):J(e,i,o,u,.5);break;case"square":if(l)t.subVectors(i,e),r.set(t.y,-t.x),a.addVectors(t,r).add(e),n.subVectors(r,t).add(e),s?(a.toArray(b,3),n.toArray(b,0),n.toArray(b,9)):(a.toArray(b,3),a.toArray(b,9),n.toArray(b,0));else{t.subVectors(o,e),r.set(t.y,-t.x),a.addVectors(t,r).add(e),n.subVectors(r,t).add(e);var c=b.length;s?(a.toArray(b,c-3),n.toArray(b,c-6),n.toArray(b,c-12)):(a.toArray(b,c-6),n.toArray(b,c-3),n.toArray(b,c-12))}}}}),e.SVGLoader}),e("skylark-threejs-ex/loaders/TDSLoader",["skylark-threejs"],function(e){e.TDSLoader=function(t){e.Loader.call(this,t),this.debug=!1,this.group=null,this.position=0,this.materials=[],this.meshes=[]},e.TDSLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.TDSLoader,load:function(t,r,a,n){var i=this,o=""===i.path?e.LoaderUtils.extractUrlBase(t):i.path,s=new e.FileLoader(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.load(t,function(e){r(i.parse(e,o))},a,n)},parse:function(t,r){this.group=new e.Group,this.position=0,this.materials=[],this.meshes=[],this.readFile(t,r);for(var a=0;a<this.meshes.length;a++)this.group.add(this.meshes[a]);return this.group},readFile:function(e,i){var o=new DataView(e),s=this.readChunk(o);if(s.id===r||s.id===a||s.id===t)for(var l=this.nextChunk(o,s);0!==l;){if(l===n){var c=this.readDWord(o);this.debugMessage("3DS file version: "+c)}else l===u?(this.resetPosition(o),this.readMeshData(o,i)):this.debugMessage("Unknown main chunk: "+l.toString(16));l=this.nextChunk(o,s)}this.debugMessage("Parsed "+this.meshes.length+" meshes")},readMeshData:function(e,t){for(var r=this.readChunk(e),a=this.nextChunk(e,r);0!==a;){if(a===c){var n=+this.readDWord(e);this.debugMessage("Mesh Version: "+n)}else if(a===f){var i=this.readFloat(e);this.debugMessage("Master scale: "+i),this.group.scale.set(i,i,i)}else a===I?(this.debugMessage("Named Object"),this.resetPosition(e),this.readNamedObject(e)):a===d?(this.debugMessage("Material"),this.resetPosition(e),this.readMaterialEntry(e,t)):this.debugMessage("Unknown MDATA chunk: "+a.toString(16));a=this.nextChunk(e,r)}},readNamedObject:function(e){var t=this.readChunk(e),r=this.readString(e,64);t.cur=this.position;for(var a=this.nextChunk(e,t);0!==a;){if(a===k){this.resetPosition(e);var n=this.readMesh(e);n.name=r,this.meshes.push(n)}else this.debugMessage("Unknown named object chunk: "+a.toString(16));a=this.nextChunk(e,t)}this.endChunk(t)},readMaterialEntry:function(t,r){for(var a=this.readChunk(t),n=this.nextChunk(t,a),i=new e.MeshPhongMaterial;0!==n;){if(n===h)i.name=this.readString(t,64),this.debugMessage("   Name: "+i.name);else if(n===b)this.debugMessage("   Wireframe"),i.wireframe=!0;else if(n===T){var o=this.readByte(t);i.wireframeLinewidth=o,this.debugMessage("   Wireframe Thickness: "+o)}else if(n===x)i.side=e.DoubleSide,this.debugMessage("   DoubleSided");else if(n===A)this.debugMessage("   Additive Blending"),i.blending=e.AdditiveBlending;else if(n===m)this.debugMessage("   Diffuse Color"),i.color=this.readColor(t);else if(n===v)this.debugMessage("   Specular Color"),i.specular=this.readColor(t);else if(n===p)this.debugMessage("   Ambient color"),i.color=this.readColor(t);else if(n===g){var s=this.readWord(t);i.shininess=s,this.debugMessage("   Shininess : "+s)}else if(n===y){var l=this.readWord(t);i.opacity=.01*l,this.debugMessage("  Opacity : "+l),i.transparent=l<100}else n===w?(this.debugMessage("   ColorMap"),this.resetPosition(t),i.map=this.readMap(t,r)):n===_?(this.debugMessage("   BumpMap"),this.resetPosition(t),i.bumpMap=this.readMap(t,r)):n===F?(this.debugMessage("   OpacityMap"),this.resetPosition(t),i.alphaMap=this.readMap(t,r)):n===E?(this.debugMessage("   SpecularMap"),this.resetPosition(t),i.specularMap=this.readMap(t,r)):this.debugMessage("   Unknown material chunk: "+n.toString(16));n=this.nextChunk(t,a)}this.endChunk(a),this.materials[i.name]=i},readMesh:function(t){var r=this.readChunk(t),a=this.nextChunk(t,r),n=new e.BufferGeometry,i=[],o=new e.MeshPhongMaterial,s=new e.Mesh(n,o);for(s.name="mesh";0!==a;){if(a===R){var l=this.readWord(t);this.debugMessage("   Vertex: "+l);for(var u=[],c=0;c<l;c++)u.push(this.readFloat(t)),u.push(this.readFloat(t)),u.push(this.readFloat(t));n.setAttribute("position",new e.Float32BufferAttribute(u,3))}else if(a===C)this.resetPosition(t),this.readFaceArray(t,s);else if(a===O){var f=this.readWord(t);this.debugMessage("   UV: "+f);for(var i=[],c=0;c<f;c++)i.push(this.readFloat(t)),i.push(this.readFloat(t));n.setAttribute("uv",new e.Float32BufferAttribute(i,2))}else if(a===D){this.debugMessage("   Tranformation Matrix (TODO)");for(var d=[],c=0;c<12;c++)d[c]=this.readFloat(t);var h=new e.Matrix4;h.elements[0]=d[0],h.elements[1]=d[6],h.elements[2]=d[3],h.elements[3]=d[9],h.elements[4]=d[2],h.elements[5]=d[8],h.elements[6]=d[5],h.elements[7]=d[11],h.elements[8]=d[1],h.elements[9]=d[7],h.elements[10]=d[4],h.elements[11]=d[10],h.elements[12]=0,h.elements[13]=0,h.elements[14]=0,h.elements[15]=1,h.transpose();var p=new e.Matrix4;p.getInverse(h),n.applyMatrix4(p),h.decompose(s.position,s.quaternion,s.scale)}else this.debugMessage("   Unknown mesh chunk: "+a.toString(16));a=this.nextChunk(t,r)}return this.endChunk(r),n.computeVertexNormals(),s},readFaceArray:function(e,t){var r=this.readChunk(e),a=this.readWord(e);this.debugMessage("   Faces: "+a);for(var n=[],i=0;i<a;++i)n.push(this.readWord(e),this.readWord(e),this.readWord(e)),this.readWord(e);for(t.geometry.setIndex(n);this.position<r.end;){var r=this.readChunk(e);if(r.id===U){this.debugMessage("      Material Group"),this.resetPosition(e);var o=this.readMaterialGroup(e),s=this.materials[o.name];void 0!==s&&(t.material=s,""===s.name&&(s.name=t.name))}else this.debugMessage("      Unknown face array chunk: "+r.toString(16));this.endChunk(r)}this.endChunk(r)},readMap:function(t,r){var a=this.readChunk(t),n=this.nextChunk(t,a),i={},o=new e.TextureLoader(this.manager);for(o.setPath(this.resourcePath||r).setCrossOrigin(this.crossOrigin);0!==n;){if(n===L){var s=this.readString(t,128);i=o.load(s),this.debugMessage("      File: "+r+s)}else n===P?(i.offset.x=this.readFloat(t),this.debugMessage("      OffsetX: "+i.offset.x)):n===N?(i.offset.y=this.readFloat(t),this.debugMessage("      OffsetY: "+i.offset.y)):n===S?(i.repeat.x=this.readFloat(t),this.debugMessage("      RepeatX: "+i.repeat.x)):n===M?(i.repeat.y=this.readFloat(t),this.debugMessage("      RepeatY: "+i.repeat.y)):this.debugMessage("      Unknown map chunk: "+n.toString(16));n=this.nextChunk(t,a)}return this.endChunk(a),i},readMaterialGroup:function(e){this.readChunk(e);var t=this.readString(e,64),r=this.readWord(e);this.debugMessage("         Name: "+t),this.debugMessage("         Faces: "+r);for(var a=[],n=0;n<r;++n)a.push(this.readWord(e));return{name:t,index:a}},readColor:function(t){var r=this.readChunk(t),a=new e.Color;if(r.id===o||r.id===s){var n=this.readByte(t),u=this.readByte(t),c=this.readByte(t);a.setRGB(n/255,u/255,c/255),this.debugMessage("      Color: "+a.r+", "+a.g+", "+a.b)}else if(r.id===i||r.id===l){var n=this.readFloat(t),u=this.readFloat(t),c=this.readFloat(t);a.setRGB(n,u,c),this.debugMessage("      Color: "+a.r+", "+a.g+", "+a.b)}else this.debugMessage("      Unknown color chunk: "+r.toString(16));return this.endChunk(r),a},readChunk:function(e){var t={};return t.cur=this.position,t.id=this.readWord(e),t.size=this.readDWord(e),t.end=t.cur+t.size,t.cur+=6,t},endChunk:function(e){this.position=e.end},nextChunk:function(e,t){if(t.cur>=t.end)return 0;this.position=t.cur;try{var r=this.readChunk(e);return t.cur+=r.size,r.id}catch(e){return this.debugMessage("Unable to read chunk at "+this.position),0}},resetPosition:function(){this.position-=6},readByte:function(e){var t=e.getUint8(this.position,!0);return this.position+=1,t},readFloat:function(e){try{var t=e.getFloat32(this.position,!0);return this.position+=4,t}catch(t){this.debugMessage(t+" "+this.position+" "+e.byteLength)}},readInt:function(e){var t=e.getInt32(this.position,!0);return this.position+=4,t},readShort:function(e){var t=e.getInt16(this.position,!0);return this.position+=2,t},readDWord:function(e){var t=e.getUint32(this.position,!0);return this.position+=4,t},readWord:function(e){var t=e.getUint16(this.position,!0);return this.position+=2,t},readString:function(e,t){for(var r="",a=0;a<t;a++){var n=this.readByte(e);if(!n)break;r+=String.fromCharCode(n)}return r},debugMessage:function(e){this.debug&&console.log(e)}});var t=19789,r=15786,a=49725,n=2,i=16,o=17,s=18,l=19,u=15677,c=15678,f=256,d=45055,h=40960,p=40976,m=40992,v=41008,g=41024,y=41040,x=41089,A=41091,b=41093,T=41095,w=41472,F=41488,_=41520,E=41476,L=41728,S=41812,M=41814,P=41816,N=41818,I=16384,k=16640,R=16656,C=16672,U=16688,O=16704,D=16736;return e.TDSLoader}),e("skylark-threejs-ex/loaders/VTKLoader",["skylark-threejs"],function(e,t){return e.VTKLoader=function(t){e.Loader.call(this,t)},e.VTKLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.VTKLoader,load:function(t,r,a,n){var i=this,o=new e.FileLoader(i.manager);o.setPath(i.path),o.setResponseType("arraybuffer"),o.load(t,function(e){r(i.parse(e))},a,n)},parse:function(r){function a(e,t){var r=e.length,a=new Float32Array(r+t.length);return a.set(e),a.set(t,r),a}function n(e,t){var r=e.length,a=new Int32Array(r+t.length);return a.set(e),a.set(t,r),a}function i(e){for(var t="",r=new Uint8Array(e),a=0,n=r.length;n--;)t+=String.fromCharCode(r[a++]);return t}var o=e.LoaderUtils.decodeText(new Uint8Array(r,0,250)).split("\n");return-1!==o[0].indexOf("xml")?function(r){function i(e){var t,r,a,n,i,o,s="undefined"!=typeof Uint8Array?Uint8Array:Array,l=[],u=[],c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",f=c.length;for(t=0;t<f;t++)l[t]=c[t];for(t=0;t<f;++t)u[c.charCodeAt(t)]=t;u["-".charCodeAt(0)]=62,u["_".charCodeAt(0)]=63;var f=e.length;if(f%4>0)throw new Error("Invalid string. Length must be a multiple of 4");i="="===e[f-2]?2:"="===e[f-1]?1:0,o=new s(3*f/4-i),a=i>0?f-4:f;var d=0;for(t=0,r=0;t<a;t+=4,r+=3)n=u[e.charCodeAt(t)]<<18|u[e.charCodeAt(t+1)]<<12|u[e.charCodeAt(t+2)]<<6|u[e.charCodeAt(t+3)],o[d++]=(16711680&n)>>16,o[d++]=(65280&n)>>8,o[d++]=255&n;return 2===i?(n=u[e.charCodeAt(t)]<<2|u[e.charCodeAt(t+1)]>>4,o[d++]=255&n):1===i&&(n=u[e.charCodeAt(t)]<<10|u[e.charCodeAt(t+1)]<<4|u[e.charCodeAt(t+2)]>>2,o[d++]=n>>8&255,o[d++]=255&n),o}function o(e,r){var o=0;if("UInt64"===l.attributes.header_type?o=8:"UInt32"===l.attributes.header_type&&(o=4),"binary"===e.attributes.format&&r){var s,u,c,f,d,h,p;if("Float32"===e.attributes.type)var m=new Float32Array;else if("Int64"===e.attributes.type)var m=new Int32Array;s=e["#text"],u=i(s),c=u[0];for(var v=1;v<o-1;v++)c|=u[v]<<v*o;d=(c+3)*o,p=d+=d%3>0?3-d%3:0,(h=[]).push(p),f=3*o;for(var v=0;v<c;v++){for(var g=u[v*o+f],y=1;y<o-1;y++)g|=u[v*o+f+y]<<8*y;p+=g,h.push(p)}for(var v=0;v<h.length-1;v++){var x=new t.Inflate(u.slice(h[v],h[v+1]),{resize:!0,verify:!0});A=(A=x.decompress()).buffer,"Float32"===e.attributes.type?(A=new Float32Array(A),m=a(m,A)):"Int64"===e.attributes.type&&(A=new Int32Array(A),m=n(m,A))}delete e["#text"],"Int64"===e.attributes.type&&"binary"===e.attributes.format&&(m=m.filter(function(e,t){if(t%2!=1)return!0}))}else{if("binary"!==e.attributes.format||r)if(e["#text"])var A=e["#text"].split(/\s+/).filter(function(e){if(""!==e)return e});else var A=new Int32Array(0).buffer;else{var A=i(e["#text"]);A=A.slice(o).buffer}if(delete e["#text"],"Float32"===e.attributes.type)var m=new Float32Array(A);else if("Int32"===e.attributes.type)var m=new Int32Array(A);else if("Int64"===e.attributes.type){var m=new Int32Array(A);"binary"===e.attributes.format&&(m=m.filter(function(e,t){if(t%2!=1)return!0}))}}return m}var s=null;if(window.DOMParser)try{s=(new DOMParser).parseFromString(r,"text/xml")}catch(e){s=null}else{if(!window.ActiveXObject)throw new Error("Cannot parse xml string!");try{if((s=new ActiveXObject("Microsoft.XMLDOM")).async=!1,!s.loadXML())throw new Error(s.parseError.reason+s.parseError.srcText)}catch(e){s=null}}var l=function e(t){var r={};if(1===t.nodeType){if(t.attributes&&t.attributes.length>0){r.attributes={};for(var a=0;a<t.attributes.length;a++){var n=t.attributes.item(a);r.attributes[n.nodeName]=n.nodeValue.trim()}}}else 3===t.nodeType&&(r=t.nodeValue.trim());if(t.hasChildNodes())for(var i=0;i<t.childNodes.length;i++){var o=t.childNodes.item(i),s=o.nodeName;if(void 0===r[s]){var l=e(o);""!==l&&(r[s]=l)}else{if(void 0===r[s].push){var u=r[s];r[s]=[u]}var l=e(o);""!==l&&r[s].push(l)}}return r}(s.documentElement),u=[],c=[],f=[];if(l.PolyData){for(var d=l.PolyData.Piece,h=l.attributes.hasOwnProperty("compressor"),p=["PointData","Points","Strips","Polys"],m=0,v=p.length;m<v;){var g=d[p[m]];if(g&&g.DataArray){if("[object Array]"===Object.prototype.toString.call(g.DataArray))var y=g.DataArray;else var y=[g.DataArray];for(var x=0,A=y.length;x<A;)"#text"in y[x]&&y[x]["#text"].length>0&&(y[x].text=o(y[x],h)),x++;switch(p[m]){case"PointData":var b=parseInt(d.attributes.NumberOfPoints),T=g.attributes.Normals;if(b>0)for(var w=0,F=y.length;w<F;w++)if(T===y[w].attributes.Name){var _=y[w].attributes.NumberOfComponents;(c=new Float32Array(b*_)).set(y[w].text,0)}break;case"Points":var b=parseInt(d.attributes.NumberOfPoints);if(b>0){var _=g.DataArray.attributes.NumberOfComponents;(u=new Float32Array(b*_)).set(g.DataArray.text,0)}break;case"Strips":var E=parseInt(d.attributes.NumberOfStrips);if(E>0){var L=new Int32Array(g.DataArray[0].text.length),S=new Int32Array(g.DataArray[1].text.length);L.set(g.DataArray[0].text,0),S.set(g.DataArray[1].text,0);var M=E+L.length;f=new Uint32Array(3*M-9*E);for(var P=0,w=0,F=E;w<F;w++){for(var N=[],I=0,k=S[w],R=0;I<k-R;I++)N.push(L[I]),w>0&&(R=S[w-1]);for(var C=0,k=S[w],R=0;C<k-R-2;C++)C%2?(f[P++]=N[C],f[P++]=N[C+2],f[P++]=N[C+1]):(f[P++]=N[C],f[P++]=N[C+1],f[P++]=N[C+2]),w>0&&(R=S[w-1])}}break;case"Polys":var U=parseInt(d.attributes.NumberOfPolys);if(U>0){var L=new Int32Array(g.DataArray[0].text.length),S=new Int32Array(g.DataArray[1].text.length);L.set(g.DataArray[0].text,0),S.set(g.DataArray[1].text,0);var M=U+L.length;f=new Uint32Array(3*M-9*U);for(var P=0,O=0,w=0,F=U,R=0;w<F;){for(var D=[],I=0,k=S[w];I<k-R;)D.push(L[O++]),I++;for(var C=1;C<k-R-1;)f[P++]=D[0],f[P++]=D[C],f[P++]=D[C+1],C++;R=S[++w-1]}}}}m++}var B=new e.BufferGeometry;return B.setIndex(new e.BufferAttribute(f,1)),B.setAttribute("position",new e.BufferAttribute(u,3)),c.length===u.length&&B.setAttribute("normal",new e.BufferAttribute(c,3)),B}throw new Error("Unsupported DATASET type")}(i(r)):o[2].includes("ASCII")?function(t){var r,a=[],n=[],i=[],o=[],s=/^[^\d.\s-]+/,l=/(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)/g,u=/^(\d+)\s+([\s\d]*)/,c=/^POINTS /,f=/^POLYGONS /,d=/^TRIANGLE_STRIPS /,h=/^POINT_DATA[ ]+(\d+)/,p=/^CELL_DATA[ ]+(\d+)/,m=/^COLOR_SCALARS[ ]+(\w+)[ ]+3/,v=/^NORMALS[ ]+(\w+)[ ]+(\w+)/,g=!1,y=!1,x=!1,A=!1,b=!1,T=!1,w=!1,F=t.split("\n");for(var _ in F){var E=F[_].trim();if(0===E.indexOf("DATASET")){var L=E.split(" ")[1];if("POLYDATA"!==L)throw new Error("Unsupported DATASET type: "+L)}else if(g)for(;null!==(r=l.exec(E))&&null===s.exec(E);){var S=parseFloat(r[1]),M=parseFloat(r[2]),P=parseFloat(r[3]);n.push(S,M,P)}else if(y){if(null!==(r=u.exec(E))){var N=parseInt(r[1]),I=r[2].split(/\s+/);if(N>=3)for(var k=parseInt(I[0]),R=1,C=0;C<N-2;++C)U=parseInt(I[R]),O=parseInt(I[R+1]),a.push(k,U,O),R++}}else if(x){if(null!==(r=u.exec(E))){var N=parseInt(r[1]),I=r[2].split(/\s+/);if(N>=3)for(var U,O,C=0;C<N-2;C++)C%2==1?(k=parseInt(I[C]),U=parseInt(I[C+2]),O=parseInt(I[C+1]),a.push(k,U,O)):(k=parseInt(I[C]),U=parseInt(I[C+1]),O=parseInt(I[C+2]),a.push(k,U,O))}}else if(A||b)if(T)for(;null!==(r=l.exec(E))&&null===s.exec(E);){var D=parseFloat(r[1]),B=parseFloat(r[2]),j=parseFloat(r[3]);i.push(D,B,j)}else if(w)for(;null!==(r=l.exec(E))&&null===s.exec(E);){var G=parseFloat(r[1]),V=parseFloat(r[2]),X=parseFloat(r[3]);o.push(G,V,X)}null!==f.exec(E)?(y=!0,g=!1,x=!1):null!==c.exec(E)?(y=!1,g=!0,x=!1):null!==d.exec(E)?(y=!1,g=!1,x=!0):null!==h.exec(E)?(A=!0,g=!1,y=!1,x=!1):null!==p.exec(E)?(b=!0,g=!1,y=!1,x=!1):null!==m.exec(E)?(T=!0,w=!1,g=!1,y=!1,x=!1):null!==v.exec(E)&&(w=!0,T=!1,g=!1,y=!1,x=!1)}var H=new e.BufferGeometry;H.setIndex(a),H.setAttribute("position",new e.Float32BufferAttribute(n,3)),o.length===n.length&&H.setAttribute("normal",new e.Float32BufferAttribute(o,3));if(i.length!==a.length)i.length===n.length&&H.setAttribute("color",new e.Float32BufferAttribute(i,3));else{var z=(H=H.toNonIndexed()).attributes.position.count/3;if(i.length===3*z){for(var Y=[],_=0;_<z;_++){var D=i[3*_+0],B=i[3*_+1],j=i[3*_+2];Y.push(D,B,j),Y.push(D,B,j),Y.push(D,B,j)}H.setAttribute("color",new e.Float32BufferAttribute(Y,3))}}return H}(i(r)):function(t){var r,a,n,i,o,s,l,u=new Uint8Array(t),c=new DataView(t),f=[],d=[],h=[],p=[],m=0;function v(e,t){for(var r=t,a=e[r],n=[];10!==a;)n.push(String.fromCharCode(a)),a=e[++r];return{start:t,end:r,next:r+1,parsedString:n.join("")}}for(;;){if(s=v(u,m),0===(l=s.parsedString).indexOf("DATASET")){var g=l.split(" ")[1];if("POLYDATA"!==g)throw new Error("Unsupported DATASET type: "+g)}else if(0===l.indexOf("POINTS")){for(p.push(l),i=parseInt(l.split(" ")[1],10),r=4*i*3,f=new Float32Array(3*i),a=s.next,n=0;n<i;n++)f[3*n]=c.getFloat32(a,!1),f[3*n+1]=c.getFloat32(a+4,!1),f[3*n+2]=c.getFloat32(a+8,!1),a+=12;s.next=s.next+r+1}else if(0===l.indexOf("TRIANGLE_STRIPS")){var y=parseInt(l.split(" ")[1],10),x=parseInt(l.split(" ")[2],10);r=4*x,h=new Uint32Array(3*x-9*y);var A=0;for(a=s.next,n=0;n<y;n++){var b=c.getInt32(a,!1),T=[];for(a+=4,o=0;o<b;o++)T.push(c.getInt32(a,!1)),a+=4;for(var w=0;w<b-2;w++)w%2?(h[A++]=T[w],h[A++]=T[w+2],h[A++]=T[w+1]):(h[A++]=T[w],h[A++]=T[w+1],h[A++]=T[w+2])}s.next=s.next+r+1}else if(0===l.indexOf("POLYGONS")){var y=parseInt(l.split(" ")[1],10),x=parseInt(l.split(" ")[2],10);r=4*x,h=new Uint32Array(3*x-9*y);var A=0;for(a=s.next,n=0;n<y;n++){var b=c.getInt32(a,!1),T=[];for(a+=4,o=0;o<b;o++)T.push(c.getInt32(a,!1)),a+=4;for(var w=1;w<b-1;w++)h[A++]=T[0],h[A++]=T[w],h[A++]=T[w+1]}s.next=s.next+r+1}else if(0===l.indexOf("POINT_DATA")){for(i=parseInt(l.split(" ")[1],10),s=v(u,s.next),r=4*i*3,d=new Float32Array(3*i),a=s.next,n=0;n<i;n++)d[3*n]=c.getFloat32(a,!1),d[3*n+1]=c.getFloat32(a+4,!1),d[3*n+2]=c.getFloat32(a+8,!1),a+=12;s.next=s.next+r}if((m=s.next)>=u.byteLength)break}var F=new e.BufferGeometry;F.setIndex(new e.BufferAttribute(h,1)),F.setAttribute("position",new e.BufferAttribute(f,3)),d.length===f.length&&F.setAttribute("normal",new e.BufferAttribute(d,3));return F}(r)}}),e.VTKLoader}),e("skylark-threejs-ex/loaders/XLoader",["skylark-threejs"],function(e){var t,r,a,n,i;return e.XLoader=(t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),a=function e(){t(this,e),this.animeName="",this.boneName="",this.targetBone=null,this.keyType=4,this.frameStartLv=0,this.keyFrames=[],this.InverseMx=null},n=function(){function a(e){t(this,a),this.fps=30,this.name="xanimation",this.length=0,this.hierarchy=[],this.putFlags=e,void 0===this.putFlags.putPos&&(this.putFlags.putPos=!0),void 0===this.putFlags.putRot&&(this.putFlags.putRot=!0),void 0===this.putFlags.putScl&&(this.putFlags.putScl=!0)}return r(a,[{key:"make",value:function(e){for(var t=0;t<e.length;t++)this.hierarchy.push(this.makeBonekeys(e[t]));this.length=this.hierarchy[0].keys[this.hierarchy[0].keys.length-1].time}},{key:"clone",value:function(){return Object.assign({},this)}},{key:"makeBonekeys",value:function(e){var t={};return t.name=e.boneName,t.parent="",t.keys=this.keyFrameRefactor(e),t.copy=function(){return Object.assign({},this)},t}},{key:"keyFrameRefactor",value:function(t){for(var r=[],a=0;a<t.keyFrames.length;a++){var n={};n.time=t.keyFrames[a].time*this.fps,t.keyFrames[a].pos&&this.putFlags.putPos&&(n.pos=t.keyFrames[a].pos),t.keyFrames[a].rot&&this.putFlags.putRot&&(n.rot=t.keyFrames[a].rot),t.keyFrames[a].scl&&this.putFlags.putScl&&(n.scl=t.keyFrames[a].scl),t.keyFrames[a].matrix&&(n.matrix=t.keyFrames[a].matrix,this.putFlags.putPos&&(n.pos=(new e.Vector3).setFromMatrixPosition(n.matrix)),this.putFlags.putRot&&(n.rot=(new e.Quaternion).setFromRotationMatrix(n.matrix)),this.putFlags.putScl&&(n.scl=(new e.Vector3).setFromMatrixScale(n.matrix))),r.push(n)}return r}}]),a}(),i=function e(){t(this,e),this.index=0,this.Frame=0,this.time=0,this.matrix=null},function(){function o(r){e.Loader.call(this,r),t(this,o),this.debug=!1,this.texloader=new e.TextureLoader(this.manager),this.url="",this._putMatLength=0,this._nowMat=null,this._nowFrameName="",this.frameHierarchie=[],this.Hierarchies={},this.HieStack=[],this._currentObject={},this._currentFrame={},this._data=null,this.onLoad=null,this.IsUvYReverse=!0,this.Meshes=[],this.animations=[],this.animTicksPerSecond=30,this._currentGeo=null,this._currentAnime=null,this._currentAnimeFrames=null}return r(o,[{key:"_setArgOption",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(e){for(var r=t;r<e.length;r++)switch(r){case 0:this.url=e[r];break;case 1:this.options=e[r]}void 0===this.options&&(this.options={})}}},{key:"load",value:function(t,r,a,n){var i=this;this._setArgOption(t);var o=new e.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.load(this.url,function(e){i.parse(e,r)},a,n)}},{key:"_readLine",value:function(e){for(var t=0;;){var r=-1;if(-1===(r=e.indexOf("//",t))&&(r=e.indexOf("#",t)),!(r>-1&&r<2))break;var a=-1;(a=e.indexOf("\r\n",t))>0?t=a+2:(a=e.indexOf("\r",t),t=a>0?a+1:e.indexOf("\n",t)+1)}return e.substr(t)}},{key:"_readLine",value:function(e){for(var t=0;;){var r=-1;if(-1===(r=e.indexOf("//",t))&&(r=e.indexOf("#",t)),!(r>-1&&r<2))break;var a=-1;(a=e.indexOf("\r\n",t))>0?t=a+2:(a=e.indexOf("\r",t),t=a>0?a+1:e.indexOf("\n",t)+1)}return e.substr(t)}},{key:"_isBinary",value:function(e){var t=new DataView(e),r=t.getUint32(80,!0),a=84+50*r;if(a===t.byteLength)return!0;for(var n=t.byteLength,i=0;i<n;i++)if(t.getUint8(i,!1)>127)return!0;return!1}},{key:"_ensureBinary",value:function(e){if("string"==typeof e){for(var t=new Uint8Array(e.length),r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t.buffer||t}return e}},{key:"_ensureString",value:function(t){return"string"!=typeof t?e.LoaderUtils.decodeText(new Uint8Array(t)):t}},{key:"parse",value:function(e,t){var r=this._ensureBinary(e);return this._data=this._ensureString(e),this.onLoad=t,this._isBinary(r)?this._parseBinary(r):this._parseASCII()}},{key:"_parseBinary",value:function(t){return this._parseASCII(e.LoaderUtils.decodeText(new Uint8Array(t)))}},{key:"_parseASCII",value:function(){var t;t=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:e.LoaderUtils.extractUrlBase(this.url),this.texloader.setPath(t).setCrossOrigin(this.crossOrigin);this.Hierarchies.children=[],this._hierarchieParse(this.Hierarchies,16),this._changeRoot(),this._currentObject=this.Hierarchies.children.shift(),this._mainloop()}},{key:"_hierarchieParse",value:function(e,t){for(var r=t;;){var a=this._data.indexOf("{",r)+1,n=this._data.indexOf("}",r),i=this._data.indexOf("{",a)+1;if(!(a>0&&n>a)){r=-1===a?this._data.length:n+1;break}var o={children:[]},s=this._readLine(this._data.substr(r,a-r-1)).trim(),l=s.split(/ /g);if(l.length>0?(o.type=l[0],l.length>=2?o.name=l[1]:o.name=l[0]+this.Hierarchies.children.length):(o.name=s,o.type=""),"Animation"===o.type){o.data=this._data.substr(i,n-i).trim();var u=this._hierarchieParse(o,n+1);r=u.end,o.children=u.parent.children}else{var c=this._data.lastIndexOf(";",i>0?Math.min(i,n):n);if(o.data=this._data.substr(a,c-a).trim(),i<=0||n<i)r=n+1;else{var f=Math.max(c+1,a),d=this._hierarchieParse(o,f);r=d.end,o.children=d.parent.children}}o.parent=e,"template"!=o.type&&e.children.push(o)}return{parent:e,end:r}}},{key:"_mainloop",value:function(){var e=this;this._mainProc(),this._currentObject.parent||this._currentObject.children.length>0||!this._currentObject.worked?setTimeout(function(){e._mainloop()},1):setTimeout(function(){e.onLoad({models:e.Meshes,animations:e.animations})},1)}},{key:"_mainProc",value:function(){for(var e=!1;;){if(!this._currentObject.worked){switch(this._currentObject.type){case"template":break;case"AnimTicksPerSecond":this.animTicksPerSecond=parseInt(this._currentObject.data);break;case"Frame":this._setFrame();break;case"FrameTransformMatrix":this._setFrameTransformMatrix();break;case"Mesh":this._changeRoot(),this._currentGeo={},this._currentGeo.name=this._currentObject.name.trim(),this._currentGeo.parentName=this._getParentName(this._currentObject).trim(),this._currentGeo.VertexSetedBoneCount=[],this._currentGeo.GeometryData={vertices:[],normals:[],uvs:[],skinIndices:[],skinWeights:[],indices:[],materialIndices:[]},this._currentGeo.Materials=[],this._currentGeo.normalVectors=[],this._currentGeo.BoneInfs=[],this._currentGeo.baseFrame=this._currentFrame,this._makeBoneFrom_CurrentFrame(),this._readVertexDatas(),e=!0;break;case"MeshNormals":this._readVertexDatas();break;case"MeshTextureCoords":this._setMeshTextureCoords();break;case"VertexDuplicationIndices":break;case"MeshMaterialList":this._setMeshMaterialList();break;case"Material":this._setMaterial();break;case"SkinWeights":this._setSkinWeights();break;case"AnimationSet":this._changeRoot(),this._currentAnime={},this._currentAnime.name=this._currentObject.name.trim(),this._currentAnime.AnimeFrames=[];break;case"Animation":this._currentAnimeFrames&&this._currentAnime.AnimeFrames.push(this._currentAnimeFrames),this._currentAnimeFrames=new a,this._currentAnimeFrames.boneName=this._currentObject.data.trim();break;case"AnimationKey":this._readAnimationKey(),e=!0}this._currentObject.worked=!0}if(this._currentObject.children.length>0){if(this._currentObject=this._currentObject.children.shift(),this.debug&&console.log("processing "+this._currentObject.name),e)break}else if(this._currentObject.worked&&this._currentObject.parent&&!this._currentObject.parent.parent&&this._changeRoot(),this._currentObject.parent?this._currentObject=this._currentObject.parent:e=!0,e)break}}},{key:"_changeRoot",value:function(){null!=this._currentGeo&&this._currentGeo.name&&this._makeOutputGeometry(),this._currentGeo={},null!=this._currentAnime&&this._currentAnime.name&&(this._currentAnimeFrames&&(this._currentAnime.AnimeFrames.push(this._currentAnimeFrames),this._currentAnimeFrames=null),this._makeOutputAnimation()),this._currentAnime={}}},{key:"_getParentName",value:function(e){return e.parent?e.parent.name?e.parent.name:this._getParentName(e.parent):""}},{key:"_setFrame",value:function(){this._nowFrameName=this._currentObject.name.trim(),this._currentFrame={},this._currentFrame.name=this._nowFrameName,this._currentFrame.children=[],this._currentObject.parent&&this._currentObject.parent.name&&(this._currentFrame.parentName=this._currentObject.parent.name),this.frameHierarchie.push(this._nowFrameName),this.HieStack[this._nowFrameName]=this._currentFrame}},{key:"_setFrameTransformMatrix",value:function(){this._currentFrame.FrameTransformMatrix=new e.Matrix4;var t=this._currentObject.data.split(",");this._ParseMatrixData(this._currentFrame.FrameTransformMatrix,t),this._makeBoneFrom_CurrentFrame()}},{key:"_makeBoneFrom_CurrentFrame",value:function(){if(this._currentFrame.FrameTransformMatrix){var t=new e.Bone;if(t.name=this._currentFrame.name,t.applyMatrix4(this._currentFrame.FrameTransformMatrix),t.matrixWorld=t.matrix,t.FrameTransformMatrix=this._currentFrame.FrameTransformMatrix,this._currentFrame.putBone=t,this._currentFrame.parentName)for(var r in this.HieStack)this.HieStack[r].name===this._currentFrame.parentName&&this.HieStack[r].putBone.add(this._currentFrame.putBone)}}},{key:"_readVertexDatas",value:function(){for(var e=0,t=0,r=0,a=0;;){var n=!1;if(0===r){var i=this._readInt1(e);e=i.endRead,r=1,(a=this._currentObject.data.indexOf(";;",e)+1)<=0&&(a=this._currentObject.data.length)}else{var o=0;switch(t){case 0:o=this._currentObject.data.indexOf(",",e)+1;break;case 1:o=this._currentObject.data.indexOf(";,",e)+1}switch((0===o||o>a)&&(o=a,r=0,n=!0),this._currentObject.type){case"Mesh":switch(t){case 0:this._readVertex1(this._currentObject.data.substr(e,o-e));break;case 1:this._readFace1(this._currentObject.data.substr(e,o-e))}break;case"MeshNormals":switch(t){case 0:this._readNormalVector1(this._currentObject.data.substr(e,o-e))}}e=o+1,n&&t++}if(e>=this._currentObject.data.length)break}}},{key:"_readInt1",value:function(e){var t=this._currentObject.data.indexOf(";",e);return{refI:parseInt(this._currentObject.data.substr(e,t-e)),endRead:t+1}}},{key:"_readVertex1",value:function(e){var t=this._readLine(e.trim()).substr(0,e.length-2).split(";");this._currentGeo.GeometryData.vertices.push(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])),this._currentGeo.GeometryData.skinIndices.push(0,0,0,0),this._currentGeo.GeometryData.skinWeights.push(1,0,0,0),this._currentGeo.VertexSetedBoneCount.push(0)}},{key:"_readFace1",value:function(e){var t=this._readLine(e.trim()).substr(2,e.length-4).split(",");this._currentGeo.GeometryData.indices.push(parseInt(t[0],10),parseInt(t[1],10),parseInt(t[2],10))}},{key:"_readNormalVector1",value:function(e){var t=this._readLine(e.trim()).substr(0,e.length-2).split(";");this._currentGeo.GeometryData.normals.push(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))}},{key:"_buildGeometry",value:function(){for(var t=new e.BufferGeometry,r=[],a=[],n=[],i=[],o=[],s=this._currentGeo.GeometryData,l=0,u=s.indices.length;l<u;l++){var c=2*s.indices[l],f=3*s.indices[l],d=4*s.indices[l];r.push(s.vertices[f],s.vertices[f+1],s.vertices[f+2]),a.push(s.normals[f],s.normals[f+1],s.normals[f+2]),i.push(s.skinIndices[d],s.skinIndices[d+1],s.skinIndices[d+2],s.skinIndices[d+3]),o.push(s.skinWeights[d],s.skinWeights[d+1],s.skinWeights[d+2],s.skinWeights[d+3]),n.push(s.uvs[c],s.uvs[c+1])}return t.setAttribute("position",new e.Float32BufferAttribute(r,3)),t.setAttribute("normal",new e.Float32BufferAttribute(a,3)),t.setAttribute("uv",new e.Float32BufferAttribute(n,2)),t.setAttribute("skinIndex",new e.Uint16BufferAttribute(i,4)),t.setAttribute("skinWeight",new e.Float32BufferAttribute(o,4)),this._computeGroups(t,s.materialIndices),t}},{key:"_computeGroups",value:function(e,t){for(var r,a=[],n=void 0,i=0;i<t.length;i++){var o=t[i];o!==n&&(n=o,void 0!==r&&(r.count=3*i-r.start,a.push(r)),r={start:3*i,materialIndex:n})}void 0!==r&&(r.count=3*i-r.start,a.push(r)),e.groups=a}},{key:"_setMeshTextureCoords",value:function(){for(var e=0,t=0,r=0;;){switch(t){case 0:if(0===r){var a=this._readInt1(0);e=a.endRead,r=1}else{var n=this._currentObject.data.indexOf(",",e)+1;0===n&&(n=this._currentObject.data.length,t=2,r=0);var i=this._currentObject.data.substr(e,n-e),o=this._readLine(i.trim()).split(";");this.IsUvYReverse?this._currentGeo.GeometryData.uvs.push(parseFloat(o[0]),1-parseFloat(o[1])):this._currentGeo.GeometryData.uvs.push(parseFloat(o[0]),parseFloat(o[1])),e=n+1}}if(e>=this._currentObject.data.length)break}}},{key:"_setMeshMaterialList",value:function(){for(var e=0,t=0,r=0;;){if(r<2){var a=this._readInt1(e);e=a.endRead,r++}else{var n=this._currentObject.data.indexOf(";",e);-1===n&&(n=this._currentObject.data.length,t=3,r=0);for(var i=this._currentObject.data.substr(e,n-e),o=this._readLine(i.trim()).split(","),s=0;s<o.length;s++)this._currentGeo.GeometryData.materialIndices[s]=parseInt(o[s]);e=this._currentObject.data.length}if(e>=this._currentObject.data.length||t>=3)break}}},{key:"_setMaterial",value:function(){var t=new e.MeshPhongMaterial({color:16777215*Math.random()});t.side=e.FrontSide,t.name=this._currentObject.name;var r=0,a=this._currentObject.data.indexOf(";;",r),n=this._currentObject.data.substr(r,a-r),i=this._readLine(n.trim()).split(";");t.color.r=parseFloat(i[0]),t.color.g=parseFloat(i[1]),t.color.b=parseFloat(i[2]),r=a+2,a=this._currentObject.data.indexOf(";",r),n=this._currentObject.data.substr(r,a-r),t.shininess=parseFloat(this._readLine(n)),r=a+1,a=this._currentObject.data.indexOf(";;",r),n=this._currentObject.data.substr(r,a-r);var o=this._readLine(n.trim()).split(";");t.specular.r=parseFloat(o[0]),t.specular.g=parseFloat(o[1]),t.specular.b=parseFloat(o[2]),r=a+2,-1===(a=this._currentObject.data.indexOf(";;",r))&&(a=this._currentObject.data.length),n=this._currentObject.data.substr(r,a-r);var s=this._readLine(n.trim()).split(";");t.emissive.r=parseFloat(s[0]),t.emissive.g=parseFloat(s[1]),t.emissive.b=parseFloat(s[2]);for(var l=null;this._currentObject.children.length>0;){l=this._currentObject.children.shift(),this.debug&&console.log("processing "+l.name);var u=l.data.substr(1,l.data.length-2);switch(l.type){case"TextureFilename":t.map=this.texloader.load(u);break;case"BumpMapFilename":t.bumpMap=this.texloader.load(u),t.bumpScale=.05;break;case"NormalMapFilename":t.normalMap=this.texloader.load(u),t.normalScale=new e.Vector2(2,2);break;case"EmissiveMapFilename":t.emissiveMap=this.texloader.load(u);break;case"LightMapFilename":t.lightMap=this.texloader.load(u)}}this._currentGeo.Materials.push(t)}},{key:"_setSkinWeights",value:function(){var r=new function e(){t(this,e),this.boneName="",this.BoneIndex=0,this.Indeces=[],this.Weights=[],this.initMatrix=null,this.OffsetMatrix=null},a=0,n=this._currentObject.data.indexOf(";",a),i=this._currentObject.data.substr(a,n-a);a=n+1,r.boneName=i.substr(1,i.length-2),r.BoneIndex=this._currentGeo.BoneInfs.length,n=this._currentObject.data.indexOf(";",a),a=n+1,n=this._currentObject.data.indexOf(";",a),i=this._currentObject.data.substr(a,n-a);for(var o=this._readLine(i.trim()).split(","),s=0;s<o.length;s++)r.Indeces.push(parseInt(o[s]));a=n+1,n=this._currentObject.data.indexOf(";",a),i=this._currentObject.data.substr(a,n-a);for(var l=this._readLine(i.trim()).split(","),u=0;u<l.length;u++)r.Weights.push(parseFloat(l[u]));a=n+1,(n=this._currentObject.data.indexOf(";",a))<=0&&(n=this._currentObject.data.length),i=this._currentObject.data.substr(a,n-a);var c=this._readLine(i.trim()).split(",");r.OffsetMatrix=new e.Matrix4,this._ParseMatrixData(r.OffsetMatrix,c),this._currentGeo.BoneInfs.push(r)}},{key:"_makePutBoneList",value:function(t,r){var a=!1;for(var n in this.HieStack)if(this.HieStack[n].name===t||a){a=!0;var i=new e.Bone;if(i.name=this.HieStack[n].name,i.applyMatrix4(this.HieStack[n].FrameTransformMatrix),i.matrixWorld=i.matrix,i.FrameTransformMatrix=this.HieStack[n].FrameTransformMatrix,i.pos=(new e.Vector3).setFromMatrixPosition(i.FrameTransformMatrix).toArray(),i.rotq=(new e.Quaternion).setFromRotationMatrix(i.FrameTransformMatrix).toArray(),i.scl=(new e.Vector3).setFromMatrixScale(i.FrameTransformMatrix).toArray(),this.HieStack[n].parentName&&this.HieStack[n].parentName.length>0)for(var o=0;o<r.length;o++)if(this.HieStack[n].parentName===r[o].name){r[o].add(i),i.parent=o;break}r.push(i)}}},{key:"_makeOutputGeometry",value:function(){var t=null;if(this._currentGeo.BoneInfs.length>0){var r=[];this._makePutBoneList(this._currentGeo.baseFrame.parentName,r);for(var a=0;a<this._currentGeo.BoneInfs.length;a++){for(var n=0,i=0;i<r.length;i++)if(r[i].name===this._currentGeo.BoneInfs[a].boneName){n=i,r[i].OffsetMatrix=new e.Matrix4,r[i].OffsetMatrix.copy(this._currentGeo.BoneInfs[a].OffsetMatrix);break}for(var o=0;o<this._currentGeo.BoneInfs[a].Indeces.length;o++){var s=this._currentGeo.BoneInfs[a].Indeces[o],l=this._currentGeo.BoneInfs[a].Weights[o],u=4*s;switch(this._currentGeo.VertexSetedBoneCount[s]){case 0:this._currentGeo.GeometryData.skinIndices[u]=n,this._currentGeo.GeometryData.skinWeights[u]=l;break;case 1:this._currentGeo.GeometryData.skinIndices[u+1]=n,this._currentGeo.GeometryData.skinWeights[u+1]=l;break;case 2:this._currentGeo.GeometryData.skinIndices[u+2]=n,this._currentGeo.GeometryData.skinWeights[u+2]=l;break;case 3:this._currentGeo.GeometryData.skinIndices[u+3]=n,this._currentGeo.GeometryData.skinWeights[u+3]=l}this._currentGeo.VertexSetedBoneCount[s]++,this._currentGeo.VertexSetedBoneCount[s]>4&&console.log("warn! over 4 bone weight! :"+s)}}for(var c=0;c<this._currentGeo.Materials.length;c++)this._currentGeo.Materials[c].skinning=!0;for(var f=[],d=0;d<r.length;d++)r[d].OffsetMatrix?f.push(r[d].OffsetMatrix):f.push(new e.Matrix4);var h=this._buildGeometry();t=new e.SkinnedMesh(h,1===this._currentGeo.Materials.length?this._currentGeo.Materials[0]:this._currentGeo.Materials),this._initSkeleton(t,r,f)}else{var p=this._buildGeometry();t=new e.Mesh(p,1===this._currentGeo.Materials.length?this._currentGeo.Materials[0]:this._currentGeo.Materials)}t.name=this._currentGeo.name;var m=new e.Matrix4,v=this._currentGeo.baseFrame.putBone;if(v&&v.parent){for(;v=v.parent;)m.multiply(v.FrameTransformMatrix);t.applyMatrix4(m)}this.Meshes.push(t)}},{key:"_initSkeleton",value:function(t,r,a){var n,i,o,s,l=[];for(o=0,s=r.length;o<s;o++)i=r[o],n=new e.Bone,l.push(n),n.name=i.name,n.position.fromArray(i.pos),n.quaternion.fromArray(i.rotq),void 0!==i.scl&&n.scale.fromArray(i.scl);for(o=0,s=r.length;o<s;o++)-1!==(i=r[o]).parent&&null!==i.parent&&void 0!==l[i.parent]?l[i.parent].add(l[o]):t.add(l[o]);t.updateMatrixWorld(!0);var u=new e.Skeleton(l,a);t.bind(u,t.matrixWorld)}},{key:"_readAnimationKey",value:function(){var t=0,r=this._currentObject.data.indexOf(";",t),a=this._currentObject.data.substr(t,r-t);t=r+1;var n=parseInt(this._readLine(a));r=this._currentObject.data.indexOf(";",t),t=r+1,a=this._currentObject.data.substr(t);for(var o=this._readLine(a.trim()).split(";;,"),s=0;s<o.length;s++){var l=o[s].split(";"),u=new i;if(u.type=n,u.Frame=parseInt(l[0]),u.index=this._currentAnimeFrames.keyFrames.length,u.time=u.Frame,4!=n){for(var c=!1,f=0;f<this._currentAnimeFrames.keyFrames.length;f++)if(this._currentAnimeFrames.keyFrames[f].Frame===u.Frame){u=this._currentAnimeFrames.keyFrames[f],c=!0;break}var d=l[2].split(",");switch(n){case 0:u.rot=new e.Quaternion(parseFloat(d[1]),parseFloat(d[2]),parseFloat(d[3]),-1*parseFloat(d[0]));break;case 1:u.scl=new e.Vector3(parseFloat(d[0]),parseFloat(d[1]),parseFloat(d[2]));break;case 2:u.pos=new e.Vector3(parseFloat(d[0]),parseFloat(d[1]),parseFloat(d[2]))}c||this._currentAnimeFrames.keyFrames.push(u)}else u.matrix=new e.Matrix4,this._ParseMatrixData(u.matrix,l[2].split(",")),this._currentAnimeFrames.keyFrames.push(u)}}},{key:"_makeOutputAnimation",value:function(){var e=new n(this.options);e.fps=this.animTicksPerSecond,e.name=this._currentAnime.name,e.make(this._currentAnime.AnimeFrames),this.animations.push(e)}},{key:"assignAnimation",value:function(t,r){var a=t,n=r;if(a||(a=this.Meshes[0]),n||(n=this.animations[0]),!a||!n)return null;var i={};i.fps=n.fps,i.name=n.name,i.length=n.length,i.hierarchy=[];for(var o=0;o<a.skeleton.bones.length;o++){for(var s=!1,l=0;l<n.hierarchy.length;l++)if(a.skeleton.bones[o].name===n.hierarchy[l].name){s=!0;var u=n.hierarchy[l].copy();if(u.parent=-1,a.skeleton.bones[o].parent&&"Bone"===a.skeleton.bones[o].parent.type)for(var c=0;c<i.hierarchy.length;c++)i.hierarchy[c].name===a.skeleton.bones[o].parent.name&&(u.parent=c,u.parentName=a.skeleton.bones[o].parent.name);i.hierarchy.push(u);break}if(!s){var f=n.hierarchy[0].copy();f.name=a.skeleton.bones[o].name,f.parent=-1;for(var d=0;d<f.keys.length;d++)f.keys[d].pos&&f.keys[d].pos.set(0,0,0),f.keys[d].scl&&f.keys[d].scl.set(1,1,1),f.keys[d].rot&&f.keys[d].rot.set(0,0,0,1);i.hierarchy.push(f)}}return a.geometry.animations||(a.geometry.animations=[]),a.geometry.animations.push(e.AnimationClip.parseAnimation(i,a.skeleton.bones)),a.animationMixer||(a.animationMixer=new e.AnimationMixer(a)),i}},{key:"_ParseMatrixData",value:function(e,t){e.set(parseFloat(t[0]),parseFloat(t[4]),parseFloat(t[8]),parseFloat(t[12]),parseFloat(t[1]),parseFloat(t[5]),parseFloat(t[9]),parseFloat(t[13]),parseFloat(t[2]),parseFloat(t[6]),parseFloat(t[10]),parseFloat(t[14]),parseFloat(t[3]),parseFloat(t[7]),parseFloat(t[11]),parseFloat(t[15]))}}]),o}()),e.XLoader}),e("skylark-threejs-ex/loaders/DDSLoader",["skylark-threejs"],function(e){return e.DDSLoader=function(t){e.CompressedTextureLoader.call(this,t)},e.DDSLoader.prototype=Object.assign(Object.create(e.CompressedTextureLoader.prototype),{constructor:e.DDSLoader,parse:function(t,r){var a={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};function n(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function i(e,t,r,a){for(var n=r*a*4,i=new Uint8Array(e,t,n),o=new Uint8Array(n),s=0,l=0,u=0;u<a;u++)for(var c=0;c<r;c++){var f=i[l],d=i[++l],h=i[++l],p=i[++l];l++,o[s]=h,o[++s]=d,o[++s]=f,o[++s]=p,s++}return o}var o,s=n("DXT1"),l=n("DXT3"),u=n("DXT5"),c=n("ETC1"),f=new Int32Array(t,0,31);if(542327876!==f[0])return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),a;if(4&!f[20])return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),a;var d,h=f[21],p=!1;switch(h){case s:o=8,a.format=e.RGB_S3TC_DXT1_Format;break;case l:o=16,a.format=e.RGBA_S3TC_DXT3_Format;break;case u:o=16,a.format=e.RGBA_S3TC_DXT5_Format;break;case c:o=8,a.format=e.RGB_ETC1_Format;break;default:if(!(32===f[22]&&16711680&f[23]&&65280&f[24]&&255&f[25]&&4278190080&f[26]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",(d=h,String.fromCharCode(255&d,d>>8&255,d>>16&255,d>>24&255))),a;p=!0,o=64,a.format=e.RGBAFormat}a.mipmapCount=1,131072&f[2]&&!1!==r&&(a.mipmapCount=Math.max(1,f[7]));var m=f[28];if(a.isCubemap=!!(512&m),a.isCubemap&&(!(1024&m)||!(2048&m)||!(4096&m)||!(8192&m)||!(16384&m)||!(32768&m)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),a;a.width=f[4],a.height=f[3];for(var v=f[1]+4,g=a.isCubemap?6:1,y=0;y<g;y++)for(var x=a.width,A=a.height,b=0;b<a.mipmapCount;b++){if(p)var T=i(t,v,x,A),w=T.length;else var w=Math.max(4,x)/4*Math.max(4,A)/4*o,T=new Uint8Array(t,v,w);var F={data:T,width:x,height:A};a.mipmaps.push(F),v+=w,x=Math.max(x>>1,1),A=Math.max(A>>1,1)}return a}}),e.DDSLoader}),e("skylark-threejs-ex/loaders/PVRLoader",["skylark-threejs"],function(e){return e.PVRLoader=function(t){e.CompressedTextureLoader.call(this,t)},e.PVRLoader.prototype=Object.assign(Object.create(e.CompressedTextureLoader.prototype),{constructor:e.PVRLoader,parse:function(t,r){var a=new Uint32Array(t,0,13),n={buffer:t,header:a,loadMipmaps:r};return 55727696===a[0]?e.PVRLoader._parseV3(n):559044176===a[11]?e.PVRLoader._parseV2(n):void console.error("THREE.PVRLoader: Unknown PVR format.")}}),e.PVRLoader._parseV3=function(t){var r,a,n=t.header,i=n[12],o=n[2],s=n[6],l=n[7],u=n[10],c=n[11];switch(o){case 0:r=2,a=e.RGB_PVRTC_2BPPV1_Format;break;case 1:r=2,a=e.RGBA_PVRTC_2BPPV1_Format;break;case 2:r=4,a=e.RGB_PVRTC_4BPPV1_Format;break;case 3:r=4,a=e.RGBA_PVRTC_4BPPV1_Format;break;default:console.error("THREE.PVRLoader: Unsupported PVR format:",o)}return t.dataPtr=52+i,t.bpp=r,t.format=a,t.width=l,t.height=s,t.numSurfaces=u,t.numMipmaps=c,t.isCubemap=6===u,e.PVRLoader._extract(t)},e.PVRLoader._parseV2=function(t){var r,a,n=t.header,i=n[0],o=n[1],s=n[2],l=n[3],u=n[4],c=n[10],f=n[12],d=255&u,h=c>0;return 25===d?(a=h?e.RGBA_PVRTC_4BPPV1_Format:e.RGB_PVRTC_4BPPV1_Format,r=4):24===d?(a=h?e.RGBA_PVRTC_2BPPV1_Format:e.RGB_PVRTC_2BPPV1_Format,r=2):console.error("THREE.PVRLoader: Unknown PVR format:",d),t.dataPtr=i,t.bpp=r,t.format=a,t.width=s,t.height=o,t.numSurfaces=f,t.numMipmaps=l+1,t.isCubemap=6===f,e.PVRLoader._extract(t)},e.PVRLoader._extract=function(e){var t={mipmaps:[],width:e.width,height:e.height,format:e.format,mipmapCount:e.numMipmaps,isCubemap:e.isCubemap},r=e.buffer,a=e.dataPtr,n=e.bpp,i=e.numSurfaces,o=0,s=0,l=0,u=0,c=0,f=0;2===n?(l=8,u=4):(l=4,u=4),s=l*u*n/8,t.mipmaps.length=e.numMipmaps*i;for(var d=0;d<e.numMipmaps;){var h=e.width>>d,p=e.height>>d;f=p/u,(c=h/l)<2&&(c=2),f<2&&(f=2),o=c*f*s;for(var m=0;m<i;m++){var v=new Uint8Array(r,a,o),g={data:v,width:h,height:p};t.mipmaps[m*e.numMipmaps+d]=g,a+=o}d++}return t},e.PVRLoader}),e("skylark-threejs-ex/loaders/KTXLoader",["skylark-threejs"],function(e){e.KTXLoader=function(t){e.CompressedTextureLoader.call(this,t)},e.KTXLoader.prototype=Object.assign(Object.create(e.CompressedTextureLoader.prototype),{constructor:e.KTXLoader,parse:function(e,r){var a=new t(e,1);return{mipmaps:a.mipmaps(r),width:a.pixelWidth,height:a.pixelHeight,format:a.glInternalFormat,isCubemap:6===a.numberOfFaces,mipmapCount:a.numberOfMipmapLevels}}});var t=function(){function e(t,r){this.arrayBuffer=t;var a=new Uint8Array(this.arrayBuffer,0,12);if(171===a[0]&&75===a[1]&&84===a[2]&&88===a[3]&&32===a[4]&&49===a[5]&&49===a[6]&&187===a[7]&&13===a[8]&&10===a[9]&&26===a[10]&&10===a[11]){var n=Uint32Array.BYTES_PER_ELEMENT,i=new DataView(this.arrayBuffer,12,13*n),o=i.getUint32(0,!0),s=67305985===o;this.glType=i.getUint32(1*n,s),this.glTypeSize=i.getUint32(2*n,s),this.glFormat=i.getUint32(3*n,s),this.glInternalFormat=i.getUint32(4*n,s),this.glBaseInternalFormat=i.getUint32(5*n,s),this.pixelWidth=i.getUint32(6*n,s),this.pixelHeight=i.getUint32(7*n,s),this.pixelDepth=i.getUint32(8*n,s),this.numberOfArrayElements=i.getUint32(9*n,s),this.numberOfFaces=i.getUint32(10*n,s),this.numberOfMipmapLevels=i.getUint32(11*n,s),this.bytesOfKeyValueData=i.getUint32(12*n,s),0===this.glType?(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0!==this.pixelHeight&&0===this.pixelDepth?0===this.numberOfArrayElements?this.numberOfFaces===r?this.loadType=e.COMPRESSED_2D:console.warn("number of faces expected"+r+", but found "+this.numberOfFaces):console.warn("texture arrays not currently supported"):console.warn("only 2D textures currently supported")):console.warn("only compressed formats currently supported")}else console.error("texture missing KTX identifier")}return e.prototype.mipmaps=function(t){for(var r=[],a=e.HEADER_LEN+this.bytesOfKeyValueData,n=this.pixelWidth,i=this.pixelHeight,o=t?this.numberOfMipmapLevels:1,s=0;s<o;s++){var l=new Int32Array(this.arrayBuffer,a,1)[0];a+=4;for(var u=0;u<this.numberOfFaces;u++){var c=new Uint8Array(this.arrayBuffer,a,l);r.push({data:c,width:n,height:i}),a+=l,a+=3-(l+3)%4}n=Math.max(1,.5*n),i=Math.max(1,.5*i)}return r},e.HEADER_LEN=64,e.COMPRESSED_2D=0,e.COMPRESSED_3D=1,e.TEX_2D=2,e.TEX_3D=3,e}();return e.KTXLoader}),e("skylark-threejs-ex/modifiers/SimplifyModifier",["skylark-threejs"],function(e){return e.SimplifyModifier=function(){},function(){var t=new e.Vector3,r=new e.Vector3;function a(e,t){var r=e.indexOf(t);r>-1&&e.splice(r,1)}function n(e,t){var r,a,n,i=t.position.distanceTo(e.position),o=0,s=[],l=e.faces.length;for(r=0;r<l;r++)(a=e.faces[r]).hasVertex(t)&&s.push(a);for(r=0;r<l;r++){var u=1;a=e.faces[r];for(var c=0;c<s.length;c++){n=s[c];var f=a.normal.dot(n.normal);u=Math.min(u,(1.001-f)/2)}o=Math.max(o,u)}s.length<2&&(o=1);var d=i*o+0;return d}function i(e){if(0===e.neighbors.length)return e.collapseNeighbor=null,void(e.collapseCost=-.01);e.collapseCost=1e5,e.collapseNeighbor=null;for(var t=0;t<e.neighbors.length;t++){var r=n(e,e.neighbors[t]);e.collapseNeighbor||(e.collapseNeighbor=e.neighbors[t],e.collapseCost=r,e.minCost=r,e.totalCost=0,e.costCount=0),e.costCount++,e.totalCost+=r,r<e.minCost&&(e.collapseNeighbor=e.neighbors[t],e.minCost=r)}e.collapseCost=e.totalCost/e.costCount}function o(e,t){for(console.assert(0===e.faces.length);e.neighbors.length;){var r=e.neighbors.pop();a(r.neighbors,e)}a(t,e)}function s(e,t){a(t,e),e.v1&&a(e.v1.faces,e),e.v2&&a(e.v2.faces,e),e.v3&&a(e.v3.faces,e);for(var r,n,i=[e.v1,e.v2,e.v3],o=0;o<3;o++)n=i[(o+1)%3],(r=i[o])&&n&&(r.removeIfNonNeighbor(n),n.removeIfNonNeighbor(r))}function l(e,t,r,a){if(a){var n,l=[];for(n=0;n<r.neighbors.length;n++)l.push(r.neighbors[n]);for(n=r.faces.length-1;n>=0;n--)r.faces[n].hasVertex(a)&&s(r.faces[n],t);for(n=r.faces.length-1;n>=0;n--)r.faces[n].replaceVertex(r,a);for(o(r,e),n=0;n<l.length;n++)i(l[n])}else o(r,e)}function u(e){for(var t=e[0],r=0;r<e.length;r++)e[r].collapseCost<t.collapseCost&&(t=e[r]);return t}function c(t,r,a,n,i,o){this.a=n,this.b=i,this.c=o,this.v1=t,this.v2=r,this.v3=a,this.normal=new e.Vector3,this.computeNormal(),t.faces.push(this),t.addUniqueNeighbor(r),t.addUniqueNeighbor(a),r.faces.push(this),r.addUniqueNeighbor(t),r.addUniqueNeighbor(a),a.faces.push(this),a.addUniqueNeighbor(t),a.addUniqueNeighbor(r)}function f(e,t){this.position=e,this.id=t,this.faces=[],this.neighbors=[],this.collapseCost=0,this.collapseNeighbor=null}c.prototype.computeNormal=function(){var e=this.v1.position,a=this.v2.position,n=this.v3.position;t.subVectors(n,a),r.subVectors(e,a),t.cross(r).normalize(),this.normal.copy(t)},c.prototype.hasVertex=function(e){return e===this.v1||e===this.v2||e===this.v3},c.prototype.replaceVertex=function(e,t){e===this.v1?this.v1=t:e===this.v2?this.v2=t:e===this.v3&&(this.v3=t),a(e.faces,this),t.faces.push(this),e.removeIfNonNeighbor(this.v1),this.v1.removeIfNonNeighbor(e),e.removeIfNonNeighbor(this.v2),this.v2.removeIfNonNeighbor(e),e.removeIfNonNeighbor(this.v3),this.v3.removeIfNonNeighbor(e),this.v1.addUniqueNeighbor(this.v2),this.v1.addUniqueNeighbor(this.v3),this.v2.addUniqueNeighbor(this.v1),this.v2.addUniqueNeighbor(this.v3),this.v3.addUniqueNeighbor(this.v1),this.v3.addUniqueNeighbor(this.v2),this.computeNormal()},f.prototype.addUniqueNeighbor=function(e){var t,r;t=this.neighbors,r=e,-1===t.indexOf(r)&&t.push(r)},f.prototype.removeIfNonNeighbor=function(e){var t=this.neighbors,r=this.faces,a=t.indexOf(e);if(-1!==a){for(var n=0;n<r.length;n++)if(r[n].hasVertex(e))return;t.splice(a,1)}},e.SimplifyModifier.prototype.modify=function(t,r){t.isBufferGeometry&&(t=(new e.Geometry).fromBufferGeometry(t)),t.mergeVertices();var a,n,o,s=t.vertices,d=t.faces,h=[],p=[];for(a=0,n=s.length;a<n;a++){var m=new f(s[a],a);h.push(m)}for(a=0,n=d.length;a<n;a++){var v=d[a],g=v.a,y=v.b,x=v.c,A=new c(h[g],h[y],h[x],g,y,x);p.push(A)}for(a=0,n=h.length;a<n;a++)i(h[a]);for(var b=r;b--;){if(!(o=u(h))){console.log("THREE.SimplifyModifier: No next vertex");break}l(h,p,o,o.collapseNeighbor)}var T=new e.BufferGeometry,w=[],F=[];for(a=0;a<h.length;a++){var m=h[a].position;w.push(m.x,m.y,m.z)}for(a=0;a<p.length;a++){var v=p[a],g=h.indexOf(v.v1),y=h.indexOf(v.v2),x=h.indexOf(v.v3);F.push(g,y,x)}return T.setAttribute("position",new e.Float32BufferAttribute(w,3)),T.setIndex(F),T}}(),e.SimplifyModifier}),e("skylark-threejs-ex/modifiers/SubdivisionModifier",["skylark-threejs"],function(e){return e.SubdivisionModifier=function(e){this.subdivisions=void 0===e?1:e},e.SubdivisionModifier.prototype.modify=function(t){(t=t.isBufferGeometry?(new e.Geometry).fromBufferGeometry(t):t.clone()).mergeVertices();for(var r=this.subdivisions;r-- >0;)this.smooth(t);return t.computeFaceNormals(),t.computeVertexNormals(),t},function(){var t=["a","b","c"];function r(e,t,r){var a=Math.min(e,t),n=Math.max(e,t),i=a+"_"+n;return r[i]}function a(e,t,r,a,n,i){var o,s=Math.min(e,t),l=Math.max(e,t),u=s+"_"+l;if(u in a)o=a[u];else{var c=r[s],f=r[l];o={a:c,b:f,newEdge:null,faces:[]},a[u]=o}o.faces.push(n),i[e].edges.push(o),i[t].edges.push(o)}function n(t,r,a,n,i){t.push(new e.Face3(r,a,n,void 0,void 0,i))}function i(e,t){return Math.abs(t-e)/2+Math.min(e,t)}function o(e,t,r,a){e.push([t.clone(),r.clone(),a.clone()])}e.SubdivisionModifier.prototype.smooth=function(s){var l,u,c,f,d,h,p,m,v,g,y,x,A,b=new e.Vector3,T=[];l=s.vertices,u=s.faces;var w,F,_,E,L,S,M,P,N,I,k,R,C,U,O=void 0!==(c=s.faceVertexUvs)[0]&&c[0].length>0;if(O)for(var D=0;D<c.length;D++)T.push([]);for(p in g=new Array(l.length),function(e,t,r,n){var i,o,s;for(i=0,o=e.length;i<o;i++)r[i]={edges:[]};for(i=0,o=t.length;i<o;i++)a((s=t[i]).a,s.b,e,n,s,r),a(s.b,s.c,e,n,s,r),a(s.c,s.a,e,n,s,r)}(l,u,g,y={}),x=[],y){for(F=y[p],_=new e.Vector3,L=3/8,S=1/8,2!=(M=F.faces.length)&&(L=.5,S=0),_.addVectors(F.a,F.b).multiplyScalar(L),b.set(0,0,0),D=0;D<M;D++){for(E=F.faces[D],v=0;v<3&&((w=l[E[t[v]]])===F.a||w===F.b);v++);b.add(w)}b.multiplyScalar(S),_.add(b),F.newEdge=x.length,x.push(_)}for(A=[],p=0,m=l.length;p<m;p++){for(C=l[p],R=g[p].edges,3==(h=R.length)?P=3/16:h>3&&(P=3/(8*h)),N=1-h*P,I=P,h<=2&&2==h&&(N=.75,I=1/8),U=C.clone().multiplyScalar(N),b.set(0,0,0),D=0;D<h;D++)k=R[D],w=k.a!==C?k.a:k.b,b.add(w);b.multiplyScalar(I),U.add(b),A.push(U)}f=A.concat(x);var B,j,G,V,X,H,z,Y=A.length;d=[];var Q=new e.Vector2,W=new e.Vector2,K=new e.Vector2;for(p=0,m=u.length;p<m;p++)if(E=u[p],B=r(E.a,E.b,y).newEdge+Y,j=r(E.b,E.c,y).newEdge+Y,G=r(E.c,E.a,y).newEdge+Y,n(d,B,j,G,E.materialIndex),n(d,E.a,B,G,E.materialIndex),n(d,E.b,j,B,E.materialIndex),n(d,E.c,G,j,E.materialIndex),O)for(var D=0;D<c.length;D++)V=c[D][p],X=V[0],H=V[1],z=V[2],Q.set(i(X.x,H.x),i(X.y,H.y)),W.set(i(H.x,z.x),i(H.y,z.y)),K.set(i(X.x,z.x),i(X.y,z.y)),o(T[D],Q,W,K),o(T[D],X,Q,K),o(T[D],H,W,Q),o(T[D],z,K,W);s.vertices=f,s.faces=d,O&&(s.faceVertexUvs=T)}}(),e.SubdivisionModifier}),e("skylark-threejs-ex/exporters/DRACOExporter",["skylark-threejs"],function(e){return e.DRACOExporter=function(){},e.DRACOExporter.prototype={constructor:e.DRACOExporter,parse:function(t,r){if(void 0===DracoEncoderModule)throw new Error("THREE.DRACOExporter: required the draco_decoder to work.");void 0===r&&(r={decodeSpeed:5,encodeSpeed:5,encoderMethod:e.DRACOExporter.MESH_EDGEBREAKER_ENCODING,quantization:[16,8,8,8,8],exportUvs:!0,exportNormals:!0,exportColor:!1});var a=DracoEncoderModule(),n=new a.Encoder,i=new a.MeshBuilder,o=new a.Mesh;if(!0===t.isGeometry){var s=new e.BufferGeometry;s.fromGeometry(t),t=s}if(!0!==t.isBufferGeometry)throw new Error("THREE.DRACOExporter.parse(geometry, options): geometry is not a THREE.Geometry or THREE.BufferGeometry instance.");var l=t.getAttribute("position");i.AddFloatAttributeToMesh(o,a.POSITION,l.count,l.itemSize,l.array);var u=t.getIndex();if(null!==u)i.AddFacesToMesh(o,u.count,u.array);else{for(var u=new(l.count>65535?Uint32Array:Uint16Array)(l.count),c=0;c<u.length;c++)u[c]=c;i.AddFacesToMesh(o,l.count,u)}if(!0===r.exportNormals){var f=t.getAttribute("normal");void 0!==f&&i.AddFloatAttributeToMesh(o,a.NORMAL,f.count,f.itemSize,f.array)}if(!0===r.exportUvs){var d=t.getAttribute("uv");void 0!==d&&i.AddFloatAttributeToMesh(o,a.TEX_COORD,d.count,d.itemSize,d.array)}if(!0===r.exportColor){var h=t.getAttribute("color");void 0!==h&&i.AddFloatAttributeToMesh(o,a.COLOR,h.count,h.itemSize,h.array)}var p=new a.DracoInt8Array;if(n.SetSpeedOptions(r.encodeSpeed||5,r.decodeSpeed||5),void 0!==r.encoderMethod&&n.SetEncodingMethod(r.encoderMethod),void 0!==r.quantization)for(var c=0;c<5;c++)void 0!==r.quantization[c]&&n.SetAttributeQuantization(c,r.quantization[c]);var m=n.EncodeMeshToDracoBuffer(o,p);if(a.destroy(o),0===m)throw new Error("THREE.DRACOExporter: Draco encoding failed.");for(var v=new Int8Array(new ArrayBuffer(m)),c=0;c<m;c++)v[c]=p.GetValue(c);return a.destroy(p),a.destroy(n),a.destroy(i),v}},e.DRACOExporter.MESH_EDGEBREAKER_ENCODING=1,e.DRACOExporter.MESH_SEQUENTIAL_ENCODING=0,e.DRACOExporter.POINT_CLOUD=0,e.DRACOExporter.TRIANGULAR_MESH=1,e.DRACOExporter.INVALID=-1,e.DRACOExporter.POSITION=0,e.DRACOExporter.NORMAL=1,e.DRACOExporter.COLOR=2,e.DRACOExporter.TEX_COORD=3,e.DRACOExporter.GENERIC=4,e.DRACOExporter}),e("skylark-threejs-ex/exporters/OBJExporter",["skylark-threejs"],function(e){return e.OBJExporter=function(){},e.OBJExporter.prototype={constructor:e.OBJExporter,parse:function(t){var r,a,n,i,o,s="",l=0,u=0,c=0,f=new e.Vector3,d=new e.Vector3,h=new e.Vector2,p=[];return t.traverse(function(t){t instanceof e.Mesh&&function(t){var n=0,m=0,v=0,g=t.geometry,y=new e.Matrix3;g instanceof e.Geometry&&(g=(new e.BufferGeometry).setFromObject(t));if(g instanceof e.BufferGeometry){var x=g.getAttribute("position"),A=g.getAttribute("normal"),b=g.getAttribute("uv"),T=g.getIndex();if(s+="o "+t.name+"\n",t.material&&t.material.name&&(s+="usemtl "+t.material.name+"\n"),void 0!==x)for(r=0,i=x.count;r<i;r++,n++)f.x=x.getX(r),f.y=x.getY(r),f.z=x.getZ(r),f.applyMatrix4(t.matrixWorld),s+="v "+f.x+" "+f.y+" "+f.z+"\n";if(void 0!==b)for(r=0,i=b.count;r<i;r++,v++)h.x=b.getX(r),h.y=b.getY(r),s+="vt "+h.x+" "+h.y+"\n";if(void 0!==A)for(y.getNormalMatrix(t.matrixWorld),r=0,i=A.count;r<i;r++,m++)d.x=A.getX(r),d.y=A.getY(r),d.z=A.getZ(r),d.applyMatrix3(y).normalize(),s+="vn "+d.x+" "+d.y+" "+d.z+"\n";if(null!==T)for(r=0,i=T.count;r<i;r+=3){for(o=0;o<3;o++)a=T.getX(r+o)+1,p[o]=l+a+(A||b?"/"+(b?u+a:"")+(A?"/"+(c+a):""):"");s+="f "+p.join(" ")+"\n"}else for(r=0,i=x.count;r<i;r+=3){for(o=0;o<3;o++)a=r+o+1,p[o]=l+a+(A||b?"/"+(b?u+a:"")+(A?"/"+(c+a):""):"");s+="f "+p.join(" ")+"\n"}}else console.warn("THREE.OBJExporter.parseMesh(): geometry type unsupported",g);l+=n,u+=v,c+=m}(t),t instanceof e.Line&&function(t){var o=0,u=t.geometry,c=t.type;u instanceof e.Geometry&&(u=(new e.BufferGeometry).setFromObject(t));if(u instanceof e.BufferGeometry){var d=u.getAttribute("position");if(s+="o "+t.name+"\n",void 0!==d)for(r=0,i=d.count;r<i;r++,o++)f.x=d.getX(r),f.y=d.getY(r),f.z=d.getZ(r),f.applyMatrix4(t.matrixWorld),s+="v "+f.x+" "+f.y+" "+f.z+"\n";if("Line"===c){for(s+="l ",a=1,i=d.count;a<=i;a++)s+=l+a+" ";s+="\n"}if("LineSegments"===c)for(n=(a=1)+1,i=d.count;a<i;n=(a+=2)+1)s+="l "+(l+a)+" "+(l+n)+"\n"}else console.warn("THREE.OBJExporter.parseLine(): geometry type unsupported",u);l+=o}(t)}),s}},e.OBJExporter}),e("skylark-threejs-ex/exporters/STLExporter",["skylark-threejs"],function(e){var t,r;return e.STLExporter=function(){},e.STLExporter.prototype={constructor:e.STLExporter,parse:(t=new e.Vector3,r=new e.Matrix3,function(a,n){void 0===n&&(n={});var i=void 0!==n.binary&&n.binary,o=[],s=0;if(a.traverse(function(t){if(t.isMesh){var r=t.geometry;r.isBufferGeometry&&(r=(new e.Geometry).fromBufferGeometry(r)),r.isGeometry&&(s+=r.faces.length,o.push({geometry:r,matrixWorld:t.matrixWorld}))}}),i){var l=80,u=2*s+3*s*4*4+80+4,c=new ArrayBuffer(u),f=new DataView(c);f.setUint32(l,s,!0),l+=4;for(var d=0,h=o.length;d<h;d++){var p=o[d],m=p.geometry.vertices,v=p.geometry.faces,g=p.matrixWorld;r.getNormalMatrix(g);for(var y=0,x=v.length;y<x;y++){var A=v[y];t.copy(A.normal).applyMatrix3(r).normalize(),f.setFloat32(l,t.x,!0),l+=4,f.setFloat32(l,t.y,!0),l+=4,f.setFloat32(l,t.z,!0),l+=4;for(var b=[A.a,A.b,A.c],T=0;T<3;T++)t.copy(m[b[T]]).applyMatrix4(g),f.setFloat32(l,t.x,!0),l+=4,f.setFloat32(l,t.y,!0),l+=4,f.setFloat32(l,t.z,!0),l+=4;f.setUint16(l,0,!0),l+=2}}return f}var f="";f+="solid exported\n";for(var d=0,h=o.length;d<h;d++){var p=o[d],m=p.geometry.vertices,v=p.geometry.faces,g=p.matrixWorld;r.getNormalMatrix(g);for(var y=0,x=v.length;y<x;y++){var A=v[y];t.copy(A.normal).applyMatrix3(r).normalize(),f+="\tfacet normal "+t.x+" "+t.y+" "+t.z+"\n",f+="\t\touter loop\n";for(var b=[A.a,A.b,A.c],T=0;T<3;T++)t.copy(m[b[T]]).applyMatrix4(g),f+="\t\t\tvertex "+t.x+" "+t.y+" "+t.z+"\n";f+="\t\tendloop\n",f+="\tendfacet\n"}}return f+="endsolid exported\n"})},e.STLExporter}),e("skylark-threejs-ex/exporters/GLTFExporter",["skylark-threejs"],function(e){var t={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,FLOAT:5126,UNSIGNED_INT:5125,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},r={};r[e.NearestFilter]=t.NEAREST,r[e.NearestMipmapNearestFilter]=t.NEAREST_MIPMAP_NEAREST,r[e.NearestMipmapLinearFilter]=t.NEAREST_MIPMAP_LINEAR,r[e.LinearFilter]=t.LINEAR,r[e.LinearMipmapNearestFilter]=t.LINEAR_MIPMAP_NEAREST,r[e.LinearMipmapLinearFilter]=t.LINEAR_MIPMAP_LINEAR,r[e.ClampToEdgeWrapping]=t.CLAMP_TO_EDGE,r[e.RepeatWrapping]=t.REPEAT,r[e.MirroredRepeatWrapping]=t.MIRRORED_REPEAT;var a={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};return e.GLTFExporter=function(){},e.GLTFExporter.prototype={constructor:e.GLTFExporter,parse:function(n,i,o){var s={binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,maxTextureSize:1/0,animations:[],forceIndices:!1,forcePowerOfTwoTextures:!1,includeCustomExtensions:!1};(o=Object.assign({},s,o)).animations.length>0&&(o.trs=!0);var l,u={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},c=0,f=[],d=[],h=new Map,p=[],m={},v={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},g=new Map,y=0;function x(e){return g.has(e)||g.set(e,y++),g.get(e)}function A(e,t){return e.length===t.length&&e.every(function(e,r){return e===t[r]})}function b(e){return 4*Math.ceil(e/4)}function T(e,t){t=t||0;var r=b(e.byteLength);if(r!==e.byteLength){var a=new Uint8Array(r);if(a.set(new Uint8Array(e)),0!==t)for(var n=e.byteLength;n<r;n++)a[n]=t;return a.buffer}return e}function w(e,t){if(0!==Object.keys(e.userData).length)try{var r=JSON.parse(JSON.stringify(e.userData));if(o.includeCustomExtensions&&r.gltfExtensions){for(var a in void 0===t.extensions&&(t.extensions={}),r.gltfExtensions)t.extensions[a]=r.gltfExtensions[a],m[a]=!0;delete r.gltfExtensions}Object.keys(r).length>0&&(t.extras=r)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}function F(e,t){var r=!1,a={};0===t.offset.x&&0===t.offset.y||(a.offset=t.offset.toArray(),r=!0),0!==t.rotation&&(a.rotation=t.rotation,r=!0),1===t.repeat.x&&1===t.repeat.y||(a.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=a,m.KHR_texture_transform=!0)}function _(e){return u.buffers||(u.buffers=[{byteLength:0}]),f.push(e),0}function E(e,r,a,n){var i;if(e.array.constructor===Float32Array)i=t.FLOAT;else if(e.array.constructor===Uint32Array)i=t.UNSIGNED_INT;else if(e.array.constructor===Uint16Array)i=t.UNSIGNED_SHORT;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");i=t.UNSIGNED_BYTE}if(void 0===a&&(a=0),void 0===n&&(n=e.count),o.truncateDrawRange&&void 0!==r&&null===r.index){var s=a+n,l=r.drawRange.count===1/0?e.count:r.drawRange.start+r.drawRange.count;a=Math.max(a,r.drawRange.start),(n=Math.min(s,l)-a)<0&&(n=0)}if(0===n)return null;var f,d=function(e,t,r){for(var a={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},n=t;n<t+r;n++)for(var i=0;i<e.itemSize;i++){var o=e.array[n*e.itemSize+i];a.min[i]=Math.min(a.min[i],o),a.max[i]=Math.max(a.max[i],o)}return a}(e,a,n);void 0!==r&&(f=e===r.index?t.ELEMENT_ARRAY_BUFFER:t.ARRAY_BUFFER);var h=function(e,r,a,n,i){u.bufferViews||(u.bufferViews=[]);var o;o=r===t.UNSIGNED_BYTE?1:r===t.UNSIGNED_SHORT?2:4;for(var s=b(n*e.itemSize*o),l=new DataView(new ArrayBuffer(s)),f=0,d=a;d<a+n;d++)for(var h=0;h<e.itemSize;h++){var p=e.array[d*e.itemSize+h];r===t.FLOAT?l.setFloat32(f,p,!0):r===t.UNSIGNED_INT?l.setUint32(f,p,!0):r===t.UNSIGNED_SHORT?l.setUint16(f,p,!0):r===t.UNSIGNED_BYTE&&l.setUint8(f,p),f+=o}var m={buffer:_(l.buffer),byteOffset:c,byteLength:s};void 0!==i&&(m.target=i);i===t.ARRAY_BUFFER&&(m.byteStride=e.itemSize*o);return c+=s,u.bufferViews.push(m),{id:u.bufferViews.length-1,byteLength:0}}(e,i,a,n,f),p={bufferView:h.id,byteOffset:h.byteOffset,componentType:i,count:n,max:d.max,min:d.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return u.accessors||(u.accessors=[]),u.accessors.push(p),u.accessors.length-1}function L(t,r,a){v.images.has(t)||v.images.set(t,{});var n=v.images.get(t),i=r===e.RGBAFormat?"image/png":"image/jpeg",s=i+":flipY/"+a.toString();if(void 0!==n[s])return n[s];u.images||(u.images=[]);var f={mimeType:i};if(o.embedImages){var h=l=l||document.createElement("canvas");h.width=Math.min(t.width,o.maxTextureSize),h.height=Math.min(t.height,o.maxTextureSize),o.forcePowerOfTwoTextures&&!function(t){return e.MathUtils.isPowerOfTwo(t.width)&&e.MathUtils.isPowerOfTwo(t.height)}(h)&&(console.warn("GLTFExporter: Resized non-power-of-two image.",t),h.width=e.MathUtils.floorPowerOfTwo(h.width),h.height=e.MathUtils.floorPowerOfTwo(h.height));var p=h.getContext("2d");!0===a&&(p.translate(0,h.height),p.scale(1,-1)),p.drawImage(t,0,0,h.width,h.height),!0===o.binary?d.push(new Promise(function(e){h.toBlob(function(t){(function(e){u.bufferViews||(u.bufferViews=[]);return new Promise(function(t){var r=new window.FileReader;r.readAsArrayBuffer(e),r.onloadend=function(){var e=T(r.result),a={buffer:_(e),byteOffset:c,byteLength:e.byteLength};c+=e.byteLength,u.bufferViews.push(a),t(u.bufferViews.length-1)}})})(t).then(function(t){f.bufferView=t,e()})},i)})):f.uri=h.toDataURL(i)}else f.uri=t.src;u.images.push(f);var m=u.images.length-1;return n[s]=m,m}function S(e){if(v.textures.has(e))return v.textures.get(e);u.textures||(u.textures=[]);var t={sampler:function(e){u.samplers||(u.samplers=[]);var t={magFilter:r[e.magFilter],minFilter:r[e.minFilter],wrapS:r[e.wrapS],wrapT:r[e.wrapT]};return u.samplers.push(t),u.samplers.length-1}(e),source:L(e.image,e.format,e.flipY)};e.name&&(t.name=e.name),u.textures.push(t);var a=u.textures.length-1;return v.textures.set(e,a),a}function M(t){if(v.materials.has(t))return v.materials.get(t);if(t.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;u.materials||(u.materials=[]);var r={pbrMetallicRoughness:{}};t.isMeshBasicMaterial?(r.extensions={KHR_materials_unlit:{}},m.KHR_materials_unlit=!0):t.isGLTFSpecularGlossinessMaterial?(r.extensions={KHR_materials_pbrSpecularGlossiness:{}},m.KHR_materials_pbrSpecularGlossiness=!0):t.isMeshStandardMaterial||console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");var a=t.color.toArray().concat([t.opacity]);if(A(a,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=a),t.isMeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=t.metalness,r.pbrMetallicRoughness.roughnessFactor=t.roughness):t.isMeshBasicMaterial?(r.pbrMetallicRoughness.metallicFactor=0,r.pbrMetallicRoughness.roughnessFactor=.9):(r.pbrMetallicRoughness.metallicFactor=.5,r.pbrMetallicRoughness.roughnessFactor=.5),t.isGLTFSpecularGlossinessMaterial){r.pbrMetallicRoughness.baseColorFactor&&(r.extensions.KHR_materials_pbrSpecularGlossiness.diffuseFactor=r.pbrMetallicRoughness.baseColorFactor);var n=[1,1,1];t.specular.toArray(n,0),r.extensions.KHR_materials_pbrSpecularGlossiness.specularFactor=n,r.extensions.KHR_materials_pbrSpecularGlossiness.glossinessFactor=t.glossiness}if(t.metalnessMap||t.roughnessMap)if(t.metalnessMap===t.roughnessMap){var i={index:S(t.metalnessMap)};F(i,t.metalnessMap),r.pbrMetallicRoughness.metallicRoughnessTexture=i}else console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.");if(t.map){var o={index:S(t.map)};F(o,t.map),t.isGLTFSpecularGlossinessMaterial&&(r.extensions.KHR_materials_pbrSpecularGlossiness.diffuseTexture=o),r.pbrMetallicRoughness.baseColorTexture=o}if(t.isGLTFSpecularGlossinessMaterial&&t.specularMap){var s={index:S(t.specularMap)};F(s,t.specularMap),r.extensions.KHR_materials_pbrSpecularGlossiness.specularGlossinessTexture=s}if(t.emissive){var l=t.emissive.clone().multiplyScalar(t.emissiveIntensity).toArray();if(A(l,[0,0,0])||(r.emissiveFactor=l),t.emissiveMap){var c={index:S(t.emissiveMap)};F(c,t.emissiveMap),r.emissiveTexture=c}}if(t.normalMap){var f={index:S(t.normalMap)};t.normalScale&&-1!==t.normalScale.x&&(t.normalScale.x!==t.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),f.scale=t.normalScale.x),F(f,t.normalMap),r.normalTexture=f}if(t.aoMap){var d={index:S(t.aoMap),texCoord:1};1!==t.aoMapIntensity&&(d.strength=t.aoMapIntensity),F(d,t.aoMap),r.occlusionTexture=d}t.transparent?r.alphaMode="BLEND":t.alphaTest>0&&(r.alphaMode="MASK",r.alphaCutoff=t.alphaTest),t.side===e.DoubleSide&&(r.doubleSided=!0),""!==t.name&&(r.name=t.name),w(t,r),u.materials.push(r);var h=u.materials.length-1;return v.materials.set(t,h),h}function P(r){var a=[r.geometry.uuid];if(Array.isArray(r.material))for(var n=0,i=r.material.length;n<i;n++)a.push(r.material[n].uuid);else a.push(r.material.uuid);var s=a.join(":");if(v.meshes.has(s))return v.meshes.get(s);var l,c=r.geometry;l=r.isLineSegments?t.LINES:r.isLineLoop?t.LINE_LOOP:r.isLine?t.LINE_STRIP:r.isPoints?t.POINTS:r.material.wireframe?t.LINES:t.TRIANGLES,c.isBufferGeometry||(console.warn("GLTFExporter: Exporting THREE.Geometry will increase file size. Use THREE.BufferGeometry instead."),c=(new e.BufferGeometry).setFromObject(r));var f={},d={},h=[],p=[],m={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},g=c.getAttribute("normal");void 0===g||function(t){if(v.attributesNormalized.has(t))return!1;for(var r=new e.Vector3,a=0,n=t.count;a<n;a++)if(Math.abs(r.fromArray(t.array,3*a).length()-1)>5e-4)return!1;return!0}(g)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),c.setAttribute("normal",function(t){if(v.attributesNormalized.has(t))return v.attributesNormalized.get(t);for(var r=t.clone(),a=new e.Vector3,n=0,i=r.count;n<i;n++)a.fromArray(r.array,3*n),0===a.x&&0===a.y&&0===a.z?a.setX(1):a.normalize(),a.toArray(r.array,3*n);return v.attributesNormalized.set(t,r),r}(g)));var y=null;for(var A in c.attributes)if("morph"!==A.substr(0,5)){var b=c.attributes[A];A=m[A]||A.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(A)||(A="_"+A),v.attributes.has(x(b)))d[A]=v.attributes.get(x(b));else{y=null;var T=b.array;"JOINTS_0"!==A||T instanceof Uint16Array||T instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),y=new e.BufferAttribute(new Uint16Array(T),b.itemSize,b.normalized));var F=E(y||b,c);null!==F&&(d[A]=F,v.attributes.set(x(b),F))}}if(void 0!==g&&c.setAttribute("normal",g),0===Object.keys(d).length)return null;if(void 0!==r.morphTargetInfluences&&r.morphTargetInfluences.length>0){var _=[],L=[],S={};if(void 0!==r.morphTargetDictionary)for(var P in r.morphTargetDictionary)S[r.morphTargetDictionary[P]]=P;for(var n=0;n<r.morphTargetInfluences.length;++n){var N={},I=!1;for(var A in c.morphAttributes)if("position"===A||"normal"===A){var b=c.morphAttributes[A][n],k=A.toUpperCase(),R=c.attributes[A];if(v.attributes.has(x(b)))N[k]=v.attributes.get(x(b));else{var C=b.clone();if(!c.morphTargetsRelative)for(var U=0,O=b.count;U<O;U++)C.setXYZ(U,b.getX(U)-R.getX(U),b.getY(U)-R.getY(U),b.getZ(U)-R.getZ(U));N[k]=E(C,c),v.attributes.set(x(R),N[k])}}else I||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),I=!0);p.push(N),_.push(r.morphTargetInfluences[n]),void 0!==r.morphTargetDictionary&&L.push(S[n])}f.weights=_,L.length>0&&(f.extras={},f.extras.targetNames=L)}var D=o.forceIndices,B=Array.isArray(r.material);if(B&&0===c.groups.length)return null;!D&&null===c.index&&B&&(console.warn("THREE.GLTFExporter: Creating index for non-indexed multi-material mesh."),D=!0);var j=!1;if(null===c.index&&D){for(var G=[],n=0,V=c.attributes.position.count;n<V;n++)G[n]=n;c.setIndex(G),j=!0}for(var X=B?r.material:[r.material],H=B?c.groups:[{materialIndex:0,start:void 0,count:void 0}],n=0,V=H.length;n<V;n++){var z={mode:l,attributes:d};if(w(c,z),p.length>0&&(z.targets=p),null!==c.index){var Y=x(c.index);void 0===H[n].start&&void 0===H[n].count||(Y+=":"+H[n].start+":"+H[n].count),v.attributes.has(Y)?z.indices=v.attributes.get(Y):(z.indices=E(c.index,c,H[n].start,H[n].count),v.attributes.set(Y,z.indices)),null===z.indices&&delete z.indices}var Q=M(X[H[n].materialIndex]);null!==Q&&(z.material=Q),h.push(z)}j&&c.setIndex(null),f.primitives=h,u.meshes||(u.meshes=[]),u.meshes.push(f);var W=u.meshes.length-1;return v.meshes.set(s,W),W}function N(t,r){u.animations||(u.animations=[]);for(var n=(t=e.GLTFExporter.Utils.mergeMorphTargetTracks(t.clone(),r)).tracks,i=[],o=[],s=0;s<n.length;++s){var l=n[s],c=e.PropertyBinding.parseTrackName(l.name),f=e.PropertyBinding.findNode(r,c.nodeName),d=a[c.propertyName];if("bones"===c.objectName&&(f=!0===f.isSkinnedMesh?f.skeleton.getBoneByName(c.objectIndex):void 0),!f||!d)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',l.name),null;var p,m=l.values.length/l.times.length;d===a.morphTargetInfluences&&(m/=f.morphTargetInfluences.length),!0===l.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(p="CUBICSPLINE",m/=3):p=l.getInterpolation()===e.InterpolateDiscrete?"STEP":"LINEAR",o.push({input:E(new e.BufferAttribute(l.times,1)),output:E(new e.BufferAttribute(l.values,m)),interpolation:p}),i.push({sampler:o.length-1,target:{node:h.get(f),path:d}})}return u.animations.push({name:t.name||"clip_"+u.animations.length,samplers:o,channels:i}),u.animations.length-1}function I(t){var r=u.nodes[h.get(t)],a=t.skeleton;if(void 0===a)return null;var n=t.skeleton.bones[0];if(void 0===n)return null;for(var i=[],o=new Float32Array(16*a.bones.length),s=0;s<a.bones.length;++s)i.push(h.get(a.bones[s])),a.boneInverses[s].toArray(o,16*s);void 0===u.skins&&(u.skins=[]),u.skins.push({inverseBindMatrices:E(new e.BufferAttribute(o,16)),joints:i,skeleton:h.get(n)});var l=r.skin=u.skins.length-1;return l}function k(t){u.nodes||(u.nodes=[]);var r={};if(o.trs){var a=t.quaternion.toArray(),n=t.position.toArray(),i=t.scale.toArray();A(a,[0,0,0,1])||(r.rotation=a),A(n,[0,0,0])||(r.translation=n),A(i,[1,1,1])||(r.scale=i)}else t.matrixAutoUpdate&&t.updateMatrix(),A(t.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])||(r.matrix=t.matrix.elements);if(""!==t.name&&(r.name=String(t.name)),w(t,r),t.isMesh||t.isLine||t.isPoints){var s=P(t);null!==s&&(r.mesh=s)}else if(t.isCamera)r.camera=function(t){u.cameras||(u.cameras=[]);var r=t.isOrthographicCamera,a={type:r?"orthographic":"perspective"};r?a.orthographic={xmag:2*t.right,ymag:2*t.top,zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near}:a.perspective={aspectRatio:t.aspect,yfov:e.MathUtils.degToRad(t.fov),zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near};""!==t.name&&(a.name=t.type);return u.cameras.push(a),u.cameras.length-1}(t);else if(t.isDirectionalLight||t.isPointLight||t.isSpotLight)m.KHR_lights_punctual||(u.extensions=u.extensions||{},u.extensions.KHR_lights_punctual={lights:[]},m.KHR_lights_punctual=!0),r.extensions=r.extensions||{},r.extensions.KHR_lights_punctual={light:function(e){var t={};e.name&&(t.name=e.name);t.color=e.color.toArray(),t.intensity=e.intensity,e.isDirectionalLight?t.type="directional":e.isPointLight?(t.type="point",e.distance>0&&(t.range=e.distance)):e.isSpotLight&&(t.type="spot",e.distance>0&&(t.range=e.distance),t.spot={},t.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,t.spot.outerConeAngle=e.angle);void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2.");!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1.");var r=u.extensions.KHR_lights_punctual.lights;return r.push(t),r.length-1}(t)};else if(t.isLight)return console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",t),null;if(t.isSkinnedMesh&&p.push(t),t.children.length>0){for(var l=[],c=0,f=t.children.length;c<f;c++){var d=t.children[c];if(d.visible||!1===o.onlyVisible){var v=k(d);null!==v&&l.push(v)}}l.length>0&&(r.children=l)}u.nodes.push(r);var g=u.nodes.length-1;return h.set(t,g),g}function R(e){u.scenes||(u.scenes=[],u.scene=0);var t={};""!==e.name&&(t.name=e.name),u.scenes.push(t);for(var r=[],a=0,n=e.children.length;a<n;a++){var i=e.children[a];if(i.visible||!1===o.onlyVisible){var s=k(i);null!==s&&r.push(s)}}r.length>0&&(t.nodes=r),w(e,t)}!function(t){t=t instanceof Array?t:[t];for(var r=[],a=0;a<t.length;a++)t[a]instanceof e.Scene?R(t[a]):r.push(t[a]);r.length>0&&function(t){var r=new e.Scene;r.name="AuxScene";for(var a=0;a<t.length;a++)r.children.push(t[a]);R(r)}(r);for(var a=0;a<p.length;++a)I(p[a]);for(var a=0;a<o.animations.length;++a)N(o.animations[a],t[0])}(n),Promise.all(d).then(function(){var e=new Blob(f,{type:"application/octet-stream"}),t=Object.keys(m);if(t.length>0&&(u.extensionsUsed=t),u.buffers&&u.buffers.length>0&&(u.buffers[0].byteLength=e.size),!0===o.binary){var r=new window.FileReader;r.readAsArrayBuffer(e),r.onloadend=function(){var e=T(r.result),t=new DataView(new ArrayBuffer(8));t.setUint32(0,e.byteLength,!0),t.setUint32(4,5130562,!0);var a=T(function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;for(var t=new Uint8Array(new ArrayBuffer(e.length)),r=0,a=e.length;r<a;r++){var n=e.charCodeAt(r);t[r]=n>255?32:n}return t.buffer}(JSON.stringify(u)),32),n=new DataView(new ArrayBuffer(8));n.setUint32(0,a.byteLength,!0),n.setUint32(4,1313821514,!0);var o=new ArrayBuffer(12),s=new DataView(o);s.setUint32(0,1179937895,!0),s.setUint32(4,2,!0);var l=12+n.byteLength+a.byteLength+t.byteLength+e.byteLength;s.setUint32(8,l,!0);var c=new Blob([o,n,a,t,e],{type:"application/octet-stream"}),f=new window.FileReader;f.readAsArrayBuffer(c),f.onloadend=function(){i(f.result)}}}else if(u.buffers&&u.buffers.length>0){var r=new window.FileReader;r.readAsDataURL(e),r.onloadend=function(){var e=r.result;u.buffers[0].uri=e,i(u)}}else i(u)})}},e.GLTFExporter.Utils={insertKeyframe:function(e,t){var r,a=e.getValueSize(),n=new e.TimeBufferType(e.times.length+1),i=new e.ValueBufferType(e.values.length+a),o=e.createInterpolant(new e.ValueBufferType(a));if(0===e.times.length){n[0]=t;for(var s=0;s<a;s++)i[s]=0;r=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<.001)return 0;n[0]=t,n.set(e.times,1),i.set(o.evaluate(t),0),i.set(e.values,a),r=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<.001)return e.times.length-1;n[n.length-1]=t,n.set(e.times,0),i.set(e.values,0),i.set(o.evaluate(t),e.values.length),r=n.length-1}else for(var s=0;s<e.times.length;s++){if(Math.abs(e.times[s]-t)<.001)return s;if(e.times[s]<t&&e.times[s+1]>t){n.set(e.times.slice(0,s+1),0),n[s+1]=t,n.set(e.times.slice(s+1),s+2),i.set(e.values.slice(0,(s+1)*a),0),i.set(o.evaluate(t),(s+1)*a),i.set(e.values.slice((s+1)*a),(s+2)*a),r=s+1;break}}return e.times=n,e.values=i,r},mergeMorphTargetTracks:function(t,r){for(var a=[],n={},i=t.tracks,o=0;o<i.length;++o){var s=i[o],l=e.PropertyBinding.parseTrackName(s.name),u=e.PropertyBinding.findNode(r,l.nodeName);if("morphTargetInfluences"===l.propertyName&&void 0!==l.propertyIndex){if(s.createInterpolant!==s.InterpolantFactoryMethodDiscrete&&s.createInterpolant!==s.InterpolantFactoryMethodLinear){if(s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(s=s.clone()).setInterpolation(e.InterpolateLinear)}var c,f=u.morphTargetInfluences.length,d=u.morphTargetDictionary[l.propertyIndex];if(void 0===d)throw new Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0!==n[u.uuid]){var h=s.createInterpolant(new s.ValueBufferType(1));c=n[u.uuid];for(var p=0;p<c.times.length;p++)c.values[p*f+d]=h.evaluate(c.times[p]);for(var p=0;p<s.times.length;p++){var m=this.insertKeyframe(c,s.times[p]);c.values[m*f+d]=s.values[p]}}else{for(var v=new((c=s.clone()).ValueBufferType)(f*c.times.length),p=0;p<c.times.length;p++)v[p*f+d]=c.values[p];c.name=".morphTargetInfluences",c.values=v,n[u.uuid]=c,a.push(c)}}else a.push(s)}return t.tracks=a,t}},e.GLTFExporter}),e("skylark-threejs-ex/exporters/ColladaExporter",["skylark-threejs"],function(e){return e.ColladaExporter=function(){},e.ColladaExporter.prototype={constructor:e.ColladaExporter,parse:function(t,r,a){a=a||{},""!==(a=Object.assign({version:"1.4.1",author:null,textureDirectory:""},a)).textureDirectory&&(a.textureDirectory=`${a.textureDirectory}/`.replace(/\\/g,"/").replace(/\/+/g,"/"));var n,i,o=a.version;if("1.4.1"!==o&&"1.5.0"!==o)return console.warn(`ColladaExporter : Version ${o} not supported for export. Only 1.4.1 and 1.5.0.`),null;function s(e,t){n=n||document.createElement("canvas"),i=i||n.getContext("2d"),n.width=e.naturalWidth,n.height=e.naturalHeight,i.drawImage(e,0,0);var r=n.toDataURL(`image/${t}`,1).replace(/^data:image\/(png|jpg);base64,/,"");return function(e){for(var t=atob(e),r=new Uint8Array(t.length),a=0,n=r.length;a<n;a++)r[a]=t.charCodeAt(a);return r}(r)}var l,u=["getX","getY","getZ","getW"];function c(e){if(e.isInterleavedBufferAttribute){for(var t=new e.array.constructor(e.count*e.itemSize),r=e.itemSize,a=0,n=e.count;a<n;a++)for(var i=0;i<r;i++)t[a*r+i]=e[u[i]](a);return t}return e.array}function f(e,t,r){return Array.isArray(e)?e.slice(t,t+r):new e.constructor(e.buffer,t*e.BYTES_PER_ELEMENT,r)}function d(e,t,r,a){var n=c(e),i=`<source id="${t}">`+`<float_array id="${t}-array" count="${n.length}">`+n.join(" ")+"</float_array><technique_common>"+`<accessor source="#${t}-array" count="${Math.floor(n.length/e.itemSize)}" stride="${e.itemSize}">`+r.map(e=>`<param name="${e}" type="${a}" />`).join("")+"</accessor></technique_common></source>";return i}function h(e){var t=v.get(e);if(null==t){t=`image-${y.length+1}`;var r=e.name||t,n=`<image id="${t}" name="${r}">`;n+="1.5.0"===o?`<init_from><ref>${a.textureDirectory}${r}.png</ref></init_from>`:`<init_from>${a.textureDirectory}${r}.png</init_from>`,n+="</image>",y.push(n),v.set(e,t),g.push({directory:a.textureDirectory,name:r,ext:"png",data:s(e.image,"png"),original:e})}return t}var p=new WeakMap,m=new WeakMap,v=new WeakMap,g=[],y=[],x=[],A=[],b=[],T=function t(r){var a=`<node name="${r.name}">`;a+=function(t){return t.updateMatrix(),(l=l||new e.Matrix4).copy(t.matrix),l.transpose(),`<matrix>${l.toArray().join(" ")}</matrix>`}(r);if(r instanceof e.Mesh&&null!=r.geometry){var n=function(t){var r=p.get(t);if(!r){var a=t;a instanceof e.Geometry&&(a=(new e.BufferGeometry).fromGeometry(a));var n=`Mesh${x.length+1}`,i=a.index?a.index.count*a.index.itemSize:a.attributes.position.count,o=null!=a.groups&&0!==a.groups.length?a.groups:[{start:0,count:i,materialIndex:0}],s=t.name?` name="${t.name}"`:"",l=`<geometry id="${n}"${s}><mesh>`,u=`${n}-position`,h=`${n}-vertices`;l+=d(a.attributes.position,u,["X","Y","Z"],"float"),l+=`<vertices id="${h}"><input semantic="POSITION" source="#${u}" /></vertices>`;var m=`<input semantic="VERTEX" source="#${h}" offset="0" />`;if("normal"in a.attributes){var v=`${n}-normal`;l+=d(a.attributes.normal,v,["X","Y","Z"],"float"),m+=`<input semantic="NORMAL" source="#${v}" offset="0" />`}if("uv"in a.attributes){var g=`${n}-texcoord`;l+=d(a.attributes.uv,g,["S","T"],"float"),m+=`<input semantic="TEXCOORD" source="#${g}" offset="0" set="0" />`}if("color"in a.attributes){var y=`${n}-color`;l+=d(a.attributes.color,y,["X","Y","Z"],"uint8"),m+=`<input semantic="COLOR" source="#${y}" offset="0" />`}var A=null;if(a.index)A=c(a.index);else for(var b=0,T=(A=new Array(i)).length;b<T;b++)A[b]=b;for(var b=0,T=o.length;b<T;b++){var w=o[b],F=f(A,w.start,w.count),_=F.length/3;l+=`<triangles material="MESH_MATERIAL_${w.materialIndex}" count="${_}">`,l+=m,l+=`<p>${F.join(" ")}</p>`,l+="</triangles>"}l+="</mesh></geometry>",x.push(l),r={meshid:n,bufferGeometry:a},p.set(t,r)}return r}(r.geometry),i=n.meshid,o=n.bufferGeometry,s=null,u=[],v=r.material||new e.MeshBasicMaterial,g=Array.isArray(v)?v:[v];u=o.groups.length>g.length?new Array(o.groups.length):new Array(g.length),s=u.fill().map((t,r)=>(function(t){var r=m.get(t);if(null==r){r=`Mat${A.length+1}`;var a="phong";t instanceof e.MeshLambertMaterial?a="lambert":t instanceof e.MeshBasicMaterial&&(a="constant",null!==t.map&&console.warn("ColladaExporter: Texture maps not supported with MeshBasicMaterial."));var n=t.emissive?t.emissive:new e.Color(0,0,0),i=t.color?t.color:new e.Color(0,0,0),o=t.specular?t.specular:new e.Color(1,1,1),s=t.shininess||0,l=t.reflectivity||0,u="";!0===t.transparent&&(u+="<transparent>"+(t.map?'<texture texture="diffuse-sampler"></texture>':"<float>1</float>")+"</transparent>",t.opacity<1&&(u+=`<transparency><float>${t.opacity}</float></transparency>`));var c=`<technique sid="common"><${a}>`+"<emission>"+(t.emissiveMap?'<texture texture="emissive-sampler" texcoord="TEXCOORD" />':`<color sid="emission">${n.r} ${n.g} ${n.b} 1</color>`)+"</emission>"+("constant"!==a?"<diffuse>"+(t.map?'<texture texture="diffuse-sampler" texcoord="TEXCOORD" />':`<color sid="diffuse">${i.r} ${i.g} ${i.b} 1</color>`)+"</diffuse>":"")+("constant"!==a?"<bump>"+(t.normalMap?'<texture texture="bump-sampler" texcoord="TEXCOORD" />':"")+"</bump>":"")+("phong"===a?`<specular><color sid="specular">${o.r} ${o.g} ${o.b} 1</color></specular>`+"<shininess>"+(t.specularMap?'<texture texture="specular-sampler" texcoord="TEXCOORD" />':`<float sid="shininess">${s}</float>`)+"</shininess>":"")+`<reflective><color>${i.r} ${i.g} ${i.b} 1</color></reflective>`+`<reflectivity><float>${l}</float></reflectivity>`+u+`</${a}></technique>`,f=`<effect id="${r}-effect">`+"<profile_COMMON>"+(t.map?'<newparam sid="diffuse-surface"><surface type="2D">'+`<init_from>${h(t.map)}</init_from>`+'</surface></newparam><newparam sid="diffuse-sampler"><sampler2D><source>diffuse-surface</source></sampler2D></newparam>':"")+(t.specularMap?'<newparam sid="specular-surface"><surface type="2D">'+`<init_from>${h(t.specularMap)}</init_from>`+'</surface></newparam><newparam sid="specular-sampler"><sampler2D><source>specular-surface</source></sampler2D></newparam>':"")+(t.emissiveMap?'<newparam sid="emissive-surface"><surface type="2D">'+`<init_from>${h(t.emissiveMap)}</init_from>`+'</surface></newparam><newparam sid="emissive-sampler"><sampler2D><source>emissive-surface</source></sampler2D></newparam>':"")+(t.normalMap?'<newparam sid="bump-surface"><surface type="2D">'+`<init_from>${h(t.normalMap)}</init_from>`+'</surface></newparam><newparam sid="bump-sampler"><sampler2D><source>bump-surface</source></sampler2D></newparam>':"")+c+(t.side===e.DoubleSide?'<extra><technique profile="THREEJS"><double_sided sid="double_sided" type="int">1</double_sided></technique></extra>':"")+"</profile_COMMON></effect>",d=t.name?` name="${t.name}"`:"",p=`<material id="${r}"${d}><instance_effect url="#${r}-effect" /></material>`;b.push(p),A.push(f),m.set(t,r)}return r})(g[r%g.length])),a+=`<instance_geometry url="#${i}">`+(null!=s?"<bind_material><technique_common>"+s.map((e,t)=>`<instance_material symbol="MESH_MATERIAL_${t}" target="#${e}" >`+'<bind_vertex_input semantic="TEXCOORD" input_semantic="TEXCOORD" input_set="0" /></instance_material>').join("")+"</technique_common></bind_material>":"")+"</instance_geometry>"}r.children.forEach(e=>a+=t(e));a+="</node>";return a}(t),w="1.4.1"===o?"http://www.collada.org/2005/11/COLLADASchema":"https://www.khronos.org/collada/",F='<?xml version="1.0" encoding="UTF-8" standalone="no" ?>'+`<COLLADA xmlns="${w}" version="${o}">`+"<asset><contributor><authoring_tool>three.js Collada Exporter</authoring_tool>"+(null!==a.author?`<author>${a.author}</author>`:"")+"</contributor>"+`<created>${(new Date).toISOString()}</created>`+`<modified>${(new Date).toISOString()}</modified>`+"<up_axis>Y_UP</up_axis></asset>";F+=`<library_images>${y.join("")}</library_images>`,F+=`<library_effects>${A.join("")}</library_effects>`,F+=`<library_materials>${b.join("")}</library_materials>`,F+=`<library_geometries>${x.join("")}</library_geometries>`,F+=`<library_visual_scenes><visual_scene id="Scene" name="scene">${T}</visual_scene></library_visual_scenes>`,F+='<scene><instance_visual_scene url="#Scene"/></scene>';var _,E,L,S,M,P,N={data:(_=F+="</COLLADA>",E=/^<\//,L=/(\?>$)|(\/>$)/,S=/<[^>]+>[^<]*<\/[^<]+>/,M=((e,t)=>t>0?e+M(e,t-1):""),P=0,_.match(/(<[^>]+>[^<]+<\/[^<]+>)|(<[^>]+>)/g).map(e=>{S.test(e)||L.test(e)||!E.test(e)||P--;var t=`${M("  ",P)}${e}`;return S.test(e)||L.test(e)||E.test(e)||P++,t}).join("\n")),textures:g};return"function"==typeof r&&requestAnimationFrame(()=>r(N)),N}},e.ColladaExporter}),e("skylark-threejs-ex/exporters/PLYExporter",["skylark-threejs"],function(e){return e.PLYExporter=function(){},e.PLYExporter.prototype={constructor:e.PLYExporter,parse:function(t,r,a){function n(e){t.traverse(function(t){if(!0===t.isMesh){var r=t,a=r.geometry;!0===a.isGeometry&&(a=o.get(a)),!0===a.isBufferGeometry&&void 0!==a.getAttribute("position")&&e(r,a)}})}r&&"object"==typeof r&&(console.warn('THREE.PLYExporter: The options parameter is now the third argument to the "parse" function. See the documentation for the new API.'),a=r,r=void 0);var i=(a=Object.assign({binary:!1,excludeAttributes:[],littleEndian:!1},a)).excludeAttributes,o=new WeakMap,s=!1,l=!1,u=!1,c=0,f=0;t.traverse(function(t){if(!0===t.isMesh){var r=t,a=r.geometry;if(!0===a.isGeometry){var n=o.get(a)||(new e.BufferGeometry).setFromObject(r);o.set(a,n),a=n}if(!0===a.isBufferGeometry){var i=a.getAttribute("position"),d=a.getAttribute("normal"),h=a.getAttribute("uv"),p=a.getAttribute("color"),m=a.getIndex();if(void 0===i)return;c+=i.count,f+=m?m.count/3:i.count/3,void 0!==d&&(s=!0),void 0!==h&&(u=!0),void 0!==p&&(l=!0)}}});var d=-1===i.indexOf("index");if(s=s&&-1===i.indexOf("normal"),l=l&&-1===i.indexOf("color"),u=u&&-1===i.indexOf("uv"),d&&f!==Math.floor(f))return console.error("PLYExporter: Failed to generate a valid PLY file with triangle indices because the number of indices is not divisible by 3."),null;var h="ply\n"+`format ${a.binary?a.littleEndian?"binary_little_endian":"binary_big_endian":"ascii"} 1.0\n`+`element vertex ${c}\n`+"property float x\nproperty float y\nproperty float z\n";!0===s&&(h+="property float nx\nproperty float ny\nproperty float nz\n"),!0===u&&(h+="property float s\nproperty float t\n"),!0===l&&(h+="property uchar red\nproperty uchar green\nproperty uchar blue\n"),!0===d&&(h+=`element face ${f}\n`+"property list uchar int vertex_index\n"),h+="end_header\n";var p=new e.Vector3,m=new e.Matrix3,v=null;if(!0===a.binary){var g=(new TextEncoder).encode(h),y=c*(12+(s?12:0)+(l?3:0)+(u?8:0)),x=d?13*f:0,A=new DataView(new ArrayBuffer(g.length+y+x));new Uint8Array(A.buffer).set(g,0);var b=g.length,T=g.length+y,w=0;n(function(e,t){var r=t.getAttribute("position"),n=t.getAttribute("normal"),i=t.getAttribute("uv"),o=t.getAttribute("color"),c=t.getIndex();m.getNormalMatrix(e.matrixWorld);for(var f=0,h=r.count;f<h;f++)p.x=r.getX(f),p.y=r.getY(f),p.z=r.getZ(f),p.applyMatrix4(e.matrixWorld),A.setFloat32(b,p.x,a.littleEndian),b+=4,A.setFloat32(b,p.y,a.littleEndian),b+=4,A.setFloat32(b,p.z,a.littleEndian),b+=4,!0===s&&(null!=n?(p.x=n.getX(f),p.y=n.getY(f),p.z=n.getZ(f),p.applyMatrix3(m).normalize(),A.setFloat32(b,p.x,a.littleEndian),b+=4,A.setFloat32(b,p.y,a.littleEndian),b+=4,A.setFloat32(b,p.z,a.littleEndian),b+=4):(A.setFloat32(b,0,a.littleEndian),b+=4,A.setFloat32(b,0,a.littleEndian),b+=4,A.setFloat32(b,0,a.littleEndian),b+=4)),!0===u&&(null!=i?(A.setFloat32(b,i.getX(f),a.littleEndian),b+=4,A.setFloat32(b,i.getY(f),a.littleEndian),b+=4):!1!==u&&(A.setFloat32(b,0,a.littleEndian),b+=4,A.setFloat32(b,0,a.littleEndian),b+=4)),!0===l&&(null!=o?(A.setUint8(b,Math.floor(255*o.getX(f))),b+=1,A.setUint8(b,Math.floor(255*o.getY(f))),b+=1,A.setUint8(b,Math.floor(255*o.getZ(f))),b+=1):(A.setUint8(b,255),b+=1,A.setUint8(b,255),b+=1,A.setUint8(b,255),b+=1));if(!0===d)if(null!==c)for(var f=0,h=c.count;f<h;f+=3)A.setUint8(T,3),T+=1,A.setUint32(T,c.getX(f+0)+w,a.littleEndian),T+=4,A.setUint32(T,c.getX(f+1)+w,a.littleEndian),T+=4,A.setUint32(T,c.getX(f+2)+w,a.littleEndian),T+=4;else for(var f=0,h=r.count;f<h;f+=3)A.setUint8(T,3),T+=1,A.setUint32(T,w+f,a.littleEndian),T+=4,A.setUint32(T,w+f+1,a.littleEndian),T+=4,A.setUint32(T,w+f+2,a.littleEndian),T+=4;w+=r.count}),v=A.buffer}else{var w=0,F="",_="";n(function(e,t){var r=t.getAttribute("position"),a=t.getAttribute("normal"),n=t.getAttribute("uv"),i=t.getAttribute("color"),o=t.getIndex();m.getNormalMatrix(e.matrixWorld);for(var c=0,h=r.count;c<h;c++){p.x=r.getX(c),p.y=r.getY(c),p.z=r.getZ(c),p.applyMatrix4(e.matrixWorld);var v=p.x+" "+p.y+" "+p.z;!0===s&&(null!=a?(p.x=a.getX(c),p.y=a.getY(c),p.z=a.getZ(c),p.applyMatrix3(m).normalize(),v+=" "+p.x+" "+p.y+" "+p.z):v+=" 0 0 0"),!0===u&&(null!=n?v+=" "+n.getX(c)+" "+n.getY(c):!1!==u&&(v+=" 0 0")),!0===l&&(v+=null!=i?" "+Math.floor(255*i.getX(c))+" "+Math.floor(255*i.getY(c))+" "+Math.floor(255*i.getZ(c)):" 255 255 255"),F+=v+"\n"}if(!0===d){if(null!==o)for(var c=0,h=o.count;c<h;c+=3)_+=`3 ${o.getX(c+0)+w}`,_+=` ${o.getX(c+1)+w}`,_+=` ${o.getX(c+2)+w}\n`;else for(var c=0,h=r.count;c<h;c+=3)_+=`3 ${w+c} ${w+c+1} ${w+c+2}\n`;f+=o?o.count/3:r.count/3}w+=r.count}),v=`${h}${F}${d?`${_}\n`:"\n"}`}return"function"==typeof r&&requestAnimationFrame(()=>r(v)),v}},e.PLYExporter}),e("skylark-threejs-ex/main",["skylark-threejs","./shaders/CopyShader","./shaders/BokehShader","./shaders/SAOShader","./shaders/DepthLimitedBlurShader","./shaders/UnpackDepthRGBAShader","./shaders/ConvolutionShader","./shaders/LuminosityHighPassShader","./shaders/FXAAShader","./shaders/SSAOShader","./shaders/FilmShader","./shaders/DotScreenShader","./shaders/LuminosityShader","./shaders/SobelOperatorShader","./shaders/ColorifyShader","./shaders/ToneMapShader","./shaders/TechnicolorShader","./shaders/HueSaturationShader","./postprocessing/EffectComposer","./postprocessing/RenderPass","./postprocessing/ShaderPass","./postprocessing/MaskPass","./curves/NURBSCurve","./curves/NURBSSurface","./curves/NURBSUtils","./objects/Lensflare","./objects/Reflector","./objects/Refractor","./loaders/TTFLoader","./loaders/3MFLoader","./loaders/AMFLoader","./loaders/AssimpLoader","./loaders/ColladaLoader","./loaders/DRACOLoader","./loaders/FBXLoader","./loaders/GCodeLoader","./loaders/GLTFLoader","./loaders/MTLLoader","./loaders/OBJLoader","./loaders/PCDLoader","./loaders/PLYLoader","./loaders/PRWMLoader","./loaders/STLLoader","./loaders/SVGLoader","./loaders/TDSLoader","./loaders/VTKLoader","./loaders/XLoader","./loaders/DDSLoader","./loaders/PVRLoader","./loaders/TGALoader","./loaders/KTXLoader","./modifiers/SimplifyModifier","./modifiers/SubdivisionModifier","./exporters/DRACOExporter","./exporters/OBJExporter","./exporters/STLExporter","./exporters/GLTFExporter","./exporters/ColladaExporter","./exporters/PLYExporter"],function(e){return e}),e("skylark-threejs-ex",["skylark-threejs-ex/main"],function(e){return e})}(r),!a){var o=require("skylark-langx-ns");n?module.exports=o:t.skylarkjs=o}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-threejs-ex.js.map
