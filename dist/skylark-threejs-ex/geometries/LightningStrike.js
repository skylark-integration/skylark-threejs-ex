/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs","../math/SimplexNoise"],function(t,i){"use strict";var e=function(i){t.BufferGeometry.call(this),this.type="LightningStrike",i=i||{},this.init(e.copyParameters(i,i)),this.createMesh()};return e.prototype=Object.create(t.BufferGeometry.prototype),e.prototype.constructor=e,e.prototype.isLightningStrike=!0,e.RAY_INITIALIZED=0,e.RAY_UNBORN=1,e.RAY_PROPAGATING=2,e.RAY_STEADY=3,e.RAY_VANISHING=4,e.RAY_EXTINGUISHED=5,e.COS30DEG=Math.cos(30*Math.PI/180),e.SIN30DEG=Math.sin(30*Math.PI/180),e.createRandomGenerator=function(){for(var t=[],i=0;i<2053;i++)t.push(Math.random());var e={currentSeed:0,random:function(){var i=t[e.currentSeed];return e.currentSeed=(e.currentSeed+1)%2053,i},getSeed:function(){return e.currentSeed/2053},setSeed:function(t){e.currentSeed=Math.floor(2053*t)%2053}};return e},e.copyParameters=function(i,e){e=e||{};var r=function(t){return e===i?t:t.clone()};return(i=i||{}).sourceOffset=void 0!==e.sourceOffset?r(e.sourceOffset):new t.Vector3(0,100,0),i.destOffset=void 0!==e.destOffset?r(e.destOffset):new t.Vector3(0,0,0),i.timeScale=void 0!==e.timeScale?e.timeScale:1,i.roughness=void 0!==e.roughness?e.roughness:.9,i.straightness=void 0!==e.straightness?e.straightness:.7,i.up0=void 0!==e.up0?r(e.up0):new t.Vector3(0,0,1),i.up1=void 0!==e.up1?r(e.up1):new t.Vector3(0,0,1),i.radius0=void 0!==e.radius0?e.radius0:1,i.radius1=void 0!==e.radius1?e.radius1:1,i.radius0Factor=void 0!==e.radius0Factor?e.radius0Factor:.5,i.radius1Factor=void 0!==e.radius1Factor?e.radius1Factor:.2,i.minRadius=void 0!==e.minRadius?e.minRadius:.2,i.isEternal=void 0!==e.isEternal?e.isEternal:void 0===e.birthTime||void 0===e.deathTime,i.birthTime=e.birthTime,i.deathTime=e.deathTime,i.propagationTimeFactor=void 0!==e.propagationTimeFactor?e.propagationTimeFactor:.1,i.vanishingTimeFactor=void 0!==e.vanishingTimeFactor?e.vanishingTimeFactor:.9,i.subrayPeriod=void 0!==e.subrayPeriod?e.subrayPeriod:4,i.subrayDutyCycle=void 0!==e.subrayDutyCycle?e.subrayDutyCycle:.6,i.maxIterations=void 0!==e.maxIterations?e.maxIterations:9,i.isStatic=void 0!==e.isStatic&&e.isStatic,i.ramification=void 0!==e.ramification?e.ramification:5,i.maxSubrayRecursion=void 0!==e.maxSubrayRecursion?e.maxSubrayRecursion:3,i.recursionProbability=void 0!==e.recursionProbability?e.recursionProbability:.6,i.generateUVs=void 0!==e.generateUVs&&e.generateUVs,i.randomGenerator=e.randomGenerator,i.noiseSeed=e.noiseSeed,i.onDecideSubrayCreation=e.onDecideSubrayCreation,i.onSubrayCreation=e.onSubrayCreation,i},e.prototype.update=function(t){this.isStatic||(this.rayParameters.isEternal||this.rayParameters.birthTime<=t&&t<=this.rayParameters.deathTime?(this.updateMesh(t),t<this.subrays[0].endPropagationTime?this.state=e.RAY_PROPAGATING:t>this.subrays[0].beginVanishingTime?this.state=e.RAY_VANISHING:this.state=e.RAY_STEADY,this.visible=!0):(this.visible=!1,t<this.rayParameters.birthTime?this.state=e.RAY_UNBORN:this.state=e.RAY_EXTINGUISHED))},e.prototype.init=function(r){this.rayParameters=r,this.maxIterations=void 0!==r.maxIterations?Math.floor(r.maxIterations):9,r.maxIterations=this.maxIterations,this.isStatic=void 0!==r.isStatic&&r.isStatic,r.isStatic=this.isStatic,this.ramification=void 0!==r.ramification?Math.floor(r.ramification):5,r.ramification=this.ramification,this.maxSubrayRecursion=void 0!==r.maxSubrayRecursion?Math.floor(r.maxSubrayRecursion):3,r.maxSubrayRecursion=this.maxSubrayRecursion,this.recursionProbability=void 0!==r.recursionProbability?r.recursionProbability:.6,r.recursionProbability=this.recursionProbability,this.generateUVs=void 0!==r.generateUVs&&r.generateUVs,r.generateUVs=this.generateUVs,void 0!==r.randomGenerator?(this.randomGenerator=r.randomGenerator,this.seedGenerator=r.randomGenerator,void 0!==r.noiseSeed&&this.seedGenerator.setSeed(r.noiseSeed)):(this.randomGenerator=e.createRandomGenerator(),this.seedGenerator=Math),void 0!==r.onDecideSubrayCreation?this.onDecideSubrayCreation=r.onDecideSubrayCreation:(this.createDefaultSubrayCreationCallbacks(),void 0!==r.onSubrayCreation&&(this.onSubrayCreation=r.onSubrayCreation)),this.state=e.RAY_INITIALIZED,this.maxSubrays=Math.ceil(1+Math.pow(this.ramification,Math.max(0,this.maxSubrayRecursion-1))),r.maxSubrays=this.maxSubrays,this.maxRaySegments=2*(1<<this.maxIterations),this.subrays=[];for(var s=0;s<this.maxSubrays;s++)this.subrays.push(this.createSubray());this.raySegments=[];for(s=0;s<this.maxRaySegments;s++)this.raySegments.push(this.createSegment());this.time=0,this.timeFraction=0,this.currentSegmentCallback=null,this.currentCreateTriangleVertices=this.generateUVs?this.createTriangleVerticesWithUVs:this.createTriangleVerticesWithoutUVs,this.numSubrays=0,this.currentSubray=null,this.currentSegmentIndex=0,this.isInitialSegment=!1,this.subrayProbability=0,this.currentVertex=0,this.currentIndex=0,this.currentCoordinate=0,this.currentUVCoordinate=0,this.vertices=null,this.uvs=null,this.indices=null,this.positionAttribute=null,this.uvsAttribute=null,this.simplexX=new i(this.seedGenerator),this.simplexY=new i(this.seedGenerator),this.simplexZ=new i(this.seedGenerator),this.forwards=new t.Vector3,this.forwardsFill=new t.Vector3,this.side=new t.Vector3,this.down=new t.Vector3,this.middlePos=new t.Vector3,this.middleLinPos=new t.Vector3,this.newPos=new t.Vector3,this.vPos=new t.Vector3,this.cross1=new t.Vector3},e.prototype.createMesh=function(){var i=1<<this.maxIterations,e=3*(i+1)*this.maxSubrays,r=18*i*this.maxSubrays;this.vertices=new Float32Array(3*e),this.indices=new Uint32Array(r),this.generateUVs&&(this.uvs=new Float32Array(2*e)),this.fillMesh(0),this.setIndex(new t.Uint32BufferAttribute(this.indices,1)),this.positionAttribute=new t.Float32BufferAttribute(this.vertices,3),this.setAttribute("position",this.positionAttribute),this.generateUVs&&(this.uvsAttribute=new t.Float32BufferAttribute(new Float32Array(this.uvs),2),this.setAttribute("uv",this.uvsAttribute)),this.isStatic||(this.index.usage=t.DynamicDrawUsage,this.positionAttribute.usage=t.DynamicDrawUsage,this.generateUVs&&(this.uvsAttribute.usage=t.DynamicDrawUsage)),this.vertices=this.positionAttribute.array,this.indices=this.index.array,this.generateUVs&&(this.uvs=this.uvsAttribute.array)},e.prototype.updateMesh=function(t){this.fillMesh(t),this.drawRange.count=this.currentIndex,this.index.needsUpdate=!0,this.positionAttribute.needsUpdate=!0,this.generateUVs&&(this.uvsAttribute.needsUpdate=!0)},e.prototype.fillMesh=function(t){var i=this;this.currentVertex=0,this.currentIndex=0,this.currentCoordinate=0,this.currentUVCoordinate=0,this.fractalRay(t,function(e){var r=i.currentSubray;t<r.birthTime||(this.rayParameters.isEternal&&0==i.currentSubray.recursion?(i.createPrism(e),i.onDecideSubrayCreation(e,i)):t<r.endPropagationTime?i.timeFraction>=e.fraction0*r.propagationTimeFactor&&(i.createPrism(e),i.onDecideSubrayCreation(e,i)):t<r.beginVanishingTime?(i.createPrism(e),i.onDecideSubrayCreation(e,i)):(i.timeFraction<=r.vanishingTimeFactor+e.fraction1*(1-r.vanishingTimeFactor)&&i.createPrism(e),i.onDecideSubrayCreation(e,i)))})},e.prototype.addNewSubray=function(){return this.subrays[this.numSubrays++]},e.prototype.initSubray=function(t,i){t.pos0.copy(i.sourceOffset),t.pos1.copy(i.destOffset),t.up0.copy(i.up0),t.up1.copy(i.up1),t.radius0=i.radius0,t.radius1=i.radius1,t.birthTime=i.birthTime,t.deathTime=i.deathTime,t.timeScale=i.timeScale,t.roughness=i.roughness,t.straightness=i.straightness,t.propagationTimeFactor=i.propagationTimeFactor,t.vanishingTimeFactor=i.vanishingTimeFactor,t.maxIterations=this.maxIterations,t.seed=void 0!==i.noiseSeed?i.noiseSeed:0,t.recursion=0},e.prototype.fractalRay=function(i,e){this.time=i,this.currentSegmentCallback=e,this.numSubrays=0,this.initSubray(this.addNewSubray(),this.rayParameters);for(var r=0;r<this.numSubrays;r++){var s=this.subrays[r];this.currentSubray=s,this.randomGenerator.setSeed(s.seed),s.endPropagationTime=t.MathUtils.lerp(s.birthTime,s.deathTime,s.propagationTimeFactor),s.beginVanishingTime=t.MathUtils.lerp(s.deathTime,s.birthTime,1-s.vanishingTimeFactor);var a=this.randomGenerator.random;s.linPos0.set(a(),a(),a()).multiplyScalar(1e3),s.linPos1.set(a(),a(),a()).multiplyScalar(1e3),this.timeFraction=(i-s.birthTime)/(s.deathTime-s.birthTime),this.currentSegmentIndex=0,this.isInitialSegment=!0;var o=this.getNewSegment();o.iteration=0,o.pos0.copy(s.pos0),o.pos1.copy(s.pos1),o.linPos0.copy(s.linPos0),o.linPos1.copy(s.linPos1),o.up0.copy(s.up0),o.up1.copy(s.up1),o.radius0=s.radius0,o.radius1=s.radius1,o.fraction0=0,o.fraction1=1,o.positionVariationFactor=1-s.straightness,this.subrayProbability=this.ramification*Math.pow(this.recursionProbability,s.recursion)/(1<<s.maxIterations),this.fractalRayRecursive(o)}this.currentSegmentCallback=null,this.currentSubray=null},e.prototype.fractalRayRecursive=function(t){if(t.iteration>=this.currentSubray.maxIterations)this.currentSegmentCallback(t);else{this.forwards.subVectors(t.pos1,t.pos0);var i=this.forwards.length();i<1e-6&&(this.forwards.set(0,0,.01),i=this.forwards.length());var e=.5*(t.radius0+t.radius1),r=.5*(t.fraction0+t.fraction1),s=this.time*this.currentSubray.timeScale*Math.pow(2,t.iteration);this.middlePos.lerpVectors(t.pos0,t.pos1,.5),this.middleLinPos.lerpVectors(t.linPos0,t.linPos1,.5);var a=this.middleLinPos;this.newPos.set(this.simplexX.noise4d(a.x,a.y,a.z,s),this.simplexY.noise4d(a.x,a.y,a.z,s),this.simplexZ.noise4d(a.x,a.y,a.z,s)),this.newPos.multiplyScalar(t.positionVariationFactor*i),this.newPos.add(this.middlePos);var o=this.getNewSegment();o.pos0.copy(t.pos0),o.pos1.copy(this.newPos),o.linPos0.copy(t.linPos0),o.linPos1.copy(this.middleLinPos),o.up0.copy(t.up0),o.up1.copy(t.up1),o.radius0=t.radius0,o.radius1=e,o.fraction0=t.fraction0,o.fraction1=r,o.positionVariationFactor=t.positionVariationFactor*this.currentSubray.roughness,o.iteration=t.iteration+1;var n=this.getNewSegment();n.pos0.copy(this.newPos),n.pos1.copy(t.pos1),n.linPos0.copy(this.middleLinPos),n.linPos1.copy(t.linPos1),this.cross1.crossVectors(t.up0,this.forwards.normalize()),n.up0.crossVectors(this.forwards,this.cross1).normalize(),n.up1.copy(t.up1),n.radius0=e,n.radius1=t.radius1,n.fraction0=r,n.fraction1=t.fraction1,n.positionVariationFactor=t.positionVariationFactor*this.currentSubray.roughness,n.iteration=t.iteration+1,this.fractalRayRecursive(o),this.fractalRayRecursive(n)}},e.prototype.createPrism=function(t){this.forwardsFill.subVectors(t.pos1,t.pos0).normalize(),this.isInitialSegment&&(this.currentCreateTriangleVertices(t.pos0,t.up0,this.forwardsFill,t.radius0,0),this.isInitialSegment=!1),this.currentCreateTriangleVertices(t.pos1,t.up0,this.forwardsFill,t.radius1,t.fraction1),this.createPrismFaces()},e.prototype.createTriangleVerticesWithoutUVs=function(t,i,r,s){this.side.crossVectors(i,r).multiplyScalar(s*e.COS30DEG),this.down.copy(i).multiplyScalar(-s*e.SIN30DEG);var a=this.vPos,o=this.vertices;a.copy(t).sub(this.side).add(this.down),o[this.currentCoordinate++]=a.x,o[this.currentCoordinate++]=a.y,o[this.currentCoordinate++]=a.z,a.copy(t).add(this.side).add(this.down),o[this.currentCoordinate++]=a.x,o[this.currentCoordinate++]=a.y,o[this.currentCoordinate++]=a.z,a.copy(i).multiplyScalar(s).add(t),o[this.currentCoordinate++]=a.x,o[this.currentCoordinate++]=a.y,o[this.currentCoordinate++]=a.z,this.currentVertex+=3},e.prototype.createTriangleVerticesWithUVs=function(t,i,r,s,a){this.side.crossVectors(i,r).multiplyScalar(s*e.COS30DEG),this.down.copy(i).multiplyScalar(-s*e.SIN30DEG);var o=this.vPos,n=this.vertices,c=this.uvs;o.copy(t).sub(this.side).add(this.down),n[this.currentCoordinate++]=o.x,n[this.currentCoordinate++]=o.y,n[this.currentCoordinate++]=o.z,c[this.currentUVCoordinate++]=a,c[this.currentUVCoordinate++]=0,o.copy(t).add(this.side).add(this.down),n[this.currentCoordinate++]=o.x,n[this.currentCoordinate++]=o.y,n[this.currentCoordinate++]=o.z,c[this.currentUVCoordinate++]=a,c[this.currentUVCoordinate++]=.5,o.copy(i).multiplyScalar(s).add(t),n[this.currentCoordinate++]=o.x,n[this.currentCoordinate++]=o.y,n[this.currentCoordinate++]=o.z,c[this.currentUVCoordinate++]=a,c[this.currentUVCoordinate++]=1,this.currentVertex+=3},e.prototype.createPrismFaces=function(t){var i=this.indices;t=this.currentVertex-6;i[this.currentIndex++]=t+1,i[this.currentIndex++]=t+2,i[this.currentIndex++]=t+5,i[this.currentIndex++]=t+1,i[this.currentIndex++]=t+5,i[this.currentIndex++]=t+4,i[this.currentIndex++]=t+0,i[this.currentIndex++]=t+1,i[this.currentIndex++]=t+4,i[this.currentIndex++]=t+0,i[this.currentIndex++]=t+4,i[this.currentIndex++]=t+3,i[this.currentIndex++]=t+2,i[this.currentIndex++]=t+0,i[this.currentIndex++]=t+3,i[this.currentIndex++]=t+2,i[this.currentIndex++]=t+3,i[this.currentIndex++]=t+5},e.prototype.createDefaultSubrayCreationCallbacks=function(){var i=this.randomGenerator.random;this.onDecideSubrayCreation=function(e,r){var s=r.currentSubray,a=r.rayParameters.subrayPeriod,o=r.rayParameters.subrayDutyCycle,n=r.rayParameters.isEternal&&0==s.recursion?-i()*a:t.MathUtils.lerp(s.birthTime,s.endPropagationTime,e.fraction0)-i()*a,c=r.time-n,u=Math.floor(c/a),h=i()*(u+1),d=0;if(c%a<=o*a&&(d=r.subrayProbability),s.recursion<r.maxSubrayRecursion&&r.numSubrays<r.maxSubrays&&i()<d){var m=r.addNewSubray(),p=r.randomGenerator.getSeed();m.seed=h,r.randomGenerator.setSeed(h),m.recursion=s.recursion+1,m.maxIterations=Math.max(1,s.maxIterations-1),m.linPos0.set(i(),i(),i()).multiplyScalar(1e3),m.linPos1.set(i(),i(),i()).multiplyScalar(1e3),m.up0.copy(s.up0),m.up1.copy(s.up1),m.radius0=e.radius0*r.rayParameters.radius0Factor,m.radius1=Math.min(r.rayParameters.minRadius,e.radius1*r.rayParameters.radius1Factor),m.birthTime=n+u*a,m.deathTime=m.birthTime+a*o,r.rayParameters.isEternal||0!=s.recursion||(m.birthTime=Math.max(m.birthTime,s.birthTime),m.deathTime=Math.min(m.deathTime,s.deathTime)),m.timeScale=2*s.timeScale,m.roughness=s.roughness,m.straightness=s.straightness,m.propagationTimeFactor=s.propagationTimeFactor,m.vanishingTimeFactor=s.vanishingTimeFactor,r.onSubrayCreation(e,s,m,r),r.randomGenerator.setSeed(p)}};var e=new t.Vector3,r=new t.Vector3,s=new t.Vector3,a=new t.Vector3;this.onSubrayCreation=function(t,i,e,r){r.subrayCylinderPosition(t,i,e,.5,.6,.2)},this.subrayConePosition=function(t,o,n,c,u,h){n.pos0.copy(t.pos0),e.subVectors(o.pos1,o.pos0),r.copy(e).normalize(),e.multiplyScalar(t.fraction0+(1-t.fraction0)*(i()*c));var d=e.length();s.crossVectors(o.up0,r);var m=2*Math.PI*i();s.multiplyScalar(Math.cos(m)),a.copy(o.up0).multiplyScalar(Math.sin(m)),n.pos1.copy(s).add(a).multiplyScalar(d*u*(h+i()*(1-h))).add(e).add(o.pos0)},this.subrayCylinderPosition=function(t,o,n,c,u,h){n.pos0.copy(t.pos0),e.subVectors(o.pos1,o.pos0),r.copy(e).normalize(),e.multiplyScalar(t.fraction0+(1-t.fraction0)*((2*i()-1)*c));var d=e.length();s.crossVectors(o.up0,r);var m=2*Math.PI*i();s.multiplyScalar(Math.cos(m)),a.copy(o.up0).multiplyScalar(Math.sin(m)),n.pos1.copy(s).add(a).multiplyScalar(d*u*(h+i()*(1-h))).add(e).add(o.pos0)}},e.prototype.createSubray=function(){return{seed:0,maxIterations:0,recursion:0,pos0:new t.Vector3,pos1:new t.Vector3,linPos0:new t.Vector3,linPos1:new t.Vector3,up0:new t.Vector3,up1:new t.Vector3,radius0:0,radius1:0,birthTime:0,deathTime:0,timeScale:0,roughness:0,straightness:0,propagationTimeFactor:0,vanishingTimeFactor:0,endPropagationTime:0,beginVanishingTime:0}},e.prototype.createSegment=function(){return{iteration:0,pos0:new t.Vector3,pos1:new t.Vector3,linPos0:new t.Vector3,linPos1:new t.Vector3,up0:new t.Vector3,up1:new t.Vector3,radius0:0,radius1:0,fraction0:0,fraction1:0,positionVariationFactor:0}},e.prototype.getNewSegment=function(){return this.raySegments[this.currentSegmentIndex++]},e.prototype.copy=function(i){return t.BufferGeometry.prototype.copy.call(this,i),this.init(e.copyParameters({},i.rayParameters)),this},e.prototype.clone=function(){return new this.constructor(e.copyParameters({},this.rayParameters))},e});
//# sourceMappingURL=../sourcemaps/geometries/LightningStrike.js.map
