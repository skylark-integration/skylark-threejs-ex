/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs","../threex","./Pass","../math/SimplexNoise","../shaders/SSAOShader","../shaders/CopyShader"],function(e,r,t,a,i,s){"use strict";var n=function(r,a,n,l){t.call(this),this.width=void 0!==n?n:512,this.height=void 0!==l?l:512,this.clear=!0,this.camera=a,this.scene=r,this.kernelRadius=8,this.kernelSize=32,this.kernel=[],this.noiseTexture=null,this.output=0,this.minDistance=.005,this.maxDistance=.1,this.generateSampleKernel(),this.generateRandomKernelRotations();var o=new e.DepthTexture;o.type=e.UnsignedShortType,o.minFilter=e.NearestFilter,o.maxFilter=e.NearestFilter,this.beautyRenderTarget=new e.WebGLRenderTarget(this.width,this.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,format:e.RGBAFormat,depthTexture:o,depthBuffer:!0}),this.normalRenderTarget=new e.WebGLRenderTarget(this.width,this.height,{minFilter:e.NearestFilter,magFilter:e.NearestFilter,format:e.RGBAFormat}),this.ssaoRenderTarget=new e.WebGLRenderTarget(this.width,this.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,format:e.RGBAFormat}),this.blurRenderTarget=this.ssaoRenderTarget.clone(),void 0===i&&console.error("THREE.SSAOPass: The pass relies on SSAOShader."),this.ssaoMaterial=new e.ShaderMaterial({defines:Object.assign({},i.defines),uniforms:e.UniformsUtils.clone(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,blending:e.NoBlending}),this.ssaoMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.ssaoMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.ssaoMaterial.uniforms.tDepth.value=this.beautyRenderTarget.depthTexture,this.ssaoMaterial.uniforms.tNoise.value=this.noiseTexture,this.ssaoMaterial.uniforms.kernel.value=this.kernel,this.ssaoMaterial.uniforms.cameraNear.value=this.camera.near,this.ssaoMaterial.uniforms.cameraFar.value=this.camera.far,this.ssaoMaterial.uniforms.resolution.value.set(this.width,this.height),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.getInverse(this.camera.projectionMatrix),this.normalMaterial=new e.MeshNormalMaterial,this.normalMaterial.blending=e.NoBlending,this.blurMaterial=new e.ShaderMaterial({defines:Object.assign({},SSAOBlurShader.defines),uniforms:e.UniformsUtils.clone(SSAOBlurShader.uniforms),vertexShader:SSAOBlurShader.vertexShader,fragmentShader:SSAOBlurShader.fragmentShader}),this.blurMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.blurMaterial.uniforms.resolution.value.set(this.width,this.height),this.depthRenderMaterial=new e.ShaderMaterial({defines:Object.assign({},SSAODepthShader.defines),uniforms:e.UniformsUtils.clone(SSAODepthShader.uniforms),vertexShader:SSAODepthShader.vertexShader,fragmentShader:SSAODepthShader.fragmentShader,blending:e.NoBlending}),this.depthRenderMaterial.uniforms.tDepth.value=this.beautyRenderTarget.depthTexture,this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this.copyMaterial=new e.ShaderMaterial({uniforms:e.UniformsUtils.clone(s.uniforms),vertexShader:s.vertexShader,fragmentShader:s.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blendSrc:e.DstColorFactor,blendDst:e.ZeroFactor,blendEquation:e.AddEquation,blendSrcAlpha:e.DstAlphaFactor,blendDstAlpha:e.ZeroFactor,blendEquationAlpha:e.AddEquation}),this.fsQuad=new t.FullScreenQuad(null),this.originalClearColor=new e.Color};return n.prototype=Object.assign(Object.create(t.prototype),{constructor:n,dispose:function(){this.beautyRenderTarget.dispose(),this.normalRenderTarget.dispose(),this.ssaoRenderTarget.dispose(),this.blurRenderTarget.dispose(),this.normalMaterial.dispose(),this.blurMaterial.dispose(),this.copyMaterial.dispose(),this.depthRenderMaterial.dispose(),this.fsQuad.dispose()},render:function(r,t){switch(r.setRenderTarget(this.beautyRenderTarget),r.clear(),r.render(this.scene,this.camera),this.renderOverride(r,this.normalMaterial,this.normalRenderTarget,7829503,1),this.ssaoMaterial.uniforms.kernelRadius.value=this.kernelRadius,this.ssaoMaterial.uniforms.minDistance.value=this.minDistance,this.ssaoMaterial.uniforms.maxDistance.value=this.maxDistance,this.renderPass(r,this.ssaoMaterial,this.ssaoRenderTarget),this.renderPass(r,this.blurMaterial,this.blurRenderTarget),this.output){case n.OUTPUT.SSAO:this.copyMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.copyMaterial.blending=e.NoBlending,this.renderPass(r,this.copyMaterial,this.renderToScreen?null:t);break;case n.OUTPUT.Blur:this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=e.NoBlending,this.renderPass(r,this.copyMaterial,this.renderToScreen?null:t);break;case n.OUTPUT.Beauty:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=e.NoBlending,this.renderPass(r,this.copyMaterial,this.renderToScreen?null:t);break;case n.OUTPUT.Depth:this.renderPass(r,this.depthRenderMaterial,this.renderToScreen?null:t);break;case n.OUTPUT.Normal:this.copyMaterial.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.copyMaterial.blending=e.NoBlending,this.renderPass(r,this.copyMaterial,this.renderToScreen?null:t);break;case n.OUTPUT.Default:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=e.NoBlending,this.renderPass(r,this.copyMaterial,this.renderToScreen?null:t),this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=e.CustomBlending,this.renderPass(r,this.copyMaterial,this.renderToScreen?null:t);break;default:console.warn("THREE.SSAOPass: Unknown output type.")}},renderPass:function(e,r,t,a,i){this.originalClearColor.copy(e.getClearColor());var s=e.getClearAlpha(),n=e.autoClear;e.setRenderTarget(t),e.autoClear=!1,void 0!==a&&null!==a&&(e.setClearColor(a),e.setClearAlpha(i||0),e.clear()),this.fsQuad.material=r,this.fsQuad.render(e),e.autoClear=n,e.setClearColor(this.originalClearColor),e.setClearAlpha(s)},renderOverride:function(e,r,t,a,i){this.originalClearColor.copy(e.getClearColor());var s=e.getClearAlpha(),n=e.autoClear;e.setRenderTarget(t),e.autoClear=!1,a=r.clearColor||a,i=r.clearAlpha||i,void 0!==a&&null!==a&&(e.setClearColor(a),e.setClearAlpha(i||0),e.clear()),this.scene.overrideMaterial=r,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=n,e.setClearColor(this.originalClearColor),e.setClearAlpha(s)},setSize:function(e,r){this.width=e,this.height=r,this.beautyRenderTarget.setSize(e,r),this.ssaoRenderTarget.setSize(e,r),this.normalRenderTarget.setSize(e,r),this.blurRenderTarget.setSize(e,r),this.ssaoMaterial.uniforms.resolution.value.set(e,r),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.getInverse(this.camera.projectionMatrix),this.blurMaterial.uniforms.resolution.value.set(e,r)},generateSampleKernel:function(){for(var r=this.kernelSize,t=this.kernel,a=0;a<r;a++){var i=new e.Vector3;i.x=2*Math.random()-1,i.y=2*Math.random()-1,i.z=Math.random(),i.normalize();var s=a/r;s=e.MathUtils.lerp(.1,1,s*s),i.multiplyScalar(s),t.push(i)}},generateRandomKernelRotations:function(){void 0===a&&console.error("THREE.SSAOPass: The pass relies on SimplexNoise.");for(var r=new a,t=new Float32Array(64),i=0;i<16;i++){var s=4*i,n=2*Math.random()-1,l=2*Math.random()-1,o=r.noise3d(n,l,0);t[s]=o,t[s+1]=o,t[s+2]=o,t[s+3]=1}this.noiseTexture=new e.DataTexture(t,4,4,e.RGBAFormat,e.FloatType),this.noiseTexture.wrapS=e.RepeatWrapping,this.noiseTexture.wrapT=e.RepeatWrapping}}),n.OUTPUT={Default:0,SSAO:1,Blur:2,Beauty:3,Depth:4,Normal:5},r.postprocessing.SSAOPass=n});
//# sourceMappingURL=../sourcemaps/postprocessing/SSAOPass.js.map
