/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs","../shaders/SAOShader","../shaders/DepthLimitedBlurShader","../shaders/DepthLimitedBlurShader","../shaders/CopyShader","../shaders/UnpackDepthRGBAShader","./Pass"],function(e,r,t,a,s,i,l){return e.SAOPass=function(r,t,a,s,i){(e.Pass.call(this),this.scene=r,this.camera=t,this.clear=!0,this.needsSwap=!1,this.supportsDepthTextureExtension=void 0!==a&&a,this.supportsNormalTexture=void 0!==s&&s,this.originalClearColor=new e.Color,this.oldClearColor=new e.Color,this.oldClearAlpha=1,this.params={output:0,saoBias:.5,saoIntensity:.18,saoScale:1,saoKernelRadius:100,saoMinResolution:0,saoBlur:!0,saoBlurRadius:8,saoBlurStdDev:4,saoBlurDepthCutoff:.01},this.resolution=void 0!==i?new e.Vector2(i.x,i.y):new e.Vector2(256,256),this.saoRenderTarget=new e.WebGLRenderTarget(this.resolution.x,this.resolution.y,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,format:e.RGBAFormat}),this.blurIntermediateRenderTarget=this.saoRenderTarget.clone(),this.beautyRenderTarget=this.saoRenderTarget.clone(),this.normalRenderTarget=new e.WebGLRenderTarget(this.resolution.x,this.resolution.y,{minFilter:e.NearestFilter,magFilter:e.NearestFilter,format:e.RGBAFormat}),this.depthRenderTarget=this.normalRenderTarget.clone(),this.supportsDepthTextureExtension)&&((a=new e.DepthTexture).type=e.UnsignedShortType,a.minFilter=e.NearestFilter,a.maxFilter=e.NearestFilter,this.beautyRenderTarget.depthTexture=a,this.beautyRenderTarget.depthBuffer=!0);this.depthMaterial=new e.MeshDepthMaterial,this.depthMaterial.depthPacking=e.RGBADepthPacking,this.depthMaterial.blending=e.NoBlending,this.normalMaterial=new e.MeshNormalMaterial,this.normalMaterial.blending=e.NoBlending,void 0===e.SAOShader&&console.error("THREE.SAOPass relies on THREE.SAOShader"),this.saoMaterial=new e.ShaderMaterial({defines:Object.assign({},e.SAOShader.defines),fragmentShader:e.SAOShader.fragmentShader,vertexShader:e.SAOShader.vertexShader,uniforms:e.UniformsUtils.clone(e.SAOShader.uniforms)}),this.saoMaterial.extensions.derivatives=!0,this.saoMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.saoMaterial.defines.NORMAL_TEXTURE=this.supportsNormalTexture?1:0,this.saoMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.saoMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?a:this.depthRenderTarget.texture,this.saoMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.saoMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.saoMaterial.uniforms.cameraInverseProjectionMatrix.value.getInverse(this.camera.projectionMatrix),this.saoMaterial.uniforms.cameraProjectionMatrix.value=this.camera.projectionMatrix,this.saoMaterial.blending=e.NoBlending,void 0===e.DepthLimitedBlurShader&&console.error("THREE.SAOPass relies on THREE.DepthLimitedBlurShader"),this.vBlurMaterial=new e.ShaderMaterial({uniforms:e.UniformsUtils.clone(e.DepthLimitedBlurShader.uniforms),defines:Object.assign({},e.DepthLimitedBlurShader.defines),vertexShader:e.DepthLimitedBlurShader.vertexShader,fragmentShader:e.DepthLimitedBlurShader.fragmentShader}),this.vBlurMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.vBlurMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.vBlurMaterial.uniforms.tDiffuse.value=this.saoRenderTarget.texture,this.vBlurMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?a:this.depthRenderTarget.texture,this.vBlurMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.vBlurMaterial.blending=e.NoBlending,this.hBlurMaterial=new e.ShaderMaterial({uniforms:e.UniformsUtils.clone(e.DepthLimitedBlurShader.uniforms),defines:Object.assign({},e.DepthLimitedBlurShader.defines),vertexShader:e.DepthLimitedBlurShader.vertexShader,fragmentShader:e.DepthLimitedBlurShader.fragmentShader}),this.hBlurMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.hBlurMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.hBlurMaterial.uniforms.tDiffuse.value=this.blurIntermediateRenderTarget.texture,this.hBlurMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?a:this.depthRenderTarget.texture,this.hBlurMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.hBlurMaterial.blending=e.NoBlending,void 0===e.CopyShader&&console.error("THREE.SAOPass relies on THREE.CopyShader"),this.materialCopy=new e.ShaderMaterial({uniforms:e.UniformsUtils.clone(e.CopyShader.uniforms),vertexShader:e.CopyShader.vertexShader,fragmentShader:e.CopyShader.fragmentShader,blending:e.NoBlending}),this.materialCopy.transparent=!0,this.materialCopy.depthTest=!1,this.materialCopy.depthWrite=!1,this.materialCopy.blending=e.CustomBlending,this.materialCopy.blendSrc=e.DstColorFactor,this.materialCopy.blendDst=e.ZeroFactor,this.materialCopy.blendEquation=e.AddEquation,this.materialCopy.blendSrcAlpha=e.DstAlphaFactor,this.materialCopy.blendDstAlpha=e.ZeroFactor,this.materialCopy.blendEquationAlpha=e.AddEquation,void 0===e.UnpackDepthRGBAShader&&console.error("THREE.SAOPass relies on THREE.UnpackDepthRGBAShader"),this.depthCopy=new e.ShaderMaterial({uniforms:e.UniformsUtils.clone(e.UnpackDepthRGBAShader.uniforms),vertexShader:e.UnpackDepthRGBAShader.vertexShader,fragmentShader:e.UnpackDepthRGBAShader.fragmentShader,blending:e.NoBlending}),this.fsQuad=new e.Pass.FullScreenQuad(null)},e.SAOPass.OUTPUT={Beauty:1,Default:0,SAO:2,Depth:3,Normal:4},e.SAOPass.prototype=Object.assign(Object.create(e.Pass.prototype),{constructor:e.SAOPass,render:function(r,t,a){if(this.renderToScreen&&(this.materialCopy.blending=e.NoBlending,this.materialCopy.uniforms.tDiffuse.value=a.texture,this.materialCopy.needsUpdate=!0,this.renderPass(r,this.materialCopy,null)),1!==this.params.output){this.oldClearColor.copy(r.getClearColor()),this.oldClearAlpha=r.getClearAlpha();var s=r.autoClear;r.autoClear=!1,r.setRenderTarget(this.depthRenderTarget),r.clear(),this.saoMaterial.uniforms.bias.value=this.params.saoBias,this.saoMaterial.uniforms.intensity.value=this.params.saoIntensity,this.saoMaterial.uniforms.scale.value=this.params.saoScale,this.saoMaterial.uniforms.kernelRadius.value=this.params.saoKernelRadius,this.saoMaterial.uniforms.minResolution.value=this.params.saoMinResolution,this.saoMaterial.uniforms.cameraNear.value=this.camera.near,this.saoMaterial.uniforms.cameraFar.value=this.camera.far;var i=this.params.saoBlurDepthCutoff*(this.camera.far-this.camera.near);this.vBlurMaterial.uniforms.depthCutoff.value=i,this.hBlurMaterial.uniforms.depthCutoff.value=i,this.vBlurMaterial.uniforms.cameraNear.value=this.camera.near,this.vBlurMaterial.uniforms.cameraFar.value=this.camera.far,this.hBlurMaterial.uniforms.cameraNear.value=this.camera.near,this.hBlurMaterial.uniforms.cameraFar.value=this.camera.far,this.params.saoBlurRadius=Math.floor(this.params.saoBlurRadius),this.prevStdDev===this.params.saoBlurStdDev&&this.prevNumSamples===this.params.saoBlurRadius||(e.BlurShaderUtils.configure(this.vBlurMaterial,this.params.saoBlurRadius,this.params.saoBlurStdDev,new e.Vector2(0,1)),e.BlurShaderUtils.configure(this.hBlurMaterial,this.params.saoBlurRadius,this.params.saoBlurStdDev,new e.Vector2(1,0)),this.prevStdDev=this.params.saoBlurStdDev,this.prevNumSamples=this.params.saoBlurRadius),r.setClearColor(0),r.setRenderTarget(this.beautyRenderTarget),r.clear(),r.render(this.scene,this.camera),this.supportsDepthTextureExtension||this.renderOverride(r,this.depthMaterial,this.depthRenderTarget,0,1),this.supportsNormalTexture&&this.renderOverride(r,this.normalMaterial,this.normalRenderTarget,7829503,1),this.renderPass(r,this.saoMaterial,this.saoRenderTarget,16777215,1),this.params.saoBlur&&(this.renderPass(r,this.vBlurMaterial,this.blurIntermediateRenderTarget,16777215,1),this.renderPass(r,this.hBlurMaterial,this.saoRenderTarget,16777215,1));var l=this.materialCopy;3===this.params.output?this.supportsDepthTextureExtension?(this.materialCopy.uniforms.tDiffuse.value=this.beautyRenderTarget.depthTexture,this.materialCopy.needsUpdate=!0):(this.depthCopy.uniforms.tDiffuse.value=this.depthRenderTarget.texture,this.depthCopy.needsUpdate=!0,l=this.depthCopy):4===this.params.output?(this.materialCopy.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.materialCopy.needsUpdate=!0):(this.materialCopy.uniforms.tDiffuse.value=this.saoRenderTarget.texture,this.materialCopy.needsUpdate=!0),0===this.params.output?l.blending=e.CustomBlending:l.blending=e.NoBlending,this.renderPass(r,l,this.renderToScreen?null:a),r.setClearColor(this.oldClearColor,this.oldClearAlpha),r.autoClear=s}},renderPass:function(e,r,t,a,s){this.originalClearColor.copy(e.getClearColor());var i=e.getClearAlpha(),l=e.autoClear;e.setRenderTarget(t),e.autoClear=!1,void 0!==a&&null!==a&&(e.setClearColor(a),e.setClearAlpha(s||0),e.clear()),this.fsQuad.material=r,this.fsQuad.render(e),e.autoClear=l,e.setClearColor(this.originalClearColor),e.setClearAlpha(i)},renderOverride:function(e,r,t,a,s){this.originalClearColor.copy(e.getClearColor());var i=e.getClearAlpha(),l=e.autoClear;e.setRenderTarget(t),e.autoClear=!1,a=r.clearColor||a,s=r.clearAlpha||s,void 0!==a&&null!==a&&(e.setClearColor(a),e.setClearAlpha(s||0),e.clear()),this.scene.overrideMaterial=r,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=l,e.setClearColor(this.originalClearColor),e.setClearAlpha(i)},setSize:function(e,r){this.beautyRenderTarget.setSize(e,r),this.saoRenderTarget.setSize(e,r),this.blurIntermediateRenderTarget.setSize(e,r),this.normalRenderTarget.setSize(e,r),this.depthRenderTarget.setSize(e,r),this.saoMaterial.uniforms.size.value.set(e,r),this.saoMaterial.uniforms.cameraInverseProjectionMatrix.value.getInverse(this.camera.projectionMatrix),this.saoMaterial.uniforms.cameraProjectionMatrix.value=this.camera.projectionMatrix,this.saoMaterial.needsUpdate=!0,this.vBlurMaterial.uniforms.size.value.set(e,r),this.vBlurMaterial.needsUpdate=!0,this.hBlurMaterial.uniforms.size.value.set(e,r),this.hBlurMaterial.needsUpdate=!0}}),e.SAOPass});
//# sourceMappingURL=../sourcemaps/postprocessing/SAOPass.js.map
