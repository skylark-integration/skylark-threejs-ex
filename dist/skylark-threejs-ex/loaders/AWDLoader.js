/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs","../threex"],function(t,e){"use strict";var r=function(){function e(){this.id=0,this.data=null,this.namespace=0,this.flags=0}function r(){}r.prototype={set:function(t,e){this[t]=e},get:function(t,e){return this.hasOwnProperty(t)?this[t]:e}};var s=function(r){t.Loader.call(this,r),this.trunk=new t.Object3D,this.materialFactory=void 0,this._url="",this._baseDir="",this._data=void 0,this._ptr=0,this._version=[],this._streaming=!1,this._optimized_for_accuracy=!1,this._compression=0,this._bodylen=4294967295,this._blocks=[new e],this._accuracyMatrix=!1,this._accuracyGeo=!1,this._accuracyProps=!1};return s.prototype=Object.assign(Object.create(t.Loader.prototype),{constructor:s,load:function(e,r,s,a){var i=this;this._url=e,this._baseDir=e.substr(0,e.lastIndexOf("/")+1);var h=new t.FileLoader(this.manager);h.setPath(this.path),h.setResponseType("arraybuffer"),h.load(e,function(t){r(i.parse(t))},s,a)},parse:function(t){var e=t.byteLength;for(this._ptr=0,this._data=new DataView(t),this._parseHeader(),0!=this._compression&&console.error("compressed AWD not supported"),this._streaming||this._bodylen==t.byteLength-this._ptr||console.error("AWDLoader: body len does not match file length",this._bodylen,e-this._ptr);this._ptr<e;)this.parseNextBlock();return this.trunk},parseNextBlock:function(){var t,r,s=this.readU32(),a=this.readU8(),i=this.readU8(),h=this.readU8(),n=this.readU32();switch(i){case 1:t=this.parseMeshData();break;case 22:t=this.parseContainer();break;case 23:t=this.parseMeshInstance();break;case 81:t=this.parseMaterial();break;case 82:t=this.parseTexture();break;case 101:t=this.parseSkeleton();break;case 112:t=this.parseMeshPoseAnimation(!1);break;case 113:t=this.parseVertexAnimationSet();break;case 102:t=this.parseSkeletonPose();break;case 103:t=this.parseSkeletonAnimation();break;case 122:t=this.parseAnimatorSet();break;default:this._ptr+=n}this._blocks[s]=r=new e,r.data=t,r.id=s,r.namespace=a,r.flags=h},_parseHeader:function(){var t=this._version;if(4282180!=(this.readU8()<<16|this.readU8()<<8|this.readU8()))throw new Error("AWDLoader - bad magic");t[0]=this.readU8(),t[1]=this.readU8();var e=this.readU16();this._streaming=1==(1&e),2===t[0]&&1===t[1]&&(this._accuracyMatrix=2==(2&e),this._accuracyGeo=4==(4&e),this._accuracyProps=8==(8&e)),this._geoNrType=this._accuracyGeo?8:7,this._matrixNrType=this._accuracyMatrix?8:7,this._propsNrType=this._accuracyProps?8:7,this._optimized_for_accuracy=2==(2&e),this._compression=this.readU8(),this._bodylen=this.readU32()},parseContainer:function(){var e=new t.Object3D,r=this.readU32(),s=this.parseMatrix4();return e.name=this.readUTF(),e.applyMatrix4(s),(this._blocks[r].data||this.trunk).add(e),this.parseProperties({1:this._matrixNrType,2:this._matrixNrType,3:this._matrixNrType,4:4}),e.extra=this.parseUserAttributes(),e},parseMeshInstance:function(){var e,r,s,a,i,h,n,o,d,p,u,c,l;for(h=this.readU32(),o=this.parseMatrix4(),e=this.readUTF(),n=this.readU32(),c=this.readU16(),s=this.getBlock(n),d=[],l=0;l<c;l++)u=this.readU32(),p=this.getBlock(u),d.push(p);if(i=[],(a=s.length)>1)for(r=new t.Object3D,l=0;l<a;l++){var f=new t.Mesh(s[l]);i.push(f),r.add(f)}else r=new t.Mesh(s[0]),i.push(r);r.applyMatrix4(o),r.name=e,(this.getBlock(h)||this.trunk).add(r);var _=d.length,U=Math.max(a,_);for(l=0;l<U;l++)i[l%a].material=d[l%_];return this.parseProperties(null),r.extra=this.parseUserAttributes(),r},parseMaterial:function(){var e,r,s,a,i,h;for(e=this.readUTF(),r=this.readU8(),h=this.readU8(),s=this.parseProperties({1:3,2:23,11:21,12:7,13:21}),0;0<h;)this.readU16(),this.parseProperties(null),this.parseUserAttributes();if(i=this.parseUserAttributes(),void 0!==this.materialFactory&&(a=this.materialFactory(e)))return a;if(a=new t.MeshPhongMaterial,1===r)a.color.setHex(s.get(1,13421772));else if(2===r){var n=s.get(2,0);a.map=this.getBlock(n)}return a.extra=i,a.alphaThreshold=s.get(12,0),a.repeat=s.get(13,!1),a},parseTexture:function(){var t,e,r=this.readUTF();if(0===this.readU8()){e=this.readU32();var s=this.readUTFBytes(e);console.log(s),(t=this.loadTexture(s)).userData={},t.userData.name=r}return this.parseProperties(null),this.parseUserAttributes(),t},loadTexture:function(e){var r=new t.Texture;return new t.ImageLoader(this.manager).load(this._baseDir+e,function(t){r.image=t,r.needsUpdate=!0}),r},parseSkeleton:function(){this.readUTF();var e=this.readU16(),r=[],s=0;for(this.parseProperties(null);s<e;){var a,i;this.readU16(),(a=new t.Bone).parent=this.readU16()-1,a.name=this.readUTF(),i=this.parseMatrix4(),a.skinMatrix=i,this.parseProperties(null),this.parseUserAttributes(),r.push(a),s++}return this.parseUserAttributes(),r},parseSkeletonPose:function(){this.readUTF();var e=this.readU16();this.parseProperties(null);for(var r=[],s=0;s<e;){var a;a=1===this.readU8()?this.parseMatrix4():new t.Matrix4,r[s]=a,s++}return this.parseUserAttributes(),r},parseSkeletonAnimation:function(){this.readUTF();var t,e,r,s=[],a=this.readU16();this.parseProperties(null);for(var i=0;i<a;)e=this.readU32(),t=this.readU16(),r=this._blocks[e].data,s.push({pose:r,duration:t}),i++;if(0!==s.length)return this.parseUserAttributes(),s},parseVertexAnimationSet:function(){this.readUTF();for(var t,e=this.readU16(),r=(this.parseProperties({1:5}),0),s=[];r<e;)t=this.readU32(),s.push(this._blocks[t].data),r++;return this.parseUserAttributes(),s},parseAnimatorSet:function(){this.readUTF();var t,e,r=this.readU16(),s=this.parseProperties({1:23});t=this.readU32();for(var a=this.readU16(),i=[],h=0;h<a;h++)i.push(this.readU32());this.readU16(),Boolean(this.readU8());this.parseUserAttributes(),this.parseUserAttributes();var n,o=[];for(h=0;h<i.length;h++)o.push(this._blocks[i[h]].data);for(e=this._blocks[t].data,1==r&&(n={animationSet:e,skeleton:this._blocks[s.get(1,0)].data}),h=0;h<o.length;h++)o[h].animator=n;return n},parseMeshData:function(){var e,r,s=this.readUTF(),a=this.readU16(),i=0,h=[];for(this.parseProperties({1:this._geoNrType,2:this._geoNrType});i<a;){var n,o,d;for((e=new t.BufferGeometry).name=s,h.push(e),n=this.readU32(),o=this._ptr+n,this.parseProperties({1:this._geoNrType,2:this._geoNrType});this._ptr<o;){var p=0,u=this.readU8(),c=(this.readU8(),this.readU32()),l=c+this._ptr;if(1===u)for(r=new Float32Array(c/12*3),d=new t.BufferAttribute(r,3),e.setAttribute("position",d),p=0;this._ptr<l;)r[p]=-this.readF32(),r[p+1]=this.readF32(),r[p+2]=this.readF32(),p+=3;else if(2===u)for(r=new Uint16Array(c/2),d=new t.BufferAttribute(r,1),e.setIndex(d),p=0;this._ptr<l;)r[p+1]=this.readU16(),r[p]=this.readU16(),r[p+2]=this.readU16(),p+=3;else if(3===u)for(r=new Float32Array(c/8*2),d=new t.BufferAttribute(r,2),e.setAttribute("uv",d),p=0;this._ptr<l;)r[p]=this.readF32(),r[p+1]=1-this.readF32(),p+=2;else if(4===u)for(r=new Float32Array(c/12*3),d=new t.BufferAttribute(r,3),e.setAttribute("normal",d),p=0;this._ptr<l;)r[p]=-this.readF32(),r[p+1]=this.readF32(),r[p+2]=this.readF32(),p+=3;else this._ptr=l}this.parseUserAttributes(),e.computeBoundingSphere(),i++}return this.parseUserAttributes(),h},parseMeshPoseAnimation:function(t){var e,r,s,a,i,h,n,o,d,p=1,u=0,c={},l=[],f=(this.readUTF(),this.readU32()),_=this.getBlock(f);if(null!==_){for((h=_.geometry).morphTargets=[],t||(p=this.readU16()),e=this.readU16(),n=this.readU16(),o=0;o<n;)l.push(this.readU16()),o++;for(d=this.parseProperties({1:21,2:21}),c.looping=d.get(1,!0),c.stitchFinalFrame=d.get(2,!1),r=0;r<p;){for(this.readU16(),s=0;s<e;)for(o=0,a=this.readU32(),i=this._ptr+a;o<n;){if(1===l[o]){var U=new Float32Array(a/4);for(h.morphTargets.push({array:U}),u=0;this._ptr<i;)U[u]=this.readF32(),U[u+1]=this.readF32(),U[u+2]=this.readF32(),u+=3;s++}else this._ptr=i;o++}r++}return this.parseUserAttributes(),null}console.log("parseMeshPoseAnimation target mesh not found at:",f)},getBlock:function(t){return this._blocks[t].data},parseMatrix4:function(){var e=new t.Matrix4,r=e.elements;return r[0]=this.readF32(),r[1]=this.readF32(),r[2]=this.readF32(),r[3]=0,r[4]=this.readF32(),r[5]=this.readF32(),r[6]=this.readF32(),r[7]=0,r[8]=this.readF32(),r[9]=this.readF32(),r[10]=this.readF32(),r[11]=0,r[12]=-this.readF32(),r[13]=this.readF32(),r[14]=this.readF32(),r[15]=1,e},parseProperties:function(t){var e=this.readU32(),s=this._ptr+e,a=new r;if(t)for(;this._ptr<s;){var i,h=this.readU16(),n=this.readU32();t.hasOwnProperty(h)?(i=t[h],a.set(h,this.parseAttrValue(i,n))):this._ptr+=n}return a},parseUserAttributes:function(){return this._ptr=this.readU32()+this._ptr,null},parseAttrValue:function(t,e){var r,s;switch(t){case 1:r=1,s=this.readI8;break;case 2:r=2,s=this.readI16;break;case 3:r=4,s=this.readI32;break;case 21:case 4:r=1,s=this.readU8;break;case 5:r=2,s=this.readU16;break;case 6:case 23:r=4,s=this.readU32;break;case 7:r=4,s=this.readF32;break;case 8:r=8,s=this.readF64;break;case 41:case 42:case 43:case 44:case 45:case 46:case 47:r=8,s=this.readF64}if(r<e){var a,i,h;for(a=[],i=0,h=e/r;i<h;)a.push(s.call(this)),i++;return a}return s.call(this)},readU8:function(){return this._data.getUint8(this._ptr++)},readI8:function(){return this._data.getInt8(this._ptr++)},readU16:function(){var t=this._data.getUint16(this._ptr,!0);return this._ptr+=2,t},readI16:function(){var t=this._data.getInt16(this._ptr,!0);return this._ptr+=2,t},readU32:function(){var t=this._data.getUint32(this._ptr,!0);return this._ptr+=4,t},readI32:function(){var t=this._data.getInt32(this._ptr,!0);return this._ptr+=4,t},readF32:function(){var t=this._data.getFloat32(this._ptr,!0);return this._ptr+=4,t},readF64:function(){var t=this._data.getFloat64(this._ptr,!0);return this._ptr+=8,t},readUTF:function(){var t=this.readU16();return this.readUTFBytes(t)},readUTFBytes:function(t){for(var e=[],r=0;e.length<t;){var s=this._data.getUint8(this._ptr++,!0);if(s<128)e[r++]=String.fromCharCode(s);else if(s>191&&s<224){var a=this._data.getUint8(this._ptr++,!0);e[r++]=String.fromCharCode((31&s)<<6|63&a)}else{a=this._data.getUint8(this._ptr++,!0);var i=this._data.getUint8(this._ptr++,!0);e[r++]=String.fromCharCode((15&s)<<12|(63&a)<<6|63&i)}}return e.join("")}}),s}();return e.loaders.AWDLoader=r});
//# sourceMappingURL=../sourcemaps/loaders/AWDLoader.js.map
