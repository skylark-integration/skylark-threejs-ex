/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs"],function(e){"use strict";function r(e){this.IFF=e}function t(e){this.IFF=e}function a(){this.debugger=new i}function s(e){this.dv=new DataView(e),this.offset=0}function i(){this.active=!1,this.depth=0,this.formList=[]}function n(e){return e%2}function c(e){return e.length+1+(n(e.length+1)?1:0)}var o;r.prototype={constructor:r,parseBlock:function(){this.IFF.debugger.offset=this.IFF.reader.offset,this.IFF.debugger.closeForms();var e=this.IFF.reader.getIDTag(),r=this.IFF.reader.getUint32();switch(r>this.IFF.reader.dv.byteLength-this.IFF.reader.offset&&(this.IFF.reader.offset-=4,r=this.IFF.reader.getUint16()),this.IFF.debugger.dataOffset=this.IFF.reader.offset,this.IFF.debugger.length=r,e){case"FORM":this.IFF.parseForm(r);break;case"ICON":case"VMPA":case"BBOX":case"NORM":case"PRE ":case"POST":case"KEY ":case"SPAN":case"TIME":case"CLRS":case"CLRA":case"FILT":case"DITH":case"CONT":case"BRIT":case"SATR":case"HUE ":case"GAMM":case"NEGA":case"IFLT":case"PFLT":case"PROJ":case"AXIS":case"AAST":case"PIXB":case"AUVO":case"STCK":case"PROC":case"VALU":case"FUNC":case"PNAM":case"INAM":case"GRST":case"GREN":case"GRPT":case"FKEY":case"IKEY":case"CSYS":case"OPAQ":case"CMAP":case"NLOC":case"NZOM":case"NVER":case"NSRV":case"NVSK":case"NCRD":case"WRPW":case"WRPH":case"NMOD":case"NPRW":case"NPLA":case"NODS":case"VERS":case"ENUM":case"TAG ":case"OPAC":case"CGMD":case"CGTY":case"CGST":case"CGEN":case"CGTS":case"CGTE":case"OSMP":case"OMDE":case"OUTR":case"FLAG":case"TRNL":case"GLOW":case"GVAL":case"SHRP":case"RFOP":case"RSAN":case"TROP":case"RBLR":case"TBLR":case"CLRH":case"CLRF":case"ADTR":case"LINE":case"ALPH":case"VCOL":case"ENAB":this.IFF.debugger.skipped=!0,this.IFF.reader.skip(r);break;case"SURF":this.IFF.parseSurfaceLwo2(r);break;case"CLIP":this.IFF.parseClipLwo2(r);break;case"IPIX":case"IMIP":case"IMOD":case"AMOD":case"IINV":case"INCR":case"IAXS":case"IFOT":case"ITIM":case"IWRL":case"IUTI":case"IINX":case"IINY":case"IINZ":case"IREF":4===r?this.IFF.currentNode[e]=this.IFF.reader.getInt32():this.IFF.reader.skip(r);break;case"OTAG":this.IFF.parseObjectTag();break;case"LAYR":this.IFF.parseLayer(r);break;case"PNTS":this.IFF.parsePoints(r);break;case"VMAP":this.IFF.parseVertexMapping(r);break;case"AUVU":case"AUVN":this.IFF.reader.skip(r-1),this.IFF.reader.getVariableLengthIndex();break;case"POLS":this.IFF.parsePolygonList(r);break;case"TAGS":this.IFF.parseTagStrings(r);break;case"PTAG":this.IFF.parsePolygonTagMapping(r);break;case"VMAD":this.IFF.parseVertexMapping(r,!0);break;case"DESC":this.IFF.currentForm.description=this.IFF.reader.getString();break;case"TEXT":case"CMNT":case"NCOM":this.IFF.currentForm.comment=this.IFF.reader.getString();break;case"NAME":this.IFF.currentForm.channelName=this.IFF.reader.getString();break;case"WRAP":this.IFF.currentForm.wrap={w:this.IFF.reader.getUint16(),h:this.IFF.reader.getUint16()};break;case"IMAG":var t=this.IFF.reader.getVariableLengthIndex();this.IFF.currentForm.imageIndex=t;break;case"OREF":this.IFF.currentForm.referenceObject=this.IFF.reader.getString();break;case"ROID":this.IFF.currentForm.referenceObjectID=this.IFF.reader.getUint32();break;case"SSHN":this.IFF.currentSurface.surfaceShaderName=this.IFF.reader.getString();break;case"AOVN":this.IFF.currentSurface.surfaceCustomAOVName=this.IFF.reader.getString();break;case"NSTA":this.IFF.currentForm.disabled=this.IFF.reader.getUint16();break;case"NRNM":this.IFF.currentForm.realName=this.IFF.reader.getString();break;case"NNME":this.IFF.currentForm.refName=this.IFF.reader.getString(),this.IFF.currentSurface.nodes[this.IFF.currentForm.refName]=this.IFF.currentForm;break;case"INME":this.IFF.currentForm.nodeName||(this.IFF.currentForm.nodeName=[]),this.IFF.currentForm.nodeName.push(this.IFF.reader.getString());break;case"IINN":this.IFF.currentForm.inputNodeName||(this.IFF.currentForm.inputNodeName=[]),this.IFF.currentForm.inputNodeName.push(this.IFF.reader.getString());break;case"IINM":this.IFF.currentForm.inputName||(this.IFF.currentForm.inputName=[]),this.IFF.currentForm.inputName.push(this.IFF.reader.getString());break;case"IONM":this.IFF.currentForm.inputOutputName||(this.IFF.currentForm.inputOutputName=[]),this.IFF.currentForm.inputOutputName.push(this.IFF.reader.getString());break;case"FNAM":this.IFF.currentForm.fileName=this.IFF.reader.getString();break;case"CHAN":4===r?this.IFF.currentForm.textureChannel=this.IFF.reader.getIDTag():this.IFF.reader.skip(r);break;case"SMAN":var a=this.IFF.reader.getFloat32();this.IFF.currentSurface.attributes.smooth=!(a<0);break;case"COLR":this.IFF.currentSurface.attributes.undefined={value:this.IFF.reader.getFloat32Array(3)},this.IFF.reader.skip(2);break;case"LUMI":this.IFF.currentSurface.attributes.Luminosity={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"SPEC":this.IFF.currentSurface.attributes.Specular={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"DIFF":this.IFF.currentSurface.attributes.Diffuse={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"REFL":this.IFF.currentSurface.attributes.Reflection={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"GLOS":this.IFF.currentSurface.attributes.Glossiness={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"TRAN":this.IFF.currentSurface.attributes.opacity=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"BUMP":this.IFF.currentSurface.attributes.bumpStrength=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"SIDE":this.IFF.currentSurface.attributes.side=this.IFF.reader.getUint16();break;case"RIMG":this.IFF.currentSurface.attributes.reflectionMap=this.IFF.reader.getVariableLengthIndex();break;case"RIND":this.IFF.currentSurface.attributes.refractiveIndex=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"TIMG":this.IFF.currentSurface.attributes.refractionMap=this.IFF.reader.getVariableLengthIndex();break;case"IMAP":this.IFF.reader.skip(2);break;case"TMAP":this.IFF.debugger.skipped=!0,this.IFF.reader.skip(r);break;case"IUVI":this.IFF.currentNode.UVChannel=this.IFF.reader.getString(r);break;case"IUTL":this.IFF.currentNode.widthWrappingMode=this.IFF.reader.getUint32();break;case"IVTL":this.IFF.currentNode.heightWrappingMode=this.IFF.reader.getUint32();break;case"BLOK":break;default:this.IFF.parseUnknownCHUNK(e,r)}"FORM"!=e&&(this.IFF.debugger.node=1,this.IFF.debugger.nodeID=e,this.IFF.debugger.log()),this.IFF.reader.offset>=this.IFF.currentFormEnd&&(this.IFF.currentForm=this.IFF.parentForm)}},t.prototype={constructor:t,parseBlock:function(){this.IFF.debugger.offset=this.IFF.reader.offset,this.IFF.debugger.closeForms();var e=this.IFF.reader.getIDTag(),r=this.IFF.reader.getUint32();switch(this.IFF.debugger.dataOffset=this.IFF.reader.offset,this.IFF.debugger.length=r,e){case"FORM":this.IFF.parseForm(r);break;case"ICON":case"VMPA":case"BBOX":case"NORM":case"PRE ":case"POST":case"KEY ":case"SPAN":case"TIME":case"CLRS":case"CLRA":case"FILT":case"DITH":case"CONT":case"BRIT":case"SATR":case"HUE ":case"GAMM":case"NEGA":case"IFLT":case"PFLT":case"PROJ":case"AXIS":case"AAST":case"PIXB":case"STCK":case"VALU":case"PNAM":case"INAM":case"GRST":case"GREN":case"GRPT":case"FKEY":case"IKEY":case"CSYS":case"OPAQ":case"CMAP":case"NLOC":case"NZOM":case"NVER":case"NSRV":case"NCRD":case"NMOD":case"NSEL":case"NPRW":case"NPLA":case"VERS":case"ENUM":case"TAG ":case"CGMD":case"CGTY":case"CGST":case"CGEN":case"CGTS":case"CGTE":case"OSMP":case"OMDE":case"OUTR":case"FLAG":case"TRNL":case"SHRP":case"RFOP":case"RSAN":case"TROP":case"RBLR":case"TBLR":case"CLRH":case"CLRF":case"ADTR":case"GLOW":case"LINE":case"ALPH":case"VCOL":case"ENAB":this.IFF.debugger.skipped=!0,this.IFF.reader.skip(r);break;case"IPIX":case"IMIP":case"IMOD":case"AMOD":case"IINV":case"INCR":case"IAXS":case"IFOT":case"ITIM":case"IWRL":case"IUTI":case"IINX":case"IINY":case"IINZ":case"IREF":4===r?this.IFF.currentNode[e]=this.IFF.reader.getInt32():this.IFF.reader.skip(r);break;case"OTAG":this.IFF.parseObjectTag();break;case"LAYR":this.IFF.parseLayer(r);break;case"PNTS":this.IFF.parsePoints(r);break;case"VMAP":this.IFF.parseVertexMapping(r);break;case"POLS":this.IFF.parsePolygonList(r);break;case"TAGS":this.IFF.parseTagStrings(r);break;case"PTAG":this.IFF.parsePolygonTagMapping(r);break;case"VMAD":this.IFF.parseVertexMapping(r,!0);break;case"DESC":this.IFF.currentForm.description=this.IFF.reader.getString();break;case"TEXT":case"CMNT":case"NCOM":this.IFF.currentForm.comment=this.IFF.reader.getString();break;case"NAME":this.IFF.currentForm.channelName=this.IFF.reader.getString();break;case"WRAP":this.IFF.currentForm.wrap={w:this.IFF.reader.getUint16(),h:this.IFF.reader.getUint16()};break;case"IMAG":var t=this.IFF.reader.getVariableLengthIndex();this.IFF.currentForm.imageIndex=t;break;case"OREF":this.IFF.currentForm.referenceObject=this.IFF.reader.getString();break;case"ROID":this.IFF.currentForm.referenceObjectID=this.IFF.reader.getUint32();break;case"SSHN":this.IFF.currentSurface.surfaceShaderName=this.IFF.reader.getString();break;case"AOVN":this.IFF.currentSurface.surfaceCustomAOVName=this.IFF.reader.getString();break;case"NSTA":this.IFF.currentForm.disabled=this.IFF.reader.getUint16();break;case"NRNM":this.IFF.currentForm.realName=this.IFF.reader.getString();break;case"NNME":this.IFF.currentForm.refName=this.IFF.reader.getString(),this.IFF.currentSurface.nodes[this.IFF.currentForm.refName]=this.IFF.currentForm;break;case"INME":this.IFF.currentForm.nodeName||(this.IFF.currentForm.nodeName=[]),this.IFF.currentForm.nodeName.push(this.IFF.reader.getString());break;case"IINN":this.IFF.currentForm.inputNodeName||(this.IFF.currentForm.inputNodeName=[]),this.IFF.currentForm.inputNodeName.push(this.IFF.reader.getString());break;case"IINM":this.IFF.currentForm.inputName||(this.IFF.currentForm.inputName=[]),this.IFF.currentForm.inputName.push(this.IFF.reader.getString());break;case"IONM":this.IFF.currentForm.inputOutputName||(this.IFF.currentForm.inputOutputName=[]),this.IFF.currentForm.inputOutputName.push(this.IFF.reader.getString());break;case"FNAM":this.IFF.currentForm.fileName=this.IFF.reader.getString();break;case"CHAN":4===r?this.IFF.currentForm.textureChannel=this.IFF.reader.getIDTag():this.IFF.reader.skip(r);break;case"SMAN":var a=this.IFF.reader.getFloat32();this.IFF.currentSurface.attributes.smooth=!(a<0);break;case"COLR":this.IFF.currentSurface.attributes.undefined={value:this.IFF.reader.getFloat32Array(3)},this.IFF.reader.skip(2);break;case"LUMI":this.IFF.currentSurface.attributes.Luminosity={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"SPEC":this.IFF.currentSurface.attributes.Specular={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"DIFF":this.IFF.currentSurface.attributes.Diffuse={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"REFL":this.IFF.currentSurface.attributes.Reflection={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"GLOS":this.IFF.currentSurface.attributes.Glossiness={value:this.IFF.reader.getFloat32()},this.IFF.reader.skip(2);break;case"TRAN":this.IFF.currentSurface.attributes.opacity=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"BUMP":this.IFF.currentSurface.attributes.bumpStrength=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"SIDE":this.IFF.currentSurface.attributes.side=this.IFF.reader.getUint16();break;case"RIMG":this.IFF.currentSurface.attributes.reflectionMap=this.IFF.reader.getVariableLengthIndex();break;case"RIND":this.IFF.currentSurface.attributes.refractiveIndex=this.IFF.reader.getFloat32(),this.IFF.reader.skip(2);break;case"TIMG":this.IFF.currentSurface.attributes.refractionMap=this.IFF.reader.getVariableLengthIndex();break;case"IMAP":this.IFF.currentSurface.attributes.imageMapIndex=this.IFF.reader.getUint32();break;case"IUVI":this.IFF.currentNode.UVChannel=this.IFF.reader.getString(r);break;case"IUTL":this.IFF.currentNode.widthWrappingMode=this.IFF.reader.getUint32();break;case"IVTL":this.IFF.currentNode.heightWrappingMode=this.IFF.reader.getUint32();break;default:this.IFF.parseUnknownCHUNK(e,r)}"FORM"!=e&&(this.IFF.debugger.node=1,this.IFF.debugger.nodeID=e,this.IFF.debugger.log()),this.IFF.reader.offset>=this.IFF.currentFormEnd&&(this.IFF.currentForm=this.IFF.parentForm)}},a.prototype={constructor:a,parse:function(e){if(this.reader=new s(e),this.tree={materials:{},layers:[],tags:[],textures:[]},this.currentLayer=this.tree,this.currentForm=this.tree,this.parseTopForm(),void 0!==this.tree.format){if("LWO2"===this.tree.format)for(this.parser=new r(this);!this.reader.endOfFile();)this.parser.parseBlock();else if("LWO3"===this.tree.format)for(this.parser=new t(this);!this.reader.endOfFile();)this.parser.parseBlock();return this.debugger.offset=this.reader.offset,this.debugger.closeForms(),this.tree}},parseTopForm(){if(this.debugger.offset=this.reader.offset,"FORM"===this.reader.getIDTag()){var e=this.reader.getUint32();this.debugger.dataOffset=this.reader.offset,this.debugger.length=e;var r=this.reader.getIDTag();"LWO2"===r?this.tree.format=r:"LWO3"===r&&(this.tree.format=r),this.debugger.node=0,this.debugger.nodeID=r,this.debugger.log()}else console.warn("LWOLoader: Top-level FORM missing.")},parseForm(e){var r=this.reader.getIDTag();switch(r){case"ISEQ":case"ANIM":case"STCC":case"VPVL":case"VPRM":case"NROT":case"WRPW":case"WRPH":case"FUNC":case"FALL":case"OPAC":case"GRAD":case"ENVS":case"VMOP":case"VMBG":case"OMAX":case"STEX":case"CKBG":case"CKEY":case"VMLA":case"VMLB":this.debugger.skipped=!0,this.skipForm(e);break;case"META":case"NNDS":case"NODS":case"NDTA":case"ADAT":case"AOVS":case"BLOK":case"IBGC":case"IOPC":case"IIMG":case"TXTR":this.debugger.length=4,this.debugger.skipped=!0;break;case"IFAL":case"ISCL":case"IPOS":case"IROT":case"IBMP":case"IUTD":case"IVTD":this.parseTextureNodeAttribute(r);break;case"ENVL":this.parseEnvelope(e);break;case"CLIP":"LWO2"===this.tree.format?this.parseForm(e):this.parseClip(e);break;case"STIL":this.parseImage();break;case"XREF":this.reader.skip(8),this.currentForm.referenceTexture={index:this.reader.getUint32(),refName:this.reader.getString()};break;case"IMST":this.parseImageStateForm(e);break;case"SURF":this.parseSurfaceForm(e);break;case"VALU":this.parseValueForm(e);break;case"NTAG":this.parseSubNode(e);break;case"ATTR":case"SATR":this.setupForm("attributes",e);break;case"NCON":this.parseConnections(e);break;case"SSHA":this.parentForm=this.currentForm,this.currentForm=this.currentSurface,this.setupForm("surfaceShader",e);break;case"SSHD":this.setupForm("surfaceShaderData",e);break;case"ENTR":this.parseEntryForm(e);break;case"IMAP":this.parseImageMap(e);break;case"TAMP":this.parseXVAL("amplitude",e);break;case"TMAP":this.setupForm("textureMap",e);break;case"CNTR":this.parseXVAL3("center",e);break;case"SIZE":this.parseXVAL3("scale",e);break;case"ROTA":this.parseXVAL3("rotation",e);break;default:this.parseUnknownForm(r,e)}this.debugger.node=0,this.debugger.nodeID=r,this.debugger.log()},setupForm(e,r){this.currentForm||(this.currentForm=this.currentNode),this.currentFormEnd=this.reader.offset+r,this.parentForm=this.currentForm,this.currentForm[e]?(console.warn("LWOLoader: form already exists on parent: ",e,this.currentForm),this.currentForm=this.currentForm[e]):(this.currentForm[e]={},this.currentForm=this.currentForm[e])},skipForm(e){this.reader.skip(e-4)},parseUnknownForm(r,t){var a,s,i;console.warn("LWOLoader: unknown FORM encountered: "+r,t),a=this.reader.dv.buffer,s=this.reader.offset,i=t-4,console.log(e.LoaderUtils.decodeText(new Uint8Array(a,s,i))),this.reader.skip(t-4)},parseSurfaceForm(e){this.reader.skip(8);var r=this.reader.getString(),t={attributes:{},connections:{},name:r,inputName:r,nodes:{},source:this.reader.getString()};this.tree.materials[r]=t,this.currentSurface=t,this.parentForm=this.tree.materials,this.currentForm=t,this.currentFormEnd=this.reader.offset+e},parseSurfaceLwo2(e){var r=this.reader.getString(),t={attributes:{},connections:{},name:r,nodes:{},source:this.reader.getString()};this.tree.materials[r]=t,this.currentSurface=t,this.parentForm=this.tree.materials,this.currentForm=t,this.currentFormEnd=this.reader.offset+e},parseSubNode(e){this.reader.skip(8);var r={name:this.reader.getString()};this.currentForm=r,this.currentNode=r,this.currentFormEnd=this.reader.offset+e},parseConnections(e){this.currentFormEnd=this.reader.offset+e,this.parentForm=this.currentForm,this.currentForm=this.currentSurface.connections},parseEntryForm(e){this.reader.skip(8);var r=this.reader.getString();this.currentForm=this.currentNode.attributes,this.setupForm(r,e)},parseValueForm(){this.reader.skip(8);var e=this.reader.getString();"double"===e?this.currentForm.value=this.reader.getUint64():"int"===e?this.currentForm.value=this.reader.getUint32():"vparam"===e?(this.reader.skip(24),this.currentForm.value=this.reader.getFloat64()):"vparam3"===e&&(this.reader.skip(24),this.currentForm.value=this.reader.getFloat64Array(3))},parseImageStateForm(){this.reader.skip(8),this.currentForm.mipMapLevel=this.reader.getFloat32()},parseImageMap(e){this.currentFormEnd=this.reader.offset+e,this.parentForm=this.currentForm,this.currentForm.maps||(this.currentForm.maps=[]);var r={};this.currentForm.maps.push(r),this.currentForm=r,this.reader.skip(10)},parseTextureNodeAttribute(e){switch(this.reader.skip(28),this.reader.skip(20),e){case"ISCL":this.currentNode.scale=this.reader.getFloat32Array(3);break;case"IPOS":this.currentNode.position=this.reader.getFloat32Array(3);break;case"IROT":this.currentNode.rotation=this.reader.getFloat32Array(3);break;case"IFAL":this.currentNode.falloff=this.reader.getFloat32Array(3);break;case"IBMP":this.currentNode.amplitude=this.reader.getFloat32();break;case"IUTD":this.currentNode.uTiles=this.reader.getFloat32();break;case"IVTD":this.currentNode.vTiles=this.reader.getFloat32()}this.reader.skip(2)},parseEnvelope(e){this.reader.skip(e-4)},parseClip(e){if("FORM"===this.reader.getIDTag())return this.reader.skip(16),void(this.currentNode.fileName=this.reader.getString());this.reader.setOffset(this.reader.offset-4),this.currentFormEnd=this.reader.offset+e,this.parentForm=this.currentForm,this.reader.skip(8);var r={index:this.reader.getUint32()};this.tree.textures.push(r),this.currentForm=r},parseClipLwo2(e){for(var r={index:this.reader.getUint32(),fileName:""};;){var t=this.reader.getIDTag(),a=this.reader.getUint16();if("STIL"===t){r.fileName=this.reader.getString();break}if(a>=e)break}this.tree.textures.push(r),this.currentForm=r},parseImage(){this.reader.skip(8),this.currentForm.fileName=this.reader.getString()},parseXVAL(e,r){var t=this.reader.offset+r-4;this.reader.skip(8),this.currentForm[e]=this.reader.getFloat32(),this.reader.setOffset(t)},parseXVAL3(e,r){var t=this.reader.offset+r-4;this.reader.skip(8),this.currentForm[e]={x:this.reader.getFloat32(),y:this.reader.getFloat32(),z:this.reader.getFloat32()},this.reader.setOffset(t)},parseObjectTag(){this.tree.objectTags||(this.tree.objectTags={}),this.tree.objectTags[this.reader.getIDTag()]={tagString:this.reader.getString()}},parseLayer(e){var r={number:this.reader.getUint16(),flags:this.reader.getUint16(),pivot:this.reader.getFloat32Array(3),name:this.reader.getString()};this.tree.layers.push(r),this.currentLayer=r;var t=16+c(this.currentLayer.name);this.currentLayer.parent=t<e?this.reader.getUint16():-1},parsePoints(e){this.currentPoints=[];for(var r=0;r<e/4;r+=3)this.currentPoints.push(this.reader.getFloat32(),this.reader.getFloat32(),-this.reader.getFloat32())},parseVertexMapping(e,r){var t=this.reader.offset+e,a=this.reader.getString();if(this.reader.offset!==t){this.reader.setOffset(this.reader.offset-c(a));var s=this.reader.getIDTag();this.reader.getUint16();var i=this.reader.getString(),n=e-6-c(i);switch(s){case"TXUV":this.parseUVMapping(i,t,r);break;case"MORF":case"SPOT":this.parseMorphTargets(i,t,s);break;case"APSL":case"NORM":case"WGHT":case"MNVW":case"PICK":case"RGB ":case"RGBA":this.reader.skip(n);break;default:console.warn("LWOLoader: unknown vertex map type: "+s),this.reader.skip(n)}}else this.currentForm.UVChannel=a},parseUVMapping(e,r,t){for(var a=[],s=[],i=[];this.reader.offset<r;)a.push(this.reader.getVariableLengthIndex()),t&&s.push(this.reader.getVariableLengthIndex()),i.push(this.reader.getFloat32(),this.reader.getFloat32());t?(this.currentLayer.discontinuousUVs||(this.currentLayer.discontinuousUVs={}),this.currentLayer.discontinuousUVs[e]={uvIndices:a,polyIndices:s,uvs:i}):(this.currentLayer.uvs||(this.currentLayer.uvs={}),this.currentLayer.uvs[e]={uvIndices:a,uvs:i})},parseMorphTargets(e,r,t){var a=[],s=[];for(t="MORF"===t?"relative":"absolute";this.reader.offset<r;)a.push(this.reader.getVariableLengthIndex()),s.push(this.reader.getFloat32(),this.reader.getFloat32(),-this.reader.getFloat32());this.currentLayer.morphTargets||(this.currentLayer.morphTargets={}),this.currentLayer.morphTargets[e]={indices:a,points:s,type:t}},parsePolygonList(e){for(var r=this.reader.offset+e,t=this.reader.getIDTag(),a=[],s=[];this.reader.offset<r;){var i=this.reader.getUint16();i&=1023,s.push(i);for(var n=0;n<i;n++)a.push(this.reader.getVariableLengthIndex())}var c={type:t,vertexIndices:a,polygonDimensions:s,points:this.currentPoints};1===s[0]?c.type="points":2===s[0]&&(c.type="lines"),this.currentLayer.geometry=c},parseTagStrings(e){this.tree.tags=this.reader.getStringArray(e)},parsePolygonTagMapping(e){var r=this.reader.offset+e;"SURF"===this.reader.getIDTag()?this.parseMaterialIndices(r):this.reader.skip(e-4)},parseMaterialIndices(e){for(this.currentLayer.geometry.materialIndices=[];this.reader.offset<e;){var r=this.reader.getVariableLengthIndex(),t=this.reader.getUint16();this.currentLayer.geometry.materialIndices.push(r,t)}},parseUnknownCHUNK(e,r){console.warn("LWOLoader: unknown chunk type: "+e+" length: "+r);var t=this.reader.getString(r);this.currentForm[e]=t}},s.prototype={constructor:s,size:function(){return this.dv.buffer.byteLength},setOffset(e){e>0&&e<this.dv.buffer.byteLength?this.offset=e:console.error("LWOLoader: invalid buffer offset")},endOfFile:function(){return this.offset>=this.size()},skip:function(e){this.offset+=e},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getUint16:function(){var e=this.dv.getUint16(this.offset);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,!1);return this.offset+=4,e},getUint32:function(){var e=this.dv.getUint32(this.offset,!1);return this.offset+=4,e},getUint64:function(){return 4294967296*this.getUint32()+this.getUint32()},getFloat32:function(){var e=this.dv.getFloat32(this.offset,!1);return this.offset+=4,e},getFloat32Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getFloat32());return r},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var r=[],t=0;t<e;t++)r.push(this.getFloat64());return r},getVariableLengthIndex(){var e=this.getUint8();return 255===e?65536*this.getUint8()+256*this.getUint8()+this.getUint8():256*e+this.getUint8()},getIDTag(){return this.getString(4)},getString:function(r){if(0!==r){var t=[];if(r)for(var a=0;a<r;a++)t[a]=this.getUint8();else{for(var s,i=0;0!==s;)0!==(s=this.getUint8())&&t.push(s),i++;n(i+1)||this.getUint8()}return e.LoaderUtils.decodeText(new Uint8Array(t))}},getStringArray:function(e){var r=this.getString(e);return(r=r.split("\0")).filter(Boolean)}},i.prototype={constructor:i,enable:function(){this.active=!0},log:function(){if(this.active){var e;switch(this.node){case 0:e="FORM";break;case 1:e="CHK";break;case 2:e="S-CHK"}console.log("| ".repeat(this.depth)+e,this.nodeID,`( ${this.offset} ) -> ( ${this.dataOffset+this.length} )`,0==this.node?" {":"",this.skipped?"SKIPPED":"",0==this.node&&this.skipped?"}":""),0!=this.node||this.skipped||(this.depth+=1,this.formList.push(this.dataOffset+this.length)),this.skipped=!1}},closeForms:function(){if(this.active)for(var e=this.formList.length-1;e>=0;e--)this.offset>=this.formList[e]&&(this.depth-=1,console.log("| ".repeat(this.depth)+"}"),this.formList.splice(-1,1))}};var h=function(r,t){e.Loader.call(this,r),t=t||{},this.resourcePath=void 0!==t.resourcePath?t.resourcePath:""};function F(e){this.textureLoader=e}function u(e){this.textureLoader=e}function p(){}return h.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:h,load:function(r,t,a,s){var i=this,n=""===i.path?function(e,r){var t=e.indexOf(r);return-1===t?"./":e.substr(0,t)}(r,"Objects"):i.path,c=r.split(n).pop().split(".")[0],o=new e.FileLoader(this.manager);o.setPath(i.path),o.setResponseType("arraybuffer"),o.load(r,function(e){t(i.parse(e,n,c))},a,s)},parse:function(r,t,s){return o=(new a).parse(r),new F(new e.TextureLoader(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin)).parse(s)}}),F.prototype={constructor:F,parse:function(e){return this.materials=new u(this.textureLoader).parse(),this.defaultLayerName=e,this.meshes=this.parseLayers(),{materials:this.materials,meshes:this.meshes}},parseLayers(){var e=[],r=[],t=new p,a=this;return o.layers.forEach(function(s){var i=t.parse(s.geometry,s),n=a.parseMesh(i,s);e[s.number]=n,-1===s.parent?r.push(n):e[s.parent].add(n)}),this.applyPivots(r),r},parseMesh(r,t){var a,s=this.getMaterials(r.userData.matNames,t.geometry.type);return this.duplicateUVs(r,s),a="points"===t.geometry.type?new e.Points(r,s):"lines"===t.geometry.type?new e.LineSegments(r,s):new e.Mesh(r,s),t.name?a.name=t.name:a.name=this.defaultLayerName+"_layer_"+t.number,a.userData.pivot=t.pivot,a},applyPivots(e){e.forEach(function(e){e.traverse(function(e){var r=e.userData.pivot;if(e.position.x+=r[0],e.position.y+=r[1],e.position.z+=r[2],e.parent){var t=e.parent.userData.pivot;e.position.x-=t[0],e.position.y-=t[1],e.position.z-=t[2]}})})},getMaterials(r,t){var a=[],s=this;r.forEach(function(e,r){a[r]=s.getMaterialByName(e)}),"points"!==t&&"lines"!==t||a.forEach(function(r,s){var i={color:r.color};"points"===t?(i.size=.1,i.map=r.map,i.morphTargets=r.morphTargets,a[s]=new e.PointsMaterial(i)):"lines"===t&&(a[s]=new e.LineBasicMaterial(i))});var i=a.filter(Boolean);return 1===i.length?i[0]:a},getMaterialByName(e){return this.materials.filter(function(r){return r.name===e})[0]},duplicateUVs(r,t){var a=!1;Array.isArray(t)?t.forEach(function(e){e.aoMap&&(a=!0)}):t.aoMap&&(a=!0),a&&r.setAttribute("uv2",new e.BufferAttribute(r.attributes.uv.array,2))}},u.prototype={constructor:u,parse:function(){var e=[];for(var r in this.textures={},o.materials)"LWO3"===o.format?e.push(this.parseMaterial(o.materials[r],r,o.textures)):"LWO2"===o.format&&e.push(this.parseMaterialLwo2(o.materials[r],r,o.textures));return e},parseMaterial(e,r,t){var a={name:r,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)},s=this.parseConnections(e.connections,e.nodes),i=this.parseTextureNodes(s.maps);this.parseAttributeImageMaps(s.attributes,t,i,e.maps);var n=this.parseAttributes(s.attributes,i);return this.parseEnvMap(s,i,n),a=Object.assign(i,a),a=Object.assign(a,n),new(this.getMaterialType(s.attributes))(a)},parseMaterialLwo2(r,t){var a={name:t,side:this.getSide(r.attributes),flatShading:this.getSmooth(r.attributes)},s=this.parseAttributes(r.attributes,{});return a=Object.assign(a,s),new e.MeshPhongMaterial(a)},getSide(r){if(!r.side)return e.BackSide;switch(r.side){case 0:case 1:return e.BackSide;case 2:return e.FrontSide;case 3:return e.DoubleSide}},getSmooth:e=>!e.smooth||!e.smooth,parseConnections(e,r){var t={maps:{}},a=e.inputName,s=e.inputNodeName,i=e.nodeName,n=this;return a.forEach(function(e,a){if("Material"===e){var i=n.getNodeByRefName(s[a],r);t.attributes=i.attributes,t.envMap=i.fileName,t.name=s[a]}}),i.forEach(function(e,i){e===t.name&&(t.maps[a[i]]=n.getNodeByRefName(s[i],r))}),t},getNodeByRefName(e,r){for(var t in r)if(r[t].refName===e)return r[t]},parseTextureNodes(r){var t={};for(var a in r){var s=r[a],i=s.fileName;if(!i)return;var n=this.loadTexture(i);switch(void 0!==s.widthWrappingMode&&(n.wrapS=this.getWrappingType(s.widthWrappingMode)),void 0!==s.heightWrappingMode&&(n.wrapT=this.getWrappingType(s.heightWrappingMode)),a){case"Color":t.map=n;break;case"Roughness":t.roughnessMap=n,t.roughness=.5;break;case"Specular":t.specularMap=n,t.specular=16777215;break;case"Luminous":t.emissiveMap=n,t.emissive=8421504;break;case"Luminous Color":t.emissive=8421504;break;case"Metallic":t.metalnessMap=n,t.metalness=.5;break;case"Transparency":case"Alpha":t.alphaMap=n,t.transparent=!0;break;case"Normal":t.normalMap=n,void 0!==s.amplitude&&(t.normalScale=new e.Vector2(s.amplitude,s.amplitude));break;case"Bump":t.bumpMap=n}}return t.roughnessMap&&t.specularMap&&delete t.specularMap,t},parseAttributeImageMaps(e,r,t){for(var a in e){var s=e[a];if(s.maps){var i=s.maps[0],n=this.getTexturePathByIndex(i.imageIndex,r);if(!n)return;var c=this.loadTexture(n);switch(void 0!==i.wrap&&(c.wrapS=this.getWrappingType(i.wrap.w)),void 0!==i.wrap&&(c.wrapT=this.getWrappingType(i.wrap.h)),a){case"Color":t.map=c;break;case"Diffuse":t.aoMap=c;break;case"Roughness":t.roughnessMap=c,t.roughness=1;break;case"Specular":t.specularMap=c,t.specular=16777215;break;case"Luminosity":t.emissiveMap=c,t.emissive=8421504;break;case"Metallic":t.metalnessMap=c,t.metalness=1;break;case"Transparency":case"Alpha":t.alphaMap=c,t.transparent=!0;break;case"Normal":t.normalMap=c;break;case"Bump":t.bumpMap=c}}}},parseAttributes(r,t){var a={};return r.undefined&&!t.map?a.color=(new e.Color).fromArray(r.undefined.value):a.color=new e.Color,r.Transparency&&0!==r.Transparency.value&&(a.opacity=1-r.Transparency.value,a.transparent=!0),r["Bump Height"]&&(a.bumpScale=.1*r["Bump Height"].value),r["Refraction Index"]&&(a.refractionRatio=1/r["Refraction Index"].value),this.parsePhysicalAttributes(a,r,t),this.parseStandardAttributes(a,r,t),this.parsePhongAttributes(a,r,t),a},parsePhysicalAttributes(e,r){r.Clearcoat&&r.Clearcoat.value>0&&(e.clearcoat=r.Clearcoat.value,r["Clearcoat Gloss"]&&(e.clearcoatRoughness=.5*(1-r["Clearcoat Gloss"].value)))},parseStandardAttributes(r,t,a){t.Luminous&&(r.emissiveIntensity=t.Luminous.value,t["Luminous Color"]&&!a.emissive?r.emissive=(new e.Color).fromArray(t["Luminous Color"].value):r.emissive=new e.Color(8421504)),t.Roughness&&!a.roughnessMap&&(r.roughness=t.Roughness.value),t.Metallic&&!a.metalnessMap&&(r.metalness=t.Metallic.value)},parsePhongAttributes(r,t,a){t.Diffuse&&r.color.multiplyScalar(t.Diffuse.value),t.Reflection&&(r.reflectivity=t.Reflection.value,r.combine=e.AddOperation),t.Luminosity&&(r.emissiveIntensity=t.Luminosity.value,a.emissiveMap||a.map?r.emissive=new e.Color(8421504):r.emissive=r.color),t.Roughness||!t.Specular||a.specularMap||(t["Color Highlight"]?r.specular=(new e.Color).setScalar(t.Specular.value).lerp(r.color.clone().multiplyScalar(t.Specular.value),t["Color Highlight"].value):r.specular=(new e.Color).setScalar(t.Specular.value)),r.specular&&t.Glossiness&&(r.shininess=7+Math.pow(2,12*t.Glossiness.value+2))},parseEnvMap(r,t,a){if(r.envMap){var s=this.loadTexture(r.envMap);a.transparent&&a.opacity<.999?(s.mapping=e.EquirectangularRefractionMapping,void 0!==a.reflectivity&&(delete a.reflectivity,delete a.combine),void 0!==a.metalness&&delete a.metalness):s.mapping=e.EquirectangularReflectionMapping,t.envMap=s}},getTexturePathByIndex(e){var r="";return o.textures?(o.textures.forEach(function(t){t.index===e&&(r=t.fileName)}),r):r},loadTexture(e){return e?this.textureLoader.load(e,void 0,void 0,function(){console.warn("LWOLoader: non-standard resource hierarchy. Use `resourcePath` parameter to specify root content directory.")}):null},getWrappingType(r){switch(r){case 0:return console.warn('LWOLoader: "Reset" texture wrapping type is not supported in three'),e.ClampToEdgeWrapping;case 1:return e.RepeatWrapping;case 2:return e.MirroredRepeatWrapping;case 3:return e.ClampToEdgeWrapping}},getMaterialType:r=>r.Clearcoat&&r.Clearcoat.value>0?e.MeshPhysicalMaterial:r.Roughness?e.MeshStandardMaterial:e.MeshPhongMaterial},p.prototype={constructor:p,parse(r,t){var a=new e.BufferGeometry;a.setAttribute("position",new e.Float32BufferAttribute(r.points,3));var s=this.splitIndices(r.vertexIndices,r.polygonDimensions);return a.setIndex(s),this.parseGroups(a,r),a.computeVertexNormals(),this.parseUVs(a,t,s),this.parseMorphTargets(a,t,s),a.translate(-t.pivot[0],-t.pivot[1],-t.pivot[2]),a},splitIndices(e,r){var t=[],a=0;return r.forEach(function(r){if(r<4)for(var s=0;s<r;s++)t.push(e[a+s]);else if(4===r)t.push(e[a],e[a+1],e[a+2],e[a],e[a+2],e[a+3]);else if(r>4){for(s=1;s<r-1;s++)t.push(e[a],e[a+s],e[a+s+1]);console.warn("LWOLoader: polygons with greater than 4 sides are not supported")}a+=r}),t},parseGroups(e,r){var t=o.tags,a=[],s=3;"lines"===r.type&&(s=2),"points"===r.type&&(s=1);for(var i,n=this.splitMaterialIndices(r.polygonDimensions,r.materialIndices),c=0,h={},F=0,u=0,p=0;p<n.length;p+=2){var d,g=n[p+1];if(0===p&&(a[c]=t[g]),void 0===i&&(i=g),g!==i)h[t[i]]?d=h[t[i]]:(d=c,h[t[i]]=c,a[c]=t[i],c++),e.addGroup(F,u,d),F+=u,i=g,u=0;u+=s}e.groups.length>0&&(h[t[g]]?d=h[t[g]]:(d=c,h[t[g]]=c,a[c]=t[g]),e.addGroup(F,u,d));e.userData.matNames=a},splitMaterialIndices(e,r){var t=[];return e.forEach(function(e,a){if(e<=3)t.push(r[2*a],r[2*a+1]);else if(4===e)t.push(r[2*a],r[2*a+1],r[2*a],r[2*a+1]);else for(var s=0;s<e-2;s++)t.push(r[2*a],r[2*a+1])}),t},parseUVs(r,t){var a=Array.from(Array(2*r.attributes.position.count),function(){return 0});for(var s in t.uvs){var i=t.uvs[s].uvs;t.uvs[s].uvIndices.forEach(function(e,r){a[2*e]=i[2*r],a[2*e+1]=i[2*r+1]})}r.setAttribute("uv",new e.Float32BufferAttribute(a,2))},parseMorphTargets(r,t){var a=0;for(var s in t.morphTargets){var i=r.attributes.position.array.slice();r.morphAttributes.position||(r.morphAttributes.position=[]);var n=t.morphTargets[s].points,c=t.morphTargets[s].indices,o=t.morphTargets[s].type;c.forEach(function(e,r){"relative"===o?(i[3*e]+=n[3*r],i[3*e+1]+=n[3*r+1],i[3*e+2]+=n[3*r+2]):(i[3*e]=n[3*r],i[3*e+1]=n[3*r+1],i[3*e+2]=n[3*r+2])}),r.morphAttributes.position[a]=new e.Float32BufferAttribute(i,3),r.morphAttributes.position[a].name=s,a++}r.morphTargetsRelative=!1}},h});
//# sourceMappingURL=../sourcemaps/loaders/LWOLoader.js.map
