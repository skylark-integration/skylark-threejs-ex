/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs"],function(e){return e.AMFLoader=function(t){e.Loader.call(this,t)},e.AMFLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.AMFLoader,load:function(t,n,a,r){var o=this,i=new e.FileLoader(o.manager);i.setPath(o.path),i.setResponseType("arraybuffer"),i.load(t,function(e){n(o.parse(e))},a,r)},parse:function(t){function n(t){for(var n="AMF Material",r=t.attributes.id.textContent,o={r:1,g:1,b:1,a:1},i=null,l=0;l<t.childNodes.length;l++){var s=t.childNodes[l];"metadata"===s.nodeName&&void 0!==s.attributes.type?"name"===s.attributes.type.value&&(n=s.textContent):"color"===s.nodeName&&(o=a(s))}return i=new e.MeshPhongMaterial({flatShading:!0,color:new e.Color(o.r,o.g,o.b),name:n}),1!==o.a&&(i.transparent=!0,i.opacity=o.a),{id:r,material:i}}function a(e){for(var t={r:1,g:1,b:1,a:1},n=0;n<e.childNodes.length;n++){var a=e.childNodes[n];"r"===a.nodeName?t.r=a.textContent:"g"===a.nodeName?t.g=a.textContent:"b"===a.nodeName?t.b=a.textContent:"a"===a.nodeName&&(t.a=a.textContent)}return t}function r(e){var t={name:"",triangles:[],materialid:null},n=e.firstElementChild;for(void 0!==e.attributes.materialid&&(t.materialId=e.attributes.materialid.nodeValue);n;){if("metadata"===n.nodeName)void 0!==n.attributes.type&&"name"===n.attributes.type.value&&(t.name=n.textContent);else if("triangle"===n.nodeName){var a=n.getElementsByTagName("v1")[0].textContent,r=n.getElementsByTagName("v2")[0].textContent,o=n.getElementsByTagName("v3")[0].textContent;t.triangles.push(a,r,o)}n=n.nextElementSibling}return t}function o(e){for(var t=[],n=[],a=e.firstElementChild;a;){if("vertex"===a.nodeName)for(var r=a.firstElementChild;r;){if("coordinates"===r.nodeName){var o=r.getElementsByTagName("x")[0].textContent,i=r.getElementsByTagName("y")[0].textContent,l=r.getElementsByTagName("z")[0].textContent;t.push(o,i,l)}else if("normal"===r.nodeName){var s=r.getElementsByTagName("nx")[0].textContent,m=r.getElementsByTagName("ny")[0].textContent,d=r.getElementsByTagName("nz")[0].textContent;n.push(s,m,d)}r=r.nextElementSibling}a=a.nextElementSibling}return{vertices:t,normals:n}}function i(e){for(var t=e.attributes.id.textContent,n={name:"amfobject",meshes:[]},i=null,l=e.firstElementChild;l;){if("metadata"===l.nodeName)void 0!==l.attributes.type&&"name"===l.attributes.type.value&&(n.name=l.textContent);else if("color"===l.nodeName)i=a(l);else if("mesh"===l.nodeName){for(var s=l.firstElementChild,m={vertices:[],normals:[],volumes:[],color:i};s;){if("vertices"===s.nodeName){var d=o(s);m.normals=m.normals.concat(d.normals),m.vertices=m.vertices.concat(d.vertices)}else"volume"===s.nodeName&&m.volumes.push(r(s));s=s.nextElementSibling}n.meshes.push(m)}l=l.nextElementSibling}return{id:t,obj:n}}var l,s,m=function(t){var n=new DataView(t);if("PK"===String.fromCharCode(n.getUint8(0),n.getUint8(1))){var a=null,r=null;console.log("THREE.AMFLoader: Loading Zip");try{a=new JSZip(t)}catch(e){if(e instanceof ReferenceError)return console.log("THREE.AMFLoader: jszip missing and file is compressed."),null}for(r in a.files)if(".amf"===r.toLowerCase().substr(-4))break;console.log("THREE.AMFLoader: Trying to load file asset: "+r),n=new DataView(a.file(r).asArrayBuffer())}var o=e.LoaderUtils.decodeText(n),i=(new DOMParser).parseFromString(o,"application/xml");return"amf"!==i.documentElement.nodeName.toLowerCase()?(console.log("THREE.AMFLoader: Error loading AMF - no AMF document found."),null):i}(t),d="",u="",c=function(e){var t=1,n="millimeter";void 0!==e.documentElement.attributes.unit&&(n=e.documentElement.attributes.unit.value.toLowerCase());var a={millimeter:1,inch:25.4,feet:304.8,meter:1e3,micron:.001};return void 0!==a[n]&&(t=a[n]),console.log("THREE.AMFLoader: Unit scale: "+t),t}(m),f={},v={},g=m.documentElement.childNodes;for(l=0;l<g.length;l++){var h=g[l];if("metadata"===h.nodeName)void 0!==h.attributes.type&&("name"===h.attributes.type.value?d=h.textContent:"author"===h.attributes.type.value&&(u=h.textContent));else if("material"===h.nodeName){var b=n(h);f[b.id]=b.material}else if("object"===h.nodeName){var p=i(h);v[p.id]=p.obj}}var E=new e.Group,N=new e.MeshPhongMaterial({color:11184895,flatShading:!0});for(var C in E.name=d,E.userData.author=u,E.userData.loader="AMF",v){var x=v[C],y=x.meshes,w=new e.Group;for(w.name=x.name||"",l=0;l<y.length;l++){var M=N,A=y[l],F=new e.Float32BufferAttribute(A.vertices,3),L=null;if(A.normals.length&&(L=new e.Float32BufferAttribute(A.normals,3)),A.color){var T=A.color;(M=N.clone()).color=new e.Color(T.r,T.g,T.b),1!==T.a&&(M.transparent=!0,M.opacity=T.a)}var B=A.volumes;for(s=0;s<B.length;s++){var S=B[s],j=new e.BufferGeometry,R=M;j.setIndex(S.triangles),j.setAttribute("position",F.clone()),L&&j.setAttribute("normal",L.clone()),void 0!==f[S.materialId]&&(R=f[S.materialId]),j.scale(c,c,c),w.add(new e.Mesh(j,R.clone()))}}E.add(w)}return E}}),e.AMFLoader});
//# sourceMappingURL=../sourcemaps/loaders/AMFLoader.js.map
