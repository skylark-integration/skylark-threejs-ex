/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs","../threex","skylark-zlib/Gunzip","../misc/Volume"],function(r,e,t,n){"use strict";var a=function(e){r.Loader.call(this,e)};return a.prototype=Object.assign(Object.create(r.Loader.prototype),{constructor:a,load:function(e,t,n,a){var s=this,i=new r.FileLoader(s.manager);i.setPath(s.path),i.setResponseType("arraybuffer"),i.load(e,function(r){t(s.parse(r))},n,a)},parse:function(e){var s=e,i=0,o=new Int8Array(new Int16Array([1]).buffer)[0]>0,c=!0,h={};var u=function(r,e){void 0!==e&&null!==e||(e=1);var t=1,n=Uint8Array;switch(r){case"uchar":break;case"schar":n=Int8Array;break;case"ushort":n=Uint16Array,t=2;break;case"sshort":n=Int16Array,t=2;break;case"uint":n=Uint32Array,t=4;break;case"sint":n=Int32Array,t=4;break;case"float":n=Float32Array,t=4;break;case"complex":case"double":n=Float64Array,t=8}var a=new n(s.slice(i,i+=e*t));return o!=c&&(a=function(r,e){for(var t=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),n=0;n<r.byteLength;n+=e)for(var a=n+e-1,s=n;a>s;a--,s++){var i=t[s];t[s]=t[a],t[a]=i}return r}(a,t)),1==e?a[0]:a}("uchar",e.byteLength),l=u.length,p=null,f=0;for(y=1;y<l;y++)if(10==u[y-1]&&10==u[y]){p=this.parseChars(u,0,y-2),f=y+1;break}!function(e){var t,n,s,i,o,c,u,l,p;for(l=0,p=(c=e.split(/\r?\n/)).length;l<p;l++)(o=c[l]).match(/NRRD\d+/)?h.isNrrd=!0:o.match(/^#/)||(u=o.match(/(.*):(.*)/))&&(n=u[1].trim(),t=u[2].trim(),(s=a.prototype.fieldFunctions[n])?s.call(h,t):h[n]=t);if(!h.isNrrd)throw new Error("Not an NRRD file");if("bz2"===h.encoding||"bzip2"===h.encoding)throw new Error("Bzip is not supported");if(!h.vectors&&(h.vectors=[new r.Vector3(1,0,0),new r.Vector3(0,1,0),new r.Vector3(0,0,1)],h.spacings))for(i=0;i<=2;i++)isNaN(h.spacings[i])||h.vectors[i].multiplyScalar(h.spacings[i])}(p);s=u.subarray(f);if("gzip"===h.encoding||"gz"===h.encoding){var d=new t(new Uint8Array(s));s=d.decompress()}else if("ascii"===h.encoding||"text"===h.encoding||"txt"===h.encoding||"hex"===h.encoding)s=function(r,e,t){var n,a="";e=e||0,t=t||r.length;var s=h.sizes.reduce(function(r,e){return r*e},1),i=10;"hex"===h.encoding&&(i=16);var o=new h.__array(s),c=0,u=parseInt;h.__array!==Float32Array&&h.__array!==Float64Array||(u=parseFloat);for(var l=e;l<t;l++)((n=r[l])<9||n>13)&&32!==n?a+=String.fromCharCode(n):(""!==a&&(o[c]=u(a,i),c++),a="");return""!==a&&(o[c]=u(a,i),c++),o}(s);else if("raw"===h.encoding){for(var g=new Uint8Array(s.length),y=0;y<s.length;y++)g[y]=s[y];s=g}s=s.buffer;var v=new n;v.header=h,v.data=new h.__array(s);var w=v.computeMinMax(),b=w[0],_=w[1];v.windowLow=b,v.windowHigh=_,v.dimensions=[h.sizes[0],h.sizes[1],h.sizes[2]],v.xLength=v.dimensions[0],v.yLength=v.dimensions[1],v.zLength=v.dimensions[2];var m=new r.Vector3(h.vectors[0][0],h.vectors[0][1],h.vectors[0][2]).length(),A=new r.Vector3(h.vectors[1][0],h.vectors[1][1],h.vectors[1][2]).length(),k=new r.Vector3(h.vectors[2][0],h.vectors[2][1],h.vectors[2][2]).length();v.spacing=[m,A,k],v.matrix=new r.Matrix4;var x=1,z=1;if("left-posterior-superior"==h.space?(x=-1,z=-1):"left-anterior-superior"===h.space&&(x=-1),h.vectors){var L=h.vectors;v.matrix.set(x*L[0][0],x*L[1][0],x*L[2][0],0,z*L[0][1],z*L[1][1],z*L[2][1],0,1*L[0][2],1*L[1][2],1*L[2][2],0,0,0,0,1)}else v.matrix.set(x,0,0,0,0,z,0,0,0,0,1,0,0,0,0,1);return v.inverseMatrix=new r.Matrix4,v.inverseMatrix.getInverse(v.matrix),v.RASDimensions=new r.Vector3(v.xLength,v.yLength,v.zLength).applyMatrix4(v.matrix).round().toArray().map(Math.abs),v.lowerThreshold===-1/0&&(v.lowerThreshold=b),v.upperThreshold===1/0&&(v.upperThreshold=_),v},parseChars:function(r,e,t){void 0===e&&(e=0),void 0===t&&(t=r.length);var n="",a=0;for(a=e;a<t;++a)n+=String.fromCharCode(r[a]);return n},fieldFunctions:{type:function(r){switch(r){case"uchar":case"unsigned char":case"uint8":case"uint8_t":this.__array=Uint8Array;break;case"signed char":case"int8":case"int8_t":this.__array=Int8Array;break;case"short":case"short int":case"signed short":case"signed short int":case"int16":case"int16_t":this.__array=Int16Array;break;case"ushort":case"unsigned short":case"unsigned short int":case"uint16":case"uint16_t":this.__array=Uint16Array;break;case"int":case"signed int":case"int32":case"int32_t":this.__array=Int32Array;break;case"uint":case"unsigned int":case"uint32":case"uint32_t":this.__array=Uint32Array;break;case"float":this.__array=Float32Array;break;case"double":this.__array=Float64Array;break;default:throw new Error("Unsupported NRRD data type: "+r)}return this.type=r},endian:function(r){return this.endian=r},encoding:function(r){return this.encoding=r},dimension:function(r){return this.dim=parseInt(r,10)},sizes:function(r){var e;return this.sizes=function(){var t,n,a,s;for(s=[],t=0,n=(a=r.split(/\s+/)).length;t<n;t++)e=a[t],s.push(parseInt(e,10));return s}()},space:function(r){return this.space=r},"space origin":function(r){return this.space_origin=r.split("(")[1].split(")")[0].split(",")},"space directions":function(r){var e,t,n;return t=r.match(/\(.*?\)/g),this.vectors=function(){var r,a,s;for(s=[],r=0,a=t.length;r<a;r++)n=t[r],s.push(function(){var r,t,a,s;for(s=[],r=0,t=(a=n.slice(1,-1).split(/,/)).length;r<t;r++)e=a[r],s.push(parseFloat(e));return s}());return s}()},spacings:function(r){var e,t;return t=r.split(/\s+/),this.spacings=function(){var r,n,a=[];for(r=0,n=t.length;r<n;r++)e=t[r],a.push(parseFloat(e));return a}()}}}),e.loaders.NRRDLoader=a});
//# sourceMappingURL=../sourcemaps/loaders/NRRDLoader.js.map
