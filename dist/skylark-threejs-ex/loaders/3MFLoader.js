/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs"],function(e){return e.ThreeMFLoader=function(t){e.Loader.call(this,t),this.availableExtensions=[]},e.ThreeMFLoader.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:e.ThreeMFLoader,load:function(t,r,a,i){var n=this,o=new e.FileLoader(n.manager);o.setPath(n.path),o.setResponseType("arraybuffer"),o.load(t,function(e){r(n.parse(e))},a,i)},parse:function(t){var r=this,a=new e.TextureLoader(this.manager);function i(e){for(var t=[],r=(new DOMParser).parseFromString(e,"application/xml").querySelectorAll("Relationship"),a=0;a<r.length;a++){var i=r[a],n={target:i.getAttribute("Target"),id:i.getAttribute("Id"),type:i.getAttribute("Type")};t.push(n)}return t}function n(e){for(var t={id:e.getAttribute("id"),basematerials:[]},r=e.querySelectorAll("base"),a=0;a<r.length;a++){var i=l(r[a]);i.index=a,t.basematerials.push(i)}return t}function o(e){for(var t={id:e.getAttribute("id"),texid:e.getAttribute("texid"),displaypropertiesid:e.getAttribute("displaypropertiesid")},r=e.querySelectorAll("tex2coord"),a=[],i=0;i<r.length;i++){var n=r[i],o=n.getAttribute("u"),s=n.getAttribute("v");a.push(parseFloat(o),parseFloat(s))}return t.uvs=new Float32Array(a),t}function s(t){for(var r={id:t.getAttribute("id"),displaypropertiesid:t.getAttribute("displaypropertiesid")},a=t.querySelectorAll("color"),i=[],n=new e.Color,o=0;o<a.length;o++){var s=a[o].getAttribute("color");n.setStyle(s.substring(0,7)),n.convertSRGBToLinear(),i.push(n.r,n.g,n.b)}return r.colors=new Float32Array(i),r}function u(e){for(var t={id:e.getAttribute("id")},r=e.querySelectorAll("pbmetallic"),a=[],i=0;i<r.length;i++){var n=r[i];a.push({name:n.getAttribute("name"),metallicness:parseFloat(n.getAttribute("metallicness")),roughness:parseFloat(n.getAttribute("roughness"))})}return t.data=a,t}function l(e){var t={};return t.name=e.getAttribute("name"),t.displaycolor=e.getAttribute("displaycolor"),t.displaypropertiesid=e.getAttribute("displaypropertiesid"),t}function p(e){var t={};t.objectId=e.getAttribute("objectid");var r=e.getAttribute("transform");return r&&(t.transform=c(r)),t}function c(t){var r=[];t.split(" ").forEach(function(e){r.push(parseFloat(e))});var a=new e.Matrix4;return a.set(r[0],r[3],r[6],r[9],r[1],r[4],r[7],r[10],r[2],r[5],r[8],r[11],0,0,0,1),a}function d(e){var t={type:e.getAttribute("type")},r=e.getAttribute("id");r&&(t.id=r);var a=e.getAttribute("pid");a&&(t.pid=a);var i=e.getAttribute("pindex");i&&(t.pindex=i);var n=e.getAttribute("thumbnail");n&&(t.thumbnail=n);var o=e.getAttribute("partnumber");o&&(t.partnumber=o);var s=e.getAttribute("name");s&&(t.name=s);var u=e.querySelector("mesh");u&&(t.mesh=function(e){for(var t={},r=[],a=e.querySelectorAll("vertices vertex"),i=0;i<a.length;i++){var n=a[i],o=n.getAttribute("x"),s=n.getAttribute("y"),u=n.getAttribute("z");r.push(parseFloat(o),parseFloat(s),parseFloat(u))}t.vertices=new Float32Array(r);var l=[],p=[],c=e.querySelectorAll("triangles triangle");for(i=0;i<c.length;i++){var d=c[i],v=d.getAttribute("v1"),h=d.getAttribute("v2"),g=d.getAttribute("v3"),f=d.getAttribute("p1"),b=d.getAttribute("p2"),m=d.getAttribute("p3"),A=d.getAttribute("pid"),y={};y.v1=parseInt(v,10),y.v2=parseInt(h,10),y.v3=parseInt(g,10),p.push(y.v1,y.v2,y.v3),f&&(y.p1=parseInt(f,10)),b&&(y.p2=parseInt(b,10)),m&&(y.p3=parseInt(m,10)),A&&(y.pid=A),0<Object.keys(y).length&&l.push(y)}return t.triangleProperties=l,t.triangles=new Uint32Array(p),t}(u));var l=e.querySelector("components");return l&&(t.components=function(e){for(var t=[],r=e.querySelectorAll("component"),a=0;a<r.length;a++){var i=p(r[a]);t.push(i)}return t}(l)),t}function v(e){var t={unit:e.getAttribute("unit")||"millimeter"},r=e.querySelectorAll("metadata");r&&(t.metadata=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r],i=a.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(i)&&(t[i]=a.textContent)}return t}(r));var a=e.querySelector("resources");a&&(t.resources=function(e){for(var t={basematerials:{}},r=e.querySelectorAll("basematerials"),a=0;a<r.length;a++){var i=n(r[a]);t.basematerials[i.id]=i}t.texture2d={};var l,p=e.querySelectorAll("texture2d");for(a=0;a<p.length;a++){var c=p[a],v={id:(l=c).getAttribute("id"),path:l.getAttribute("path"),contenttype:l.getAttribute("contenttype"),tilestyleu:l.getAttribute("tilestyleu"),tilestylev:l.getAttribute("tilestylev"),filter:l.getAttribute("filter")};t.texture2d[v.id]=v}t.colorgroup={};var h=e.querySelectorAll("colorgroup");for(a=0;a<h.length;a++){var g=s(h[a]);t.colorgroup[g.id]=g}t.pbmetallicdisplayproperties={};var f=e.querySelectorAll("pbmetallicdisplayproperties");for(a=0;a<f.length;a++){var b=u(f[a]);t.pbmetallicdisplayproperties[b.id]=b}t.texture2dgroup={};var m=e.querySelectorAll("texture2dgroup");for(a=0;a<m.length;a++){var A=o(m[a]);t.texture2dgroup[A.id]=A}t.object={};var y=e.querySelectorAll("object");for(a=0;a<y.length;a++){var w=d(y[a]);t.object[w.id]=w}return t}(a));var i=e.querySelector("build");return i&&(t.build=function(e){for(var t=[],r=e.querySelectorAll("item"),a=0;a<r.length;a++){var i=r[a],n={objectId:i.getAttribute("objectid")},o=i.getAttribute("transform");o&&(n.transform=c(o)),t.push(n)}return t}(i)),t}function h(t,r,i,n){var o=t.texid,s=i.resources.texture2d[o];if(s){var u=n[s.path],l=s.contenttype,p=new Blob([u],{type:l}),c=URL.createObjectURL(p),d=a.load(c,function(){URL.revokeObjectURL(c)});switch(d.encoding=e.sRGBEncoding,s.tilestyleu){case"wrap":d.wrapS=e.RepeatWrapping;break;case"mirror":d.wrapS=e.MirroredRepeatWrapping;break;case"none":case"clamp":d.wrapS=e.ClampToEdgeWrapping;break;default:d.wrapS=e.RepeatWrapping}switch(s.tilestylev){case"wrap":d.wrapT=e.RepeatWrapping;break;case"mirror":d.wrapT=e.MirroredRepeatWrapping;break;case"none":case"clamp":d.wrapT=e.ClampToEdgeWrapping;break;default:d.wrapT=e.RepeatWrapping}switch(s.filter){case"auto":d.magFilter=e.LinearFilter,d.minFilter=e.LinearMipmapLinearFilter;break;case"linear":d.magFilter=e.LinearFilter,d.minFilter=e.LinearFilter;break;case"nearest":d.magFilter=e.NearestFilter,d.minFilter=e.NearestFilter;break;default:d.magFilter=e.LinearFilter,d.minFilter=e.LinearMipmapLinearFilter}return d}return null}function g(t,r,a,i,n,o){for(var s=o.pindex,u={},l=0,p=r.length;l<p;l++){var c=void 0!==(S=r[l]).p1?S.p1:s;void 0===u[c]&&(u[c]=[]),u[c].push(S)}var d=Object.keys(u),v=[];for(l=0,p=d.length;l<p;l++){for(var h=d[l],g=u[h],f=w(t.basematerials[h],L,a,n,o,x),b=new e.BufferGeometry,m=[],A=i.vertices,y=0,F=g.length;y<F;y++){var S=g[y];m.push(A[3*S.v1+0]),m.push(A[3*S.v1+1]),m.push(A[3*S.v1+2]),m.push(A[3*S.v2+0]),m.push(A[3*S.v2+1]),m.push(A[3*S.v2+2]),m.push(A[3*S.v3+0]),m.push(A[3*S.v3+1]),m.push(A[3*S.v3+2])}b.setAttribute("position",new e.Float32BufferAttribute(m,3));var M=new e.Mesh(b,f);v.push(M)}return v}function f(t,r,a,i,n,o){for(var s=new e.BufferGeometry,u=[],l=[],p=i.vertices,c=t.uvs,d=0,v=r.length;d<v;d++){var g=r[d];u.push(p[3*g.v1+0]),u.push(p[3*g.v1+1]),u.push(p[3*g.v1+2]),u.push(p[3*g.v2+0]),u.push(p[3*g.v2+1]),u.push(p[3*g.v2+2]),u.push(p[3*g.v3+0]),u.push(p[3*g.v3+1]),u.push(p[3*g.v3+2]),l.push(c[2*g.p1+0]),l.push(c[2*g.p1+1]),l.push(c[2*g.p2+0]),l.push(c[2*g.p2+1]),l.push(c[2*g.p3+0]),l.push(c[2*g.p3+1])}s.setAttribute("position",new e.Float32BufferAttribute(u,3)),s.setAttribute("uv",new e.Float32BufferAttribute(l,2));var f=w(t,L,a,n,o,h),b=new e.MeshPhongMaterial({map:f,flatShading:!0});return new e.Mesh(s,b)}function b(t,r,a,i){for(var n=new e.BufferGeometry,o=[],s=[],u=i.vertices,l=t.colors,p=0,c=r.length;p<c;p++){var d=r[p],v=d.v1,h=d.v2,g=d.v3;o.push(u[3*v+0]),o.push(u[3*v+1]),o.push(u[3*v+2]),o.push(u[3*h+0]),o.push(u[3*h+1]),o.push(u[3*h+2]),o.push(u[3*g+0]),o.push(u[3*g+1]),o.push(u[3*g+2]);var f=d.p1,b=d.p2,m=d.p3;s.push(l[3*f+0]),s.push(l[3*f+1]),s.push(l[3*f+2]),s.push(l[3*(b||f)+0]),s.push(l[3*(b||f)+1]),s.push(l[3*(b||f)+2]),s.push(l[3*(m||f)+0]),s.push(l[3*(m||f)+1]),s.push(l[3*(m||f)+2])}n.setAttribute("position",new e.Float32BufferAttribute(o,3)),n.setAttribute("color",new e.Float32BufferAttribute(s,3));var A=new e.MeshPhongMaterial({vertexColors:!0,flatShading:!0});return new e.Mesh(n,A)}function m(t){var r=new e.BufferGeometry;r.setIndex(new e.BufferAttribute(t.triangles,1)),r.setAttribute("position",new e.BufferAttribute(t.vertices,3));var a=new e.MeshPhongMaterial({color:11184895,flatShading:!0});return new e.Mesh(r,a)}function A(e,t){return void 0!==t.resources.texture2dgroup[e]?"texture":void 0!==t.resources.basematerials[e]?"material":void 0!==t.resources.colorgroup[e]?"vertexColors":"default"===e?"default":void 0}function y(t,r,a,i,n){for(var o=new e.Group,s=function(e,t,r,a,i){for(var n=Object.keys(e),o=[],s=0,u=n.length;s<u;s++){var l=n[s],p=e[l];switch(A(l,t)){case"material":for(var c=g(t.resources.basematerials[l],p,t,r,a,i),d=0,v=c.length;d<v;d++)o.push(c[d]);break;case"texture":var h=t.resources.texture2dgroup[l];o.push(f(h,p,t,r,a,i));break;case"vertexColors":var y=t.resources.colorgroup[l];o.push(b(y,p,0,r));break;case"default":o.push(m(r));break;default:console.error("THREE.3MFLoader: Unsupported resource type.")}}return o}(function(e,t,r){for(var a={},i=t.triangleProperties,n=r.pid,o=0,s=i.length;o<s;o++){var u=i[o],l=void 0!==u.pid?u.pid:n;void 0===l&&(l="default"),void 0===a[l]&&(a[l]=[]),a[l].push(u)}return a}(0,t,n),a,t,i,n),u=0,l=s.length;u<l;u++)o.add(s[u]);return o}function w(e,t,r,a,i,n){return void 0!==e.build?e.build:(e.build=n(e,t,r,a,i),e.build)}function x(t,r,a){var i,n=t.displaypropertiesid,o=a.resources.pbmetallicdisplayproperties;if(null!==n&&void 0!==o[n]){var s=o[n].data[t.index];i=new e.MeshStandardMaterial({flatShading:!0,roughness:s.roughness,metalness:s.metallicness})}else i=new e.MeshPhongMaterial({flatShading:!0});i.name=t.name;var u=t.displaycolor,l=u.substring(0,7);return i.color.setStyle(l),i.color.convertSRGBToLinear(),9===u.length&&(i.opacity=parseInt(u.charAt(7)+u.charAt(8),16)/255),i}function F(t,r,a,i){for(var n=new e.Group,o=0;o<t.length;o++){var s=t[o],u=r[s.objectId];void 0===u&&(S(s.objectId,r,a,i),u=r[s.objectId]);var l=u.clone(),p=s.transform;p&&l.applyMatrix4(p),n.add(l)}return n}function S(e,t,a,i){var n=a.resources.object[e];if(n.mesh){var o=n.mesh;!function(e,t,a){if(e){for(var i=[],n=Object.keys(e),o=0;o<n.length;o++)for(var s=n[o],u=0;u<r.availableExtensions.length;u++)(l=r.availableExtensions[u]).ns===s&&i.push(l);for(o=0;o<i.length;o++){var l;(l=i[o]).apply(a,e[l.ns],t)}}}(a.extensions,o,a.xml),t[n.id]=w(o,t,a,i,n,y)}else{var s=n.components;t[n.id]=w(s,t,a,i,n,F)}}var M=function(t){var r,a,n,o,s=null,u=null,l=[],p=[],c=[],d=[],h={},g={};try{s=new JSZip(t)}catch(e){if(e instanceof ReferenceError)return console.error("THREE.3MFLoader: jszip missing and file is compressed."),null}for(u in s.files)u.match(/\_rels\/.rels$/)?r=u:u.match(/3D\/_rels\/.*\.model\.rels$/)?a=u:u.match(/^3D\/.*\.model$/)?l.push(u):u.match(/^3D\/Metadata\/.*\.xml$/)?p.push(u):u.match(/^3D\/Textures?\/.*/)?c.push(u):u.match(/^3D\/Other\/.*/)&&d.push(u);var f=new Uint8Array(s.file(r).asArrayBuffer());n=i(e.LoaderUtils.decodeText(f)),a&&(f=new Uint8Array(s.file(a).asArrayBuffer()),o=i(e.LoaderUtils.decodeText(f)));for(var b=0;b<l.length;b++){var m=l[b],A=new Uint8Array(s.file(m).asArrayBuffer()),y=e.LoaderUtils.decodeText(A),w=(new DOMParser).parseFromString(y,"application/xml");"model"!==w.documentElement.nodeName.toLowerCase()&&console.error("THREE.3MFLoader: Error loading 3MF - no 3MF document found: ",m);var x=w.querySelector("model"),F={};for(b=0;b<x.attributes.length;b++){var S=x.attributes[b];S.name.match(/^xmlns:(.+)$/)&&(F[S.value]=RegExp.$1)}var M=v(x);M.xml=x,0<Object.keys(F).length&&(M.extensions=F),h[m]=M}for(b=0;b<c.length;b++){var L=c[b];g[L]=s.file(L).asArrayBuffer()}return{rels:n,modelRels:o,model:h,printTicket:{},texture:g,other:{}}}(t),L=function(e){var t=e.model,r=e.modelRels,a={},i=Object.keys(t),n={};if(r)for(var o=0,s=r.length;o<s;o++){var u=r[o],l=u.target.substring(1);e.texture[l]&&(n[u.target]=e.texture[l])}for(o=0;o<i.length;o++)for(var p=t[i[o]],c=Object.keys(p.resources.object),d=0;d<c.length;d++)S(c[d],a,p,n);return a}(M);return function(t,r){for(var a=new e.Group,i=r.rels[0],n=r.model[i.target.substring(1)].build,o=0;o<n.length;o++){var s=n[o],u=t[s.objectId],l=s.transform;l&&u.applyMatrix4(l),a.add(u)}return a}(L,M)},addExtension:function(e){this.availableExtensions.push(e)}}),e.ThreeMFLoader});
//# sourceMappingURL=../sourcemaps/loaders/3MFLoader.js.map
