/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs","../threex"],function(e,t){"use strict";var r,a,i,s,n,h=(r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),i=function e(){r(this,e),this.animeName="",this.boneName="",this.targetBone=null,this.keyType=4,this.frameStartLv=0,this.keyFrames=[],this.InverseMx=null},s=function(){function t(e){r(this,t),this.fps=30,this.name="xanimation",this.length=0,this.hierarchy=[],this.putFlags=e,void 0===this.putFlags.putPos&&(this.putFlags.putPos=!0),void 0===this.putFlags.putRot&&(this.putFlags.putRot=!0),void 0===this.putFlags.putScl&&(this.putFlags.putScl=!0)}return a(t,[{key:"make",value:function(e){for(var t=0;t<e.length;t++)this.hierarchy.push(this.makeBonekeys(e[t]));this.length=this.hierarchy[0].keys[this.hierarchy[0].keys.length-1].time}},{key:"clone",value:function(){return Object.assign({},this)}},{key:"makeBonekeys",value:function(e){var t={};return t.name=e.boneName,t.parent="",t.keys=this.keyFrameRefactor(e),t.copy=function(){return Object.assign({},this)},t}},{key:"keyFrameRefactor",value:function(t){for(var r=[],a=0;a<t.keyFrames.length;a++){var i={};i.time=t.keyFrames[a].time*this.fps,t.keyFrames[a].pos&&this.putFlags.putPos&&(i.pos=t.keyFrames[a].pos),t.keyFrames[a].rot&&this.putFlags.putRot&&(i.rot=t.keyFrames[a].rot),t.keyFrames[a].scl&&this.putFlags.putScl&&(i.scl=t.keyFrames[a].scl),t.keyFrames[a].matrix&&(i.matrix=t.keyFrames[a].matrix,this.putFlags.putPos&&(i.pos=(new e.Vector3).setFromMatrixPosition(i.matrix)),this.putFlags.putRot&&(i.rot=(new e.Quaternion).setFromRotationMatrix(i.matrix)),this.putFlags.putScl&&(i.scl=(new e.Vector3).setFromMatrixScale(i.matrix))),r.push(i)}return r}}]),t}(),n=function e(){r(this,e),this.index=0,this.Frame=0,this.time=0,this.matrix=null},function(){function t(a){e.Loader.call(this,a),r(this,t),this.debug=!1,this.texloader=new e.TextureLoader(this.manager),this.url="",this._putMatLength=0,this._nowMat=null,this._nowFrameName="",this.frameHierarchie=[],this.Hierarchies={},this.HieStack=[],this._currentObject={},this._currentFrame={},this._data=null,this.onLoad=null,this.IsUvYReverse=!0,this.Meshes=[],this.animations=[],this.animTicksPerSecond=30,this._currentGeo=null,this._currentAnime=null,this._currentAnimeFrames=null}return a(t,[{key:"_setArgOption",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(e){for(var r=t;r<e.length;r++)switch(r){case 0:this.url=e[r];break;case 1:this.options=e[r]}void 0===this.options&&(this.options={})}}},{key:"load",value:function(t,r,a,i){var s=this;this._setArgOption(t);var n=new e.FileLoader(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.load(this.url,function(e){s.parse(e,r)},a,i)}},{key:"_readLine",value:function(e){for(var t=0;;){var r=-1;if(-1===(r=e.indexOf("//",t))&&(r=e.indexOf("#",t)),!(r>-1&&r<2))break;var a=-1;t=(a=e.indexOf("\r\n",t))>0?a+2:(a=e.indexOf("\r",t))>0?a+1:e.indexOf("\n",t)+1}return e.substr(t)}},{key:"_readLine",value:function(e){for(var t=0;;){var r=-1;if(-1===(r=e.indexOf("//",t))&&(r=e.indexOf("#",t)),!(r>-1&&r<2))break;var a=-1;t=(a=e.indexOf("\r\n",t))>0?a+2:(a=e.indexOf("\r",t))>0?a+1:e.indexOf("\n",t)+1}return e.substr(t)}},{key:"_isBinary",value:function(e){var t=new DataView(e);if(84+50*t.getUint32(80,!0)===t.byteLength)return!0;for(var r=t.byteLength,a=0;a<r;a++)if(t.getUint8(a,!1)>127)return!0;return!1}},{key:"_ensureBinary",value:function(e){if("string"==typeof e){for(var t=new Uint8Array(e.length),r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t.buffer||t}return e}},{key:"_ensureString",value:function(t){return"string"!=typeof t?e.LoaderUtils.decodeText(new Uint8Array(t)):t}},{key:"parse",value:function(e,t){var r=this._ensureBinary(e);return this._data=this._ensureString(e),this.onLoad=t,this._isBinary(r)?this._parseBinary(r):this._parseASCII()}},{key:"_parseBinary",value:function(t){return this._parseASCII(e.LoaderUtils.decodeText(new Uint8Array(t)))}},{key:"_parseASCII",value:function(){var t;t=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:e.LoaderUtils.extractUrlBase(this.url),this.texloader.setPath(t).setCrossOrigin(this.crossOrigin),this.Hierarchies.children=[],this._hierarchieParse(this.Hierarchies,16),this._changeRoot(),this._currentObject=this.Hierarchies.children.shift(),this._mainloop()}},{key:"_hierarchieParse",value:function(e,t){for(var r=t;;){var a=this._data.indexOf("{",r)+1,i=this._data.indexOf("}",r),s=this._data.indexOf("{",a)+1;if(!(a>0&&i>a)){r=-1===a?this._data.length:i+1;break}var n={children:[]},h=this._readLine(this._data.substr(r,a-r-1)).trim(),o=h.split(/ /g);if(o.length>0?(n.type=o[0],o.length>=2?n.name=o[1]:n.name=o[0]+this.Hierarchies.children.length):(n.name=h,n.type=""),"Animation"===n.type){n.data=this._data.substr(s,i-s).trim();var c=this._hierarchieParse(n,i+1);r=c.end,n.children=c.parent.children}else{var u=this._data.lastIndexOf(";",s>0?Math.min(s,i):i);if(n.data=this._data.substr(a,u-a).trim(),s<=0||i<s)r=i+1;else{var l=Math.max(u+1,a),m=this._hierarchieParse(n,l);r=m.end,n.children=m.parent.children}}n.parent=e,"template"!=n.type&&e.children.push(n)}return{parent:e,end:r}}},{key:"_mainloop",value:function(){var e=this;this._mainProc(),this._currentObject.parent||this._currentObject.children.length>0||!this._currentObject.worked?setTimeout(function(){e._mainloop()},1):setTimeout(function(){e.onLoad({models:e.Meshes,animations:e.animations})},1)}},{key:"_mainProc",value:function(){for(var e=!1;;){if(!this._currentObject.worked){switch(this._currentObject.type){case"template":break;case"AnimTicksPerSecond":this.animTicksPerSecond=parseInt(this._currentObject.data);break;case"Frame":this._setFrame();break;case"FrameTransformMatrix":this._setFrameTransformMatrix();break;case"Mesh":this._changeRoot(),this._currentGeo={},this._currentGeo.name=this._currentObject.name.trim(),this._currentGeo.parentName=this._getParentName(this._currentObject).trim(),this._currentGeo.VertexSetedBoneCount=[],this._currentGeo.GeometryData={vertices:[],normals:[],uvs:[],skinIndices:[],skinWeights:[],indices:[],materialIndices:[]},this._currentGeo.Materials=[],this._currentGeo.normalVectors=[],this._currentGeo.BoneInfs=[],this._currentGeo.baseFrame=this._currentFrame,this._makeBoneFrom_CurrentFrame(),this._readVertexDatas(),e=!0;break;case"MeshNormals":this._readVertexDatas();break;case"MeshTextureCoords":this._setMeshTextureCoords();break;case"VertexDuplicationIndices":break;case"MeshMaterialList":this._setMeshMaterialList();break;case"Material":this._setMaterial();break;case"SkinWeights":this._setSkinWeights();break;case"AnimationSet":this._changeRoot(),this._currentAnime={},this._currentAnime.name=this._currentObject.name.trim(),this._currentAnime.AnimeFrames=[];break;case"Animation":this._currentAnimeFrames&&this._currentAnime.AnimeFrames.push(this._currentAnimeFrames),this._currentAnimeFrames=new i,this._currentAnimeFrames.boneName=this._currentObject.data.trim();break;case"AnimationKey":this._readAnimationKey(),e=!0}this._currentObject.worked=!0}if(this._currentObject.children.length>0){if(this._currentObject=this._currentObject.children.shift(),this.debug&&console.log("processing "+this._currentObject.name),e)break}else if(this._currentObject.worked&&this._currentObject.parent&&!this._currentObject.parent.parent&&this._changeRoot(),this._currentObject.parent?this._currentObject=this._currentObject.parent:e=!0,e)break}}},{key:"_changeRoot",value:function(){null!=this._currentGeo&&this._currentGeo.name&&this._makeOutputGeometry(),this._currentGeo={},null!=this._currentAnime&&this._currentAnime.name&&(this._currentAnimeFrames&&(this._currentAnime.AnimeFrames.push(this._currentAnimeFrames),this._currentAnimeFrames=null),this._makeOutputAnimation()),this._currentAnime={}}},{key:"_getParentName",value:function(e){return e.parent?e.parent.name?e.parent.name:this._getParentName(e.parent):""}},{key:"_setFrame",value:function(){this._nowFrameName=this._currentObject.name.trim(),this._currentFrame={},this._currentFrame.name=this._nowFrameName,this._currentFrame.children=[],this._currentObject.parent&&this._currentObject.parent.name&&(this._currentFrame.parentName=this._currentObject.parent.name),this.frameHierarchie.push(this._nowFrameName),this.HieStack[this._nowFrameName]=this._currentFrame}},{key:"_setFrameTransformMatrix",value:function(){this._currentFrame.FrameTransformMatrix=new e.Matrix4;var t=this._currentObject.data.split(",");this._ParseMatrixData(this._currentFrame.FrameTransformMatrix,t),this._makeBoneFrom_CurrentFrame()}},{key:"_makeBoneFrom_CurrentFrame",value:function(){if(this._currentFrame.FrameTransformMatrix){var t=new e.Bone;if(t.name=this._currentFrame.name,t.applyMatrix4(this._currentFrame.FrameTransformMatrix),t.matrixWorld=t.matrix,t.FrameTransformMatrix=this._currentFrame.FrameTransformMatrix,this._currentFrame.putBone=t,this._currentFrame.parentName)for(var r in this.HieStack)this.HieStack[r].name===this._currentFrame.parentName&&this.HieStack[r].putBone.add(this._currentFrame.putBone)}}},{key:"_readVertexDatas",value:function(){for(var e=0,t=0,r=0,a=0;;){var i=!1;if(0===r)e=this._readInt1(e).endRead,r=1,(a=this._currentObject.data.indexOf(";;",e)+1)<=0&&(a=this._currentObject.data.length);else{var s=0;switch(t){case 0:s=this._currentObject.data.indexOf(",",e)+1;break;case 1:s=this._currentObject.data.indexOf(";,",e)+1}switch((0===s||s>a)&&(s=a,r=0,i=!0),this._currentObject.type){case"Mesh":switch(t){case 0:this._readVertex1(this._currentObject.data.substr(e,s-e));break;case 1:this._readFace1(this._currentObject.data.substr(e,s-e))}break;case"MeshNormals":switch(t){case 0:this._readNormalVector1(this._currentObject.data.substr(e,s-e))}}e=s+1,i&&t++}if(e>=this._currentObject.data.length)break}}},{key:"_readInt1",value:function(e){var t=this._currentObject.data.indexOf(";",e);return{refI:parseInt(this._currentObject.data.substr(e,t-e)),endRead:t+1}}},{key:"_readVertex1",value:function(e){var t=this._readLine(e.trim()).substr(0,e.length-2).split(";");this._currentGeo.GeometryData.vertices.push(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])),this._currentGeo.GeometryData.skinIndices.push(0,0,0,0),this._currentGeo.GeometryData.skinWeights.push(1,0,0,0),this._currentGeo.VertexSetedBoneCount.push(0)}},{key:"_readFace1",value:function(e){var t=this._readLine(e.trim()).substr(2,e.length-4).split(",");this._currentGeo.GeometryData.indices.push(parseInt(t[0],10),parseInt(t[1],10),parseInt(t[2],10))}},{key:"_readNormalVector1",value:function(e){var t=this._readLine(e.trim()).substr(0,e.length-2).split(";");this._currentGeo.GeometryData.normals.push(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))}},{key:"_buildGeometry",value:function(){for(var t=new e.BufferGeometry,r=[],a=[],i=[],s=[],n=[],h=this._currentGeo.GeometryData,o=0,c=h.indices.length;o<c;o++){var u=2*h.indices[o],l=3*h.indices[o],m=4*h.indices[o];r.push(h.vertices[l],h.vertices[l+1],h.vertices[l+2]),a.push(h.normals[l],h.normals[l+1],h.normals[l+2]),s.push(h.skinIndices[m],h.skinIndices[m+1],h.skinIndices[m+2],h.skinIndices[m+3]),n.push(h.skinWeights[m],h.skinWeights[m+1],h.skinWeights[m+2],h.skinWeights[m+3]),i.push(h.uvs[u],h.uvs[u+1])}return t.setAttribute("position",new e.Float32BufferAttribute(r,3)),t.setAttribute("normal",new e.Float32BufferAttribute(a,3)),t.setAttribute("uv",new e.Float32BufferAttribute(i,2)),t.setAttribute("skinIndex",new e.Uint16BufferAttribute(s,4)),t.setAttribute("skinWeight",new e.Float32BufferAttribute(n,4)),this._computeGroups(t,h.materialIndices),t}},{key:"_computeGroups",value:function(e,t){for(var r,a=[],i=void 0,s=0;s<t.length;s++){var n=t[s];n!==i&&(i=n,void 0!==r&&(r.count=3*s-r.start,a.push(r)),r={start:3*s,materialIndex:i})}void 0!==r&&(r.count=3*s-r.start,a.push(r)),e.groups=a}},{key:"_setMeshTextureCoords",value:function(){for(var e=0,t=0,r=0;;){switch(t){case 0:if(0===r)e=this._readInt1(0).endRead,r=1;else{var a=this._currentObject.data.indexOf(",",e)+1;0===a&&(a=this._currentObject.data.length,t=2,r=0);var i=this._currentObject.data.substr(e,a-e),s=this._readLine(i.trim()).split(";");this.IsUvYReverse?this._currentGeo.GeometryData.uvs.push(parseFloat(s[0]),1-parseFloat(s[1])):this._currentGeo.GeometryData.uvs.push(parseFloat(s[0]),parseFloat(s[1])),e=a+1}}if(e>=this._currentObject.data.length)break}}},{key:"_setMeshMaterialList",value:function(){for(var e=0,t=0,r=0;;){if(r<2)e=this._readInt1(e).endRead,r++;else{var a=this._currentObject.data.indexOf(";",e);-1===a&&(a=this._currentObject.data.length,t=3,r=0);for(var i=this._currentObject.data.substr(e,a-e),s=this._readLine(i.trim()).split(","),n=0;n<s.length;n++)this._currentGeo.GeometryData.materialIndices[n]=parseInt(s[n]);e=this._currentObject.data.length}if(e>=this._currentObject.data.length||t>=3)break}}},{key:"_setMaterial",value:function(){var t=new e.MeshPhongMaterial({color:16777215*Math.random()});t.side=e.FrontSide,t.name=this._currentObject.name;var r=0,a=this._currentObject.data.indexOf(";;",r),i=this._currentObject.data.substr(r,a-r),s=this._readLine(i.trim()).split(";");t.color.r=parseFloat(s[0]),t.color.g=parseFloat(s[1]),t.color.b=parseFloat(s[2]),r=a+2,a=this._currentObject.data.indexOf(";",r),i=this._currentObject.data.substr(r,a-r),t.shininess=parseFloat(this._readLine(i)),r=a+1,a=this._currentObject.data.indexOf(";;",r),i=this._currentObject.data.substr(r,a-r);var n=this._readLine(i.trim()).split(";");t.specular.r=parseFloat(n[0]),t.specular.g=parseFloat(n[1]),t.specular.b=parseFloat(n[2]),r=a+2,-1===(a=this._currentObject.data.indexOf(";;",r))&&(a=this._currentObject.data.length),i=this._currentObject.data.substr(r,a-r);var h=this._readLine(i.trim()).split(";");t.emissive.r=parseFloat(h[0]),t.emissive.g=parseFloat(h[1]),t.emissive.b=parseFloat(h[2]);for(var o=null;this._currentObject.children.length>0;){o=this._currentObject.children.shift(),this.debug&&console.log("processing "+o.name);var c=o.data.substr(1,o.data.length-2);switch(o.type){case"TextureFilename":t.map=this.texloader.load(c);break;case"BumpMapFilename":t.bumpMap=this.texloader.load(c),t.bumpScale=.05;break;case"NormalMapFilename":t.normalMap=this.texloader.load(c),t.normalScale=new e.Vector2(2,2);break;case"EmissiveMapFilename":t.emissiveMap=this.texloader.load(c);break;case"LightMapFilename":t.lightMap=this.texloader.load(c)}}this._currentGeo.Materials.push(t)}},{key:"_setSkinWeights",value:function(){var t=new function e(){r(this,e),this.boneName="",this.BoneIndex=0,this.Indeces=[],this.Weights=[],this.initMatrix=null,this.OffsetMatrix=null},a=0,i=this._currentObject.data.indexOf(";",a),s=this._currentObject.data.substr(a,i-a);a=i+1,t.boneName=s.substr(1,s.length-2),t.BoneIndex=this._currentGeo.BoneInfs.length,a=(i=this._currentObject.data.indexOf(";",a))+1,i=this._currentObject.data.indexOf(";",a),s=this._currentObject.data.substr(a,i-a);for(var n=this._readLine(s.trim()).split(","),h=0;h<n.length;h++)t.Indeces.push(parseInt(n[h]));a=i+1,i=this._currentObject.data.indexOf(";",a),s=this._currentObject.data.substr(a,i-a);for(var o=this._readLine(s.trim()).split(","),c=0;c<o.length;c++)t.Weights.push(parseFloat(o[c]));a=i+1,(i=this._currentObject.data.indexOf(";",a))<=0&&(i=this._currentObject.data.length),s=this._currentObject.data.substr(a,i-a);var u=this._readLine(s.trim()).split(",");t.OffsetMatrix=new e.Matrix4,this._ParseMatrixData(t.OffsetMatrix,u),this._currentGeo.BoneInfs.push(t)}},{key:"_makePutBoneList",value:function(t,r){var a=!1;for(var i in this.HieStack)if(this.HieStack[i].name===t||a){a=!0;var s=new e.Bone;if(s.name=this.HieStack[i].name,s.applyMatrix4(this.HieStack[i].FrameTransformMatrix),s.matrixWorld=s.matrix,s.FrameTransformMatrix=this.HieStack[i].FrameTransformMatrix,s.pos=(new e.Vector3).setFromMatrixPosition(FrameTransformMatrix).toArray(),s.rotq=(new e.Quaternion).setFromRotationMatrix(FrameTransformMatrix).toArray(),s.scl=(new e.Vector3).setFromMatrixScale(FrameTransformMatrix).toArray(),this.HieStack[i].parentName&&this.HieStack[i].parentName.length>0)for(var n=0;n<r.length;n++)if(this.HieStack[i].parentName===r[n].name){r[n].add(s),s.parent=n;break}r.push(s)}}},{key:"_makeOutputGeometry",value:function(){var t=null;if(this._currentGeo.BoneInfs.length>0){var r=[];this._makePutBoneList(this._currentGeo.baseFrame.parentName,r);for(var a=0;a<this._currentGeo.BoneInfs.length;a++){for(var i=0,s=0;s<r.length;s++)if(r[s].name===this._currentGeo.BoneInfs[a].boneName){i=s,r[s].OffsetMatrix=new e.Matrix4,r[s].OffsetMatrix.copy(this._currentGeo.BoneInfs[a].OffsetMatrix);break}for(var n=0;n<this._currentGeo.BoneInfs[a].Indeces.length;n++){var h=this._currentGeo.BoneInfs[a].Indeces[n],o=this._currentGeo.BoneInfs[a].Weights[n],c=4*h;switch(this._currentGeo.VertexSetedBoneCount[h]){case 0:this._currentGeo.GeometryData.skinIndices[c]=i,this._currentGeo.GeometryData.skinWeights[c]=o;break;case 1:this._currentGeo.GeometryData.skinIndices[c+1]=i,this._currentGeo.GeometryData.skinWeights[c+1]=o;break;case 2:this._currentGeo.GeometryData.skinIndices[c+2]=i,this._currentGeo.GeometryData.skinWeights[c+2]=o;break;case 3:this._currentGeo.GeometryData.skinIndices[c+3]=i,this._currentGeo.GeometryData.skinWeights[c+3]=o}this._currentGeo.VertexSetedBoneCount[h]++,this._currentGeo.VertexSetedBoneCount[h]>4&&console.log("warn! over 4 bone weight! :"+h)}}for(var u=0;u<this._currentGeo.Materials.length;u++)this._currentGeo.Materials[u].skinning=!0;for(var l=[],m=0;m<r.length;m++)r[m].OffsetMatrix?l.push(r[m].OffsetMatrix):l.push(new e.Matrix4);var _=this._buildGeometry();t=new e.SkinnedMesh(_,1===this._currentGeo.Materials.length?this._currentGeo.Materials[0]:this._currentGeo.Materials),this._initSkeleton(t,r,l)}else{var p=this._buildGeometry();t=new e.Mesh(p,1===this._currentGeo.Materials.length?this._currentGeo.Materials[0]:this._currentGeo.Materials)}t.name=this._currentGeo.name;var d=new e.Matrix4,f=this._currentGeo.baseFrame.putBone;if(f&&f.parent){for(;f=f.parent;)d.multiply(f.FrameTransformMatrix);t.applyMatrix4(d)}this.Meshes.push(t)}},{key:"_initSkeleton",value:function(t,r,a){var i,s,n,h,o=[];for(n=0,h=r.length;n<h;n++)s=r[n],i=new e.Bone,o.push(i),i.name=s.name,i.position.fromArray(s.pos),i.quaternion.fromArray(s.rotq),void 0!==s.scl&&i.scale.fromArray(s.scl);for(n=0,h=r.length;n<h;n++)-1!==(s=r[n]).parent&&null!==s.parent&&void 0!==o[s.parent]?o[s.parent].add(o[n]):t.add(o[n]);t.updateMatrixWorld(!0);var c=new e.Skeleton(o,a);t.bind(c,t.matrixWorld)}},{key:"_readAnimationKey",value:function(){var t=0,r=this._currentObject.data.indexOf(";",t),a=this._currentObject.data.substr(t,r-t);t=r+1;var i=parseInt(this._readLine(a));t=(r=this._currentObject.data.indexOf(";",t))+1,a=this._currentObject.data.substr(t);for(var s=this._readLine(a.trim()).split(";;,"),h=0;h<s.length;h++){var o=s[h].split(";"),c=new n;if(c.type=i,c.Frame=parseInt(o[0]),c.index=this._currentAnimeFrames.keyFrames.length,c.time=c.Frame,4!=i){for(var u=!1,l=0;l<this._currentAnimeFrames.keyFrames.length;l++)if(this._currentAnimeFrames.keyFrames[l].Frame===c.Frame){c=this._currentAnimeFrames.keyFrames[l],u=!0;break}var m=o[2].split(",");switch(i){case 0:c.rot=new e.Quaternion(parseFloat(m[1]),parseFloat(m[2]),parseFloat(m[3]),-1*parseFloat(m[0]));break;case 1:c.scl=new e.Vector3(parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2]));break;case 2:c.pos=new e.Vector3(parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2]))}u||this._currentAnimeFrames.keyFrames.push(c)}else c.matrix=new e.Matrix4,this._ParseMatrixData(c.matrix,o[2].split(",")),this._currentAnimeFrames.keyFrames.push(c)}}},{key:"_makeOutputAnimation",value:function(){var e=new s(this.options);e.fps=this.animTicksPerSecond,e.name=this._currentAnime.name,e.make(this._currentAnime.AnimeFrames),this.animations.push(e)}},{key:"assignAnimation",value:function(t,r){var a=t,i=r;if(a||(a=this.Meshes[0]),i||(i=this.animations[0]),!a||!i)return null;var s={};s.fps=i.fps,s.name=i.name,s.length=i.length,s.hierarchy=[];for(var n=0;n<a.skeleton.bones.length;n++){for(var h=!1,o=0;o<i.hierarchy.length;o++)if(a.skeleton.bones[n].name===i.hierarchy[o].name){h=!0;var c=i.hierarchy[o].copy();if(c.parent=-1,a.skeleton.bones[n].parent&&"Bone"===a.skeleton.bones[n].parent.type)for(var u=0;u<s.hierarchy.length;u++)s.hierarchy[u].name===a.skeleton.bones[n].parent.name&&(c.parent=u,c.parentName=a.skeleton.bones[n].parent.name);s.hierarchy.push(c);break}if(!h){var l=i.hierarchy[0].copy();l.name=a.skeleton.bones[n].name,l.parent=-1;for(var m=0;m<l.keys.length;m++)l.keys[m].pos&&l.keys[m].pos.set(0,0,0),l.keys[m].scl&&l.keys[m].scl.set(1,1,1),l.keys[m].rot&&l.keys[m].rot.set(0,0,0,1);s.hierarchy.push(l)}}return a.geometry.animations||(a.geometry.animations=[]),a.geometry.animations.push(e.AnimationClip.parseAnimation(s,a.skeleton.bones)),a.animationMixer||(a.animationMixer=new e.AnimationMixer(a)),s}},{key:"_ParseMatrixData",value:function(e,t){e.set(parseFloat(t[0]),parseFloat(t[4]),parseFloat(t[8]),parseFloat(t[12]),parseFloat(t[1]),parseFloat(t[5]),parseFloat(t[9]),parseFloat(t[13]),parseFloat(t[2]),parseFloat(t[6]),parseFloat(t[10]),parseFloat(t[14]),parseFloat(t[3]),parseFloat(t[7]),parseFloat(t[11]),parseFloat(t[15]))}}]),t}());return t.loaders.XLoader=h});
//# sourceMappingURL=../sourcemaps/loaders/XLoader.js.map
