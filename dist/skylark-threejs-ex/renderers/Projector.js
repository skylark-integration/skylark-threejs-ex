/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs"],function(e){return e.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},e.RenderableFace=function(){this.id=0,this.v1=new e.RenderableVertex,this.v2=new e.RenderableVertex,this.v3=new e.RenderableVertex,this.normalModel=new e.Vector3,this.vertexNormalsModel=[new e.Vector3,new e.Vector3,new e.Vector3],this.vertexNormalsLength=0,this.color=new e.Color,this.material=null,this.uvs=[new e.Vector2,new e.Vector2,new e.Vector2],this.z=0,this.renderOrder=0},e.RenderableVertex=function(){this.position=new e.Vector3,this.positionWorld=new e.Vector3,this.positionScreen=new e.Vector4,this.visible=!0},e.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},e.RenderableLine=function(){this.id=0,this.v1=new e.RenderableVertex,this.v2=new e.RenderableVertex,this.vertexColors=[new e.Color,new e.Color],this.material=null,this.z=0,this.renderOrder=0},e.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new e.Vector2,this.material=null,this.renderOrder=0},e.Projector=function(){var r,t,i,o,n,a,s,l,c,p,u,f=[],h=0,d=[],m=0,v=[],y=0,x=[],g=0,w=[],S=0,M={objects:[],lights:[],elements:[]},b=new e.Vector3,z=new e.Vector4,V=new e.Box3(new e.Vector3(-1,-1,-1),new e.Vector3(1,1,1)),j=new e.Box3,O=new Array(3),R=new e.Matrix4,C=new e.Matrix4,T=new e.Matrix4,k=new e.Matrix3,L=new e.Frustum,W=new e.Vector4,A=new e.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var B=new function(){var r=[],t=[],o=[],a=null,l=new e.Matrix3;function c(e){var r=e.position,t=e.positionWorld,i=e.positionScreen;t.copy(r).applyMatrix4(u),i.copy(t).applyMatrix4(C);var o=1/i.w;i.x*=o,i.y*=o,i.z*=o,e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1}function p(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(O[0]=e.positionScreen,O[1]=r.positionScreen,O[2]=t.positionScreen,V.intersectsBox(j.setFromPoints(O)))}function f(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(e){a=e,l.getNormalMatrix(a.matrixWorld),r.length=0,t.length=0,o.length=0},projectVertex:c,checkTriangleVisibility:p,checkBackfaceCulling:f,pushVertex:function(e,r,t){(i=F()).position.set(e,r,t),c(i)},pushNormal:function(e,t,i){r.push(e,t,i)},pushColor:function(e,r,i){t.push(e,r,i)},pushUv:function(e,r){o.push(e,r)},pushLine:function(e,r){var i=d[e],o=d[r];i.positionScreen.copy(i.position).applyMatrix4(T),o.positionScreen.copy(o.position).applyMatrix4(T),!0===D(i.positionScreen,o.positionScreen)&&(i.positionScreen.multiplyScalar(1/i.positionScreen.w),o.positionScreen.multiplyScalar(1/o.positionScreen.w),(s=E()).id=a.id,s.v1.copy(i),s.v2.copy(o),s.z=Math.max(i.positionScreen.z,o.positionScreen.z),s.renderOrder=a.renderOrder,s.material=a.material,a.material.vertexColors&&(s.vertexColors[0].fromArray(t,3*e),s.vertexColors[1].fromArray(t,3*r)),M.elements.push(s))},pushTriangle:function(i,s,c,u){var h=d[i],m=d[s],v=d[c];if(!1!==p(h,m,v)&&(u.side===e.DoubleSide||!0===f(h,m,v))){(n=I()).id=a.id,n.v1.copy(h),n.v2.copy(m),n.v3.copy(v),n.z=(h.positionScreen.z+m.positionScreen.z+v.positionScreen.z)/3,n.renderOrder=a.renderOrder,b.subVectors(v.position,m.position),z.subVectors(h.position,m.position),b.cross(z),n.normalModel.copy(b),n.normalModel.applyMatrix3(l).normalize();for(var y=0;y<3;y++){var x=n.vertexNormalsModel[y];x.fromArray(r,3*arguments[y]),x.applyMatrix3(l).normalize(),n.uvs[y].fromArray(o,2*arguments[y])}n.vertexNormalsLength=3,n.material=u,u.vertexColors&&n.color.fromArray(t,3*i),M.elements.push(n)}}}};function N(i){(r=function(){if(t===h){var r=new e.RenderableObject;return f.push(r),h++,t++,r}return f[t++]}()).id=i.id,r.object=i,b.setFromMatrixPosition(i.matrixWorld),b.applyMatrix4(C),r.z=b.z,r.renderOrder=i.renderOrder,M.objects.push(r)}function P(r,t,i){var o=1/r.w;r.z*=o,r.z>=-1&&r.z<=1&&((c=function(){if(p===S){var r=new e.RenderableSprite;return w.push(r),S++,p++,r}return w[p++]}()).id=t.id,c.x=r.x*o,c.y=r.y*o,c.z=r.z,c.renderOrder=t.renderOrder,c.object=t,c.rotation=t.rotation,c.scale.x=t.scale.x*Math.abs(c.x-(r.x+i.projectionMatrix.elements[0])/(r.w+i.projectionMatrix.elements[12])),c.scale.y=t.scale.y*Math.abs(c.y-(r.y+i.projectionMatrix.elements[5])/(r.w+i.projectionMatrix.elements[13])),c.material=t.material,M.elements.push(c))}function F(){if(o===m){var r=new e.RenderableVertex;return d.push(r),m++,o++,r}return d[o++]}function I(){if(a===y){var r=new e.RenderableFace;return v.push(r),y++,a++,r}return v[a++]}function E(){if(l===g){var r=new e.RenderableLine;return x.push(r),g++,l++,r}return x[l++]}function G(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}function D(e,r){var t=0,i=1,o=e.z+e.w,n=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;return o>=0&&n>=0&&a>=0&&s>=0||!(o<0&&n<0||a<0&&s<0)&&(o<0?t=Math.max(t,o/(o-n)):n<0&&(i=Math.min(i,o/(o-n))),a<0?t=Math.max(t,a/(a-s)):s<0&&(i=Math.min(i,a/(a-s))),!(i<t)&&(e.lerp(r,t),r.lerp(e,1-i),!0))}this.projectScene=function(r,i,c,f){a=0,l=0,p=0,M.elements.length=0,!0===r.autoUpdate&&r.updateMatrixWorld(),null===i.parent&&i.updateMatrixWorld(),R.copy(i.matrixWorldInverse),C.multiplyMatrices(i.projectionMatrix,R),L.setFromProjectionMatrix(C),t=0,M.objects.length=0,M.lights.length=0,function r(t){if(!1!==t.visible){if(t instanceof e.Light)M.lights.push(t);else if(t instanceof e.Mesh||t instanceof e.Line||t instanceof e.Points){if(!1===t.material.visible)return;if(!0===t.frustumCulled&&!1===L.intersectsObject(t))return;N(t)}else if(t instanceof e.Sprite){if(!1===t.material.visible)return;if(!0===t.frustumCulled&&!1===L.intersectsSprite(t))return;N(t)}for(var i=t.children,o=0,n=i.length;o<n;o++)r(i[o])}}(r),!0===c&&M.objects.sort(G);for(var h=M.objects,m=0,v=h.length;m<v;m++){var y=h[m].object,x=y.geometry;if(B.setObject(y),u=y.matrixWorld,o=0,y instanceof e.Mesh){if(x instanceof e.BufferGeometry){var g=y.material,w=Array.isArray(g),S=x.attributes,V=x.groups;if(void 0===S.position)continue;for(var j=0,O=(Oe=S.position.array).length;j<O;j+=3){var U=Oe[j],H=Oe[j+1],X=Oe[j+2];if(!0===g.morphTargets)for(var Y=x.morphAttributes.position,Z=x.morphTargetsRelative,q=y.morphTargetInfluences,J=0,K=Y.length;J<K;J++){if(0!==(ce=q[J])){var Q=Y[J];Z?(U+=Q.getX(j/3)*ce,H+=Q.getY(j/3)*ce,X+=Q.getZ(j/3)*ce):(U+=(Q.getX(j/3)-Oe[j])*ce,H+=(Q.getY(j/3)-Oe[j+1])*ce,X+=(Q.getZ(j/3)-Oe[j+2])*ce)}}B.pushVertex(U,H,X)}if(void 0!==S.normal){var $=S.normal.array;for(j=0,O=$.length;j<O;j+=3)B.pushNormal($[j],$[j+1],$[j+2])}if(void 0!==S.color)for(j=0,O=(Ve=S.color.array).length;j<O;j+=3)B.pushColor(Ve[j],Ve[j+1],Ve[j+2]);if(void 0!==S.uv){var _=S.uv.array;for(j=0,O=_.length;j<O;j+=2)B.pushUv(_[j],_[j+1])}if(null!==x.index){var ee=x.index.array;if(V.length>0)for(var re=0;re<V.length;re++){var te=V[re];if(void 0!==(g=!0===w?y.material[te.materialIndex]:y.material))for(j=te.start,O=te.start+te.count;j<O;j+=3)B.pushTriangle(ee[j],ee[j+1],ee[j+2],g)}else for(j=0,O=ee.length;j<O;j+=3)B.pushTriangle(ee[j],ee[j+1],ee[j+2],g)}else if(V.length>0)for(re=0;re<V.length;re++){te=V[re];if(void 0!==(g=!0===w?y.material[te.materialIndex]:y.material))for(j=te.start,O=te.start+te.count;j<O;j+=3)B.pushTriangle(j,j+1,j+2,g)}else for(j=0,O=Oe.length/3;j<O;j+=3)B.pushTriangle(j,j+1,j+2,g)}else if(x instanceof e.Geometry){var ie=x.vertices,oe=x.faces,ne=x.faceVertexUvs[0];k.getNormalMatrix(u);g=y.material,w=Array.isArray(g);for(var ae=0,se=ie.length;ae<se;ae++){var le=ie[ae];if(b.copy(le),!0===g.morphTargets)for(Y=x.morphTargets,q=y.morphTargetInfluences,J=0,K=Y.length;J<K;J++){var ce;if(0!==(ce=q[J])){var pe=(Q=Y[J]).vertices[ae];b.x+=(pe.x-le.x)*ce,b.y+=(pe.y-le.y)*ce,b.z+=(pe.z-le.z)*ce}}B.pushVertex(b.x,b.y,b.z)}for(var ue=0,fe=oe.length;ue<fe;ue++){var he=oe[ue];if(void 0!==(g=!0===w?y.material[he.materialIndex]:y.material)){var de=g.side,me=d[he.a],ve=d[he.b],ye=d[he.c];if(!1!==B.checkTriangleVisibility(me,ve,ye)){var xe=B.checkBackfaceCulling(me,ve,ye);if(de!==e.DoubleSide){if(de===e.FrontSide&&!1===xe)continue;if(de===e.BackSide&&!0===xe)continue}(n=I()).id=y.id,n.v1.copy(me),n.v2.copy(ve),n.v3.copy(ye),n.normalModel.copy(he.normal),!1!==xe||de!==e.BackSide&&de!==e.DoubleSide||n.normalModel.negate(),n.normalModel.applyMatrix3(k).normalize();for(var ge=he.vertexNormals,we=0,Se=Math.min(ge.length,3);we<Se;we++){var Me=n.vertexNormalsModel[we];Me.copy(ge[we]),!1!==xe||de!==e.BackSide&&de!==e.DoubleSide||Me.negate(),Me.applyMatrix3(k).normalize()}n.vertexNormalsLength=ge.length;var be=ne[ue];if(void 0!==be)for(var ze=0;ze<3;ze++)n.uvs[ze].copy(be[ze]);n.color=he.color,n.material=g,n.z=(me.positionScreen.z+ve.positionScreen.z+ye.positionScreen.z)/3,n.renderOrder=y.renderOrder,M.elements.push(n)}}}}}else if(y instanceof e.Line){if(T.multiplyMatrices(C,u),x instanceof e.BufferGeometry){if(void 0!==(S=x.attributes).position){for(j=0,O=(Oe=S.position.array).length;j<O;j+=3)B.pushVertex(Oe[j],Oe[j+1],Oe[j+2]);if(void 0!==S.color){var Ve;for(j=0,O=(Ve=S.color.array).length;j<O;j+=3)B.pushColor(Ve[j],Ve[j+1],Ve[j+2])}if(null!==x.index)for(j=0,O=(ee=x.index.array).length;j<O;j+=2)B.pushLine(ee[j],ee[j+1]);else{var je=y instanceof e.LineSegments?2:1;for(j=0,O=Oe.length/3-1;j<O;j+=je)B.pushLine(j,j+1)}}}else if(x instanceof e.Geometry){if(0===(ie=y.geometry.vertices).length)continue;(me=F()).positionScreen.copy(ie[0]).applyMatrix4(T);for(je=y instanceof e.LineSegments?2:1,ae=1,se=ie.length;ae<se;ae++)(me=F()).positionScreen.copy(ie[ae]).applyMatrix4(T),(ae+1)%je>0||(ve=d[o-2],W.copy(me.positionScreen),A.copy(ve.positionScreen),!0===D(W,A)&&(W.multiplyScalar(1/W.w),A.multiplyScalar(1/A.w),(s=E()).id=y.id,s.v1.positionScreen.copy(W),s.v2.positionScreen.copy(A),s.z=Math.max(W.z,A.z),s.renderOrder=y.renderOrder,s.material=y.material,y.material.vertexColors&&(s.vertexColors[0].copy(y.geometry.colors[ae]),s.vertexColors[1].copy(y.geometry.colors[ae-1])),M.elements.push(s)))}}else if(y instanceof e.Points){if(T.multiplyMatrices(C,u),x instanceof e.Geometry)for(ae=0,se=(ie=y.geometry.vertices).length;ae<se;ae++){le=ie[ae];z.set(le.x,le.y,le.z,1),z.applyMatrix4(T),P(z,y,i)}else if(x instanceof e.BufferGeometry){if(void 0!==(S=x.attributes).position){var Oe;for(j=0,O=(Oe=S.position.array).length;j<O;j+=3)z.set(Oe[j],Oe[j+1],Oe[j+2],1),z.applyMatrix4(T),P(z,y,i)}}}else y instanceof e.Sprite&&(y.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,y.matrixWorld),z.set(u.elements[12],u.elements[13],u.elements[14],1),z.applyMatrix4(C),P(z,y,i))}return!0===f&&M.elements.sort(G),M}},e.Projector});
//# sourceMappingURL=../sourcemaps/renderers/Projector.js.map
