/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs"],function(e){"use strict";var r=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},t=function(){this.id=0,this.v1=new i,this.v2=new i,this.v3=new i,this.normalModel=new e.Vector3,this.vertexNormalsModel=[new e.Vector3,new e.Vector3,new e.Vector3],this.vertexNormalsLength=0,this.color=new e.Color,this.material=null,this.uvs=[new e.Vector2,new e.Vector2,new e.Vector2],this.z=0,this.renderOrder=0},i=function(){this.position=new e.Vector3,this.positionWorld=new e.Vector3,this.positionScreen=new e.Vector4,this.visible=!0};i.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)};var o=function(){this.id=0,this.v1=new i,this.v2=new i,this.vertexColors=[new e.Color,new e.Color],this.material=null,this.z=0,this.renderOrder=0},n=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new e.Vector2,this.material=null,this.renderOrder=0},a=function(){var a,s,l,c,p,u,f,h,d,m,v,y=[],x=0,g=[],w=0,S=[],M=0,z=[],b=0,j=[],V=0,O={objects:[],lights:[],elements:[]},C=new e.Vector3,T=new e.Vector4,k=new e.Box3(new e.Vector3(-1,-1,-1),new e.Vector3(1,1,1)),L=new e.Box3,W=new Array(3),A=new e.Matrix4,B=new e.Matrix4,N=new e.Matrix4,R=new e.Matrix3,P=new e.Frustum,F=new e.Vector4,I=new e.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var E=new function(){var r=[],t=[],i=[],o=null,n=new e.Matrix3;function a(e){var r=e.position,t=e.positionWorld,i=e.positionScreen;t.copy(r).applyMatrix4(v),i.copy(t).applyMatrix4(B);var o=1/i.w;i.x*=o,i.y*=o,i.z*=o,e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1}function s(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(W[0]=e.positionScreen,W[1]=r.positionScreen,W[2]=t.positionScreen,k.intersectsBox(L.setFromPoints(W)))}function c(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(e){o=e,n.getNormalMatrix(o.matrixWorld),r.length=0,t.length=0,i.length=0},projectVertex:a,checkTriangleVisibility:s,checkBackfaceCulling:c,pushVertex:function(e,r,t){(l=U()).position.set(e,r,t),a(l)},pushNormal:function(e,t,i){r.push(e,t,i)},pushColor:function(e,r,i){t.push(e,r,i)},pushUv:function(e,r){i.push(e,r)},pushLine:function(e,r){var i=g[e],n=g[r];i.positionScreen.copy(i.position).applyMatrix4(N),n.positionScreen.copy(n.position).applyMatrix4(N),!0===Z(i.positionScreen,n.positionScreen)&&(i.positionScreen.multiplyScalar(1/i.positionScreen.w),n.positionScreen.multiplyScalar(1/n.positionScreen.w),(f=X()).id=o.id,f.v1.copy(i),f.v2.copy(n),f.z=Math.max(i.positionScreen.z,n.positionScreen.z),f.renderOrder=o.renderOrder,f.material=o.material,o.material.vertexColors&&(f.vertexColors[0].fromArray(t,3*e),f.vertexColors[1].fromArray(t,3*r)),O.elements.push(f))},pushTriangle:function(a,l,u,f){var h=g[a],d=g[l],m=g[u];if(!1!==s(h,d,m)&&(f.side===e.DoubleSide||!0===c(h,d,m))){(p=H()).id=o.id,p.v1.copy(h),p.v2.copy(d),p.v3.copy(m),p.z=(h.positionScreen.z+d.positionScreen.z+m.positionScreen.z)/3,p.renderOrder=o.renderOrder,C.subVectors(m.position,d.position),T.subVectors(h.position,d.position),C.cross(T),p.normalModel.copy(C),p.normalModel.applyMatrix3(n).normalize();for(var v=0;v<3;v++){var y=p.vertexNormalsModel[v];y.fromArray(r,3*arguments[v]),y.applyMatrix3(n).normalize(),p.uvs[v].fromArray(i,2*arguments[v])}p.vertexNormalsLength=3,p.material=f,f.vertexColors&&p.color.fromArray(t,3*a),O.elements.push(p)}}}};function G(e){(a=function(){if(s===x){var e=new r;return y.push(e),x++,s++,e}return y[s++]}()).id=e.id,a.object=e,C.setFromMatrixPosition(e.matrixWorld),C.applyMatrix4(B),a.z=C.z,a.renderOrder=e.renderOrder,O.objects.push(a)}function D(e,r,t){var i=1/e.w;e.z*=i,e.z>=-1&&e.z<=1&&((d=function(){if(m===V){var e=new n;return j.push(e),V++,m++,e}return j[m++]}()).id=r.id,d.x=e.x*i,d.y=e.y*i,d.z=e.z,d.renderOrder=r.renderOrder,d.object=r,d.rotation=r.rotation,d.scale.x=r.scale.x*Math.abs(d.x-(e.x+t.projectionMatrix.elements[0])/(e.w+t.projectionMatrix.elements[12])),d.scale.y=r.scale.y*Math.abs(d.y-(e.y+t.projectionMatrix.elements[5])/(e.w+t.projectionMatrix.elements[13])),d.material=r.material,O.elements.push(d))}function U(){if(c===w){var e=new i;return g.push(e),w++,c++,e}return g[c++]}function H(){if(u===M){var e=new t;return S.push(e),M++,u++,e}return S[u++]}function X(){if(h===b){var e=new o;return z.push(e),b++,h++,e}return z[h++]}function Y(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}function Z(e,r){var t=0,i=1,o=e.z+e.w,n=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;return o>=0&&n>=0&&a>=0&&s>=0||!(o<0&&n<0||a<0&&s<0)&&(o<0?t=Math.max(t,o/(o-n)):n<0&&(i=Math.min(i,o/(o-n))),a<0?t=Math.max(t,a/(a-s)):s<0&&(i=Math.min(i,a/(a-s))),!(i<t)&&(e.lerp(r,t),r.lerp(e,1-i),!0))}this.projectScene=function(r,t,i,o){u=0,h=0,m=0,O.elements.length=0,!0===r.autoUpdate&&r.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),A.copy(t.matrixWorldInverse),B.multiplyMatrices(t.projectionMatrix,A),P.setFromProjectionMatrix(B),s=0,O.objects.length=0,O.lights.length=0,function r(t){if(!1!==t.visible){if(t instanceof e.Light)O.lights.push(t);else if(t instanceof e.Mesh||t instanceof e.Line||t instanceof e.Points){if(!1===t.material.visible)return;if(!0===t.frustumCulled&&!1===P.intersectsObject(t))return;G(t)}else if(t instanceof e.Sprite){if(!1===t.material.visible)return;if(!0===t.frustumCulled&&!1===P.intersectsSprite(t))return;G(t)}for(var i=t.children,o=0,n=i.length;o<n;o++)r(i[o])}}(r),!0===i&&O.objects.sort(Y);for(var n=O.objects,a=0,l=n.length;a<l;a++){var d=n[a].object,y=d.geometry;if(E.setObject(d),v=d.matrixWorld,c=0,d instanceof e.Mesh){if(y instanceof e.BufferGeometry){var x=d.material,w=Array.isArray(x),S=y.attributes,M=y.groups;if(void 0===S.position)continue;for(var z=0,b=(Oe=S.position.array).length;z<b;z+=3){var j=Oe[z],V=Oe[z+1],k=Oe[z+2];if(!0===x.morphTargets)for(var L=y.morphAttributes.position,W=y.morphTargetsRelative,q=d.morphTargetInfluences,J=0,K=L.length;J<K;J++){if(0!==(ce=q[J])){var Q=L[J];W?(j+=Q.getX(z/3)*ce,V+=Q.getY(z/3)*ce,k+=Q.getZ(z/3)*ce):(j+=(Q.getX(z/3)-Oe[z])*ce,V+=(Q.getY(z/3)-Oe[z+1])*ce,k+=(Q.getZ(z/3)-Oe[z+2])*ce)}}E.pushVertex(j,V,k)}if(void 0!==S.normal){var $=S.normal.array;for(z=0,b=$.length;z<b;z+=3)E.pushNormal($[z],$[z+1],$[z+2])}if(void 0!==S.color)for(z=0,b=(je=S.color.array).length;z<b;z+=3)E.pushColor(je[z],je[z+1],je[z+2]);if(void 0!==S.uv){var _=S.uv.array;for(z=0,b=_.length;z<b;z+=2)E.pushUv(_[z],_[z+1])}if(null!==y.index){var ee=y.index.array;if(M.length>0)for(var re=0;re<M.length;re++){var te=M[re];if(void 0!==(x=!0===w?d.material[te.materialIndex]:d.material))for(z=te.start,b=te.start+te.count;z<b;z+=3)E.pushTriangle(ee[z],ee[z+1],ee[z+2],x)}else for(z=0,b=ee.length;z<b;z+=3)E.pushTriangle(ee[z],ee[z+1],ee[z+2],x)}else if(M.length>0)for(re=0;re<M.length;re++){te=M[re];if(void 0!==(x=!0===w?d.material[te.materialIndex]:d.material))for(z=te.start,b=te.start+te.count;z<b;z+=3)E.pushTriangle(z,z+1,z+2,x)}else for(z=0,b=Oe.length/3;z<b;z+=3)E.pushTriangle(z,z+1,z+2,x)}else if(y instanceof e.Geometry){var ie=y.vertices,oe=y.faces,ne=y.faceVertexUvs[0];R.getNormalMatrix(v);x=d.material,w=Array.isArray(x);for(var ae=0,se=ie.length;ae<se;ae++){var le=ie[ae];if(C.copy(le),!0===x.morphTargets)for(L=y.morphTargets,q=d.morphTargetInfluences,J=0,K=L.length;J<K;J++){var ce;if(0!==(ce=q[J])){var pe=(Q=L[J]).vertices[ae];C.x+=(pe.x-le.x)*ce,C.y+=(pe.y-le.y)*ce,C.z+=(pe.z-le.z)*ce}}E.pushVertex(C.x,C.y,C.z)}for(var ue=0,fe=oe.length;ue<fe;ue++){var he=oe[ue];if(void 0!==(x=!0===w?d.material[he.materialIndex]:d.material)){var de=x.side,me=g[he.a],ve=g[he.b],ye=g[he.c];if(!1!==E.checkTriangleVisibility(me,ve,ye)){var xe=E.checkBackfaceCulling(me,ve,ye);if(de!==e.DoubleSide){if(de===e.FrontSide&&!1===xe)continue;if(de===e.BackSide&&!0===xe)continue}(p=H()).id=d.id,p.v1.copy(me),p.v2.copy(ve),p.v3.copy(ye),p.normalModel.copy(he.normal),!1!==xe||de!==e.BackSide&&de!==e.DoubleSide||p.normalModel.negate(),p.normalModel.applyMatrix3(R).normalize();for(var ge=he.vertexNormals,we=0,Se=Math.min(ge.length,3);we<Se;we++){var Me=p.vertexNormalsModel[we];Me.copy(ge[we]),!1!==xe||de!==e.BackSide&&de!==e.DoubleSide||Me.negate(),Me.applyMatrix3(R).normalize()}p.vertexNormalsLength=ge.length;var ze=ne[ue];if(void 0!==ze)for(var be=0;be<3;be++)p.uvs[be].copy(ze[be]);p.color=he.color,p.material=x,p.z=(me.positionScreen.z+ve.positionScreen.z+ye.positionScreen.z)/3,p.renderOrder=d.renderOrder,O.elements.push(p)}}}}}else if(d instanceof e.Line){if(N.multiplyMatrices(B,v),y instanceof e.BufferGeometry){if(void 0!==(S=y.attributes).position){for(z=0,b=(Oe=S.position.array).length;z<b;z+=3)E.pushVertex(Oe[z],Oe[z+1],Oe[z+2]);if(void 0!==S.color){var je;for(z=0,b=(je=S.color.array).length;z<b;z+=3)E.pushColor(je[z],je[z+1],je[z+2])}if(null!==y.index)for(z=0,b=(ee=y.index.array).length;z<b;z+=2)E.pushLine(ee[z],ee[z+1]);else{var Ve=d instanceof e.LineSegments?2:1;for(z=0,b=Oe.length/3-1;z<b;z+=Ve)E.pushLine(z,z+1)}}}else if(y instanceof e.Geometry){if(0===(ie=d.geometry.vertices).length)continue;(me=U()).positionScreen.copy(ie[0]).applyMatrix4(N);for(Ve=d instanceof e.LineSegments?2:1,ae=1,se=ie.length;ae<se;ae++)(me=U()).positionScreen.copy(ie[ae]).applyMatrix4(N),(ae+1)%Ve>0||(ve=g[c-2],F.copy(me.positionScreen),I.copy(ve.positionScreen),!0===Z(F,I)&&(F.multiplyScalar(1/F.w),I.multiplyScalar(1/I.w),(f=X()).id=d.id,f.v1.positionScreen.copy(F),f.v2.positionScreen.copy(I),f.z=Math.max(F.z,I.z),f.renderOrder=d.renderOrder,f.material=d.material,d.material.vertexColors&&(f.vertexColors[0].copy(d.geometry.colors[ae]),f.vertexColors[1].copy(d.geometry.colors[ae-1])),O.elements.push(f)))}}else if(d instanceof e.Points){if(N.multiplyMatrices(B,v),y instanceof e.Geometry)for(ae=0,se=(ie=d.geometry.vertices).length;ae<se;ae++){le=ie[ae];T.set(le.x,le.y,le.z,1),T.applyMatrix4(N),D(T,d,t)}else if(y instanceof e.BufferGeometry){if(void 0!==(S=y.attributes).position){var Oe;for(z=0,b=(Oe=S.position.array).length;z<b;z+=3)T.set(Oe[z],Oe[z+1],Oe[z+2],1),T.applyMatrix4(N),D(T,d,t)}}}else d instanceof e.Sprite&&(d.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,d.matrixWorld),T.set(v.elements[12],v.elements[13],v.elements[14],1),T.applyMatrix4(B),D(T,d,t))}return!0===o&&O.elements.sort(Y),O}};return a.RenderableObject=r,a.RenderableFace=t,a.RenderableVertex=i,a.RenderableLine=o,a.RenderableSprite=n,a});
//# sourceMappingURL=../sourcemaps/renderers/Projector.js.map
