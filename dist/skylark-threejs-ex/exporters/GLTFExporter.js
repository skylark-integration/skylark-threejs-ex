/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs","../threex"],function(e,t){"use strict";var r={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,FLOAT:5126,UNSIGNED_INT:5125,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},a={};a[e.NearestFilter]=r.NEAREST,a[e.NearestMipmapNearestFilter]=r.NEAREST_MIPMAP_NEAREST,a[e.NearestMipmapLinearFilter]=r.NEAREST_MIPMAP_LINEAR,a[e.LinearFilter]=r.LINEAR,a[e.LinearMipmapNearestFilter]=r.LINEAR_MIPMAP_NEAREST,a[e.LinearMipmapLinearFilter]=r.LINEAR_MIPMAP_LINEAR,a[e.ClampToEdgeWrapping]=r.CLAMP_TO_EDGE,a[e.RepeatWrapping]=r.REPEAT,a[e.MirroredRepeatWrapping]=r.MIRRORED_REPEAT;var n={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},s=function(){};return s.prototype={constructor:s,parse:function(t,i,o){var l={binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,maxTextureSize:1/0,animations:[],forceIndices:!1,forcePowerOfTwoTextures:!1,includeCustomExtensions:!1};(o=Object.assign({},l,o)).animations.length>0&&(o.trs=!0);var u,f={asset:{version:"2.0",generator:"GLTFExporter"}},p=0,c=[],m=[],h=new Map,g=[],d={},v={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},E=new Map,T=0;function y(e){return E.has(e)||E.set(e,T++),E.get(e)}function b(e,t){return e.length===t.length&&e.every(function(e,r){return e===t[r]})}function x(e){return 4*Math.ceil(e/4)}function w(e,t){t=t||0;var r=x(e.byteLength);if(r!==e.byteLength){var a=new Uint8Array(r);if(a.set(new Uint8Array(e)),0!==t)for(var n=e.byteLength;n<r;n++)a[n]=t;return a.buffer}return e}function R(e,t){if(0!==Object.keys(e.userData).length)try{var r=JSON.parse(JSON.stringify(e.userData));if(o.includeCustomExtensions&&r.gltfExtensions){for(var a in void 0===t.extensions&&(t.extensions={}),r.gltfExtensions)t.extensions[a]=r.gltfExtensions[a],d[a]=!0;delete r.gltfExtensions}Object.keys(r).length>0&&(t.extras=r)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}function A(e,t){var r=!1,a={};0===t.offset.x&&0===t.offset.y||(a.offset=t.offset.toArray(),r=!0),0!==t.rotation&&(a.rotation=t.rotation,r=!0),1===t.repeat.x&&1===t.repeat.y||(a.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=a,d.KHR_texture_transform=!0)}function M(e){return f.buffers||(f.buffers=[{byteLength:0}]),c.push(e),0}function I(e,t,a,n){var s;if(e.array.constructor===Float32Array)s=r.FLOAT;else if(e.array.constructor===Uint32Array)s=r.UNSIGNED_INT;else if(e.array.constructor===Uint16Array)s=r.UNSIGNED_SHORT;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");s=r.UNSIGNED_BYTE}if(void 0===a&&(a=0),void 0===n&&(n=e.count),o.truncateDrawRange&&void 0!==t&&null===t.index){var i=a+n,l=t.drawRange.count===1/0?e.count:t.drawRange.start+t.drawRange.count;a=Math.max(a,t.drawRange.start),(n=Math.min(i,l)-a)<0&&(n=0)}if(0===n)return null;var u,c=function(e,t,r){for(var a={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},n=t;n<t+r;n++)for(var s=0;s<e.itemSize;s++){var i=e.array[n*e.itemSize+s];a.min[s]=Math.min(a.min[s],i),a.max[s]=Math.max(a.max[s],i)}return a}(e,a,n);void 0!==t&&(u=e===t.index?r.ELEMENT_ARRAY_BUFFER:r.ARRAY_BUFFER);var m=function(e,t,a,n,s){var i;f.bufferViews||(f.bufferViews=[]),i=t===r.UNSIGNED_BYTE?1:t===r.UNSIGNED_SHORT?2:4;for(var o=x(n*e.itemSize*i),l=new DataView(new ArrayBuffer(o)),u=0,c=a;c<a+n;c++)for(var m=0;m<e.itemSize;m++){var h=e.array[c*e.itemSize+m];t===r.FLOAT?l.setFloat32(u,h,!0):t===r.UNSIGNED_INT?l.setUint32(u,h,!0):t===r.UNSIGNED_SHORT?l.setUint16(u,h,!0):t===r.UNSIGNED_BYTE&&l.setUint8(u,h),u+=i}var g={buffer:M(l.buffer),byteOffset:p,byteLength:o};return void 0!==s&&(g.target=s),s===r.ARRAY_BUFFER&&(g.byteStride=e.itemSize*i),p+=o,f.bufferViews.push(g),{id:f.bufferViews.length-1,byteLength:0}}(e,s,a,n,u),h={bufferView:m.id,byteOffset:m.byteOffset,componentType:s,count:n,max:c.max,min:c.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return f.accessors||(f.accessors=[]),f.accessors.push(h),f.accessors.length-1}function N(t,r,a){v.images.has(t)||v.images.set(t,{});var n=v.images.get(t),s=r===e.RGBAFormat?"image/png":"image/jpeg",i=s+":flipY/"+a.toString();if(void 0!==n[i])return n[i];f.images||(f.images=[]);var l={mimeType:s};if(o.embedImages){var c=u=u||document.createElement("canvas");c.width=Math.min(t.width,o.maxTextureSize),c.height=Math.min(t.height,o.maxTextureSize),o.forcePowerOfTwoTextures&&!function(t){return e.MathUtils.isPowerOfTwo(t.width)&&e.MathUtils.isPowerOfTwo(t.height)}(c)&&(console.warn("GLTFExporter: Resized non-power-of-two image.",t),c.width=e.MathUtils.floorPowerOfTwo(c.width),c.height=e.MathUtils.floorPowerOfTwo(c.height));var h=c.getContext("2d");!0===a&&(h.translate(0,c.height),h.scale(1,-1)),h.drawImage(t,0,0,c.width,c.height),!0===o.binary?m.push(new Promise(function(e){c.toBlob(function(t){(function(e){return f.bufferViews||(f.bufferViews=[]),new Promise(function(t){var r=new window.FileReader;r.readAsArrayBuffer(e),r.onloadend=function(){var e=w(r.result),a={buffer:M(e),byteOffset:p,byteLength:e.byteLength};p+=e.byteLength,f.bufferViews.push(a),t(f.bufferViews.length-1)}})})(t).then(function(t){l.bufferView=t,e()})},s)})):l.uri=c.toDataURL(s)}else l.uri=t.src;f.images.push(l);var g=f.images.length-1;return n[i]=g,g}function S(e){if(v.textures.has(e))return v.textures.get(e);f.textures||(f.textures=[]);var t={sampler:function(e){f.samplers||(f.samplers=[]);var t={magFilter:a[e.magFilter],minFilter:a[e.minFilter],wrapS:a[e.wrapS],wrapT:a[e.wrapT]};return f.samplers.push(t),f.samplers.length-1}(e),source:N(e.image,e.format,e.flipY)};e.name&&(t.name=e.name),f.textures.push(t);var r=f.textures.length-1;return v.textures.set(e,r),r}function L(t){if(v.materials.has(t))return v.materials.get(t);if(t.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;f.materials||(f.materials=[]);var r={pbrMetallicRoughness:{}};t.isMeshBasicMaterial?(r.extensions={KHR_materials_unlit:{}},d.KHR_materials_unlit=!0):t.isGLTFSpecularGlossinessMaterial?(r.extensions={KHR_materials_pbrSpecularGlossiness:{}},d.KHR_materials_pbrSpecularGlossiness=!0):t.isMeshStandardMaterial||console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");var a=t.color.toArray().concat([t.opacity]);if(b(a,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=a),t.isMeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=t.metalness,r.pbrMetallicRoughness.roughnessFactor=t.roughness):t.isMeshBasicMaterial?(r.pbrMetallicRoughness.metallicFactor=0,r.pbrMetallicRoughness.roughnessFactor=.9):(r.pbrMetallicRoughness.metallicFactor=.5,r.pbrMetallicRoughness.roughnessFactor=.5),t.isGLTFSpecularGlossinessMaterial){r.pbrMetallicRoughness.baseColorFactor&&(r.extensions.KHR_materials_pbrSpecularGlossiness.diffuseFactor=r.pbrMetallicRoughness.baseColorFactor);var n=[1,1,1];t.specular.toArray(n,0),r.extensions.KHR_materials_pbrSpecularGlossiness.specularFactor=n,r.extensions.KHR_materials_pbrSpecularGlossiness.glossinessFactor=t.glossiness}if(t.metalnessMap||t.roughnessMap)if(t.metalnessMap===t.roughnessMap){var s={index:S(t.metalnessMap)};A(s,t.metalnessMap),r.pbrMetallicRoughness.metallicRoughnessTexture=s}else console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.");if(t.map){var i={index:S(t.map)};A(i,t.map),t.isGLTFSpecularGlossinessMaterial&&(r.extensions.KHR_materials_pbrSpecularGlossiness.diffuseTexture=i),r.pbrMetallicRoughness.baseColorTexture=i}if(t.isGLTFSpecularGlossinessMaterial&&t.specularMap){var o={index:S(t.specularMap)};A(o,t.specularMap),r.extensions.KHR_materials_pbrSpecularGlossiness.specularGlossinessTexture=o}if(t.emissive){var l=t.emissive.clone().multiplyScalar(t.emissiveIntensity).toArray();if(b(l,[0,0,0])||(r.emissiveFactor=l),t.emissiveMap){var u={index:S(t.emissiveMap)};A(u,t.emissiveMap),r.emissiveTexture=u}}if(t.normalMap){var p={index:S(t.normalMap)};t.normalScale&&-1!==t.normalScale.x&&(t.normalScale.x!==t.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),p.scale=t.normalScale.x),A(p,t.normalMap),r.normalTexture=p}if(t.aoMap){var c={index:S(t.aoMap),texCoord:1};1!==t.aoMapIntensity&&(c.strength=t.aoMapIntensity),A(c,t.aoMap),r.occlusionTexture=c}t.transparent?r.alphaMode="BLEND":t.alphaTest>0&&(r.alphaMode="MASK",r.alphaCutoff=t.alphaTest),t.side===e.DoubleSide&&(r.doubleSided=!0),""!==t.name&&(r.name=t.name),R(t,r),f.materials.push(r);var m=f.materials.length-1;return v.materials.set(t,m),m}function _(t){var a=[t.geometry.uuid];if(Array.isArray(t.material))for(var n=0,s=t.material.length;n<s;n++)a.push(t.material[n].uuid);else a.push(t.material.uuid);var i=a.join(":");if(v.meshes.has(i))return v.meshes.get(i);var l,u=t.geometry;l=t.isLineSegments?r.LINES:t.isLineLoop?r.LINE_LOOP:t.isLine?r.LINE_STRIP:t.isPoints?r.POINTS:t.material.wireframe?r.LINES:r.TRIANGLES,u.isBufferGeometry||(console.warn("GLTFExporter: Exporting THREE.Geometry will increase file size. Use BufferGeometry instead."),u=(new e.BufferGeometry).setFromObject(t));var p={},c={},m=[],h=[],g={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=u.getAttribute("normal");void 0===d||function(t){if(v.attributesNormalized.has(t))return!1;for(var r=new e.Vector3,a=0,n=t.count;a<n;a++)if(Math.abs(r.fromArray(t.array,3*a).length()-1)>5e-4)return!1;return!0}(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),u.setAttribute("normal",function(t){if(v.attributesNormalized.has(t))return v.attributesNormalized.get(t);for(var r=t.clone(),a=new e.Vector3,n=0,s=r.count;n<s;n++)a.fromArray(r.array,3*n),0===a.x&&0===a.y&&0===a.z?a.setX(1):a.normalize(),a.toArray(r.array,3*n);return v.attributesNormalized.set(t,r),r}(d)));var E=null;for(var T in u.attributes)if("morph"!==T.substr(0,5)){var b=u.attributes[T];T=g[T]||T.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(T)||(T="_"+T),v.attributes.has(y(b)))c[T]=v.attributes.get(y(b));else{E=null;var x=b.array;"JOINTS_0"!==T||x instanceof Uint16Array||x instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),E=new e.BufferAttribute(new Uint16Array(x),b.itemSize,b.normalized));var w=I(E||b,u);null!==w&&(c[T]=w,v.attributes.set(y(b),w))}}if(void 0!==d&&u.setAttribute("normal",d),0===Object.keys(c).length)return null;if(void 0!==t.morphTargetInfluences&&t.morphTargetInfluences.length>0){var A=[],M=[],N={};if(void 0!==t.morphTargetDictionary)for(var S in t.morphTargetDictionary)N[t.morphTargetDictionary[S]]=S;for(n=0;n<t.morphTargetInfluences.length;++n){var _={},F=!1;for(var T in u.morphAttributes)if("position"===T||"normal"===T){b=u.morphAttributes[T][n];var G=T.toUpperCase(),O=u.attributes[T];if(v.attributes.has(y(b)))_[G]=v.attributes.get(y(b));else{var U=b.clone();if(!u.morphTargetsRelative)for(var P=0,B=b.count;P<B;P++)U.setXYZ(P,b.getX(P)-O.getX(P),b.getY(P)-O.getY(P),b.getZ(P)-O.getZ(P));_[G]=I(U,u),v.attributes.set(y(O),_[G])}}else F||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),F=!0);h.push(_),A.push(t.morphTargetInfluences[n]),void 0!==t.morphTargetDictionary&&M.push(N[n])}p.weights=A,M.length>0&&(p.extras={},p.extras.targetNames=M)}var D=o.forceIndices,C=Array.isArray(t.material);if(C&&0===u.groups.length)return null;!D&&null===u.index&&C&&(console.warn("THREE.GLTFExporter: Creating index for non-indexed multi-material mesh."),D=!0);var H=!1;if(null===u.index&&D){for(var z=[],k=(n=0,u.attributes.position.count);n<k;n++)z[n]=n;u.setIndex(z),H=!0}var V=C?t.material:[t.material],K=C?u.groups:[{materialIndex:0,start:void 0,count:void 0}];for(n=0,k=K.length;n<k;n++){var Y={mode:l,attributes:c};if(R(u,Y),h.length>0&&(Y.targets=h),null!==u.index){var j=y(u.index);void 0===K[n].start&&void 0===K[n].count||(j+=":"+K[n].start+":"+K[n].count),v.attributes.has(j)?Y.indices=v.attributes.get(j):(Y.indices=I(u.index,u,K[n].start,K[n].count),v.attributes.set(j,Y.indices)),null===Y.indices&&delete Y.indices}var X=L(V[K[n].materialIndex]);null!==X&&(Y.material=X),m.push(Y)}H&&u.setIndex(null),p.primitives=m,f.meshes||(f.meshes=[]),f.meshes.push(p);var J=f.meshes.length-1;return v.meshes.set(i,J),J}function F(t,r){f.animations||(f.animations=[]);for(var a=(t=s.Utils.mergeMorphTargetTracks(t.clone(),r)).tracks,i=[],o=[],l=0;l<a.length;++l){var u=a[l],p=e.PropertyBinding.parseTrackName(u.name),c=e.PropertyBinding.findNode(r,p.nodeName),m=n[p.propertyName];if("bones"===p.objectName&&(c=!0===c.isSkinnedMesh?c.skeleton.getBoneByName(p.objectIndex):void 0),!c||!m)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',u.name),null;var g,d=u.values.length/u.times.length;m===n.morphTargetInfluences&&(d/=c.morphTargetInfluences.length),!0===u.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(g="CUBICSPLINE",d/=3):g=u.getInterpolation()===e.InterpolateDiscrete?"STEP":"LINEAR",o.push({input:I(new e.BufferAttribute(u.times,1)),output:I(new e.BufferAttribute(u.values,d)),interpolation:g}),i.push({sampler:o.length-1,target:{node:h.get(c),path:m}})}return f.animations.push({name:t.name||"clip_"+f.animations.length,samplers:o,channels:i}),f.animations.length-1}function G(t){var r=f.nodes[h.get(t)],a=t.skeleton;if(void 0===a)return null;var n=t.skeleton.bones[0];if(void 0===n)return null;for(var s=[],i=new Float32Array(16*a.bones.length),o=0;o<a.bones.length;++o)s.push(h.get(a.bones[o])),a.boneInverses[o].toArray(i,16*o);return void 0===f.skins&&(f.skins=[]),f.skins.push({inverseBindMatrices:I(new e.BufferAttribute(i,16)),joints:s,skeleton:h.get(n)}),r.skin=f.skins.length-1}function O(t){f.nodes||(f.nodes=[]);var r={};if(o.trs){var a=t.quaternion.toArray(),n=t.position.toArray(),s=t.scale.toArray();b(a,[0,0,0,1])||(r.rotation=a),b(n,[0,0,0])||(r.translation=n),b(s,[1,1,1])||(r.scale=s)}else t.matrixAutoUpdate&&t.updateMatrix(),b(t.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])||(r.matrix=t.matrix.elements);if(""!==t.name&&(r.name=String(t.name)),R(t,r),t.isMesh||t.isLine||t.isPoints){var i=_(t);null!==i&&(r.mesh=i)}else if(t.isCamera)r.camera=function(t){f.cameras||(f.cameras=[]);var r=t.isOrthographicCamera,a={type:r?"orthographic":"perspective"};return r?a.orthographic={xmag:2*t.right,ymag:2*t.top,zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near}:a.perspective={aspectRatio:t.aspect,yfov:e.MathUtils.degToRad(t.fov),zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near},""!==t.name&&(a.name=t.type),f.cameras.push(a),f.cameras.length-1}(t);else if(t.isDirectionalLight||t.isPointLight||t.isSpotLight)d.KHR_lights_punctual||(f.extensions=f.extensions||{},f.extensions.KHR_lights_punctual={lights:[]},d.KHR_lights_punctual=!0),r.extensions=r.extensions||{},r.extensions.KHR_lights_punctual={light:function(e){var t={};e.name&&(t.name=e.name),t.color=e.color.toArray(),t.intensity=e.intensity,e.isDirectionalLight?t.type="directional":e.isPointLight?(t.type="point",e.distance>0&&(t.range=e.distance)):e.isSpotLight&&(t.type="spot",e.distance>0&&(t.range=e.distance),t.spot={},t.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,t.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1.");var r=f.extensions.KHR_lights_punctual.lights;return r.push(t),r.length-1}(t)};else if(t.isLight)return console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",t),null;if(t.isSkinnedMesh&&g.push(t),t.children.length>0){for(var l=[],u=0,p=t.children.length;u<p;u++){var c=t.children[u];if(c.visible||!1===o.onlyVisible){var m=O(c);null!==m&&l.push(m)}}l.length>0&&(r.children=l)}f.nodes.push(r);var v=f.nodes.length-1;return h.set(t,v),v}function U(e){f.scenes||(f.scenes=[],f.scene=0);var t={};""!==e.name&&(t.name=e.name),f.scenes.push(t);for(var r=[],a=0,n=e.children.length;a<n;a++){var s=e.children[a];if(s.visible||!1===o.onlyVisible){var i=O(s);null!==i&&r.push(i)}}r.length>0&&(t.nodes=r),R(e,t)}!function(t){t=t instanceof Array?t:[t];for(var r=[],a=0;a<t.length;a++)t[a]instanceof e.Scene?U(t[a]):r.push(t[a]);for(r.length>0&&function(t){var r=new e.Scene;r.name="AuxScene";for(var a=0;a<t.length;a++)r.children.push(t[a]);U(r)}(r),a=0;a<g.length;++a)G(g[a]);for(a=0;a<o.animations.length;++a)F(o.animations[a],t[0])}(t),Promise.all(m).then(function(){var e=new Blob(c,{type:"application/octet-stream"}),t=Object.keys(d);if(t.length>0&&(f.extensionsUsed=t),f.buffers&&f.buffers.length>0&&(f.buffers[0].byteLength=e.size),!0===o.binary){(r=new window.FileReader).readAsArrayBuffer(e),r.onloadend=function(){var e=w(r.result),t=new DataView(new ArrayBuffer(8));t.setUint32(0,e.byteLength,!0),t.setUint32(4,5130562,!0);var a=w(function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;for(var t=new Uint8Array(new ArrayBuffer(e.length)),r=0,a=e.length;r<a;r++){var n=e.charCodeAt(r);t[r]=n>255?32:n}return t.buffer}(JSON.stringify(f)),32),n=new DataView(new ArrayBuffer(8));n.setUint32(0,a.byteLength,!0),n.setUint32(4,1313821514,!0);var s=new ArrayBuffer(12),o=new DataView(s);o.setUint32(0,1179937895,!0),o.setUint32(4,2,!0);var l=12+n.byteLength+a.byteLength+t.byteLength+e.byteLength;o.setUint32(8,l,!0);var u=new Blob([s,n,a,t,e],{type:"application/octet-stream"}),p=new window.FileReader;p.readAsArrayBuffer(u),p.onloadend=function(){i(p.result)}}}else{var r;if(f.buffers&&f.buffers.length>0)(r=new window.FileReader).readAsDataURL(e),r.onloadend=function(){var e=r.result;f.buffers[0].uri=e,i(f)};else i(f)}})}},s.Utils={insertKeyframe:function(e,t){var r,a=e.getValueSize(),n=new e.TimeBufferType(e.times.length+1),s=new e.ValueBufferType(e.values.length+a),i=e.createInterpolant(new e.ValueBufferType(a));if(0===e.times.length){n[0]=t;for(var o=0;o<a;o++)s[o]=0;r=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<.001)return 0;n[0]=t,n.set(e.times,1),s.set(i.evaluate(t),0),s.set(e.values,a),r=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<.001)return e.times.length-1;n[n.length-1]=t,n.set(e.times,0),s.set(e.values,0),s.set(i.evaluate(t),e.values.length),r=n.length-1}else for(o=0;o<e.times.length;o++){if(Math.abs(e.times[o]-t)<.001)return o;if(e.times[o]<t&&e.times[o+1]>t){n.set(e.times.slice(0,o+1),0),n[o+1]=t,n.set(e.times.slice(o+1),o+2),s.set(e.values.slice(0,(o+1)*a),0),s.set(i.evaluate(t),(o+1)*a),s.set(e.values.slice((o+1)*a),(o+2)*a),r=o+1;break}}return e.times=n,e.values=s,r},mergeMorphTargetTracks:function(t,r){for(var a=[],n={},s=t.tracks,i=0;i<s.length;++i){var o=s[i],l=e.PropertyBinding.parseTrackName(o.name),u=e.PropertyBinding.findNode(r,l.nodeName);if("morphTargetInfluences"===l.propertyName&&void 0!==l.propertyIndex){if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(o=o.clone()).setInterpolation(e.InterpolateLinear)}var f,p=u.morphTargetInfluences.length,c=u.morphTargetDictionary[l.propertyIndex];if(void 0===c)throw new Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0!==n[u.uuid]){var m=o.createInterpolant(new o.ValueBufferType(1));f=n[u.uuid];for(d=0;d<f.times.length;d++)f.values[d*p+c]=m.evaluate(f.times[d]);for(d=0;d<o.times.length;d++){var h=this.insertKeyframe(f,o.times[d]);f.values[h*p+c]=o.values[d]}}else{for(var g=new((f=o.clone()).ValueBufferType)(p*f.times.length),d=0;d<f.times.length;d++)g[d*p+c]=f.values[d];f.name=".morphTargetInfluences",f.values=g,n[u.uuid]=f,a.push(f)}}else a.push(o)}return t.tracks=a,t}},t.exporters.GLTFExporter=s});
//# sourceMappingURL=../sourcemaps/exporters/GLTFExporter.js.map
