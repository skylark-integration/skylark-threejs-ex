/**
 * skylark-threejs-ex - A version of threejs extentions library that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threejs-ex/
 * @license MIT
 */
define(["skylark-threejs","../threex","../geometries/ConvexGeometry"],function(e,t,r){"use strict";var o,n=function(t,r){this.minSizeForBreak=t||1.4,this.smallDelta=r||1e-4,this.tempLine1=new e.Line3,this.tempPlane1=new e.Plane,this.tempPlane2=new e.Plane,this.tempPlane_Cut=new e.Plane,this.tempCM1=new e.Vector3,this.tempCM2=new e.Vector3,this.tempVector3=new e.Vector3,this.tempVector3_2=new e.Vector3,this.tempVector3_3=new e.Vector3,this.tempVector3_P0=new e.Vector3,this.tempVector3_P1=new e.Vector3,this.tempVector3_P2=new e.Vector3,this.tempVector3_N0=new e.Vector3,this.tempVector3_N1=new e.Vector3,this.tempVector3_AB=new e.Vector3,this.tempVector3_CB=new e.Vector3,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(var o=0;o<900;o++)this.segments[o]=!1};return n.prototype={constructor:n,prepareBreakableObject:function(e,t,r,o,n){e.geometry.isBufferGeometry||console.error("THREE.ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry.");var s=e.userData;s.mass=t,s.velocity=r.clone(),s.angularVelocity=o.clone(),s.breakable=n},subdivideByImpact:function(e,t,r,o,n){var s=[],a=this.tempPlane1,i=this.tempPlane2;this.tempVector3.addVectors(t,r),a.setFromCoplanarPoints(t,e.position,this.tempVector3);var c=n+o,m=this;return function n(p,l,h,u){if(Math.random()<.05*u||u>c)s.push(p);else{var v=Math.PI;0===u?(i.normal.copy(a.normal),i.constant=a.constant):u<=o?(v=(h-l)*(.2+.6*Math.random())+l,m.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(r,v).add(t),i.setFromCoplanarPoints(t,m.tempVector3,m.tempVector3_2)):(v=(.5*(1&u)+.2*(2-Math.random()))*Math.PI,m.tempVector3_2.copy(t).sub(p.position).applyAxisAngle(r,v).add(p.position),m.tempVector3_3.copy(r).add(p.position),i.setFromCoplanarPoints(p.position,m.tempVector3_3,m.tempVector3_2)),m.cutByPlane(p,i,m.tempResultObjects);var V=m.tempResultObjects.object1,f=m.tempResultObjects.object2;V&&n(V,l,v,u+1),f&&n(f,v,h,u+1)}}(e,0,2*Math.PI,0),s},cutByPlane:function(t,r,o){var s=t.geometry,a=s.attributes.position.array,i=s.attributes.normal.array,c=a.length/3,m=c/3,p=s.getIndex();function l(e,t){var r=3*e+t;return p?p[r]:r}p&&(m=(p=p.array).length/3);for(var h=[],u=[],v=this.smallDelta,V=c*c,f=0;f<V;f++)this.segments[f]=!1;var y=this.tempVector3_P0,d=this.tempVector3_P1,b=this.tempVector3_N0,g=this.tempVector3_N1;for(f=0;f<m-1;f++){var P=l(f,0),C=l(f,1),M=l(f,2);b.set(i[P],i[P]+1,i[P]+2);for(var w=f+1;w<m;w++){var x=l(w,0),_=l(w,1),j=l(w,2);g.set(i[x],i[x]+1,i[x]+2),1-b.dot(g)<v&&(P===x||P===_||P===j?C===x||C===_||C===j?(this.segments[P*c+C]=!0,this.segments[C*c+P]=!0):(this.segments[M*c+P]=!0,this.segments[P*c+M]=!0):C!==x&&C!==_&&C!==j||(this.segments[M*c+C]=!0,this.segments[C*c+M]=!0))}}var B=this.tempPlane_Cut;t.updateMatrix(),n.transformPlaneToLocalSpace(r,t.matrix,B);for(f=0;f<m;f++)for(var k=l(f,0),O=l(f,1),z=l(f,2),I=0;I<3;I++){var F=0===I?k:1===I?O:z,D=0===I?O:1===I?z:k;if(!this.segments[F*c+D]){this.segments[F*c+D]=!0,this.segments[D*c+F]=!0,y.set(a[3*F],a[3*F+1],a[3*F+2]),d.set(a[3*D],a[3*D+1],a[3*D+2]);var L=0;(S=B.distanceToPoint(y))>v?(L=2,u.push(y.clone())):S<-v?(L=1,h.push(y.clone())):(L=3,h.push(y.clone()),u.push(y.clone()));var S,T=0;if((S=B.distanceToPoint(d))>v?(T=2,u.push(d.clone())):S<-v?(T=1,h.push(d.clone())):(T=3,h.push(d.clone()),u.push(d.clone())),1===L&&2===T||2===L&&1===T){this.tempLine1.start.copy(y),this.tempLine1.end.copy(d);var A=new e.Vector3;if(void 0===(A=B.intersectLine(this.tempLine1,A)))return console.error("Internal error: segment does not intersect plane."),o.segmentedObject1=null,o.segmentedObject2=null,0;h.push(A),u.push(A.clone())}}}var G=.5*t.userData.mass;this.tempCM1.set(0,0,0);var R=0,q=h.length;if(q>0){for(f=0;f<q;f++)this.tempCM1.add(h[f]);this.tempCM1.divideScalar(q);for(f=0;f<q;f++){(H=h[f]).sub(this.tempCM1),R=Math.max(R,H.x,H.y,H.z)}this.tempCM1.add(t.position)}this.tempCM2.set(0,0,0);var N=0,E=u.length;if(E>0){for(f=0;f<E;f++)this.tempCM2.add(u[f]);this.tempCM2.divideScalar(E);for(f=0;f<E;f++){var H;(H=u[f]).sub(this.tempCM2),N=Math.max(N,H.x,H.y,H.z)}this.tempCM2.add(t.position)}var J=null,K=null,Q=0;return q>4&&((J=new e.Mesh(new ConvexBufferGeometry(h),t.material)).position.copy(this.tempCM1),J.quaternion.copy(t.quaternion),this.prepareBreakableObject(J,G,t.userData.velocity,t.userData.angularVelocity,2*R>this.minSizeForBreak),Q++),E>4&&((K=new e.Mesh(new ConvexBufferGeometry(u),t.material)).position.copy(this.tempCM2),K.quaternion.copy(t.quaternion),this.prepareBreakableObject(K,G,t.userData.velocity,t.userData.angularVelocity,2*N>this.minSizeForBreak),Q++),o.object1=J,o.object2=K,Q}},n.transformFreeVector=function(e,t){var r=e.x,o=e.y,n=e.z,s=t.elements;return e.x=s[0]*r+s[4]*o+s[8]*n,e.y=s[1]*r+s[5]*o+s[9]*n,e.z=s[2]*r+s[6]*o+s[10]*n,e},n.transformFreeVectorInverse=function(e,t){var r=e.x,o=e.y,n=e.z,s=t.elements;return e.x=s[0]*r+s[1]*o+s[2]*n,e.y=s[4]*r+s[5]*o+s[6]*n,e.z=s[8]*r+s[9]*o+s[10]*n,e},n.transformTiedVectorInverse=function(e,t){var r=e.x,o=e.y,n=e.z,s=t.elements;return e.x=s[0]*r+s[1]*o+s[2]*n-s[12],e.y=s[4]*r+s[5]*o+s[6]*n-s[13],e.z=s[8]*r+s[9]*o+s[10]*n-s[14],e},n.transformPlaneToLocalSpace=(o=new e.Vector3,function(e,t,r){r.normal.copy(e.normal),r.constant=e.constant;var s=n.transformTiedVectorInverse(e.coplanarPoint(o),t);n.transformFreeVectorInverse(r.normal,t),r.constant=-s.dot(r.normal)}),t.misc.ConvexObjectBreaker=n});
//# sourceMappingURL=../sourcemaps/misc/ConvexObjectBreaker.js.map
