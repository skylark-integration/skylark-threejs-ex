{"version":3,"sources":["geometries/LightningStrike.js"],"names":["define","THREE","SimplexNoise","LightningStrike","rayParameters","BufferGeometry","call","this","type","init","copyParameters","createMesh","prototype","Object","create","constructor","isLightningStrike","RAY_INITIALIZED","RAY_UNBORN","RAY_PROPAGATING","RAY_STEADY","RAY_VANISHING","RAY_EXTINGUISHED","COS30DEG","Math","cos","PI","SIN30DEG","sin","createRandomGenerator","seeds","i","push","random","generator","currentSeed","value","getSeed","setSeed","seed","floor","dest","source","vecCopy","v","clone","sourceOffset","undefined","Vector3","destOffset","timeScale","roughness","straightness","up0","up1","radius0","radius1","radius0Factor","radius1Factor","minRadius","isEternal","birthTime","deathTime","propagationTimeFactor","vanishingTimeFactor","subrayPeriod","subrayDutyCycle","maxIterations","isStatic","ramification","maxSubrayRecursion","recursionProbability","generateUVs","randomGenerator","noiseSeed","onDecideSubrayCreation","onSubrayCreation","update","time","updateMesh","subrays","endPropagationTime","state","beginVanishingTime","visible","seedGenerator","createDefaultSubrayCreationCallbacks","maxSubrays","ceil","pow","max","maxRaySegments","createSubray","raySegments","createSegment","timeFraction","currentSegmentCallback","currentCreateTriangleVertices","createTriangleVerticesWithUVs","createTriangleVerticesWithoutUVs","numSubrays","currentSubray","currentSegmentIndex","isInitialSegment","subrayProbability","currentVertex","currentIndex","currentCoordinate","currentUVCoordinate","vertices","uvs","indices","positionAttribute","uvsAttribute","simplexX","simplexY","simplexZ","forwards","forwardsFill","side","down","middlePos","middleLinPos","newPos","vPos","cross1","maxDrawableSegmentsPerSubRay","maxVerts","maxIndices","Float32Array","Uint32Array","fillMesh","setIndex","Uint32BufferAttribute","Float32BufferAttribute","setAttribute","index","usage","DynamicDrawUsage","array","drawRange","count","needsUpdate","scope","fractalRay","segment","subray","recursion","createPrism","fraction0","fraction1","addNewSubray","initSubray","pos0","copy","pos1","segmentCallback","subrayIndex","MathUtils","lerp","random1","linPos0","set","multiplyScalar","linPos1","getNewSegment","iteration","positionVariationFactor","fractalRayRecursive","subVectors","lForwards","length","middleRadius","middleFraction","timeDimension","lerpVectors","p","noise4d","x","y","z","add","newSegment1","newSegment2","crossVectors","normalize","createPrismFaces","pos","up","radius","sub","u","uv","vertex","lightningStrike","period","dutyCycle","phase0","phase","currentCycle","childSubraySeed","probability","childSubray","parentSeed","min","vec1Pos","vec2Forward","vec3Side","vec4Up","parentSubray","subrayCylinderPosition","subrayConePosition","heightFactor","sideWidthFactor","minSideWidthFactor","angle"],"mappings":"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","file":"../../geometries/LightningStrike.js","sourcesContent":["define([\n    \"skylark-threejs\",\n    '../math/SimplexNoise'\n], function (THREE, SimplexNoise) {\n    'use strict';\n    var LightningStrike = function (rayParameters) {\n        THREE.BufferGeometry.call(this);\n        this.type = 'LightningStrike';\n        rayParameters = rayParameters || {};\n        this.init(LightningStrike.copyParameters(rayParameters, rayParameters));\n        this.createMesh();\n    };\n    LightningStrike.prototype = Object.create(THREE.BufferGeometry.prototype);\n    LightningStrike.prototype.constructor = LightningStrike;\n    LightningStrike.prototype.isLightningStrike = true;\n    LightningStrike.RAY_INITIALIZED = 0;\n    LightningStrike.RAY_UNBORN = 1;\n    LightningStrike.RAY_PROPAGATING = 2;\n    LightningStrike.RAY_STEADY = 3;\n    LightningStrike.RAY_VANISHING = 4;\n    LightningStrike.RAY_EXTINGUISHED = 5;\n    LightningStrike.COS30DEG = Math.cos(30 * Math.PI / 180);\n    LightningStrike.SIN30DEG = Math.sin(30 * Math.PI / 180);\n    LightningStrike.createRandomGenerator = function () {\n        var numSeeds = 2053;\n        var seeds = [];\n        for (var i = 0; i < numSeeds; i++) {\n            seeds.push(Math.random());\n        }\n        var generator = {\n            currentSeed: 0,\n            random: function () {\n                var value = seeds[generator.currentSeed];\n                generator.currentSeed = (generator.currentSeed + 1) % numSeeds;\n                return value;\n            },\n            getSeed: function () {\n                return generator.currentSeed / numSeeds;\n            },\n            setSeed: function (seed) {\n                generator.currentSeed = Math.floor(seed * numSeeds) % numSeeds;\n            }\n        };\n        return generator;\n    };\n    LightningStrike.copyParameters = function (dest, source) {\n        source = source || {};\n        dest = dest || {};\n        var vecCopy = function (v) {\n            if (source === dest) {\n                return v;\n            } else {\n                return v.clone();\n            }\n        };\n        dest.sourceOffset = source.sourceOffset !== undefined ? vecCopy(source.sourceOffset) : new THREE.Vector3(0, 100, 0), dest.destOffset = source.destOffset !== undefined ? vecCopy(source.destOffset) : new THREE.Vector3(0, 0, 0), dest.timeScale = source.timeScale !== undefined ? source.timeScale : 1, dest.roughness = source.roughness !== undefined ? source.roughness : 0.9, dest.straightness = source.straightness !== undefined ? source.straightness : 0.7, dest.up0 = source.up0 !== undefined ? vecCopy(source.up0) : new THREE.Vector3(0, 0, 1);\n        dest.up1 = source.up1 !== undefined ? vecCopy(source.up1) : new THREE.Vector3(0, 0, 1), dest.radius0 = source.radius0 !== undefined ? source.radius0 : 1, dest.radius1 = source.radius1 !== undefined ? source.radius1 : 1, dest.radius0Factor = source.radius0Factor !== undefined ? source.radius0Factor : 0.5, dest.radius1Factor = source.radius1Factor !== undefined ? source.radius1Factor : 0.2, dest.minRadius = source.minRadius !== undefined ? source.minRadius : 0.2, dest.isEternal = source.isEternal !== undefined ? source.isEternal : source.birthTime === undefined || source.deathTime === undefined, dest.birthTime = source.birthTime, dest.deathTime = source.deathTime, dest.propagationTimeFactor = source.propagationTimeFactor !== undefined ? source.propagationTimeFactor : 0.1, dest.vanishingTimeFactor = source.vanishingTimeFactor !== undefined ? source.vanishingTimeFactor : 0.9, dest.subrayPeriod = source.subrayPeriod !== undefined ? source.subrayPeriod : 4, dest.subrayDutyCycle = source.subrayDutyCycle !== undefined ? source.subrayDutyCycle : 0.6;\n        dest.maxIterations = source.maxIterations !== undefined ? source.maxIterations : 9;\n        dest.isStatic = source.isStatic !== undefined ? source.isStatic : false;\n        dest.ramification = source.ramification !== undefined ? source.ramification : 5;\n        dest.maxSubrayRecursion = source.maxSubrayRecursion !== undefined ? source.maxSubrayRecursion : 3;\n        dest.recursionProbability = source.recursionProbability !== undefined ? source.recursionProbability : 0.6;\n        dest.generateUVs = source.generateUVs !== undefined ? source.generateUVs : false;\n        dest.randomGenerator = source.randomGenerator, dest.noiseSeed = source.noiseSeed, dest.onDecideSubrayCreation = source.onDecideSubrayCreation, dest.onSubrayCreation = source.onSubrayCreation;\n        return dest;\n    };\n    LightningStrike.prototype.update = function (time) {\n        if (this.isStatic)\n            return;\n        if (this.rayParameters.isEternal || this.rayParameters.birthTime <= time && time <= this.rayParameters.deathTime) {\n            this.updateMesh(time);\n            if (time < this.subrays[0].endPropagationTime) {\n                this.state = LightningStrike.RAY_PROPAGATING;\n            } else if (time > this.subrays[0].beginVanishingTime) {\n                this.state = LightningStrike.RAY_VANISHING;\n            } else {\n                this.state = LightningStrike.RAY_STEADY;\n            }\n            this.visible = true;\n        } else {\n            this.visible = false;\n            if (time < this.rayParameters.birthTime) {\n                this.state = LightningStrike.RAY_UNBORN;\n            } else {\n                this.state = LightningStrike.RAY_EXTINGUISHED;\n            }\n        }\n    };\n    LightningStrike.prototype.init = function (rayParameters) {\n        this.rayParameters = rayParameters;\n        this.maxIterations = rayParameters.maxIterations !== undefined ? Math.floor(rayParameters.maxIterations) : 9;\n        rayParameters.maxIterations = this.maxIterations;\n        this.isStatic = rayParameters.isStatic !== undefined ? rayParameters.isStatic : false;\n        rayParameters.isStatic = this.isStatic;\n        this.ramification = rayParameters.ramification !== undefined ? Math.floor(rayParameters.ramification) : 5;\n        rayParameters.ramification = this.ramification;\n        this.maxSubrayRecursion = rayParameters.maxSubrayRecursion !== undefined ? Math.floor(rayParameters.maxSubrayRecursion) : 3;\n        rayParameters.maxSubrayRecursion = this.maxSubrayRecursion;\n        this.recursionProbability = rayParameters.recursionProbability !== undefined ? rayParameters.recursionProbability : 0.6;\n        rayParameters.recursionProbability = this.recursionProbability;\n        this.generateUVs = rayParameters.generateUVs !== undefined ? rayParameters.generateUVs : false;\n        rayParameters.generateUVs = this.generateUVs;\n        if (rayParameters.randomGenerator !== undefined) {\n            this.randomGenerator = rayParameters.randomGenerator;\n            this.seedGenerator = rayParameters.randomGenerator;\n            if (rayParameters.noiseSeed !== undefined) {\n                this.seedGenerator.setSeed(rayParameters.noiseSeed);\n            }\n        } else {\n            this.randomGenerator = LightningStrike.createRandomGenerator();\n            this.seedGenerator = Math;\n        }\n        if (rayParameters.onDecideSubrayCreation !== undefined) {\n            this.onDecideSubrayCreation = rayParameters.onDecideSubrayCreation;\n        } else {\n            this.createDefaultSubrayCreationCallbacks();\n            if (rayParameters.onSubrayCreation !== undefined) {\n                this.onSubrayCreation = rayParameters.onSubrayCreation;\n            }\n        }\n        this.state = LightningStrike.RAY_INITIALIZED;\n        this.maxSubrays = Math.ceil(1 + Math.pow(this.ramification, Math.max(0, this.maxSubrayRecursion - 1)));\n        rayParameters.maxSubrays = this.maxSubrays;\n        this.maxRaySegments = 2 * (1 << this.maxIterations);\n        this.subrays = [];\n        for (var i = 0; i < this.maxSubrays; i++) {\n            this.subrays.push(this.createSubray());\n        }\n        this.raySegments = [];\n        for (var i = 0; i < this.maxRaySegments; i++) {\n            this.raySegments.push(this.createSegment());\n        }\n        this.time = 0;\n        this.timeFraction = 0;\n        this.currentSegmentCallback = null;\n        this.currentCreateTriangleVertices = this.generateUVs ? this.createTriangleVerticesWithUVs : this.createTriangleVerticesWithoutUVs;\n        this.numSubrays = 0;\n        this.currentSubray = null;\n        this.currentSegmentIndex = 0;\n        this.isInitialSegment = false;\n        this.subrayProbability = 0;\n        this.currentVertex = 0;\n        this.currentIndex = 0;\n        this.currentCoordinate = 0;\n        this.currentUVCoordinate = 0;\n        this.vertices = null;\n        this.uvs = null;\n        this.indices = null;\n        this.positionAttribute = null;\n        this.uvsAttribute = null;\n        this.simplexX = new SimplexNoise(this.seedGenerator);\n        this.simplexY = new SimplexNoise(this.seedGenerator);\n        this.simplexZ = new SimplexNoise(this.seedGenerator);\n        this.forwards = new THREE.Vector3();\n        this.forwardsFill = new THREE.Vector3();\n        this.side = new THREE.Vector3();\n        this.down = new THREE.Vector3();\n        this.middlePos = new THREE.Vector3();\n        this.middleLinPos = new THREE.Vector3();\n        this.newPos = new THREE.Vector3();\n        this.vPos = new THREE.Vector3();\n        this.cross1 = new THREE.Vector3();\n    };\n    LightningStrike.prototype.createMesh = function () {\n        var maxDrawableSegmentsPerSubRay = 1 << this.maxIterations;\n        var maxVerts = 3 * (maxDrawableSegmentsPerSubRay + 1) * this.maxSubrays;\n        var maxIndices = 18 * maxDrawableSegmentsPerSubRay * this.maxSubrays;\n        this.vertices = new Float32Array(maxVerts * 3);\n        this.indices = new Uint32Array(maxIndices);\n        if (this.generateUVs) {\n            this.uvs = new Float32Array(maxVerts * 2);\n        }\n        this.fillMesh(0);\n        this.setIndex(new THREE.Uint32BufferAttribute(this.indices, 1));\n        this.positionAttribute = new THREE.Float32BufferAttribute(this.vertices, 3);\n        this.setAttribute('position', this.positionAttribute);\n        if (this.generateUVs) {\n            this.uvsAttribute = new THREE.Float32BufferAttribute(new Float32Array(this.uvs), 2);\n            this.setAttribute('uv', this.uvsAttribute);\n        }\n        if (!this.isStatic) {\n            this.index.usage = THREE.DynamicDrawUsage;\n            this.positionAttribute.usage = THREE.DynamicDrawUsage;\n            if (this.generateUVs) {\n                this.uvsAttribute.usage = THREE.DynamicDrawUsage;\n            }\n        }\n        this.vertices = this.positionAttribute.array;\n        this.indices = this.index.array;\n        if (this.generateUVs) {\n            this.uvs = this.uvsAttribute.array;\n        }\n    };\n    LightningStrike.prototype.updateMesh = function (time) {\n        this.fillMesh(time);\n        this.drawRange.count = this.currentIndex;\n        this.index.needsUpdate = true;\n        this.positionAttribute.needsUpdate = true;\n        if (this.generateUVs) {\n            this.uvsAttribute.needsUpdate = true;\n        }\n    };\n    LightningStrike.prototype.fillMesh = function (time) {\n        var scope = this;\n        this.currentVertex = 0;\n        this.currentIndex = 0;\n        this.currentCoordinate = 0;\n        this.currentUVCoordinate = 0;\n        this.fractalRay(time, function fillVertices(segment) {\n            var subray = scope.currentSubray;\n            if (time < subray.birthTime) {\n                return;\n            } else if (this.rayParameters.isEternal && scope.currentSubray.recursion == 0) {\n                scope.createPrism(segment);\n                scope.onDecideSubrayCreation(segment, scope);\n            } else if (time < subray.endPropagationTime) {\n                if (scope.timeFraction >= segment.fraction0 * subray.propagationTimeFactor) {\n                    scope.createPrism(segment);\n                    scope.onDecideSubrayCreation(segment, scope);\n                }\n            } else if (time < subray.beginVanishingTime) {\n                scope.createPrism(segment);\n                scope.onDecideSubrayCreation(segment, scope);\n            } else {\n                if (scope.timeFraction <= subray.vanishingTimeFactor + segment.fraction1 * (1 - subray.vanishingTimeFactor)) {\n                    scope.createPrism(segment);\n                }\n                scope.onDecideSubrayCreation(segment, scope);\n            }\n        });\n    };\n    LightningStrike.prototype.addNewSubray = function () {\n        return this.subrays[this.numSubrays++];\n    };\n    LightningStrike.prototype.initSubray = function (subray, rayParameters) {\n        subray.pos0.copy(rayParameters.sourceOffset);\n        subray.pos1.copy(rayParameters.destOffset);\n        subray.up0.copy(rayParameters.up0);\n        subray.up1.copy(rayParameters.up1);\n        subray.radius0 = rayParameters.radius0;\n        subray.radius1 = rayParameters.radius1;\n        subray.birthTime = rayParameters.birthTime;\n        subray.deathTime = rayParameters.deathTime;\n        subray.timeScale = rayParameters.timeScale;\n        subray.roughness = rayParameters.roughness;\n        subray.straightness = rayParameters.straightness;\n        subray.propagationTimeFactor = rayParameters.propagationTimeFactor;\n        subray.vanishingTimeFactor = rayParameters.vanishingTimeFactor;\n        subray.maxIterations = this.maxIterations;\n        subray.seed = rayParameters.noiseSeed !== undefined ? rayParameters.noiseSeed : 0;\n        subray.recursion = 0;\n    };\n    LightningStrike.prototype.fractalRay = function (time, segmentCallback) {\n        this.time = time;\n        this.currentSegmentCallback = segmentCallback;\n        this.numSubrays = 0;\n        this.initSubray(this.addNewSubray(), this.rayParameters);\n        for (var subrayIndex = 0; subrayIndex < this.numSubrays; subrayIndex++) {\n            var subray = this.subrays[subrayIndex];\n            this.currentSubray = subray;\n            this.randomGenerator.setSeed(subray.seed);\n            subray.endPropagationTime = THREE.MathUtils.lerp(subray.birthTime, subray.deathTime, subray.propagationTimeFactor);\n            subray.beginVanishingTime = THREE.MathUtils.lerp(subray.deathTime, subray.birthTime, 1 - subray.vanishingTimeFactor);\n            var random1 = this.randomGenerator.random;\n            subray.linPos0.set(random1(), random1(), random1()).multiplyScalar(1000);\n            subray.linPos1.set(random1(), random1(), random1()).multiplyScalar(1000);\n            this.timeFraction = (time - subray.birthTime) / (subray.deathTime - subray.birthTime);\n            this.currentSegmentIndex = 0;\n            this.isInitialSegment = true;\n            var segment = this.getNewSegment();\n            segment.iteration = 0;\n            segment.pos0.copy(subray.pos0);\n            segment.pos1.copy(subray.pos1);\n            segment.linPos0.copy(subray.linPos0);\n            segment.linPos1.copy(subray.linPos1);\n            segment.up0.copy(subray.up0);\n            segment.up1.copy(subray.up1);\n            segment.radius0 = subray.radius0;\n            segment.radius1 = subray.radius1;\n            segment.fraction0 = 0;\n            segment.fraction1 = 1;\n            segment.positionVariationFactor = 1 - subray.straightness;\n            this.subrayProbability = this.ramification * Math.pow(this.recursionProbability, subray.recursion) / (1 << subray.maxIterations);\n            this.fractalRayRecursive(segment);\n        }\n        this.currentSegmentCallback = null;\n        this.currentSubray = null;\n    };\n    LightningStrike.prototype.fractalRayRecursive = function (segment) {\n        if (segment.iteration >= this.currentSubray.maxIterations) {\n            this.currentSegmentCallback(segment);\n            return;\n        }\n        this.forwards.subVectors(segment.pos1, segment.pos0);\n        var lForwards = this.forwards.length();\n        if (lForwards < 0.000001) {\n            this.forwards.set(0, 0, 0.01);\n            lForwards = this.forwards.length();\n        }\n        var middleRadius = (segment.radius0 + segment.radius1) * 0.5;\n        var middleFraction = (segment.fraction0 + segment.fraction1) * 0.5;\n        var timeDimension = this.time * this.currentSubray.timeScale * Math.pow(2, segment.iteration);\n        this.middlePos.lerpVectors(segment.pos0, segment.pos1, 0.5);\n        this.middleLinPos.lerpVectors(segment.linPos0, segment.linPos1, 0.5);\n        var p = this.middleLinPos;\n        this.newPos.set(this.simplexX.noise4d(p.x, p.y, p.z, timeDimension), this.simplexY.noise4d(p.x, p.y, p.z, timeDimension), this.simplexZ.noise4d(p.x, p.y, p.z, timeDimension));\n        this.newPos.multiplyScalar(segment.positionVariationFactor * lForwards);\n        this.newPos.add(this.middlePos);\n        var newSegment1 = this.getNewSegment();\n        newSegment1.pos0.copy(segment.pos0);\n        newSegment1.pos1.copy(this.newPos);\n        newSegment1.linPos0.copy(segment.linPos0);\n        newSegment1.linPos1.copy(this.middleLinPos);\n        newSegment1.up0.copy(segment.up0);\n        newSegment1.up1.copy(segment.up1);\n        newSegment1.radius0 = segment.radius0;\n        newSegment1.radius1 = middleRadius;\n        newSegment1.fraction0 = segment.fraction0;\n        newSegment1.fraction1 = middleFraction;\n        newSegment1.positionVariationFactor = segment.positionVariationFactor * this.currentSubray.roughness;\n        newSegment1.iteration = segment.iteration + 1;\n        var newSegment2 = this.getNewSegment();\n        newSegment2.pos0.copy(this.newPos);\n        newSegment2.pos1.copy(segment.pos1);\n        newSegment2.linPos0.copy(this.middleLinPos);\n        newSegment2.linPos1.copy(segment.linPos1);\n        this.cross1.crossVectors(segment.up0, this.forwards.normalize());\n        newSegment2.up0.crossVectors(this.forwards, this.cross1).normalize();\n        newSegment2.up1.copy(segment.up1);\n        newSegment2.radius0 = middleRadius;\n        newSegment2.radius1 = segment.radius1;\n        newSegment2.fraction0 = middleFraction;\n        newSegment2.fraction1 = segment.fraction1;\n        newSegment2.positionVariationFactor = segment.positionVariationFactor * this.currentSubray.roughness;\n        newSegment2.iteration = segment.iteration + 1;\n        this.fractalRayRecursive(newSegment1);\n        this.fractalRayRecursive(newSegment2);\n    };\n    LightningStrike.prototype.createPrism = function (segment) {\n        this.forwardsFill.subVectors(segment.pos1, segment.pos0).normalize();\n        if (this.isInitialSegment) {\n            this.currentCreateTriangleVertices(segment.pos0, segment.up0, this.forwardsFill, segment.radius0, 0);\n            this.isInitialSegment = false;\n        }\n        this.currentCreateTriangleVertices(segment.pos1, segment.up0, this.forwardsFill, segment.radius1, segment.fraction1);\n        this.createPrismFaces();\n    };\n    LightningStrike.prototype.createTriangleVerticesWithoutUVs = function (pos, up, forwards, radius) {\n        this.side.crossVectors(up, forwards).multiplyScalar(radius * LightningStrike.COS30DEG);\n        this.down.copy(up).multiplyScalar(-radius * LightningStrike.SIN30DEG);\n        var p = this.vPos;\n        var v = this.vertices;\n        p.copy(pos).sub(this.side).add(this.down);\n        v[this.currentCoordinate++] = p.x;\n        v[this.currentCoordinate++] = p.y;\n        v[this.currentCoordinate++] = p.z;\n        p.copy(pos).add(this.side).add(this.down);\n        v[this.currentCoordinate++] = p.x;\n        v[this.currentCoordinate++] = p.y;\n        v[this.currentCoordinate++] = p.z;\n        p.copy(up).multiplyScalar(radius).add(pos);\n        v[this.currentCoordinate++] = p.x;\n        v[this.currentCoordinate++] = p.y;\n        v[this.currentCoordinate++] = p.z;\n        this.currentVertex += 3;\n    };\n    LightningStrike.prototype.createTriangleVerticesWithUVs = function (pos, up, forwards, radius, u) {\n        this.side.crossVectors(up, forwards).multiplyScalar(radius * LightningStrike.COS30DEG);\n        this.down.copy(up).multiplyScalar(-radius * LightningStrike.SIN30DEG);\n        var p = this.vPos;\n        var v = this.vertices;\n        var uv = this.uvs;\n        p.copy(pos).sub(this.side).add(this.down);\n        v[this.currentCoordinate++] = p.x;\n        v[this.currentCoordinate++] = p.y;\n        v[this.currentCoordinate++] = p.z;\n        uv[this.currentUVCoordinate++] = u;\n        uv[this.currentUVCoordinate++] = 0;\n        p.copy(pos).add(this.side).add(this.down);\n        v[this.currentCoordinate++] = p.x;\n        v[this.currentCoordinate++] = p.y;\n        v[this.currentCoordinate++] = p.z;\n        uv[this.currentUVCoordinate++] = u;\n        uv[this.currentUVCoordinate++] = 0.5;\n        p.copy(up).multiplyScalar(radius).add(pos);\n        v[this.currentCoordinate++] = p.x;\n        v[this.currentCoordinate++] = p.y;\n        v[this.currentCoordinate++] = p.z;\n        uv[this.currentUVCoordinate++] = u;\n        uv[this.currentUVCoordinate++] = 1;\n        this.currentVertex += 3;\n    };\n    LightningStrike.prototype.createPrismFaces = function (vertex) {\n        var indices = this.indices;\n        var vertex = this.currentVertex - 6;\n        indices[this.currentIndex++] = vertex + 1;\n        indices[this.currentIndex++] = vertex + 2;\n        indices[this.currentIndex++] = vertex + 5;\n        indices[this.currentIndex++] = vertex + 1;\n        indices[this.currentIndex++] = vertex + 5;\n        indices[this.currentIndex++] = vertex + 4;\n        indices[this.currentIndex++] = vertex + 0;\n        indices[this.currentIndex++] = vertex + 1;\n        indices[this.currentIndex++] = vertex + 4;\n        indices[this.currentIndex++] = vertex + 0;\n        indices[this.currentIndex++] = vertex + 4;\n        indices[this.currentIndex++] = vertex + 3;\n        indices[this.currentIndex++] = vertex + 2;\n        indices[this.currentIndex++] = vertex + 0;\n        indices[this.currentIndex++] = vertex + 3;\n        indices[this.currentIndex++] = vertex + 2;\n        indices[this.currentIndex++] = vertex + 3;\n        indices[this.currentIndex++] = vertex + 5;\n    };\n    LightningStrike.prototype.createDefaultSubrayCreationCallbacks = function () {\n        var random1 = this.randomGenerator.random;\n        this.onDecideSubrayCreation = function (segment, lightningStrike) {\n            var subray = lightningStrike.currentSubray;\n            var period = lightningStrike.rayParameters.subrayPeriod;\n            var dutyCycle = lightningStrike.rayParameters.subrayDutyCycle;\n            var phase0 = lightningStrike.rayParameters.isEternal && subray.recursion == 0 ? -random1() * period : THREE.MathUtils.lerp(subray.birthTime, subray.endPropagationTime, segment.fraction0) - random1() * period;\n            var phase = lightningStrike.time - phase0;\n            var currentCycle = Math.floor(phase / period);\n            var childSubraySeed = random1() * (currentCycle + 1);\n            var isActive = phase % period <= dutyCycle * period;\n            var probability = 0;\n            if (isActive) {\n                probability = lightningStrike.subrayProbability;\n            }\n            if (subray.recursion < lightningStrike.maxSubrayRecursion && lightningStrike.numSubrays < lightningStrike.maxSubrays && random1() < probability) {\n                var childSubray = lightningStrike.addNewSubray();\n                var parentSeed = lightningStrike.randomGenerator.getSeed();\n                childSubray.seed = childSubraySeed;\n                lightningStrike.randomGenerator.setSeed(childSubraySeed);\n                childSubray.recursion = subray.recursion + 1;\n                childSubray.maxIterations = Math.max(1, subray.maxIterations - 1);\n                childSubray.linPos0.set(random1(), random1(), random1()).multiplyScalar(1000);\n                childSubray.linPos1.set(random1(), random1(), random1()).multiplyScalar(1000);\n                childSubray.up0.copy(subray.up0);\n                childSubray.up1.copy(subray.up1);\n                childSubray.radius0 = segment.radius0 * lightningStrike.rayParameters.radius0Factor;\n                childSubray.radius1 = Math.min(lightningStrike.rayParameters.minRadius, segment.radius1 * lightningStrike.rayParameters.radius1Factor);\n                childSubray.birthTime = phase0 + currentCycle * period;\n                childSubray.deathTime = childSubray.birthTime + period * dutyCycle;\n                if (!lightningStrike.rayParameters.isEternal && subray.recursion == 0) {\n                    childSubray.birthTime = Math.max(childSubray.birthTime, subray.birthTime);\n                    childSubray.deathTime = Math.min(childSubray.deathTime, subray.deathTime);\n                }\n                childSubray.timeScale = subray.timeScale * 2;\n                childSubray.roughness = subray.roughness;\n                childSubray.straightness = subray.straightness;\n                childSubray.propagationTimeFactor = subray.propagationTimeFactor;\n                childSubray.vanishingTimeFactor = subray.vanishingTimeFactor;\n                lightningStrike.onSubrayCreation(segment, subray, childSubray, lightningStrike);\n                lightningStrike.randomGenerator.setSeed(parentSeed);\n            }\n        };\n        var vec1Pos = new THREE.Vector3();\n        var vec2Forward = new THREE.Vector3();\n        var vec3Side = new THREE.Vector3();\n        var vec4Up = new THREE.Vector3();\n        this.onSubrayCreation = function (segment, parentSubray, childSubray, lightningStrike) {\n            lightningStrike.subrayCylinderPosition(segment, parentSubray, childSubray, 0.5, 0.6, 0.2);\n        };\n        this.subrayConePosition = function (segment, parentSubray, childSubray, heightFactor, sideWidthFactor, minSideWidthFactor) {\n            childSubray.pos0.copy(segment.pos0);\n            vec1Pos.subVectors(parentSubray.pos1, parentSubray.pos0);\n            vec2Forward.copy(vec1Pos).normalize();\n            vec1Pos.multiplyScalar(segment.fraction0 + (1 - segment.fraction0) * (random1() * heightFactor));\n            var length = vec1Pos.length();\n            vec3Side.crossVectors(parentSubray.up0, vec2Forward);\n            var angle = 2 * Math.PI * random1();\n            vec3Side.multiplyScalar(Math.cos(angle));\n            vec4Up.copy(parentSubray.up0).multiplyScalar(Math.sin(angle));\n            childSubray.pos1.copy(vec3Side).add(vec4Up).multiplyScalar(length * sideWidthFactor * (minSideWidthFactor + random1() * (1 - minSideWidthFactor))).add(vec1Pos).add(parentSubray.pos0);\n        };\n        this.subrayCylinderPosition = function (segment, parentSubray, childSubray, heightFactor, sideWidthFactor, minSideWidthFactor) {\n            childSubray.pos0.copy(segment.pos0);\n            vec1Pos.subVectors(parentSubray.pos1, parentSubray.pos0);\n            vec2Forward.copy(vec1Pos).normalize();\n            vec1Pos.multiplyScalar(segment.fraction0 + (1 - segment.fraction0) * ((2 * random1() - 1) * heightFactor));\n            var length = vec1Pos.length();\n            vec3Side.crossVectors(parentSubray.up0, vec2Forward);\n            var angle = 2 * Math.PI * random1();\n            vec3Side.multiplyScalar(Math.cos(angle));\n            vec4Up.copy(parentSubray.up0).multiplyScalar(Math.sin(angle));\n            childSubray.pos1.copy(vec3Side).add(vec4Up).multiplyScalar(length * sideWidthFactor * (minSideWidthFactor + random1() * (1 - minSideWidthFactor))).add(vec1Pos).add(parentSubray.pos0);\n        };\n    };\n    LightningStrike.prototype.createSubray = function () {\n        return {\n            seed: 0,\n            maxIterations: 0,\n            recursion: 0,\n            pos0: new THREE.Vector3(),\n            pos1: new THREE.Vector3(),\n            linPos0: new THREE.Vector3(),\n            linPos1: new THREE.Vector3(),\n            up0: new THREE.Vector3(),\n            up1: new THREE.Vector3(),\n            radius0: 0,\n            radius1: 0,\n            birthTime: 0,\n            deathTime: 0,\n            timeScale: 0,\n            roughness: 0,\n            straightness: 0,\n            propagationTimeFactor: 0,\n            vanishingTimeFactor: 0,\n            endPropagationTime: 0,\n            beginVanishingTime: 0\n        };\n    };\n    LightningStrike.prototype.createSegment = function () {\n        return {\n            iteration: 0,\n            pos0: new THREE.Vector3(),\n            pos1: new THREE.Vector3(),\n            linPos0: new THREE.Vector3(),\n            linPos1: new THREE.Vector3(),\n            up0: new THREE.Vector3(),\n            up1: new THREE.Vector3(),\n            radius0: 0,\n            radius1: 0,\n            fraction0: 0,\n            fraction1: 0,\n            positionVariationFactor: 0\n        };\n    };\n    LightningStrike.prototype.getNewSegment = function () {\n        return this.raySegments[this.currentSegmentIndex++];\n    };\n    LightningStrike.prototype.copy = function (source) {\n        THREE.BufferGeometry.prototype.copy.call(this, source);\n        this.init(LightningStrike.copyParameters({}, source.rayParameters));\n        return this;\n    };\n    LightningStrike.prototype.clone = function () {\n        return new this.constructor(LightningStrike.copyParameters({}, this.rayParameters));\n    };\n    return LightningStrike;\n});"]}