{"version":3,"sources":["nodes/inputs/RTTNode.js"],"names":["define","THREE","NodeBuilder","NodeMaterial","TextureNode","RTTNode","width","height","input","options","this","clear","undefined","renderTarget","WebGLRenderTarget","material","camera","OrthographicCamera","scene","Scene","quad","Mesh","PlaneBufferGeometry","frustumCulled","add","render","call","texture","prototype","Object","create","constructor","nodeType","build","builder","output","uuid","rttBuilder","nodes","updaters","fragment","value","updateFramesaveTo","frame","saveTo","saveToCurrent","saveToMaterial","dispose","saveToScene","renderer","setRenderTarget","updateFrame","uniforms","renderTexture","console","warn","copy","source","toJSON","meta","data","getJSONNode"],"mappings":"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","file":"../../../nodes/inputs/RTTNode.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    '../core/NodeBuilder',\r\n    '../materials/NodeMaterial',\r\n    './TextureNode'\r\n], function (\r\n    THREE, \r\n    NodeBuilder, \r\n    NodeMaterial, \r\n    TextureNode\r\n) {\r\n    'use strict';\r\n    function RTTNode(width, height, input, options) {\r\n        options = options || {};\r\n        this.input = input;\r\n        this.clear = options.clear !== undefined ? options.clear : true;\r\n        this.renderTarget = new THREE.WebGLRenderTarget(width, height, options);\r\n        this.material = new NodeMaterial();\r\n        this.camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);\r\n        this.scene = new THREE.Scene();\r\n        this.quad = new THREE.Mesh(new THREE.PlaneBufferGeometry(2, 2), this.material);\r\n        this.quad.frustumCulled = false;\r\n        this.scene.add(this.quad);\r\n        this.render = true;\r\n        TextureNode.call(this, this.renderTarget.texture);\r\n    }\r\n    RTTNode.prototype = Object.create(TextureNode.prototype);\r\n    RTTNode.prototype.constructor = RTTNode;\r\n    RTTNode.prototype.nodeType = 'RTT';\r\n    RTTNode.prototype.build = function (builder, output, uuid) {\r\n        var rttBuilder = new NodeBuilder();\r\n        rttBuilder.nodes = builder.nodes;\r\n        rttBuilder.updaters = builder.updaters;\r\n        this.material.fragment.value = this.input;\r\n        this.material.build({ builder: rttBuilder });\r\n        return TextureNode.prototype.build.call(this, builder, output, uuid);\r\n    };\r\n    RTTNode.prototype.updateFramesaveTo = function (frame) {\r\n        this.saveTo.render = false;\r\n        if (this.saveTo !== this.saveToCurrent) {\r\n            if (this.saveToMaterial)\r\n                this.saveToMaterial.dispose();\r\n            var material = new NodeMaterial();\r\n            material.fragment.value = this;\r\n            material.build();\r\n            var scene = new THREE.Scene();\r\n            var quad = new THREE.Mesh(new THREE.PlaneBufferGeometry(2, 2), material);\r\n            quad.frustumCulled = false;\r\n            scene.add(quad);\r\n            this.saveToScene = scene;\r\n            this.saveToMaterial = material;\r\n        }\r\n        this.saveToCurrent = this.saveTo;\r\n        frame.renderer.setRenderTarget(this.saveTo.renderTarget);\r\n        if (this.saveTo.clear)\r\n            frame.renderer.clear();\r\n        frame.renderer.render(this.saveToScene, this.camera);\r\n    };\r\n    RTTNode.prototype.updateFrame = function (frame) {\r\n        if (frame.renderer) {\r\n            if (this.saveTo && this.saveTo.render === false) {\r\n                this.updateFramesaveTo(frame);\r\n            }\r\n            if (this.render) {\r\n                if (this.material.uniforms.renderTexture) {\r\n                    this.material.uniforms.renderTexture.value = frame.renderTexture;\r\n                }\r\n                frame.renderer.setRenderTarget(this.renderTarget);\r\n                if (this.clear)\r\n                    frame.renderer.clear();\r\n                frame.renderer.render(this.scene, this.camera);\r\n            }\r\n            if (this.saveTo && this.saveTo.render === true) {\r\n                this.updateFramesaveTo(frame);\r\n            }\r\n        } else {\r\n            console.warn('RTTNode need a renderer in NodeFrame');\r\n        }\r\n    };\r\n    RTTNode.prototype.copy = function (source) {\r\n        TextureNode.prototype.copy.call(this, source);\r\n        this.saveTo = source.saveTo;\r\n        return this;\r\n    };\r\n    RTTNode.prototype.toJSON = function (meta) {\r\n        var data = this.getJSONNode(meta);\r\n        if (!data) {\r\n            data = TextureNode.prototype.toJSON.call(this, meta);\r\n            if (this.saveTo)\r\n                data.saveTo = this.saveTo.toJSON(meta).uuid;\r\n        }\r\n        return data;\r\n    };\r\n    return RTTNode;\r\n});"]}