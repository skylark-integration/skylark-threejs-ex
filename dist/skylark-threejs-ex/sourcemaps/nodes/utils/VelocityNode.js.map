{"version":3,"sources":["nodes/utils/VelocityNode.js"],"names":["define","THREE","Vector3Node","VelocityNode","target","params","call","this","velocity","Vector3","setTarget","setParams","prototype","Object","create","constructor","nodeType","getReadonly","type","moment","speed","springVelocity","lastVelocity","position","oldPosition","getWorldPosition","clone","updateFrameVelocity","subVectors","copy","updateFrame","frame","deltaFps","delta","fps","spring","Math","pow","damping","multiplyScalar","exp","add","value","source","toJSON","meta","data","getJSONNode","createJSONNode","uuid","JSON","parse","stringify"],"mappings":";;;;;;;AAAAA,QACI,kBACA,yBACD,SACCC,EACAC,GAEA,aACA,SAASC,EAAaC,EAAQC,GAC1BH,EAAYI,KAAKC,MACjBA,KAAKF,UACLE,KAAKC,SAAW,IAAIP,EAAMQ,QAC1BF,KAAKG,UAAUN,GACfG,KAAKI,UAAUN,GAmFnB,OAjFAF,EAAaS,UAAYC,OAAOC,OAAOZ,EAAYU,WACnDT,EAAaS,UAAUG,YAAcZ,EACrCA,EAAaS,UAAUI,SAAW,WAClCb,EAAaS,UAAUK,YAAc,WACjC,OAAO,GAEXd,EAAaS,UAAUD,UAAY,SAAUN,GACzC,OAAQE,KAAKF,OAAOa,MACpB,IAAK,iBACMX,KAAKY,cACLZ,KAAKa,aACLb,KAAKc,sBACLd,KAAKe,aAIhB,OADAf,KAAKF,OAASA,MACNE,KAAKF,OAAOa,MACpB,IAAK,UACDX,KAAKY,OAAS,IAAIlB,EAAMQ,QACxBF,KAAKa,MAAQ,IAAInB,EAAMQ,QACvBF,KAAKc,eAAiB,IAAIpB,EAAMQ,QAChCF,KAAKe,aAAe,IAAIrB,EAAMQ,UAItCN,EAAaS,UAAUF,UAAY,SAAUN,GACrCG,KAAKH,gBACEG,KAAKgB,gBACLhB,KAAKiB,aAEhBjB,KAAKH,OAASA,EACVA,IACAG,KAAKgB,SAAWnB,EAAOqB,iBAAiBlB,KAAKgB,UAAY,IAAItB,EAAMQ,SACnEF,KAAKiB,YAAcjB,KAAKgB,SAASG,UAGzCvB,EAAaS,UAAUe,oBAAsB,WACrCpB,KAAKH,SACLG,KAAKgB,SAAWhB,KAAKH,OAAOqB,iBAAiBlB,KAAKgB,UAAY,IAAItB,EAAMQ,SACxEF,KAAKC,SAASoB,WAAWrB,KAAKgB,SAAUhB,KAAKiB,aAC7CjB,KAAKiB,YAAYK,KAAKtB,KAAKgB,YAGnCpB,EAAaS,UAAUkB,YAAc,SAAUC,GAE3C,OADAxB,KAAKoB,oBAAoBI,GACjBxB,KAAKF,OAAOa,MACpB,IAAK,UACD,IAAIc,EAAWD,EAAME,OAAS1B,KAAKF,OAAO6B,KAAO,IAC7CC,EAASC,KAAKC,IAAI9B,KAAKF,OAAO8B,OAAQH,GAAWM,EAAUF,KAAKC,IAAI9B,KAAKF,OAAOiC,QAASN,GAC7FzB,KAAKC,SAAS+B,eAAeH,KAAKI,KAAKjC,KAAKF,OAAOiC,QAAUN,IAC7DzB,KAAKC,SAASiC,IAAIlC,KAAKc,gBACvBd,KAAKC,SAASiC,IAAIlC,KAAKa,MAAMmB,eAAeD,GAASC,eAAe,EAAIJ,IACxE5B,KAAKa,MAAMQ,WAAWrB,KAAKC,SAAUD,KAAKe,cAC1Cf,KAAKc,eAAeoB,IAAIlC,KAAKa,OAC7Bb,KAAKc,eAAekB,eAAeJ,GACnC5B,KAAKY,OAAOsB,IAAIlC,KAAKc,gBACrBd,KAAKY,OAAOoB,eAAeD,GAC3B/B,KAAKe,aAAaO,KAAKtB,KAAKC,UAC5BD,KAAKmC,MAAMb,KAAKtB,KAAKY,QACrB,MACJ,QACIZ,KAAKmC,MAAMb,KAAKtB,KAAKC,YAG7BL,EAAaS,UAAUiB,KAAO,SAAUc,GAKpC,OAJAzC,EAAYU,UAAUiB,KAAKvB,KAAKC,KAAMoC,GAClCA,EAAOvC,QACPG,KAAKG,UAAUiC,EAAOvC,QAC1BG,KAAKI,UAAUgC,EAAOtC,QACfE,MAEXJ,EAAaS,UAAUgC,OAAS,SAAUC,GACtC,IAAIC,EAAOvC,KAAKwC,YAAYF,GAO5B,OANKC,IACDA,EAAOvC,KAAKyC,eAAeH,GACvBtC,KAAKH,SACL0C,EAAK1C,OAASG,KAAKH,OAAO6C,MAC9BH,EAAKzC,OAAS6C,KAAKC,MAAMD,KAAKE,UAAU7C,KAAKF,UAE1CyC,GAEJ3C","file":"../../../nodes/utils/VelocityNode.js","sourcesContent":["define([\n    \"skylark-threejs\",\n    '../inputs/Vector3Node'\n], function (\n    THREE, \n    Vector3Node\n) {\n    'use strict';\n    function VelocityNode(target, params) {\n        Vector3Node.call(this);\n        this.params = {};\n        this.velocity = new THREE.Vector3();\n        this.setTarget(target);\n        this.setParams(params);\n    }\n    VelocityNode.prototype = Object.create(Vector3Node.prototype);\n    VelocityNode.prototype.constructor = VelocityNode;\n    VelocityNode.prototype.nodeType = 'Velocity';\n    VelocityNode.prototype.getReadonly = function () {\n        return false;\n    };\n    VelocityNode.prototype.setParams = function (params) {\n        switch (this.params.type) {\n        case 'elastic':\n            delete this.moment;\n            delete this.speed;\n            delete this.springVelocity;\n            delete this.lastVelocity;\n            break;\n        }\n        this.params = params || {};\n        switch (this.params.type) {\n        case 'elastic':\n            this.moment = new THREE.Vector3();\n            this.speed = new THREE.Vector3();\n            this.springVelocity = new THREE.Vector3();\n            this.lastVelocity = new THREE.Vector3();\n            break;\n        }\n    };\n    VelocityNode.prototype.setTarget = function (target) {\n        if (this.target) {\n            delete this.position;\n            delete this.oldPosition;\n        }\n        this.target = target;\n        if (target) {\n            this.position = target.getWorldPosition(this.position || new THREE.Vector3());\n            this.oldPosition = this.position.clone();\n        }\n    };\n    VelocityNode.prototype.updateFrameVelocity = function () {\n        if (this.target) {\n            this.position = this.target.getWorldPosition(this.position || new THREE.Vector3());\n            this.velocity.subVectors(this.position, this.oldPosition);\n            this.oldPosition.copy(this.position);\n        }\n    };\n    VelocityNode.prototype.updateFrame = function (frame) {\n        this.updateFrameVelocity(frame);\n        switch (this.params.type) {\n        case 'elastic':\n            var deltaFps = frame.delta * (this.params.fps || 60);\n            var spring = Math.pow(this.params.spring, deltaFps), damping = Math.pow(this.params.damping, deltaFps);\n            this.velocity.multiplyScalar(Math.exp(-this.params.damping * deltaFps));\n            this.velocity.add(this.springVelocity);\n            this.velocity.add(this.speed.multiplyScalar(damping).multiplyScalar(1 - spring));\n            this.speed.subVectors(this.velocity, this.lastVelocity);\n            this.springVelocity.add(this.speed);\n            this.springVelocity.multiplyScalar(spring);\n            this.moment.add(this.springVelocity);\n            this.moment.multiplyScalar(damping);\n            this.lastVelocity.copy(this.velocity);\n            this.value.copy(this.moment);\n            break;\n        default:\n            this.value.copy(this.velocity);\n        }\n    };\n    VelocityNode.prototype.copy = function (source) {\n        Vector3Node.prototype.copy.call(this, source);\n        if (source.target)\n            this.setTarget(source.target);\n        this.setParams(source.params);\n        return this;\n    };\n    VelocityNode.prototype.toJSON = function (meta) {\n        var data = this.getJSONNode(meta);\n        if (!data) {\n            data = this.createJSONNode(meta);\n            if (this.target)\n                data.target = this.target.uuid;\n            data.params = JSON.parse(JSON.stringify(this.params));\n        }\n        return data;\n    };\n    return VelocityNode;\n});"]}