{"version":3,"sources":["nodes/materials/nodes/PhongNode.js"],"names":["define","THREE","Node","ColorNode","FloatNode","PhongNode","call","this","color","specular","shininess","prototype","Object","create","constructor","nodeType","build","builder","code","requires","lights","isShader","position","analyzeAndFlow","cache","undefined","mergeUniform","UniformsUtils","merge","UniformsLib","fog","addParsCode","join","output","push","result","mask","analyze","slot","alpha","normal","light","ao","ambient","shadow","emissive","environment","environmentAlpha","flow","transparent","copy","source","toJSON","meta","data","getJSONNode","createJSONNode","uuid"],"mappings":"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","file":"../../../../nodes/materials/nodes/PhongNode.js","sourcesContent":["define([\r\n    'skylark-threejs',\r\n    '../../core/Node',\r\n    '../../inputs/ColorNode',\r\n    '../../inputs/FloatNode'\r\n], function (\r\n    THREE, \r\n    Node, \r\n    ColorNode, \r\n    FloatNode\r\n) {\r\n    'use strict';\r\n    function PhongNode() {\r\n        Node.call(this);\r\n        this.color = new ColorNode(15658734);\r\n        this.specular = new ColorNode(1118481);\r\n        this.shininess = new FloatNode(30);\r\n    }\r\n    PhongNode.prototype = Object.create(Node.prototype);\r\n    PhongNode.prototype.constructor = PhongNode;\r\n    PhongNode.prototype.nodeType = 'Phong';\r\n    PhongNode.prototype.build = function (builder) {\r\n        var code;\r\n        builder.define('PHONG');\r\n        builder.requires.lights = true;\r\n        if (builder.isShader('vertex')) {\r\n            var position = this.position ? this.position.analyzeAndFlow(builder, 'v3', { cache: 'position' }) : undefined;\r\n            builder.mergeUniform(THREE.UniformsUtils.merge([\r\n                THREE.UniformsLib.fog,\r\n                THREE.UniformsLib.lights\r\n            ]));\r\n            builder.addParsCode([\r\n                'varying vec3 vViewPosition;',\r\n                '#ifndef FLAT_SHADED',\r\n                '\\tvarying vec3 vNormal;',\r\n                '#endif',\r\n                '#include <fog_pars_vertex>',\r\n                '#include <morphtarget_pars_vertex>',\r\n                '#include <skinning_pars_vertex>',\r\n                '#include <shadowmap_pars_vertex>',\r\n                '#include <logdepthbuf_pars_vertex>',\r\n                '#include <clipping_planes_pars_vertex>'\r\n            ].join('\\n'));\r\n            var output = [\r\n                '#include <beginnormal_vertex>',\r\n                '#include <morphnormal_vertex>',\r\n                '#include <skinbase_vertex>',\r\n                '#include <skinnormal_vertex>',\r\n                '#include <defaultnormal_vertex>',\r\n                '#ifndef FLAT_SHADED',\r\n                '\\tvNormal = normalize( transformedNormal );',\r\n                '#endif',\r\n                '#include <begin_vertex>'\r\n            ];\r\n            if (position) {\r\n                output.push(position.code, position.result ? 'transformed = ' + position.result + ';' : '');\r\n            }\r\n            output.push('\\t#include <morphtarget_vertex>', '\\t#include <skinning_vertex>', '\\t#include <project_vertex>', '\\t#include <fog_vertex>', '\\t#include <logdepthbuf_vertex>', '\\t#include <clipping_planes_vertex>', '\\tvViewPosition = - mvPosition.xyz;', '\\t#include <worldpos_vertex>', '\\t#include <shadowmap_vertex>', '\\t#include <fog_vertex>');\r\n            code = output.join('\\n');\r\n        } else {\r\n            if (this.mask)\r\n                this.mask.analyze(builder);\r\n            this.color.analyze(builder, { slot: 'color' });\r\n            this.specular.analyze(builder);\r\n            this.shininess.analyze(builder);\r\n            if (this.alpha)\r\n                this.alpha.analyze(builder);\r\n            if (this.normal)\r\n                this.normal.analyze(builder);\r\n            if (this.light)\r\n                this.light.analyze(builder, { cache: 'light' });\r\n            if (this.ao)\r\n                this.ao.analyze(builder);\r\n            if (this.ambient)\r\n                this.ambient.analyze(builder);\r\n            if (this.shadow)\r\n                this.shadow.analyze(builder);\r\n            if (this.emissive)\r\n                this.emissive.analyze(builder, { slot: 'emissive' });\r\n            if (this.environment)\r\n                this.environment.analyze(builder, { slot: 'environment' });\r\n            if (this.environmentAlpha && this.environment)\r\n                this.environmentAlpha.analyze(builder);\r\n            var mask = this.mask ? this.mask.flow(builder, 'b') : undefined;\r\n            var color = this.color.flow(builder, 'c', { slot: 'color' });\r\n            var specular = this.specular.flow(builder, 'c');\r\n            var shininess = this.shininess.flow(builder, 'f');\r\n            var alpha = this.alpha ? this.alpha.flow(builder, 'f') : undefined;\r\n            var normal = this.normal ? this.normal.flow(builder, 'v3') : undefined;\r\n            var light = this.light ? this.light.flow(builder, 'v3', { cache: 'light' }) : undefined;\r\n            var ao = this.ao ? this.ao.flow(builder, 'f') : undefined;\r\n            var ambient = this.ambient ? this.ambient.flow(builder, 'c') : undefined;\r\n            var shadow = this.shadow ? this.shadow.flow(builder, 'c') : undefined;\r\n            var emissive = this.emissive ? this.emissive.flow(builder, 'c', { slot: 'emissive' }) : undefined;\r\n            var environment = this.environment ? this.environment.flow(builder, 'c', { slot: 'environment' }) : undefined;\r\n            var environmentAlpha = this.environmentAlpha && this.environment ? this.environmentAlpha.flow(builder, 'f') : undefined;\r\n            builder.requires.transparent = alpha !== undefined;\r\n            builder.addParsCode([\r\n                '#include <fog_pars_fragment>',\r\n                '#include <bsdfs>',\r\n                '#include <lights_pars_begin>',\r\n                '#include <lights_phong_pars_fragment>',\r\n                '#include <shadowmap_pars_fragment>',\r\n                '#include <logdepthbuf_pars_fragment>'\r\n            ].join('\\n'));\r\n            var output = [\r\n                '#include <normal_fragment_begin>',\r\n                '\\tBlinnPhongMaterial material;'\r\n            ];\r\n            if (mask) {\r\n                output.push(mask.code, 'if ( ! ' + mask.result + ' ) discard;');\r\n            }\r\n            output.push(color.code, '\\tvec3 diffuseColor = ' + color.result + ';', '\\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );', '#include <logdepthbuf_fragment>', specular.code, '\\tvec3 specular = ' + specular.result + ';', shininess.code, '\\tfloat shininess = max( 0.0001, ' + shininess.result + ' );', '\\tfloat specularStrength = 1.0;');\r\n            if (alpha) {\r\n                output.push(alpha.code, '#ifdef ALPHATEST', 'if ( ' + alpha.result + ' <= ALPHATEST ) discard;', '#endif');\r\n            }\r\n            if (normal) {\r\n                output.push(normal.code, 'normal = ' + normal.result + ';');\r\n            }\r\n            output.push('material.diffuseColor = ' + (light ? 'vec3( 1.0 )' : 'diffuseColor') + ';');\r\n            output.push('material.specularColor = specular;', 'material.specularShininess = shininess;', 'material.specularStrength = specularStrength;', '#include <lights_fragment_begin>', '#include <lights_fragment_end>');\r\n            if (light) {\r\n                output.push(light.code, 'reflectedLight.directDiffuse = ' + light.result + ';');\r\n                output.push('reflectedLight.directDiffuse *= diffuseColor;', 'reflectedLight.indirectDiffuse *= diffuseColor;');\r\n            }\r\n            if (ao) {\r\n                output.push(ao.code, 'reflectedLight.indirectDiffuse *= ' + ao.result + ';');\r\n            }\r\n            if (ambient) {\r\n                output.push(ambient.code, 'reflectedLight.indirectDiffuse += ' + ambient.result + ';');\r\n            }\r\n            if (shadow) {\r\n                output.push(shadow.code, 'reflectedLight.directDiffuse *= ' + shadow.result + ';', 'reflectedLight.directSpecular *= ' + shadow.result + ';');\r\n            }\r\n            if (emissive) {\r\n                output.push(emissive.code, 'reflectedLight.directDiffuse += ' + emissive.result + ';');\r\n            }\r\n            output.push('vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular;');\r\n            if (environment) {\r\n                output.push(environment.code);\r\n                if (environmentAlpha) {\r\n                    output.push(environmentAlpha.code, 'outgoingLight = mix( outgoingLight, ' + environment.result + ', ' + environmentAlpha.result + ' );');\r\n                } else {\r\n                    output.push('outgoingLight = ' + environment.result + ';');\r\n                }\r\n            }\r\n            if (alpha) {\r\n                output.push('gl_FragColor = vec4( outgoingLight, ' + alpha.result + ' );');\r\n            } else {\r\n                output.push('gl_FragColor = vec4( outgoingLight, 1.0 );');\r\n            }\r\n            output.push('#include <tonemapping_fragment>', '#include <encodings_fragment>', '#include <fog_fragment>', '#include <premultiplied_alpha_fragment>');\r\n            code = output.join('\\n');\r\n        }\r\n        return code;\r\n    };\r\n    PhongNode.prototype.copy = function (source) {\r\n        Node.prototype.copy.call(this, source);\r\n        if (source.position)\r\n            this.position = source.position;\r\n        this.color = source.color;\r\n        this.specular = source.specular;\r\n        this.shininess = source.shininess;\r\n        if (source.mask)\r\n            this.mask = source.mask;\r\n        if (source.alpha)\r\n            this.alpha = source.alpha;\r\n        if (source.normal)\r\n            this.normal = source.normal;\r\n        if (source.light)\r\n            this.light = source.light;\r\n        if (source.shadow)\r\n            this.shadow = source.shadow;\r\n        if (source.ao)\r\n            this.ao = source.ao;\r\n        if (source.emissive)\r\n            this.emissive = source.emissive;\r\n        if (source.ambient)\r\n            this.ambient = source.ambient;\r\n        if (source.environment)\r\n            this.environment = source.environment;\r\n        if (source.environmentAlpha)\r\n            this.environmentAlpha = source.environmentAlpha;\r\n        return this;\r\n    };\r\n    PhongNode.prototype.toJSON = function (meta) {\r\n        var data = this.getJSONNode(meta);\r\n        if (!data) {\r\n            data = this.createJSONNode(meta);\r\n            if (this.position)\r\n                data.position = this.position.toJSON(meta).uuid;\r\n            data.color = this.color.toJSON(meta).uuid;\r\n            data.specular = this.specular.toJSON(meta).uuid;\r\n            data.shininess = this.shininess.toJSON(meta).uuid;\r\n            if (this.mask)\r\n                data.mask = this.mask.toJSON(meta).uuid;\r\n            if (this.alpha)\r\n                data.alpha = this.alpha.toJSON(meta).uuid;\r\n            if (this.normal)\r\n                data.normal = this.normal.toJSON(meta).uuid;\r\n            if (this.light)\r\n                data.light = this.light.toJSON(meta).uuid;\r\n            if (this.ao)\r\n                data.ao = this.ao.toJSON(meta).uuid;\r\n            if (this.ambient)\r\n                data.ambient = this.ambient.toJSON(meta).uuid;\r\n            if (this.shadow)\r\n                data.shadow = this.shadow.toJSON(meta).uuid;\r\n            if (this.emissive)\r\n                data.emissive = this.emissive.toJSON(meta).uuid;\r\n            if (this.environment)\r\n                data.environment = this.environment.toJSON(meta).uuid;\r\n            if (this.environmentAlpha)\r\n                data.environmentAlpha = this.environmentAlpha.toJSON(meta).uuid;\r\n        }\r\n        return data;\r\n    };\r\n    return PhongNode;\r\n});"]}