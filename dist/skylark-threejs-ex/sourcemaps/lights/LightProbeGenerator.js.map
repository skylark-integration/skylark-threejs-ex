{"version":3,"sources":["lights/LightProbeGenerator.js"],"names":["define","THREE","threex","LightProbeGenerator","fromCubeTexture","cubeTexture","norm","lengthSq","weight","totalWeight","coord","Vector3","dir","color","Color","shBasis","sh","SphericalHarmonics3","shCoefficients","coefficients","faceIndex","image","width","height","canvas","document","createElement","context","getContext","drawImage","imageData","getImageData","data","imageWidth","pixelSize","i","il","length","setRGB","convertColorToLinear","encoding","pixelIndex","col","row","Math","floor","set","sqrt","copy","normalize","getBasisAt","j","x","r","y","g","z","b","PI","LightProbe","fromCubeRenderTarget","renderer","cubeRenderTarget","Uint8Array","readRenderTargetPixels","texture","sRGBEncoding","convertSRGBToLinear","LinearEncoding","console","warn","lights"],"mappings":"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","file":"../../lights/LightProbeGenerator.js","sourcesContent":["define([\n    \"skylark-threejs\",\n    \"../threex\"\n], function (\n    THREE,\n    threex\n) {\n    'use strict';\n    var LightProbeGenerator = {\n        fromCubeTexture: function (cubeTexture) {\n            var norm, lengthSq, weight, totalWeight = 0;\n            var coord = new THREE.Vector3();\n            var dir = new THREE.Vector3();\n            var color = new THREE.Color();\n            var shBasis = [\n                0,\n                0,\n                0,\n                0,\n                0,\n                0,\n                0,\n                0,\n                0\n            ];\n            var sh = new THREE.SphericalHarmonics3();\n            var shCoefficients = sh.coefficients;\n            for (var faceIndex = 0; faceIndex < 6; faceIndex++) {\n                var image = cubeTexture.image[faceIndex];\n                var width = image.width;\n                var height = image.height;\n                var canvas = document.createElement('canvas');\n                canvas.width = width;\n                canvas.height = height;\n                var context = canvas.getContext('2d');\n                context.drawImage(image, 0, 0, width, height);\n                var imageData = context.getImageData(0, 0, width, height);\n                var data = imageData.data;\n                var imageWidth = imageData.width;\n                var pixelSize = 2 / imageWidth;\n                for (var i = 0, il = data.length; i < il; i += 4) {\n                    color.setRGB(data[i] / 255, data[i + 1] / 255, data[i + 2] / 255);\n                    convertColorToLinear(color, cubeTexture.encoding);\n                    var pixelIndex = i / 4;\n                    var col = -1 + (pixelIndex % imageWidth + 0.5) * pixelSize;\n                    var row = 1 - (Math.floor(pixelIndex / imageWidth) + 0.5) * pixelSize;\n                    switch (faceIndex) {\n                    case 0:\n                        coord.set(-1, row, -col);\n                        break;\n                    case 1:\n                        coord.set(1, row, col);\n                        break;\n                    case 2:\n                        coord.set(-col, 1, -row);\n                        break;\n                    case 3:\n                        coord.set(-col, -1, row);\n                        break;\n                    case 4:\n                        coord.set(-col, row, 1);\n                        break;\n                    case 5:\n                        coord.set(col, row, -1);\n                        break;\n                    }\n                    lengthSq = coord.lengthSq();\n                    weight = 4 / (Math.sqrt(lengthSq) * lengthSq);\n                    totalWeight += weight;\n                    dir.copy(coord).normalize();\n                    THREE.SphericalHarmonics3.getBasisAt(dir, shBasis);\n                    for (var j = 0; j < 9; j++) {\n                        shCoefficients[j].x += shBasis[j] * color.r * weight;\n                        shCoefficients[j].y += shBasis[j] * color.g * weight;\n                        shCoefficients[j].z += shBasis[j] * color.b * weight;\n                    }\n                }\n            }\n            norm = 4 * Math.PI / totalWeight;\n            for (var j = 0; j < 9; j++) {\n                shCoefficients[j].x *= norm;\n                shCoefficients[j].y *= norm;\n                shCoefficients[j].z *= norm;\n            }\n            return new THREE.LightProbe(sh);\n        },\n        fromCubeRenderTarget: function (renderer, cubeRenderTarget) {\n            var norm, lengthSq, weight, totalWeight = 0;\n            var coord = new THREE.Vector3();\n            var dir = new THREE.Vector3();\n            var color = new THREE.Color();\n            var shBasis = [\n                0,\n                0,\n                0,\n                0,\n                0,\n                0,\n                0,\n                0,\n                0\n            ];\n            var sh = new THREE.SphericalHarmonics3();\n            var shCoefficients = sh.coefficients;\n            for (var faceIndex = 0; faceIndex < 6; faceIndex++) {\n                var imageWidth = cubeRenderTarget.width;\n                var data = new Uint8Array(imageWidth * imageWidth * 4);\n                renderer.readRenderTargetPixels(cubeRenderTarget, 0, 0, imageWidth, imageWidth, data, faceIndex);\n                var pixelSize = 2 / imageWidth;\n                for (var i = 0, il = data.length; i < il; i += 4) {\n                    color.setRGB(data[i] / 255, data[i + 1] / 255, data[i + 2] / 255);\n                    convertColorToLinear(color, cubeRenderTarget.texture.encoding);\n                    var pixelIndex = i / 4;\n                    var col = -1 + (pixelIndex % imageWidth + 0.5) * pixelSize;\n                    var row = 1 - (Math.floor(pixelIndex / imageWidth) + 0.5) * pixelSize;\n                    switch (faceIndex) {\n                    case 0:\n                        coord.set(1, row, -col);\n                        break;\n                    case 1:\n                        coord.set(-1, row, col);\n                        break;\n                    case 2:\n                        coord.set(col, 1, -row);\n                        break;\n                    case 3:\n                        coord.set(col, -1, row);\n                        break;\n                    case 4:\n                        coord.set(col, row, 1);\n                        break;\n                    case 5:\n                        coord.set(-col, row, -1);\n                        break;\n                    }\n                    lengthSq = coord.lengthSq();\n                    weight = 4 / (Math.sqrt(lengthSq) * lengthSq);\n                    totalWeight += weight;\n                    dir.copy(coord).normalize();\n                    THREE.SphericalHarmonics3.getBasisAt(dir, shBasis);\n                    for (var j = 0; j < 9; j++) {\n                        shCoefficients[j].x += shBasis[j] * color.r * weight;\n                        shCoefficients[j].y += shBasis[j] * color.g * weight;\n                        shCoefficients[j].z += shBasis[j] * color.b * weight;\n                    }\n                }\n            }\n            norm = 4 * Math.PI / totalWeight;\n            for (var j = 0; j < 9; j++) {\n                shCoefficients[j].x *= norm;\n                shCoefficients[j].y *= norm;\n                shCoefficients[j].z *= norm;\n            }\n            return new THREE.LightProbe(sh);\n        }\n    };\n    var convertColorToLinear = function (color, encoding) {\n        switch (encoding) {\n        case THREE.sRGBEncoding:\n            color.convertSRGBToLinear();\n            break;\n        case THREE.LinearEncoding:\n            break;\n        default:\n            console.warn('WARNING: LightProbeGenerator convertColorToLinear() encountered an unsupported encoding.');\n            break;\n        }\n        return color;\n    };\n    \n    return threex.lights.LightProbeGenerator = LightProbeGenerator;\n});"]}