{"version":3,"sources":["animation/MMDAnimationHelper.js"],"names":["define","THREE","threex","CCDIKSolver","MMDPhysics","MMDAnimationHelper","params","this","meshes","camera","cameraTarget","Object3D","name","audio","audioManager","objects","WeakMap","configuration","sync","undefined","afterglow","resetPhysicsOnLoop","enabled","animation","ik","grant","physics","cameraAnimation","onBeforePhysics","sharedPhysics","masterPhysics","AudioManager","elapsedTime","currentTime","delayTime","audioDuration","buffer","duration","GrantSolver","mesh","grants","quaternion","prototype","constructor","add","object","isSkinnedMesh","_addMesh","isCamera","_setupCamera","type","Error","_setupAudio","_syncDuration","remove","_removeMesh","_clearCamera","_clearAudio","update","delta","control","i","length","_animateMesh","_updateSharedPhysics","_animateCamera","pose","vpd","resetPose","bones","skeleton","boneParams","boneNameDictionary","il","vector","Vector3","Quaternion","boneParam","boneIndex","bone","position","fromArray","translation","multiply","updateMatrixWorld","_createCCDIKSolver","saveOriginalBonesBeforeIK","createGrantSolver","enable","key","_optimizeIK","geometry","userData","MMD","indexOf","push","set","looped","_setupMeshAnimation","_setupMeshPhysics","clearCamera","_setupCameraAnimation","clearAudio","found","writeIndex","delete","get","animations","Array","isArray","mixer","AnimationMixer","clipAction","play","addEventListener","event","tracks","action","_clip","slice","ikSolver","grantSolver","world","_getMasterPhysics","_createMMDPhysics","animationWarmup","reset","warmup","_restoreBones","_saveBones","updateProjectionMatrix","up","applyQuaternion","lookAt","physicsEnabled","iks","links","j","jl","link","index","rigidBodyType","rigidBodies","constraints","max","_actions","clip","has","Math","_updatePropertyMixersBuffer","propertyMixers","_bindings","accuIndex","_accuIndex","propertyMixer","offset","valueSize","binding","getValue","backupBones","Float32Array","toArray","p","updateRigidBodies","stepSimulation","updateBones","elapsed","_shouldStopAudio","stop","_shouldStartAudio","isPlaying","startTime","parentBone","parentIndex","isLocal","affectPosition","affectRotation","slerp","ratio"],"mappings":"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","file":"../../animation/MMDAnimationHelper.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\",\r\n    './CCDIKSolver',\r\n    './MMDPhysics'\r\n], function (\r\n    THREE, \r\n    threex,\r\n    CCDIKSolver, \r\n    MMDPhysics\r\n) {\r\n    'use strict';\r\n    var MMDAnimationHelper = function () {\r\n        function MMDAnimationHelper(params) {\r\n            params = params || {};\r\n            this.meshes = [];\r\n            this.camera = null;\r\n            this.cameraTarget = new THREE.Object3D();\r\n            this.cameraTarget.name = 'target';\r\n            this.audio = null;\r\n            this.audioManager = null;\r\n            this.objects = new WeakMap();\r\n            this.configuration = {\r\n                sync: params.sync !== undefined ? params.sync : true,\r\n                afterglow: params.afterglow !== undefined ? params.afterglow : 0,\r\n                resetPhysicsOnLoop: params.resetPhysicsOnLoop !== undefined ? params.resetPhysicsOnLoop : true\r\n            };\r\n            this.enabled = {\r\n                animation: true,\r\n                ik: true,\r\n                grant: true,\r\n                physics: true,\r\n                cameraAnimation: true\r\n            };\r\n            this.onBeforePhysics = function () {\r\n            };\r\n            this.sharedPhysics = false;\r\n            this.masterPhysics = null;\r\n        }\r\n        MMDAnimationHelper.prototype = {\r\n            constructor: MMDAnimationHelper,\r\n            add: function (object, params) {\r\n                params = params || {};\r\n                if (object.isSkinnedMesh) {\r\n                    this._addMesh(object, params);\r\n                } else if (object.isCamera) {\r\n                    this._setupCamera(object, params);\r\n                } else if (object.type === 'Audio') {\r\n                    this._setupAudio(object, params);\r\n                } else {\r\n                    throw new Error('THREE.MMDAnimationHelper.add: ' + 'accepts only ' + 'THREE.SkinnedMesh or ' + 'THREE.Camera or ' + 'THREE.Audio instance.');\r\n                }\r\n                if (this.configuration.sync)\r\n                    this._syncDuration();\r\n                return this;\r\n            },\r\n            remove: function (object) {\r\n                if (object.isSkinnedMesh) {\r\n                    this._removeMesh(object);\r\n                } else if (object.isCamera) {\r\n                    this._clearCamera(object);\r\n                } else if (object.type === 'Audio') {\r\n                    this._clearAudio(object);\r\n                } else {\r\n                    throw new Error('THREE.MMDAnimationHelper.remove: ' + 'accepts only ' + 'THREE.SkinnedMesh or ' + 'THREE.Camera or ' + 'THREE.Audio instance.');\r\n                }\r\n                if (this.configuration.sync)\r\n                    this._syncDuration();\r\n                return this;\r\n            },\r\n            update: function (delta) {\r\n                if (this.audioManager !== null)\r\n                    this.audioManager.control(delta);\r\n                for (var i = 0; i < this.meshes.length; i++) {\r\n                    this._animateMesh(this.meshes[i], delta);\r\n                }\r\n                if (this.sharedPhysics)\r\n                    this._updateSharedPhysics(delta);\r\n                if (this.camera !== null)\r\n                    this._animateCamera(this.camera, delta);\r\n                return this;\r\n            },\r\n            pose: function (mesh, vpd, params) {\r\n                params = params || {};\r\n                if (params.resetPose !== false)\r\n                    mesh.pose();\r\n                var bones = mesh.skeleton.bones;\r\n                var boneParams = vpd.bones;\r\n                var boneNameDictionary = {};\r\n                for (var i = 0, il = bones.length; i < il; i++) {\r\n                    boneNameDictionary[bones[i].name] = i;\r\n                }\r\n                var vector = new THREE.Vector3();\r\n                var quaternion = new THREE.Quaternion();\r\n                for (var i = 0, il = boneParams.length; i < il; i++) {\r\n                    var boneParam = boneParams[i];\r\n                    var boneIndex = boneNameDictionary[boneParam.name];\r\n                    if (boneIndex === undefined)\r\n                        continue;\r\n                    var bone = bones[boneIndex];\r\n                    bone.position.add(vector.fromArray(boneParam.translation));\r\n                    bone.quaternion.multiply(quaternion.fromArray(boneParam.quaternion));\r\n                }\r\n                mesh.updateMatrixWorld(true);\r\n                if (params.ik !== false) {\r\n                    this._createCCDIKSolver(mesh).update(params.saveOriginalBonesBeforeIK);\r\n                }\r\n                if (params.grant !== false) {\r\n                    this.createGrantSolver(mesh).update();\r\n                }\r\n                return this;\r\n            },\r\n            enable: function (key, enabled) {\r\n                if (this.enabled[key] === undefined) {\r\n                    throw new Error('THREE.MMDAnimationHelper.enable: ' + 'unknown key ' + key);\r\n                }\r\n                this.enabled[key] = enabled;\r\n                if (key === 'physics') {\r\n                    for (var i = 0, il = this.meshes.length; i < il; i++) {\r\n                        this._optimizeIK(this.meshes[i], enabled);\r\n                    }\r\n                }\r\n                return this;\r\n            },\r\n            createGrantSolver: function (mesh) {\r\n                return new GrantSolver(mesh, mesh.geometry.userData.MMD.grants);\r\n            },\r\n            _addMesh: function (mesh, params) {\r\n                if (this.meshes.indexOf(mesh) >= 0) {\r\n                    throw new Error('THREE.MMDAnimationHelper._addMesh: ' + \"SkinnedMesh '\" + mesh.name + \"' has already been added.\");\r\n                }\r\n                this.meshes.push(mesh);\r\n                this.objects.set(mesh, { looped: false });\r\n                this._setupMeshAnimation(mesh, params.animation);\r\n                if (params.physics !== false) {\r\n                    this._setupMeshPhysics(mesh, params);\r\n                }\r\n                return this;\r\n            },\r\n            _setupCamera: function (camera, params) {\r\n                if (this.camera === camera) {\r\n                    throw new Error('THREE.MMDAnimationHelper._setupCamera: ' + \"Camera '\" + camera.name + \"' has already been set.\");\r\n                }\r\n                if (this.camera)\r\n                    this.clearCamera(this.camera);\r\n                this.camera = camera;\r\n                camera.add(this.cameraTarget);\r\n                this.objects.set(camera, {});\r\n                if (params.animation !== undefined) {\r\n                    this._setupCameraAnimation(camera, params.animation);\r\n                }\r\n                return this;\r\n            },\r\n            _setupAudio: function (audio, params) {\r\n                if (this.audio === audio) {\r\n                    throw new Error('THREE.MMDAnimationHelper._setupAudio: ' + \"Audio '\" + audio.name + \"' has already been set.\");\r\n                }\r\n                if (this.audio)\r\n                    this.clearAudio(this.audio);\r\n                this.audio = audio;\r\n                this.audioManager = new AudioManager(audio, params);\r\n                this.objects.set(this.audioManager, { duration: this.audioManager.duration });\r\n                return this;\r\n            },\r\n            _removeMesh: function (mesh) {\r\n                var found = false;\r\n                var writeIndex = 0;\r\n                for (var i = 0, il = this.meshes.length; i < il; i++) {\r\n                    if (this.meshes[i] === mesh) {\r\n                        this.objects.delete(mesh);\r\n                        found = true;\r\n                        continue;\r\n                    }\r\n                    this.meshes[writeIndex++] = this.meshes[i];\r\n                }\r\n                if (!found) {\r\n                    throw new Error('THREE.MMDAnimationHelper._removeMesh: ' + \"SkinnedMesh '\" + mesh.name + \"' has not been added yet.\");\r\n                }\r\n                this.meshes.length = writeIndex;\r\n                return this;\r\n            },\r\n            _clearCamera: function (camera) {\r\n                if (camera !== this.camera) {\r\n                    throw new Error('THREE.MMDAnimationHelper._clearCamera: ' + \"Camera '\" + camera.name + \"' has not been set yet.\");\r\n                }\r\n                this.camera.remove(this.cameraTarget);\r\n                this.objects.delete(this.camera);\r\n                this.camera = null;\r\n                return this;\r\n            },\r\n            _clearAudio: function (audio) {\r\n                if (audio !== this.audio) {\r\n                    throw new Error('THREE.MMDAnimationHelper._clearAudio: ' + \"Audio '\" + audio.name + \"' has not been set yet.\");\r\n                }\r\n                this.objects.delete(this.audioManager);\r\n                this.audio = null;\r\n                this.audioManager = null;\r\n                return this;\r\n            },\r\n            _setupMeshAnimation: function (mesh, animation) {\r\n                var objects = this.objects.get(mesh);\r\n                if (animation !== undefined) {\r\n                    var animations = Array.isArray(animation) ? animation : [animation];\r\n                    objects.mixer = new THREE.AnimationMixer(mesh);\r\n                    for (var i = 0, il = animations.length; i < il; i++) {\r\n                        objects.mixer.clipAction(animations[i]).play();\r\n                    }\r\n                    objects.mixer.addEventListener('loop', function (event) {\r\n                        var tracks = event.action._clip.tracks;\r\n                        if (tracks.length > 0 && tracks[0].name.slice(0, 6) !== '.bones')\r\n                            return;\r\n                        objects.looped = true;\r\n                    });\r\n                }\r\n                objects.ikSolver = this._createCCDIKSolver(mesh);\r\n                objects.grantSolver = this.createGrantSolver(mesh);\r\n                return this;\r\n            },\r\n            _setupCameraAnimation: function (camera, animation) {\r\n                var animations = Array.isArray(animation) ? animation : [animation];\r\n                var objects = this.objects.get(camera);\r\n                objects.mixer = new THREE.AnimationMixer(camera);\r\n                for (var i = 0, il = animations.length; i < il; i++) {\r\n                    objects.mixer.clipAction(animations[i]).play();\r\n                }\r\n            },\r\n            _setupMeshPhysics: function (mesh, params) {\r\n                var objects = this.objects.get(mesh);\r\n                if (params.world === undefined && this.sharedPhysics) {\r\n                    var masterPhysics = this._getMasterPhysics();\r\n                    if (masterPhysics !== null)\r\n                        world = masterPhysics.world;\r\n                }\r\n                objects.physics = this._createMMDPhysics(mesh, params);\r\n                if (objects.mixer && params.animationWarmup !== false) {\r\n                    this._animateMesh(mesh, 0);\r\n                    objects.physics.reset();\r\n                }\r\n                objects.physics.warmup(params.warmup !== undefined ? params.warmup : 60);\r\n                this._optimizeIK(mesh, true);\r\n            },\r\n            _animateMesh: function (mesh, delta) {\r\n                var objects = this.objects.get(mesh);\r\n                var mixer = objects.mixer;\r\n                var ikSolver = objects.ikSolver;\r\n                var grantSolver = objects.grantSolver;\r\n                var physics = objects.physics;\r\n                var looped = objects.looped;\r\n                if (mixer && this.enabled.animation) {\r\n                    this._restoreBones(mesh);\r\n                    mixer.update(delta);\r\n                    this._saveBones(mesh);\r\n                    if (ikSolver && this.enabled.ik) {\r\n                        mesh.updateMatrixWorld(true);\r\n                        ikSolver.update();\r\n                    }\r\n                    if (grantSolver && this.enabled.grant) {\r\n                        grantSolver.update();\r\n                    }\r\n                }\r\n                if (looped === true && this.enabled.physics) {\r\n                    if (physics && this.configuration.resetPhysicsOnLoop)\r\n                        physics.reset();\r\n                    objects.looped = false;\r\n                }\r\n                if (physics && this.enabled.physics && !this.sharedPhysics) {\r\n                    this.onBeforePhysics(mesh);\r\n                    physics.update(delta);\r\n                }\r\n            },\r\n            _animateCamera: function (camera, delta) {\r\n                var mixer = this.objects.get(camera).mixer;\r\n                if (mixer && this.enabled.cameraAnimation) {\r\n                    mixer.update(delta);\r\n                    camera.updateProjectionMatrix();\r\n                    camera.up.set(0, 1, 0);\r\n                    camera.up.applyQuaternion(camera.quaternion);\r\n                    camera.lookAt(this.cameraTarget.position);\r\n                }\r\n            },\r\n            _optimizeIK: function (mesh, physicsEnabled) {\r\n                var iks = mesh.geometry.userData.MMD.iks;\r\n                var bones = mesh.geometry.userData.MMD.bones;\r\n                for (var i = 0, il = iks.length; i < il; i++) {\r\n                    var ik = iks[i];\r\n                    var links = ik.links;\r\n                    for (var j = 0, jl = links.length; j < jl; j++) {\r\n                        var link = links[j];\r\n                        if (physicsEnabled === true) {\r\n                            link.enabled = bones[link.index].rigidBodyType > 0 ? false : true;\r\n                        } else {\r\n                            link.enabled = true;\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            _createCCDIKSolver: function (mesh) {\r\n                if (CCDIKSolver === undefined) {\r\n                    throw new Error('THREE.MMDAnimationHelper: Import CCDIKSolver.');\r\n                }\r\n                return new CCDIKSolver(mesh, mesh.geometry.userData.MMD.iks);\r\n            },\r\n            _createMMDPhysics: function (mesh, params) {\r\n                if (MMDPhysics === undefined) {\r\n                    throw new Error('THREE.MMDPhysics: Import MMDPhysics.');\r\n                }\r\n                return new MMDPhysics(mesh, mesh.geometry.userData.MMD.rigidBodies, mesh.geometry.userData.MMD.constraints, params);\r\n            },\r\n            _syncDuration: function () {\r\n                var max = 0;\r\n                var objects = this.objects;\r\n                var meshes = this.meshes;\r\n                var camera = this.camera;\r\n                var audioManager = this.audioManager;\r\n                for (var i = 0, il = meshes.length; i < il; i++) {\r\n                    var mixer = this.objects.get(meshes[i]).mixer;\r\n                    if (mixer === undefined)\r\n                        continue;\r\n                    for (var j = 0; j < mixer._actions.length; j++) {\r\n                        var clip = mixer._actions[j]._clip;\r\n                        if (!objects.has(clip)) {\r\n                            objects.set(clip, { duration: clip.duration });\r\n                        }\r\n                        max = Math.max(max, objects.get(clip).duration);\r\n                    }\r\n                }\r\n                if (camera !== null) {\r\n                    var mixer = this.objects.get(camera).mixer;\r\n                    if (mixer !== undefined) {\r\n                        for (var i = 0, il = mixer._actions.length; i < il; i++) {\r\n                            var clip = mixer._actions[i]._clip;\r\n                            if (!objects.has(clip)) {\r\n                                objects.set(clip, { duration: clip.duration });\r\n                            }\r\n                            max = Math.max(max, objects.get(clip).duration);\r\n                        }\r\n                    }\r\n                }\r\n                if (audioManager !== null) {\r\n                    max = Math.max(max, objects.get(audioManager).duration);\r\n                }\r\n                max += this.configuration.afterglow;\r\n                for (var i = 0, il = this.meshes.length; i < il; i++) {\r\n                    var mixer = this.objects.get(this.meshes[i]).mixer;\r\n                    if (mixer === undefined)\r\n                        continue;\r\n                    for (var j = 0, jl = mixer._actions.length; j < jl; j++) {\r\n                        mixer._actions[j]._clip.duration = max;\r\n                    }\r\n                }\r\n                if (camera !== null) {\r\n                    var mixer = this.objects.get(camera).mixer;\r\n                    if (mixer !== undefined) {\r\n                        for (var i = 0, il = mixer._actions.length; i < il; i++) {\r\n                            mixer._actions[i]._clip.duration = max;\r\n                        }\r\n                    }\r\n                }\r\n                if (audioManager !== null) {\r\n                    audioManager.duration = max;\r\n                }\r\n            },\r\n            _updatePropertyMixersBuffer: function (mesh) {\r\n                var mixer = this.objects.get(mesh).mixer;\r\n                var propertyMixers = mixer._bindings;\r\n                var accuIndex = mixer._accuIndex;\r\n                for (var i = 0, il = propertyMixers.length; i < il; i++) {\r\n                    var propertyMixer = propertyMixers[i];\r\n                    var buffer = propertyMixer.buffer;\r\n                    var stride = propertyMixer.valueSize;\r\n                    var offset = (accuIndex + 1) * stride;\r\n                    propertyMixer.binding.getValue(buffer, offset);\r\n                }\r\n            },\r\n            _saveBones: function (mesh) {\r\n                var objects = this.objects.get(mesh);\r\n                var bones = mesh.skeleton.bones;\r\n                var backupBones = objects.backupBones;\r\n                if (backupBones === undefined) {\r\n                    backupBones = new Float32Array(bones.length * 7);\r\n                    objects.backupBones = backupBones;\r\n                }\r\n                for (var i = 0, il = bones.length; i < il; i++) {\r\n                    var bone = bones[i];\r\n                    bone.position.toArray(backupBones, i * 7);\r\n                    bone.quaternion.toArray(backupBones, i * 7 + 3);\r\n                }\r\n            },\r\n            _restoreBones: function (mesh) {\r\n                var objects = this.objects.get(mesh);\r\n                var backupBones = objects.backupBones;\r\n                if (backupBones === undefined)\r\n                    return;\r\n                var bones = mesh.skeleton.bones;\r\n                for (var i = 0, il = bones.length; i < il; i++) {\r\n                    var bone = bones[i];\r\n                    bone.position.fromArray(backupBones, i * 7);\r\n                    bone.quaternion.fromArray(backupBones, i * 7 + 3);\r\n                }\r\n            },\r\n            _getMasterPhysics: function () {\r\n                if (this.masterPhysics !== null)\r\n                    return this.masterPhysics;\r\n                for (var i = 0, il = this.meshes.length; i < il; i++) {\r\n                    var physics = this.meshes[i].physics;\r\n                    if (physics !== undefined && physics !== null) {\r\n                        this.masterPhysics = physics;\r\n                        return this.masterPhysics;\r\n                    }\r\n                }\r\n                return null;\r\n            },\r\n            _updateSharedPhysics: function (delta) {\r\n                if (this.meshes.length === 0 || !this.enabled.physics || !this.sharedPhysics)\r\n                    return;\r\n                var physics = this._getMasterPhysics();\r\n                if (physics === null)\r\n                    return;\r\n                for (var i = 0, il = this.meshes.length; i < il; i++) {\r\n                    var p = this.meshes[i].physics;\r\n                    if (p !== null && p !== undefined) {\r\n                        p.updateRigidBodies();\r\n                    }\r\n                }\r\n                physics.stepSimulation(delta);\r\n                for (var i = 0, il = this.meshes.length; i < il; i++) {\r\n                    var p = this.meshes[i].physics;\r\n                    if (p !== null && p !== undefined) {\r\n                        p.updateBones();\r\n                    }\r\n                }\r\n            }\r\n        };\r\n        function AudioManager(audio, params) {\r\n            params = params || {};\r\n            this.audio = audio;\r\n            this.elapsedTime = 0;\r\n            this.currentTime = 0;\r\n            this.delayTime = params.delayTime !== undefined ? params.delayTime : 0;\r\n            this.audioDuration = this.audio.buffer.duration;\r\n            this.duration = this.audioDuration + this.delayTime;\r\n        }\r\n        AudioManager.prototype = {\r\n            constructor: AudioManager,\r\n            control: function (delta) {\r\n                this.elapsed += delta;\r\n                this.currentTime += delta;\r\n                if (this._shouldStopAudio())\r\n                    this.audio.stop();\r\n                if (this._shouldStartAudio())\r\n                    this.audio.play();\r\n                return this;\r\n            },\r\n            _shouldStartAudio: function () {\r\n                if (this.audio.isPlaying)\r\n                    return false;\r\n                while (this.currentTime >= this.duration) {\r\n                    this.currentTime -= this.duration;\r\n                }\r\n                if (this.currentTime < this.delayTime)\r\n                    return false;\r\n                if (this.currentTime - this.delayTime > this.audioDuration)\r\n                    return false;\r\n                this.audio.startTime = this.currentTime - this.delayTime;\r\n                return true;\r\n            },\r\n            _shouldStopAudio: function () {\r\n                return this.audio.isPlaying && this.currentTime >= this.duration;\r\n            }\r\n        };\r\n        function GrantSolver(mesh, grants) {\r\n            this.mesh = mesh;\r\n            this.grants = grants || [];\r\n        }\r\n        GrantSolver.prototype = {\r\n            constructor: GrantSolver,\r\n            update: function () {\r\n                var quaternion = new THREE.Quaternion();\r\n                return function () {\r\n                    var bones = this.mesh.skeleton.bones;\r\n                    var grants = this.grants;\r\n                    for (var i = 0, il = grants.length; i < il; i++) {\r\n                        var grant = grants[i];\r\n                        var bone = bones[grant.index];\r\n                        var parentBone = bones[grant.parentIndex];\r\n                        if (grant.isLocal) {\r\n                            if (grant.affectPosition) {\r\n                            }\r\n                            if (grant.affectRotation) {\r\n                            }\r\n                        } else {\r\n                            if (grant.affectPosition) {\r\n                            }\r\n                            if (grant.affectRotation) {\r\n                                quaternion.set(0, 0, 0, 1);\r\n                                quaternion.slerp(parentBone.quaternion, grant.ratio);\r\n                                bone.quaternion.multiply(quaternion);\r\n                            }\r\n                        }\r\n                    }\r\n                    return this;\r\n                };\r\n            }()\r\n        };\r\n        return MMDAnimationHelper;\r\n    }();\r\n\r\n    return threex.animation.MMDAnimationHelper = MMDAnimationHelper;\r\n});"]}