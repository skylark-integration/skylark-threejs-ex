{"version":3,"sources":["animation/MMDPhysics.js"],"names":["define","THREE","threex","MMDPhysics","mesh","rigidBodyParams","constraintParams","params","Ammo","Error","this","manager","ResourceManager","unitStep","undefined","maxStepNum","gravity","Vector3","copy","world","bodies","constraints","_init","threeVector3s","threeMatrix4s","threeQuaternions","threeEulers","transforms","quaternions","vector3s","RigidBody","body","bone","boneOffsetForm","boneOffsetFormInverse","Constraint","bodyA","bodyB","constraint","MMDPhysicsHelper","physics","Object3D","call","root","matrix","matrixWorld","matrixAutoUpdate","materials","push","MeshBasicMaterial","color","Color","wireframe","depthTest","depthWrite","opacity","transparent","position","quaternion","scale","matrixWorldInv","prototype","constructor","update","delta","parent","isNonDefaultScale","allocThreeVector3","allocThreeQuaternion","decompose","x","y","z","set","updateMatrixWorld","_updateRigidBodies","_stepSimulation","_updateBones","freeThreeVector3","freeThreeQuaternion","reset","i","il","length","warmup","cycles","setGravity","btVector3","createHelper","currentPosition","currentQuaternion","currentScale","_createWorld","_initRigidBodies","_initConstraints","config","btDefaultCollisionConfiguration","dispatcher","btCollisionDispatcher","cache","btDbvtBroadphase","solver","btSequentialImpulseConstraintSolver","btDiscreteDynamicsWorld","rigidBodies","rigidBodyIndex1","rigidBodyIndex2","stepTime","stepSimulation","updateFromBone","updateBone","pop","v","allocThreeMatrix4","Matrix4","freeThreeMatrix4","m","Quaternion","q","allocThreeEuler","Euler","freeThreeEuler","e","allocTransform","btTransform","freeTransform","t","allocQuaternion","btQuaternion","freeQuaternion","allocVector3","freeVector3","setIdentity","getBasis","getRotation","getBasisAsMatrix3","quaternionToMatrix3","getOrigin","setOrigin","setValue","copyOrigin","t1","t2","o","setBasis","setRotation","setBasisFromMatrix3","matrix3ToQuaternion","setOriginFromArray3","a","setOriginFromThreeVector3","setBasisFromArray3","thQ","thE","setBasisFromThreeQuaternion","setFromEuler","setX","setY","setZ","setW","w","multiplyTransforms","m1","m2","o1","o2","v1","multiplyMatrix3ByVector3","v2","addVector3","m3","multiplyMatrices3","inverseTransform","transposeMatrix3","negativeVector3","v10","rowOfMatrix3","v11","v12","v20","columnOfMatrix3","v21","v22","dotVectors3","v4","v0","xx","yy","zz","xy","yz","zx","xw","yw","zw","s","Math","sqrt","_setTransformFromBone","boneIndex","type","_updateBoneRotation","_updateBonePosition","_setPositionFromBone","bones","skeleton","Bone","shape","p","shapeType","btSphereShape","width","btBoxShape","height","depth","btCapsuleShape","generateShape","weight","localInertia","calculateLocalInertia","rotation","vector","boneForm","getWorldPosition","form","state","btDefaultMotionState","info","btRigidBodyConstructionInfo","set_m_friction","friction","set_m_restitution","restitution","btRigidBody","setCollisionFlags","getCollisionFlags","setActivationState","setDamping","positionDamping","rotationDamping","setSleepingThresholds","addRigidBody","groupIndex","groupTarget","_getBoneTransform","tr","_getWorldTransformForBone","getCenterOfMassTransform","setCenterOfMassTransform","getMotionState","setWorldTransform","getWorldTransform","thQ2","thQ3","setFromRotationMatrix","conjugate","multiply","normalize","thV","worldToLocal","formA","formB","formInverseA","formInverseB","formA2","formB2","btGeneric6DofSpringConstraint","lll","lul","all","aul","translationLimitation1","translationLimitation2","rotationLimitation1","rotationLimitation2","setLinearLowerLimit","setLinearUpperLimit","setAngularLowerLimit","setAngularUpperLimit","springPosition","enableSpring","setStiffness","springRotation","setParam","addConstraint","Object","assign","create","force","visible","compose","getInverse","child","children","origin","applyMatrix4","createGeometry","param","SphereBufferGeometry","BoxBufferGeometry","radius","cylinderHeight","segmentsRadius","segmentsHeight","geometry","CylinderBufferGeometry","upperSphere","Mesh","PI","lowerSphere","updateMatrix","merge","add","animation"],"mappings":"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","file":"../../animation/MMDPhysics.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var MMDPhysics = function () {\r\n        function MMDPhysics(mesh, rigidBodyParams, constraintParams, params) {\r\n            if (typeof Ammo === 'undefined') {\r\n                throw new Error('THREE.MMDPhysics: Import ammo.js https://github.com/kripken/ammo');\r\n            }\r\n            constraintParams = constraintParams || [];\r\n            params = params || {};\r\n            this.manager = new ResourceManager();\r\n            this.mesh = mesh;\r\n            this.unitStep = params.unitStep !== undefined ? params.unitStep : 1 / 65;\r\n            this.maxStepNum = params.maxStepNum !== undefined ? params.maxStepNum : 3;\r\n            this.gravity = new THREE.Vector3(0, -9.8 * 10, 0);\r\n            if (params.gravity !== undefined)\r\n                this.gravity.copy(params.gravity);\r\n            this.world = params.world !== undefined ? params.world : null;\r\n            this.bodies = [];\r\n            this.constraints = [];\r\n            this._init(mesh, rigidBodyParams, constraintParams);\r\n        }\r\n        MMDPhysics.prototype = {\r\n            constructor: MMDPhysics,\r\n            update: function (delta) {\r\n                var manager = this.manager;\r\n                var mesh = this.mesh;\r\n                var isNonDefaultScale = false;\r\n                var position = manager.allocThreeVector3();\r\n                var quaternion = manager.allocThreeQuaternion();\r\n                var scale = manager.allocThreeVector3();\r\n                mesh.matrixWorld.decompose(position, quaternion, scale);\r\n                if (scale.x !== 1 || scale.y !== 1 || scale.z !== 1) {\r\n                    isNonDefaultScale = true;\r\n                }\r\n                var parent;\r\n                if (isNonDefaultScale) {\r\n                    parent = mesh.parent;\r\n                    if (parent !== null)\r\n                        mesh.parent = null;\r\n                    scale.copy(this.mesh.scale);\r\n                    mesh.scale.set(1, 1, 1);\r\n                    mesh.updateMatrixWorld(true);\r\n                }\r\n                this._updateRigidBodies();\r\n                this._stepSimulation(delta);\r\n                this._updateBones();\r\n                if (isNonDefaultScale) {\r\n                    if (parent !== null)\r\n                        mesh.parent = parent;\r\n                    mesh.scale.copy(scale);\r\n                }\r\n                manager.freeThreeVector3(scale);\r\n                manager.freeThreeQuaternion(quaternion);\r\n                manager.freeThreeVector3(position);\r\n                return this;\r\n            },\r\n            reset: function () {\r\n                for (var i = 0, il = this.bodies.length; i < il; i++) {\r\n                    this.bodies[i].reset();\r\n                }\r\n                return this;\r\n            },\r\n            warmup: function (cycles) {\r\n                for (var i = 0; i < cycles; i++) {\r\n                    this.update(1 / 60);\r\n                }\r\n                return this;\r\n            },\r\n            setGravity: function (gravity) {\r\n                this.world.setGravity(new Ammo.btVector3(gravity.x, gravity.y, gravity.z));\r\n                this.gravity.copy(gravity);\r\n                return this;\r\n            },\r\n            createHelper: function () {\r\n                return new MMDPhysicsHelper(this.mesh, this);\r\n            },\r\n            _init: function (mesh, rigidBodyParams, constraintParams) {\r\n                var manager = this.manager;\r\n                var parent = mesh.parent;\r\n                if (parent !== null)\r\n                    parent = null;\r\n                var currentPosition = manager.allocThreeVector3();\r\n                var currentQuaternion = manager.allocThreeQuaternion();\r\n                var currentScale = manager.allocThreeVector3();\r\n                currentPosition.copy(mesh.position);\r\n                currentQuaternion.copy(mesh.quaternion);\r\n                currentScale.copy(mesh.scale);\r\n                mesh.position.set(0, 0, 0);\r\n                mesh.quaternion.set(0, 0, 0, 1);\r\n                mesh.scale.set(1, 1, 1);\r\n                mesh.updateMatrixWorld(true);\r\n                if (this.world === null) {\r\n                    this.world = this._createWorld();\r\n                    this.setGravity(this.gravity);\r\n                }\r\n                this._initRigidBodies(rigidBodyParams);\r\n                this._initConstraints(constraintParams);\r\n                if (parent !== null)\r\n                    mesh.parent = parent;\r\n                mesh.position.copy(currentPosition);\r\n                mesh.quaternion.copy(currentQuaternion);\r\n                mesh.scale.copy(currentScale);\r\n                mesh.updateMatrixWorld(true);\r\n                this.reset();\r\n                manager.freeThreeVector3(currentPosition);\r\n                manager.freeThreeQuaternion(currentQuaternion);\r\n                manager.freeThreeVector3(currentScale);\r\n            },\r\n            _createWorld: function () {\r\n                var config = new Ammo.btDefaultCollisionConfiguration();\r\n                var dispatcher = new Ammo.btCollisionDispatcher(config);\r\n                var cache = new Ammo.btDbvtBroadphase();\r\n                var solver = new Ammo.btSequentialImpulseConstraintSolver();\r\n                var world = new Ammo.btDiscreteDynamicsWorld(dispatcher, cache, solver, config);\r\n                return world;\r\n            },\r\n            _initRigidBodies: function (rigidBodies) {\r\n                for (var i = 0, il = rigidBodies.length; i < il; i++) {\r\n                    this.bodies.push(new RigidBody(this.mesh, this.world, rigidBodies[i], this.manager));\r\n                }\r\n            },\r\n            _initConstraints: function (constraints) {\r\n                for (var i = 0, il = constraints.length; i < il; i++) {\r\n                    var params = constraints[i];\r\n                    var bodyA = this.bodies[params.rigidBodyIndex1];\r\n                    var bodyB = this.bodies[params.rigidBodyIndex2];\r\n                    this.constraints.push(new Constraint(this.mesh, this.world, bodyA, bodyB, params, this.manager));\r\n                }\r\n            },\r\n            _stepSimulation: function (delta) {\r\n                var unitStep = this.unitStep;\r\n                var stepTime = delta;\r\n                var maxStepNum = (delta / unitStep | 0) + 1;\r\n                if (stepTime < unitStep) {\r\n                    stepTime = unitStep;\r\n                    maxStepNum = 1;\r\n                }\r\n                if (maxStepNum > this.maxStepNum) {\r\n                    maxStepNum = this.maxStepNum;\r\n                }\r\n                this.world.stepSimulation(stepTime, maxStepNum, unitStep);\r\n            },\r\n            _updateRigidBodies: function () {\r\n                for (var i = 0, il = this.bodies.length; i < il; i++) {\r\n                    this.bodies[i].updateFromBone();\r\n                }\r\n            },\r\n            _updateBones: function () {\r\n                for (var i = 0, il = this.bodies.length; i < il; i++) {\r\n                    this.bodies[i].updateBone();\r\n                }\r\n            }\r\n        };\r\n        function ResourceManager() {\r\n            this.threeVector3s = [];\r\n            this.threeMatrix4s = [];\r\n            this.threeQuaternions = [];\r\n            this.threeEulers = [];\r\n            this.transforms = [];\r\n            this.quaternions = [];\r\n            this.vector3s = [];\r\n        }\r\n        ResourceManager.prototype = {\r\n            constructor: ResourceManager,\r\n            allocThreeVector3: function () {\r\n                return this.threeVector3s.length > 0 ? this.threeVector3s.pop() : new THREE.Vector3();\r\n            },\r\n            freeThreeVector3: function (v) {\r\n                this.threeVector3s.push(v);\r\n            },\r\n            allocThreeMatrix4: function () {\r\n                return this.threeMatrix4s.length > 0 ? this.threeMatrix4s.pop() : new THREE.Matrix4();\r\n            },\r\n            freeThreeMatrix4: function (m) {\r\n                this.threeMatrix4s.push(m);\r\n            },\r\n            allocThreeQuaternion: function () {\r\n                return this.threeQuaternions.length > 0 ? this.threeQuaternions.pop() : new THREE.Quaternion();\r\n            },\r\n            freeThreeQuaternion: function (q) {\r\n                this.threeQuaternions.push(q);\r\n            },\r\n            allocThreeEuler: function () {\r\n                return this.threeEulers.length > 0 ? this.threeEulers.pop() : new THREE.Euler();\r\n            },\r\n            freeThreeEuler: function (e) {\r\n                this.threeEulers.push(e);\r\n            },\r\n            allocTransform: function () {\r\n                return this.transforms.length > 0 ? this.transforms.pop() : new Ammo.btTransform();\r\n            },\r\n            freeTransform: function (t) {\r\n                this.transforms.push(t);\r\n            },\r\n            allocQuaternion: function () {\r\n                return this.quaternions.length > 0 ? this.quaternions.pop() : new Ammo.btQuaternion();\r\n            },\r\n            freeQuaternion: function (q) {\r\n                this.quaternions.push(q);\r\n            },\r\n            allocVector3: function () {\r\n                return this.vector3s.length > 0 ? this.vector3s.pop() : new Ammo.btVector3();\r\n            },\r\n            freeVector3: function (v) {\r\n                this.vector3s.push(v);\r\n            },\r\n            setIdentity: function (t) {\r\n                t.setIdentity();\r\n            },\r\n            getBasis: function (t) {\r\n                var q = this.allocQuaternion();\r\n                t.getBasis().getRotation(q);\r\n                return q;\r\n            },\r\n            getBasisAsMatrix3: function (t) {\r\n                var q = this.getBasis(t);\r\n                var m = this.quaternionToMatrix3(q);\r\n                this.freeQuaternion(q);\r\n                return m;\r\n            },\r\n            getOrigin: function (t) {\r\n                return t.getOrigin();\r\n            },\r\n            setOrigin: function (t, v) {\r\n                t.getOrigin().setValue(v.x(), v.y(), v.z());\r\n            },\r\n            copyOrigin: function (t1, t2) {\r\n                var o = t2.getOrigin();\r\n                this.setOrigin(t1, o);\r\n            },\r\n            setBasis: function (t, q) {\r\n                t.setRotation(q);\r\n            },\r\n            setBasisFromMatrix3: function (t, m) {\r\n                var q = this.matrix3ToQuaternion(m);\r\n                this.setBasis(t, q);\r\n                this.freeQuaternion(q);\r\n            },\r\n            setOriginFromArray3: function (t, a) {\r\n                t.getOrigin().setValue(a[0], a[1], a[2]);\r\n            },\r\n            setOriginFromThreeVector3: function (t, v) {\r\n                t.getOrigin().setValue(v.x, v.y, v.z);\r\n            },\r\n            setBasisFromArray3: function (t, a) {\r\n                var thQ = this.allocThreeQuaternion();\r\n                var thE = this.allocThreeEuler();\r\n                thE.set(a[0], a[1], a[2]);\r\n                this.setBasisFromThreeQuaternion(t, thQ.setFromEuler(thE));\r\n                this.freeThreeEuler(thE);\r\n                this.freeThreeQuaternion(thQ);\r\n            },\r\n            setBasisFromThreeQuaternion: function (t, a) {\r\n                var q = this.allocQuaternion();\r\n                q.setX(a.x);\r\n                q.setY(a.y);\r\n                q.setZ(a.z);\r\n                q.setW(a.w);\r\n                this.setBasis(t, q);\r\n                this.freeQuaternion(q);\r\n            },\r\n            multiplyTransforms: function (t1, t2) {\r\n                var t = this.allocTransform();\r\n                this.setIdentity(t);\r\n                var m1 = this.getBasisAsMatrix3(t1);\r\n                var m2 = this.getBasisAsMatrix3(t2);\r\n                var o1 = this.getOrigin(t1);\r\n                var o2 = this.getOrigin(t2);\r\n                var v1 = this.multiplyMatrix3ByVector3(m1, o2);\r\n                var v2 = this.addVector3(v1, o1);\r\n                this.setOrigin(t, v2);\r\n                var m3 = this.multiplyMatrices3(m1, m2);\r\n                this.setBasisFromMatrix3(t, m3);\r\n                this.freeVector3(v1);\r\n                this.freeVector3(v2);\r\n                return t;\r\n            },\r\n            inverseTransform: function (t) {\r\n                var t2 = this.allocTransform();\r\n                var m1 = this.getBasisAsMatrix3(t);\r\n                var o = this.getOrigin(t);\r\n                var m2 = this.transposeMatrix3(m1);\r\n                var v1 = this.negativeVector3(o);\r\n                var v2 = this.multiplyMatrix3ByVector3(m2, v1);\r\n                this.setOrigin(t2, v2);\r\n                this.setBasisFromMatrix3(t2, m2);\r\n                this.freeVector3(v1);\r\n                this.freeVector3(v2);\r\n                return t2;\r\n            },\r\n            multiplyMatrices3: function (m1, m2) {\r\n                var m3 = [];\r\n                var v10 = this.rowOfMatrix3(m1, 0);\r\n                var v11 = this.rowOfMatrix3(m1, 1);\r\n                var v12 = this.rowOfMatrix3(m1, 2);\r\n                var v20 = this.columnOfMatrix3(m2, 0);\r\n                var v21 = this.columnOfMatrix3(m2, 1);\r\n                var v22 = this.columnOfMatrix3(m2, 2);\r\n                m3[0] = this.dotVectors3(v10, v20);\r\n                m3[1] = this.dotVectors3(v10, v21);\r\n                m3[2] = this.dotVectors3(v10, v22);\r\n                m3[3] = this.dotVectors3(v11, v20);\r\n                m3[4] = this.dotVectors3(v11, v21);\r\n                m3[5] = this.dotVectors3(v11, v22);\r\n                m3[6] = this.dotVectors3(v12, v20);\r\n                m3[7] = this.dotVectors3(v12, v21);\r\n                m3[8] = this.dotVectors3(v12, v22);\r\n                this.freeVector3(v10);\r\n                this.freeVector3(v11);\r\n                this.freeVector3(v12);\r\n                this.freeVector3(v20);\r\n                this.freeVector3(v21);\r\n                this.freeVector3(v22);\r\n                return m3;\r\n            },\r\n            addVector3: function (v1, v2) {\r\n                var v = this.allocVector3();\r\n                v.setValue(v1.x() + v2.x(), v1.y() + v2.y(), v1.z() + v2.z());\r\n                return v;\r\n            },\r\n            dotVectors3: function (v1, v2) {\r\n                return v1.x() * v2.x() + v1.y() * v2.y() + v1.z() * v2.z();\r\n            },\r\n            rowOfMatrix3: function (m, i) {\r\n                var v = this.allocVector3();\r\n                v.setValue(m[i * 3 + 0], m[i * 3 + 1], m[i * 3 + 2]);\r\n                return v;\r\n            },\r\n            columnOfMatrix3: function (m, i) {\r\n                var v = this.allocVector3();\r\n                v.setValue(m[i + 0], m[i + 3], m[i + 6]);\r\n                return v;\r\n            },\r\n            negativeVector3: function (v) {\r\n                var v2 = this.allocVector3();\r\n                v2.setValue(-v.x(), -v.y(), -v.z());\r\n                return v2;\r\n            },\r\n            multiplyMatrix3ByVector3: function (m, v) {\r\n                var v4 = this.allocVector3();\r\n                var v0 = this.rowOfMatrix3(m, 0);\r\n                var v1 = this.rowOfMatrix3(m, 1);\r\n                var v2 = this.rowOfMatrix3(m, 2);\r\n                var x = this.dotVectors3(v0, v);\r\n                var y = this.dotVectors3(v1, v);\r\n                var z = this.dotVectors3(v2, v);\r\n                v4.setValue(x, y, z);\r\n                this.freeVector3(v0);\r\n                this.freeVector3(v1);\r\n                this.freeVector3(v2);\r\n                return v4;\r\n            },\r\n            transposeMatrix3: function (m) {\r\n                var m2 = [];\r\n                m2[0] = m[0];\r\n                m2[1] = m[3];\r\n                m2[2] = m[6];\r\n                m2[3] = m[1];\r\n                m2[4] = m[4];\r\n                m2[5] = m[7];\r\n                m2[6] = m[2];\r\n                m2[7] = m[5];\r\n                m2[8] = m[8];\r\n                return m2;\r\n            },\r\n            quaternionToMatrix3: function (q) {\r\n                var m = [];\r\n                var x = q.x();\r\n                var y = q.y();\r\n                var z = q.z();\r\n                var w = q.w();\r\n                var xx = x * x;\r\n                var yy = y * y;\r\n                var zz = z * z;\r\n                var xy = x * y;\r\n                var yz = y * z;\r\n                var zx = z * x;\r\n                var xw = x * w;\r\n                var yw = y * w;\r\n                var zw = z * w;\r\n                m[0] = 1 - 2 * (yy + zz);\r\n                m[1] = 2 * (xy - zw);\r\n                m[2] = 2 * (zx + yw);\r\n                m[3] = 2 * (xy + zw);\r\n                m[4] = 1 - 2 * (zz + xx);\r\n                m[5] = 2 * (yz - xw);\r\n                m[6] = 2 * (zx - yw);\r\n                m[7] = 2 * (yz + xw);\r\n                m[8] = 1 - 2 * (xx + yy);\r\n                return m;\r\n            },\r\n            matrix3ToQuaternion: function (m) {\r\n                var t = m[0] + m[4] + m[8];\r\n                var s, x, y, z, w;\r\n                if (t > 0) {\r\n                    s = Math.sqrt(t + 1) * 2;\r\n                    w = 0.25 * s;\r\n                    x = (m[7] - m[5]) / s;\r\n                    y = (m[2] - m[6]) / s;\r\n                    z = (m[3] - m[1]) / s;\r\n                } else if (m[0] > m[4] && m[0] > m[8]) {\r\n                    s = Math.sqrt(1 + m[0] - m[4] - m[8]) * 2;\r\n                    w = (m[7] - m[5]) / s;\r\n                    x = 0.25 * s;\r\n                    y = (m[1] + m[3]) / s;\r\n                    z = (m[2] + m[6]) / s;\r\n                } else if (m[4] > m[8]) {\r\n                    s = Math.sqrt(1 + m[4] - m[0] - m[8]) * 2;\r\n                    w = (m[2] - m[6]) / s;\r\n                    x = (m[1] + m[3]) / s;\r\n                    y = 0.25 * s;\r\n                    z = (m[5] + m[7]) / s;\r\n                } else {\r\n                    s = Math.sqrt(1 + m[8] - m[0] - m[4]) * 2;\r\n                    w = (m[3] - m[1]) / s;\r\n                    x = (m[2] + m[6]) / s;\r\n                    y = (m[5] + m[7]) / s;\r\n                    z = 0.25 * s;\r\n                }\r\n                var q = this.allocQuaternion();\r\n                q.setX(x);\r\n                q.setY(y);\r\n                q.setZ(z);\r\n                q.setW(w);\r\n                return q;\r\n            }\r\n        };\r\n        function RigidBody(mesh, world, params, manager) {\r\n            this.mesh = mesh;\r\n            this.world = world;\r\n            this.params = params;\r\n            this.manager = manager;\r\n            this.body = null;\r\n            this.bone = null;\r\n            this.boneOffsetForm = null;\r\n            this.boneOffsetFormInverse = null;\r\n            this._init();\r\n        }\r\n        RigidBody.prototype = {\r\n            constructor: MMDPhysics.RigidBody,\r\n            reset: function () {\r\n                this._setTransformFromBone();\r\n                return this;\r\n            },\r\n            updateFromBone: function () {\r\n                if (this.params.boneIndex !== -1 && this.params.type === 0) {\r\n                    this._setTransformFromBone();\r\n                }\r\n                return this;\r\n            },\r\n            updateBone: function () {\r\n                if (this.params.type === 0 || this.params.boneIndex === -1) {\r\n                    return this;\r\n                }\r\n                this._updateBoneRotation();\r\n                if (this.params.type === 1) {\r\n                    this._updateBonePosition();\r\n                }\r\n                this.bone.updateMatrixWorld(true);\r\n                if (this.params.type === 2) {\r\n                    this._setPositionFromBone();\r\n                }\r\n                return this;\r\n            },\r\n            _init: function () {\r\n                function generateShape(p) {\r\n                    switch (p.shapeType) {\r\n                    case 0:\r\n                        return new Ammo.btSphereShape(p.width);\r\n                    case 1:\r\n                        return new Ammo.btBoxShape(new Ammo.btVector3(p.width, p.height, p.depth));\r\n                    case 2:\r\n                        return new Ammo.btCapsuleShape(p.width, p.height);\r\n                    default:\r\n                        throw 'unknown shape type ' + p.shapeType;\r\n                    }\r\n                }\r\n                var manager = this.manager;\r\n                var params = this.params;\r\n                var bones = this.mesh.skeleton.bones;\r\n                var bone = params.boneIndex === -1 ? new THREE.Bone() : bones[params.boneIndex];\r\n                var shape = generateShape(params);\r\n                var weight = params.type === 0 ? 0 : params.weight;\r\n                var localInertia = manager.allocVector3();\r\n                localInertia.setValue(0, 0, 0);\r\n                if (weight !== 0) {\r\n                    shape.calculateLocalInertia(weight, localInertia);\r\n                }\r\n                var boneOffsetForm = manager.allocTransform();\r\n                manager.setIdentity(boneOffsetForm);\r\n                manager.setOriginFromArray3(boneOffsetForm, params.position);\r\n                manager.setBasisFromArray3(boneOffsetForm, params.rotation);\r\n                var vector = manager.allocThreeVector3();\r\n                var boneForm = manager.allocTransform();\r\n                manager.setIdentity(boneForm);\r\n                manager.setOriginFromThreeVector3(boneForm, bone.getWorldPosition(vector));\r\n                var form = manager.multiplyTransforms(boneForm, boneOffsetForm);\r\n                var state = new Ammo.btDefaultMotionState(form);\r\n                var info = new Ammo.btRigidBodyConstructionInfo(weight, state, shape, localInertia);\r\n                info.set_m_friction(params.friction);\r\n                info.set_m_restitution(params.restitution);\r\n                var body = new Ammo.btRigidBody(info);\r\n                if (params.type === 0) {\r\n                    body.setCollisionFlags(body.getCollisionFlags() | 2);\r\n                    body.setActivationState(4);\r\n                }\r\n                body.setDamping(params.positionDamping, params.rotationDamping);\r\n                body.setSleepingThresholds(0, 0);\r\n                this.world.addRigidBody(body, 1 << params.groupIndex, params.groupTarget);\r\n                this.body = body;\r\n                this.bone = bone;\r\n                this.boneOffsetForm = boneOffsetForm;\r\n                this.boneOffsetFormInverse = manager.inverseTransform(boneOffsetForm);\r\n                manager.freeVector3(localInertia);\r\n                manager.freeTransform(form);\r\n                manager.freeTransform(boneForm);\r\n                manager.freeThreeVector3(vector);\r\n            },\r\n            _getBoneTransform: function () {\r\n                var manager = this.manager;\r\n                var p = manager.allocThreeVector3();\r\n                var q = manager.allocThreeQuaternion();\r\n                var s = manager.allocThreeVector3();\r\n                this.bone.matrixWorld.decompose(p, q, s);\r\n                var tr = manager.allocTransform();\r\n                manager.setOriginFromThreeVector3(tr, p);\r\n                manager.setBasisFromThreeQuaternion(tr, q);\r\n                var form = manager.multiplyTransforms(tr, this.boneOffsetForm);\r\n                manager.freeTransform(tr);\r\n                manager.freeThreeVector3(s);\r\n                manager.freeThreeQuaternion(q);\r\n                manager.freeThreeVector3(p);\r\n                return form;\r\n            },\r\n            _getWorldTransformForBone: function () {\r\n                var manager = this.manager;\r\n                var tr = this.body.getCenterOfMassTransform();\r\n                return manager.multiplyTransforms(tr, this.boneOffsetFormInverse);\r\n            },\r\n            _setTransformFromBone: function () {\r\n                var manager = this.manager;\r\n                var form = this._getBoneTransform();\r\n                this.body.setCenterOfMassTransform(form);\r\n                this.body.getMotionState().setWorldTransform(form);\r\n                manager.freeTransform(form);\r\n            },\r\n            _setPositionFromBone: function () {\r\n                var manager = this.manager;\r\n                var form = this._getBoneTransform();\r\n                var tr = manager.allocTransform();\r\n                this.body.getMotionState().getWorldTransform(tr);\r\n                manager.copyOrigin(tr, form);\r\n                this.body.setCenterOfMassTransform(tr);\r\n                this.body.getMotionState().setWorldTransform(tr);\r\n                manager.freeTransform(tr);\r\n                manager.freeTransform(form);\r\n            },\r\n            _updateBoneRotation: function () {\r\n                var manager = this.manager;\r\n                var tr = this._getWorldTransformForBone();\r\n                var q = manager.getBasis(tr);\r\n                var thQ = manager.allocThreeQuaternion();\r\n                var thQ2 = manager.allocThreeQuaternion();\r\n                var thQ3 = manager.allocThreeQuaternion();\r\n                thQ.set(q.x(), q.y(), q.z(), q.w());\r\n                thQ2.setFromRotationMatrix(this.bone.matrixWorld);\r\n                thQ2.conjugate();\r\n                thQ2.multiply(thQ);\r\n                thQ3.setFromRotationMatrix(this.bone.matrix);\r\n                this.bone.quaternion.copy(thQ2.multiply(thQ3).normalize());\r\n                manager.freeThreeQuaternion(thQ);\r\n                manager.freeThreeQuaternion(thQ2);\r\n                manager.freeThreeQuaternion(thQ3);\r\n                manager.freeQuaternion(q);\r\n                manager.freeTransform(tr);\r\n            },\r\n            _updateBonePosition: function () {\r\n                var manager = this.manager;\r\n                var tr = this._getWorldTransformForBone();\r\n                var thV = manager.allocThreeVector3();\r\n                var o = manager.getOrigin(tr);\r\n                thV.set(o.x(), o.y(), o.z());\r\n                if (this.bone.parent) {\r\n                    this.bone.parent.worldToLocal(thV);\r\n                }\r\n                this.bone.position.copy(thV);\r\n                manager.freeThreeVector3(thV);\r\n                manager.freeTransform(tr);\r\n            }\r\n        };\r\n        function Constraint(mesh, world, bodyA, bodyB, params, manager) {\r\n            this.mesh = mesh;\r\n            this.world = world;\r\n            this.bodyA = bodyA;\r\n            this.bodyB = bodyB;\r\n            this.params = params;\r\n            this.manager = manager;\r\n            this.constraint = null;\r\n            this._init();\r\n        }\r\n        Constraint.prototype = {\r\n            constructor: Constraint,\r\n            _init: function () {\r\n                var manager = this.manager;\r\n                var params = this.params;\r\n                var bodyA = this.bodyA;\r\n                var bodyB = this.bodyB;\r\n                var form = manager.allocTransform();\r\n                manager.setIdentity(form);\r\n                manager.setOriginFromArray3(form, params.position);\r\n                manager.setBasisFromArray3(form, params.rotation);\r\n                var formA = manager.allocTransform();\r\n                var formB = manager.allocTransform();\r\n                bodyA.body.getMotionState().getWorldTransform(formA);\r\n                bodyB.body.getMotionState().getWorldTransform(formB);\r\n                var formInverseA = manager.inverseTransform(formA);\r\n                var formInverseB = manager.inverseTransform(formB);\r\n                var formA2 = manager.multiplyTransforms(formInverseA, form);\r\n                var formB2 = manager.multiplyTransforms(formInverseB, form);\r\n                var constraint = new Ammo.btGeneric6DofSpringConstraint(bodyA.body, bodyB.body, formA2, formB2, true);\r\n                var lll = manager.allocVector3();\r\n                var lul = manager.allocVector3();\r\n                var all = manager.allocVector3();\r\n                var aul = manager.allocVector3();\r\n                lll.setValue(params.translationLimitation1[0], params.translationLimitation1[1], params.translationLimitation1[2]);\r\n                lul.setValue(params.translationLimitation2[0], params.translationLimitation2[1], params.translationLimitation2[2]);\r\n                all.setValue(params.rotationLimitation1[0], params.rotationLimitation1[1], params.rotationLimitation1[2]);\r\n                aul.setValue(params.rotationLimitation2[0], params.rotationLimitation2[1], params.rotationLimitation2[2]);\r\n                constraint.setLinearLowerLimit(lll);\r\n                constraint.setLinearUpperLimit(lul);\r\n                constraint.setAngularLowerLimit(all);\r\n                constraint.setAngularUpperLimit(aul);\r\n                for (var i = 0; i < 3; i++) {\r\n                    if (params.springPosition[i] !== 0) {\r\n                        constraint.enableSpring(i, true);\r\n                        constraint.setStiffness(i, params.springPosition[i]);\r\n                    }\r\n                }\r\n                for (var i = 0; i < 3; i++) {\r\n                    if (params.springRotation[i] !== 0) {\r\n                        constraint.enableSpring(i + 3, true);\r\n                        constraint.setStiffness(i + 3, params.springRotation[i]);\r\n                    }\r\n                }\r\n                if (constraint.setParam !== undefined) {\r\n                    for (var i = 0; i < 6; i++) {\r\n                        constraint.setParam(2, 0.475, i);\r\n                    }\r\n                }\r\n                this.world.addConstraint(constraint, true);\r\n                this.constraint = constraint;\r\n                manager.freeTransform(form);\r\n                manager.freeTransform(formA);\r\n                manager.freeTransform(formB);\r\n                manager.freeTransform(formInverseA);\r\n                manager.freeTransform(formInverseB);\r\n                manager.freeTransform(formA2);\r\n                manager.freeTransform(formB2);\r\n                manager.freeVector3(lll);\r\n                manager.freeVector3(lul);\r\n                manager.freeVector3(all);\r\n                manager.freeVector3(aul);\r\n            }\r\n        };\r\n        function MMDPhysicsHelper(mesh, physics) {\r\n            THREE.Object3D.call(this);\r\n            this.root = mesh;\r\n            this.physics = physics;\r\n            this.matrix.copy(mesh.matrixWorld);\r\n            this.matrixAutoUpdate = false;\r\n            this.materials = [];\r\n            this.materials.push(new THREE.MeshBasicMaterial({\r\n                color: new THREE.Color(16746632),\r\n                wireframe: true,\r\n                depthTest: false,\r\n                depthWrite: false,\r\n                opacity: 0.25,\r\n                transparent: true\r\n            }));\r\n            this.materials.push(new THREE.MeshBasicMaterial({\r\n                color: new THREE.Color(8978312),\r\n                wireframe: true,\r\n                depthTest: false,\r\n                depthWrite: false,\r\n                opacity: 0.25,\r\n                transparent: true\r\n            }));\r\n            this.materials.push(new THREE.MeshBasicMaterial({\r\n                color: new THREE.Color(8947967),\r\n                wireframe: true,\r\n                depthTest: false,\r\n                depthWrite: false,\r\n                opacity: 0.25,\r\n                transparent: true\r\n            }));\r\n            this._init();\r\n        }\r\n        MMDPhysicsHelper.prototype = Object.assign(Object.create(THREE.Object3D.prototype), {\r\n            constructor: MMDPhysicsHelper,\r\n            updateMatrixWorld: function () {\r\n                var position = new THREE.Vector3();\r\n                var quaternion = new THREE.Quaternion();\r\n                var scale = new THREE.Vector3();\r\n                var matrixWorldInv = new THREE.Matrix4();\r\n                return function updateMatrixWorld(force) {\r\n                    var mesh = this.root;\r\n                    if (this.visible) {\r\n                        var bodies = this.physics.bodies;\r\n                        matrixWorldInv.copy(mesh.matrixWorld).decompose(position, quaternion, scale).compose(position, quaternion, scale.set(1, 1, 1)).getInverse(matrixWorldInv);\r\n                        for (var i = 0, il = bodies.length; i < il; i++) {\r\n                            var body = bodies[i].body;\r\n                            var child = this.children[i];\r\n                            var tr = body.getCenterOfMassTransform();\r\n                            var origin = tr.getOrigin();\r\n                            var rotation = tr.getRotation();\r\n                            child.position.set(origin.x(), origin.y(), origin.z()).applyMatrix4(matrixWorldInv);\r\n                            child.quaternion.setFromRotationMatrix(matrixWorldInv).multiply(quaternion.set(rotation.x(), rotation.y(), rotation.z(), rotation.w()));\r\n                        }\r\n                    }\r\n                    this.matrix.copy(mesh.matrixWorld).decompose(position, quaternion, scale).compose(position, quaternion, scale.set(1, 1, 1));\r\n                    THREE.Object3D.prototype.updateMatrixWorld.call(this, force);\r\n                };\r\n            }(),\r\n            _init: function () {\r\n                var bodies = this.physics.bodies;\r\n                function createGeometry(param) {\r\n                    switch (param.shapeType) {\r\n                    case 0:\r\n                        return new THREE.SphereBufferGeometry(param.width, 16, 8);\r\n                    case 1:\r\n                        return new THREE.BoxBufferGeometry(param.width * 2, param.height * 2, param.depth * 2, 8, 8, 8);\r\n                    case 2:\r\n                        return new createCapsuleGeometry(param.width, param.height, 16, 8);\r\n                    default:\r\n                        return null;\r\n                    }\r\n                }\r\n                function createCapsuleGeometry(radius, cylinderHeight, segmentsRadius, segmentsHeight) {\r\n                    var geometry = new THREE.CylinderBufferGeometry(radius, radius, cylinderHeight, segmentsRadius, segmentsHeight, true);\r\n                    var upperSphere = new THREE.Mesh(new THREE.SphereBufferGeometry(radius, segmentsRadius, segmentsHeight, 0, Math.PI * 2, 0, Math.PI / 2));\r\n                    var lowerSphere = new THREE.Mesh(new THREE.SphereBufferGeometry(radius, segmentsRadius, segmentsHeight, 0, Math.PI * 2, Math.PI / 2, Math.PI / 2));\r\n                    upperSphere.position.set(0, cylinderHeight / 2, 0);\r\n                    lowerSphere.position.set(0, -cylinderHeight / 2, 0);\r\n                    upperSphere.updateMatrix();\r\n                    lowerSphere.updateMatrix();\r\n                    geometry.merge(upperSphere.geometry, upperSphere.matrix);\r\n                    geometry.merge(lowerSphere.geometry, lowerSphere.matrix);\r\n                    return geometry;\r\n                }\r\n                for (var i = 0, il = bodies.length; i < il; i++) {\r\n                    var param = bodies[i].params;\r\n                    this.add(new THREE.Mesh(createGeometry(param), this.materials[param.type]));\r\n                }\r\n            }\r\n        });\r\n        return MMDPhysics;\r\n    }();\r\n\r\n    return  threex.animation.MMDPhysics = MMDPhysics;\r\n});"]}