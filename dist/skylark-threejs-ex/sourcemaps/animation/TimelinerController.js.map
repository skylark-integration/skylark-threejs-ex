{"version":3,"sources":["animation/TimelinerController.js"],"names":["define","THREE","threex","TimelinerController","scene","trackInfo","onUpdate","this","_scene","_trackInfo","_onUpdate","_mixer","AnimationMixer","_clip","_action","_tracks","_propRefs","_channelNames","prototype","constructor","init","tracks","i","n","length","spec","push","_addTrack","type","propertyPath","initialValue","interpolation","AnimationClip","clipAction","play","setDisplayTime","time","update","setDuration","duration","getChannelNames","getChannelKeyTimes","channelName","times","setKeyframe","track","index","Timeliner","binarySearch","values","stride","getValueSize","offset","nTimes","nValues","e","getValue","delKeyframe","pop","moveKeyframe","delta","moveRemaining","endAt","needsSort","_sort","serialize","result","channels","names","name","deserialize","structs","data","_setArray","order","AnimationUtils","getKeyframeOrder","sortedArray","dst","src","apply","prop","Array","slice","call","PropertyBinding","animation"],"mappings":"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","file":"../../animation/TimelinerController.js","sourcesContent":["define([\n    \"skylark-threejs\",\n    \"../threex\"\n], function (\n    THREE,\n    threex\n) {\n    'use strict';\n    var TimelinerController = function TimelinerController(scene, trackInfo, onUpdate) {\n        this._scene = scene;\n        this._trackInfo = trackInfo;\n        this._onUpdate = onUpdate;\n        this._mixer = new THREE.AnimationMixer(scene);\n        this._clip = null;\n        this._action = null;\n        this._tracks = {};\n        this._propRefs = {};\n        this._channelNames = [];\n    };\n    TimelinerController.prototype = {\n        constructor: TimelinerController,\n        init: function () {\n            var tracks = [], trackInfo = this._trackInfo;\n            for (var i = 0, n = trackInfo.length; i !== n; ++i) {\n                var spec = trackInfo[i];\n                tracks.push(this._addTrack(spec.type, spec.propertyPath, spec.initialValue, spec.interpolation));\n            }\n            this._clip = new THREE.AnimationClip('editclip', 0, tracks);\n            this._action = this._mixer.clipAction(this._clip).play();\n        },\n        setDisplayTime: function (time) {\n            this._action.time = time;\n            this._mixer.update(0);\n            this._onUpdate();\n        },\n        setDuration: function (duration) {\n            this._clip.duration = duration;\n        },\n        getChannelNames: function () {\n            return this._channelNames;\n        },\n        getChannelKeyTimes: function (channelName) {\n            return this._tracks[channelName].times;\n        },\n        setKeyframe: function (channelName, time) {\n            var track = this._tracks[channelName], times = track.times, index = Timeliner.binarySearch(times, time), values = track.values, stride = track.getValueSize(), offset = index * stride;\n            if (index < 0) {\n                index = ~index;\n                offset = index * stride;\n                var nTimes = times.length + 1, nValues = values.length + stride;\n                for (var i = nTimes - 1; i !== index; --i) {\n                    times[i] = times[i - 1];\n                }\n                for (var i = nValues - 1, e = offset + stride - 1; i !== e; --i) {\n                    values[i] = values[i - stride];\n                }\n            }\n            times[index] = time;\n            this._propRefs[channelName].getValue(values, offset);\n        },\n        delKeyframe: function (channelName, time) {\n            var track = this._tracks[channelName], times = track.times, index = Timeliner.binarySearch(times, time);\n            if (times.length > 1 && index >= 0) {\n                var nTimes = times.length - 1, values = track.values, stride = track.getValueSize(), nValues = values.length - stride;\n                for (var i = index; i !== nTimes; ++i) {\n                    times[i] = times[i + 1];\n                }\n                times.pop();\n                for (var offset = index * stride; offset !== nValues; ++offset) {\n                    values[offset] = values[offset + stride];\n                }\n                values.length = nValues;\n            }\n        },\n        moveKeyframe: function (channelName, time, delta, moveRemaining) {\n            var track = this._tracks[channelName], times = track.times, index = Timeliner.binarySearch(times, time);\n            if (index >= 0) {\n                var endAt = moveRemaining ? times.length : index + 1, needsSort = times[index - 1] <= time || !moveRemaining && time >= times[index + 1];\n                while (index !== endAt)\n                    times[index++] += delta;\n                if (needsSort)\n                    this._sort(track);\n            }\n        },\n        serialize: function () {\n            var result = {\n                    duration: this._clip.duration,\n                    channels: {}\n                }, names = this._channelNames, tracks = this._tracks, channels = result.channels;\n            for (var i = 0, n = names.length; i !== n; ++i) {\n                var name = names[i], track = tracks[name];\n                channels[name] = {\n                    times: track.times,\n                    values: track.values\n                };\n            }\n            return result;\n        },\n        deserialize: function (structs) {\n            var names = this._channelNames, tracks = this._tracks, channels = structs.channels;\n            this.setDuration(structs.duration);\n            for (var i = 0, n = names.length; i !== n; ++i) {\n                var name = names[i], track = tracks[name], data = channels[name];\n                this._setArray(track.times, data.times);\n                this._setArray(track.values, data.values);\n            }\n            this.setDisplayTime(this._mixer.time);\n        },\n        _sort: function (track) {\n            var times = track.times, order = THREE.AnimationUtils.getKeyframeOrder(times);\n            this._setArray(times, THREE.AnimationUtils.sortedArray(times, 1, order));\n            var values = track.values, stride = track.getValueSize();\n            this._setArray(values, THREE.AnimationUtils.sortedArray(values, stride, order));\n        },\n        _setArray: function (dst, src) {\n            dst.length = 0;\n            dst.push.apply(dst, src);\n        },\n        _addTrack: function (type, prop, initialValue, interpolation) {\n            var track = new type(prop, [0], initialValue, interpolation);\n            track.times = Array.prototype.slice.call(track.times);\n            track.values = Array.prototype.slice.call(track.values);\n            this._channelNames.push(prop);\n            this._tracks[prop] = track;\n            this._propRefs[prop] = new THREE.PropertyBinding(this._scene, prop);\n            return track;\n        }\n    };\n\n    return threex.animation.TimelinerController = TimelinerController;\n});"]}