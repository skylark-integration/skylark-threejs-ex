{"version":3,"sources":["loaders/GCodeLoader.js"],"names":["define","THREE","threex","GCodeLoader","manager","Loader","call","this","splitLayer","prototype","Object","assign","create","constructor","load","url","onLoad","onProgress","onError","self","loader","FileLoader","setPath","path","text","parse","data","state","x","y","z","e","f","extruding","relative","layers","currentLayer","undefined","pathMaterial","LineBasicMaterial","color","name","extrudingMaterial","newLayer","line","vertex","pathVertex","push","delta","v1","v2","absolute","p1","p2","lines","replace","split","i","length","tokens","cmd","toUpperCase","args","splice","forEach","token","key","toLowerCase","value","parseFloat","substring","addObject","geometry","BufferGeometry","setAttribute","Float32BufferAttribute","segments","LineSegments","object","add","Group","layer","concat","quaternion","setFromEuler","Euler","Math","PI","loaders"],"mappings":"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","file":"../../loaders/GCodeLoader.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var GCodeLoader = function (manager) {\r\n        THREE.Loader.call(this, manager);\r\n        this.splitLayer = false;\r\n    };\r\n    GCodeLoader.prototype = Object.assign(Object.create(THREE.Loader.prototype), {\r\n        constructor: GCodeLoader,\r\n        load: function (url, onLoad, onProgress, onError) {\r\n            var self = this;\r\n            var loader = new THREE.FileLoader(self.manager);\r\n            loader.setPath(self.path);\r\n            loader.load(url, function (text) {\r\n                onLoad(self.parse(text));\r\n            }, onProgress, onError);\r\n        },\r\n        parse: function (data) {\r\n            var state = {\r\n                x: 0,\r\n                y: 0,\r\n                z: 0,\r\n                e: 0,\r\n                f: 0,\r\n                extruding: false,\r\n                relative: false\r\n            };\r\n            var layers = [];\r\n            var currentLayer = undefined;\r\n            var pathMaterial = new THREE.LineBasicMaterial({ color: 16711680 });\r\n            pathMaterial.name = 'path';\r\n            var extrudingMaterial = new THREE.LineBasicMaterial({ color: 65280 });\r\n            extrudingMaterial.name = 'extruded';\r\n            function newLayer(line) {\r\n                currentLayer = {\r\n                    vertex: [],\r\n                    pathVertex: [],\r\n                    z: line.z\r\n                };\r\n                layers.push(currentLayer);\r\n            }\r\n            function addSegment(p1, p2) {\r\n                if (currentLayer === undefined) {\r\n                    newLayer(p1);\r\n                }\r\n                if (line.extruding) {\r\n                    currentLayer.vertex.push(p1.x, p1.y, p1.z);\r\n                    currentLayer.vertex.push(p2.x, p2.y, p2.z);\r\n                } else {\r\n                    currentLayer.pathVertex.push(p1.x, p1.y, p1.z);\r\n                    currentLayer.pathVertex.push(p2.x, p2.y, p2.z);\r\n                }\r\n            }\r\n            function delta(v1, v2) {\r\n                return state.relative ? v2 : v2 - v1;\r\n            }\r\n            function absolute(v1, v2) {\r\n                return state.relative ? v1 + v2 : v2;\r\n            }\r\n            var lines = data.replace(/;.+/g, '').split('\\n');\r\n            for (var i = 0; i < lines.length; i++) {\r\n                var tokens = lines[i].split(' ');\r\n                var cmd = tokens[0].toUpperCase();\r\n                var args = {};\r\n                tokens.splice(1).forEach(function (token) {\r\n                    if (token[0] !== undefined) {\r\n                        var key = token[0].toLowerCase();\r\n                        var value = parseFloat(token.substring(1));\r\n                        args[key] = value;\r\n                    }\r\n                });\r\n                if (cmd === 'G0' || cmd === 'G1') {\r\n                    var line = {\r\n                        x: args.x !== undefined ? absolute(state.x, args.x) : state.x,\r\n                        y: args.y !== undefined ? absolute(state.y, args.y) : state.y,\r\n                        z: args.z !== undefined ? absolute(state.z, args.z) : state.z,\r\n                        e: args.e !== undefined ? absolute(state.e, args.e) : state.e,\r\n                        f: args.f !== undefined ? absolute(state.f, args.f) : state.f\r\n                    };\r\n                    if (delta(state.e, line.e) > 0) {\r\n                        line.extruding = delta(state.e, line.e) > 0;\r\n                        if (currentLayer == undefined || line.z != currentLayer.z) {\r\n                            newLayer(line);\r\n                        }\r\n                    }\r\n                    addSegment(state, line);\r\n                    state = line;\r\n                } else if (cmd === 'G2' || cmd === 'G3') {\r\n                } else if (cmd === 'G90') {\r\n                    state.relative = false;\r\n                } else if (cmd === 'G91') {\r\n                    state.relative = true;\r\n                } else if (cmd === 'G92') {\r\n                    var line = state;\r\n                    line.x = args.x !== undefined ? args.x : line.x;\r\n                    line.y = args.y !== undefined ? args.y : line.y;\r\n                    line.z = args.z !== undefined ? args.z : line.z;\r\n                    line.e = args.e !== undefined ? args.e : line.e;\r\n                    state = line;\r\n                } else {\r\n                }\r\n            }\r\n            function addObject(vertex, extruding) {\r\n                var geometry = new THREE.BufferGeometry();\r\n                geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertex, 3));\r\n                var segments = new THREE.LineSegments(geometry, extruding ? extrudingMaterial : pathMaterial);\r\n                segments.name = 'layer' + i;\r\n                object.add(segments);\r\n            }\r\n            var object = new THREE.Group();\r\n            object.name = 'gcode';\r\n            if (this.splitLayer) {\r\n                for (var i = 0; i < layers.length; i++) {\r\n                    var layer = layers[i];\r\n                    addObject(layer.vertex, true);\r\n                    addObject(layer.pathVertex, false);\r\n                }\r\n            } else {\r\n                var vertex = [], pathVertex = [];\r\n                for (var i = 0; i < layers.length; i++) {\r\n                    var layer = layers[i];\r\n                    vertex = vertex.concat(layer.vertex);\r\n                    pathVertex = pathVertex.concat(layer.pathVertex);\r\n                }\r\n                addObject(vertex, true);\r\n                addObject(pathVertex, false);\r\n            }\r\n            object.quaternion.setFromEuler(new THREE.Euler(-Math.PI / 2, 0, 0));\r\n            return object;\r\n        }\r\n    });\r\n    return threex.loaders.GCodeLoader = GCodeLoader;\r\n});"]}