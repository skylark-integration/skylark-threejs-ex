{"version":3,"sources":["loaders/PRWMLoader.js"],"names":["define","THREE","bigEndianPlatform","isBigEndianPlatform","buffer","ArrayBuffer","uint8Array","Uint8Array","uint16Array","Uint16Array","InvertedEncodingTypes","Float32Array","Int8Array","Int16Array","Int32Array","Uint32Array","getMethods","Float64Array","copyFromBuffer","sourceArrayBuffer","viewType","position","length","fromBigEndian","result","bytesPerElement","BYTES_PER_ELEMENT","readView","DataView","getMethod","name","littleEndian","i","PRWMLoader","manager","Loader","call","this","prototype","Object","assign","create","constructor","load","url","onLoad","onProgress","onError","scope","loader","FileLoader","setPath","path","setResponseType","replace","arrayBuffer","parse","attribute","data","array","version","flags","indexedGeometry","indicesType","bigEndian","attributesNumber","valuesNumber","indicesNumber","Error","attributeName","char","attributeType","cardinality","arrayType","values","indices","pos","attributes","String","fromCharCode","Math","ceil","type","decodePrwm","attributesKey","keys","bufferGeometry","BufferGeometry","setAttribute","BufferAttribute","normalized","setIndex"],"mappings":"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","file":"../../loaders/PRWMLoader.js","sourcesContent":["define([\n    \"skylark-threejs\"\n], function (THREE) {\n    'use strict';\n    var PRWMLoader = function () {\n        var bigEndianPlatform = null;\n        function isBigEndianPlatform() {\n            if (bigEndianPlatform === null) {\n                var buffer = new ArrayBuffer(2), uint8Array = new Uint8Array(buffer), uint16Array = new Uint16Array(buffer);\n                uint8Array[0] = 170;\n                uint8Array[1] = 187;\n                bigEndianPlatform = uint16Array[0] === 43707;\n            }\n            return bigEndianPlatform;\n        }\n        var InvertedEncodingTypes = [\n            null,\n            Float32Array,\n            null,\n            Int8Array,\n            Int16Array,\n            null,\n            Int32Array,\n            Uint8Array,\n            Uint16Array,\n            null,\n            Uint32Array\n        ];\n        var getMethods = {\n            Uint16Array: 'getUint16',\n            Uint32Array: 'getUint32',\n            Int16Array: 'getInt16',\n            Int32Array: 'getInt32',\n            Float32Array: 'getFloat32',\n            Float64Array: 'getFloat64'\n        };\n        function copyFromBuffer(sourceArrayBuffer, viewType, position, length, fromBigEndian) {\n            var bytesPerElement = viewType.BYTES_PER_ELEMENT, result;\n            if (fromBigEndian === isBigEndianPlatform() || bytesPerElement === 1) {\n                result = new viewType(sourceArrayBuffer, position, length);\n            } else {\n                var readView = new DataView(sourceArrayBuffer, position, length * bytesPerElement), getMethod = getMethods[viewType.name], littleEndian = !fromBigEndian, i = 0;\n                result = new viewType(length);\n                for (; i < length; i++) {\n                    result[i] = readView[getMethod](i * bytesPerElement, littleEndian);\n                }\n            }\n            return result;\n        }\n        function decodePrwm(buffer) {\n            var array = new Uint8Array(buffer), version = array[0], flags = array[1], indexedGeometry = !!(flags >> 7 & 1), indicesType = flags >> 6 & 1, bigEndian = (flags >> 5 & 1) === 1, attributesNumber = flags & 31, valuesNumber = 0, indicesNumber = 0;\n            if (bigEndian) {\n                valuesNumber = (array[2] << 16) + (array[3] << 8) + array[4];\n                indicesNumber = (array[5] << 16) + (array[6] << 8) + array[7];\n            } else {\n                valuesNumber = array[2] + (array[3] << 8) + (array[4] << 16);\n                indicesNumber = array[5] + (array[6] << 8) + (array[7] << 16);\n            }\n            if (version === 0) {\n                throw new Error('PRWM decoder: Invalid format version: 0');\n            } else if (version !== 1) {\n                throw new Error('PRWM decoder: Unsupported format version: ' + version);\n            }\n            if (!indexedGeometry) {\n                if (indicesType !== 0) {\n                    throw new Error('PRWM decoder: Indices type must be set to 0 for non-indexed geometries');\n                } else if (indicesNumber !== 0) {\n                    throw new Error('PRWM decoder: Number of indices must be set to 0 for non-indexed geometries');\n                }\n            }\n            var pos = 8;\n            var attributes = {}, attributeName, char, attributeType, cardinality, encodingType, arrayType, values, indices, i;\n            for (i = 0; i < attributesNumber; i++) {\n                attributeName = '';\n                while (pos < array.length) {\n                    char = array[pos];\n                    pos++;\n                    if (char === 0) {\n                        break;\n                    } else {\n                        attributeName += String.fromCharCode(char);\n                    }\n                }\n                flags = array[pos];\n                attributeType = flags >> 7 & 1;\n                cardinality = (flags >> 4 & 3) + 1;\n                encodingType = flags & 15;\n                arrayType = InvertedEncodingTypes[encodingType];\n                pos++;\n                pos = Math.ceil(pos / 4) * 4;\n                values = copyFromBuffer(buffer, arrayType, pos, cardinality * valuesNumber, bigEndian);\n                pos += arrayType.BYTES_PER_ELEMENT * cardinality * valuesNumber;\n                attributes[attributeName] = {\n                    type: attributeType,\n                    cardinality: cardinality,\n                    values: values\n                };\n            }\n            pos = Math.ceil(pos / 4) * 4;\n            indices = null;\n            if (indexedGeometry) {\n                indices = copyFromBuffer(buffer, indicesType === 1 ? Uint32Array : Uint16Array, pos, indicesNumber, bigEndian);\n            }\n            return {\n                version: version,\n                attributes: attributes,\n                indices: indices\n            };\n        }\n        function PRWMLoader(manager) {\n            THREE.Loader.call(this, manager);\n        }\n        PRWMLoader.prototype = Object.assign(Object.create(THREE.Loader.prototype), {\n            constructor: PRWMLoader,\n            load: function (url, onLoad, onProgress, onError) {\n                var scope = this;\n                var loader = new THREE.FileLoader(scope.manager);\n                loader.setPath(scope.path);\n                loader.setResponseType('arraybuffer');\n                url = url.replace(/\\*/g, isBigEndianPlatform() ? 'be' : 'le');\n                loader.load(url, function (arrayBuffer) {\n                    onLoad(scope.parse(arrayBuffer));\n                }, onProgress, onError);\n            },\n            parse: function (arrayBuffer) {\n                var data = decodePrwm(arrayBuffer), attributesKey = Object.keys(data.attributes), bufferGeometry = new THREE.BufferGeometry(), attribute, i;\n                for (i = 0; i < attributesKey.length; i++) {\n                    attribute = data.attributes[attributesKey[i]];\n                    bufferGeometry.setAttribute(attributesKey[i], new THREE.BufferAttribute(attribute.values, attribute.cardinality, attribute.normalized));\n                }\n                if (data.indices !== null) {\n                    bufferGeometry.setIndex(new THREE.BufferAttribute(data.indices, 1));\n                }\n                return bufferGeometry;\n            }\n        });\n        PRWMLoader.isBigEndianPlatform = function () {\n            return isBigEndianPlatform();\n        };\n        return PRWMLoader;\n    }();\n    return PRWMLoader;\n});"]}