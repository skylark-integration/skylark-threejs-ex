{"version":3,"sources":["loaders/LWOLoader.js"],"names":["define","THREE","threex","LWO2Parser","IFFParser","this","IFF","LWO3Parser","debugger","Debugger","DataViewReader","buffer","dv","DataView","offset","active","depth","formList","isEven","num","stringOffset","string","length","lwoTree","prototype","constructor","parseBlock","reader","closeForms","blockID","getIDTag","getUint32","byteLength","getUint16","dataOffset","parseForm","skipped","skip","parseSurfaceLwo2","parseClipLwo2","currentNode","getInt32","parseObjectTag","parseLayer","parsePoints","parseVertexMapping","getVariableLengthIndex","parsePolygonList","parseTagStrings","parsePolygonTagMapping","currentForm","description","getString","comment","channelName","wrap","w","h","index","imageIndex","referenceObject","referenceObjectID","currentSurface","surfaceShaderName","surfaceCustomAOVName","disabled","realName","refName","nodes","nodeName","push","inputNodeName","inputName","inputOutputName","fileName","textureChannel","maxSmoothingAngle","getFloat32","attributes","smooth","undefined","value","getFloat32Array","Luminosity","Specular","Diffuse","Reflection","Glossiness","opacity","bumpStrength","side","reflectionMap","refractiveIndex","refractionMap","UVChannel","widthWrappingMode","heightWrappingMode","parseUnknownCHUNK","node","nodeID","log","currentFormEnd","parentForm","imageMapIndex","parse","tree","materials","layers","tags","textures","currentLayer","parseTopForm","format","parser","endOfFile","[object Object]","type","console","warn","skipForm","parseTextureNodeAttribute","parseEnvelope","parseClip","parseImage","referenceTexture","parseImageStateForm","parseSurfaceForm","parseValueForm","parseSubNode","setupForm","parseConnections","parseEntryForm","parseImageMap","parseXVAL","parseXVAL3","parseUnknownForm","from","to","LoaderUtils","decodeText","Uint8Array","name","surface","connections","source","valueType","getUint64","getFloat64","getFloat64Array","mipMapLevel","maps","map","scale","position","rotation","falloff","amplitude","uTiles","vTiles","setOffset","texture","tag","n_length","endOffset","x","y","z","objectTags","tagString","layer","number","flags","pivot","parsedLength","parent","currentPoints","i","discontinuous","finalOffset","remainingLength","parseUVMapping","parseMorphTargets","uvIndices","polyIndices","uvs","discontinuousUVs","indices","points","morphTargets","polygonDimensions","numverts","j","geometryData","vertexIndices","geometry","getStringArray","parseMaterialIndices","materialIndices","polygonIndex","materialIndex","data","size","error","getUint8","a","littleEndian","firstByte","currentChar","len","split","filter","Boolean","enable","nodeType","repeat","splice","LWOLoader","manager","parameters","Loader","call","resourcePath","LWOTreeParser","textureLoader","MaterialParser","GeometryParser","Object","assign","create","load","url","onLoad","onProgress","onError","self","path","dir","indexOf","substr","extractParentUrl","modelName","pop","loader","FileLoader","setPath","setResponseType","iffBuffer","TextureLoader","setCrossOrigin","crossOrigin","defaultLayerName","meshes","parseLayers","finalMeshes","geometryParser","forEach","mesh","parseMesh","add","applyPivots","getMaterials","userData","matNames","duplicateUVs","Points","LineSegments","Mesh","traverse","child","parentPivot","namesArray","getMaterialByName","mat","spec","color","PointsMaterial","LineBasicMaterial","filtered","m","Array","isArray","material","aoMap","setAttribute","BufferAttribute","uv","array","parseMaterial","parseMaterialLwo2","materialData","params","getSide","flatShading","getSmooth","parseTextureNodes","parseAttributeImageMaps","parseAttributes","parseEnvMap","getMaterialType","MeshPhongMaterial","BackSide","FrontSide","DoubleSide","materialConnections","matNode","getNodeByRefName","envMap","textureNodes","loadTexture","wrapS","getWrappingType","wrapT","roughnessMap","roughness","specularMap","specular","emissiveMap","emissive","metalnessMap","metalness","alphaMap","transparent","normalMap","normalScale","Vector2","bumpMap","attribute","mapData","getTexturePathByIndex","Color","fromArray","Transparency","bumpScale","refractionRatio","parsePhysicalAttributes","parseStandardAttributes","parsePhongAttributes","Clearcoat","clearcoat","clearcoatRoughness","Luminous","emissiveIntensity","Roughness","Metallic","multiplyScalar","reflectivity","combine","AddOperation","setScalar","lerp","clone","shininess","Math","pow","mapping","EquirectangularRefractionMapping","EquirectangularReflectionMapping","ClampToEdgeWrapping","RepeatWrapping","MirroredRepeatWrapping","nodeData","MeshPhysicalMaterial","MeshStandardMaterial","geoData","BufferGeometry","Float32BufferAttribute","splitIndices","setIndex","parseGroups","computeVertexNormals","parseUVs","translate","remappedIndices","dim","k","elemSize","prevMaterialIndex","splitMaterialIndices","indexNum","indexPairs","prevStart","currentCount","currentIndex","addGroup","groups","remappedUVs","count","remappedPoints","slice","morphAttributes","morphPoints","morphIndices","morphTargetsRelative","loaders"],"mappings":"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","file":"../../loaders/LWOLoader.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    function LWO2Parser(IFFParser) {\r\n        this.IFF = IFFParser;\r\n    }\r\n    LWO2Parser.prototype = {\r\n        constructor: LWO2Parser,\r\n        parseBlock: function () {\r\n            this.IFF.debugger.offset = this.IFF.reader.offset;\r\n            this.IFF.debugger.closeForms();\r\n            var blockID = this.IFF.reader.getIDTag();\r\n            var length = this.IFF.reader.getUint32();\r\n            if (length > this.IFF.reader.dv.byteLength - this.IFF.reader.offset) {\r\n                this.IFF.reader.offset -= 4;\r\n                length = this.IFF.reader.getUint16();\r\n            }\r\n            this.IFF.debugger.dataOffset = this.IFF.reader.offset;\r\n            this.IFF.debugger.length = length;\r\n            switch (blockID) {\r\n            case 'FORM':\r\n                this.IFF.parseForm(length);\r\n                break;\r\n            case 'ICON':\r\n            case 'VMPA':\r\n            case 'BBOX':\r\n            case 'NORM':\r\n            case 'PRE ':\r\n            case 'POST':\r\n            case 'KEY ':\r\n            case 'SPAN':\r\n            case 'TIME':\r\n            case 'CLRS':\r\n            case 'CLRA':\r\n            case 'FILT':\r\n            case 'DITH':\r\n            case 'CONT':\r\n            case 'BRIT':\r\n            case 'SATR':\r\n            case 'HUE ':\r\n            case 'GAMM':\r\n            case 'NEGA':\r\n            case 'IFLT':\r\n            case 'PFLT':\r\n            case 'PROJ':\r\n            case 'AXIS':\r\n            case 'AAST':\r\n            case 'PIXB':\r\n            case 'AUVO':\r\n            case 'STCK':\r\n            case 'PROC':\r\n            case 'VALU':\r\n            case 'FUNC':\r\n            case 'PNAM':\r\n            case 'INAM':\r\n            case 'GRST':\r\n            case 'GREN':\r\n            case 'GRPT':\r\n            case 'FKEY':\r\n            case 'IKEY':\r\n            case 'CSYS':\r\n            case 'OPAQ':\r\n            case 'CMAP':\r\n            case 'NLOC':\r\n            case 'NZOM':\r\n            case 'NVER':\r\n            case 'NSRV':\r\n            case 'NVSK':\r\n            case 'NCRD':\r\n            case 'WRPW':\r\n            case 'WRPH':\r\n            case 'NMOD':\r\n            case 'NPRW':\r\n            case 'NPLA':\r\n            case 'NODS':\r\n            case 'VERS':\r\n            case 'ENUM':\r\n            case 'TAG ':\r\n            case 'OPAC':\r\n            case 'CGMD':\r\n            case 'CGTY':\r\n            case 'CGST':\r\n            case 'CGEN':\r\n            case 'CGTS':\r\n            case 'CGTE':\r\n            case 'OSMP':\r\n            case 'OMDE':\r\n            case 'OUTR':\r\n            case 'FLAG':\r\n            case 'TRNL':\r\n            case 'GLOW':\r\n            case 'GVAL':\r\n            case 'SHRP':\r\n            case 'RFOP':\r\n            case 'RSAN':\r\n            case 'TROP':\r\n            case 'RBLR':\r\n            case 'TBLR':\r\n            case 'CLRH':\r\n            case 'CLRF':\r\n            case 'ADTR':\r\n            case 'LINE':\r\n            case 'ALPH':\r\n            case 'VCOL':\r\n            case 'ENAB':\r\n                this.IFF.debugger.skipped = true;\r\n                this.IFF.reader.skip(length);\r\n                break;\r\n            case 'SURF':\r\n                this.IFF.parseSurfaceLwo2(length);\r\n                break;\r\n            case 'CLIP':\r\n                this.IFF.parseClipLwo2(length);\r\n                break;\r\n            case 'IPIX':\r\n            case 'IMIP':\r\n            case 'IMOD':\r\n            case 'AMOD':\r\n            case 'IINV':\r\n            case 'INCR':\r\n            case 'IAXS':\r\n            case 'IFOT':\r\n            case 'ITIM':\r\n            case 'IWRL':\r\n            case 'IUTI':\r\n            case 'IINX':\r\n            case 'IINY':\r\n            case 'IINZ':\r\n            case 'IREF':\r\n                if (length === 4)\r\n                    this.IFF.currentNode[blockID] = this.IFF.reader.getInt32();\r\n                else\r\n                    this.IFF.reader.skip(length);\r\n                break;\r\n            case 'OTAG':\r\n                this.IFF.parseObjectTag();\r\n                break;\r\n            case 'LAYR':\r\n                this.IFF.parseLayer(length);\r\n                break;\r\n            case 'PNTS':\r\n                this.IFF.parsePoints(length);\r\n                break;\r\n            case 'VMAP':\r\n                this.IFF.parseVertexMapping(length);\r\n                break;\r\n            case 'AUVU':\r\n            case 'AUVN':\r\n                this.IFF.reader.skip(length - 1);\r\n                this.IFF.reader.getVariableLengthIndex();\r\n                break;\r\n            case 'POLS':\r\n                this.IFF.parsePolygonList(length);\r\n                break;\r\n            case 'TAGS':\r\n                this.IFF.parseTagStrings(length);\r\n                break;\r\n            case 'PTAG':\r\n                this.IFF.parsePolygonTagMapping(length);\r\n                break;\r\n            case 'VMAD':\r\n                this.IFF.parseVertexMapping(length, true);\r\n                break;\r\n            case 'DESC':\r\n                this.IFF.currentForm.description = this.IFF.reader.getString();\r\n                break;\r\n            case 'TEXT':\r\n            case 'CMNT':\r\n            case 'NCOM':\r\n                this.IFF.currentForm.comment = this.IFF.reader.getString();\r\n                break;\r\n            case 'NAME':\r\n                this.IFF.currentForm.channelName = this.IFF.reader.getString();\r\n                break;\r\n            case 'WRAP':\r\n                this.IFF.currentForm.wrap = {\r\n                    w: this.IFF.reader.getUint16(),\r\n                    h: this.IFF.reader.getUint16()\r\n                };\r\n                break;\r\n            case 'IMAG':\r\n                var index = this.IFF.reader.getVariableLengthIndex();\r\n                this.IFF.currentForm.imageIndex = index;\r\n                break;\r\n            case 'OREF':\r\n                this.IFF.currentForm.referenceObject = this.IFF.reader.getString();\r\n                break;\r\n            case 'ROID':\r\n                this.IFF.currentForm.referenceObjectID = this.IFF.reader.getUint32();\r\n                break;\r\n            case 'SSHN':\r\n                this.IFF.currentSurface.surfaceShaderName = this.IFF.reader.getString();\r\n                break;\r\n            case 'AOVN':\r\n                this.IFF.currentSurface.surfaceCustomAOVName = this.IFF.reader.getString();\r\n                break;\r\n            case 'NSTA':\r\n                this.IFF.currentForm.disabled = this.IFF.reader.getUint16();\r\n                break;\r\n            case 'NRNM':\r\n                this.IFF.currentForm.realName = this.IFF.reader.getString();\r\n                break;\r\n            case 'NNME':\r\n                this.IFF.currentForm.refName = this.IFF.reader.getString();\r\n                this.IFF.currentSurface.nodes[this.IFF.currentForm.refName] = this.IFF.currentForm;\r\n                break;\r\n            case 'INME':\r\n                if (!this.IFF.currentForm.nodeName)\r\n                    this.IFF.currentForm.nodeName = [];\r\n                this.IFF.currentForm.nodeName.push(this.IFF.reader.getString());\r\n                break;\r\n            case 'IINN':\r\n                if (!this.IFF.currentForm.inputNodeName)\r\n                    this.IFF.currentForm.inputNodeName = [];\r\n                this.IFF.currentForm.inputNodeName.push(this.IFF.reader.getString());\r\n                break;\r\n            case 'IINM':\r\n                if (!this.IFF.currentForm.inputName)\r\n                    this.IFF.currentForm.inputName = [];\r\n                this.IFF.currentForm.inputName.push(this.IFF.reader.getString());\r\n                break;\r\n            case 'IONM':\r\n                if (!this.IFF.currentForm.inputOutputName)\r\n                    this.IFF.currentForm.inputOutputName = [];\r\n                this.IFF.currentForm.inputOutputName.push(this.IFF.reader.getString());\r\n                break;\r\n            case 'FNAM':\r\n                this.IFF.currentForm.fileName = this.IFF.reader.getString();\r\n                break;\r\n            case 'CHAN':\r\n                if (length === 4)\r\n                    this.IFF.currentForm.textureChannel = this.IFF.reader.getIDTag();\r\n                else\r\n                    this.IFF.reader.skip(length);\r\n                break;\r\n            case 'SMAN':\r\n                var maxSmoothingAngle = this.IFF.reader.getFloat32();\r\n                this.IFF.currentSurface.attributes.smooth = maxSmoothingAngle < 0 ? false : true;\r\n                break;\r\n            case 'COLR':\r\n                this.IFF.currentSurface.attributes.undefined = { value: this.IFF.reader.getFloat32Array(3) };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'LUMI':\r\n                this.IFF.currentSurface.attributes.Luminosity = { value: this.IFF.reader.getFloat32() };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'SPEC':\r\n                this.IFF.currentSurface.attributes.Specular = { value: this.IFF.reader.getFloat32() };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'DIFF':\r\n                this.IFF.currentSurface.attributes.Diffuse = { value: this.IFF.reader.getFloat32() };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'REFL':\r\n                this.IFF.currentSurface.attributes.Reflection = { value: this.IFF.reader.getFloat32() };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'GLOS':\r\n                this.IFF.currentSurface.attributes.Glossiness = { value: this.IFF.reader.getFloat32() };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'TRAN':\r\n                this.IFF.currentSurface.attributes.opacity = this.IFF.reader.getFloat32();\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'BUMP':\r\n                this.IFF.currentSurface.attributes.bumpStrength = this.IFF.reader.getFloat32();\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'SIDE':\r\n                this.IFF.currentSurface.attributes.side = this.IFF.reader.getUint16();\r\n                break;\r\n            case 'RIMG':\r\n                this.IFF.currentSurface.attributes.reflectionMap = this.IFF.reader.getVariableLengthIndex();\r\n                break;\r\n            case 'RIND':\r\n                this.IFF.currentSurface.attributes.refractiveIndex = this.IFF.reader.getFloat32();\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'TIMG':\r\n                this.IFF.currentSurface.attributes.refractionMap = this.IFF.reader.getVariableLengthIndex();\r\n                break;\r\n            case 'IMAP':\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'TMAP':\r\n                this.IFF.debugger.skipped = true;\r\n                this.IFF.reader.skip(length);\r\n                break;\r\n            case 'IUVI':\r\n                this.IFF.currentNode.UVChannel = this.IFF.reader.getString(length);\r\n                break;\r\n            case 'IUTL':\r\n                this.IFF.currentNode.widthWrappingMode = this.IFF.reader.getUint32();\r\n                break;\r\n            case 'IVTL':\r\n                this.IFF.currentNode.heightWrappingMode = this.IFF.reader.getUint32();\r\n                break;\r\n            case 'BLOK':\r\n                break;\r\n            default:\r\n                this.IFF.parseUnknownCHUNK(blockID, length);\r\n            }\r\n            if (blockID != 'FORM') {\r\n                this.IFF.debugger.node = 1;\r\n                this.IFF.debugger.nodeID = blockID;\r\n                this.IFF.debugger.log();\r\n            }\r\n            if (this.IFF.reader.offset >= this.IFF.currentFormEnd) {\r\n                this.IFF.currentForm = this.IFF.parentForm;\r\n            }\r\n        }\r\n    };\r\n    function LWO3Parser(IFFParser) {\r\n        this.IFF = IFFParser;\r\n    }\r\n    LWO3Parser.prototype = {\r\n        constructor: LWO3Parser,\r\n        parseBlock: function () {\r\n            this.IFF.debugger.offset = this.IFF.reader.offset;\r\n            this.IFF.debugger.closeForms();\r\n            var blockID = this.IFF.reader.getIDTag();\r\n            var length = this.IFF.reader.getUint32();\r\n            this.IFF.debugger.dataOffset = this.IFF.reader.offset;\r\n            this.IFF.debugger.length = length;\r\n            switch (blockID) {\r\n            case 'FORM':\r\n                this.IFF.parseForm(length);\r\n                break;\r\n            case 'ICON':\r\n            case 'VMPA':\r\n            case 'BBOX':\r\n            case 'NORM':\r\n            case 'PRE ':\r\n            case 'POST':\r\n            case 'KEY ':\r\n            case 'SPAN':\r\n            case 'TIME':\r\n            case 'CLRS':\r\n            case 'CLRA':\r\n            case 'FILT':\r\n            case 'DITH':\r\n            case 'CONT':\r\n            case 'BRIT':\r\n            case 'SATR':\r\n            case 'HUE ':\r\n            case 'GAMM':\r\n            case 'NEGA':\r\n            case 'IFLT':\r\n            case 'PFLT':\r\n            case 'PROJ':\r\n            case 'AXIS':\r\n            case 'AAST':\r\n            case 'PIXB':\r\n            case 'STCK':\r\n            case 'VALU':\r\n            case 'PNAM':\r\n            case 'INAM':\r\n            case 'GRST':\r\n            case 'GREN':\r\n            case 'GRPT':\r\n            case 'FKEY':\r\n            case 'IKEY':\r\n            case 'CSYS':\r\n            case 'OPAQ':\r\n            case 'CMAP':\r\n            case 'NLOC':\r\n            case 'NZOM':\r\n            case 'NVER':\r\n            case 'NSRV':\r\n            case 'NCRD':\r\n            case 'NMOD':\r\n            case 'NSEL':\r\n            case 'NPRW':\r\n            case 'NPLA':\r\n            case 'VERS':\r\n            case 'ENUM':\r\n            case 'TAG ':\r\n            case 'CGMD':\r\n            case 'CGTY':\r\n            case 'CGST':\r\n            case 'CGEN':\r\n            case 'CGTS':\r\n            case 'CGTE':\r\n            case 'OSMP':\r\n            case 'OMDE':\r\n            case 'OUTR':\r\n            case 'FLAG':\r\n            case 'TRNL':\r\n            case 'SHRP':\r\n            case 'RFOP':\r\n            case 'RSAN':\r\n            case 'TROP':\r\n            case 'RBLR':\r\n            case 'TBLR':\r\n            case 'CLRH':\r\n            case 'CLRF':\r\n            case 'ADTR':\r\n            case 'GLOW':\r\n            case 'LINE':\r\n            case 'ALPH':\r\n            case 'VCOL':\r\n            case 'ENAB':\r\n                this.IFF.debugger.skipped = true;\r\n                this.IFF.reader.skip(length);\r\n                break;\r\n            case 'IPIX':\r\n            case 'IMIP':\r\n            case 'IMOD':\r\n            case 'AMOD':\r\n            case 'IINV':\r\n            case 'INCR':\r\n            case 'IAXS':\r\n            case 'IFOT':\r\n            case 'ITIM':\r\n            case 'IWRL':\r\n            case 'IUTI':\r\n            case 'IINX':\r\n            case 'IINY':\r\n            case 'IINZ':\r\n            case 'IREF':\r\n                if (length === 4)\r\n                    this.IFF.currentNode[blockID] = this.IFF.reader.getInt32();\r\n                else\r\n                    this.IFF.reader.skip(length);\r\n                break;\r\n            case 'OTAG':\r\n                this.IFF.parseObjectTag();\r\n                break;\r\n            case 'LAYR':\r\n                this.IFF.parseLayer(length);\r\n                break;\r\n            case 'PNTS':\r\n                this.IFF.parsePoints(length);\r\n                break;\r\n            case 'VMAP':\r\n                this.IFF.parseVertexMapping(length);\r\n                break;\r\n            case 'POLS':\r\n                this.IFF.parsePolygonList(length);\r\n                break;\r\n            case 'TAGS':\r\n                this.IFF.parseTagStrings(length);\r\n                break;\r\n            case 'PTAG':\r\n                this.IFF.parsePolygonTagMapping(length);\r\n                break;\r\n            case 'VMAD':\r\n                this.IFF.parseVertexMapping(length, true);\r\n                break;\r\n            case 'DESC':\r\n                this.IFF.currentForm.description = this.IFF.reader.getString();\r\n                break;\r\n            case 'TEXT':\r\n            case 'CMNT':\r\n            case 'NCOM':\r\n                this.IFF.currentForm.comment = this.IFF.reader.getString();\r\n                break;\r\n            case 'NAME':\r\n                this.IFF.currentForm.channelName = this.IFF.reader.getString();\r\n                break;\r\n            case 'WRAP':\r\n                this.IFF.currentForm.wrap = {\r\n                    w: this.IFF.reader.getUint16(),\r\n                    h: this.IFF.reader.getUint16()\r\n                };\r\n                break;\r\n            case 'IMAG':\r\n                var index = this.IFF.reader.getVariableLengthIndex();\r\n                this.IFF.currentForm.imageIndex = index;\r\n                break;\r\n            case 'OREF':\r\n                this.IFF.currentForm.referenceObject = this.IFF.reader.getString();\r\n                break;\r\n            case 'ROID':\r\n                this.IFF.currentForm.referenceObjectID = this.IFF.reader.getUint32();\r\n                break;\r\n            case 'SSHN':\r\n                this.IFF.currentSurface.surfaceShaderName = this.IFF.reader.getString();\r\n                break;\r\n            case 'AOVN':\r\n                this.IFF.currentSurface.surfaceCustomAOVName = this.IFF.reader.getString();\r\n                break;\r\n            case 'NSTA':\r\n                this.IFF.currentForm.disabled = this.IFF.reader.getUint16();\r\n                break;\r\n            case 'NRNM':\r\n                this.IFF.currentForm.realName = this.IFF.reader.getString();\r\n                break;\r\n            case 'NNME':\r\n                this.IFF.currentForm.refName = this.IFF.reader.getString();\r\n                this.IFF.currentSurface.nodes[this.IFF.currentForm.refName] = this.IFF.currentForm;\r\n                break;\r\n            case 'INME':\r\n                if (!this.IFF.currentForm.nodeName)\r\n                    this.IFF.currentForm.nodeName = [];\r\n                this.IFF.currentForm.nodeName.push(this.IFF.reader.getString());\r\n                break;\r\n            case 'IINN':\r\n                if (!this.IFF.currentForm.inputNodeName)\r\n                    this.IFF.currentForm.inputNodeName = [];\r\n                this.IFF.currentForm.inputNodeName.push(this.IFF.reader.getString());\r\n                break;\r\n            case 'IINM':\r\n                if (!this.IFF.currentForm.inputName)\r\n                    this.IFF.currentForm.inputName = [];\r\n                this.IFF.currentForm.inputName.push(this.IFF.reader.getString());\r\n                break;\r\n            case 'IONM':\r\n                if (!this.IFF.currentForm.inputOutputName)\r\n                    this.IFF.currentForm.inputOutputName = [];\r\n                this.IFF.currentForm.inputOutputName.push(this.IFF.reader.getString());\r\n                break;\r\n            case 'FNAM':\r\n                this.IFF.currentForm.fileName = this.IFF.reader.getString();\r\n                break;\r\n            case 'CHAN':\r\n                if (length === 4)\r\n                    this.IFF.currentForm.textureChannel = this.IFF.reader.getIDTag();\r\n                else\r\n                    this.IFF.reader.skip(length);\r\n                break;\r\n            case 'SMAN':\r\n                var maxSmoothingAngle = this.IFF.reader.getFloat32();\r\n                this.IFF.currentSurface.attributes.smooth = maxSmoothingAngle < 0 ? false : true;\r\n                break;\r\n            case 'COLR':\r\n                this.IFF.currentSurface.attributes.undefined = { value: this.IFF.reader.getFloat32Array(3) };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'LUMI':\r\n                this.IFF.currentSurface.attributes.Luminosity = { value: this.IFF.reader.getFloat32() };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'SPEC':\r\n                this.IFF.currentSurface.attributes.Specular = { value: this.IFF.reader.getFloat32() };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'DIFF':\r\n                this.IFF.currentSurface.attributes.Diffuse = { value: this.IFF.reader.getFloat32() };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'REFL':\r\n                this.IFF.currentSurface.attributes.Reflection = { value: this.IFF.reader.getFloat32() };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'GLOS':\r\n                this.IFF.currentSurface.attributes.Glossiness = { value: this.IFF.reader.getFloat32() };\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'TRAN':\r\n                this.IFF.currentSurface.attributes.opacity = this.IFF.reader.getFloat32();\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'BUMP':\r\n                this.IFF.currentSurface.attributes.bumpStrength = this.IFF.reader.getFloat32();\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'SIDE':\r\n                this.IFF.currentSurface.attributes.side = this.IFF.reader.getUint16();\r\n                break;\r\n            case 'RIMG':\r\n                this.IFF.currentSurface.attributes.reflectionMap = this.IFF.reader.getVariableLengthIndex();\r\n                break;\r\n            case 'RIND':\r\n                this.IFF.currentSurface.attributes.refractiveIndex = this.IFF.reader.getFloat32();\r\n                this.IFF.reader.skip(2);\r\n                break;\r\n            case 'TIMG':\r\n                this.IFF.currentSurface.attributes.refractionMap = this.IFF.reader.getVariableLengthIndex();\r\n                break;\r\n            case 'IMAP':\r\n                this.IFF.currentSurface.attributes.imageMapIndex = this.IFF.reader.getUint32();\r\n                break;\r\n            case 'IUVI':\r\n                this.IFF.currentNode.UVChannel = this.IFF.reader.getString(length);\r\n                break;\r\n            case 'IUTL':\r\n                this.IFF.currentNode.widthWrappingMode = this.IFF.reader.getUint32();\r\n                break;\r\n            case 'IVTL':\r\n                this.IFF.currentNode.heightWrappingMode = this.IFF.reader.getUint32();\r\n                break;\r\n            default:\r\n                this.IFF.parseUnknownCHUNK(blockID, length);\r\n            }\r\n            if (blockID != 'FORM') {\r\n                this.IFF.debugger.node = 1;\r\n                this.IFF.debugger.nodeID = blockID;\r\n                this.IFF.debugger.log();\r\n            }\r\n            if (this.IFF.reader.offset >= this.IFF.currentFormEnd) {\r\n                this.IFF.currentForm = this.IFF.parentForm;\r\n            }\r\n        }\r\n    };\r\n    function IFFParser() {\r\n        this.debugger = new Debugger();\r\n    }\r\n    IFFParser.prototype = {\r\n        constructor: IFFParser,\r\n        parse: function (buffer) {\r\n            this.reader = new DataViewReader(buffer);\r\n            this.tree = {\r\n                materials: {},\r\n                layers: [],\r\n                tags: [],\r\n                textures: []\r\n            };\r\n            this.currentLayer = this.tree;\r\n            this.currentForm = this.tree;\r\n            this.parseTopForm();\r\n            if (this.tree.format === undefined)\r\n                return;\r\n            if (this.tree.format === 'LWO2') {\r\n                this.parser = new LWO2Parser(this);\r\n                while (!this.reader.endOfFile())\r\n                    this.parser.parseBlock();\r\n            } else if (this.tree.format === 'LWO3') {\r\n                this.parser = new LWO3Parser(this);\r\n                while (!this.reader.endOfFile())\r\n                    this.parser.parseBlock();\r\n            }\r\n            this.debugger.offset = this.reader.offset;\r\n            this.debugger.closeForms();\r\n            return this.tree;\r\n        },\r\n        parseTopForm() {\r\n            this.debugger.offset = this.reader.offset;\r\n            var topForm = this.reader.getIDTag();\r\n            if (topForm !== 'FORM') {\r\n                console.warn('LWOLoader: Top-level FORM missing.');\r\n                return;\r\n            }\r\n            var length = this.reader.getUint32();\r\n            this.debugger.dataOffset = this.reader.offset;\r\n            this.debugger.length = length;\r\n            var type = this.reader.getIDTag();\r\n            if (type === 'LWO2') {\r\n                this.tree.format = type;\r\n            } else if (type === 'LWO3') {\r\n                this.tree.format = type;\r\n            }\r\n            this.debugger.node = 0;\r\n            this.debugger.nodeID = type;\r\n            this.debugger.log();\r\n            return;\r\n        },\r\n        parseForm(length) {\r\n            var type = this.reader.getIDTag();\r\n            switch (type) {\r\n            case 'ISEQ':\r\n            case 'ANIM':\r\n            case 'STCC':\r\n            case 'VPVL':\r\n            case 'VPRM':\r\n            case 'NROT':\r\n            case 'WRPW':\r\n            case 'WRPH':\r\n            case 'FUNC':\r\n            case 'FALL':\r\n            case 'OPAC':\r\n            case 'GRAD':\r\n            case 'ENVS':\r\n            case 'VMOP':\r\n            case 'VMBG':\r\n            case 'OMAX':\r\n            case 'STEX':\r\n            case 'CKBG':\r\n            case 'CKEY':\r\n            case 'VMLA':\r\n            case 'VMLB':\r\n                this.debugger.skipped = true;\r\n                this.skipForm(length);\r\n                break;\r\n            case 'META':\r\n            case 'NNDS':\r\n            case 'NODS':\r\n            case 'NDTA':\r\n            case 'ADAT':\r\n            case 'AOVS':\r\n            case 'BLOK':\r\n            case 'IBGC':\r\n            case 'IOPC':\r\n            case 'IIMG':\r\n            case 'TXTR':\r\n                this.debugger.length = 4;\r\n                this.debugger.skipped = true;\r\n                break;\r\n            case 'IFAL':\r\n            case 'ISCL':\r\n            case 'IPOS':\r\n            case 'IROT':\r\n            case 'IBMP':\r\n            case 'IUTD':\r\n            case 'IVTD':\r\n                this.parseTextureNodeAttribute(type);\r\n                break;\r\n            case 'ENVL':\r\n                this.parseEnvelope(length);\r\n                break;\r\n            case 'CLIP':\r\n                if (this.tree.format === 'LWO2') {\r\n                    this.parseForm(length);\r\n                } else {\r\n                    this.parseClip(length);\r\n                }\r\n                break;\r\n            case 'STIL':\r\n                this.parseImage();\r\n                break;\r\n            case 'XREF':\r\n                this.reader.skip(8);\r\n                this.currentForm.referenceTexture = {\r\n                    index: this.reader.getUint32(),\r\n                    refName: this.reader.getString()\r\n                };\r\n                break;\r\n            case 'IMST':\r\n                this.parseImageStateForm(length);\r\n                break;\r\n            case 'SURF':\r\n                this.parseSurfaceForm(length);\r\n                break;\r\n            case 'VALU':\r\n                this.parseValueForm(length);\r\n                break;\r\n            case 'NTAG':\r\n                this.parseSubNode(length);\r\n                break;\r\n            case 'ATTR':\r\n            case 'SATR':\r\n                this.setupForm('attributes', length);\r\n                break;\r\n            case 'NCON':\r\n                this.parseConnections(length);\r\n                break;\r\n            case 'SSHA':\r\n                this.parentForm = this.currentForm;\r\n                this.currentForm = this.currentSurface;\r\n                this.setupForm('surfaceShader', length);\r\n                break;\r\n            case 'SSHD':\r\n                this.setupForm('surfaceShaderData', length);\r\n                break;\r\n            case 'ENTR':\r\n                this.parseEntryForm(length);\r\n                break;\r\n            case 'IMAP':\r\n                this.parseImageMap(length);\r\n                break;\r\n            case 'TAMP':\r\n                this.parseXVAL('amplitude', length);\r\n                break;\r\n            case 'TMAP':\r\n                this.setupForm('textureMap', length);\r\n                break;\r\n            case 'CNTR':\r\n                this.parseXVAL3('center', length);\r\n                break;\r\n            case 'SIZE':\r\n                this.parseXVAL3('scale', length);\r\n                break;\r\n            case 'ROTA':\r\n                this.parseXVAL3('rotation', length);\r\n                break;\r\n            default:\r\n                this.parseUnknownForm(type, length);\r\n            }\r\n            this.debugger.node = 0;\r\n            this.debugger.nodeID = type;\r\n            this.debugger.log();\r\n        },\r\n        setupForm(type, length) {\r\n            if (!this.currentForm)\r\n                this.currentForm = this.currentNode;\r\n            this.currentFormEnd = this.reader.offset + length;\r\n            this.parentForm = this.currentForm;\r\n            if (!this.currentForm[type]) {\r\n                this.currentForm[type] = {};\r\n                this.currentForm = this.currentForm[type];\r\n            } else {\r\n                console.warn('LWOLoader: form already exists on parent: ', type, this.currentForm);\r\n                this.currentForm = this.currentForm[type];\r\n            }\r\n        },\r\n        skipForm(length) {\r\n            this.reader.skip(length - 4);\r\n        },\r\n        parseUnknownForm(type, length) {\r\n            console.warn('LWOLoader: unknown FORM encountered: ' + type, length);\r\n            printBuffer(this.reader.dv.buffer, this.reader.offset, length - 4);\r\n            this.reader.skip(length - 4);\r\n        },\r\n        parseSurfaceForm(length) {\r\n            this.reader.skip(8);\r\n            var name = this.reader.getString();\r\n            var surface = {\r\n                attributes: {},\r\n                connections: {},\r\n                name: name,\r\n                inputName: name,\r\n                nodes: {},\r\n                source: this.reader.getString()\r\n            };\r\n            this.tree.materials[name] = surface;\r\n            this.currentSurface = surface;\r\n            this.parentForm = this.tree.materials;\r\n            this.currentForm = surface;\r\n            this.currentFormEnd = this.reader.offset + length;\r\n        },\r\n        parseSurfaceLwo2(length) {\r\n            var name = this.reader.getString();\r\n            var surface = {\r\n                attributes: {},\r\n                connections: {},\r\n                name: name,\r\n                nodes: {},\r\n                source: this.reader.getString()\r\n            };\r\n            this.tree.materials[name] = surface;\r\n            this.currentSurface = surface;\r\n            this.parentForm = this.tree.materials;\r\n            this.currentForm = surface;\r\n            this.currentFormEnd = this.reader.offset + length;\r\n        },\r\n        parseSubNode(length) {\r\n            this.reader.skip(8);\r\n            var name = this.reader.getString();\r\n            var node = { name: name };\r\n            this.currentForm = node;\r\n            this.currentNode = node;\r\n            this.currentFormEnd = this.reader.offset + length;\r\n        },\r\n        parseConnections(length) {\r\n            this.currentFormEnd = this.reader.offset + length;\r\n            this.parentForm = this.currentForm;\r\n            this.currentForm = this.currentSurface.connections;\r\n        },\r\n        parseEntryForm(length) {\r\n            this.reader.skip(8);\r\n            var name = this.reader.getString();\r\n            this.currentForm = this.currentNode.attributes;\r\n            this.setupForm(name, length);\r\n        },\r\n        parseValueForm() {\r\n            this.reader.skip(8);\r\n            var valueType = this.reader.getString();\r\n            if (valueType === 'double') {\r\n                this.currentForm.value = this.reader.getUint64();\r\n            } else if (valueType === 'int') {\r\n                this.currentForm.value = this.reader.getUint32();\r\n            } else if (valueType === 'vparam') {\r\n                this.reader.skip(24);\r\n                this.currentForm.value = this.reader.getFloat64();\r\n            } else if (valueType === 'vparam3') {\r\n                this.reader.skip(24);\r\n                this.currentForm.value = this.reader.getFloat64Array(3);\r\n            }\r\n        },\r\n        parseImageStateForm() {\r\n            this.reader.skip(8);\r\n            this.currentForm.mipMapLevel = this.reader.getFloat32();\r\n        },\r\n        parseImageMap(length) {\r\n            this.currentFormEnd = this.reader.offset + length;\r\n            this.parentForm = this.currentForm;\r\n            if (!this.currentForm.maps)\r\n                this.currentForm.maps = [];\r\n            var map = {};\r\n            this.currentForm.maps.push(map);\r\n            this.currentForm = map;\r\n            this.reader.skip(10);\r\n        },\r\n        parseTextureNodeAttribute(type) {\r\n            this.reader.skip(28);\r\n            this.reader.skip(20);\r\n            switch (type) {\r\n            case 'ISCL':\r\n                this.currentNode.scale = this.reader.getFloat32Array(3);\r\n                break;\r\n            case 'IPOS':\r\n                this.currentNode.position = this.reader.getFloat32Array(3);\r\n                break;\r\n            case 'IROT':\r\n                this.currentNode.rotation = this.reader.getFloat32Array(3);\r\n                break;\r\n            case 'IFAL':\r\n                this.currentNode.falloff = this.reader.getFloat32Array(3);\r\n                break;\r\n            case 'IBMP':\r\n                this.currentNode.amplitude = this.reader.getFloat32();\r\n                break;\r\n            case 'IUTD':\r\n                this.currentNode.uTiles = this.reader.getFloat32();\r\n                break;\r\n            case 'IVTD':\r\n                this.currentNode.vTiles = this.reader.getFloat32();\r\n                break;\r\n            }\r\n            this.reader.skip(2);\r\n        },\r\n        parseEnvelope(length) {\r\n            this.reader.skip(length - 4);\r\n        },\r\n        parseClip(length) {\r\n            var tag = this.reader.getIDTag();\r\n            if (tag === 'FORM') {\r\n                this.reader.skip(16);\r\n                this.currentNode.fileName = this.reader.getString();\r\n                return;\r\n            }\r\n            this.reader.setOffset(this.reader.offset - 4);\r\n            this.currentFormEnd = this.reader.offset + length;\r\n            this.parentForm = this.currentForm;\r\n            this.reader.skip(8);\r\n            var texture = { index: this.reader.getUint32() };\r\n            this.tree.textures.push(texture);\r\n            this.currentForm = texture;\r\n        },\r\n        parseClipLwo2(length) {\r\n            var texture = {\r\n                index: this.reader.getUint32(),\r\n                fileName: ''\r\n            };\r\n            while (true) {\r\n                var tag = this.reader.getIDTag();\r\n                var n_length = this.reader.getUint16();\r\n                if (tag === 'STIL') {\r\n                    texture.fileName = this.reader.getString();\r\n                    break;\r\n                }\r\n                if (n_length >= length) {\r\n                    break;\r\n                }\r\n            }\r\n            this.tree.textures.push(texture);\r\n            this.currentForm = texture;\r\n        },\r\n        parseImage() {\r\n            this.reader.skip(8);\r\n            this.currentForm.fileName = this.reader.getString();\r\n        },\r\n        parseXVAL(type, length) {\r\n            var endOffset = this.reader.offset + length - 4;\r\n            this.reader.skip(8);\r\n            this.currentForm[type] = this.reader.getFloat32();\r\n            this.reader.setOffset(endOffset);\r\n        },\r\n        parseXVAL3(type, length) {\r\n            var endOffset = this.reader.offset + length - 4;\r\n            this.reader.skip(8);\r\n            this.currentForm[type] = {\r\n                x: this.reader.getFloat32(),\r\n                y: this.reader.getFloat32(),\r\n                z: this.reader.getFloat32()\r\n            };\r\n            this.reader.setOffset(endOffset);\r\n        },\r\n        parseObjectTag() {\r\n            if (!this.tree.objectTags)\r\n                this.tree.objectTags = {};\r\n            this.tree.objectTags[this.reader.getIDTag()] = { tagString: this.reader.getString() };\r\n        },\r\n        parseLayer(length) {\r\n            var layer = {\r\n                number: this.reader.getUint16(),\r\n                flags: this.reader.getUint16(),\r\n                pivot: this.reader.getFloat32Array(3),\r\n                name: this.reader.getString()\r\n            };\r\n            this.tree.layers.push(layer);\r\n            this.currentLayer = layer;\r\n            var parsedLength = 16 + stringOffset(this.currentLayer.name);\r\n            this.currentLayer.parent = parsedLength < length ? this.reader.getUint16() : -1;\r\n        },\r\n        parsePoints(length) {\r\n            this.currentPoints = [];\r\n            for (var i = 0; i < length / 4; i += 3) {\r\n                this.currentPoints.push(this.reader.getFloat32(), this.reader.getFloat32(), -this.reader.getFloat32());\r\n            }\r\n        },\r\n        parseVertexMapping(length, discontinuous) {\r\n            var finalOffset = this.reader.offset + length;\r\n            var channelName = this.reader.getString();\r\n            if (this.reader.offset === finalOffset) {\r\n                this.currentForm.UVChannel = channelName;\r\n                return;\r\n            }\r\n            this.reader.setOffset(this.reader.offset - stringOffset(channelName));\r\n            var type = this.reader.getIDTag();\r\n            this.reader.getUint16();\r\n            var name = this.reader.getString();\r\n            var remainingLength = length - 6 - stringOffset(name);\r\n            switch (type) {\r\n            case 'TXUV':\r\n                this.parseUVMapping(name, finalOffset, discontinuous);\r\n                break;\r\n            case 'MORF':\r\n            case 'SPOT':\r\n                this.parseMorphTargets(name, finalOffset, type);\r\n                break;\r\n            case 'APSL':\r\n            case 'NORM':\r\n            case 'WGHT':\r\n            case 'MNVW':\r\n            case 'PICK':\r\n            case 'RGB ':\r\n            case 'RGBA':\r\n                this.reader.skip(remainingLength);\r\n                break;\r\n            default:\r\n                console.warn('LWOLoader: unknown vertex map type: ' + type);\r\n                this.reader.skip(remainingLength);\r\n            }\r\n        },\r\n        parseUVMapping(name, finalOffset, discontinuous) {\r\n            var uvIndices = [];\r\n            var polyIndices = [];\r\n            var uvs = [];\r\n            while (this.reader.offset < finalOffset) {\r\n                uvIndices.push(this.reader.getVariableLengthIndex());\r\n                if (discontinuous)\r\n                    polyIndices.push(this.reader.getVariableLengthIndex());\r\n                uvs.push(this.reader.getFloat32(), this.reader.getFloat32());\r\n            }\r\n            if (discontinuous) {\r\n                if (!this.currentLayer.discontinuousUVs)\r\n                    this.currentLayer.discontinuousUVs = {};\r\n                this.currentLayer.discontinuousUVs[name] = {\r\n                    uvIndices: uvIndices,\r\n                    polyIndices: polyIndices,\r\n                    uvs: uvs\r\n                };\r\n            } else {\r\n                if (!this.currentLayer.uvs)\r\n                    this.currentLayer.uvs = {};\r\n                this.currentLayer.uvs[name] = {\r\n                    uvIndices: uvIndices,\r\n                    uvs: uvs\r\n                };\r\n            }\r\n        },\r\n        parseMorphTargets(name, finalOffset, type) {\r\n            var indices = [];\r\n            var points = [];\r\n            type = type === 'MORF' ? 'relative' : 'absolute';\r\n            while (this.reader.offset < finalOffset) {\r\n                indices.push(this.reader.getVariableLengthIndex());\r\n                points.push(this.reader.getFloat32(), this.reader.getFloat32(), -this.reader.getFloat32());\r\n            }\r\n            if (!this.currentLayer.morphTargets)\r\n                this.currentLayer.morphTargets = {};\r\n            this.currentLayer.morphTargets[name] = {\r\n                indices: indices,\r\n                points: points,\r\n                type: type\r\n            };\r\n        },\r\n        parsePolygonList(length) {\r\n            var finalOffset = this.reader.offset + length;\r\n            var type = this.reader.getIDTag();\r\n            var indices = [];\r\n            var polygonDimensions = [];\r\n            while (this.reader.offset < finalOffset) {\r\n                var numverts = this.reader.getUint16();\r\n                numverts = numverts & 1023;\r\n                polygonDimensions.push(numverts);\r\n                for (var j = 0; j < numverts; j++)\r\n                    indices.push(this.reader.getVariableLengthIndex());\r\n            }\r\n            var geometryData = {\r\n                type: type,\r\n                vertexIndices: indices,\r\n                polygonDimensions: polygonDimensions,\r\n                points: this.currentPoints\r\n            };\r\n            if (polygonDimensions[0] === 1)\r\n                geometryData.type = 'points';\r\n            else if (polygonDimensions[0] === 2)\r\n                geometryData.type = 'lines';\r\n            this.currentLayer.geometry = geometryData;\r\n        },\r\n        parseTagStrings(length) {\r\n            this.tree.tags = this.reader.getStringArray(length);\r\n        },\r\n        parsePolygonTagMapping(length) {\r\n            var finalOffset = this.reader.offset + length;\r\n            var type = this.reader.getIDTag();\r\n            if (type === 'SURF')\r\n                this.parseMaterialIndices(finalOffset);\r\n            else {\r\n                this.reader.skip(length - 4);\r\n            }\r\n        },\r\n        parseMaterialIndices(finalOffset) {\r\n            this.currentLayer.geometry.materialIndices = [];\r\n            while (this.reader.offset < finalOffset) {\r\n                var polygonIndex = this.reader.getVariableLengthIndex();\r\n                var materialIndex = this.reader.getUint16();\r\n                this.currentLayer.geometry.materialIndices.push(polygonIndex, materialIndex);\r\n            }\r\n        },\r\n        parseUnknownCHUNK(blockID, length) {\r\n            console.warn('LWOLoader: unknown chunk type: ' + blockID + ' length: ' + length);\r\n            var data = this.reader.getString(length);\r\n            this.currentForm[blockID] = data;\r\n        }\r\n    };\r\n    function DataViewReader(buffer) {\r\n        this.dv = new DataView(buffer);\r\n        this.offset = 0;\r\n    }\r\n    DataViewReader.prototype = {\r\n        constructor: DataViewReader,\r\n        size: function () {\r\n            return this.dv.buffer.byteLength;\r\n        },\r\n        setOffset(offset) {\r\n            if (offset > 0 && offset < this.dv.buffer.byteLength) {\r\n                this.offset = offset;\r\n            } else {\r\n                console.error('LWOLoader: invalid buffer offset');\r\n            }\r\n        },\r\n        endOfFile: function () {\r\n            if (this.offset >= this.size())\r\n                return true;\r\n            return false;\r\n        },\r\n        skip: function (length) {\r\n            this.offset += length;\r\n        },\r\n        getUint8: function () {\r\n            var value = this.dv.getUint8(this.offset);\r\n            this.offset += 1;\r\n            return value;\r\n        },\r\n        getUint16: function () {\r\n            var value = this.dv.getUint16(this.offset);\r\n            this.offset += 2;\r\n            return value;\r\n        },\r\n        getInt32: function () {\r\n            var value = this.dv.getInt32(this.offset, false);\r\n            this.offset += 4;\r\n            return value;\r\n        },\r\n        getUint32: function () {\r\n            var value = this.dv.getUint32(this.offset, false);\r\n            this.offset += 4;\r\n            return value;\r\n        },\r\n        getUint64: function () {\r\n            var low, high;\r\n            high = this.getUint32();\r\n            low = this.getUint32();\r\n            return high * 4294967296 + low;\r\n        },\r\n        getFloat32: function () {\r\n            var value = this.dv.getFloat32(this.offset, false);\r\n            this.offset += 4;\r\n            return value;\r\n        },\r\n        getFloat32Array: function (size) {\r\n            var a = [];\r\n            for (var i = 0; i < size; i++) {\r\n                a.push(this.getFloat32());\r\n            }\r\n            return a;\r\n        },\r\n        getFloat64: function () {\r\n            var value = this.dv.getFloat64(this.offset, this.littleEndian);\r\n            this.offset += 8;\r\n            return value;\r\n        },\r\n        getFloat64Array: function (size) {\r\n            var a = [];\r\n            for (var i = 0; i < size; i++) {\r\n                a.push(this.getFloat64());\r\n            }\r\n            return a;\r\n        },\r\n        getVariableLengthIndex() {\r\n            var firstByte = this.getUint8();\r\n            if (firstByte === 255) {\r\n                return this.getUint8() * 65536 + this.getUint8() * 256 + this.getUint8();\r\n            }\r\n            return firstByte * 256 + this.getUint8();\r\n        },\r\n        getIDTag() {\r\n            return this.getString(4);\r\n        },\r\n        getString: function (size) {\r\n            if (size === 0)\r\n                return;\r\n            var a = [];\r\n            if (size) {\r\n                for (var i = 0; i < size; i++) {\r\n                    a[i] = this.getUint8();\r\n                }\r\n            } else {\r\n                var currentChar;\r\n                var len = 0;\r\n                while (currentChar !== 0) {\r\n                    currentChar = this.getUint8();\r\n                    if (currentChar !== 0)\r\n                        a.push(currentChar);\r\n                    len++;\r\n                }\r\n                if (!isEven(len + 1))\r\n                    this.getUint8();\r\n            }\r\n            return THREE.LoaderUtils.decodeText(new Uint8Array(a));\r\n        },\r\n        getStringArray: function (size) {\r\n            var a = this.getString(size);\r\n            a = a.split('\\0');\r\n            return a.filter(Boolean);\r\n        }\r\n    };\r\n    function Debugger() {\r\n        this.active = false;\r\n        this.depth = 0;\r\n        this.formList = [];\r\n    }\r\n    Debugger.prototype = {\r\n        constructor: Debugger,\r\n        enable: function () {\r\n            this.active = true;\r\n        },\r\n        log: function () {\r\n            if (!this.active)\r\n                return;\r\n            var nodeType;\r\n            switch (this.node) {\r\n            case 0:\r\n                nodeType = 'FORM';\r\n                break;\r\n            case 1:\r\n                nodeType = 'CHK';\r\n                break;\r\n            case 2:\r\n                nodeType = 'S-CHK';\r\n                break;\r\n            }\r\n            console.log('| '.repeat(this.depth) + nodeType, this.nodeID, `( ${ this.offset } ) -> ( ${ this.dataOffset + this.length } )`, this.node == 0 ? ' {' : '', this.skipped ? 'SKIPPED' : '', this.node == 0 && this.skipped ? '}' : '');\r\n            if (this.node == 0 && !this.skipped) {\r\n                this.depth += 1;\r\n                this.formList.push(this.dataOffset + this.length);\r\n            }\r\n            this.skipped = false;\r\n        },\r\n        closeForms: function () {\r\n            if (!this.active)\r\n                return;\r\n            for (var i = this.formList.length - 1; i >= 0; i--) {\r\n                if (this.offset >= this.formList[i]) {\r\n                    this.depth -= 1;\r\n                    console.log('| '.repeat(this.depth) + '}');\r\n                    this.formList.splice(-1, 1);\r\n                }\r\n            }\r\n        }\r\n    };\r\n    function isEven(num) {\r\n        return num % 2;\r\n    }\r\n    function stringOffset(string) {\r\n        return string.length + 1 + (isEven(string.length + 1) ? 1 : 0);\r\n    }\r\n    function printBuffer(buffer, from, to) {\r\n        console.log(THREE.LoaderUtils.decodeText(new Uint8Array(buffer, from, to)));\r\n    }\r\n    var lwoTree;\r\n    var LWOLoader = function (manager, parameters) {\r\n        THREE.Loader.call(this, manager);\r\n        parameters = parameters || {};\r\n        this.resourcePath = parameters.resourcePath !== undefined ? parameters.resourcePath : '';\r\n    };\r\n    LWOLoader.prototype = Object.assign(Object.create(THREE.Loader.prototype), {\r\n        constructor: LWOLoader,\r\n        load: function (url, onLoad, onProgress, onError) {\r\n            var self = this;\r\n            var path = self.path === '' ? extractParentUrl(url, 'Objects') : self.path;\r\n            var modelName = url.split(path).pop().split('.')[0];\r\n            var loader = new THREE.FileLoader(this.manager);\r\n            loader.setPath(self.path);\r\n            loader.setResponseType('arraybuffer');\r\n            loader.load(url, function (buffer) {\r\n                onLoad(self.parse(buffer, path, modelName));\r\n            }, onProgress, onError);\r\n        },\r\n        parse: function (iffBuffer, path, modelName) {\r\n            lwoTree = new IFFParser().parse(iffBuffer);\r\n            var textureLoader = new THREE.TextureLoader(this.manager).setPath(this.resourcePath || path).setCrossOrigin(this.crossOrigin);\r\n            return new LWOTreeParser(textureLoader).parse(modelName);\r\n        }\r\n    });\r\n    function LWOTreeParser(textureLoader) {\r\n        this.textureLoader = textureLoader;\r\n    }\r\n    LWOTreeParser.prototype = {\r\n        constructor: LWOTreeParser,\r\n        parse: function (modelName) {\r\n            this.materials = new MaterialParser(this.textureLoader).parse();\r\n            this.defaultLayerName = modelName;\r\n            this.meshes = this.parseLayers();\r\n            return {\r\n                materials: this.materials,\r\n                meshes: this.meshes\r\n            };\r\n        },\r\n        parseLayers() {\r\n            var meshes = [];\r\n            var finalMeshes = [];\r\n            var geometryParser = new GeometryParser();\r\n            var self = this;\r\n            lwoTree.layers.forEach(function (layer) {\r\n                var geometry = geometryParser.parse(layer.geometry, layer);\r\n                var mesh = self.parseMesh(geometry, layer);\r\n                meshes[layer.number] = mesh;\r\n                if (layer.parent === -1)\r\n                    finalMeshes.push(mesh);\r\n                else\r\n                    meshes[layer.parent].add(mesh);\r\n            });\r\n            this.applyPivots(finalMeshes);\r\n            return finalMeshes;\r\n        },\r\n        parseMesh(geometry, layer) {\r\n            var mesh;\r\n            var materials = this.getMaterials(geometry.userData.matNames, layer.geometry.type);\r\n            this.duplicateUVs(geometry, materials);\r\n            if (layer.geometry.type === 'points')\r\n                mesh = new THREE.Points(geometry, materials);\r\n            else if (layer.geometry.type === 'lines')\r\n                mesh = new THREE.LineSegments(geometry, materials);\r\n            else\r\n                mesh = new THREE.Mesh(geometry, materials);\r\n            if (layer.name)\r\n                mesh.name = layer.name;\r\n            else\r\n                mesh.name = this.defaultLayerName + '_layer_' + layer.number;\r\n            mesh.userData.pivot = layer.pivot;\r\n            return mesh;\r\n        },\r\n        applyPivots(meshes) {\r\n            meshes.forEach(function (mesh) {\r\n                mesh.traverse(function (child) {\r\n                    var pivot = child.userData.pivot;\r\n                    child.position.x += pivot[0];\r\n                    child.position.y += pivot[1];\r\n                    child.position.z += pivot[2];\r\n                    if (child.parent) {\r\n                        var parentPivot = child.parent.userData.pivot;\r\n                        child.position.x -= parentPivot[0];\r\n                        child.position.y -= parentPivot[1];\r\n                        child.position.z -= parentPivot[2];\r\n                    }\r\n                });\r\n            });\r\n        },\r\n        getMaterials(namesArray, type) {\r\n            var materials = [];\r\n            var self = this;\r\n            namesArray.forEach(function (name, i) {\r\n                materials[i] = self.getMaterialByName(name);\r\n            });\r\n            if (type === 'points' || type === 'lines') {\r\n                materials.forEach(function (mat, i) {\r\n                    var spec = { color: mat.color };\r\n                    if (type === 'points') {\r\n                        spec.size = 0.1;\r\n                        spec.map = mat.map;\r\n                        spec.morphTargets = mat.morphTargets;\r\n                        materials[i] = new THREE.PointsMaterial(spec);\r\n                    } else if (type === 'lines') {\r\n                        materials[i] = new THREE.LineBasicMaterial(spec);\r\n                    }\r\n                });\r\n            }\r\n            var filtered = materials.filter(Boolean);\r\n            if (filtered.length === 1)\r\n                return filtered[0];\r\n            return materials;\r\n        },\r\n        getMaterialByName(name) {\r\n            return this.materials.filter(function (m) {\r\n                return m.name === name;\r\n            })[0];\r\n        },\r\n        duplicateUVs(geometry, materials) {\r\n            var duplicateUVs = false;\r\n            if (!Array.isArray(materials)) {\r\n                if (materials.aoMap)\r\n                    duplicateUVs = true;\r\n            } else {\r\n                materials.forEach(function (material) {\r\n                    if (material.aoMap)\r\n                        duplicateUVs = true;\r\n                });\r\n            }\r\n            if (!duplicateUVs)\r\n                return;\r\n            geometry.setAttribute('uv2', new THREE.BufferAttribute(geometry.attributes.uv.array, 2));\r\n        }\r\n    };\r\n    function MaterialParser(textureLoader) {\r\n        this.textureLoader = textureLoader;\r\n    }\r\n    MaterialParser.prototype = {\r\n        constructor: MaterialParser,\r\n        parse: function () {\r\n            var materials = [];\r\n            this.textures = {};\r\n            for (var name in lwoTree.materials) {\r\n                if (lwoTree.format === 'LWO3') {\r\n                    materials.push(this.parseMaterial(lwoTree.materials[name], name, lwoTree.textures));\r\n                } else if (lwoTree.format === 'LWO2') {\r\n                    materials.push(this.parseMaterialLwo2(lwoTree.materials[name], name, lwoTree.textures));\r\n                }\r\n            }\r\n            return materials;\r\n        },\r\n        parseMaterial(materialData, name, textures) {\r\n            var params = {\r\n                name: name,\r\n                side: this.getSide(materialData.attributes),\r\n                flatShading: this.getSmooth(materialData.attributes)\r\n            };\r\n            var connections = this.parseConnections(materialData.connections, materialData.nodes);\r\n            var maps = this.parseTextureNodes(connections.maps);\r\n            this.parseAttributeImageMaps(connections.attributes, textures, maps, materialData.maps);\r\n            var attributes = this.parseAttributes(connections.attributes, maps);\r\n            this.parseEnvMap(connections, maps, attributes);\r\n            params = Object.assign(maps, params);\r\n            params = Object.assign(params, attributes);\r\n            var materialType = this.getMaterialType(connections.attributes);\r\n            return new materialType(params);\r\n        },\r\n        parseMaterialLwo2(materialData, name) {\r\n            var params = {\r\n                name: name,\r\n                side: this.getSide(materialData.attributes),\r\n                flatShading: this.getSmooth(materialData.attributes)\r\n            };\r\n            var attributes = this.parseAttributes(materialData.attributes, {});\r\n            params = Object.assign(params, attributes);\r\n            return new THREE.MeshPhongMaterial(params);\r\n        },\r\n        getSide(attributes) {\r\n            if (!attributes.side)\r\n                return THREE.BackSide;\r\n            switch (attributes.side) {\r\n            case 0:\r\n            case 1:\r\n                return THREE.BackSide;\r\n            case 2:\r\n                return THREE.FrontSide;\r\n            case 3:\r\n                return THREE.DoubleSide;\r\n            }\r\n        },\r\n        getSmooth(attributes) {\r\n            if (!attributes.smooth)\r\n                return true;\r\n            return !attributes.smooth;\r\n        },\r\n        parseConnections(connections, nodes) {\r\n            var materialConnections = { maps: {} };\r\n            var inputName = connections.inputName;\r\n            var inputNodeName = connections.inputNodeName;\r\n            var nodeName = connections.nodeName;\r\n            var self = this;\r\n            inputName.forEach(function (name, index) {\r\n                if (name === 'Material') {\r\n                    var matNode = self.getNodeByRefName(inputNodeName[index], nodes);\r\n                    materialConnections.attributes = matNode.attributes;\r\n                    materialConnections.envMap = matNode.fileName;\r\n                    materialConnections.name = inputNodeName[index];\r\n                }\r\n            });\r\n            nodeName.forEach(function (name, index) {\r\n                if (name === materialConnections.name) {\r\n                    materialConnections.maps[inputName[index]] = self.getNodeByRefName(inputNodeName[index], nodes);\r\n                }\r\n            });\r\n            return materialConnections;\r\n        },\r\n        getNodeByRefName(refName, nodes) {\r\n            for (var name in nodes) {\r\n                if (nodes[name].refName === refName)\r\n                    return nodes[name];\r\n            }\r\n        },\r\n        parseTextureNodes(textureNodes) {\r\n            var maps = {};\r\n            for (var name in textureNodes) {\r\n                var node = textureNodes[name];\r\n                var path = node.fileName;\r\n                if (!path)\r\n                    return;\r\n                var texture = this.loadTexture(path);\r\n                if (node.widthWrappingMode !== undefined)\r\n                    texture.wrapS = this.getWrappingType(node.widthWrappingMode);\r\n                if (node.heightWrappingMode !== undefined)\r\n                    texture.wrapT = this.getWrappingType(node.heightWrappingMode);\r\n                switch (name) {\r\n                case 'Color':\r\n                    maps.map = texture;\r\n                    break;\r\n                case 'Roughness':\r\n                    maps.roughnessMap = texture;\r\n                    maps.roughness = 0.5;\r\n                    break;\r\n                case 'Specular':\r\n                    maps.specularMap = texture;\r\n                    maps.specular = 16777215;\r\n                    break;\r\n                case 'Luminous':\r\n                    maps.emissiveMap = texture;\r\n                    maps.emissive = 8421504;\r\n                    break;\r\n                case 'Luminous Color':\r\n                    maps.emissive = 8421504;\r\n                    break;\r\n                case 'Metallic':\r\n                    maps.metalnessMap = texture;\r\n                    maps.metalness = 0.5;\r\n                    break;\r\n                case 'Transparency':\r\n                case 'Alpha':\r\n                    maps.alphaMap = texture;\r\n                    maps.transparent = true;\r\n                    break;\r\n                case 'Normal':\r\n                    maps.normalMap = texture;\r\n                    if (node.amplitude !== undefined)\r\n                        maps.normalScale = new THREE.Vector2(node.amplitude, node.amplitude);\r\n                    break;\r\n                case 'Bump':\r\n                    maps.bumpMap = texture;\r\n                    break;\r\n                }\r\n            }\r\n            if (maps.roughnessMap && maps.specularMap)\r\n                delete maps.specularMap;\r\n            return maps;\r\n        },\r\n        parseAttributeImageMaps(attributes, textures, maps) {\r\n            for (var name in attributes) {\r\n                var attribute = attributes[name];\r\n                if (attribute.maps) {\r\n                    var mapData = attribute.maps[0];\r\n                    var path = this.getTexturePathByIndex(mapData.imageIndex, textures);\r\n                    if (!path)\r\n                        return;\r\n                    var texture = this.loadTexture(path);\r\n                    if (mapData.wrap !== undefined)\r\n                        texture.wrapS = this.getWrappingType(mapData.wrap.w);\r\n                    if (mapData.wrap !== undefined)\r\n                        texture.wrapT = this.getWrappingType(mapData.wrap.h);\r\n                    switch (name) {\r\n                    case 'Color':\r\n                        maps.map = texture;\r\n                        break;\r\n                    case 'Diffuse':\r\n                        maps.aoMap = texture;\r\n                        break;\r\n                    case 'Roughness':\r\n                        maps.roughnessMap = texture;\r\n                        maps.roughness = 1;\r\n                        break;\r\n                    case 'Specular':\r\n                        maps.specularMap = texture;\r\n                        maps.specular = 16777215;\r\n                        break;\r\n                    case 'Luminosity':\r\n                        maps.emissiveMap = texture;\r\n                        maps.emissive = 8421504;\r\n                        break;\r\n                    case 'Metallic':\r\n                        maps.metalnessMap = texture;\r\n                        maps.metalness = 1;\r\n                        break;\r\n                    case 'Transparency':\r\n                    case 'Alpha':\r\n                        maps.alphaMap = texture;\r\n                        maps.transparent = true;\r\n                        break;\r\n                    case 'Normal':\r\n                        maps.normalMap = texture;\r\n                        break;\r\n                    case 'Bump':\r\n                        maps.bumpMap = texture;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        parseAttributes(attributes, maps) {\r\n            var params = {};\r\n            if (attributes.undefined && !maps.map) {\r\n                params.color = new THREE.Color().fromArray(attributes.undefined.value);\r\n            } else\r\n                params.color = new THREE.Color();\r\n            if (attributes.Transparency && attributes.Transparency.value !== 0) {\r\n                params.opacity = 1 - attributes.Transparency.value;\r\n                params.transparent = true;\r\n            }\r\n            if (attributes['Bump Height'])\r\n                params.bumpScale = attributes['Bump Height'].value * 0.1;\r\n            if (attributes['Refraction Index'])\r\n                params.refractionRatio = 1 / attributes['Refraction Index'].value;\r\n            this.parsePhysicalAttributes(params, attributes, maps);\r\n            this.parseStandardAttributes(params, attributes, maps);\r\n            this.parsePhongAttributes(params, attributes, maps);\r\n            return params;\r\n        },\r\n        parsePhysicalAttributes(params, attributes) {\r\n            if (attributes.Clearcoat && attributes.Clearcoat.value > 0) {\r\n                params.clearcoat = attributes.Clearcoat.value;\r\n                if (attributes['Clearcoat Gloss']) {\r\n                    params.clearcoatRoughness = 0.5 * (1 - attributes['Clearcoat Gloss'].value);\r\n                }\r\n            }\r\n        },\r\n        parseStandardAttributes(params, attributes, maps) {\r\n            if (attributes.Luminous) {\r\n                params.emissiveIntensity = attributes.Luminous.value;\r\n                if (attributes['Luminous Color'] && !maps.emissive) {\r\n                    params.emissive = new THREE.Color().fromArray(attributes['Luminous Color'].value);\r\n                } else {\r\n                    params.emissive = new THREE.Color(8421504);\r\n                }\r\n            }\r\n            if (attributes.Roughness && !maps.roughnessMap)\r\n                params.roughness = attributes.Roughness.value;\r\n            if (attributes.Metallic && !maps.metalnessMap)\r\n                params.metalness = attributes.Metallic.value;\r\n        },\r\n        parsePhongAttributes(params, attributes, maps) {\r\n            if (attributes.Diffuse)\r\n                params.color.multiplyScalar(attributes.Diffuse.value);\r\n            if (attributes.Reflection) {\r\n                params.reflectivity = attributes.Reflection.value;\r\n                params.combine = THREE.AddOperation;\r\n            }\r\n            if (attributes.Luminosity) {\r\n                params.emissiveIntensity = attributes.Luminosity.value;\r\n                if (!maps.emissiveMap && !maps.map) {\r\n                    params.emissive = params.color;\r\n                } else {\r\n                    params.emissive = new THREE.Color(8421504);\r\n                }\r\n            }\r\n            if (!attributes.Roughness && attributes.Specular && !maps.specularMap) {\r\n                if (attributes['Color Highlight']) {\r\n                    params.specular = new THREE.Color().setScalar(attributes.Specular.value).lerp(params.color.clone().multiplyScalar(attributes.Specular.value), attributes['Color Highlight'].value);\r\n                } else {\r\n                    params.specular = new THREE.Color().setScalar(attributes.Specular.value);\r\n                }\r\n            }\r\n            if (params.specular && attributes.Glossiness)\r\n                params.shininess = 7 + Math.pow(2, attributes.Glossiness.value * 12 + 2);\r\n        },\r\n        parseEnvMap(connections, maps, attributes) {\r\n            if (connections.envMap) {\r\n                var envMap = this.loadTexture(connections.envMap);\r\n                if (attributes.transparent && attributes.opacity < 0.999) {\r\n                    envMap.mapping = THREE.EquirectangularRefractionMapping;\r\n                    if (attributes.reflectivity !== undefined) {\r\n                        delete attributes.reflectivity;\r\n                        delete attributes.combine;\r\n                    }\r\n                    if (attributes.metalness !== undefined) {\r\n                        delete attributes.metalness;\r\n                    }\r\n                } else\r\n                    envMap.mapping = THREE.EquirectangularReflectionMapping;\r\n                maps.envMap = envMap;\r\n            }\r\n        },\r\n        getTexturePathByIndex(index) {\r\n            var fileName = '';\r\n            if (!lwoTree.textures)\r\n                return fileName;\r\n            lwoTree.textures.forEach(function (texture) {\r\n                if (texture.index === index)\r\n                    fileName = texture.fileName;\r\n            });\r\n            return fileName;\r\n        },\r\n        loadTexture(path) {\r\n            if (!path)\r\n                return null;\r\n            var texture;\r\n            texture = this.textureLoader.load(path, undefined, undefined, function () {\r\n                console.warn('LWOLoader: non-standard resource hierarchy. Use `resourcePath` parameter to specify root content directory.');\r\n            });\r\n            return texture;\r\n        },\r\n        getWrappingType(num) {\r\n            switch (num) {\r\n            case 0:\r\n                console.warn('LWOLoader: \"Reset\" texture wrapping type is not supported in three');\r\n                return THREE.ClampToEdgeWrapping;\r\n            case 1:\r\n                return THREE.RepeatWrapping;\r\n            case 2:\r\n                return THREE.MirroredRepeatWrapping;\r\n            case 3:\r\n                return THREE.ClampToEdgeWrapping;\r\n            }\r\n        },\r\n        getMaterialType(nodeData) {\r\n            if (nodeData.Clearcoat && nodeData.Clearcoat.value > 0)\r\n                return THREE.MeshPhysicalMaterial;\r\n            if (nodeData.Roughness)\r\n                return THREE.MeshStandardMaterial;\r\n            return THREE.MeshPhongMaterial;\r\n        }\r\n    };\r\n    function GeometryParser() {\r\n    }\r\n    GeometryParser.prototype = {\r\n        constructor: GeometryParser,\r\n        parse(geoData, layer) {\r\n            var geometry = new THREE.BufferGeometry();\r\n            geometry.setAttribute('position', new THREE.Float32BufferAttribute(geoData.points, 3));\r\n            var indices = this.splitIndices(geoData.vertexIndices, geoData.polygonDimensions);\r\n            geometry.setIndex(indices);\r\n            this.parseGroups(geometry, geoData);\r\n            geometry.computeVertexNormals();\r\n            this.parseUVs(geometry, layer, indices);\r\n            this.parseMorphTargets(geometry, layer, indices);\r\n            geometry.translate(-layer.pivot[0], -layer.pivot[1], -layer.pivot[2]);\r\n            return geometry;\r\n        },\r\n        splitIndices(indices, polygonDimensions) {\r\n            var remappedIndices = [];\r\n            var i = 0;\r\n            polygonDimensions.forEach(function (dim) {\r\n                if (dim < 4) {\r\n                    for (var k = 0; k < dim; k++)\r\n                        remappedIndices.push(indices[i + k]);\r\n                } else if (dim === 4) {\r\n                    remappedIndices.push(indices[i], indices[i + 1], indices[i + 2], indices[i], indices[i + 2], indices[i + 3]);\r\n                } else if (dim > 4) {\r\n                    for (var k = 1; k < dim - 1; k++) {\r\n                        remappedIndices.push(indices[i], indices[i + k], indices[i + k + 1]);\r\n                    }\r\n                    console.warn('LWOLoader: polygons with greater than 4 sides are not supported');\r\n                }\r\n                i += dim;\r\n            });\r\n            return remappedIndices;\r\n        },\r\n        parseGroups(geometry, geoData) {\r\n            var tags = lwoTree.tags;\r\n            var matNames = [];\r\n            var elemSize = 3;\r\n            if (geoData.type === 'lines')\r\n                elemSize = 2;\r\n            if (geoData.type === 'points')\r\n                elemSize = 1;\r\n            var remappedIndices = this.splitMaterialIndices(geoData.polygonDimensions, geoData.materialIndices);\r\n            var indexNum = 0;\r\n            var indexPairs = {};\r\n            var prevMaterialIndex;\r\n            var prevStart = 0;\r\n            var currentCount = 0;\r\n            for (var i = 0; i < remappedIndices.length; i += 2) {\r\n                var materialIndex = remappedIndices[i + 1];\r\n                if (i === 0)\r\n                    matNames[indexNum] = tags[materialIndex];\r\n                if (prevMaterialIndex === undefined)\r\n                    prevMaterialIndex = materialIndex;\r\n                if (materialIndex !== prevMaterialIndex) {\r\n                    var currentIndex;\r\n                    if (indexPairs[tags[prevMaterialIndex]]) {\r\n                        currentIndex = indexPairs[tags[prevMaterialIndex]];\r\n                    } else {\r\n                        currentIndex = indexNum;\r\n                        indexPairs[tags[prevMaterialIndex]] = indexNum;\r\n                        matNames[indexNum] = tags[prevMaterialIndex];\r\n                        indexNum++;\r\n                    }\r\n                    geometry.addGroup(prevStart, currentCount, currentIndex);\r\n                    prevStart += currentCount;\r\n                    prevMaterialIndex = materialIndex;\r\n                    currentCount = 0;\r\n                }\r\n                currentCount += elemSize;\r\n            }\r\n            if (geometry.groups.length > 0) {\r\n                var currentIndex;\r\n                if (indexPairs[tags[materialIndex]]) {\r\n                    currentIndex = indexPairs[tags[materialIndex]];\r\n                } else {\r\n                    currentIndex = indexNum;\r\n                    indexPairs[tags[materialIndex]] = indexNum;\r\n                    matNames[indexNum] = tags[materialIndex];\r\n                }\r\n                geometry.addGroup(prevStart, currentCount, currentIndex);\r\n            }\r\n            geometry.userData.matNames = matNames;\r\n        },\r\n        splitMaterialIndices(polygonDimensions, indices) {\r\n            var remappedIndices = [];\r\n            polygonDimensions.forEach(function (dim, i) {\r\n                if (dim <= 3) {\r\n                    remappedIndices.push(indices[i * 2], indices[i * 2 + 1]);\r\n                } else if (dim === 4) {\r\n                    remappedIndices.push(indices[i * 2], indices[i * 2 + 1], indices[i * 2], indices[i * 2 + 1]);\r\n                } else {\r\n                    for (var k = 0; k < dim - 2; k++) {\r\n                        remappedIndices.push(indices[i * 2], indices[i * 2 + 1]);\r\n                    }\r\n                }\r\n            });\r\n            return remappedIndices;\r\n        },\r\n        parseUVs(geometry, layer) {\r\n            var remappedUVs = Array.from(Array(geometry.attributes.position.count * 2), function () {\r\n                return 0;\r\n            });\r\n            for (var name in layer.uvs) {\r\n                var uvs = layer.uvs[name].uvs;\r\n                var uvIndices = layer.uvs[name].uvIndices;\r\n                uvIndices.forEach(function (i, j) {\r\n                    remappedUVs[i * 2] = uvs[j * 2];\r\n                    remappedUVs[i * 2 + 1] = uvs[j * 2 + 1];\r\n                });\r\n            }\r\n            geometry.setAttribute('uv', new THREE.Float32BufferAttribute(remappedUVs, 2));\r\n        },\r\n        parseMorphTargets(geometry, layer) {\r\n            var num = 0;\r\n            for (var name in layer.morphTargets) {\r\n                var remappedPoints = geometry.attributes.position.array.slice();\r\n                if (!geometry.morphAttributes.position)\r\n                    geometry.morphAttributes.position = [];\r\n                var morphPoints = layer.morphTargets[name].points;\r\n                var morphIndices = layer.morphTargets[name].indices;\r\n                var type = layer.morphTargets[name].type;\r\n                morphIndices.forEach(function (i, j) {\r\n                    if (type === 'relative') {\r\n                        remappedPoints[i * 3] += morphPoints[j * 3];\r\n                        remappedPoints[i * 3 + 1] += morphPoints[j * 3 + 1];\r\n                        remappedPoints[i * 3 + 2] += morphPoints[j * 3 + 2];\r\n                    } else {\r\n                        remappedPoints[i * 3] = morphPoints[j * 3];\r\n                        remappedPoints[i * 3 + 1] = morphPoints[j * 3 + 1];\r\n                        remappedPoints[i * 3 + 2] = morphPoints[j * 3 + 2];\r\n                    }\r\n                });\r\n                geometry.morphAttributes.position[num] = new THREE.Float32BufferAttribute(remappedPoints, 3);\r\n                geometry.morphAttributes.position[num].name = name;\r\n                num++;\r\n            }\r\n            geometry.morphTargetsRelative = false;\r\n        }\r\n    };\r\n    function extractParentUrl(url, dir) {\r\n        var index = url.indexOf(dir);\r\n        if (index === -1)\r\n            return './';\r\n        return url.substr(0, index);\r\n    }\r\n\r\n    return threex.loaders.LWOLoader = LWOLoader;\r\n});"]}