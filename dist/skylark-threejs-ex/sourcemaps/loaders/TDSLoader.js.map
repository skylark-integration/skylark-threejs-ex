{"version":3,"sources":["loaders/TDSLoader.js"],"names":["define","THREE","threex","TDSLoader","manager","Loader","call","this","debug","group","position","materials","meshes","prototype","Object","assign","create","constructor","load","url","onLoad","onProgress","onError","scope","path","LoaderUtils","extractUrlBase","loader","FileLoader","setPath","setResponseType","data","parse","arraybuffer","Group","readFile","i","length","add","DataView","chunk","readChunk","id","MLIBMAGIC","CMAGIC","M3DMAGIC","next","nextChunk","M3D_VERSION","version","readDWord","debugMessage","MDATA","resetPosition","readMeshData","toString","MESH_VERSION","MASTER_SCALE","scale","readFloat","set","NAMED_OBJECT","readNamedObject","MAT_ENTRY","readMaterialEntry","name","readString","cur","N_TRI_OBJECT","mesh","readMesh","push","endChunk","material","MeshPhongMaterial","MAT_NAME","MAT_WIRE","wireframe","MAT_WIRE_SIZE","value","readByte","wireframeLinewidth","MAT_TWO_SIDE","side","DoubleSide","MAT_ADDITIVE","blending","AdditiveBlending","MAT_DIFFUSE","color","readColor","MAT_SPECULAR","specular","MAT_AMBIENT","MAT_SHININESS","shininess","readWord","MAT_TRANSPARENCY","opacity","transparent","MAT_TEXMAP","map","readMap","MAT_BUMPMAP","bumpMap","MAT_OPACMAP","alphaMap","MAT_SPECMAP","specularMap","geometry","BufferGeometry","uvs","Mesh","POINT_ARRAY","points","vertices","setAttribute","Float32BufferAttribute","FACE_ARRAY","readFaceArray","TEX_VERTS","texels","MESH_MATRIX","values","matrix","Matrix4","elements","transpose","inverse","getInverse","applyMatrix4","decompose","quaternion","computeVertexNormals","faces","index","setIndex","end","MSH_MAT_GROUP","readMaterialGroup","undefined","texture","TextureLoader","resourcePath","setCrossOrigin","crossOrigin","MAT_MAPNAME","MAT_MAP_UOFFSET","offset","x","MAT_MAP_VOFFSET","y","MAT_MAP_USCALE","repeat","MAT_MAP_VSCALE","numFaces","Color","COLOR_24","LIN_COLOR_24","r","g","b","setRGB","COLOR_F","LIN_COLOR_F","size","e","v","getUint8","getFloat32","byteLength","readInt","getInt32","readShort","getInt16","getUint32","getUint16","maxLength","s","c","String","fromCharCode","message","console","log","loaders"],"mappings":"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","file":"../../loaders/TDSLoader.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var TDSLoader = function (manager) {\r\n        THREE.Loader.call(this, manager);\r\n        this.debug = false;\r\n        this.group = null;\r\n        this.position = 0;\r\n        this.materials = [];\r\n        this.meshes = [];\r\n    };\r\n    TDSLoader.prototype = Object.assign(Object.create(THREE.Loader.prototype), {\r\n        constructor: TDSLoader,\r\n        load: function (url, onLoad, onProgress, onError) {\r\n            var scope = this;\r\n            var path = scope.path === '' ? THREE.LoaderUtils.extractUrlBase(url) : scope.path;\r\n            var loader = new THREE.FileLoader(this.manager);\r\n            loader.setPath(this.path);\r\n            loader.setResponseType('arraybuffer');\r\n            loader.load(url, function (data) {\r\n                onLoad(scope.parse(data, path));\r\n            }, onProgress, onError);\r\n        },\r\n        parse: function (arraybuffer, path) {\r\n            this.group = new THREE.Group();\r\n            this.position = 0;\r\n            this.materials = [];\r\n            this.meshes = [];\r\n            this.readFile(arraybuffer, path);\r\n            for (var i = 0; i < this.meshes.length; i++) {\r\n                this.group.add(this.meshes[i]);\r\n            }\r\n            return this.group;\r\n        },\r\n        readFile: function (arraybuffer, path) {\r\n            var data = new DataView(arraybuffer);\r\n            var chunk = this.readChunk(data);\r\n            if (chunk.id === MLIBMAGIC || chunk.id === CMAGIC || chunk.id === M3DMAGIC) {\r\n                var next = this.nextChunk(data, chunk);\r\n                while (next !== 0) {\r\n                    if (next === M3D_VERSION) {\r\n                        var version = this.readDWord(data);\r\n                        this.debugMessage('3DS file version: ' + version);\r\n                    } else if (next === MDATA) {\r\n                        this.resetPosition(data);\r\n                        this.readMeshData(data, path);\r\n                    } else {\r\n                        this.debugMessage('Unknown main chunk: ' + next.toString(16));\r\n                    }\r\n                    next = this.nextChunk(data, chunk);\r\n                }\r\n            }\r\n            this.debugMessage('Parsed ' + this.meshes.length + ' meshes');\r\n        },\r\n        readMeshData: function (data, path) {\r\n            var chunk = this.readChunk(data);\r\n            var next = this.nextChunk(data, chunk);\r\n            while (next !== 0) {\r\n                if (next === MESH_VERSION) {\r\n                    var version = +this.readDWord(data);\r\n                    this.debugMessage('Mesh Version: ' + version);\r\n                } else if (next === MASTER_SCALE) {\r\n                    var scale = this.readFloat(data);\r\n                    this.debugMessage('Master scale: ' + scale);\r\n                    this.group.scale.set(scale, scale, scale);\r\n                } else if (next === NAMED_OBJECT) {\r\n                    this.debugMessage('Named Object');\r\n                    this.resetPosition(data);\r\n                    this.readNamedObject(data);\r\n                } else if (next === MAT_ENTRY) {\r\n                    this.debugMessage('Material');\r\n                    this.resetPosition(data);\r\n                    this.readMaterialEntry(data, path);\r\n                } else {\r\n                    this.debugMessage('Unknown MDATA chunk: ' + next.toString(16));\r\n                }\r\n                next = this.nextChunk(data, chunk);\r\n            }\r\n        },\r\n        readNamedObject: function (data) {\r\n            var chunk = this.readChunk(data);\r\n            var name = this.readString(data, 64);\r\n            chunk.cur = this.position;\r\n            var next = this.nextChunk(data, chunk);\r\n            while (next !== 0) {\r\n                if (next === N_TRI_OBJECT) {\r\n                    this.resetPosition(data);\r\n                    var mesh = this.readMesh(data);\r\n                    mesh.name = name;\r\n                    this.meshes.push(mesh);\r\n                } else {\r\n                    this.debugMessage('Unknown named object chunk: ' + next.toString(16));\r\n                }\r\n                next = this.nextChunk(data, chunk);\r\n            }\r\n            this.endChunk(chunk);\r\n        },\r\n        readMaterialEntry: function (data, path) {\r\n            var chunk = this.readChunk(data);\r\n            var next = this.nextChunk(data, chunk);\r\n            var material = new THREE.MeshPhongMaterial();\r\n            while (next !== 0) {\r\n                if (next === MAT_NAME) {\r\n                    material.name = this.readString(data, 64);\r\n                    this.debugMessage('   Name: ' + material.name);\r\n                } else if (next === MAT_WIRE) {\r\n                    this.debugMessage('   Wireframe');\r\n                    material.wireframe = true;\r\n                } else if (next === MAT_WIRE_SIZE) {\r\n                    var value = this.readByte(data);\r\n                    material.wireframeLinewidth = value;\r\n                    this.debugMessage('   Wireframe Thickness: ' + value);\r\n                } else if (next === MAT_TWO_SIDE) {\r\n                    material.side = THREE.DoubleSide;\r\n                    this.debugMessage('   DoubleSided');\r\n                } else if (next === MAT_ADDITIVE) {\r\n                    this.debugMessage('   Additive Blending');\r\n                    material.blending = THREE.AdditiveBlending;\r\n                } else if (next === MAT_DIFFUSE) {\r\n                    this.debugMessage('   Diffuse Color');\r\n                    material.color = this.readColor(data);\r\n                } else if (next === MAT_SPECULAR) {\r\n                    this.debugMessage('   Specular Color');\r\n                    material.specular = this.readColor(data);\r\n                } else if (next === MAT_AMBIENT) {\r\n                    this.debugMessage('   Ambient color');\r\n                    material.color = this.readColor(data);\r\n                } else if (next === MAT_SHININESS) {\r\n                    var shininess = this.readWord(data);\r\n                    material.shininess = shininess;\r\n                    this.debugMessage('   Shininess : ' + shininess);\r\n                } else if (next === MAT_TRANSPARENCY) {\r\n                    var opacity = this.readWord(data);\r\n                    material.opacity = opacity * 0.01;\r\n                    this.debugMessage('  Opacity : ' + opacity);\r\n                    material.transparent = opacity < 100 ? true : false;\r\n                } else if (next === MAT_TEXMAP) {\r\n                    this.debugMessage('   ColorMap');\r\n                    this.resetPosition(data);\r\n                    material.map = this.readMap(data, path);\r\n                } else if (next === MAT_BUMPMAP) {\r\n                    this.debugMessage('   BumpMap');\r\n                    this.resetPosition(data);\r\n                    material.bumpMap = this.readMap(data, path);\r\n                } else if (next === MAT_OPACMAP) {\r\n                    this.debugMessage('   OpacityMap');\r\n                    this.resetPosition(data);\r\n                    material.alphaMap = this.readMap(data, path);\r\n                } else if (next === MAT_SPECMAP) {\r\n                    this.debugMessage('   SpecularMap');\r\n                    this.resetPosition(data);\r\n                    material.specularMap = this.readMap(data, path);\r\n                } else {\r\n                    this.debugMessage('   Unknown material chunk: ' + next.toString(16));\r\n                }\r\n                next = this.nextChunk(data, chunk);\r\n            }\r\n            this.endChunk(chunk);\r\n            this.materials[material.name] = material;\r\n        },\r\n        readMesh: function (data) {\r\n            var chunk = this.readChunk(data);\r\n            var next = this.nextChunk(data, chunk);\r\n            var geometry = new THREE.BufferGeometry();\r\n            var uvs = [];\r\n            var material = new THREE.MeshPhongMaterial();\r\n            var mesh = new THREE.Mesh(geometry, material);\r\n            mesh.name = 'mesh';\r\n            while (next !== 0) {\r\n                if (next === POINT_ARRAY) {\r\n                    var points = this.readWord(data);\r\n                    this.debugMessage('   Vertex: ' + points);\r\n                    var vertices = [];\r\n                    for (var i = 0; i < points; i++) {\r\n                        vertices.push(this.readFloat(data));\r\n                        vertices.push(this.readFloat(data));\r\n                        vertices.push(this.readFloat(data));\r\n                    }\r\n                    geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));\r\n                } else if (next === FACE_ARRAY) {\r\n                    this.resetPosition(data);\r\n                    this.readFaceArray(data, mesh);\r\n                } else if (next === TEX_VERTS) {\r\n                    var texels = this.readWord(data);\r\n                    this.debugMessage('   UV: ' + texels);\r\n                    var uvs = [];\r\n                    for (var i = 0; i < texels; i++) {\r\n                        uvs.push(this.readFloat(data));\r\n                        uvs.push(this.readFloat(data));\r\n                    }\r\n                    geometry.setAttribute('uv', new THREE.Float32BufferAttribute(uvs, 2));\r\n                } else if (next === MESH_MATRIX) {\r\n                    this.debugMessage('   Tranformation Matrix (TODO)');\r\n                    var values = [];\r\n                    for (var i = 0; i < 12; i++) {\r\n                        values[i] = this.readFloat(data);\r\n                    }\r\n                    var matrix = new THREE.Matrix4();\r\n                    matrix.elements[0] = values[0];\r\n                    matrix.elements[1] = values[6];\r\n                    matrix.elements[2] = values[3];\r\n                    matrix.elements[3] = values[9];\r\n                    matrix.elements[4] = values[2];\r\n                    matrix.elements[5] = values[8];\r\n                    matrix.elements[6] = values[5];\r\n                    matrix.elements[7] = values[11];\r\n                    matrix.elements[8] = values[1];\r\n                    matrix.elements[9] = values[7];\r\n                    matrix.elements[10] = values[4];\r\n                    matrix.elements[11] = values[10];\r\n                    matrix.elements[12] = 0;\r\n                    matrix.elements[13] = 0;\r\n                    matrix.elements[14] = 0;\r\n                    matrix.elements[15] = 1;\r\n                    matrix.transpose();\r\n                    var inverse = new THREE.Matrix4();\r\n                    inverse.getInverse(matrix);\r\n                    geometry.applyMatrix4(inverse);\r\n                    matrix.decompose(mesh.position, mesh.quaternion, mesh.scale);\r\n                } else {\r\n                    this.debugMessage('   Unknown mesh chunk: ' + next.toString(16));\r\n                }\r\n                next = this.nextChunk(data, chunk);\r\n            }\r\n            this.endChunk(chunk);\r\n            geometry.computeVertexNormals();\r\n            return mesh;\r\n        },\r\n        readFaceArray: function (data, mesh) {\r\n            var chunk = this.readChunk(data);\r\n            var faces = this.readWord(data);\r\n            this.debugMessage('   Faces: ' + faces);\r\n            var index = [];\r\n            for (var i = 0; i < faces; ++i) {\r\n                index.push(this.readWord(data), this.readWord(data), this.readWord(data));\r\n                this.readWord(data);\r\n            }\r\n            mesh.geometry.setIndex(index);\r\n            while (this.position < chunk.end) {\r\n                var chunk = this.readChunk(data);\r\n                if (chunk.id === MSH_MAT_GROUP) {\r\n                    this.debugMessage('      Material Group');\r\n                    this.resetPosition(data);\r\n                    var group = this.readMaterialGroup(data);\r\n                    var material = this.materials[group.name];\r\n                    if (material !== undefined) {\r\n                        mesh.material = material;\r\n                        if (material.name === '') {\r\n                            material.name = mesh.name;\r\n                        }\r\n                    }\r\n                } else {\r\n                    this.debugMessage('      Unknown face array chunk: ' + chunk.toString(16));\r\n                }\r\n                this.endChunk(chunk);\r\n            }\r\n            this.endChunk(chunk);\r\n        },\r\n        readMap: function (data, path) {\r\n            var chunk = this.readChunk(data);\r\n            var next = this.nextChunk(data, chunk);\r\n            var texture = {};\r\n            var loader = new THREE.TextureLoader(this.manager);\r\n            loader.setPath(this.resourcePath || path).setCrossOrigin(this.crossOrigin);\r\n            while (next !== 0) {\r\n                if (next === MAT_MAPNAME) {\r\n                    var name = this.readString(data, 128);\r\n                    texture = loader.load(name);\r\n                    this.debugMessage('      File: ' + path + name);\r\n                } else if (next === MAT_MAP_UOFFSET) {\r\n                    texture.offset.x = this.readFloat(data);\r\n                    this.debugMessage('      OffsetX: ' + texture.offset.x);\r\n                } else if (next === MAT_MAP_VOFFSET) {\r\n                    texture.offset.y = this.readFloat(data);\r\n                    this.debugMessage('      OffsetY: ' + texture.offset.y);\r\n                } else if (next === MAT_MAP_USCALE) {\r\n                    texture.repeat.x = this.readFloat(data);\r\n                    this.debugMessage('      RepeatX: ' + texture.repeat.x);\r\n                } else if (next === MAT_MAP_VSCALE) {\r\n                    texture.repeat.y = this.readFloat(data);\r\n                    this.debugMessage('      RepeatY: ' + texture.repeat.y);\r\n                } else {\r\n                    this.debugMessage('      Unknown map chunk: ' + next.toString(16));\r\n                }\r\n                next = this.nextChunk(data, chunk);\r\n            }\r\n            this.endChunk(chunk);\r\n            return texture;\r\n        },\r\n        readMaterialGroup: function (data) {\r\n            this.readChunk(data);\r\n            var name = this.readString(data, 64);\r\n            var numFaces = this.readWord(data);\r\n            this.debugMessage('         Name: ' + name);\r\n            this.debugMessage('         Faces: ' + numFaces);\r\n            var index = [];\r\n            for (var i = 0; i < numFaces; ++i) {\r\n                index.push(this.readWord(data));\r\n            }\r\n            return {\r\n                name: name,\r\n                index: index\r\n            };\r\n        },\r\n        readColor: function (data) {\r\n            var chunk = this.readChunk(data);\r\n            var color = new THREE.Color();\r\n            if (chunk.id === COLOR_24 || chunk.id === LIN_COLOR_24) {\r\n                var r = this.readByte(data);\r\n                var g = this.readByte(data);\r\n                var b = this.readByte(data);\r\n                color.setRGB(r / 255, g / 255, b / 255);\r\n                this.debugMessage('      Color: ' + color.r + ', ' + color.g + ', ' + color.b);\r\n            } else if (chunk.id === COLOR_F || chunk.id === LIN_COLOR_F) {\r\n                var r = this.readFloat(data);\r\n                var g = this.readFloat(data);\r\n                var b = this.readFloat(data);\r\n                color.setRGB(r, g, b);\r\n                this.debugMessage('      Color: ' + color.r + ', ' + color.g + ', ' + color.b);\r\n            } else {\r\n                this.debugMessage('      Unknown color chunk: ' + chunk.toString(16));\r\n            }\r\n            this.endChunk(chunk);\r\n            return color;\r\n        },\r\n        readChunk: function (data) {\r\n            var chunk = {};\r\n            chunk.cur = this.position;\r\n            chunk.id = this.readWord(data);\r\n            chunk.size = this.readDWord(data);\r\n            chunk.end = chunk.cur + chunk.size;\r\n            chunk.cur += 6;\r\n            return chunk;\r\n        },\r\n        endChunk: function (chunk) {\r\n            this.position = chunk.end;\r\n        },\r\n        nextChunk: function (data, chunk) {\r\n            if (chunk.cur >= chunk.end) {\r\n                return 0;\r\n            }\r\n            this.position = chunk.cur;\r\n            try {\r\n                var next = this.readChunk(data);\r\n                chunk.cur += next.size;\r\n                return next.id;\r\n            } catch (e) {\r\n                this.debugMessage('Unable to read chunk at ' + this.position);\r\n                return 0;\r\n            }\r\n        },\r\n        resetPosition: function () {\r\n            this.position -= 6;\r\n        },\r\n        readByte: function (data) {\r\n            var v = data.getUint8(this.position, true);\r\n            this.position += 1;\r\n            return v;\r\n        },\r\n        readFloat: function (data) {\r\n            try {\r\n                var v = data.getFloat32(this.position, true);\r\n                this.position += 4;\r\n                return v;\r\n            } catch (e) {\r\n                this.debugMessage(e + ' ' + this.position + ' ' + data.byteLength);\r\n            }\r\n        },\r\n        readInt: function (data) {\r\n            var v = data.getInt32(this.position, true);\r\n            this.position += 4;\r\n            return v;\r\n        },\r\n        readShort: function (data) {\r\n            var v = data.getInt16(this.position, true);\r\n            this.position += 2;\r\n            return v;\r\n        },\r\n        readDWord: function (data) {\r\n            var v = data.getUint32(this.position, true);\r\n            this.position += 4;\r\n            return v;\r\n        },\r\n        readWord: function (data) {\r\n            var v = data.getUint16(this.position, true);\r\n            this.position += 2;\r\n            return v;\r\n        },\r\n        readString: function (data, maxLength) {\r\n            var s = '';\r\n            for (var i = 0; i < maxLength; i++) {\r\n                var c = this.readByte(data);\r\n                if (!c) {\r\n                    break;\r\n                }\r\n                s += String.fromCharCode(c);\r\n            }\r\n            return s;\r\n        },\r\n        debugMessage: function (message) {\r\n            if (this.debug) {\r\n                console.log(message);\r\n            }\r\n        }\r\n    });\r\n    var M3DMAGIC = 19789;\r\n    var MLIBMAGIC = 15786;\r\n    var CMAGIC = 49725;\r\n    var M3D_VERSION = 2;\r\n    var COLOR_F = 16;\r\n    var COLOR_24 = 17;\r\n    var LIN_COLOR_24 = 18;\r\n    var LIN_COLOR_F = 19;\r\n    var MDATA = 15677;\r\n    var MESH_VERSION = 15678;\r\n    var MASTER_SCALE = 256;\r\n    var MAT_ENTRY = 45055;\r\n    var MAT_NAME = 40960;\r\n    var MAT_AMBIENT = 40976;\r\n    var MAT_DIFFUSE = 40992;\r\n    var MAT_SPECULAR = 41008;\r\n    var MAT_SHININESS = 41024;\r\n    var MAT_TRANSPARENCY = 41040;\r\n    var MAT_TWO_SIDE = 41089;\r\n    var MAT_ADDITIVE = 41091;\r\n    var MAT_WIRE = 41093;\r\n    var MAT_WIRE_SIZE = 41095;\r\n    var MAT_TEXMAP = 41472;\r\n    var MAT_OPACMAP = 41488;\r\n    var MAT_BUMPMAP = 41520;\r\n    var MAT_SPECMAP = 41476;\r\n    var MAT_MAPNAME = 41728;\r\n    var MAT_MAP_USCALE = 41812;\r\n    var MAT_MAP_VSCALE = 41814;\r\n    var MAT_MAP_UOFFSET = 41816;\r\n    var MAT_MAP_VOFFSET = 41818;\r\n    var NAMED_OBJECT = 16384;\r\n    var N_TRI_OBJECT = 16640;\r\n    var POINT_ARRAY = 16656;\r\n    var FACE_ARRAY = 16672;\r\n    var MSH_MAT_GROUP = 16688;\r\n    var TEX_VERTS = 16704;\r\n    var MESH_MATRIX = 16736;\r\n\r\n    return threex.loaders.TDSLoader = TDSLoader;\r\n});"]}