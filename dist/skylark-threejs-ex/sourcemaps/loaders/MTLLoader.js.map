{"version":3,"sources":["loaders/MTLLoader.js"],"names":["define","THREE","threex","MTLLoader","manager","Loader","call","this","prototype","Object","assign","create","constructor","load","url","onLoad","onProgress","onError","scope","path","LoaderUtils","extractUrlBase","loader","FileLoader","setPath","text","parse","setMaterialOptions","value","materialOptions","lines","split","info","delimiter_pattern","materialsInfo","i","length","line","trim","charAt","pos","indexOf","key","substring","toLowerCase","name","ss","parseFloat","materialCreator","MaterialCreator","resourcePath","setCrossOrigin","crossOrigin","setManager","setMaterials","baseUrl","options","materials","materialsArray","nameLookup","side","FrontSide","wrap","RepeatWrapping","convert","converted","mn","mat","covmat","prop","save","lprop","normalizeRGB","ignoreZeroRGBs","preload","getIndex","materialName","getAsArray","index","undefined","createMaterial_","params","setMapForType","mapType","texParams","getTextureParams","map","loadTexture","test","repeat","copy","scale","offset","wrapS","wrapT","n","color","Color","fromArray","specular","emissive","transparent","shininess","opacity","invertTrProperty","MeshPhongMaterial","matParams","Vector2","items","bumpScale","splice","set","join","mapping","texture","DefaultLoadingManager","getHandler","TextureLoader","loaders"],"mappings":"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","file":"../../loaders/MTLLoader.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var MTLLoader = function (manager) {\r\n        THREE.Loader.call(this, manager);\r\n    };\r\n    MTLLoader.prototype = Object.assign(Object.create(THREE.Loader.prototype), {\r\n        constructor: MTLLoader,\r\n        load: function (url, onLoad, onProgress, onError) {\r\n            var scope = this;\r\n            var path = this.path === '' ? THREE.LoaderUtils.extractUrlBase(url) : this.path;\r\n            var loader = new THREE.FileLoader(this.manager);\r\n            loader.setPath(this.path);\r\n            loader.load(url, function (text) {\r\n                onLoad(scope.parse(text, path));\r\n            }, onProgress, onError);\r\n        },\r\n        setMaterialOptions: function (value) {\r\n            this.materialOptions = value;\r\n            return this;\r\n        },\r\n        parse: function (text, path) {\r\n            var lines = text.split('\\n');\r\n            var info = {};\r\n            var delimiter_pattern = /\\s+/;\r\n            var materialsInfo = {};\r\n            for (var i = 0; i < lines.length; i++) {\r\n                var line = lines[i];\r\n                line = line.trim();\r\n                if (line.length === 0 || line.charAt(0) === '#') {\r\n                    continue;\r\n                }\r\n                var pos = line.indexOf(' ');\r\n                var key = pos >= 0 ? line.substring(0, pos) : line;\r\n                key = key.toLowerCase();\r\n                var value = pos >= 0 ? line.substring(pos + 1) : '';\r\n                value = value.trim();\r\n                if (key === 'newmtl') {\r\n                    info = { name: value };\r\n                    materialsInfo[value] = info;\r\n                } else {\r\n                    if (key === 'ka' || key === 'kd' || key === 'ks' || key === 'ke') {\r\n                        var ss = value.split(delimiter_pattern, 3);\r\n                        info[key] = [\r\n                            parseFloat(ss[0]),\r\n                            parseFloat(ss[1]),\r\n                            parseFloat(ss[2])\r\n                        ];\r\n                    } else {\r\n                        info[key] = value;\r\n                    }\r\n                }\r\n            }\r\n            var materialCreator = new MTLLoader.MaterialCreator(this.resourcePath || path, this.materialOptions);\r\n            materialCreator.setCrossOrigin(this.crossOrigin);\r\n            materialCreator.setManager(this.manager);\r\n            materialCreator.setMaterials(materialsInfo);\r\n            return materialCreator;\r\n        }\r\n    });\r\n    MTLLoader.MaterialCreator = function (baseUrl, options) {\r\n        this.baseUrl = baseUrl || '';\r\n        this.options = options;\r\n        this.materialsInfo = {};\r\n        this.materials = {};\r\n        this.materialsArray = [];\r\n        this.nameLookup = {};\r\n        this.side = this.options && this.options.side ? this.options.side : THREE.FrontSide;\r\n        this.wrap = this.options && this.options.wrap ? this.options.wrap : THREE.RepeatWrapping;\r\n    };\r\n    MTLLoader.MaterialCreator.prototype = {\r\n        constructor: MTLLoader.MaterialCreator,\r\n        crossOrigin: 'anonymous',\r\n        setCrossOrigin: function (value) {\r\n            this.crossOrigin = value;\r\n            return this;\r\n        },\r\n        setManager: function (value) {\r\n            this.manager = value;\r\n        },\r\n        setMaterials: function (materialsInfo) {\r\n            this.materialsInfo = this.convert(materialsInfo);\r\n            this.materials = {};\r\n            this.materialsArray = [];\r\n            this.nameLookup = {};\r\n        },\r\n        convert: function (materialsInfo) {\r\n            if (!this.options)\r\n                return materialsInfo;\r\n            var converted = {};\r\n            for (var mn in materialsInfo) {\r\n                var mat = materialsInfo[mn];\r\n                var covmat = {};\r\n                converted[mn] = covmat;\r\n                for (var prop in mat) {\r\n                    var save = true;\r\n                    var value = mat[prop];\r\n                    var lprop = prop.toLowerCase();\r\n                    switch (lprop) {\r\n                    case 'kd':\r\n                    case 'ka':\r\n                    case 'ks':\r\n                        if (this.options && this.options.normalizeRGB) {\r\n                            value = [\r\n                                value[0] / 255,\r\n                                value[1] / 255,\r\n                                value[2] / 255\r\n                            ];\r\n                        }\r\n                        if (this.options && this.options.ignoreZeroRGBs) {\r\n                            if (value[0] === 0 && value[1] === 0 && value[2] === 0) {\r\n                                save = false;\r\n                            }\r\n                        }\r\n                        break;\r\n                    default:\r\n                        break;\r\n                    }\r\n                    if (save) {\r\n                        covmat[lprop] = value;\r\n                    }\r\n                }\r\n            }\r\n            return converted;\r\n        },\r\n        preload: function () {\r\n            for (var mn in this.materialsInfo) {\r\n                this.create(mn);\r\n            }\r\n        },\r\n        getIndex: function (materialName) {\r\n            return this.nameLookup[materialName];\r\n        },\r\n        getAsArray: function () {\r\n            var index = 0;\r\n            for (var mn in this.materialsInfo) {\r\n                this.materialsArray[index] = this.create(mn);\r\n                this.nameLookup[mn] = index;\r\n                index++;\r\n            }\r\n            return this.materialsArray;\r\n        },\r\n        create: function (materialName) {\r\n            if (this.materials[materialName] === undefined) {\r\n                this.createMaterial_(materialName);\r\n            }\r\n            return this.materials[materialName];\r\n        },\r\n        createMaterial_: function (materialName) {\r\n            var scope = this;\r\n            var mat = this.materialsInfo[materialName];\r\n            var params = {\r\n                name: materialName,\r\n                side: this.side\r\n            };\r\n            function resolveURL(baseUrl, url) {\r\n                if (typeof url !== 'string' || url === '')\r\n                    return '';\r\n                if (/^https?:\\/\\//i.test(url))\r\n                    return url;\r\n                return baseUrl + url;\r\n            }\r\n            function setMapForType(mapType, value) {\r\n                if (params[mapType])\r\n                    return;\r\n                var texParams = scope.getTextureParams(value, params);\r\n                var map = scope.loadTexture(resolveURL(scope.baseUrl, texParams.url));\r\n                map.repeat.copy(texParams.scale);\r\n                map.offset.copy(texParams.offset);\r\n                map.wrapS = scope.wrap;\r\n                map.wrapT = scope.wrap;\r\n                params[mapType] = map;\r\n            }\r\n            for (var prop in mat) {\r\n                var value = mat[prop];\r\n                var n;\r\n                if (value === '')\r\n                    continue;\r\n                switch (prop.toLowerCase()) {\r\n                case 'kd':\r\n                    params.color = new THREE.Color().fromArray(value);\r\n                    break;\r\n                case 'ks':\r\n                    params.specular = new THREE.Color().fromArray(value);\r\n                    break;\r\n                case 'ke':\r\n                    params.emissive = new THREE.Color().fromArray(value);\r\n                    break;\r\n                case 'map_kd':\r\n                    setMapForType('map', value);\r\n                    break;\r\n                case 'map_ks':\r\n                    setMapForType('specularMap', value);\r\n                    break;\r\n                case 'map_ke':\r\n                    setMapForType('emissiveMap', value);\r\n                    break;\r\n                case 'norm':\r\n                    setMapForType('normalMap', value);\r\n                    break;\r\n                case 'map_bump':\r\n                case 'bump':\r\n                    setMapForType('bumpMap', value);\r\n                    break;\r\n                case 'map_d':\r\n                    setMapForType('alphaMap', value);\r\n                    params.transparent = true;\r\n                    break;\r\n                case 'ns':\r\n                    params.shininess = parseFloat(value);\r\n                    break;\r\n                case 'd':\r\n                    n = parseFloat(value);\r\n                    if (n < 1) {\r\n                        params.opacity = n;\r\n                        params.transparent = true;\r\n                    }\r\n                    break;\r\n                case 'tr':\r\n                    n = parseFloat(value);\r\n                    if (this.options && this.options.invertTrProperty)\r\n                        n = 1 - n;\r\n                    if (n > 0) {\r\n                        params.opacity = 1 - n;\r\n                        params.transparent = true;\r\n                    }\r\n                    break;\r\n                default:\r\n                    break;\r\n                }\r\n            }\r\n            this.materials[materialName] = new THREE.MeshPhongMaterial(params);\r\n            return this.materials[materialName];\r\n        },\r\n        getTextureParams: function (value, matParams) {\r\n            var texParams = {\r\n                scale: new THREE.Vector2(1, 1),\r\n                offset: new THREE.Vector2(0, 0)\r\n            };\r\n            var items = value.split(/\\s+/);\r\n            var pos;\r\n            pos = items.indexOf('-bm');\r\n            if (pos >= 0) {\r\n                matParams.bumpScale = parseFloat(items[pos + 1]);\r\n                items.splice(pos, 2);\r\n            }\r\n            pos = items.indexOf('-s');\r\n            if (pos >= 0) {\r\n                texParams.scale.set(parseFloat(items[pos + 1]), parseFloat(items[pos + 2]));\r\n                items.splice(pos, 4);\r\n            }\r\n            pos = items.indexOf('-o');\r\n            if (pos >= 0) {\r\n                texParams.offset.set(parseFloat(items[pos + 1]), parseFloat(items[pos + 2]));\r\n                items.splice(pos, 4);\r\n            }\r\n            texParams.url = items.join(' ').trim();\r\n            return texParams;\r\n        },\r\n        loadTexture: function (url, mapping, onLoad, onProgress, onError) {\r\n            var texture;\r\n            var manager = this.manager !== undefined ? this.manager : THREE.DefaultLoadingManager;\r\n            var loader = manager.getHandler(url);\r\n            if (loader === null) {\r\n                loader = new THREE.TextureLoader(manager);\r\n            }\r\n            if (loader.setCrossOrigin)\r\n                loader.setCrossOrigin(this.crossOrigin);\r\n            texture = loader.load(url, onLoad, onProgress, onError);\r\n            if (mapping !== undefined)\r\n                texture.mapping = mapping;\r\n            return texture;\r\n        }\r\n    };\r\n    return threex.loaders.MTLLoader = MTLLoader;\r\n});"]}