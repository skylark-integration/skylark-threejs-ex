{"version":3,"sources":["loaders/MDDLoader.js"],"names":["define","THREE","threex","MDDLoader","manager","Loader","call","this","prototype","Object","assign","create","constructor","load","url","onLoad","onProgress","onError","scope","loader","FileLoader","setPath","path","setResponseType","data","parse","view","DataView","totalFrames","getUint32","totalPoints","offset","times","Float32Array","values","fill","i","getFloat32","track","NumberKeyframeTrack","clip","AnimationClip","length","morphTargets","morphTarget","j","stride","attribute","BufferAttribute","name","push","loaders"],"mappings":";;;;;;;AAAAA,QACI,kBACA,aACD,SACCC,EACAC,GAEA,aACA,IAAIC,EAAY,SAAUC,GACtBH,EAAMI,OAAOC,KAAKC,KAAMH,IAkD5B,OAhDAD,EAAUK,UAAYC,OAAOC,OAAOD,OAAOE,OAAOV,EAAMI,OAAOG,YAC3DI,YAAaT,EACbU,KAAM,SAAUC,EAAKC,EAAQC,EAAYC,GACrC,IAAIC,EAAQX,KACRY,EAAS,IAAIlB,EAAMmB,WAAWb,KAAKH,SACvCe,EAAOE,QAAQd,KAAKe,MACpBH,EAAOI,gBAAgB,eACvBJ,EAAON,KAAKC,EAAK,SAAUU,GACvBT,EAAOG,EAAMO,MAAMD,KACpBR,EAAYC,IAEnBQ,MAAO,SAAUD,GAOb,IANA,IAAIE,EAAO,IAAIC,SAASH,GACpBI,EAAcF,EAAKG,UAAU,GAC7BC,EAAcJ,EAAKG,UAAU,GAC7BE,EAAS,EACTC,EAAQ,IAAIC,aAAaL,GACzBM,EAAS,IAAID,aAAaL,EAAcA,GAAaO,KAAK,GACrDC,EAAI,EAAGA,EAAIR,EAAaQ,IAC7BJ,EAAMI,GAAKV,EAAKW,WAAWN,GAC3BA,GAAU,EACVG,EAAON,EAAcQ,EAAIA,GAAK,EAElC,IAAIE,EAAQ,IAAIrC,EAAMsC,oBAAoB,yBAA0BP,EAAOE,GACvEM,EAAO,IAAIvC,EAAMwC,cAAc,UAAWT,EAAMA,EAAMU,OAAS,IAAKJ,IACpEK,KACJ,IAASP,EAAI,EAAGA,EAAIR,EAAaQ,IAAK,CAElC,IADA,IAAIQ,EAAc,IAAIX,aAA2B,EAAdH,GAC1Be,EAAI,EAAGA,EAAIf,EAAae,IAAK,CAClC,IAAIC,EAAa,EAAJD,EACbD,EAAYE,EAAS,GAAKpB,EAAKW,WAAWN,GAC1CA,GAAU,EACVa,EAAYE,EAAS,GAAKpB,EAAKW,WAAWN,GAC1CA,GAAU,EACVa,EAAYE,EAAS,GAAKpB,EAAKW,WAAWN,GAC1CA,GAAU,EAEd,IAAIgB,EAAY,IAAI9C,EAAM+C,gBAAgBJ,EAAa,GACvDG,EAAUE,KAAO,SAAWb,EAC5BO,EAAaO,KAAKH,GAEtB,OACIJ,aAAcA,EACdH,KAAMA,MAKXtC,EAAOiD,QAAQhD,UAAYA","file":"../../loaders/MDDLoader.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var MDDLoader = function (manager) {\r\n        THREE.Loader.call(this, manager);\r\n    };\r\n    MDDLoader.prototype = Object.assign(Object.create(THREE.Loader.prototype), {\r\n        constructor: MDDLoader,\r\n        load: function (url, onLoad, onProgress, onError) {\r\n            var scope = this;\r\n            var loader = new THREE.FileLoader(this.manager);\r\n            loader.setPath(this.path);\r\n            loader.setResponseType('arraybuffer');\r\n            loader.load(url, function (data) {\r\n                onLoad(scope.parse(data));\r\n            }, onProgress, onError);\r\n        },\r\n        parse: function (data) {\r\n            var view = new DataView(data);\r\n            var totalFrames = view.getUint32(0);\r\n            var totalPoints = view.getUint32(4);\r\n            var offset = 8;\r\n            var times = new Float32Array(totalFrames);\r\n            var values = new Float32Array(totalFrames * totalFrames).fill(0);\r\n            for (var i = 0; i < totalFrames; i++) {\r\n                times[i] = view.getFloat32(offset);\r\n                offset += 4;\r\n                values[totalFrames * i + i] = 1;\r\n            }\r\n            var track = new THREE.NumberKeyframeTrack('.morphTargetInfluences', times, values);\r\n            var clip = new THREE.AnimationClip('default', times[times.length - 1], [track]);\r\n            var morphTargets = [];\r\n            for (var i = 0; i < totalFrames; i++) {\r\n                var morphTarget = new Float32Array(totalPoints * 3);\r\n                for (var j = 0; j < totalPoints; j++) {\r\n                    var stride = j * 3;\r\n                    morphTarget[stride + 0] = view.getFloat32(offset);\r\n                    offset += 4;\r\n                    morphTarget[stride + 1] = view.getFloat32(offset);\r\n                    offset += 4;\r\n                    morphTarget[stride + 2] = view.getFloat32(offset);\r\n                    offset += 4;\r\n                }\r\n                var attribute = new THREE.BufferAttribute(morphTarget, 3);\r\n                attribute.name = 'morph_' + i;\r\n                morphTargets.push(attribute);\r\n            }\r\n            return {\r\n                morphTargets: morphTargets,\r\n                clip: clip\r\n            };\r\n        }\r\n    });\r\n\r\n    return threex.loaders.MDDLoader = MDDLoader;\r\n});"]}