{"version":3,"sources":["loaders/OBJLoader2Parallel.js"],"names":["define","THREE","threex","WorkerExecutionSupport","CodeSerializer","OBJLoader2","OBJLoader2Parser","WorkerRunner","OBJLoader2Parallel","manager","call","this","preferJsmWorker","jsmWorkerUrl","executeParallel","workerExecutionSupport","OBJLOADER2_PARALLEL_VERSION","console","info","DEFAULT_JSM_WORKER_PATH","prototype","Object","assign","create","constructor","setExecuteParallel","setJsmWorker","undefined","getWorkerExecutionSupport","buildWorkerCode","codeBuilderInstructions","CodeBuilderInstructions","isSupportsJsmWorker","setJsmWorkerUrl","isSupportsStandardWorker","objectManipulator","ObjectManipulator","defaultWorkerPayloadHandler","DefaultWorkerPayloadHandler","parser","workerRunner","addCodeFragment","serializeClass","startCode","name","addStartCode","load","content","onLoad","onFileLoadProgress","onError","onMeshAlter","scope","object3d","message","logging","enabled","debug","parse","callbacks","_onLoad","isWorkerLoaded","buildWorker","scopedOnAssetAvailable","payload","_onAssetAvailable","updateCallbacks","baseObject3d","materialHandler","createDefaultMaterials","params","modelName","instanceNo","useIndices","disregardNormals","materialPerSmoothingGroup","useOAsMesh","materials","getMaterialsJSON","data","input","options","dummy","Object3D","loaders"],"mappings":"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","file":"../../loaders/OBJLoader2Parallel.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\",\r\n    './obj2/worker/main/WorkerExecutionSupport',\r\n    './obj2/utils/CodeSerializer',\r\n    './OBJLoader2',\r\n    './obj2/OBJLoader2Parser',\r\n    './obj2/worker/parallel/WorkerRunner'\r\n], function (\r\n    THREE, \r\n    threex,\r\n    WorkerExecutionSupport, \r\n    CodeSerializer, \r\n    OBJLoader2, \r\n    OBJLoader2Parser, \r\n    WorkerRunner\r\n) {\r\n    'use strict';\r\n    const OBJLoader2Parallel = function (manager) {\r\n        OBJLoader2.call(this, manager);\r\n        this.preferJsmWorker = false;\r\n        this.jsmWorkerUrl = null;\r\n        this.executeParallel = true;\r\n        this.workerExecutionSupport = new WorkerExecutionSupport();\r\n    };\r\n    OBJLoader2Parallel.OBJLOADER2_PARALLEL_VERSION = '3.2.0';\r\n    console.info('Using OBJLoader2Parallel version: ' + OBJLoader2Parallel.OBJLOADER2_PARALLEL_VERSION);\r\n    OBJLoader2Parallel.DEFAULT_JSM_WORKER_PATH = './jsm/loaders/obj2/worker/parallel/OBJLoader2JsmWorker';\r\n    OBJLoader2Parallel.prototype = Object.assign(Object.create(OBJLoader2.prototype), {\r\n        constructor: OBJLoader2Parallel,\r\n        setExecuteParallel: function (executeParallel) {\r\n            this.executeParallel = executeParallel === true;\r\n            return this;\r\n        },\r\n        setJsmWorker: function (preferJsmWorker, jsmWorkerUrl) {\r\n            this.preferJsmWorker = preferJsmWorker === true;\r\n            if (jsmWorkerUrl === undefined || jsmWorkerUrl === null) {\r\n                throw 'The url to the jsm worker is not valid. Aborting...';\r\n            }\r\n            this.jsmWorkerUrl = jsmWorkerUrl;\r\n            return this;\r\n        },\r\n        getWorkerExecutionSupport: function () {\r\n            return this.workerExecutionSupport;\r\n        },\r\n        buildWorkerCode: function () {\r\n            let codeBuilderInstructions = new CodeBuilderInstructions(true, true, this.preferJsmWorker);\r\n            if (codeBuilderInstructions.isSupportsJsmWorker()) {\r\n                codeBuilderInstructions.setJsmWorkerUrl(this.jsmWorkerUrl);\r\n            }\r\n            if (codeBuilderInstructions.isSupportsStandardWorker()) {\r\n                let objectManipulator = new ObjectManipulator();\r\n                let defaultWorkerPayloadHandler = new DefaultWorkerPayloadHandler(this.parser);\r\n                let workerRunner = new WorkerRunner({});\r\n                codeBuilderInstructions.addCodeFragment(CodeSerializer.serializeClass(OBJLoader2Parser, this.parser));\r\n                codeBuilderInstructions.addCodeFragment(CodeSerializer.serializeClass(ObjectManipulator, objectManipulator));\r\n                codeBuilderInstructions.addCodeFragment(CodeSerializer.serializeClass(DefaultWorkerPayloadHandler, defaultWorkerPayloadHandler));\r\n                codeBuilderInstructions.addCodeFragment(CodeSerializer.serializeClass(WorkerRunner, workerRunner));\r\n                let startCode = 'new ' + workerRunner.constructor.name + '( new ' + defaultWorkerPayloadHandler.constructor.name + '( new ' + this.parser.constructor.name + '() ) );';\r\n                codeBuilderInstructions.addStartCode(startCode);\r\n            }\r\n            return codeBuilderInstructions;\r\n        },\r\n        load: function (content, onLoad, onFileLoadProgress, onError, onMeshAlter) {\r\n            let scope = this;\r\n            function interceptOnLoad(object3d, message) {\r\n                if (object3d.name === 'OBJLoader2ParallelDummy') {\r\n                    if (scope.parser.logging.enabled && scope.parser.logging.debug) {\r\n                        console.debug('Received dummy answer from OBJLoader2Parallel#parse');\r\n                    }\r\n                } else {\r\n                    onLoad(object3d, message);\r\n                }\r\n            }\r\n            OBJLoader2.prototype.load.call(this, content, interceptOnLoad, onFileLoadProgress, onError, onMeshAlter);\r\n        },\r\n        parse: function (content) {\r\n            if (this.executeParallel) {\r\n                if (this.parser.callbacks.onLoad === this.parser._onLoad) {\r\n                    throw 'No callback other than the default callback was provided! Aborting!';\r\n                }\r\n                if (!this.workerExecutionSupport.isWorkerLoaded(this.preferJsmWorker)) {\r\n                    this.workerExecutionSupport.buildWorker(this.buildWorkerCode());\r\n                    let scope = this;\r\n                    let scopedOnAssetAvailable = function (payload) {\r\n                        scope._onAssetAvailable(payload);\r\n                    };\r\n                    function scopedOnLoad(message) {\r\n                        scope.parser.callbacks.onLoad(scope.baseObject3d, message);\r\n                    }\r\n                    this.workerExecutionSupport.updateCallbacks(scopedOnAssetAvailable, scopedOnLoad);\r\n                }\r\n                this.materialHandler.createDefaultMaterials(false);\r\n                this.workerExecutionSupport.executeParallel({\r\n                    params: {\r\n                        modelName: this.modelName,\r\n                        instanceNo: this.instanceNo,\r\n                        useIndices: this.parser.useIndices,\r\n                        disregardNormals: this.parser.disregardNormals,\r\n                        materialPerSmoothingGroup: this.parser.materialPerSmoothingGroup,\r\n                        useOAsMesh: this.parser.useOAsMesh,\r\n                        materials: this.materialHandler.getMaterialsJSON()\r\n                    },\r\n                    data: {\r\n                        input: content,\r\n                        options: null\r\n                    },\r\n                    logging: {\r\n                        enabled: this.parser.logging.enabled,\r\n                        debug: this.parser.logging.debug\r\n                    }\r\n                });\r\n                let dummy = new THREE.Object3D();\r\n                dummy.name = 'OBJLoader2ParallelDummy';\r\n                return dummy;\r\n            } else {\r\n                return OBJLoader2.prototype.parse.call(this, content);\r\n            }\r\n        }\r\n    });\r\n    return threex.loaders.OBJLoader2Parallel = OBJLoader2Parallel;\r\n});"]}