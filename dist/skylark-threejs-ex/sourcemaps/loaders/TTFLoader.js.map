{"version":3,"sources":["loaders/TTFLoader.js"],"names":["define","THREE","TTFLoader","manager","Loader","call","this","reversed","prototype","Object","assign","create","constructor","load","url","onLoad","onProgress","onError","scope","loader","FileLoader","setPath","path","setResponseType","buffer","parse","arraybuffer","reverseCommands","commands","paths","forEach","c","type","toLowerCase","push","p","result","x","length","y","i","command","undefined","x2","y2","x1","y1","opentype","console","warn","font","round","Math","glyphs","scale","unitsPerEm","glyphIndexMap","encoding","cmap","unicodes","keys","unicode","glyph","token","ha","advanceWidth","x_min","xMin","x_max","xMax","o","String","fromCodePoint","familyName","getEnglishName","ascender","descender","underlinePosition","tables","post","underlineThickness","boundingBox","head","yMin","yMax","resolution","original_font_information","name","convert"],"mappings":"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","file":"../../loaders/TTFLoader.js","sourcesContent":["define([\n    \"skylark-threejs\"\n], function (THREE) {\n    'use strict';\n    var TTFLoader = function (manager) {\n        THREE.Loader.call(this, manager);\n        this.reversed = false;\n    };\n    TTFLoader.prototype = Object.assign(Object.create(THREE.Loader.prototype), {\n        constructor: TTFLoader,\n        load: function (url, onLoad, onProgress, onError) {\n            var scope = this;\n            var loader = new THREE.FileLoader(this.manager);\n            loader.setPath(this.path);\n            loader.setResponseType('arraybuffer');\n            loader.load(url, function (buffer) {\n                onLoad(scope.parse(buffer));\n            }, onProgress, onError);\n        },\n        parse: function (arraybuffer) {\n            function convert(font, reversed) {\n                var round = Math.round;\n                var glyphs = {};\n                var scale = 100000 / ((font.unitsPerEm || 2048) * 72);\n                var glyphIndexMap = font.encoding.cmap.glyphIndexMap;\n                var unicodes = Object.keys(glyphIndexMap);\n                for (var i = 0; i < unicodes.length; i++) {\n                    var unicode = unicodes[i];\n                    var glyph = font.glyphs.glyphs[glyphIndexMap[unicode]];\n                    if (unicode !== undefined) {\n                        var token = {\n                            ha: round(glyph.advanceWidth * scale),\n                            x_min: round(glyph.xMin * scale),\n                            x_max: round(glyph.xMax * scale),\n                            o: ''\n                        };\n                        if (reversed) {\n                            glyph.path.commands = reverseCommands(glyph.path.commands);\n                        }\n                        glyph.path.commands.forEach(function (command) {\n                            if (command.type.toLowerCase() === 'c') {\n                                command.type = 'b';\n                            }\n                            token.o += command.type.toLowerCase() + ' ';\n                            if (command.x !== undefined && command.y !== undefined) {\n                                token.o += round(command.x * scale) + ' ' + round(command.y * scale) + ' ';\n                            }\n                            if (command.x1 !== undefined && command.y1 !== undefined) {\n                                token.o += round(command.x1 * scale) + ' ' + round(command.y1 * scale) + ' ';\n                            }\n                            if (command.x2 !== undefined && command.y2 !== undefined) {\n                                token.o += round(command.x2 * scale) + ' ' + round(command.y2 * scale) + ' ';\n                            }\n                        });\n                        glyphs[String.fromCodePoint(glyph.unicode)] = token;\n                    }\n                }\n                return {\n                    glyphs: glyphs,\n                    familyName: font.getEnglishName('fullName'),\n                    ascender: round(font.ascender * scale),\n                    descender: round(font.descender * scale),\n                    underlinePosition: font.tables.post.underlinePosition,\n                    underlineThickness: font.tables.post.underlineThickness,\n                    boundingBox: {\n                        xMin: font.tables.head.xMin,\n                        xMax: font.tables.head.xMax,\n                        yMin: font.tables.head.yMin,\n                        yMax: font.tables.head.yMax\n                    },\n                    resolution: 1000,\n                    original_font_information: font.tables.name\n                };\n            }\n            function reverseCommands(commands) {\n                var paths = [];\n                var path;\n                commands.forEach(function (c) {\n                    if (c.type.toLowerCase() === 'm') {\n                        path = [c];\n                        paths.push(path);\n                    } else if (c.type.toLowerCase() !== 'z') {\n                        path.push(c);\n                    }\n                });\n                var reversed = [];\n                paths.forEach(function (p) {\n                    var result = {\n                        type: 'm',\n                        x: p[p.length - 1].x,\n                        y: p[p.length - 1].y\n                    };\n                    reversed.push(result);\n                    for (var i = p.length - 1; i > 0; i--) {\n                        var command = p[i];\n                        var result = { type: command.type };\n                        if (command.x2 !== undefined && command.y2 !== undefined) {\n                            result.x1 = command.x2;\n                            result.y1 = command.y2;\n                            result.x2 = command.x1;\n                            result.y2 = command.y1;\n                        } else if (command.x1 !== undefined && command.y1 !== undefined) {\n                            result.x1 = command.x1;\n                            result.y1 = command.y1;\n                        }\n                        result.x = p[i - 1].x;\n                        result.y = p[i - 1].y;\n                        reversed.push(result);\n                    }\n                });\n                return reversed;\n            }\n            if (typeof opentype === 'undefined') {\n                console.warn(\"THREE.TTFLoader: The loader requires opentype.js. Make sure it's included before using the loader.\");\n                return null;\n            }\n            return convert(opentype.parse(arraybuffer), this.reversed);\n        }\n    });\n    return TTFLoader;\n});"]}