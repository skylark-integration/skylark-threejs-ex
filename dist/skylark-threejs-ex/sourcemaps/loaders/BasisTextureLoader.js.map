{"version":3,"sources":["loaders/BasisTextureLoader.js"],"names":["define","THREE","threex","BasisTextureLoader","manager","Loader","call","this","transcoderPath","transcoderBinary","transcoderPending","workerLimit","workerPool","workerNextTaskID","workerSourceURL","workerConfig","format","astcSupported","bptcSupported","etcSupported","dxtSupported","pvrtcSupported","prototype","Object","assign","create","constructor","setTranscoderPath","path","setWorkerLimit","detectSupport","renderer","config","extensions","get","BASIS_FORMAT","cTFASTC_4x4","cTFBC7_M5","cTFBC3","cTFPVRTC1_4_RGBA","Error","cTFETC1","load","url","onLoad","onProgress","onError","loader","FileLoader","setResponseType","buffer","_createTexture","then","catch","worker","taskID","taskCost","byteLength","texturePending","_allocateWorker","_worker","Promise","resolve","reject","_callbacks","postMessage","type","id","message","texture","width","height","mipmaps","CompressedTexture","RGBA_ASTC_4x4_Format","RGBA_BPTC_Format","cTFBC1","DXT_FORMAT_MAP","UnsignedByteType","RGB_ETC1_Format","cTFPVRTC1_4_RGB","RGB_PVRTC_4BPPV1_Format","RGBA_PVRTC_4BPPV1_Format","minFilter","length","LinearFilter","LinearMipmapLinearFilter","magFilter","generateMipmaps","needsUpdate","finally","_taskLoad","_initTranscoder","jsLoader","setPath","jsContent","undefined","binaryLoader","binaryContent","all","fn","BasisWorker","toString","body","substring","indexOf","lastIndexOf","join","URL","createObjectURL","Blob","Worker","onmessage","e","data","console","error","push","sort","a","b","dispose","i","terminate","cTFETC2","cTFBC4","cTFBC5","cTFBC7_M6_OPAQUE_ONLY","cTFATC_RGB","cTFATC_RGBA_INTERPOLATED_ALPHA","cTFRGBA32","cTFRGB565","cTFBGR565","cTFRGBA4444","DXT_FORMAT","COMPRESSED_RGB_S3TC_DXT1_EXT","COMPRESSED_RGBA_S3TC_DXT1_EXT","COMPRESSED_RGBA_S3TC_DXT3_EXT","COMPRESSED_RGBA_S3TC_DXT5_EXT","_BasisFile","wasmBinary","BasisModule","onRuntimeInitialized","BASIS","BasisFile","initializeBasis","hasAlpha","basisFile","Uint8Array","getImageWidth","getImageHeight","levels","getNumLevels","getHasAlpha","cleanup","close","delete","startTranscoding","mip","mipWidth","mipHeight","dst","getImageTranscodedSizeInBytes","status","transcodeImage","transcode","buffers","self","loaders"],"mappings":"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","file":"../../loaders/BasisTextureLoader.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var BasisTextureLoader = function (manager) {\r\n        THREE.Loader.call(this, manager);\r\n        this.transcoderPath = '';\r\n        this.transcoderBinary = null;\r\n        this.transcoderPending = null;\r\n        this.workerLimit = 4;\r\n        this.workerPool = [];\r\n        this.workerNextTaskID = 1;\r\n        this.workerSourceURL = '';\r\n        this.workerConfig = {\r\n            format: null,\r\n            astcSupported: false,\r\n            bptcSupported: false,\r\n            etcSupported: false,\r\n            dxtSupported: false,\r\n            pvrtcSupported: false\r\n        };\r\n    };\r\n    BasisTextureLoader.prototype = Object.assign(Object.create(THREE.Loader.prototype), {\r\n        constructor: BasisTextureLoader,\r\n        setTranscoderPath: function (path) {\r\n            this.transcoderPath = path;\r\n            return this;\r\n        },\r\n        setWorkerLimit: function (workerLimit) {\r\n            this.workerLimit = workerLimit;\r\n            return this;\r\n        },\r\n        detectSupport: function (renderer) {\r\n            var config = this.workerConfig;\r\n            config.astcSupported = !!renderer.extensions.get('WEBGL_compressed_texture_astc');\r\n            config.bptcSupported = !!renderer.extensions.get('EXT_texture_compression_bptc');\r\n            config.etcSupported = !!renderer.extensions.get('WEBGL_compressed_texture_etc1');\r\n            config.dxtSupported = !!renderer.extensions.get('WEBGL_compressed_texture_s3tc');\r\n            config.pvrtcSupported = !!renderer.extensions.get('WEBGL_compressed_texture_pvrtc') || !!renderer.extensions.get('WEBKIT_WEBGL_compressed_texture_pvrtc');\r\n            if (config.astcSupported) {\r\n                config.format = BasisTextureLoader.BASIS_FORMAT.cTFASTC_4x4;\r\n            } else if (config.bptcSupported) {\r\n                config.format = BasisTextureLoader.BASIS_FORMAT.cTFBC7_M5;\r\n            } else if (config.dxtSupported) {\r\n                config.format = BasisTextureLoader.BASIS_FORMAT.cTFBC3;\r\n            } else if (config.pvrtcSupported) {\r\n                config.format = BasisTextureLoader.BASIS_FORMAT.cTFPVRTC1_4_RGBA;\r\n            } else if (config.etcSupported) {\r\n                config.format = BasisTextureLoader.BASIS_FORMAT.cTFETC1;\r\n            } else {\r\n                throw new Error('THREE.BasisTextureLoader: No suitable compressed texture format found.');\r\n            }\r\n            return this;\r\n        },\r\n        load: function (url, onLoad, onProgress, onError) {\r\n            var loader = new THREE.FileLoader(this.manager);\r\n            loader.setResponseType('arraybuffer');\r\n            loader.load(url, buffer => {\r\n                this._createTexture(buffer).then(onLoad).catch(onError);\r\n            }, onProgress, onError);\r\n        },\r\n        _createTexture: function (buffer) {\r\n            var worker;\r\n            var taskID;\r\n            var taskCost = buffer.byteLength;\r\n            var texturePending = this._allocateWorker(taskCost).then(_worker => {\r\n                worker = _worker;\r\n                taskID = this.workerNextTaskID++;\r\n                return new Promise((resolve, reject) => {\r\n                    worker._callbacks[taskID] = {\r\n                        resolve,\r\n                        reject\r\n                    };\r\n                    worker.postMessage({\r\n                        type: 'transcode',\r\n                        id: taskID,\r\n                        buffer\r\n                    }, [buffer]);\r\n                });\r\n            }).then(message => {\r\n                var config = this.workerConfig;\r\n                var {width, height, mipmaps, format} = message;\r\n                var texture;\r\n                switch (format) {\r\n                case BasisTextureLoader.BASIS_FORMAT.cTFASTC_4x4:\r\n                    texture = new THREE.CompressedTexture(mipmaps, width, height, THREE.RGBA_ASTC_4x4_Format);\r\n                    break;\r\n                case BasisTextureLoader.BASIS_FORMAT.cTFBC7_M5:\r\n                    texture = new THREE.CompressedTexture(mipmaps, width, height, THREE.RGBA_BPTC_Format);\r\n                    break;\r\n                case BasisTextureLoader.BASIS_FORMAT.cTFBC1:\r\n                case BasisTextureLoader.BASIS_FORMAT.cTFBC3:\r\n                    texture = new THREE.CompressedTexture(mipmaps, width, height, BasisTextureLoader.DXT_FORMAT_MAP[config.format], THREE.UnsignedByteType);\r\n                    break;\r\n                case BasisTextureLoader.BASIS_FORMAT.cTFETC1:\r\n                    texture = new THREE.CompressedTexture(mipmaps, width, height, THREE.RGB_ETC1_Format);\r\n                    break;\r\n                case BasisTextureLoader.BASIS_FORMAT.cTFPVRTC1_4_RGB:\r\n                    texture = new THREE.CompressedTexture(mipmaps, width, height, THREE.RGB_PVRTC_4BPPV1_Format);\r\n                    break;\r\n                case BasisTextureLoader.BASIS_FORMAT.cTFPVRTC1_4_RGBA:\r\n                    texture = new THREE.CompressedTexture(mipmaps, width, height, THREE.RGBA_PVRTC_4BPPV1_Format);\r\n                    break;\r\n                default:\r\n                    throw new Error('THREE.BasisTextureLoader: No supported format available.');\r\n                }\r\n                texture.minFilter = mipmaps.length === 1 ? THREE.LinearFilter : THREE.LinearMipmapLinearFilter;\r\n                texture.magFilter = THREE.LinearFilter;\r\n                texture.generateMipmaps = false;\r\n                texture.needsUpdate = true;\r\n                return texture;\r\n            });\r\n            texturePending.finally(() => {\r\n                if (worker && taskID) {\r\n                    worker._taskLoad -= taskCost;\r\n                    delete worker._callbacks[taskID];\r\n                }\r\n            });\r\n            return texturePending;\r\n        },\r\n        _initTranscoder: function () {\r\n            if (!this.transcoderPending) {\r\n                var jsLoader = new THREE.FileLoader(this.manager);\r\n                jsLoader.setPath(this.transcoderPath);\r\n                var jsContent = new Promise((resolve, reject) => {\r\n                    jsLoader.load('basis_transcoder', resolve, undefined, reject);\r\n                });\r\n                var binaryLoader = new THREE.FileLoader(this.manager);\r\n                binaryLoader.setPath(this.transcoderPath);\r\n                binaryLoader.setResponseType('arraybuffer');\r\n                var binaryContent = new Promise((resolve, reject) => {\r\n                    binaryLoader.load('basis_transcoder.wasm', resolve, undefined, reject);\r\n                });\r\n                this.transcoderPending = Promise.all([\r\n                    jsContent,\r\n                    binaryContent\r\n                ]).then(([jsContent, binaryContent]) => {\r\n                    var fn = BasisTextureLoader.BasisWorker.toString();\r\n                    var body = [\r\n                        '/* basis_transcoder.js */',\r\n                        jsContent,\r\n                        '/* worker */',\r\n                        fn.substring(fn.indexOf('{') + 1, fn.lastIndexOf('}'))\r\n                    ].join('\\n');\r\n                    this.workerSourceURL = URL.createObjectURL(new Blob([body]));\r\n                    this.transcoderBinary = binaryContent;\r\n                });\r\n            }\r\n            return this.transcoderPending;\r\n        },\r\n        _allocateWorker: function (taskCost) {\r\n            return this._initTranscoder().then(() => {\r\n                if (this.workerPool.length < this.workerLimit) {\r\n                    var worker = new Worker(this.workerSourceURL);\r\n                    worker._callbacks = {};\r\n                    worker._taskLoad = 0;\r\n                    worker.postMessage({\r\n                        type: 'init',\r\n                        config: this.workerConfig,\r\n                        transcoderBinary: this.transcoderBinary\r\n                    });\r\n                    worker.onmessage = function (e) {\r\n                        var message = e.data;\r\n                        switch (message.type) {\r\n                        case 'transcode':\r\n                            worker._callbacks[message.id].resolve(message);\r\n                            break;\r\n                        case 'error':\r\n                            worker._callbacks[message.id].reject(message);\r\n                            break;\r\n                        default:\r\n                            console.error('THREE.BasisTextureLoader: Unexpected message, \"' + message.type + '\"');\r\n                        }\r\n                    };\r\n                    this.workerPool.push(worker);\r\n                } else {\r\n                    this.workerPool.sort(function (a, b) {\r\n                        return a._taskLoad > b._taskLoad ? -1 : 1;\r\n                    });\r\n                }\r\n                var worker = this.workerPool[this.workerPool.length - 1];\r\n                worker._taskLoad += taskCost;\r\n                return worker;\r\n            });\r\n        },\r\n        dispose: function () {\r\n            for (var i = 0; i < this.workerPool.length; i++) {\r\n                this.workerPool[i].terminate();\r\n            }\r\n            this.workerPool.length = 0;\r\n            return this;\r\n        }\r\n    });\r\n    BasisTextureLoader.BASIS_FORMAT = {\r\n        cTFETC1: 0,\r\n        cTFETC2: 1,\r\n        cTFBC1: 2,\r\n        cTFBC3: 3,\r\n        cTFBC4: 4,\r\n        cTFBC5: 5,\r\n        cTFBC7_M6_OPAQUE_ONLY: 6,\r\n        cTFBC7_M5: 7,\r\n        cTFPVRTC1_4_RGB: 8,\r\n        cTFPVRTC1_4_RGBA: 9,\r\n        cTFASTC_4x4: 10,\r\n        cTFATC_RGB: 11,\r\n        cTFATC_RGBA_INTERPOLATED_ALPHA: 12,\r\n        cTFRGBA32: 13,\r\n        cTFRGB565: 14,\r\n        cTFBGR565: 15,\r\n        cTFRGBA4444: 16\r\n    };\r\n    BasisTextureLoader.DXT_FORMAT = {\r\n        COMPRESSED_RGB_S3TC_DXT1_EXT: 33776,\r\n        COMPRESSED_RGBA_S3TC_DXT1_EXT: 33777,\r\n        COMPRESSED_RGBA_S3TC_DXT3_EXT: 33778,\r\n        COMPRESSED_RGBA_S3TC_DXT5_EXT: 33779\r\n    };\r\n    BasisTextureLoader.DXT_FORMAT_MAP = {};\r\n    BasisTextureLoader.DXT_FORMAT_MAP[BasisTextureLoader.BASIS_FORMAT.cTFBC1] = BasisTextureLoader.DXT_FORMAT.COMPRESSED_RGB_S3TC_DXT1_EXT;\r\n    BasisTextureLoader.DXT_FORMAT_MAP[BasisTextureLoader.BASIS_FORMAT.cTFBC3] = BasisTextureLoader.DXT_FORMAT.COMPRESSED_RGBA_S3TC_DXT5_EXT;\r\n    BasisTextureLoader.BasisWorker = function () {\r\n        var config;\r\n        var transcoderPending;\r\n        var _BasisFile;\r\n        onmessage = function (e) {\r\n            var message = e.data;\r\n            switch (message.type) {\r\n            case 'init':\r\n                config = message.config;\r\n                init(message.transcoderBinary);\r\n                break;\r\n            case 'transcode':\r\n                transcoderPending.then(() => {\r\n                    try {\r\n                        var {width, height, hasAlpha, mipmaps, format} = transcode(message.buffer);\r\n                        var buffers = [];\r\n                        for (var i = 0; i < mipmaps.length; ++i) {\r\n                            buffers.push(mipmaps[i].data.buffer);\r\n                        }\r\n                        self.postMessage({\r\n                            type: 'transcode',\r\n                            id: message.id,\r\n                            width,\r\n                            height,\r\n                            hasAlpha,\r\n                            mipmaps,\r\n                            format\r\n                        }, buffers);\r\n                    } catch (error) {\r\n                        console.error(error);\r\n                        self.postMessage({\r\n                            type: 'error',\r\n                            id: message.id,\r\n                            error: error.message\r\n                        });\r\n                    }\r\n                });\r\n                break;\r\n            }\r\n        };\r\n        function init(wasmBinary) {\r\n            var BasisModule;\r\n            transcoderPending = new Promise(resolve => {\r\n                BasisModule = {\r\n                    wasmBinary,\r\n                    onRuntimeInitialized: resolve\r\n                };\r\n                BASIS(BasisModule);\r\n            }).then(() => {\r\n                var {BasisFile, initializeBasis} = BasisModule;\r\n                _BasisFile = BasisFile;\r\n                initializeBasis();\r\n            });\r\n        }\r\n        function transcode(buffer) {\r\n            var basisFile = new _BasisFile(new Uint8Array(buffer));\r\n            var width = basisFile.getImageWidth(0, 0);\r\n            var height = basisFile.getImageHeight(0, 0);\r\n            var levels = basisFile.getNumLevels(0);\r\n            var hasAlpha = basisFile.getHasAlpha();\r\n            function cleanup() {\r\n                basisFile.close();\r\n                basisFile.delete();\r\n            }\r\n            if (!hasAlpha) {\r\n                switch (config.format) {\r\n                case 9:\r\n                    config.format = 8;\r\n                    break;\r\n                default:\r\n                    break;\r\n                }\r\n            }\r\n            if (!width || !height || !levels) {\r\n                cleanup();\r\n                throw new Error('THREE.BasisTextureLoader:  Invalid .basis file');\r\n            }\r\n            if (!basisFile.startTranscoding()) {\r\n                cleanup();\r\n                throw new Error('THREE.BasisTextureLoader: .startTranscoding failed');\r\n            }\r\n            var mipmaps = [];\r\n            for (var mip = 0; mip < levels; mip++) {\r\n                var mipWidth = basisFile.getImageWidth(0, mip);\r\n                var mipHeight = basisFile.getImageHeight(0, mip);\r\n                var dst = new Uint8Array(basisFile.getImageTranscodedSizeInBytes(0, mip, config.format));\r\n                var status = basisFile.transcodeImage(dst, 0, mip, config.format, 0, hasAlpha);\r\n                if (!status) {\r\n                    cleanup();\r\n                    throw new Error('THREE.BasisTextureLoader: .transcodeImage failed.');\r\n                }\r\n                mipmaps.push({\r\n                    data: dst,\r\n                    width: mipWidth,\r\n                    height: mipHeight\r\n                });\r\n            }\r\n            cleanup();\r\n            return {\r\n                width,\r\n                height,\r\n                hasAlpha,\r\n                mipmaps,\r\n                format: config.format\r\n            };\r\n        }\r\n    };\r\n\r\n    return threex.loaders.BasisTextureLoader = BasisTextureLoader;\r\n});"]}