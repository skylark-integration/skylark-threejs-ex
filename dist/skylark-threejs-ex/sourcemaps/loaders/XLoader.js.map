{"version":3,"sources":["loaders/XLoader.js"],"names":["define","THREE","threex","classCallCheck","createClass","XAnimationInfo","XAnimationObj","XKeyFrameInfo","XLoader","instance","Constructor","TypeError","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","protoProps","staticProps","prototype","this","animeName","boneName","targetBone","keyType","frameStartLv","keyFrames","InverseMx","_flags","fps","name","hierarchy","putFlags","undefined","putPos","putRot","putScl","value","XAnimationInfoArray","push","makeBonekeys","keys","time","assign","refObj","parent","keyFrameRefactor","copy","keyframe","pos","rot","scl","matrix","Vector3","setFromMatrixPosition","Quaternion","setFromRotationMatrix","setFromMatrixScale","index","Frame","manager","Loader","call","debug","texloader","TextureLoader","url","_putMatLength","_nowMat","_nowFrameName","frameHierarchie","Hierarchies","HieStack","_currentObject","_currentFrame","_data","onLoad","IsUvYReverse","Meshes","animations","animTicksPerSecond","_currentGeo","_currentAnime","_currentAnimeFrames","_arg","_start","arguments","options","onProgress","onError","_this","_setArgOption","loader","FileLoader","setPath","path","setResponseType","load","response","parse","line","readed","find","indexOf","foundNewLine","substr","binData","reader","DataView","getUint32","byteLength","fileLength","getUint8","buf","array_buffer","Uint8Array","charCodeAt","buffer","LoaderUtils","decodeText","data","_ensureBinary","_ensureString","_isBinary","_parseBinary","_parseASCII","resourcePath","extractUrlBase","setCrossOrigin","crossOrigin","children","_hierarchieParse","_changeRoot","shift","_mainloop","_parent","_end","endRead","find1","findEnd","findNext","nameData","_readLine","trim","word","split","type","refs","end","DataEnder","lastIndexOf","Math","min","nextStart","max","_refs","_this2","_mainProc","worked","setTimeout","models","breakFlag","parseInt","_setFrame","_setFrameTransformMatrix","parentName","_getParentName","VertexSetedBoneCount","GeometryData","vertices","normals","uvs","skinIndices","skinWeights","indices","materialIndices","Materials","normalVectors","BoneInfs","baseFrame","_makeBoneFrom_CurrentFrame","_readVertexDatas","_setMeshTextureCoords","_setMeshMaterialList","_setMaterial","_setSkinWeights","AnimeFrames","_readAnimationKey","console","log","_makeOutputGeometry","_makeOutputAnimation","_obj","FrameTransformMatrix","Matrix4","_ParseMatrixData","b","Bone","applyMatrix4","matrixWorld","putBone","frame","add","mode","mode_local","maxLength","changeMode","_readInt1","_readVertex1","_readFace1","_readNormalVector1","start","refI","parseFloat","bufferGeometry","BufferGeometry","position","l","stride2","stride3","stride4","setAttribute","Float32BufferAttribute","Uint16BufferAttribute","_computeGroups","group","groups","materialIndex","currentMaterialIndex","count","MeshPhongMaterial","color","random","side","FrontSide","r","g","shininess","data2","specular","data3","emissive","localObject","fileName","map","bumpMap","bumpScale","normalMap","normalScale","Vector2","emissiveMap","lightMap","boneInf","XboneInf","BoneIndex","Indeces","Weights","initMatrix","OffsetMatrix","_i","_RootName","_bones","putting","toArray","rotq","mesh","putBones","_makePutBoneList","bi","boneIndex","bb","vi","nowVertexID","nowVal","stride","sk","skinning","offsetList","_bi","_buildGeometry","SkinnedMesh","_initSkeleton","_bufferGeometry","Mesh","worldBaseMx","currentMxFrame","multiply","boneList","boneInverses","bone","gbone","il","bones","fromArray","quaternion","scale","updateMatrixWorld","skeleton","Skeleton","bind","nowKeyType","keyInfo","frameFound","mm","frameValue","animationObj","make","_model","_animation","model","animation","put","findAnimation","c_key","_c_key","k","set","geometry","AnimationClip","parseAnimation","animationMixer","AnimationMixer","targetMatrix","loaders"],"mappings":"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","file":"../../loaders/XLoader.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var XLoader = function () {\r\n        var classCallCheck = function (instance, Constructor) {\r\n            if (!(instance instanceof Constructor)) {\r\n                throw new TypeError('Cannot call a class as a function');\r\n            }\r\n        };\r\n        var createClass = function () {\r\n            function defineProperties(target, props) {\r\n                for (var i = 0; i < props.length; i++) {\r\n                    var descriptor = props[i];\r\n                    descriptor.enumerable = descriptor.enumerable || false;\r\n                    descriptor.configurable = true;\r\n                    if ('value' in descriptor)\r\n                        descriptor.writable = true;\r\n                    Object.defineProperty(target, descriptor.key, descriptor);\r\n                }\r\n            }\r\n            return function (Constructor, protoProps, staticProps) {\r\n                if (protoProps)\r\n                    defineProperties(Constructor.prototype, protoProps);\r\n                if (staticProps)\r\n                    defineProperties(Constructor, staticProps);\r\n                return Constructor;\r\n            };\r\n        }();\r\n        var XboneInf = function XboneInf() {\r\n            classCallCheck(this, XboneInf);\r\n            this.boneName = '';\r\n            this.BoneIndex = 0;\r\n            this.Indeces = [];\r\n            this.Weights = [];\r\n            this.initMatrix = null;\r\n            this.OffsetMatrix = null;\r\n        };\r\n        var XAnimationInfo = function XAnimationInfo() {\r\n            classCallCheck(this, XAnimationInfo);\r\n            this.animeName = '';\r\n            this.boneName = '';\r\n            this.targetBone = null;\r\n            this.keyType = 4;\r\n            this.frameStartLv = 0;\r\n            this.keyFrames = [];\r\n            this.InverseMx = null;\r\n        };\r\n        var XAnimationObj = function () {\r\n            function XAnimationObj(_flags) {\r\n                classCallCheck(this, XAnimationObj);\r\n                this.fps = 30;\r\n                this.name = 'xanimation';\r\n                this.length = 0;\r\n                this.hierarchy = [];\r\n                this.putFlags = _flags;\r\n                if (this.putFlags.putPos === undefined) {\r\n                    this.putFlags.putPos = true;\r\n                }\r\n                if (this.putFlags.putRot === undefined) {\r\n                    this.putFlags.putRot = true;\r\n                }\r\n                if (this.putFlags.putScl === undefined) {\r\n                    this.putFlags.putScl = true;\r\n                }\r\n            }\r\n            createClass(XAnimationObj, [\r\n                {\r\n                    key: 'make',\r\n                    value: function make(XAnimationInfoArray) {\r\n                        for (var i = 0; i < XAnimationInfoArray.length; i++) {\r\n                            this.hierarchy.push(this.makeBonekeys(XAnimationInfoArray[i]));\r\n                        }\r\n                        this.length = this.hierarchy[0].keys[this.hierarchy[0].keys.length - 1].time;\r\n                    }\r\n                },\r\n                {\r\n                    key: 'clone',\r\n                    value: function clone() {\r\n                        return Object.assign({}, this);\r\n                    }\r\n                },\r\n                {\r\n                    key: 'makeBonekeys',\r\n                    value: function makeBonekeys(XAnimationInfo) {\r\n                        var refObj = {};\r\n                        refObj.name = XAnimationInfo.boneName;\r\n                        refObj.parent = '';\r\n                        refObj.keys = this.keyFrameRefactor(XAnimationInfo);\r\n                        refObj.copy = function () {\r\n                            return Object.assign({}, this);\r\n                        };\r\n                        return refObj;\r\n                    }\r\n                },\r\n                {\r\n                    key: 'keyFrameRefactor',\r\n                    value: function keyFrameRefactor(XAnimationInfo) {\r\n                        var keys = [];\r\n                        for (var i = 0; i < XAnimationInfo.keyFrames.length; i++) {\r\n                            var keyframe = {};\r\n                            keyframe.time = XAnimationInfo.keyFrames[i].time * this.fps;\r\n                            if (XAnimationInfo.keyFrames[i].pos && this.putFlags.putPos) {\r\n                                keyframe.pos = XAnimationInfo.keyFrames[i].pos;\r\n                            }\r\n                            if (XAnimationInfo.keyFrames[i].rot && this.putFlags.putRot) {\r\n                                keyframe.rot = XAnimationInfo.keyFrames[i].rot;\r\n                            }\r\n                            if (XAnimationInfo.keyFrames[i].scl && this.putFlags.putScl) {\r\n                                keyframe.scl = XAnimationInfo.keyFrames[i].scl;\r\n                            }\r\n                            if (XAnimationInfo.keyFrames[i].matrix) {\r\n                                keyframe.matrix = XAnimationInfo.keyFrames[i].matrix;\r\n                                if (this.putFlags.putPos) {\r\n                                    keyframe.pos = new THREE.Vector3().setFromMatrixPosition(keyframe.matrix);\r\n                                }\r\n                                if (this.putFlags.putRot) {\r\n                                    keyframe.rot = new THREE.Quaternion().setFromRotationMatrix(keyframe.matrix);\r\n                                }\r\n                                if (this.putFlags.putScl) {\r\n                                    keyframe.scl = new THREE.Vector3().setFromMatrixScale(keyframe.matrix);\r\n                                }\r\n                            }\r\n                            keys.push(keyframe);\r\n                        }\r\n                        return keys;\r\n                    }\r\n                }\r\n            ]);\r\n            return XAnimationObj;\r\n        }();\r\n        var XKeyFrameInfo = function XKeyFrameInfo() {\r\n            classCallCheck(this, XKeyFrameInfo);\r\n            this.index = 0;\r\n            this.Frame = 0;\r\n            this.time = 0;\r\n            this.matrix = null;\r\n        };\r\n        var XLoader = function () {\r\n            function XLoader(manager) {\r\n                THREE.Loader.call(this, manager);\r\n                classCallCheck(this, XLoader);\r\n                this.debug = false;\r\n                this.texloader = new THREE.TextureLoader(this.manager);\r\n                this.url = '';\r\n                this._putMatLength = 0;\r\n                this._nowMat = null;\r\n                this._nowFrameName = '';\r\n                this.frameHierarchie = [];\r\n                this.Hierarchies = {};\r\n                this.HieStack = [];\r\n                this._currentObject = {};\r\n                this._currentFrame = {};\r\n                this._data = null;\r\n                this.onLoad = null;\r\n                this.IsUvYReverse = true;\r\n                this.Meshes = [];\r\n                this.animations = [];\r\n                this.animTicksPerSecond = 30;\r\n                this._currentGeo = null;\r\n                this._currentAnime = null;\r\n                this._currentAnimeFrames = null;\r\n            }\r\n            createClass(XLoader, [\r\n                {\r\n                    key: '_setArgOption',\r\n                    value: function _setArgOption(_arg) {\r\n                        var _start = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;\r\n                        if (!_arg) {\r\n                            return;\r\n                        }\r\n                        for (var i = _start; i < _arg.length; i++) {\r\n                            switch (i) {\r\n                            case 0:\r\n                                this.url = _arg[i];\r\n                                break;\r\n                            case 1:\r\n                                this.options = _arg[i];\r\n                                break;\r\n                            }\r\n                        }\r\n                        if (this.options === undefined) {\r\n                            this.options = {};\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: 'load',\r\n                    value: function load(_arg, onLoad, onProgress, onError) {\r\n                        var _this = this;\r\n                        this._setArgOption(_arg);\r\n                        var loader = new THREE.FileLoader(this.manager);\r\n                        loader.setPath(this.path);\r\n                        loader.setResponseType('arraybuffer');\r\n                        loader.load(this.url, function (response) {\r\n                            _this.parse(response, onLoad);\r\n                        }, onProgress, onError);\r\n                    }\r\n                },\r\n                {\r\n                    key: '_readLine',\r\n                    value: function _readLine(line) {\r\n                        var readed = 0;\r\n                        while (true) {\r\n                            var find = -1;\r\n                            find = line.indexOf('//', readed);\r\n                            if (find === -1) {\r\n                                find = line.indexOf('#', readed);\r\n                            }\r\n                            if (find > -1 && find < 2) {\r\n                                var foundNewLine = -1;\r\n                                foundNewLine = line.indexOf('\\r\\n', readed);\r\n                                if (foundNewLine > 0) {\r\n                                    readed = foundNewLine + 2;\r\n                                } else {\r\n                                    foundNewLine = line.indexOf('\\r', readed);\r\n                                    if (foundNewLine > 0) {\r\n                                        readed = foundNewLine + 1;\r\n                                    } else {\r\n                                        readed = line.indexOf('\\n', readed) + 1;\r\n                                    }\r\n                                }\r\n                            } else {\r\n                                break;\r\n                            }\r\n                        }\r\n                        return line.substr(readed);\r\n                    }\r\n                },\r\n                {\r\n                    key: '_readLine',\r\n                    value: function _readLine(line) {\r\n                        var readed = 0;\r\n                        while (true) {\r\n                            var find = -1;\r\n                            find = line.indexOf('//', readed);\r\n                            if (find === -1) {\r\n                                find = line.indexOf('#', readed);\r\n                            }\r\n                            if (find > -1 && find < 2) {\r\n                                var foundNewLine = -1;\r\n                                foundNewLine = line.indexOf('\\r\\n', readed);\r\n                                if (foundNewLine > 0) {\r\n                                    readed = foundNewLine + 2;\r\n                                } else {\r\n                                    foundNewLine = line.indexOf('\\r', readed);\r\n                                    if (foundNewLine > 0) {\r\n                                        readed = foundNewLine + 1;\r\n                                    } else {\r\n                                        readed = line.indexOf('\\n', readed) + 1;\r\n                                    }\r\n                                }\r\n                            } else {\r\n                                break;\r\n                            }\r\n                        }\r\n                        return line.substr(readed);\r\n                    }\r\n                },\r\n                {\r\n                    key: '_isBinary',\r\n                    value: function _isBinary(binData) {\r\n                        var reader = new DataView(binData);\r\n                        var face_size = 32 / 8 * 3 + 32 / 8 * 3 * 3 + 16 / 8;\r\n                        var n_faces = reader.getUint32(80, true);\r\n                        var expect = 80 + 32 / 8 + n_faces * face_size;\r\n                        if (expect === reader.byteLength) {\r\n                            return true;\r\n                        }\r\n                        var fileLength = reader.byteLength;\r\n                        for (var index = 0; index < fileLength; index++) {\r\n                            if (reader.getUint8(index, false) > 127) {\r\n                                return true;\r\n                            }\r\n                        }\r\n                        return false;\r\n                    }\r\n                },\r\n                {\r\n                    key: '_ensureBinary',\r\n                    value: function _ensureBinary(buf) {\r\n                        if (typeof buf === 'string') {\r\n                            var array_buffer = new Uint8Array(buf.length);\r\n                            for (var i = 0; i < buf.length; i++) {\r\n                                array_buffer[i] = buf.charCodeAt(i) & 255;\r\n                            }\r\n                            return array_buffer.buffer || array_buffer;\r\n                        } else {\r\n                            return buf;\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: '_ensureString',\r\n                    value: function _ensureString(buf) {\r\n                        if (typeof buf !== 'string') {\r\n                            return THREE.LoaderUtils.decodeText(new Uint8Array(buf));\r\n                        } else {\r\n                            return buf;\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: 'parse',\r\n                    value: function _parse(data, onLoad) {\r\n                        var binData = this._ensureBinary(data);\r\n                        this._data = this._ensureString(data);\r\n                        this.onLoad = onLoad;\r\n                        return this._isBinary(binData) ? this._parseBinary(binData) : this._parseASCII();\r\n                    }\r\n                },\r\n                {\r\n                    key: '_parseBinary',\r\n                    value: function _parseBinary(data) {\r\n                        return this._parseASCII(THREE.LoaderUtils.decodeText(new Uint8Array(data)));\r\n                    }\r\n                },\r\n                {\r\n                    key: '_parseASCII',\r\n                    value: function _parseASCII() {\r\n                        var path;\r\n                        if (this.resourcePath !== '') {\r\n                            path = this.resourcePath;\r\n                        } else if (this.path !== '') {\r\n                            path = this.path;\r\n                        } else {\r\n                            path = THREE.LoaderUtils.extractUrlBase(this.url);\r\n                        }\r\n                        this.texloader.setPath(path).setCrossOrigin(this.crossOrigin);\r\n                        var endRead = 16;\r\n                        this.Hierarchies.children = [];\r\n                        this._hierarchieParse(this.Hierarchies, endRead);\r\n                        this._changeRoot();\r\n                        this._currentObject = this.Hierarchies.children.shift();\r\n                        this._mainloop();\r\n                    }\r\n                },\r\n                {\r\n                    key: '_hierarchieParse',\r\n                    value: function _hierarchieParse(_parent, _end) {\r\n                        var endRead = _end;\r\n                        while (true) {\r\n                            var find1 = this._data.indexOf('{', endRead) + 1;\r\n                            var findEnd = this._data.indexOf('}', endRead);\r\n                            var findNext = this._data.indexOf('{', find1) + 1;\r\n                            if (find1 > 0 && findEnd > find1) {\r\n                                var _currentObject = {};\r\n                                _currentObject.children = [];\r\n                                var nameData = this._readLine(this._data.substr(endRead, find1 - endRead - 1)).trim();\r\n                                var word = nameData.split(/ /g);\r\n                                if (word.length > 0) {\r\n                                    _currentObject.type = word[0];\r\n                                    if (word.length >= 2) {\r\n                                        _currentObject.name = word[1];\r\n                                    } else {\r\n                                        _currentObject.name = word[0] + this.Hierarchies.children.length;\r\n                                    }\r\n                                } else {\r\n                                    _currentObject.name = nameData;\r\n                                    _currentObject.type = '';\r\n                                }\r\n                                if (_currentObject.type === 'Animation') {\r\n                                    _currentObject.data = this._data.substr(findNext, findEnd - findNext).trim();\r\n                                    var refs = this._hierarchieParse(_currentObject, findEnd + 1);\r\n                                    endRead = refs.end;\r\n                                    _currentObject.children = refs.parent.children;\r\n                                } else {\r\n                                    var DataEnder = this._data.lastIndexOf(';', findNext > 0 ? Math.min(findNext, findEnd) : findEnd);\r\n                                    _currentObject.data = this._data.substr(find1, DataEnder - find1).trim();\r\n                                    if (findNext <= 0 || findEnd < findNext) {\r\n                                        endRead = findEnd + 1;\r\n                                    } else {\r\n                                        var nextStart = Math.max(DataEnder + 1, find1);\r\n                                        var _refs = this._hierarchieParse(_currentObject, nextStart);\r\n                                        endRead = _refs.end;\r\n                                        _currentObject.children = _refs.parent.children;\r\n                                    }\r\n                                }\r\n                                _currentObject.parent = _parent;\r\n                                if (_currentObject.type != 'template') {\r\n                                    _parent.children.push(_currentObject);\r\n                                }\r\n                            } else {\r\n                                endRead = find1 === -1 ? this._data.length : findEnd + 1;\r\n                                break;\r\n                            }\r\n                        }\r\n                        return {\r\n                            parent: _parent,\r\n                            end: endRead\r\n                        };\r\n                    }\r\n                },\r\n                {\r\n                    key: '_mainloop',\r\n                    value: function _mainloop() {\r\n                        var _this2 = this;\r\n                        this._mainProc();\r\n                        if (this._currentObject.parent || this._currentObject.children.length > 0 || !this._currentObject.worked) {\r\n                            setTimeout(function () {\r\n                                _this2._mainloop();\r\n                            }, 1);\r\n                        } else {\r\n                            setTimeout(function () {\r\n                                _this2.onLoad({\r\n                                    models: _this2.Meshes,\r\n                                    animations: _this2.animations\r\n                                });\r\n                            }, 1);\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: '_mainProc',\r\n                    value: function _mainProc() {\r\n                        var breakFlag = false;\r\n                        while (true) {\r\n                            if (!this._currentObject.worked) {\r\n                                switch (this._currentObject.type) {\r\n                                case 'template':\r\n                                    break;\r\n                                case 'AnimTicksPerSecond':\r\n                                    this.animTicksPerSecond = parseInt(this._currentObject.data);\r\n                                    break;\r\n                                case 'Frame':\r\n                                    this._setFrame();\r\n                                    break;\r\n                                case 'FrameTransformMatrix':\r\n                                    this._setFrameTransformMatrix();\r\n                                    break;\r\n                                case 'Mesh':\r\n                                    this._changeRoot();\r\n                                    this._currentGeo = {};\r\n                                    this._currentGeo.name = this._currentObject.name.trim();\r\n                                    this._currentGeo.parentName = this._getParentName(this._currentObject).trim();\r\n                                    this._currentGeo.VertexSetedBoneCount = [];\r\n                                    this._currentGeo.GeometryData = {\r\n                                        vertices: [],\r\n                                        normals: [],\r\n                                        uvs: [],\r\n                                        skinIndices: [],\r\n                                        skinWeights: [],\r\n                                        indices: [],\r\n                                        materialIndices: []\r\n                                    };\r\n                                    this._currentGeo.Materials = [];\r\n                                    this._currentGeo.normalVectors = [];\r\n                                    this._currentGeo.BoneInfs = [];\r\n                                    this._currentGeo.baseFrame = this._currentFrame;\r\n                                    this._makeBoneFrom_CurrentFrame();\r\n                                    this._readVertexDatas();\r\n                                    breakFlag = true;\r\n                                    break;\r\n                                case 'MeshNormals':\r\n                                    this._readVertexDatas();\r\n                                    break;\r\n                                case 'MeshTextureCoords':\r\n                                    this._setMeshTextureCoords();\r\n                                    break;\r\n                                case 'VertexDuplicationIndices':\r\n                                    break;\r\n                                case 'MeshMaterialList':\r\n                                    this._setMeshMaterialList();\r\n                                    break;\r\n                                case 'Material':\r\n                                    this._setMaterial();\r\n                                    break;\r\n                                case 'SkinWeights':\r\n                                    this._setSkinWeights();\r\n                                    break;\r\n                                case 'AnimationSet':\r\n                                    this._changeRoot();\r\n                                    this._currentAnime = {};\r\n                                    this._currentAnime.name = this._currentObject.name.trim();\r\n                                    this._currentAnime.AnimeFrames = [];\r\n                                    break;\r\n                                case 'Animation':\r\n                                    if (this._currentAnimeFrames) {\r\n                                        this._currentAnime.AnimeFrames.push(this._currentAnimeFrames);\r\n                                    }\r\n                                    this._currentAnimeFrames = new XAnimationInfo();\r\n                                    this._currentAnimeFrames.boneName = this._currentObject.data.trim();\r\n                                    break;\r\n                                case 'AnimationKey':\r\n                                    this._readAnimationKey();\r\n                                    breakFlag = true;\r\n                                    break;\r\n                                }\r\n                                this._currentObject.worked = true;\r\n                            }\r\n                            if (this._currentObject.children.length > 0) {\r\n                                this._currentObject = this._currentObject.children.shift();\r\n                                if (this.debug) {\r\n                                    console.log('processing ' + this._currentObject.name);\r\n                                }\r\n                                if (breakFlag)\r\n                                    break;\r\n                            } else {\r\n                                if (this._currentObject.worked) {\r\n                                    if (this._currentObject.parent && !this._currentObject.parent.parent) {\r\n                                        this._changeRoot();\r\n                                    }\r\n                                }\r\n                                if (this._currentObject.parent) {\r\n                                    this._currentObject = this._currentObject.parent;\r\n                                } else {\r\n                                    breakFlag = true;\r\n                                }\r\n                                if (breakFlag)\r\n                                    break;\r\n                            }\r\n                        }\r\n                        return;\r\n                    }\r\n                },\r\n                {\r\n                    key: '_changeRoot',\r\n                    value: function _changeRoot() {\r\n                        if (this._currentGeo != null && this._currentGeo.name) {\r\n                            this._makeOutputGeometry();\r\n                        }\r\n                        this._currentGeo = {};\r\n                        if (this._currentAnime != null && this._currentAnime.name) {\r\n                            if (this._currentAnimeFrames) {\r\n                                this._currentAnime.AnimeFrames.push(this._currentAnimeFrames);\r\n                                this._currentAnimeFrames = null;\r\n                            }\r\n                            this._makeOutputAnimation();\r\n                        }\r\n                        this._currentAnime = {};\r\n                    }\r\n                },\r\n                {\r\n                    key: '_getParentName',\r\n                    value: function _getParentName(_obj) {\r\n                        if (_obj.parent) {\r\n                            if (_obj.parent.name) {\r\n                                return _obj.parent.name;\r\n                            } else {\r\n                                return this._getParentName(_obj.parent);\r\n                            }\r\n                        } else {\r\n                            return '';\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: '_setFrame',\r\n                    value: function _setFrame() {\r\n                        this._nowFrameName = this._currentObject.name.trim();\r\n                        this._currentFrame = {};\r\n                        this._currentFrame.name = this._nowFrameName;\r\n                        this._currentFrame.children = [];\r\n                        if (this._currentObject.parent && this._currentObject.parent.name) {\r\n                            this._currentFrame.parentName = this._currentObject.parent.name;\r\n                        }\r\n                        this.frameHierarchie.push(this._nowFrameName);\r\n                        this.HieStack[this._nowFrameName] = this._currentFrame;\r\n                    }\r\n                },\r\n                {\r\n                    key: '_setFrameTransformMatrix',\r\n                    value: function _setFrameTransformMatrix() {\r\n                        this._currentFrame.FrameTransformMatrix = new THREE.Matrix4();\r\n                        var data = this._currentObject.data.split(',');\r\n                        this._ParseMatrixData(this._currentFrame.FrameTransformMatrix, data);\r\n                        this._makeBoneFrom_CurrentFrame();\r\n                    }\r\n                },\r\n                {\r\n                    key: '_makeBoneFrom_CurrentFrame',\r\n                    value: function _makeBoneFrom_CurrentFrame() {\r\n                        if (!this._currentFrame.FrameTransformMatrix) {\r\n                            return;\r\n                        }\r\n                        var b = new THREE.Bone();\r\n                        b.name = this._currentFrame.name;\r\n                        b.applyMatrix4(this._currentFrame.FrameTransformMatrix);\r\n                        b.matrixWorld = b.matrix;\r\n                        b.FrameTransformMatrix = this._currentFrame.FrameTransformMatrix;\r\n                        this._currentFrame.putBone = b;\r\n                        if (this._currentFrame.parentName) {\r\n                            for (var frame in this.HieStack) {\r\n                                if (this.HieStack[frame].name === this._currentFrame.parentName) {\r\n                                    this.HieStack[frame].putBone.add(this._currentFrame.putBone);\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: '_readVertexDatas',\r\n                    value: function _readVertexDatas() {\r\n                        var endRead = 0;\r\n                        var mode = 0;\r\n                        var mode_local = 0;\r\n                        var maxLength = 0;\r\n                        while (true) {\r\n                            var changeMode = false;\r\n                            if (mode_local === 0) {\r\n                                var refO = this._readInt1(endRead);\r\n                                endRead = refO.endRead;\r\n                                mode_local = 1;\r\n                                maxLength = this._currentObject.data.indexOf(';;', endRead) + 1;\r\n                                if (maxLength <= 0) {\r\n                                    maxLength = this._currentObject.data.length;\r\n                                }\r\n                            } else {\r\n                                var find = 0;\r\n                                switch (mode) {\r\n                                case 0:\r\n                                    find = this._currentObject.data.indexOf(',', endRead) + 1;\r\n                                    break;\r\n                                case 1:\r\n                                    find = this._currentObject.data.indexOf(';,', endRead) + 1;\r\n                                    break;\r\n                                }\r\n                                if (find === 0 || find > maxLength) {\r\n                                    find = maxLength;\r\n                                    mode_local = 0;\r\n                                    changeMode = true;\r\n                                }\r\n                                switch (this._currentObject.type) {\r\n                                case 'Mesh':\r\n                                    switch (mode) {\r\n                                    case 0:\r\n                                        this._readVertex1(this._currentObject.data.substr(endRead, find - endRead));\r\n                                        break;\r\n                                    case 1:\r\n                                        this._readFace1(this._currentObject.data.substr(endRead, find - endRead));\r\n                                        break;\r\n                                    }\r\n                                    break;\r\n                                case 'MeshNormals':\r\n                                    switch (mode) {\r\n                                    case 0:\r\n                                        this._readNormalVector1(this._currentObject.data.substr(endRead, find - endRead));\r\n                                        break;\r\n                                    }\r\n                                    break;\r\n                                }\r\n                                endRead = find + 1;\r\n                                if (changeMode) {\r\n                                    mode++;\r\n                                }\r\n                            }\r\n                            if (endRead >= this._currentObject.data.length) {\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: '_readInt1',\r\n                    value: function _readInt1(start) {\r\n                        var find = this._currentObject.data.indexOf(';', start);\r\n                        return {\r\n                            refI: parseInt(this._currentObject.data.substr(start, find - start)),\r\n                            endRead: find + 1\r\n                        };\r\n                    }\r\n                },\r\n                {\r\n                    key: '_readVertex1',\r\n                    value: function _readVertex1(line) {\r\n                        var data = this._readLine(line.trim()).substr(0, line.length - 2).split(';');\r\n                        this._currentGeo.GeometryData.vertices.push(parseFloat(data[0]), parseFloat(data[1]), parseFloat(data[2]));\r\n                        this._currentGeo.GeometryData.skinIndices.push(0, 0, 0, 0);\r\n                        this._currentGeo.GeometryData.skinWeights.push(1, 0, 0, 0);\r\n                        this._currentGeo.VertexSetedBoneCount.push(0);\r\n                    }\r\n                },\r\n                {\r\n                    key: '_readFace1',\r\n                    value: function _readFace1(line) {\r\n                        var data = this._readLine(line.trim()).substr(2, line.length - 4).split(',');\r\n                        this._currentGeo.GeometryData.indices.push(parseInt(data[0], 10), parseInt(data[1], 10), parseInt(data[2], 10));\r\n                    }\r\n                },\r\n                {\r\n                    key: '_readNormalVector1',\r\n                    value: function _readNormalVector1(line) {\r\n                        var data = this._readLine(line.trim()).substr(0, line.length - 2).split(';');\r\n                        this._currentGeo.GeometryData.normals.push(parseFloat(data[0]), parseFloat(data[1]), parseFloat(data[2]));\r\n                    }\r\n                },\r\n                {\r\n                    key: '_buildGeometry',\r\n                    value: function _buildGeometry() {\r\n                        var bufferGeometry = new THREE.BufferGeometry();\r\n                        var position = [];\r\n                        var normals = [];\r\n                        var uvs = [];\r\n                        var skinIndices = [];\r\n                        var skinWeights = [];\r\n                        var data = this._currentGeo.GeometryData;\r\n                        for (var i = 0, l = data.indices.length; i < l; i++) {\r\n                            var stride2 = data.indices[i] * 2;\r\n                            var stride3 = data.indices[i] * 3;\r\n                            var stride4 = data.indices[i] * 4;\r\n                            position.push(data.vertices[stride3], data.vertices[stride3 + 1], data.vertices[stride3 + 2]);\r\n                            normals.push(data.normals[stride3], data.normals[stride3 + 1], data.normals[stride3 + 2]);\r\n                            skinIndices.push(data.skinIndices[stride4], data.skinIndices[stride4 + 1], data.skinIndices[stride4 + 2], data.skinIndices[stride4 + 3]);\r\n                            skinWeights.push(data.skinWeights[stride4], data.skinWeights[stride4 + 1], data.skinWeights[stride4 + 2], data.skinWeights[stride4 + 3]);\r\n                            uvs.push(data.uvs[stride2], data.uvs[stride2 + 1]);\r\n                        }\r\n                        bufferGeometry.setAttribute('position', new THREE.Float32BufferAttribute(position, 3));\r\n                        bufferGeometry.setAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));\r\n                        bufferGeometry.setAttribute('uv', new THREE.Float32BufferAttribute(uvs, 2));\r\n                        bufferGeometry.setAttribute('skinIndex', new THREE.Uint16BufferAttribute(skinIndices, 4));\r\n                        bufferGeometry.setAttribute('skinWeight', new THREE.Float32BufferAttribute(skinWeights, 4));\r\n                        this._computeGroups(bufferGeometry, data.materialIndices);\r\n                        return bufferGeometry;\r\n                    }\r\n                },\r\n                {\r\n                    key: '_computeGroups',\r\n                    value: function _computeGroups(bufferGeometry, materialIndices) {\r\n                        var group;\r\n                        var groups = [];\r\n                        var materialIndex = undefined;\r\n                        for (var i = 0; i < materialIndices.length; i++) {\r\n                            var currentMaterialIndex = materialIndices[i];\r\n                            if (currentMaterialIndex !== materialIndex) {\r\n                                materialIndex = currentMaterialIndex;\r\n                                if (group !== undefined) {\r\n                                    group.count = i * 3 - group.start;\r\n                                    groups.push(group);\r\n                                }\r\n                                group = {\r\n                                    start: i * 3,\r\n                                    materialIndex: materialIndex\r\n                                };\r\n                            }\r\n                        }\r\n                        if (group !== undefined) {\r\n                            group.count = i * 3 - group.start;\r\n                            groups.push(group);\r\n                        }\r\n                        bufferGeometry.groups = groups;\r\n                    }\r\n                },\r\n                {\r\n                    key: '_setMeshTextureCoords',\r\n                    value: function _setMeshTextureCoords() {\r\n                        var endRead = 0;\r\n                        var mode = 0;\r\n                        var mode_local = 0;\r\n                        while (true) {\r\n                            switch (mode) {\r\n                            case 0:\r\n                                if (mode_local === 0) {\r\n                                    var refO = this._readInt1(0);\r\n                                    endRead = refO.endRead;\r\n                                    mode_local = 1;\r\n                                } else {\r\n                                    var find = this._currentObject.data.indexOf(',', endRead) + 1;\r\n                                    if (find === 0) {\r\n                                        find = this._currentObject.data.length;\r\n                                        mode = 2;\r\n                                        mode_local = 0;\r\n                                    }\r\n                                    var line = this._currentObject.data.substr(endRead, find - endRead);\r\n                                    var data = this._readLine(line.trim()).split(';');\r\n                                    if (this.IsUvYReverse) {\r\n                                        this._currentGeo.GeometryData.uvs.push(parseFloat(data[0]), 1 - parseFloat(data[1]));\r\n                                    } else {\r\n                                        this._currentGeo.GeometryData.uvs.push(parseFloat(data[0]), parseFloat(data[1]));\r\n                                    }\r\n                                    endRead = find + 1;\r\n                                }\r\n                                break;\r\n                            }\r\n                            if (endRead >= this._currentObject.data.length) {\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: '_setMeshMaterialList',\r\n                    value: function _setMeshMaterialList() {\r\n                        var endRead = 0;\r\n                        var mode = 0;\r\n                        var mode_local = 0;\r\n                        while (true) {\r\n                            if (mode_local < 2) {\r\n                                var refO = this._readInt1(endRead);\r\n                                endRead = refO.endRead;\r\n                                mode_local++;\r\n                            } else {\r\n                                var find = this._currentObject.data.indexOf(';', endRead);\r\n                                if (find === -1) {\r\n                                    find = this._currentObject.data.length;\r\n                                    mode = 3;\r\n                                    mode_local = 0;\r\n                                }\r\n                                var line = this._currentObject.data.substr(endRead, find - endRead);\r\n                                var data = this._readLine(line.trim()).split(',');\r\n                                for (var i = 0; i < data.length; i++) {\r\n                                    this._currentGeo.GeometryData.materialIndices[i] = parseInt(data[i]);\r\n                                }\r\n                                endRead = this._currentObject.data.length;\r\n                            }\r\n                            if (endRead >= this._currentObject.data.length || mode >= 3) {\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: '_setMaterial',\r\n                    value: function _setMaterial() {\r\n                        var _nowMat = new THREE.MeshPhongMaterial({ color: Math.random() * 16777215 });\r\n                        _nowMat.side = THREE.FrontSide;\r\n                        _nowMat.name = this._currentObject.name;\r\n                        var endRead = 0;\r\n                        var find = this._currentObject.data.indexOf(';;', endRead);\r\n                        var line = this._currentObject.data.substr(endRead, find - endRead);\r\n                        var data = this._readLine(line.trim()).split(';');\r\n                        _nowMat.color.r = parseFloat(data[0]);\r\n                        _nowMat.color.g = parseFloat(data[1]);\r\n                        _nowMat.color.b = parseFloat(data[2]);\r\n                        endRead = find + 2;\r\n                        find = this._currentObject.data.indexOf(';', endRead);\r\n                        line = this._currentObject.data.substr(endRead, find - endRead);\r\n                        _nowMat.shininess = parseFloat(this._readLine(line));\r\n                        endRead = find + 1;\r\n                        find = this._currentObject.data.indexOf(';;', endRead);\r\n                        line = this._currentObject.data.substr(endRead, find - endRead);\r\n                        var data2 = this._readLine(line.trim()).split(';');\r\n                        _nowMat.specular.r = parseFloat(data2[0]);\r\n                        _nowMat.specular.g = parseFloat(data2[1]);\r\n                        _nowMat.specular.b = parseFloat(data2[2]);\r\n                        endRead = find + 2;\r\n                        find = this._currentObject.data.indexOf(';;', endRead);\r\n                        if (find === -1) {\r\n                            find = this._currentObject.data.length;\r\n                        }\r\n                        line = this._currentObject.data.substr(endRead, find - endRead);\r\n                        var data3 = this._readLine(line.trim()).split(';');\r\n                        _nowMat.emissive.r = parseFloat(data3[0]);\r\n                        _nowMat.emissive.g = parseFloat(data3[1]);\r\n                        _nowMat.emissive.b = parseFloat(data3[2]);\r\n                        var localObject = null;\r\n                        while (true) {\r\n                            if (this._currentObject.children.length > 0) {\r\n                                localObject = this._currentObject.children.shift();\r\n                                if (this.debug) {\r\n                                    console.log('processing ' + localObject.name);\r\n                                }\r\n                                var fileName = localObject.data.substr(1, localObject.data.length - 2);\r\n                                switch (localObject.type) {\r\n                                case 'TextureFilename':\r\n                                    _nowMat.map = this.texloader.load(fileName);\r\n                                    break;\r\n                                case 'BumpMapFilename':\r\n                                    _nowMat.bumpMap = this.texloader.load(fileName);\r\n                                    _nowMat.bumpScale = 0.05;\r\n                                    break;\r\n                                case 'NormalMapFilename':\r\n                                    _nowMat.normalMap = this.texloader.load(fileName);\r\n                                    _nowMat.normalScale = new THREE.Vector2(2, 2);\r\n                                    break;\r\n                                case 'EmissiveMapFilename':\r\n                                    _nowMat.emissiveMap = this.texloader.load(fileName);\r\n                                    break;\r\n                                case 'LightMapFilename':\r\n                                    _nowMat.lightMap = this.texloader.load(fileName);\r\n                                    break;\r\n                                }\r\n                            } else {\r\n                                break;\r\n                            }\r\n                        }\r\n                        this._currentGeo.Materials.push(_nowMat);\r\n                    }\r\n                },\r\n                {\r\n                    key: '_setSkinWeights',\r\n                    value: function _setSkinWeights() {\r\n                        var boneInf = new XboneInf();\r\n                        var endRead = 0;\r\n                        var find = this._currentObject.data.indexOf(';', endRead);\r\n                        var line = this._currentObject.data.substr(endRead, find - endRead);\r\n                        endRead = find + 1;\r\n                        boneInf.boneName = line.substr(1, line.length - 2);\r\n                        boneInf.BoneIndex = this._currentGeo.BoneInfs.length;\r\n                        find = this._currentObject.data.indexOf(';', endRead);\r\n                        endRead = find + 1;\r\n                        find = this._currentObject.data.indexOf(';', endRead);\r\n                        line = this._currentObject.data.substr(endRead, find - endRead);\r\n                        var data = this._readLine(line.trim()).split(',');\r\n                        for (var i = 0; i < data.length; i++) {\r\n                            boneInf.Indeces.push(parseInt(data[i]));\r\n                        }\r\n                        endRead = find + 1;\r\n                        find = this._currentObject.data.indexOf(';', endRead);\r\n                        line = this._currentObject.data.substr(endRead, find - endRead);\r\n                        var data2 = this._readLine(line.trim()).split(',');\r\n                        for (var _i = 0; _i < data2.length; _i++) {\r\n                            boneInf.Weights.push(parseFloat(data2[_i]));\r\n                        }\r\n                        endRead = find + 1;\r\n                        find = this._currentObject.data.indexOf(';', endRead);\r\n                        if (find <= 0) {\r\n                            find = this._currentObject.data.length;\r\n                        }\r\n                        line = this._currentObject.data.substr(endRead, find - endRead);\r\n                        var data3 = this._readLine(line.trim()).split(',');\r\n                        boneInf.OffsetMatrix = new THREE.Matrix4();\r\n                        this._ParseMatrixData(boneInf.OffsetMatrix, data3);\r\n                        this._currentGeo.BoneInfs.push(boneInf);\r\n                    }\r\n                },\r\n                {\r\n                    key: '_makePutBoneList',\r\n                    value: function _makePutBoneList(_RootName, _bones) {\r\n                        var putting = false;\r\n                        for (var frame in this.HieStack) {\r\n                            if (this.HieStack[frame].name === _RootName || putting) {\r\n                                putting = true;\r\n                                var b = new THREE.Bone();\r\n                                b.name = this.HieStack[frame].name;\r\n                                b.applyMatrix4(this.HieStack[frame].FrameTransformMatrix);\r\n                                b.matrixWorld = b.matrix;\r\n                                b.FrameTransformMatrix = this.HieStack[frame].FrameTransformMatrix;\r\n                                b.pos = new THREE.Vector3().setFromMatrixPosition(FrameTransformMatrix).toArray();\r\n                                b.rotq = new THREE.Quaternion().setFromRotationMatrix(FrameTransformMatrix).toArray();\r\n                                b.scl = new THREE.Vector3().setFromMatrixScale(FrameTransformMatrix).toArray();\r\n                                if (this.HieStack[frame].parentName && this.HieStack[frame].parentName.length > 0) {\r\n                                    for (var i = 0; i < _bones.length; i++) {\r\n                                        if (this.HieStack[frame].parentName === _bones[i].name) {\r\n                                            _bones[i].add(b);\r\n                                            b.parent = i;\r\n                                            break;\r\n                                        }\r\n                                    }\r\n                                }\r\n                                _bones.push(b);\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: '_makeOutputGeometry',\r\n                    value: function _makeOutputGeometry() {\r\n                        var mesh = null;\r\n                        if (this._currentGeo.BoneInfs.length > 0) {\r\n                            var putBones = [];\r\n                            this._makePutBoneList(this._currentGeo.baseFrame.parentName, putBones);\r\n                            for (var bi = 0; bi < this._currentGeo.BoneInfs.length; bi++) {\r\n                                var boneIndex = 0;\r\n                                for (var bb = 0; bb < putBones.length; bb++) {\r\n                                    if (putBones[bb].name === this._currentGeo.BoneInfs[bi].boneName) {\r\n                                        boneIndex = bb;\r\n                                        putBones[bb].OffsetMatrix = new THREE.Matrix4();\r\n                                        putBones[bb].OffsetMatrix.copy(this._currentGeo.BoneInfs[bi].OffsetMatrix);\r\n                                        break;\r\n                                    }\r\n                                }\r\n                                for (var vi = 0; vi < this._currentGeo.BoneInfs[bi].Indeces.length; vi++) {\r\n                                    var nowVertexID = this._currentGeo.BoneInfs[bi].Indeces[vi];\r\n                                    var nowVal = this._currentGeo.BoneInfs[bi].Weights[vi];\r\n                                    var stride = nowVertexID * 4;\r\n                                    switch (this._currentGeo.VertexSetedBoneCount[nowVertexID]) {\r\n                                    case 0:\r\n                                        this._currentGeo.GeometryData.skinIndices[stride] = boneIndex;\r\n                                        this._currentGeo.GeometryData.skinWeights[stride] = nowVal;\r\n                                        break;\r\n                                    case 1:\r\n                                        this._currentGeo.GeometryData.skinIndices[stride + 1] = boneIndex;\r\n                                        this._currentGeo.GeometryData.skinWeights[stride + 1] = nowVal;\r\n                                        break;\r\n                                    case 2:\r\n                                        this._currentGeo.GeometryData.skinIndices[stride + 2] = boneIndex;\r\n                                        this._currentGeo.GeometryData.skinWeights[stride + 2] = nowVal;\r\n                                        break;\r\n                                    case 3:\r\n                                        this._currentGeo.GeometryData.skinIndices[stride + 3] = boneIndex;\r\n                                        this._currentGeo.GeometryData.skinWeights[stride + 3] = nowVal;\r\n                                        break;\r\n                                    }\r\n                                    this._currentGeo.VertexSetedBoneCount[nowVertexID]++;\r\n                                    if (this._currentGeo.VertexSetedBoneCount[nowVertexID] > 4) {\r\n                                        console.log('warn! over 4 bone weight! :' + nowVertexID);\r\n                                    }\r\n                                }\r\n                            }\r\n                            for (var sk = 0; sk < this._currentGeo.Materials.length; sk++) {\r\n                                this._currentGeo.Materials[sk].skinning = true;\r\n                            }\r\n                            var offsetList = [];\r\n                            for (var _bi = 0; _bi < putBones.length; _bi++) {\r\n                                if (putBones[_bi].OffsetMatrix) {\r\n                                    offsetList.push(putBones[_bi].OffsetMatrix);\r\n                                } else {\r\n                                    offsetList.push(new THREE.Matrix4());\r\n                                }\r\n                            }\r\n                            var bufferGeometry = this._buildGeometry();\r\n                            mesh = new THREE.SkinnedMesh(bufferGeometry, this._currentGeo.Materials.length === 1 ? this._currentGeo.Materials[0] : this._currentGeo.Materials);\r\n                            this._initSkeleton(mesh, putBones, offsetList);\r\n                        } else {\r\n                            var _bufferGeometry = this._buildGeometry();\r\n                            mesh = new THREE.Mesh(_bufferGeometry, this._currentGeo.Materials.length === 1 ? this._currentGeo.Materials[0] : this._currentGeo.Materials);\r\n                        }\r\n                        mesh.name = this._currentGeo.name;\r\n                        var worldBaseMx = new THREE.Matrix4();\r\n                        var currentMxFrame = this._currentGeo.baseFrame.putBone;\r\n                        if (currentMxFrame && currentMxFrame.parent) {\r\n                            while (true) {\r\n                                currentMxFrame = currentMxFrame.parent;\r\n                                if (currentMxFrame) {\r\n                                    worldBaseMx.multiply(currentMxFrame.FrameTransformMatrix);\r\n                                } else {\r\n                                    break;\r\n                                }\r\n                            }\r\n                            mesh.applyMatrix4(worldBaseMx);\r\n                        }\r\n                        this.Meshes.push(mesh);\r\n                    }\r\n                },\r\n                {\r\n                    key: '_initSkeleton',\r\n                    value: function _initSkeleton(mesh, boneList, boneInverses) {\r\n                        var bones = [], bone, gbone;\r\n                        var i, il;\r\n                        for (i = 0, il = boneList.length; i < il; i++) {\r\n                            gbone = boneList[i];\r\n                            bone = new THREE.Bone();\r\n                            bones.push(bone);\r\n                            bone.name = gbone.name;\r\n                            bone.position.fromArray(gbone.pos);\r\n                            bone.quaternion.fromArray(gbone.rotq);\r\n                            if (gbone.scl !== undefined)\r\n                                bone.scale.fromArray(gbone.scl);\r\n                        }\r\n                        for (i = 0, il = boneList.length; i < il; i++) {\r\n                            gbone = boneList[i];\r\n                            if (gbone.parent !== -1 && gbone.parent !== null && bones[gbone.parent] !== undefined) {\r\n                                bones[gbone.parent].add(bones[i]);\r\n                            } else {\r\n                                mesh.add(bones[i]);\r\n                            }\r\n                        }\r\n                        mesh.updateMatrixWorld(true);\r\n                        var skeleton = new THREE.Skeleton(bones, boneInverses);\r\n                        mesh.bind(skeleton, mesh.matrixWorld);\r\n                    }\r\n                },\r\n                {\r\n                    key: '_readAnimationKey',\r\n                    value: function _readAnimationKey() {\r\n                        var endRead = 0;\r\n                        var find = this._currentObject.data.indexOf(';', endRead);\r\n                        var line = this._currentObject.data.substr(endRead, find - endRead);\r\n                        endRead = find + 1;\r\n                        var nowKeyType = parseInt(this._readLine(line));\r\n                        find = this._currentObject.data.indexOf(';', endRead);\r\n                        endRead = find + 1;\r\n                        line = this._currentObject.data.substr(endRead);\r\n                        var data = this._readLine(line.trim()).split(';;,');\r\n                        for (var i = 0; i < data.length; i++) {\r\n                            var data2 = data[i].split(';');\r\n                            var keyInfo = new XKeyFrameInfo();\r\n                            keyInfo.type = nowKeyType;\r\n                            keyInfo.Frame = parseInt(data2[0]);\r\n                            keyInfo.index = this._currentAnimeFrames.keyFrames.length;\r\n                            keyInfo.time = keyInfo.Frame;\r\n                            if (nowKeyType != 4) {\r\n                                var frameFound = false;\r\n                                for (var mm = 0; mm < this._currentAnimeFrames.keyFrames.length; mm++) {\r\n                                    if (this._currentAnimeFrames.keyFrames[mm].Frame === keyInfo.Frame) {\r\n                                        keyInfo = this._currentAnimeFrames.keyFrames[mm];\r\n                                        frameFound = true;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                                var frameValue = data2[2].split(',');\r\n                                switch (nowKeyType) {\r\n                                case 0:\r\n                                    keyInfo.rot = new THREE.Quaternion(parseFloat(frameValue[1]), parseFloat(frameValue[2]), parseFloat(frameValue[3]), parseFloat(frameValue[0]) * -1);\r\n                                    break;\r\n                                case 1:\r\n                                    keyInfo.scl = new THREE.Vector3(parseFloat(frameValue[0]), parseFloat(frameValue[1]), parseFloat(frameValue[2]));\r\n                                    break;\r\n                                case 2:\r\n                                    keyInfo.pos = new THREE.Vector3(parseFloat(frameValue[0]), parseFloat(frameValue[1]), parseFloat(frameValue[2]));\r\n                                    break;\r\n                                }\r\n                                if (!frameFound) {\r\n                                    this._currentAnimeFrames.keyFrames.push(keyInfo);\r\n                                }\r\n                            } else {\r\n                                keyInfo.matrix = new THREE.Matrix4();\r\n                                this._ParseMatrixData(keyInfo.matrix, data2[2].split(','));\r\n                                this._currentAnimeFrames.keyFrames.push(keyInfo);\r\n                            }\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    key: '_makeOutputAnimation',\r\n                    value: function _makeOutputAnimation() {\r\n                        var animationObj = new XAnimationObj(this.options);\r\n                        animationObj.fps = this.animTicksPerSecond;\r\n                        animationObj.name = this._currentAnime.name;\r\n                        animationObj.make(this._currentAnime.AnimeFrames);\r\n                        this.animations.push(animationObj);\r\n                    }\r\n                },\r\n                {\r\n                    key: 'assignAnimation',\r\n                    value: function assignAnimation(_model, _animation) {\r\n                        var model = _model;\r\n                        var animation = _animation;\r\n                        if (!model) {\r\n                            model = this.Meshes[0];\r\n                        }\r\n                        if (!animation) {\r\n                            animation = this.animations[0];\r\n                        }\r\n                        if (!model || !animation) {\r\n                            return null;\r\n                        }\r\n                        var put = {};\r\n                        put.fps = animation.fps;\r\n                        put.name = animation.name;\r\n                        put.length = animation.length;\r\n                        put.hierarchy = [];\r\n                        for (var b = 0; b < model.skeleton.bones.length; b++) {\r\n                            var findAnimation = false;\r\n                            for (var i = 0; i < animation.hierarchy.length; i++) {\r\n                                if (model.skeleton.bones[b].name === animation.hierarchy[i].name) {\r\n                                    findAnimation = true;\r\n                                    var c_key = animation.hierarchy[i].copy();\r\n                                    c_key.parent = -1;\r\n                                    if (model.skeleton.bones[b].parent && model.skeleton.bones[b].parent.type === 'Bone') {\r\n                                        for (var bb = 0; bb < put.hierarchy.length; bb++) {\r\n                                            if (put.hierarchy[bb].name === model.skeleton.bones[b].parent.name) {\r\n                                                c_key.parent = bb;\r\n                                                c_key.parentName = model.skeleton.bones[b].parent.name;\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                    put.hierarchy.push(c_key);\r\n                                    break;\r\n                                }\r\n                            }\r\n                            if (!findAnimation) {\r\n                                var _c_key = animation.hierarchy[0].copy();\r\n                                _c_key.name = model.skeleton.bones[b].name;\r\n                                _c_key.parent = -1;\r\n                                for (var k = 0; k < _c_key.keys.length; k++) {\r\n                                    if (_c_key.keys[k].pos) {\r\n                                        _c_key.keys[k].pos.set(0, 0, 0);\r\n                                    }\r\n                                    if (_c_key.keys[k].scl) {\r\n                                        _c_key.keys[k].scl.set(1, 1, 1);\r\n                                    }\r\n                                    if (_c_key.keys[k].rot) {\r\n                                        _c_key.keys[k].rot.set(0, 0, 0, 1);\r\n                                    }\r\n                                }\r\n                                put.hierarchy.push(_c_key);\r\n                            }\r\n                        }\r\n                        if (!model.geometry.animations) {\r\n                            model.geometry.animations = [];\r\n                        }\r\n                        model.geometry.animations.push(THREE.AnimationClip.parseAnimation(put, model.skeleton.bones));\r\n                        if (!model.animationMixer) {\r\n                            model.animationMixer = new THREE.AnimationMixer(model);\r\n                        }\r\n                        return put;\r\n                    }\r\n                },\r\n                {\r\n                    key: '_ParseMatrixData',\r\n                    value: function _ParseMatrixData(targetMatrix, data) {\r\n                        targetMatrix.set(parseFloat(data[0]), parseFloat(data[4]), parseFloat(data[8]), parseFloat(data[12]), parseFloat(data[1]), parseFloat(data[5]), parseFloat(data[9]), parseFloat(data[13]), parseFloat(data[2]), parseFloat(data[6]), parseFloat(data[10]), parseFloat(data[14]), parseFloat(data[3]), parseFloat(data[7]), parseFloat(data[11]), parseFloat(data[15]));\r\n                    }\r\n                }\r\n            ]);\r\n            return XLoader;\r\n        }();\r\n        return XLoader;\r\n    }();\r\n\r\n    return threex.loaders.XLoader = XLoader;\r\n});"]}