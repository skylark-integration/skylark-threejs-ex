{"version":3,"sources":["loaders/KMZLoader.js"],"names":["define","THREE","KMZLoader","manager","Loader","call","this","prototype","Object","assign","create","constructor","load","url","onLoad","onProgress","onError","scope","loader","FileLoader","setPath","path","setResponseType","text","parse","data","LoadingManager","setURLModifier","image","zip","files","substr","length","findFile","console","log","blob","Blob","asArrayBuffer","type","URL","createObjectURL","JSZip","model","DOMParser","parseFromString","asText","querySelector","ColladaLoader","textContent","warn","split","pop","toLowerCase","error","scene","Group"],"mappings":";;;;;;;AAAAA,QACC,kBACA,4BACC,SAASC,GA2GV,OAtGAA,EAAMC,UAAY,SAAWC,GAE5BF,EAAMG,OAAOC,KAAMC,KAAMH,IAI1BF,EAAMC,UAAUK,UAAYC,OAAOC,OAAQD,OAAOE,OAAQT,EAAMG,OAAOG,YAEtEI,YAAaV,EAAMC,UAEnBU,KAAM,SAAWC,EAAKC,EAAQC,EAAYC,GAEzC,IAAIC,EAAQX,KAERY,EAAS,IAAIjB,EAAMkB,WAAYF,EAAMd,SACzCe,EAAOE,QAASH,EAAMI,MACtBH,EAAOI,gBAAiB,eACxBJ,EAAON,KAAMC,EAAK,SAAWU,GAE5BT,EAAQG,EAAMO,MAAOD,KAEnBR,EAAYC,IAIhBQ,MAAO,SAAWC,GAgBjB,IAAItB,EAAU,IAAIF,EAAMyB,eACxBvB,EAAQwB,eAAgB,SAAWd,GAElC,IAAIe,EAjBL,SAAmBf,GAElB,IAAM,IAAIQ,KAAQQ,EAAIC,MAErB,GAAKT,EAAKU,QAAUlB,EAAImB,UAAanB,EAEpC,OAAOgB,EAAIC,MAAOT,GAWRY,CAAUpB,GAEtB,GAAKe,EAAQ,CAEZM,QAAQC,IAAK,UAAWtB,GAExB,IAAIuB,EAAO,IAAIC,MAAQT,EAAMU,kBAAqBC,KAAM,6BACxD,OAAOC,IAAIC,gBAAiBL,GAI7B,OAAOvB,IAMR,IAAIgB,EAAM,IAAIa,MAAOjB,GAErB,GAAKI,EAAIC,MAAO,WAAc,CAE7B,IAEIa,GAFM,IAAIC,WAAYC,gBAAiBhB,EAAIC,MAAO,WAAYgB,SAAU,mBAE5DC,cAAe,6BAE/B,GAAKJ,EAGJ,OADa,IAAI1C,EAAM+C,cAAe7C,GACxBqB,MAAOK,EAAIC,MAAOa,EAAMM,aAAcH,eAQrD,IAAM,IAAIzB,KAFVa,QAAQgB,KAAM,oCAEIrB,EAAIC,MAAQ,CAI7B,GAAmB,QAFHT,EAAK8B,MAAO,KAAMC,MAAMC,cAKvC,OADa,IAAIpD,EAAM+C,cAAe7C,GACxBqB,MAAOK,EAAIC,MAAOT,GAAOyB,UAS1C,OADAZ,QAAQoB,MAAO,wCACNC,MAAO,IAAItD,EAAMuD,UAMrBvD,EAAMC","file":"../../loaders/KMZLoader.js","sourcesContent":["define([\n\t\"skylark-threejs\",\n\t\"../loaders/ColladaLoader\"\n],function(THREE){\n\t/**\n\t * @author mrdoob / http://mrdoob.com/\n\t */\n\n\tTHREE.KMZLoader = function ( manager ) {\n\n\t\tTHREE.Loader.call( this, manager );\n\n\t};\n\n\tTHREE.KMZLoader.prototype = Object.assign( Object.create( THREE.Loader.prototype ), {\n\n\t\tconstructor: THREE.KMZLoader,\n\n\t\tload: function ( url, onLoad, onProgress, onError ) {\n\n\t\t\tvar scope = this;\n\n\t\t\tvar loader = new THREE.FileLoader( scope.manager );\n\t\t\tloader.setPath( scope.path );\n\t\t\tloader.setResponseType( 'arraybuffer' );\n\t\t\tloader.load( url, function ( text ) {\n\n\t\t\t\tonLoad( scope.parse( text ) );\n\n\t\t\t}, onProgress, onError );\n\n\t\t},\n\n\t\tparse: function ( data ) {\n\n\t\t\tfunction findFile( url ) {\n\n\t\t\t\tfor ( var path in zip.files ) {\n\n\t\t\t\t\tif ( path.substr( - url.length ) === url ) {\n\n\t\t\t\t\t\treturn zip.files[ path ];\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tvar manager = new THREE.LoadingManager();\n\t\t\tmanager.setURLModifier( function ( url ) {\n\n\t\t\t\tvar image = findFile( url );\n\n\t\t\t\tif ( image ) {\n\n\t\t\t\t\tconsole.log( 'Loading', url );\n\n\t\t\t\t\tvar blob = new Blob( [ image.asArrayBuffer() ], { type: 'application/octet-stream' } );\n\t\t\t\t\treturn URL.createObjectURL( blob );\n\n\t\t\t\t}\n\n\t\t\t\treturn url;\n\n\t\t\t} );\n\n\t\t\t//\n\n\t\t\tvar zip = new JSZip( data ); // eslint-disable-line no-undef\n\n\t\t\tif ( zip.files[ 'doc.kml' ] ) {\n\n\t\t\t\tvar xml = new DOMParser().parseFromString( zip.files[ 'doc.kml' ].asText(), 'application/xml' );\n\n\t\t\t\tvar model = xml.querySelector( 'Placemark Model Link href' );\n\n\t\t\t\tif ( model ) {\n\n\t\t\t\t\tvar loader = new THREE.ColladaLoader( manager );\n\t\t\t\t\treturn loader.parse( zip.files[ model.textContent ].asText() );\n\n\t\t\t\t}\n\n\t\t\t} else {\n\n\t\t\t\tconsole.warn( 'KMZLoader: Missing doc.kml file.' );\n\n\t\t\t\tfor ( var path in zip.files ) {\n\n\t\t\t\t\tvar extension = path.split( '.' ).pop().toLowerCase();\n\n\t\t\t\t\tif ( extension === 'dae' ) {\n\n\t\t\t\t\t\tvar loader = new THREE.ColladaLoader( manager );\n\t\t\t\t\t\treturn loader.parse( zip.files[ path ].asText() );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tconsole.error( 'KMZLoader: Couldn\\'t find .dae file.' );\n\t\t\treturn { scene: new THREE.Group() };\n\n\t\t}\n\n\t} );\n\t\n\treturn THREE.KMZLoader;\n});\n"]}