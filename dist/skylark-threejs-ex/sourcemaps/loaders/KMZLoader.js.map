{"version":3,"sources":["loaders/KMZLoader.js"],"names":["define","THREE","threex","ColladaLoader","KMZLoader","manager","Loader","call","this","prototype","Object","assign","create","constructor","load","url","onLoad","onProgress","onError","scope","loader","FileLoader","setPath","path","setResponseType","text","parse","data","LoadingManager","setURLModifier","image","zip","files","substr","length","findFile","console","log","blob","Blob","asArrayBuffer","type","URL","createObjectURL","JSZip","model","DOMParser","parseFromString","asText","querySelector","textContent","warn","split","pop","toLowerCase","error","scene","Group","loaders"],"mappings":";;;;;;;AAAAA,QACI,kBACA,YACA,mBACD,SACCC,EACAC,EACAC,GAEA,aACA,IAAIC,EAAY,SAAUC,GACtBJ,EAAMK,OAAOC,KAAKC,KAAMH,IAsD5B,OApDAD,EAAUK,UAAYC,OAAOC,OAAOD,OAAOE,OAAOX,EAAMK,OAAOG,YAC3DI,YAAaT,EACbU,KAAM,SAAUC,EAAKC,EAAQC,EAAYC,GACrC,IAAIC,EAAQX,KACRY,EAAS,IAAInB,EAAMoB,WAAWF,EAAMd,SACxCe,EAAOE,QAAQH,EAAMI,MACrBH,EAAOI,gBAAgB,eACvBJ,EAAON,KAAKC,EAAK,SAAUU,GACvBT,EAAOG,EAAMO,MAAMD,KACpBR,EAAYC,IAEnBQ,MAAO,SAAUC,GAQb,IAAItB,EAAU,IAAIJ,EAAM2B,eACxBvB,EAAQwB,eAAe,SAAUd,GAC7B,IAAIe,EATR,SAAkBf,GACd,IAAK,IAAIQ,KAAQQ,EAAIC,MACjB,GAAIT,EAAKU,QAAQlB,EAAImB,UAAYnB,EAC7B,OAAOgB,EAAIC,MAAMT,GAMbY,CAASpB,GACrB,GAAIe,EAAO,CACPM,QAAQC,IAAI,UAAWtB,GACvB,IAAIuB,EAAO,IAAIC,MAAMT,EAAMU,kBAAoBC,KAAM,6BACrD,OAAOC,IAAIC,gBAAgBL,GAE/B,OAAOvB,IAEX,IAAIgB,EAAM,IAAIa,MAAMjB,GACpB,GAAII,EAAIC,MAAM,WAAY,CACtB,IACIa,GADM,IAAIC,WAAYC,gBAAgBhB,EAAIC,MAAM,WAAWgB,SAAU,mBACzDC,cAAc,6BAC9B,GAAIJ,EAEA,OADa,IAAI1C,EAAcE,GACjBqB,MAAMK,EAAIC,MAAMa,EAAMK,aAAaF,eAIrD,IAAK,IAAIzB,KADTa,QAAQe,KAAK,oCACIpB,EAAIC,MAAO,CAExB,GAAkB,QADFT,EAAK6B,MAAM,KAAKC,MAAMC,cAGlC,OADa,IAAInD,EAAcE,GACjBqB,MAAMK,EAAIC,MAAMT,GAAMyB,UAKhD,OADAZ,QAAQmB,MAAM,wCACLC,MAAO,IAAIvD,EAAMwD,UAI3BvD,EAAOwD,QAAQtD,UAAYA","file":"../../loaders/KMZLoader.js","sourcesContent":["define([\n    \"skylark-threejs\",\n    \"../threex\",\n    './ColladaLoader'\n], function (\n    THREE, \n    threex,\n    ColladaLoader\n) {\n    'use strict';\n    var KMZLoader = function (manager) {\n        THREE.Loader.call(this, manager);\n    };\n    KMZLoader.prototype = Object.assign(Object.create(THREE.Loader.prototype), {\n        constructor: KMZLoader,\n        load: function (url, onLoad, onProgress, onError) {\n            var scope = this;\n            var loader = new THREE.FileLoader(scope.manager);\n            loader.setPath(scope.path);\n            loader.setResponseType('arraybuffer');\n            loader.load(url, function (text) {\n                onLoad(scope.parse(text));\n            }, onProgress, onError);\n        },\n        parse: function (data) {\n            function findFile(url) {\n                for (var path in zip.files) {\n                    if (path.substr(-url.length) === url) {\n                        return zip.files[path];\n                    }\n                }\n            }\n            var manager = new THREE.LoadingManager();\n            manager.setURLModifier(function (url) {\n                var image = findFile(url);\n                if (image) {\n                    console.log('Loading', url);\n                    var blob = new Blob([image.asArrayBuffer()], { type: 'application/octet-stream' });\n                    return URL.createObjectURL(blob);\n                }\n                return url;\n            });\n            var zip = new JSZip(data);\n            if (zip.files['doc.kml']) {\n                var xml = new DOMParser().parseFromString(zip.files['doc.kml'].asText(), 'application/xml');\n                var model = xml.querySelector('Placemark Model Link href');\n                if (model) {\n                    var loader = new ColladaLoader(manager);\n                    return loader.parse(zip.files[model.textContent].asText());\n                }\n            } else {\n                console.warn('KMZLoader: Missing doc.kml file.');\n                for (var path in zip.files) {\n                    var extension = path.split('.').pop().toLowerCase();\n                    if (extension === 'dae') {\n                        var loader = new ColladaLoader(manager);\n                        return loader.parse(zip.files[path].asText());\n                    }\n                }\n            }\n            console.error(\"KMZLoader: Couldn't find .dae file.\");\n            return { scene: new THREE.Group() };\n        }\n    });\n\n    return threex.loaders.KMZLoader = KMZLoader;\n});"]}