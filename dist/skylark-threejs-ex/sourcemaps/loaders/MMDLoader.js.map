{"version":3,"sources":["loaders/MMDLoader.js"],"names":["define","THREE","threex","TGALoader","MMDParser","MMDLoader","manager","Loader","call","this","loader","FileLoader","parser","meshBuilder","MeshBuilder","animationBuilder","AnimationBuilder","prototype","Object","assign","create","constructor","setAnimationPath","animationPath","load","url","onLoad","onProgress","onError","resourcePath","builder","setCrossOrigin","crossOrigin","path","LoaderUtils","extractUrlBase","modelExtension","_extractExtension","toLowerCase","data","build","Error","loadAnimation","object","loadVMD","vmd","isCamera","buildCameraAnimation","loadWithAnimation","modelUrl","vmdUrl","scope","mesh","animation","loadPMD","_getParser","setMimeType","undefined","setPath","setResponseType","buffer","parsePmd","loadPMX","parsePmx","urls","Array","isArray","vmds","vmdNum","length","i","il","push","parseVmd","mergeVmds","loadVPD","isUnicode","text","parseVpd","index","lastIndexOf","slice","Parser","DEFAULT_TOON_TEXTURES","geometryBuilder","GeometryBuilder","materialBuilder","MaterialBuilder","textureLoader","TextureLoader","tgaLoader","CubicBezierInterpolation","parameterPositions","sampleValues","sampleSize","resultBuffer","params","Interpolant","interpolationParams","geometry","material","setResourcePath","SkinnedMesh","skeleton","Skeleton","bone","gbone","bones","Bone","name","position","fromArray","pos","quaternion","rotq","scl","scale","parent","add","updateMatrixWorld","initBones","bind","positions","uvs","normals","indices","groups","skinIndices","skinWeights","morphTargets","morphPositions","iks","grants","rigidBodies","constraints","offset","boneTypeTable","metadata","vertexCount","v","vertices","j","jl","normal","uv","faceCount","face","faces","materialCount","materials","count","rigidBodyCount","body","value","boneIndex","type","Math","max","boneCount","boneData","parentIndex","rigidBodyType","format","ikCount","param","target","ik","effector","iteration","maxAngle","links","link","enabled","indexOf","limitation","Vector3","angleLimitation","rotationMin","lowerLimitationAngle","rotationMax","upperLimitationAngle","tmp1","tmp2","grant","ratio","isLocal","affectRotation","affectPosition","transformationClass","sort","a","b","updateAttributes","attribute","morph","elementCount","element","elements","morphs","array","morphCount","Float32BufferAttribute","morph2","rigidBody","key","constraintCount","constraint","bodyA","rigidBodyIndex1","bodyB","rigidBodyIndex2","BufferGeometry","setAttribute","Uint16BufferAttribute","setIndex","addGroup","morphAttributes","morphTargetsRelative","userData","MMD","computeBoundingSphere","textures","color","Color","diffuse","opacity","specular","emissive","ambient","shininess","transparent","skinning","fog","blending","CustomBlending","blendSrc","SrcAlphaFactor","blendDst","OneMinusSrcAlphaFactor","blendSrcAlpha","blendDstAlpha","DstAlphaFactor","flag","side","DoubleSide","FrontSide","fileName","fileNames","split","map","_loadTexture","extension","envMap","sphericalReflectionMapping","combine","MultiplyOperation","AddOperation","toonFileName","toonIndex","toonTextures","gradientMap","isToonTexture","isDefaultToonTexture","_isDefaultToonTexture","outlineParameters","thickness","edgeFlag","alpha","visible","isDefaultToon","textureIndex","envTextureIndex","envFlag","toonFlag","edgeSize","edgeColor","_checkImageTransparency","multiplyScalar","MeshToonMaterial","checkAlphaMorph","_getTGALoader","test","filePath","fullPath","parseInt","match","e","console","warn","getHandler","texture","t","image","_getRotatedImage","magFilter","NearestFilter","minFilter","flipY","wrapS","RepeatWrapping","wrapT","readyCallbacks","mapping","SphericalReflectionMapping","canvas","document","createElement","context","getContext","width","height","clearRect","translate","rotate","PI","drawImage","getImageData","groupIndex","getAlphaByUv","x","round","y","imageData","createImageData","group","centerUV","detectImageTransparency","attributes","start","tracks","buildSkeletalAnimation","tracks2","buildMorphAnimation","AnimationClip","pushInterpolation","interpolation","motions","boneNameDictionary","motionCount","motion","boneName","frameNum","times","rotations","pInterpolations","rInterpolations","basePosition","getBoneByName","toArray","time","rotation","targetName","_createTrack","VectorKeyframeTrack","QuaternionKeyframeTrack","morphTargetDictionary","morphName","values","weight","NumberKeyframeTrack","pushVector3","vec","z","cameras","q","centers","quaternions","fovs","cInterpolations","qInterpolations","fInterpolations","Quaternion","euler","Euler","center","rot","distance","fov","set","setFromEuler","applyQuaternion","w","node","typedKeyframeTrack","interpolations","stride","interpolateStride","aheadIndex","endIndex","track","createInterpolant","result","getValueSize","Float32Array","interpolate_","i1","t0","t1","valueSize","offset1","offset0","weight1","x1","x2","y1","y2","_calculate","slerpFlat","sst3","stt3","ttt","c","s","math","ft","abs","loaders"],"mappings":"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","file":"../../loaders/MMDLoader.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\",\r\n    '../loaders/TGALoader',\r\n    '../libs/mmdparser'\r\n], function (\r\n    THREE, \r\n    threex,\r\n    TGALoader, \r\n    MMDParser\r\n) {\r\n    'use strict';\r\n    var MMDLoader = function () {\r\n        function MMDLoader(manager) {\r\n             THREE.Loader.call(this, manager);\r\n            this.loader = new  THREE.FileLoader(this.manager);\r\n            this.parser = null;\r\n            this.meshBuilder = new MeshBuilder(this.manager);\r\n            this.animationBuilder = new AnimationBuilder();\r\n        }\r\n        MMDLoader.prototype = Object.assign(Object.create( THREE.Loader.prototype), {\r\n            constructor: MMDLoader,\r\n            setAnimationPath: function (animationPath) {\r\n                this.animationPath = animationPath;\r\n                return this;\r\n            },\r\n            load: function (url, onLoad, onProgress, onError) {\r\n                var builder = this.meshBuilder.setCrossOrigin(this.crossOrigin);\r\n                var resourcePath;\r\n                if (this.resourcePath !== '') {\r\n                    resourcePath = this.resourcePath;\r\n                } else if (this.path !== '') {\r\n                    resourcePath = this.path;\r\n                } else {\r\n                    resourcePath =  THREE.LoaderUtils.extractUrlBase(url);\r\n                }\r\n                var modelExtension = this._extractExtension(url).toLowerCase();\r\n                if (modelExtension !== 'pmd' && modelExtension !== 'pmx') {\r\n                    if (onError)\r\n                        onError(new Error('THREE.MMDLoader: Unknown model file extension .' + modelExtension + '.'));\r\n                    return;\r\n                }\r\n                this[modelExtension === 'pmd' ? 'loadPMD' : 'loadPMX'](url, function (data) {\r\n                    onLoad(builder.build(data, resourcePath, onProgress, onError));\r\n                }, onProgress, onError);\r\n            },\r\n            loadAnimation: function (url, object, onLoad, onProgress, onError) {\r\n                var builder = this.animationBuilder;\r\n                this.loadVMD(url, function (vmd) {\r\n                    onLoad(object.isCamera ? builder.buildCameraAnimation(vmd) : builder.build(vmd, object));\r\n                }, onProgress, onError);\r\n            },\r\n            loadWithAnimation: function (modelUrl, vmdUrl, onLoad, onProgress, onError) {\r\n                var scope = this;\r\n                this.load(modelUrl, function (mesh) {\r\n                    scope.loadAnimation(vmdUrl, mesh, function (animation) {\r\n                        onLoad({\r\n                            mesh: mesh,\r\n                            animation: animation\r\n                        });\r\n                    }, onProgress, onError);\r\n                }, onProgress, onError);\r\n            },\r\n            loadPMD: function (url, onLoad, onProgress, onError) {\r\n                var parser = this._getParser();\r\n                this.loader.setMimeType(undefined).setPath(this.path).setResponseType('arraybuffer').load(url, function (buffer) {\r\n                    onLoad(parser.parsePmd(buffer, true));\r\n                }, onProgress, onError);\r\n            },\r\n            loadPMX: function (url, onLoad, onProgress, onError) {\r\n                var parser = this._getParser();\r\n                this.loader.setMimeType(undefined).setPath(this.path).setResponseType('arraybuffer').load(url, function (buffer) {\r\n                    onLoad(parser.parsePmx(buffer, true));\r\n                }, onProgress, onError);\r\n            },\r\n            loadVMD: function (url, onLoad, onProgress, onError) {\r\n                var urls = Array.isArray(url) ? url : [url];\r\n                var vmds = [];\r\n                var vmdNum = urls.length;\r\n                var parser = this._getParser();\r\n                this.loader.setMimeType(undefined).setPath(this.animationPath).setResponseType('arraybuffer');\r\n                for (var i = 0, il = urls.length; i < il; i++) {\r\n                    this.loader.load(urls[i], function (buffer) {\r\n                        vmds.push(parser.parseVmd(buffer, true));\r\n                        if (vmds.length === vmdNum)\r\n                            onLoad(parser.mergeVmds(vmds));\r\n                    }, onProgress, onError);\r\n                }\r\n            },\r\n            loadVPD: function (url, isUnicode, onLoad, onProgress, onError) {\r\n                var parser = this._getParser();\r\n                this.loader.setMimeType(isUnicode ? undefined : 'text/plain; charset=shift_jis').setPath(this.animationPath).setResponseType('text').load(url, function (text) {\r\n                    onLoad(parser.parseVpd(text, true));\r\n                }, onProgress, onError);\r\n            },\r\n            _extractExtension: function (url) {\r\n                var index = url.lastIndexOf('.');\r\n                return index < 0 ? '' : url.slice(index + 1);\r\n            },\r\n            _getParser: function () {\r\n                if (this.parser === null) {\r\n                    if (typeof MMDParser === 'undefined') {\r\n                        throw new Error('THREE.MMDLoader: Import MMDParser https://github.com/takahirox/mmd-parser');\r\n                    }\r\n                    this.parser = new MMDParser.Parser();\r\n                }\r\n                return this.parser;\r\n            }\r\n        });\r\n        var DEFAULT_TOON_TEXTURES = [\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==',\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC',\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==',\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==',\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=',\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=',\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\r\n            'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII='\r\n        ];\r\n        function MeshBuilder(manager) {\r\n            this.geometryBuilder = new GeometryBuilder();\r\n            this.materialBuilder = new MaterialBuilder(manager);\r\n        }\r\n        MeshBuilder.prototype = {\r\n            constructor: MeshBuilder,\r\n            crossOrigin: 'anonymous',\r\n            setCrossOrigin: function (crossOrigin) {\r\n                this.crossOrigin = crossOrigin;\r\n                return this;\r\n            },\r\n            build: function (data, resourcePath, onProgress, onError) {\r\n                var geometry = this.geometryBuilder.build(data);\r\n                var material = this.materialBuilder.setCrossOrigin(this.crossOrigin).setResourcePath(resourcePath).build(data, geometry, onProgress, onError);\r\n                var mesh = new  THREE.SkinnedMesh(geometry, material);\r\n                var skeleton = new  THREE.Skeleton(initBones(mesh));\r\n                mesh.bind(skeleton);\r\n                return mesh;\r\n            }\r\n        };\r\n        function initBones(mesh) {\r\n            var geometry = mesh.geometry;\r\n            var bones = [], bone, gbone;\r\n            var i, il;\r\n            if (geometry && geometry.bones !== undefined) {\r\n                for (i = 0, il = geometry.bones.length; i < il; i++) {\r\n                    gbone = geometry.bones[i];\r\n                    bone = new  THREE.Bone();\r\n                    bones.push(bone);\r\n                    bone.name = gbone.name;\r\n                    bone.position.fromArray(gbone.pos);\r\n                    bone.quaternion.fromArray(gbone.rotq);\r\n                    if (gbone.scl !== undefined)\r\n                        bone.scale.fromArray(gbone.scl);\r\n                }\r\n                for (i = 0, il = geometry.bones.length; i < il; i++) {\r\n                    gbone = geometry.bones[i];\r\n                    if (gbone.parent !== -1 && gbone.parent !== null && bones[gbone.parent] !== undefined) {\r\n                        bones[gbone.parent].add(bones[i]);\r\n                    } else {\r\n                        mesh.add(bones[i]);\r\n                    }\r\n                }\r\n            }\r\n            mesh.updateMatrixWorld(true);\r\n            return bones;\r\n        }\r\n        function GeometryBuilder() {\r\n        }\r\n        GeometryBuilder.prototype = {\r\n            constructor: GeometryBuilder,\r\n            build: function (data) {\r\n                var positions = [];\r\n                var uvs = [];\r\n                var normals = [];\r\n                var indices = [];\r\n                var groups = [];\r\n                var bones = [];\r\n                var skinIndices = [];\r\n                var skinWeights = [];\r\n                var morphTargets = [];\r\n                var morphPositions = [];\r\n                var iks = [];\r\n                var grants = [];\r\n                var rigidBodies = [];\r\n                var constraints = [];\r\n                var offset = 0;\r\n                var boneTypeTable = {};\r\n                for (var i = 0; i < data.metadata.vertexCount; i++) {\r\n                    var v = data.vertices[i];\r\n                    for (var j = 0, jl = v.position.length; j < jl; j++) {\r\n                        positions.push(v.position[j]);\r\n                    }\r\n                    for (var j = 0, jl = v.normal.length; j < jl; j++) {\r\n                        normals.push(v.normal[j]);\r\n                    }\r\n                    for (var j = 0, jl = v.uv.length; j < jl; j++) {\r\n                        uvs.push(v.uv[j]);\r\n                    }\r\n                    for (var j = 0; j < 4; j++) {\r\n                        skinIndices.push(v.skinIndices.length - 1 >= j ? v.skinIndices[j] : 0);\r\n                    }\r\n                    for (var j = 0; j < 4; j++) {\r\n                        skinWeights.push(v.skinWeights.length - 1 >= j ? v.skinWeights[j] : 0);\r\n                    }\r\n                }\r\n                for (var i = 0; i < data.metadata.faceCount; i++) {\r\n                    var face = data.faces[i];\r\n                    for (var j = 0, jl = face.indices.length; j < jl; j++) {\r\n                        indices.push(face.indices[j]);\r\n                    }\r\n                }\r\n                for (var i = 0; i < data.metadata.materialCount; i++) {\r\n                    var material = data.materials[i];\r\n                    groups.push({\r\n                        offset: offset * 3,\r\n                        count: material.faceCount * 3\r\n                    });\r\n                    offset += material.faceCount;\r\n                }\r\n                for (var i = 0; i < data.metadata.rigidBodyCount; i++) {\r\n                    var body = data.rigidBodies[i];\r\n                    var value = boneTypeTable[body.boneIndex];\r\n                    value = value === undefined ? body.type : Math.max(body.type, value);\r\n                    boneTypeTable[body.boneIndex] = value;\r\n                }\r\n                for (var i = 0; i < data.metadata.boneCount; i++) {\r\n                    var boneData = data.bones[i];\r\n                    var bone = {\r\n                        parent: boneData.parentIndex,\r\n                        name: boneData.name,\r\n                        pos: boneData.position.slice(0, 3),\r\n                        rotq: [\r\n                            0,\r\n                            0,\r\n                            0,\r\n                            1\r\n                        ],\r\n                        scl: [\r\n                            1,\r\n                            1,\r\n                            1\r\n                        ],\r\n                        rigidBodyType: boneTypeTable[i] !== undefined ? boneTypeTable[i] : -1\r\n                    };\r\n                    if (bone.parent !== -1) {\r\n                        bone.pos[0] -= data.bones[bone.parent].position[0];\r\n                        bone.pos[1] -= data.bones[bone.parent].position[1];\r\n                        bone.pos[2] -= data.bones[bone.parent].position[2];\r\n                    }\r\n                    bones.push(bone);\r\n                }\r\n                if (data.metadata.format === 'pmd') {\r\n                    for (var i = 0; i < data.metadata.ikCount; i++) {\r\n                        var ik = data.iks[i];\r\n                        var param = {\r\n                            target: ik.target,\r\n                            effector: ik.effector,\r\n                            iteration: ik.iteration,\r\n                            maxAngle: ik.maxAngle * 4,\r\n                            links: []\r\n                        };\r\n                        for (var j = 0, jl = ik.links.length; j < jl; j++) {\r\n                            var link = {};\r\n                            link.index = ik.links[j].index;\r\n                            link.enabled = true;\r\n                            if (data.bones[link.index].name.indexOf('ひざ') >= 0) {\r\n                                link.limitation = new  THREE.Vector3(1, 0, 0);\r\n                            }\r\n                            param.links.push(link);\r\n                        }\r\n                        iks.push(param);\r\n                    }\r\n                } else {\r\n                    for (var i = 0; i < data.metadata.boneCount; i++) {\r\n                        var ik = data.bones[i].ik;\r\n                        if (ik === undefined)\r\n                            continue;\r\n                        var param = {\r\n                            target: i,\r\n                            effector: ik.effector,\r\n                            iteration: ik.iteration,\r\n                            maxAngle: ik.maxAngle,\r\n                            links: []\r\n                        };\r\n                        for (var j = 0, jl = ik.links.length; j < jl; j++) {\r\n                            var link = {};\r\n                            link.index = ik.links[j].index;\r\n                            link.enabled = true;\r\n                            if (ik.links[j].angleLimitation === 1) {\r\n                                var rotationMin = ik.links[j].lowerLimitationAngle;\r\n                                var rotationMax = ik.links[j].upperLimitationAngle;\r\n                                var tmp1 = -rotationMax[0];\r\n                                var tmp2 = -rotationMax[1];\r\n                                rotationMax[0] = -rotationMin[0];\r\n                                rotationMax[1] = -rotationMin[1];\r\n                                rotationMin[0] = tmp1;\r\n                                rotationMin[1] = tmp2;\r\n                                link.rotationMin = new  THREE.Vector3().fromArray(rotationMin);\r\n                                link.rotationMax = new  THREE.Vector3().fromArray(rotationMax);\r\n                            }\r\n                            param.links.push(link);\r\n                        }\r\n                        iks.push(param);\r\n                    }\r\n                }\r\n                if (data.metadata.format === 'pmx') {\r\n                    for (var i = 0; i < data.metadata.boneCount; i++) {\r\n                        var boneData = data.bones[i];\r\n                        var grant = boneData.grant;\r\n                        if (grant === undefined)\r\n                            continue;\r\n                        var param = {\r\n                            index: i,\r\n                            parentIndex: grant.parentIndex,\r\n                            ratio: grant.ratio,\r\n                            isLocal: grant.isLocal,\r\n                            affectRotation: grant.affectRotation,\r\n                            affectPosition: grant.affectPosition,\r\n                            transformationClass: boneData.transformationClass\r\n                        };\r\n                        grants.push(param);\r\n                    }\r\n                    grants.sort(function (a, b) {\r\n                        return a.transformationClass - b.transformationClass;\r\n                    });\r\n                }\r\n                function updateAttributes(attribute, morph, ratio) {\r\n                    for (var i = 0; i < morph.elementCount; i++) {\r\n                        var element = morph.elements[i];\r\n                        var index;\r\n                        if (data.metadata.format === 'pmd') {\r\n                            index = data.morphs[0].elements[element.index].index;\r\n                        } else {\r\n                            index = element.index;\r\n                        }\r\n                        attribute.array[index * 3 + 0] += element.position[0] * ratio;\r\n                        attribute.array[index * 3 + 1] += element.position[1] * ratio;\r\n                        attribute.array[index * 3 + 2] += element.position[2] * ratio;\r\n                    }\r\n                }\r\n                for (var i = 0; i < data.metadata.morphCount; i++) {\r\n                    var morph = data.morphs[i];\r\n                    var params = { name: morph.name };\r\n                    var attribute = new  THREE.Float32BufferAttribute(data.metadata.vertexCount * 3, 3);\r\n                    attribute.name = morph.name;\r\n                    for (var j = 0; j < data.metadata.vertexCount * 3; j++) {\r\n                        attribute.array[j] = positions[j];\r\n                    }\r\n                    if (data.metadata.format === 'pmd') {\r\n                        if (i !== 0) {\r\n                            updateAttributes(attribute, morph, 1);\r\n                        }\r\n                    } else {\r\n                        if (morph.type === 0) {\r\n                            for (var j = 0; j < morph.elementCount; j++) {\r\n                                var morph2 = data.morphs[morph.elements[j].index];\r\n                                var ratio = morph.elements[j].ratio;\r\n                                if (morph2.type === 1) {\r\n                                    updateAttributes(attribute, morph2, ratio);\r\n                                } else {\r\n                                }\r\n                            }\r\n                        } else if (morph.type === 1) {\r\n                            updateAttributes(attribute, morph, 1);\r\n                        } else if (morph.type === 2) {\r\n                        } else if (morph.type === 3) {\r\n                        } else if (morph.type === 4) {\r\n                        } else if (morph.type === 5) {\r\n                        } else if (morph.type === 6) {\r\n                        } else if (morph.type === 7) {\r\n                        } else if (morph.type === 8) {\r\n                        }\r\n                    }\r\n                    morphTargets.push(params);\r\n                    morphPositions.push(attribute);\r\n                }\r\n                for (var i = 0; i < data.metadata.rigidBodyCount; i++) {\r\n                    var rigidBody = data.rigidBodies[i];\r\n                    var params = {};\r\n                    for (var key in rigidBody) {\r\n                        params[key] = rigidBody[key];\r\n                    }\r\n                    if (data.metadata.format === 'pmx') {\r\n                        if (params.boneIndex !== -1) {\r\n                            var bone = data.bones[params.boneIndex];\r\n                            params.position[0] -= bone.position[0];\r\n                            params.position[1] -= bone.position[1];\r\n                            params.position[2] -= bone.position[2];\r\n                        }\r\n                    }\r\n                    rigidBodies.push(params);\r\n                }\r\n                for (var i = 0; i < data.metadata.constraintCount; i++) {\r\n                    var constraint = data.constraints[i];\r\n                    var params = {};\r\n                    for (var key in constraint) {\r\n                        params[key] = constraint[key];\r\n                    }\r\n                    var bodyA = rigidBodies[params.rigidBodyIndex1];\r\n                    var bodyB = rigidBodies[params.rigidBodyIndex2];\r\n                    if (bodyA.type !== 0 && bodyB.type === 2) {\r\n                        if (bodyA.boneIndex !== -1 && bodyB.boneIndex !== -1 && data.bones[bodyB.boneIndex].parentIndex === bodyA.boneIndex) {\r\n                            bodyB.type = 1;\r\n                        }\r\n                    }\r\n                    constraints.push(params);\r\n                }\r\n                var geometry = new  THREE.BufferGeometry();\r\n                geometry.setAttribute('position', new  THREE.Float32BufferAttribute(positions, 3));\r\n                geometry.setAttribute('normal', new  THREE.Float32BufferAttribute(normals, 3));\r\n                geometry.setAttribute('uv', new  THREE.Float32BufferAttribute(uvs, 2));\r\n                geometry.setAttribute('skinIndex', new  THREE.Uint16BufferAttribute(skinIndices, 4));\r\n                geometry.setAttribute('skinWeight', new  THREE.Float32BufferAttribute(skinWeights, 4));\r\n                geometry.setIndex(indices);\r\n                for (var i = 0, il = groups.length; i < il; i++) {\r\n                    geometry.addGroup(groups[i].offset, groups[i].count, i);\r\n                }\r\n                geometry.bones = bones;\r\n                geometry.morphTargets = morphTargets;\r\n                geometry.morphAttributes.position = morphPositions;\r\n                geometry.morphTargetsRelative = false;\r\n                geometry.userData.MMD = {\r\n                    bones: bones,\r\n                    iks: iks,\r\n                    grants: grants,\r\n                    rigidBodies: rigidBodies,\r\n                    constraints: constraints,\r\n                    format: data.metadata.format\r\n                };\r\n                geometry.computeBoundingSphere();\r\n                return geometry;\r\n            }\r\n        };\r\n        function MaterialBuilder(manager) {\r\n            this.manager = manager;\r\n            this.textureLoader = new  THREE.TextureLoader(this.manager);\r\n            this.tgaLoader = null;\r\n        }\r\n        MaterialBuilder.prototype = {\r\n            constructor: MaterialBuilder,\r\n            crossOrigin: 'anonymous',\r\n            resourcePath: undefined,\r\n            setCrossOrigin: function (crossOrigin) {\r\n                this.crossOrigin = crossOrigin;\r\n                return this;\r\n            },\r\n            setResourcePath: function (resourcePath) {\r\n                this.resourcePath = resourcePath;\r\n                return this;\r\n            },\r\n            build: function (data, geometry) {\r\n                var materials = [];\r\n                var textures = {};\r\n                this.textureLoader.setCrossOrigin(this.crossOrigin);\r\n                for (var i = 0; i < data.metadata.materialCount; i++) {\r\n                    var material = data.materials[i];\r\n                    var params = { userData: {} };\r\n                    if (material.name !== undefined)\r\n                        params.name = material.name;\r\n                    params.color = new  THREE.Color().fromArray(material.diffuse);\r\n                    params.opacity = material.diffuse[3];\r\n                    params.specular = new  THREE.Color().fromArray(material.specular);\r\n                    params.emissive = new  THREE.Color().fromArray(material.ambient);\r\n                    params.shininess = Math.max(material.shininess, 0.0001);\r\n                    params.transparent = params.opacity !== 1;\r\n                    params.skinning = geometry.bones.length > 0 ? true : false;\r\n                    params.morphTargets = geometry.morphTargets.length > 0 ? true : false;\r\n                    params.fog = true;\r\n                    params.blending =  THREE.CustomBlending;\r\n                    params.blendSrc =  THREE.SrcAlphaFactor;\r\n                    params.blendDst =  THREE.OneMinusSrcAlphaFactor;\r\n                    params.blendSrcAlpha =  THREE.SrcAlphaFactor;\r\n                    params.blendDstAlpha =  THREE.DstAlphaFactor;\r\n                    if (data.metadata.format === 'pmx' && (material.flag & 1) === 1) {\r\n                        params.side =  THREE.DoubleSide;\r\n                    } else {\r\n                        params.side = params.opacity === 1 ?  THREE.FrontSide :  THREE.DoubleSide;\r\n                    }\r\n                    if (data.metadata.format === 'pmd') {\r\n                        if (material.fileName) {\r\n                            var fileName = material.fileName;\r\n                            var fileNames = fileName.split('*');\r\n                            params.map = this._loadTexture(fileNames[0], textures);\r\n                            if (fileNames.length > 1) {\r\n                                var extension = fileNames[1].slice(-4).toLowerCase();\r\n                                params.envMap = this._loadTexture(fileNames[1], textures, { sphericalReflectionMapping: true });\r\n                                params.combine = extension === '.sph' ?  THREE.MultiplyOperation :  THREE.AddOperation;\r\n                            }\r\n                        }\r\n                        var toonFileName = material.toonIndex === -1 ? 'toon00.bmp' : data.toonTextures[material.toonIndex].fileName;\r\n                        params.gradientMap = this._loadTexture(toonFileName, textures, {\r\n                            isToonTexture: true,\r\n                            isDefaultToonTexture: this._isDefaultToonTexture(toonFileName)\r\n                        });\r\n                        params.userData.outlineParameters = {\r\n                            thickness: material.edgeFlag === 1 ? 0.003 : 0,\r\n                            color: [\r\n                                0,\r\n                                0,\r\n                                0\r\n                            ],\r\n                            alpha: 1,\r\n                            visible: material.edgeFlag === 1\r\n                        };\r\n                    } else {\r\n                        if (material.textureIndex !== -1) {\r\n                            params.map = this._loadTexture(data.textures[material.textureIndex], textures);\r\n                        }\r\n                        if (material.envTextureIndex !== -1 && (material.envFlag === 1 || material.envFlag == 2)) {\r\n                            params.envMap = this._loadTexture(data.textures[material.envTextureIndex], textures, { sphericalReflectionMapping: true });\r\n                            params.combine = material.envFlag === 1 ?  THREE.MultiplyOperation :  THREE.AddOperation;\r\n                        }\r\n                        var toonFileName, isDefaultToon;\r\n                        if (material.toonIndex === -1 || material.toonFlag !== 0) {\r\n                            toonFileName = 'toon' + ('0' + (material.toonIndex + 1)).slice(-2) + '.bmp';\r\n                            isDefaultToon = true;\r\n                        } else {\r\n                            toonFileName = data.textures[material.toonIndex];\r\n                            isDefaultToon = false;\r\n                        }\r\n                        params.gradientMap = this._loadTexture(toonFileName, textures, {\r\n                            isToonTexture: true,\r\n                            isDefaultToonTexture: isDefaultToon\r\n                        });\r\n                        params.userData.outlineParameters = {\r\n                            thickness: material.edgeSize / 300,\r\n                            color: material.edgeColor.slice(0, 3),\r\n                            alpha: material.edgeColor[3],\r\n                            visible: (material.flag & 16) !== 0 && material.edgeSize > 0\r\n                        };\r\n                    }\r\n                    if (params.map !== undefined) {\r\n                        if (!params.transparent) {\r\n                            this._checkImageTransparency(params.map, geometry, i);\r\n                        }\r\n                        params.emissive.multiplyScalar(0.2);\r\n                    }\r\n                    materials.push(new  THREE.MeshToonMaterial(params));\r\n                }\r\n                if (data.metadata.format === 'pmx') {\r\n                    function checkAlphaMorph(elements, materials) {\r\n                        for (var i = 0, il = elements.length; i < il; i++) {\r\n                            var element = elements[i];\r\n                            if (element.index === -1)\r\n                                continue;\r\n                            var material = materials[element.index];\r\n                            if (material.opacity !== element.diffuse[3]) {\r\n                                material.transparent = true;\r\n                            }\r\n                        }\r\n                    }\r\n                    for (var i = 0, il = data.morphs.length; i < il; i++) {\r\n                        var morph = data.morphs[i];\r\n                        var elements = morph.elements;\r\n                        if (morph.type === 0) {\r\n                            for (var j = 0, jl = elements.length; j < jl; j++) {\r\n                                var morph2 = data.morphs[elements[j].index];\r\n                                if (morph2.type !== 8)\r\n                                    continue;\r\n                                checkAlphaMorph(morph2.elements, materials);\r\n                            }\r\n                        } else if (morph.type === 8) {\r\n                            checkAlphaMorph(elements, materials);\r\n                        }\r\n                    }\r\n                }\r\n                return materials;\r\n            },\r\n            _getTGALoader: function () {\r\n                if (this.tgaLoader === null) {\r\n                    if (b.TGALoader === undefined) {\r\n                        throw new Error('THREE.MMDLoader: Import TGALoader');\r\n                    }\r\n                    this.tgaLoader = new TGALoader(this.manager);\r\n                }\r\n                return this.tgaLoader;\r\n            },\r\n            _isDefaultToonTexture: function (name) {\r\n                if (name.length !== 10)\r\n                    return false;\r\n                return /toon(10|0[0-9])\\.bmp/.test(name);\r\n            },\r\n            _loadTexture: function (filePath, textures, params, onProgress, onError) {\r\n                params = params || {};\r\n                var scope = this;\r\n                var fullPath;\r\n                if (params.isDefaultToonTexture === true) {\r\n                    var index;\r\n                    try {\r\n                        index = parseInt(filePath.match(/toon([0-9]{2})\\.bmp$/)[1]);\r\n                    } catch (e) {\r\n                        console.warn('THREE.MMDLoader: ' + filePath + ' seems like a ' + 'not right default texture path. Using toon00.bmp instead.');\r\n                        index = 0;\r\n                    }\r\n                    fullPath = DEFAULT_TOON_TEXTURES[index];\r\n                } else {\r\n                    fullPath = this.resourcePath + filePath;\r\n                }\r\n                if (textures[fullPath] !== undefined)\r\n                    return textures[fullPath];\r\n                var loader = this.manager.getHandler(fullPath);\r\n                if (loader === null) {\r\n                    loader = filePath.slice(-4).toLowerCase() === '.tga' ? this._getTGALoader() : this.textureLoader;\r\n                }\r\n                var texture = loader.load(fullPath, function (t) {\r\n                    if (params.isToonTexture === true) {\r\n                        t.image = scope._getRotatedImage(t.image);\r\n                        t.magFilter =  THREE.NearestFilter;\r\n                        t.minFilter =  THREE.NearestFilter;\r\n                    }\r\n                    t.flipY = false;\r\n                    t.wrapS =  THREE.RepeatWrapping;\r\n                    t.wrapT =  THREE.RepeatWrapping;\r\n                    for (var i = 0; i < texture.readyCallbacks.length; i++) {\r\n                        texture.readyCallbacks[i](texture);\r\n                    }\r\n                    delete texture.readyCallbacks;\r\n                }, onProgress, onError);\r\n                if (params.sphericalReflectionMapping === true) {\r\n                    texture.mapping =  THREE.SphericalReflectionMapping;\r\n                }\r\n                texture.readyCallbacks = [];\r\n                textures[fullPath] = texture;\r\n                return texture;\r\n            },\r\n            _getRotatedImage: function (image) {\r\n                var canvas = document.createElement('canvas');\r\n                var context = canvas.getContext('2d');\r\n                var width = image.width;\r\n                var height = image.height;\r\n                canvas.width = width;\r\n                canvas.height = height;\r\n                context.clearRect(0, 0, width, height);\r\n                context.translate(width / 2, height / 2);\r\n                context.rotate(0.5 * Math.PI);\r\n                context.translate(-width / 2, -height / 2);\r\n                context.drawImage(image, 0, 0);\r\n                return context.getImageData(0, 0, width, height);\r\n            },\r\n            _checkImageTransparency: function (map, geometry, groupIndex) {\r\n                map.readyCallbacks.push(function (texture) {\r\n                    function createImageData(image) {\r\n                        var canvas = document.createElement('canvas');\r\n                        canvas.width = image.width;\r\n                        canvas.height = image.height;\r\n                        var context = canvas.getContext('2d');\r\n                        context.drawImage(image, 0, 0);\r\n                        return context.getImageData(0, 0, canvas.width, canvas.height);\r\n                    }\r\n                    function detectImageTransparency(image, uvs, indices) {\r\n                        var width = image.width;\r\n                        var height = image.height;\r\n                        var data = image.data;\r\n                        var threshold = 253;\r\n                        if (data.length / (width * height) !== 4)\r\n                            return false;\r\n                        for (var i = 0; i < indices.length; i += 3) {\r\n                            var centerUV = {\r\n                                x: 0,\r\n                                y: 0\r\n                            };\r\n                            for (var j = 0; j < 3; j++) {\r\n                                var index = indices[i * 3 + j];\r\n                                var uv = {\r\n                                    x: uvs[index * 2 + 0],\r\n                                    y: uvs[index * 2 + 1]\r\n                                };\r\n                                if (getAlphaByUv(image, uv) < threshold)\r\n                                    return true;\r\n                                centerUV.x += uv.x;\r\n                                centerUV.y += uv.y;\r\n                            }\r\n                            centerUV.x /= 3;\r\n                            centerUV.y /= 3;\r\n                            if (getAlphaByUv(image, centerUV) < threshold)\r\n                                return true;\r\n                        }\r\n                        return false;\r\n                    }\r\n                    function getAlphaByUv(image, uv) {\r\n                        var width = image.width;\r\n                        var height = image.height;\r\n                        var x = Math.round(uv.x * width) % width;\r\n                        var y = Math.round(uv.y * height) % height;\r\n                        if (x < 0)\r\n                            x += width;\r\n                        if (y < 0)\r\n                            y += height;\r\n                        var index = y * width + x;\r\n                        return image.data[index * 4 + 3];\r\n                    }\r\n                    var imageData = texture.image.data !== undefined ? texture.image : createImageData(texture.image);\r\n                    var group = geometry.groups[groupIndex];\r\n                    if (detectImageTransparency(imageData, geometry.attributes.uv.array, geometry.index.array.slice(group.start, group.start + group.count))) {\r\n                        map.transparent = true;\r\n                    }\r\n                });\r\n            }\r\n        };\r\n        function AnimationBuilder() {\r\n        }\r\n        AnimationBuilder.prototype = {\r\n            constructor: AnimationBuilder,\r\n            build: function (vmd, mesh) {\r\n                var tracks = this.buildSkeletalAnimation(vmd, mesh).tracks;\r\n                var tracks2 = this.buildMorphAnimation(vmd, mesh).tracks;\r\n                for (var i = 0, il = tracks2.length; i < il; i++) {\r\n                    tracks.push(tracks2[i]);\r\n                }\r\n                return new  THREE.AnimationClip('', -1, tracks);\r\n            },\r\n            buildSkeletalAnimation: function (vmd, mesh) {\r\n                function pushInterpolation(array, interpolation, index) {\r\n                    array.push(interpolation[index + 0] / 127);\r\n                    array.push(interpolation[index + 8] / 127);\r\n                    array.push(interpolation[index + 4] / 127);\r\n                    array.push(interpolation[index + 12] / 127);\r\n                }\r\n                var tracks = [];\r\n                var motions = {};\r\n                var bones = mesh.skeleton.bones;\r\n                var boneNameDictionary = {};\r\n                for (var i = 0, il = bones.length; i < il; i++) {\r\n                    boneNameDictionary[bones[i].name] = true;\r\n                }\r\n                for (var i = 0; i < vmd.metadata.motionCount; i++) {\r\n                    var motion = vmd.motions[i];\r\n                    var boneName = motion.boneName;\r\n                    if (boneNameDictionary[boneName] === undefined)\r\n                        continue;\r\n                    motions[boneName] = motions[boneName] || [];\r\n                    motions[boneName].push(motion);\r\n                }\r\n                for (var key in motions) {\r\n                    var array = motions[key];\r\n                    array.sort(function (a, b) {\r\n                        return a.frameNum - b.frameNum;\r\n                    });\r\n                    var times = [];\r\n                    var positions = [];\r\n                    var rotations = [];\r\n                    var pInterpolations = [];\r\n                    var rInterpolations = [];\r\n                    var basePosition = mesh.skeleton.getBoneByName(key).position.toArray();\r\n                    for (var i = 0, il = array.length; i < il; i++) {\r\n                        var time = array[i].frameNum / 30;\r\n                        var position = array[i].position;\r\n                        var rotation = array[i].rotation;\r\n                        var interpolation = array[i].interpolation;\r\n                        times.push(time);\r\n                        for (var j = 0; j < 3; j++)\r\n                            positions.push(basePosition[j] + position[j]);\r\n                        for (var j = 0; j < 4; j++)\r\n                            rotations.push(rotation[j]);\r\n                        for (var j = 0; j < 3; j++)\r\n                            pushInterpolation(pInterpolations, interpolation, j);\r\n                        pushInterpolation(rInterpolations, interpolation, 3);\r\n                    }\r\n                    var targetName = '.bones[' + key + ']';\r\n                    tracks.push(this._createTrack(targetName + '.position',  THREE.VectorKeyframeTrack, times, positions, pInterpolations));\r\n                    tracks.push(this._createTrack(targetName + '.quaternion',  THREE.QuaternionKeyframeTrack, times, rotations, rInterpolations));\r\n                }\r\n                return new  THREE.AnimationClip('', -1, tracks);\r\n            },\r\n            buildMorphAnimation: function (vmd, mesh) {\r\n                var tracks = [];\r\n                var morphs = {};\r\n                var morphTargetDictionary = mesh.morphTargetDictionary;\r\n                for (var i = 0; i < vmd.metadata.morphCount; i++) {\r\n                    var morph = vmd.morphs[i];\r\n                    var morphName = morph.morphName;\r\n                    if (morphTargetDictionary[morphName] === undefined)\r\n                        continue;\r\n                    morphs[morphName] = morphs[morphName] || [];\r\n                    morphs[morphName].push(morph);\r\n                }\r\n                for (var key in morphs) {\r\n                    var array = morphs[key];\r\n                    array.sort(function (a, b) {\r\n                        return a.frameNum - b.frameNum;\r\n                    });\r\n                    var times = [];\r\n                    var values = [];\r\n                    for (var i = 0, il = array.length; i < il; i++) {\r\n                        times.push(array[i].frameNum / 30);\r\n                        values.push(array[i].weight);\r\n                    }\r\n                    tracks.push(new  THREE.NumberKeyframeTrack('.morphTargetInfluences[' + morphTargetDictionary[key] + ']', times, values));\r\n                }\r\n                return new  THREE.AnimationClip('', -1, tracks);\r\n            },\r\n            buildCameraAnimation: function (vmd) {\r\n                function pushVector3(array, vec) {\r\n                    array.push(vec.x);\r\n                    array.push(vec.y);\r\n                    array.push(vec.z);\r\n                }\r\n                function pushQuaternion(array, q) {\r\n                    array.push(q.x);\r\n                    array.push(q.y);\r\n                    array.push(q.z);\r\n                    array.push(q.w);\r\n                }\r\n                function pushInterpolation(array, interpolation, index) {\r\n                    array.push(interpolation[index * 4 + 0] / 127);\r\n                    array.push(interpolation[index * 4 + 1] / 127);\r\n                    array.push(interpolation[index * 4 + 2] / 127);\r\n                    array.push(interpolation[index * 4 + 3] / 127);\r\n                }\r\n                var tracks = [];\r\n                var cameras = vmd.cameras === undefined ? [] : vmd.cameras.slice();\r\n                cameras.sort(function (a, b) {\r\n                    return a.frameNum - b.frameNum;\r\n                });\r\n                var times = [];\r\n                var centers = [];\r\n                var quaternions = [];\r\n                var positions = [];\r\n                var fovs = [];\r\n                var cInterpolations = [];\r\n                var qInterpolations = [];\r\n                var pInterpolations = [];\r\n                var fInterpolations = [];\r\n                var quaternion = new  THREE.Quaternion();\r\n                var euler = new  THREE.Euler();\r\n                var position = new  THREE.Vector3();\r\n                var center = new  THREE.Vector3();\r\n                for (var i = 0, il = cameras.length; i < il; i++) {\r\n                    var motion = cameras[i];\r\n                    var time = motion.frameNum / 30;\r\n                    var pos = motion.position;\r\n                    var rot = motion.rotation;\r\n                    var distance = motion.distance;\r\n                    var fov = motion.fov;\r\n                    var interpolation = motion.interpolation;\r\n                    times.push(time);\r\n                    position.set(0, 0, -distance);\r\n                    center.set(pos[0], pos[1], pos[2]);\r\n                    euler.set(-rot[0], -rot[1], -rot[2]);\r\n                    quaternion.setFromEuler(euler);\r\n                    position.add(center);\r\n                    position.applyQuaternion(quaternion);\r\n                    pushVector3(centers, center);\r\n                    pushQuaternion(quaternions, quaternion);\r\n                    pushVector3(positions, position);\r\n                    fovs.push(fov);\r\n                    for (var j = 0; j < 3; j++) {\r\n                        pushInterpolation(cInterpolations, interpolation, j);\r\n                    }\r\n                    pushInterpolation(qInterpolations, interpolation, 3);\r\n                    for (var j = 0; j < 3; j++) {\r\n                        pushInterpolation(pInterpolations, interpolation, 4);\r\n                    }\r\n                    pushInterpolation(fInterpolations, interpolation, 5);\r\n                }\r\n                var tracks = [];\r\n                tracks.push(this._createTrack('target.position',  THREE.VectorKeyframeTrack, times, centers, cInterpolations));\r\n                tracks.push(this._createTrack('.quaternion',  THREE.QuaternionKeyframeTrack, times, quaternions, qInterpolations));\r\n                tracks.push(this._createTrack('.position',  THREE.VectorKeyframeTrack, times, positions, pInterpolations));\r\n                tracks.push(this._createTrack('.fov',  THREE.NumberKeyframeTrack, times, fovs, fInterpolations));\r\n                return new  THREE.AnimationClip('', -1, tracks);\r\n            },\r\n            _createTrack: function (node, typedKeyframeTrack, times, values, interpolations) {\r\n                if (times.length > 2) {\r\n                    times = times.slice();\r\n                    values = values.slice();\r\n                    interpolations = interpolations.slice();\r\n                    var stride = values.length / times.length;\r\n                    var interpolateStride = interpolations.length / times.length;\r\n                    var index = 1;\r\n                    for (var aheadIndex = 2, endIndex = times.length; aheadIndex < endIndex; aheadIndex++) {\r\n                        for (var i = 0; i < stride; i++) {\r\n                            if (values[index * stride + i] !== values[(index - 1) * stride + i] || values[index * stride + i] !== values[aheadIndex * stride + i]) {\r\n                                index++;\r\n                                break;\r\n                            }\r\n                        }\r\n                        if (aheadIndex > index) {\r\n                            times[index] = times[aheadIndex];\r\n                            for (var i = 0; i < stride; i++) {\r\n                                values[index * stride + i] = values[aheadIndex * stride + i];\r\n                            }\r\n                            for (var i = 0; i < interpolateStride; i++) {\r\n                                interpolations[index * interpolateStride + i] = interpolations[aheadIndex * interpolateStride + i];\r\n                            }\r\n                        }\r\n                    }\r\n                    times.length = index + 1;\r\n                    values.length = (index + 1) * stride;\r\n                    interpolations.length = (index + 1) * interpolateStride;\r\n                }\r\n                var track = new typedKeyframeTrack(node, times, values);\r\n                track.createInterpolant = function InterpolantFactoryMethodCubicBezier(result) {\r\n                    return new CubicBezierInterpolation(this.times, this.values, this.getValueSize(), result, new Float32Array(interpolations));\r\n                };\r\n                return track;\r\n            }\r\n        };\r\n        function CubicBezierInterpolation(parameterPositions, sampleValues, sampleSize, resultBuffer, params) {\r\n             THREE.Interpolant.call(this, parameterPositions, sampleValues, sampleSize, resultBuffer);\r\n            this.interpolationParams = params;\r\n        }\r\n        CubicBezierInterpolation.prototype = Object.assign(Object.create( THREE.Interpolant.prototype), {\r\n            constructor: CubicBezierInterpolation,\r\n            interpolate_: function (i1, t0, t, t1) {\r\n                var result = this.resultBuffer;\r\n                var values = this.sampleValues;\r\n                var stride = this.valueSize;\r\n                var params = this.interpolationParams;\r\n                var offset1 = i1 * stride;\r\n                var offset0 = offset1 - stride;\r\n                var weight1 = t1 - t0 < 1 / 30 * 1.5 ? 0 : (t - t0) / (t1 - t0);\r\n                if (stride === 4) {\r\n                    var x1 = params[i1 * 4 + 0];\r\n                    var x2 = params[i1 * 4 + 1];\r\n                    var y1 = params[i1 * 4 + 2];\r\n                    var y2 = params[i1 * 4 + 3];\r\n                    var ratio = this._calculate(x1, x2, y1, y2, weight1);\r\n                     THREE.Quaternion.slerpFlat(result, 0, values, offset0, values, offset1, ratio);\r\n                } else if (stride === 3) {\r\n                    for (var i = 0; i !== stride; ++i) {\r\n                        var x1 = params[i1 * 12 + i * 4 + 0];\r\n                        var x2 = params[i1 * 12 + i * 4 + 1];\r\n                        var y1 = params[i1 * 12 + i * 4 + 2];\r\n                        var y2 = params[i1 * 12 + i * 4 + 3];\r\n                        var ratio = this._calculate(x1, x2, y1, y2, weight1);\r\n                        result[i] = values[offset0 + i] * (1 - ratio) + values[offset1 + i] * ratio;\r\n                    }\r\n                } else {\r\n                    var x1 = params[i1 * 4 + 0];\r\n                    var x2 = params[i1 * 4 + 1];\r\n                    var y1 = params[i1 * 4 + 2];\r\n                    var y2 = params[i1 * 4 + 3];\r\n                    var ratio = this._calculate(x1, x2, y1, y2, weight1);\r\n                    result[0] = values[offset0] * (1 - ratio) + values[offset1] * ratio;\r\n                }\r\n                return result;\r\n            },\r\n            _calculate: function (x1, x2, y1, y2, x) {\r\n                var c = 0.5;\r\n                var t = c;\r\n                var s = 1 - t;\r\n                var loop = 15;\r\n                var eps = 0.00001;\r\n                var math = Math;\r\n                var sst3, stt3, ttt;\r\n                for (var i = 0; i < loop; i++) {\r\n                    sst3 = 3 * s * s * t;\r\n                    stt3 = 3 * s * t * t;\r\n                    ttt = t * t * t;\r\n                    var ft = sst3 * x1 + stt3 * x2 + ttt - x;\r\n                    if (math.abs(ft) < eps)\r\n                        break;\r\n                    c /= 2;\r\n                    t += ft < 0 ? c : -c;\r\n                    s = 1 - t;\r\n                }\r\n                return sst3 * y1 + stt3 * y2 + ttt;\r\n            }\r\n        });\r\n        return MMDLoader;\r\n    }();\r\n\r\n    return threex.loaders.MMDLoader = MMDLoader;\r\n});"]}