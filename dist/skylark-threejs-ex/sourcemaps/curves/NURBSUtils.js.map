{"version":3,"sources":["curves/NURBSUtils.js"],"names":["define","THREE","findSpan","p","u","U","n","length","low","high","mid","Math","floor","calcBasisFunctions","span","N","left","right","j","saved","r","rv","lv","temp","calcBSplinePoint","P","this","C","Vector4","point","Nj","wNj","w","x","y","z","calcBasisFunctionDerivatives","zeroArr","i","ders","slice","ndu","s1","s2","a","k","d","rk","pk","j2","calcBSplineDerivatives","nd","du","CK","nders","Pw","clone","multiplyScalar","add","calcKoverI","nom","denom","calcRationalCurveDerivatives","Pders","Aders","wders","Vector3","v","sub","divideScalar","calcNURBSDerivatives","calcSurfacePoint","q","V","target","uspan","vspan","Nu","Nv","l","Sw","set"],"mappings":"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","file":"../../curves/NURBSUtils.js","sourcesContent":["define([\n    \"skylark-threejs\"\n], function (THREE) {\n    'use strict';\n    var NURBSUtils = {\n        findSpan: function (p, u, U) {\n            var n = U.length - p - 1;\n            if (u >= U[n]) {\n                return n - 1;\n            }\n            if (u <= U[p]) {\n                return p;\n            }\n            var low = p;\n            var high = n;\n            var mid = Math.floor((low + high) / 2);\n            while (u < U[mid] || u >= U[mid + 1]) {\n                if (u < U[mid]) {\n                    high = mid;\n                } else {\n                    low = mid;\n                }\n                mid = Math.floor((low + high) / 2);\n            }\n            return mid;\n        },\n        calcBasisFunctions: function (span, u, p, U) {\n            var N = [];\n            var left = [];\n            var right = [];\n            N[0] = 1;\n            for (var j = 1; j <= p; ++j) {\n                left[j] = u - U[span + 1 - j];\n                right[j] = U[span + j] - u;\n                var saved = 0;\n                for (var r = 0; r < j; ++r) {\n                    var rv = right[r + 1];\n                    var lv = left[j - r];\n                    var temp = N[r] / (rv + lv);\n                    N[r] = saved + rv * temp;\n                    saved = lv * temp;\n                }\n                N[j] = saved;\n            }\n            return N;\n        },\n        calcBSplinePoint: function (p, U, P, u) {\n            var span = this.findSpan(p, u, U);\n            var N = this.calcBasisFunctions(span, u, p, U);\n            var C = new THREE.Vector4(0, 0, 0, 0);\n            for (var j = 0; j <= p; ++j) {\n                var point = P[span - p + j];\n                var Nj = N[j];\n                var wNj = point.w * Nj;\n                C.x += point.x * wNj;\n                C.y += point.y * wNj;\n                C.z += point.z * wNj;\n                C.w += point.w * Nj;\n            }\n            return C;\n        },\n        calcBasisFunctionDerivatives: function (span, u, p, n, U) {\n            var zeroArr = [];\n            for (var i = 0; i <= p; ++i)\n                zeroArr[i] = 0;\n            var ders = [];\n            for (var i = 0; i <= n; ++i)\n                ders[i] = zeroArr.slice(0);\n            var ndu = [];\n            for (var i = 0; i <= p; ++i)\n                ndu[i] = zeroArr.slice(0);\n            ndu[0][0] = 1;\n            var left = zeroArr.slice(0);\n            var right = zeroArr.slice(0);\n            for (var j = 1; j <= p; ++j) {\n                left[j] = u - U[span + 1 - j];\n                right[j] = U[span + j] - u;\n                var saved = 0;\n                for (var r = 0; r < j; ++r) {\n                    var rv = right[r + 1];\n                    var lv = left[j - r];\n                    ndu[j][r] = rv + lv;\n                    var temp = ndu[r][j - 1] / ndu[j][r];\n                    ndu[r][j] = saved + rv * temp;\n                    saved = lv * temp;\n                }\n                ndu[j][j] = saved;\n            }\n            for (var j = 0; j <= p; ++j) {\n                ders[0][j] = ndu[j][p];\n            }\n            for (var r = 0; r <= p; ++r) {\n                var s1 = 0;\n                var s2 = 1;\n                var a = [];\n                for (var i = 0; i <= p; ++i) {\n                    a[i] = zeroArr.slice(0);\n                }\n                a[0][0] = 1;\n                for (var k = 1; k <= n; ++k) {\n                    var d = 0;\n                    var rk = r - k;\n                    var pk = p - k;\n                    if (r >= k) {\n                        a[s2][0] = a[s1][0] / ndu[pk + 1][rk];\n                        d = a[s2][0] * ndu[rk][pk];\n                    }\n                    var j1 = rk >= -1 ? 1 : -rk;\n                    var j2 = r - 1 <= pk ? k - 1 : p - r;\n                    for (var j = j1; j <= j2; ++j) {\n                        a[s2][j] = (a[s1][j] - a[s1][j - 1]) / ndu[pk + 1][rk + j];\n                        d += a[s2][j] * ndu[rk + j][pk];\n                    }\n                    if (r <= pk) {\n                        a[s2][k] = -a[s1][k - 1] / ndu[pk + 1][r];\n                        d += a[s2][k] * ndu[r][pk];\n                    }\n                    ders[k][r] = d;\n                    var j = s1;\n                    s1 = s2;\n                    s2 = j;\n                }\n            }\n            var r = p;\n            for (var k = 1; k <= n; ++k) {\n                for (var j = 0; j <= p; ++j) {\n                    ders[k][j] *= r;\n                }\n                r *= p - k;\n            }\n            return ders;\n        },\n        calcBSplineDerivatives: function (p, U, P, u, nd) {\n            var du = nd < p ? nd : p;\n            var CK = [];\n            var span = this.findSpan(p, u, U);\n            var nders = this.calcBasisFunctionDerivatives(span, u, p, du, U);\n            var Pw = [];\n            for (var i = 0; i < P.length; ++i) {\n                var point = P[i].clone();\n                var w = point.w;\n                point.x *= w;\n                point.y *= w;\n                point.z *= w;\n                Pw[i] = point;\n            }\n            for (var k = 0; k <= du; ++k) {\n                var point = Pw[span - p].clone().multiplyScalar(nders[k][0]);\n                for (var j = 1; j <= p; ++j) {\n                    point.add(Pw[span - p + j].clone().multiplyScalar(nders[k][j]));\n                }\n                CK[k] = point;\n            }\n            for (var k = du + 1; k <= nd + 1; ++k) {\n                CK[k] = new THREE.Vector4(0, 0, 0);\n            }\n            return CK;\n        },\n        calcKoverI: function (k, i) {\n            var nom = 1;\n            for (var j = 2; j <= k; ++j) {\n                nom *= j;\n            }\n            var denom = 1;\n            for (var j = 2; j <= i; ++j) {\n                denom *= j;\n            }\n            for (var j = 2; j <= k - i; ++j) {\n                denom *= j;\n            }\n            return nom / denom;\n        },\n        calcRationalCurveDerivatives: function (Pders) {\n            var nd = Pders.length;\n            var Aders = [];\n            var wders = [];\n            for (var i = 0; i < nd; ++i) {\n                var point = Pders[i];\n                Aders[i] = new THREE.Vector3(point.x, point.y, point.z);\n                wders[i] = point.w;\n            }\n            var CK = [];\n            for (var k = 0; k < nd; ++k) {\n                var v = Aders[k].clone();\n                for (var i = 1; i <= k; ++i) {\n                    v.sub(CK[k - i].clone().multiplyScalar(this.calcKoverI(k, i) * wders[i]));\n                }\n                CK[k] = v.divideScalar(wders[0]);\n            }\n            return CK;\n        },\n        calcNURBSDerivatives: function (p, U, P, u, nd) {\n            var Pders = this.calcBSplineDerivatives(p, U, P, u, nd);\n            return this.calcRationalCurveDerivatives(Pders);\n        },\n        calcSurfacePoint: function (p, q, U, V, P, u, v, target) {\n            var uspan = this.findSpan(p, u, U);\n            var vspan = this.findSpan(q, v, V);\n            var Nu = this.calcBasisFunctions(uspan, u, p, U);\n            var Nv = this.calcBasisFunctions(vspan, v, q, V);\n            var temp = [];\n            for (var l = 0; l <= q; ++l) {\n                temp[l] = new THREE.Vector4(0, 0, 0, 0);\n                for (var k = 0; k <= p; ++k) {\n                    var point = P[uspan - p + k][vspan - q + l].clone();\n                    var w = point.w;\n                    point.x *= w;\n                    point.y *= w;\n                    point.z *= w;\n                    temp[l].add(point.multiplyScalar(Nu[k]));\n                }\n            }\n            var Sw = new THREE.Vector4(0, 0, 0, 0);\n            for (var l = 0; l <= q; ++l) {\n                Sw.add(temp[l].multiplyScalar(Nv[l]));\n            }\n            Sw.divideScalar(Sw.w);\n            target.set(Sw.x, Sw.y, Sw.z);\n        }\n    };\n    \n    return NURBSUtils;\n});"]}