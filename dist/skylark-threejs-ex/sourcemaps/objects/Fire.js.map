{"version":3,"sources":["objects/Fire.js"],"names":["define","THREE","threex","Fire","geometry","options","Mesh","call","this","type","clock","Clock","textureWidth","textureHeight","oneOverWidth","oneOverHeight","debug","undefined","color1","Color","color2","color3","colorBias","diffuse","viscosity","expansion","swirl","burnRate","drag","airSpeed","windVector","Vector2","speed","massConservation","size","sourceData","Uint8Array","clearSources","y","x","stride","sourceMaterial","uniforms","value","internalSource","needsUpdate","addSource","u","v","radius","density","windX","windY","startX","Math","max","floor","startY","endX","min","endY","diffX","diffY","wind","setSourceMap","texture","parameters","minFilter","NearestFilter","magFilter","depthBuffer","stencilBuffer","field0","WebGLRenderTarget","background","field1","fieldProj","MathUtils","isPowerOfTwo","generateMipmaps","fieldScene","Scene","orthoCamera","OrthographicCamera","position","z","fieldGeometry","PlaneBufferGeometry","DataTexture","RGBAFormat","shader","SourceShader","ShaderMaterial","vertexShader","fragmentShader","transparent","sourceMesh","add","DiffuseShader","diffuseMaterial","diffuseMesh","DriftShader","driftMaterial","driftMesh","ProjectionShader1","projMaterial1","projMesh1","ProjectionShader2","projMaterial2","projMesh2","ProjectionShader3","projMaterial3","projMesh3","DebugShader","ColorShader","material","configShaders","dt","exp","clearDiffuse","swapTextures","swap","saveRenderState","renderer","savedRenderTarget","getRenderTarget","savedXrEnabled","xr","enabled","savedShadowAutoUpdate","shadowMap","autoUpdate","savedAntialias","antialias","savedToneMapping","toneMapping","restoreRenderState","setRenderTarget","renderSource","visible","render","renderDiffuse","renderDrift","renderProject","i","temp","onBeforeRender","delta","getDelta","NoToneMapping","map","LinearFilter","prototype","Object","create","constructor","sourceMap","densityMap","join","projMap","objects"],"mappings":"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,KAAK,MACPhE,gBACI,8BACA,+BACA,yBACA,2BACA,2BACA,uBACA,0BACA,sBACA,gCACA,oBACA,gBACA,8CACA,4EACA,4EACA,6EACA,6EACA,6FACA,6FACA,6FACA,6FACA,gDACA,gDACA,gDACA,gDACA,gDACA,mDACA,mDACA,mDACA,mDACA,mNACA,oCACA,6DACA,iCACA,0DACA,sEACA,yFACA,qDACA,yFACA,+DACA,gEACA,qEACA,sEACA,KACFgE,KAAK,OAEX3J,EAAKkG,aACD3D,UACI5B,cAAkB6B,MAAO,MACzB5B,eAAmB4B,MAAO,MAC1Bb,YAAgBa,MAAO,IAAI1C,EAAM8B,QAAQ,EAAG,IAC5CF,UAAcc,MAAO,MACrBkH,YAAgBlH,MAAO,OAE3BkD,cACI,oBACA,gBACA,iBACA,kEACA,oDACA,KACFiE,KAAK,MACPhE,gBACI,8BACA,+BACA,2BACA,0BACA,gCACA,oBACA,gBACA,uDACA,yDACA,wCACA,sFACA,kEACA,kCACA,kCACA,2DACA,gFACA,8EACA,+EACA,wFACA,yDACA,yDACA,yDACA,yDACA,uFACA,2DACA,6BACA,KACFgE,KAAK,OAEX3J,EAAKqG,mBACD9D,UACI5B,cAAkB6B,MAAO,MACzB5B,eAAmB4B,MAAO,MAC1BkH,YAAgBlH,MAAO,OAE3BkD,cACI,oBACA,gBACA,iBACA,kEACA,oDACA,KACFiE,KAAK,MACPhE,gBACI,8BACA,+BACA,gCACA,oBACA,gBACA,+EACA,+EACA,gFACA,gFACA,uCACA,uCACA,uCACA,uCACA,sDACA,kDACA,wEACA,KACFgE,KAAK,OAEX3J,EAAKwG,mBACDjE,UACI5B,cAAkB6B,MAAO,MACzB5B,eAAmB4B,MAAO,MAC1BkH,YAAgBlH,MAAO,OAE3BkD,cACI,oBACA,gBACA,iBACA,kEACA,oDACA,KACFiE,KAAK,MACPhE,gBACI,8BACA,+BACA,gCACA,oBACA,gBACA,kDACA,+EACA,+EACA,gFACA,gFACA,oDACA,uCACA,uCACA,uCACA,uCACA,sDACA,oEACA,KACFgE,KAAK,OAEX3J,EAAK2G,mBACDpE,UACI5B,cAAkB6B,MAAO,MACzB5B,eAAmB4B,MAAO,MAC1BkH,YAAgBlH,MAAO,MACvBoH,SAAapH,MAAO,OAExBkD,cACI,oBACA,gBACA,iBACA,kEACA,oDACA,KACFiE,KAAK,MACPhE,gBACI,8BACA,+BACA,gCACA,6BACA,oBACA,gBACA,8CACA,4EACA,4EACA,6EACA,6EACA,wDACA,wDACA,uCACA,uCACA,uCACA,uCACA,sDACA,+CACA,+CACA,8FACA,KACFgE,KAAK,OAEX3J,EAAK+G,aACDxE,UACIxB,QAAYyB,MAAO,MACnBvB,QAAYuB,MAAO,MACnBtB,QAAYsB,MAAO,MACnBrB,WAAeqB,MAAO,MACtBkH,YAAgBlH,MAAO,OAE3BkD,cACI,oBACA,gBACA,iBACA,kEACA,oDACA,KACFiE,KAAK,MACPhE,gBACI,uBACA,uBACA,uBACA,2BACA,gCACA,oBACA,gBACA,sDACA,0DACA,qDACA,+FACA,yGACA,qDACA,KACFgE,KAAK,OAEX3J,EAAK8G,aACDvE,UACIxB,QAAYyB,MAAO,MACnBvB,QAAYuB,MAAO,MACnBtB,QAAYsB,MAAO,MACnBrB,WAAeqB,MAAO,MACtBkH,YAAgBlH,MAAO,OAE3BkD,cACI,oBACA,gBACA,iBACA,kEACA,oDACA,KACFiE,KAAK,MACPhE,gBACI,gCACA,oBACA,gBACA,qBACA,gDACA,kDACA,0CACA,yBACA,gDACA,gDACA,iEACA,uCACA,KACFgE,KAAK,OAGJ5J,EAAO8J,QAAQ7J,KAAOA","file":"../../objects/Fire.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var Fire = function (geometry, options) {\r\n        THREE.Mesh.call(this, geometry);\r\n        this.type = 'Fire';\r\n        this.clock = new THREE.Clock();\r\n        options = options || {};\r\n        var textureWidth = options.textureWidth || 512;\r\n        var textureHeight = options.textureHeight || 512;\r\n        var oneOverWidth = 1 / textureWidth;\r\n        var oneOverHeight = 1 / textureHeight;\r\n        var debug = options.debug === undefined ? false : options.debug;\r\n        this.color1 = options.color1 || new THREE.Color(16777215);\r\n        this.color2 = options.color2 || new THREE.Color(16752640);\r\n        this.color3 = options.color3 || new THREE.Color(0);\r\n        this.colorBias = options.colorBias === undefined ? 0.8 : options.colorBias;\r\n        this.diffuse = options.diffuse === undefined ? 1.33 : options.diffuse;\r\n        this.viscosity = options.viscosity === undefined ? 0.25 : options.viscosity;\r\n        this.expansion = options.expansion === undefined ? -0.25 : options.expansion;\r\n        this.swirl = options.swirl === undefined ? 50 : options.swirl;\r\n        this.burnRate = options.burnRate === undefined ? 0.3 : options.burnRate;\r\n        this.drag = options.drag === undefined ? 0.35 : options.drag;\r\n        this.airSpeed = options.airSpeed === undefined ? 6 : options.airSpeed;\r\n        this.windVector = options.windVector || new THREE.Vector2(0, 0.75);\r\n        this.speed = options.speed === undefined ? 500 : options.speed;\r\n        this.massConservation = options.massConservation === undefined ? false : options.massConservation;\r\n        var size = textureWidth * textureHeight;\r\n        this.sourceData = new Uint8Array(4 * size);\r\n        this.clearSources = function () {\r\n            for (var y = 0; y < textureHeight; y++) {\r\n                for (var x = 0; x < textureWidth; x++) {\r\n                    var i = y * textureWidth + x;\r\n                    var stride = i * 4;\r\n                    this.sourceData[stride] = 0;\r\n                    this.sourceData[stride + 1] = 0;\r\n                    this.sourceData[stride + 2] = 0;\r\n                    this.sourceData[stride + 3] = 0;\r\n                }\r\n            }\r\n            this.sourceMaterial.uniforms['sourceMap'].value = this.internalSource;\r\n            this.sourceMaterial.needsUpdate = true;\r\n            return this.sourceData;\r\n        };\r\n        this.addSource = function (u, v, radius, density = null, windX = null, windY = null) {\r\n            var startX = Math.max(Math.floor((u - radius) * textureWidth), 0);\r\n            var startY = Math.max(Math.floor((v - radius) * textureHeight), 0);\r\n            var endX = Math.min(Math.floor((u + radius) * textureWidth), textureWidth);\r\n            var endY = Math.min(Math.floor((v + radius) * textureHeight), textureHeight);\r\n            for (var y = startY; y < endY; y++) {\r\n                for (var x = startX; x < endX; x++) {\r\n                    var diffX = x * oneOverWidth - u;\r\n                    var diffY = y * oneOverHeight - v;\r\n                    if (diffX * diffX + diffY * diffY < radius * radius) {\r\n                        var i = y * textureWidth + x;\r\n                        var stride = i * 4;\r\n                        if (density != null) {\r\n                            this.sourceData[stride] = Math.min(Math.max(density, 0), 1) * 255;\r\n                        }\r\n                        if (windX != null) {\r\n                            var wind = Math.min(Math.max(windX, -1), 1);\r\n                            wind = wind < 0 ? Math.floor(wind * 127) + 255 : Math.floor(wind * 127);\r\n                            this.sourceData[stride + 1] = wind;\r\n                        }\r\n                        if (windY != null) {\r\n                            var wind = Math.min(Math.max(windY, -1), 1);\r\n                            wind = wind < 0 ? Math.floor(wind * 127) + 255 : Math.floor(wind * 127);\r\n                            this.sourceData[stride + 2] = wind;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            this.internalSource.needsUpdate = true;\r\n            return this.sourceData;\r\n        };\r\n        this.setSourceMap = function (texture) {\r\n            this.sourceMaterial.uniforms['sourceMap'].value = texture;\r\n        };\r\n        var parameters = {\r\n            minFilter: THREE.NearestFilter,\r\n            magFilter: THREE.NearestFilter,\r\n            depthBuffer: false,\r\n            stencilBuffer: false\r\n        };\r\n        this.field0 = new THREE.WebGLRenderTarget(textureWidth, textureHeight, parameters);\r\n        this.field0.background = new THREE.Color(0);\r\n        this.field1 = new THREE.WebGLRenderTarget(textureWidth, textureHeight, parameters);\r\n        this.field0.background = new THREE.Color(0);\r\n        this.fieldProj = new THREE.WebGLRenderTarget(textureWidth, textureHeight, parameters);\r\n        this.field0.background = new THREE.Color(0);\r\n        if (!THREE.MathUtils.isPowerOfTwo(textureWidth) || !THREE.MathUtils.isPowerOfTwo(textureHeight)) {\r\n            this.field0.texture.generateMipmaps = false;\r\n            this.field1.texture.generateMipmaps = false;\r\n            this.fieldProj.texture.generateMipmaps = false;\r\n        }\r\n        this.fieldScene = new THREE.Scene();\r\n        this.fieldScene.background = new THREE.Color(0);\r\n        this.orthoCamera = new THREE.OrthographicCamera(textureWidth / -2, textureWidth / 2, textureHeight / 2, textureHeight / -2, 1, 2);\r\n        this.orthoCamera.position.z = 1;\r\n        this.fieldGeometry = new THREE.PlaneBufferGeometry(textureWidth, textureHeight);\r\n        this.internalSource = new THREE.DataTexture(this.sourceData, textureWidth, textureHeight, THREE.RGBAFormat);\r\n        var shader = Fire.SourceShader;\r\n        this.sourceMaterial = new THREE.ShaderMaterial({\r\n            uniforms: shader.uniforms,\r\n            vertexShader: shader.vertexShader,\r\n            fragmentShader: shader.fragmentShader,\r\n            transparent: false\r\n        });\r\n        this.clearSources();\r\n        this.sourceMesh = new THREE.Mesh(this.fieldGeometry, this.sourceMaterial);\r\n        this.fieldScene.add(this.sourceMesh);\r\n        var shader = Fire.DiffuseShader;\r\n        this.diffuseMaterial = new THREE.ShaderMaterial({\r\n            uniforms: shader.uniforms,\r\n            vertexShader: shader.vertexShader,\r\n            fragmentShader: shader.fragmentShader,\r\n            transparent: false\r\n        });\r\n        this.diffuseMaterial.uniforms['oneOverWidth'].value = oneOverWidth;\r\n        this.diffuseMaterial.uniforms['oneOverHeight'].value = oneOverHeight;\r\n        this.diffuseMesh = new THREE.Mesh(this.fieldGeometry, this.diffuseMaterial);\r\n        this.fieldScene.add(this.diffuseMesh);\r\n        shader = Fire.DriftShader;\r\n        this.driftMaterial = new THREE.ShaderMaterial({\r\n            uniforms: shader.uniforms,\r\n            vertexShader: shader.vertexShader,\r\n            fragmentShader: shader.fragmentShader,\r\n            transparent: false\r\n        });\r\n        this.driftMaterial.uniforms['oneOverWidth'].value = oneOverWidth;\r\n        this.driftMaterial.uniforms['oneOverHeight'].value = oneOverHeight;\r\n        this.driftMesh = new THREE.Mesh(this.fieldGeometry, this.driftMaterial);\r\n        this.fieldScene.add(this.driftMesh);\r\n        shader = Fire.ProjectionShader1;\r\n        this.projMaterial1 = new THREE.ShaderMaterial({\r\n            uniforms: shader.uniforms,\r\n            vertexShader: shader.vertexShader,\r\n            fragmentShader: shader.fragmentShader,\r\n            transparent: false\r\n        });\r\n        this.projMaterial1.uniforms['oneOverWidth'].value = oneOverWidth;\r\n        this.projMaterial1.uniforms['oneOverHeight'].value = oneOverHeight;\r\n        this.projMesh1 = new THREE.Mesh(this.fieldGeometry, this.projMaterial1);\r\n        this.fieldScene.add(this.projMesh1);\r\n        shader = Fire.ProjectionShader2;\r\n        this.projMaterial2 = new THREE.ShaderMaterial({\r\n            uniforms: shader.uniforms,\r\n            vertexShader: shader.vertexShader,\r\n            fragmentShader: shader.fragmentShader,\r\n            transparent: false\r\n        });\r\n        this.projMaterial2.uniforms['oneOverWidth'].value = oneOverWidth;\r\n        this.projMaterial2.uniforms['oneOverHeight'].value = oneOverHeight;\r\n        this.projMesh2 = new THREE.Mesh(this.fieldGeometry, this.projMaterial2);\r\n        this.fieldScene.add(this.projMesh2);\r\n        shader = Fire.ProjectionShader3;\r\n        this.projMaterial3 = new THREE.ShaderMaterial({\r\n            uniforms: shader.uniforms,\r\n            vertexShader: shader.vertexShader,\r\n            fragmentShader: shader.fragmentShader,\r\n            transparent: false\r\n        });\r\n        this.projMaterial3.uniforms['oneOverWidth'].value = oneOverWidth;\r\n        this.projMaterial3.uniforms['oneOverHeight'].value = oneOverHeight;\r\n        this.projMesh3 = new THREE.Mesh(this.fieldGeometry, this.projMaterial3);\r\n        this.fieldScene.add(this.projMesh3);\r\n        if (debug) {\r\n            shader = Fire.DebugShader;\r\n        } else {\r\n            shader = Fire.ColorShader;\r\n        }\r\n        this.material = new THREE.ShaderMaterial({\r\n            uniforms: shader.uniforms,\r\n            vertexShader: shader.vertexShader,\r\n            fragmentShader: shader.fragmentShader,\r\n            transparent: true\r\n        });\r\n        this.material.uniforms['densityMap'].value = this.field1.texture;\r\n        this.configShaders = function (dt) {\r\n            this.diffuseMaterial.uniforms['diffuse'].value = dt * 0.05 * this.diffuse;\r\n            this.diffuseMaterial.uniforms['viscosity'].value = dt * 0.05 * this.viscosity;\r\n            this.diffuseMaterial.uniforms['expansion'].value = Math.exp(this.expansion * -1);\r\n            this.diffuseMaterial.uniforms['swirl'].value = Math.exp(this.swirl * -0.1);\r\n            this.diffuseMaterial.uniforms['drag'].value = Math.exp(this.drag * -0.1);\r\n            this.diffuseMaterial.uniforms['burnRate'].value = this.burnRate * dt * 0.01;\r\n            this.driftMaterial.uniforms['windVector'].value = this.windVector;\r\n            this.driftMaterial.uniforms['airSpeed'].value = dt * this.airSpeed * 0.001 * textureHeight;\r\n            this.material.uniforms['color1'].value = this.color1;\r\n            this.material.uniforms['color2'].value = this.color2;\r\n            this.material.uniforms['color3'].value = this.color3;\r\n            this.material.uniforms['colorBias'].value = this.colorBias;\r\n        };\r\n        this.clearDiffuse = function () {\r\n            this.diffuseMaterial.uniforms['expansion'].value = 1;\r\n            this.diffuseMaterial.uniforms['swirl'].value = 1;\r\n            this.diffuseMaterial.uniforms['drag'].value = 1;\r\n            this.diffuseMaterial.uniforms['burnRate'].value = 0;\r\n        };\r\n        this.swapTextures = function () {\r\n            var swap = this.field0;\r\n            this.field0 = this.field1;\r\n            this.field1 = swap;\r\n        };\r\n        this.saveRenderState = function (renderer) {\r\n            this.savedRenderTarget = renderer.getRenderTarget();\r\n            this.savedXrEnabled = renderer.xr.enabled;\r\n            this.savedShadowAutoUpdate = renderer.shadowMap.autoUpdate;\r\n            this.savedAntialias = renderer.antialias;\r\n            this.savedToneMapping = renderer.toneMapping;\r\n        };\r\n        this.restoreRenderState = function (renderer) {\r\n            renderer.xr.enabled = this.savedXrEnabled;\r\n            renderer.shadowMap.autoUpdate = this.savedShadowAutoUpdate;\r\n            renderer.setRenderTarget(this.savedRenderTarget);\r\n            renderer.antialias = this.savedAntialias;\r\n            renderer.toneMapping = this.savedToneMapping;\r\n        };\r\n        this.renderSource = function (renderer) {\r\n            this.sourceMesh.visible = true;\r\n            this.sourceMaterial.uniforms['densityMap'].value = this.field0.texture;\r\n            renderer.setRenderTarget(this.field1);\r\n            renderer.render(this.fieldScene, this.orthoCamera);\r\n            this.sourceMesh.visible = false;\r\n            this.swapTextures();\r\n        };\r\n        this.renderDiffuse = function (renderer) {\r\n            this.diffuseMesh.visible = true;\r\n            this.diffuseMaterial.uniforms['densityMap'].value = this.field0.texture;\r\n            renderer.setRenderTarget(this.field1);\r\n            renderer.render(this.fieldScene, this.orthoCamera);\r\n            this.diffuseMesh.visible = false;\r\n            this.swapTextures();\r\n        };\r\n        this.renderDrift = function (renderer) {\r\n            this.driftMesh.visible = true;\r\n            this.driftMaterial.uniforms['densityMap'].value = this.field0.texture;\r\n            renderer.setRenderTarget(this.field1);\r\n            renderer.render(this.fieldScene, this.orthoCamera);\r\n            this.driftMesh.visible = false;\r\n            this.swapTextures();\r\n        };\r\n        this.renderProject = function (renderer) {\r\n            this.projMesh1.visible = true;\r\n            this.projMaterial1.uniforms['densityMap'].value = this.field0.texture;\r\n            renderer.setRenderTarget(this.fieldProj);\r\n            renderer.render(this.fieldScene, this.orthoCamera);\r\n            this.projMesh1.visible = false;\r\n            this.projMaterial2.uniforms['densityMap'].value = this.fieldProj.texture;\r\n            this.projMesh2.visible = true;\r\n            for (var i = 0; i < 20; i++) {\r\n                renderer.setRenderTarget(this.field1);\r\n                renderer.render(this.fieldScene, this.orthoCamera);\r\n                var temp = this.field1;\r\n                this.field1 = this.fieldProj;\r\n                this.fieldProj = temp;\r\n                this.projMaterial2.uniforms['densityMap'].value = this.fieldProj.texture;\r\n            }\r\n            this.projMesh2.visible = false;\r\n            this.projMaterial3.uniforms['densityMap'].value = this.field0.texture;\r\n            this.projMaterial3.uniforms['projMap'].value = this.fieldProj.texture;\r\n            this.projMesh3.visible = true;\r\n            renderer.setRenderTarget(this.field1);\r\n            renderer.render(this.fieldScene, this.orthoCamera);\r\n            this.projMesh3.visible = false;\r\n            this.swapTextures();\r\n        };\r\n        this.onBeforeRender = function (renderer) {\r\n            var delta = this.clock.getDelta();\r\n            if (delta > 0.1) {\r\n                delta = 0.1;\r\n            }\r\n            var dt = delta * (this.speed * 0.1);\r\n            this.configShaders(dt);\r\n            this.saveRenderState(renderer);\r\n            renderer.xr.enabled = false;\r\n            renderer.shadowMap.autoUpdate = false;\r\n            renderer.antialias = false;\r\n            renderer.toneMapping = THREE.NoToneMapping;\r\n            this.sourceMesh.visible = false;\r\n            this.diffuseMesh.visible = false;\r\n            this.driftMesh.visible = false;\r\n            this.projMesh1.visible = false;\r\n            this.projMesh2.visible = false;\r\n            this.projMesh3.visible = false;\r\n            this.renderSource(renderer);\r\n            this.clearDiffuse();\r\n            for (var i = 0; i < 21; i++) {\r\n                this.renderDiffuse(renderer);\r\n            }\r\n            this.configShaders(dt);\r\n            this.renderDiffuse(renderer);\r\n            this.renderDrift(renderer);\r\n            if (this.massConservation) {\r\n                this.renderProject(renderer);\r\n                this.renderProject(renderer);\r\n            }\r\n            this.material.map = this.field1.texture;\r\n            this.material.transparent = true;\r\n            this.material.minFilter = THREE.LinearFilter, this.material.magFilter = THREE.LinearFilter, this.restoreRenderState(renderer);\r\n        };\r\n    };\r\n    Fire.prototype = Object.create(THREE.Mesh.prototype);\r\n    Fire.prototype.constructor = Fire;\r\n    Fire.SourceShader = {\r\n        uniforms: {\r\n            'sourceMap': { value: null },\r\n            'densityMap': { value: null }\r\n        },\r\n        vertexShader: [\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            ' \\t  vUv = uv;',\r\n            '     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );',\r\n            '     gl_Position = projectionMatrix * mvPosition;',\r\n            '}'\r\n        ].join('\\n'),\r\n        fragmentShader: [\r\n            'uniform sampler2D sourceMap;',\r\n            'uniform sampler2D densityMap;',\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            '    vec4 source = texture2D( sourceMap, vUv );',\r\n            '    vec4 current = texture2D( densityMap, vUv );',\r\n            '    vec2 v0 = (current.gb - step(0.5, current.gb)) * 2.0;',\r\n            '    vec2 v1 = (source.gb - step(0.5, source.gb)) * 2.0;',\r\n            '    vec2 newVel = v0 + v1;',\r\n            '    newVel = clamp(newVel, -0.99, 0.99);',\r\n            '    newVel = newVel * 0.5 + step(0.0, -newVel);',\r\n            '    float newDensity = source.r + current.a;',\r\n            '    float newTemp = source.r + current.r;',\r\n            '    newDensity = clamp(newDensity, 0.0, 1.0);',\r\n            '    newTemp = clamp(newTemp, 0.0, 1.0);',\r\n            '    gl_FragColor = vec4(newTemp, newVel.xy, newDensity);',\r\n            '}'\r\n        ].join('\\n')\r\n    };\r\n    Fire.DiffuseShader = {\r\n        uniforms: {\r\n            'oneOverWidth': { value: null },\r\n            'oneOverHeight': { value: null },\r\n            'diffuse': { value: null },\r\n            'viscosity': { value: null },\r\n            'expansion': { value: null },\r\n            'swirl': { value: null },\r\n            'drag': { value: null },\r\n            'burnRate': { value: null },\r\n            'densityMap': { value: null }\r\n        },\r\n        vertexShader: [\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            ' \\t  vUv = uv;',\r\n            '     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );',\r\n            '     gl_Position = projectionMatrix * mvPosition;',\r\n            '}'\r\n        ].join('\\n'),\r\n        fragmentShader: [\r\n            'uniform float oneOverWidth;',\r\n            'uniform float oneOverHeight;',\r\n            'uniform float diffuse;',\r\n            'uniform float viscosity;',\r\n            'uniform float expansion;',\r\n            'uniform float swirl;',\r\n            'uniform float burnRate;',\r\n            'uniform float drag;',\r\n            'uniform sampler2D densityMap;',\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            '    vec4 dC = texture2D( densityMap, vUv );',\r\n            '    vec4 dL = texture2D( densityMap, vec2(vUv.x - oneOverWidth, vUv.y) );',\r\n            '    vec4 dR = texture2D( densityMap, vec2(vUv.x + oneOverWidth, vUv.y) );',\r\n            '    vec4 dU = texture2D( densityMap, vec2(vUv.x, vUv.y - oneOverHeight) );',\r\n            '    vec4 dD = texture2D( densityMap, vec2(vUv.x, vUv.y + oneOverHeight) );',\r\n            '    vec4 dUL = texture2D( densityMap, vec2(vUv.x - oneOverWidth, vUv.y - oneOverHeight) );',\r\n            '    vec4 dUR = texture2D( densityMap, vec2(vUv.x + oneOverWidth, vUv.y - oneOverHeight) );',\r\n            '    vec4 dDL = texture2D( densityMap, vec2(vUv.x - oneOverWidth, vUv.y + oneOverHeight) );',\r\n            '    vec4 dDR = texture2D( densityMap, vec2(vUv.x + oneOverWidth, vUv.y + oneOverHeight) );',\r\n            '    dC.yz = (dC.yz - step(0.5, dC.yz)) * 2.0;',\r\n            '    dL.yz = (dL.yz - step(0.5, dL.yz)) * 2.0;',\r\n            '    dR.yz = (dR.yz - step(0.5, dR.yz)) * 2.0;',\r\n            '    dU.yz = (dU.yz - step(0.5, dU.yz)) * 2.0;',\r\n            '    dD.yz = (dD.yz - step(0.5, dD.yz)) * 2.0;',\r\n            '    dUL.yz = (dUL.yz - step(0.5, dUL.yz)) * 2.0;',\r\n            '    dUR.yz = (dUR.yz - step(0.5, dUR.yz)) * 2.0;',\r\n            '    dDL.yz = (dDL.yz - step(0.5, dDL.yz)) * 2.0;',\r\n            '    dDR.yz = (dDR.yz - step(0.5, dDR.yz)) * 2.0;',\r\n            '    vec4 result = (dC + vec4(diffuse, viscosity, viscosity, diffuse) * ( dL + dR + dU + dD + dUL + dUR + dDL + dDR )) / (1.0 + 8.0 * vec4(diffuse, viscosity, viscosity, diffuse)) - vec4(0.0, 0.0, 0.0, 0.001);',\r\n            '    float temperature = result.r;',\r\n            '    temperature = clamp(temperature - burnRate, 0.0, 1.0);',\r\n            '    vec2 velocity = result.yz;',\r\n            '    vec2 expansionVec = vec2(dL.w - dR.w, dU.w - dD.w);',\r\n            '    vec2 swirlVec = vec2((dL.z - dR.z) * 0.5, (dU.y - dD.y) * 0.5);',\r\n            '    velocity = velocity + (1.0 - expansion) * expansionVec + (1.0 - swirl) * swirlVec;',\r\n            '    velocity = velocity - (1.0 - drag) * velocity;',\r\n            '    gl_FragColor = vec4(temperature, velocity * 0.5 + step(0.0, -velocity), result.w);',\r\n            '    gl_FragColor = gl_FragColor * step(oneOverWidth, vUv.x);',\r\n            '    gl_FragColor = gl_FragColor * step(oneOverHeight, vUv.y);',\r\n            '    gl_FragColor = gl_FragColor * step(vUv.x, 1.0 - oneOverWidth);',\r\n            '    gl_FragColor = gl_FragColor * step(vUv.y, 1.0 - oneOverHeight);',\r\n            '}'\r\n        ].join('\\n')\r\n    };\r\n    Fire.DriftShader = {\r\n        uniforms: {\r\n            'oneOverWidth': { value: null },\r\n            'oneOverHeight': { value: null },\r\n            'windVector': { value: new THREE.Vector2(0, 0) },\r\n            'airSpeed': { value: null },\r\n            'densityMap': { value: null }\r\n        },\r\n        vertexShader: [\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            ' \\t  vUv = uv;',\r\n            '     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );',\r\n            '     gl_Position = projectionMatrix * mvPosition;',\r\n            '}'\r\n        ].join('\\n'),\r\n        fragmentShader: [\r\n            'uniform float oneOverWidth;',\r\n            'uniform float oneOverHeight;',\r\n            'uniform vec2 windVector;',\r\n            'uniform float airSpeed;',\r\n            'uniform sampler2D densityMap;',\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            '    vec2 velocity = texture2D( densityMap, vUv ).gb;',\r\n            '    velocity = (velocity - step(0.5, velocity)) * 2.0;',\r\n            '    velocity = velocity + windVector;',\r\n            '    vec2 sourcePos = vUv - airSpeed * vec2(oneOverWidth, oneOverHeight) * velocity;',\r\n            '    vec2 units = sourcePos / vec2(oneOverWidth, oneOverHeight);',\r\n            '    vec2 intPos = floor(units);',\r\n            '    vec2 frac = units - intPos;',\r\n            '    intPos = intPos * vec2(oneOverWidth, oneOverHeight);',\r\n            '    vec4 dX0Y0 = texture2D( densityMap, intPos + vec2(0.0, -oneOverHeight) );',\r\n            '    vec4 dX1Y0 = texture2D( densityMap, intPos + vec2(oneOverWidth, 0.0) );',\r\n            '    vec4 dX0Y1 = texture2D( densityMap, intPos + vec2(0.0, oneOverHeight) );',\r\n            '    vec4 dX1Y1 = texture2D( densityMap, intPos + vec2(oneOverWidth, oneOverHeight) );',\r\n            '    dX0Y0.gb = (dX0Y0.gb - step(0.5, dX0Y0.gb)) * 2.0;',\r\n            '    dX1Y0.gb = (dX1Y0.gb - step(0.5, dX1Y0.gb)) * 2.0;',\r\n            '    dX0Y1.gb = (dX0Y1.gb - step(0.5, dX0Y1.gb)) * 2.0;',\r\n            '    dX1Y1.gb = (dX1Y1.gb - step(0.5, dX1Y1.gb)) * 2.0;',\r\n            '    vec4 source = mix(mix(dX0Y0, dX1Y0, frac.x), mix(dX0Y1, dX1Y1, frac.x), frac.y);',\r\n            '    source.gb = source.gb * 0.5 + step(0.0, -source.gb);',\r\n            '    gl_FragColor = source;',\r\n            '}'\r\n        ].join('\\n')\r\n    };\r\n    Fire.ProjectionShader1 = {\r\n        uniforms: {\r\n            'oneOverWidth': { value: null },\r\n            'oneOverHeight': { value: null },\r\n            'densityMap': { value: null }\r\n        },\r\n        vertexShader: [\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            ' \\t  vUv = uv;',\r\n            '     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );',\r\n            '     gl_Position = projectionMatrix * mvPosition;',\r\n            '}'\r\n        ].join('\\n'),\r\n        fragmentShader: [\r\n            'uniform float oneOverWidth;',\r\n            'uniform float oneOverHeight;',\r\n            'uniform sampler2D densityMap;',\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            '    float dL = texture2D( densityMap, vec2(vUv.x - oneOverWidth, vUv.y) ).g;',\r\n            '    float dR = texture2D( densityMap, vec2(vUv.x + oneOverWidth, vUv.y) ).g;',\r\n            '    float dU = texture2D( densityMap, vec2(vUv.x, vUv.y - oneOverHeight) ).b;',\r\n            '    float dD = texture2D( densityMap, vec2(vUv.x, vUv.y + oneOverHeight) ).b;',\r\n            '    dL = (dL - step(0.5, dL)) * 2.0;',\r\n            '    dR = (dR - step(0.5, dR)) * 2.0;',\r\n            '    dU = (dU - step(0.5, dU)) * 2.0;',\r\n            '    dD = (dD - step(0.5, dD)) * 2.0;',\r\n            '    float h = (oneOverWidth + oneOverHeight) * 0.5;',\r\n            '    float div = -0.5 * h * (dR - dL + dD - dU);',\r\n            '    gl_FragColor = vec4( 0.0, 0.0, div * 0.5 + step(0.0, -div), 0.0);',\r\n            '}'\r\n        ].join('\\n')\r\n    };\r\n    Fire.ProjectionShader2 = {\r\n        uniforms: {\r\n            'oneOverWidth': { value: null },\r\n            'oneOverHeight': { value: null },\r\n            'densityMap': { value: null }\r\n        },\r\n        vertexShader: [\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            ' \\t  vUv = uv;',\r\n            '     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );',\r\n            '     gl_Position = projectionMatrix * mvPosition;',\r\n            '}'\r\n        ].join('\\n'),\r\n        fragmentShader: [\r\n            'uniform float oneOverWidth;',\r\n            'uniform float oneOverHeight;',\r\n            'uniform sampler2D densityMap;',\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            '    float div = texture2D( densityMap, vUv ).b;',\r\n            '    float pL = texture2D( densityMap, vec2(vUv.x - oneOverWidth, vUv.y) ).g;',\r\n            '    float pR = texture2D( densityMap, vec2(vUv.x + oneOverWidth, vUv.y) ).g;',\r\n            '    float pU = texture2D( densityMap, vec2(vUv.x, vUv.y - oneOverHeight) ).g;',\r\n            '    float pD = texture2D( densityMap, vec2(vUv.x, vUv.y + oneOverHeight) ).g;',\r\n            '    float divNorm = (div - step(0.5, div)) * 2.0;',\r\n            '    pL = (pL - step(0.5, pL)) * 2.0;',\r\n            '    pR = (pR - step(0.5, pR)) * 2.0;',\r\n            '    pU = (pU - step(0.5, pU)) * 2.0;',\r\n            '    pD = (pD - step(0.5, pD)) * 2.0;',\r\n            '    float p = (divNorm + pR + pL + pD + pU) * 0.25;',\r\n            '    gl_FragColor = vec4( 0.0, p * 0.5 + step(0.0, -p), div, 0.0);',\r\n            '}'\r\n        ].join('\\n')\r\n    };\r\n    Fire.ProjectionShader3 = {\r\n        uniforms: {\r\n            'oneOverWidth': { value: null },\r\n            'oneOverHeight': { value: null },\r\n            'densityMap': { value: null },\r\n            'projMap': { value: null }\r\n        },\r\n        vertexShader: [\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            ' \\t  vUv = uv;',\r\n            '     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );',\r\n            '     gl_Position = projectionMatrix * mvPosition;',\r\n            '}'\r\n        ].join('\\n'),\r\n        fragmentShader: [\r\n            'uniform float oneOverWidth;',\r\n            'uniform float oneOverHeight;',\r\n            'uniform sampler2D densityMap;',\r\n            'uniform sampler2D projMap;',\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            '    vec4 orig = texture2D(densityMap, vUv);',\r\n            '    float pL = texture2D( projMap, vec2(vUv.x - oneOverWidth, vUv.y) ).g;',\r\n            '    float pR = texture2D( projMap, vec2(vUv.x + oneOverWidth, vUv.y) ).g;',\r\n            '    float pU = texture2D( projMap, vec2(vUv.x, vUv.y - oneOverHeight) ).g;',\r\n            '    float pD = texture2D( projMap, vec2(vUv.x, vUv.y + oneOverHeight) ).g;',\r\n            '    float uNorm = (orig.g - step(0.5, orig.g)) * 2.0;',\r\n            '    float vNorm = (orig.b - step(0.5, orig.b)) * 2.0;',\r\n            '    pL = (pL - step(0.5, pL)) * 2.0;',\r\n            '    pR = (pR - step(0.5, pR)) * 2.0;',\r\n            '    pU = (pU - step(0.5, pU)) * 2.0;',\r\n            '    pD = (pD - step(0.5, pD)) * 2.0;',\r\n            '    float h = (oneOverWidth + oneOverHeight) * 0.5;',\r\n            '    float u = uNorm - (0.5 * (pR - pL) / h);',\r\n            '    float v = vNorm - (0.5 * (pD - pU) / h);',\r\n            '    gl_FragColor = vec4( orig.r, u * 0.5 + step(0.0, -u), v * 0.5 + step(0.0, -v), orig.a);',\r\n            '}'\r\n        ].join('\\n')\r\n    };\r\n    Fire.ColorShader = {\r\n        uniforms: {\r\n            'color1': { value: null },\r\n            'color2': { value: null },\r\n            'color3': { value: null },\r\n            'colorBias': { value: null },\r\n            'densityMap': { value: null }\r\n        },\r\n        vertexShader: [\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            ' \\t  vUv = uv;',\r\n            '     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );',\r\n            '     gl_Position = projectionMatrix * mvPosition;',\r\n            '}'\r\n        ].join('\\n'),\r\n        fragmentShader: [\r\n            'uniform vec3 color1;',\r\n            'uniform vec3 color2;',\r\n            'uniform vec3 color3;',\r\n            'uniform float colorBias;',\r\n            'uniform sampler2D densityMap;',\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            '    float density = texture2D( densityMap, vUv ).a;',\r\n            '    float temperature = texture2D( densityMap, vUv ).r;',\r\n            '    float bias = clamp(colorBias, 0.0001, 0.9999);',\r\n            '    vec3 blend1 = mix(color3, color2, temperature / bias) * (1.0 - step(bias, temperature));',\r\n            '    vec3 blend2 = mix(color2, color1, (temperature - bias) / (1.0 - bias) ) * step(bias, temperature);',\r\n            '    gl_FragColor = vec4(blend1 + blend2, density);',\r\n            '}'\r\n        ].join('\\n')\r\n    };\r\n    Fire.DebugShader = {\r\n        uniforms: {\r\n            'color1': { value: null },\r\n            'color2': { value: null },\r\n            'color3': { value: null },\r\n            'colorBias': { value: null },\r\n            'densityMap': { value: null }\r\n        },\r\n        vertexShader: [\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            ' \\t  vUv = uv;',\r\n            '     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );',\r\n            '     gl_Position = projectionMatrix * mvPosition;',\r\n            '}'\r\n        ].join('\\n'),\r\n        fragmentShader: [\r\n            'uniform sampler2D densityMap;',\r\n            'varying vec2 vUv;',\r\n            'void main() {',\r\n            '    float density;',\r\n            '    density = texture2D( densityMap, vUv ).a;',\r\n            '    vec2 vel = texture2D( densityMap, vUv ).gb;',\r\n            '    vel = (vel - step(0.5, vel)) * 2.0;',\r\n            '    float r = density;',\r\n            '    float g = max(abs(vel.x), density * 0.5);',\r\n            '    float b = max(abs(vel.y), density * 0.5);',\r\n            '    float a = max(density * 0.5, max(abs(vel.x), abs(vel.y)));',\r\n            '    gl_FragColor = vec4(r, g, b, a);',\r\n            '}'\r\n        ].join('\\n')\r\n    };\r\n\r\n    return threex.objects.Fire = Fire;\r\n});"]}