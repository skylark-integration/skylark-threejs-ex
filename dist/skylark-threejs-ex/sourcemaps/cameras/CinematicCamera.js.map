{"version":3,"sources":["cameras/CinematicCamera.js"],"names":["define","THREE","threex","BokehShader","CinematicCamera","fov","aspect","near","far","PerspectiveCamera","call","this","type","postprocessing","enabled","shaderSettings","rings","samples","depthShader","BokehDepthShader","materialDepth","ShaderMaterial","uniforms","vertexShader","fragmentShader","value","setLens","initPostProcessing","prototype","Object","create","constructor","focalLength","filmGauge","fNumber","coc","undefined","setFocalLength","aperture","hyperFocal","linearize","depth","zfar","znear","smoothstep","x","saturate","Math","max","min","focusAt","focusDistance","getFocalLength","focus","nearPoint","farPoint","depthOfField","sdistance","ldistance","bokeh_uniforms","scene","Scene","camera","OrthographicCamera","window","innerWidth","innerHeight","add","pars","minFilter","LinearFilter","magFilter","format","RGBFormat","rtTextureDepth","WebGLRenderTarget","rtTextureColor","bokeh_shader","UniformsUtils","clone","texture","materialBokeh","defines","RINGS","SAMPLES","DEPTH_PACKING","quad","Mesh","PlaneBufferGeometry","position","z","renderCinematic","renderer","currentRenderTarget","getRenderTarget","clear","overrideMaterial","setRenderTarget","render","cameras"],"mappings":"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","file":"../../cameras/CinematicCamera.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\",\r\n    '../shaders/BokehShader2'\r\n], function (\r\n    THREE,\r\n    threex,\r\n    BokehShader\r\n) {\r\n    'use strict';\r\n    var CinematicCamera = function (fov, aspect, near, far) {\r\n        THREE.PerspectiveCamera.call(this, fov, aspect, near, far);\r\n        this.type = 'CinematicCamera';\r\n        this.postprocessing = { enabled: true };\r\n        this.shaderSettings = {\r\n            rings: 3,\r\n            samples: 4\r\n        };\r\n        var depthShader = BokehDepthShader;\r\n        this.materialDepth = new THREE.ShaderMaterial({\r\n            uniforms: depthShader.uniforms,\r\n            vertexShader: depthShader.vertexShader,\r\n            fragmentShader: depthShader.fragmentShader\r\n        });\r\n        this.materialDepth.uniforms['mNear'].value = near;\r\n        this.materialDepth.uniforms['mFar'].value = far;\r\n        this.setLens();\r\n        this.initPostProcessing();\r\n    };\r\n    CinematicCamera.prototype = Object.create(THREE.PerspectiveCamera.prototype);\r\n    CinematicCamera.prototype.constructor = CinematicCamera;\r\n    CinematicCamera.prototype.setLens = function (focalLength, filmGauge, fNumber, coc) {\r\n        if (focalLength === undefined)\r\n            focalLength = 35;\r\n        if (filmGauge !== undefined)\r\n            this.filmGauge = filmGauge;\r\n        this.setFocalLength(focalLength);\r\n        if (fNumber === undefined)\r\n            fNumber = 8;\r\n        if (coc === undefined)\r\n            coc = 0.019;\r\n        this.fNumber = fNumber;\r\n        this.coc = coc;\r\n        this.aperture = focalLength / this.fNumber;\r\n        this.hyperFocal = focalLength * focalLength / (this.aperture * this.coc);\r\n    };\r\n    CinematicCamera.prototype.linearize = function (depth) {\r\n        var zfar = this.far;\r\n        var znear = this.near;\r\n        return -zfar * znear / (depth * (zfar - znear) - zfar);\r\n    };\r\n    CinematicCamera.prototype.smoothstep = function (near, far, depth) {\r\n        var x = this.saturate((depth - near) / (far - near));\r\n        return x * x * (3 - 2 * x);\r\n    };\r\n    CinematicCamera.prototype.saturate = function (x) {\r\n        return Math.max(0, Math.min(1, x));\r\n    };\r\n    CinematicCamera.prototype.focusAt = function (focusDistance) {\r\n        if (focusDistance === undefined)\r\n            focusDistance = 20;\r\n        var focalLength = this.getFocalLength();\r\n        this.focus = focusDistance;\r\n        this.nearPoint = this.hyperFocal * this.focus / (this.hyperFocal + (this.focus - focalLength));\r\n        this.farPoint = this.hyperFocal * this.focus / (this.hyperFocal - (this.focus - focalLength));\r\n        this.depthOfField = this.farPoint - this.nearPoint;\r\n        if (this.depthOfField < 0)\r\n            this.depthOfField = 0;\r\n        this.sdistance = this.smoothstep(this.near, this.far, this.focus);\r\n        this.ldistance = this.linearize(1 - this.sdistance);\r\n        this.postprocessing.bokeh_uniforms['focalDepth'].value = this.ldistance;\r\n    };\r\n    CinematicCamera.prototype.initPostProcessing = function () {\r\n        if (this.postprocessing.enabled) {\r\n            this.postprocessing.scene = new THREE.Scene();\r\n            this.postprocessing.camera = new THREE.OrthographicCamera(window.innerWidth / -2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / -2, -10000, 10000);\r\n            this.postprocessing.scene.add(this.postprocessing.camera);\r\n            var pars = {\r\n                minFilter: THREE.LinearFilter,\r\n                magFilter: THREE.LinearFilter,\r\n                format: THREE.RGBFormat\r\n            };\r\n            this.postprocessing.rtTextureDepth = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight, pars);\r\n            this.postprocessing.rtTextureColor = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight, pars);\r\n            var bokeh_shader = BokehShader;\r\n            this.postprocessing.bokeh_uniforms = THREE.UniformsUtils.clone(bokeh_shader.uniforms);\r\n            this.postprocessing.bokeh_uniforms['tColor'].value = this.postprocessing.rtTextureColor.texture;\r\n            this.postprocessing.bokeh_uniforms['tDepth'].value = this.postprocessing.rtTextureDepth.texture;\r\n            this.postprocessing.bokeh_uniforms['manualdof'].value = 0;\r\n            this.postprocessing.bokeh_uniforms['shaderFocus'].value = 0;\r\n            this.postprocessing.bokeh_uniforms['fstop'].value = 2.8;\r\n            this.postprocessing.bokeh_uniforms['showFocus'].value = 1;\r\n            this.postprocessing.bokeh_uniforms['focalDepth'].value = 0.1;\r\n            this.postprocessing.bokeh_uniforms['znear'].value = this.near;\r\n            this.postprocessing.bokeh_uniforms['zfar'].value = this.near;\r\n            this.postprocessing.bokeh_uniforms['textureWidth'].value = window.innerWidth;\r\n            this.postprocessing.bokeh_uniforms['textureHeight'].value = window.innerHeight;\r\n            this.postprocessing.materialBokeh = new THREE.ShaderMaterial({\r\n                uniforms: this.postprocessing.bokeh_uniforms,\r\n                vertexShader: bokeh_shader.vertexShader,\r\n                fragmentShader: bokeh_shader.fragmentShader,\r\n                defines: {\r\n                    RINGS: this.shaderSettings.rings,\r\n                    SAMPLES: this.shaderSettings.samples,\r\n                    DEPTH_PACKING: 1\r\n                }\r\n            });\r\n            this.postprocessing.quad = new THREE.Mesh(new THREE.PlaneBufferGeometry(window.innerWidth, window.innerHeight), this.postprocessing.materialBokeh);\r\n            this.postprocessing.quad.position.z = -500;\r\n            this.postprocessing.scene.add(this.postprocessing.quad);\r\n        }\r\n    };\r\n    CinematicCamera.prototype.renderCinematic = function (scene, renderer) {\r\n        if (this.postprocessing.enabled) {\r\n            var currentRenderTarget = renderer.getRenderTarget();\r\n            renderer.clear();\r\n            scene.overrideMaterial = null;\r\n            renderer.setRenderTarget(this.postprocessing.rtTextureColor);\r\n            renderer.clear();\r\n            renderer.render(scene, this);\r\n            scene.overrideMaterial = this.materialDepth;\r\n            renderer.setRenderTarget(this.postprocessing.rtTextureDepth);\r\n            renderer.clear();\r\n            renderer.render(scene, this);\r\n            renderer.setRenderTarget(null);\r\n            renderer.render(this.postprocessing.scene, this.postprocessing.camera);\r\n            renderer.setRenderTarget(currentRenderTarget);\r\n        }\r\n    };\r\n    return threex.cameras.CinematicCamera = CinematicCamera;\r\n});"]}