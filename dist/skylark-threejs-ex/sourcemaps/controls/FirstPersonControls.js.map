{"version":3,"sources":["controls/FirstPersonControls.js"],"names":["define","THREE","threex","controls","FirstPersonControls","object","domElement","undefined","console","warn","document","this","enabled","movementSpeed","lookSpeed","lookVertical","autoForward","activeLook","heightSpeed","heightCoef","heightMin","heightMax","constrainVertical","verticalMin","verticalMax","Math","PI","mouseDragOn","autoSpeedFactor","mouseX","mouseY","moveForward","moveBackward","moveLeft","moveRight","viewHalfX","viewHalfY","targetPosition","lat","lon","lookDirection","Vector3","spherical","Spherical","target","contextmenu","event","preventDefault","setAttribute","handleResize","window","innerWidth","innerHeight","offsetWidth","offsetHeight","onMouseDown","focus","stopPropagation","button","onMouseUp","onMouseMove","pageX","pageY","offsetLeft","offsetTop","onKeyDown","keyCode","moveUp","moveDown","onKeyUp","lookAt","x","y","z","isVector3","copy","set","setOrientation","update","delta","heightDelta","MathUtils","clamp","position","actualMoveSpeed","translateZ","translateX","translateY","actualLookSpeed","verticalLookRatio","max","min","phi","degToRad","theta","mapLinear","setFromSphericalCoords","add","dispose","removeEventListener","_onMouseDown","_onMouseMove","_onMouseUp","_onKeyDown","_onKeyUp","bind","scope","fn","apply","arguments","quaternion","applyQuaternion","setFromVector3","radToDeg","addEventListener"],"mappings":"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","file":"../../controls/FirstPersonControls.js","sourcesContent":["define([\n    \"skylark-threejs\",\n    \"../threex\"\n], function (\n    THREE,\n    threex\n) {\n    'use strict';\n    var FirstPersonControls = function (object, domElement) {\n        if (domElement === undefined) {\n            console.warn('THREE.FirstPersonControls: The second parameter \"domElement\" is now mandatory.');\n            domElement = document;\n        }\n        this.object = object;\n        this.domElement = domElement;\n        this.enabled = true;\n        this.movementSpeed = 1;\n        this.lookSpeed = 0.005;\n        this.lookVertical = true;\n        this.autoForward = false;\n        this.activeLook = true;\n        this.heightSpeed = false;\n        this.heightCoef = 1;\n        this.heightMin = 0;\n        this.heightMax = 1;\n        this.constrainVertical = false;\n        this.verticalMin = 0;\n        this.verticalMax = Math.PI;\n        this.mouseDragOn = false;\n        this.autoSpeedFactor = 0;\n        this.mouseX = 0;\n        this.mouseY = 0;\n        this.moveForward = false;\n        this.moveBackward = false;\n        this.moveLeft = false;\n        this.moveRight = false;\n        this.viewHalfX = 0;\n        this.viewHalfY = 0;\n        var lat = 0;\n        var lon = 0;\n        var lookDirection = new THREE.Vector3();\n        var spherical = new THREE.Spherical();\n        var target = new THREE.Vector3();\n        if (this.domElement !== document) {\n            this.domElement.setAttribute('tabindex', -1);\n        }\n        this.handleResize = function () {\n            if (this.domElement === document) {\n                this.viewHalfX = window.innerWidth / 2;\n                this.viewHalfY = window.innerHeight / 2;\n            } else {\n                this.viewHalfX = this.domElement.offsetWidth / 2;\n                this.viewHalfY = this.domElement.offsetHeight / 2;\n            }\n        };\n        this.onMouseDown = function (event) {\n            if (this.domElement !== document) {\n                this.domElement.focus();\n            }\n            event.preventDefault();\n            event.stopPropagation();\n            if (this.activeLook) {\n                switch (event.button) {\n                case 0:\n                    this.moveForward = true;\n                    break;\n                case 2:\n                    this.moveBackward = true;\n                    break;\n                }\n            }\n            this.mouseDragOn = true;\n        };\n        this.onMouseUp = function (event) {\n            event.preventDefault();\n            event.stopPropagation();\n            if (this.activeLook) {\n                switch (event.button) {\n                case 0:\n                    this.moveForward = false;\n                    break;\n                case 2:\n                    this.moveBackward = false;\n                    break;\n                }\n            }\n            this.mouseDragOn = false;\n        };\n        this.onMouseMove = function (event) {\n            if (this.domElement === document) {\n                this.mouseX = event.pageX - this.viewHalfX;\n                this.mouseY = event.pageY - this.viewHalfY;\n            } else {\n                this.mouseX = event.pageX - this.domElement.offsetLeft - this.viewHalfX;\n                this.mouseY = event.pageY - this.domElement.offsetTop - this.viewHalfY;\n            }\n        };\n        this.onKeyDown = function (event) {\n            switch (event.keyCode) {\n            case 38:\n            case 87:\n                this.moveForward = true;\n                break;\n            case 37:\n            case 65:\n                this.moveLeft = true;\n                break;\n            case 40:\n            case 83:\n                this.moveBackward = true;\n                break;\n            case 39:\n            case 68:\n                this.moveRight = true;\n                break;\n            case 82:\n                this.moveUp = true;\n                break;\n            case 70:\n                this.moveDown = true;\n                break;\n            }\n        };\n        this.onKeyUp = function (event) {\n            switch (event.keyCode) {\n            case 38:\n            case 87:\n                this.moveForward = false;\n                break;\n            case 37:\n            case 65:\n                this.moveLeft = false;\n                break;\n            case 40:\n            case 83:\n                this.moveBackward = false;\n                break;\n            case 39:\n            case 68:\n                this.moveRight = false;\n                break;\n            case 82:\n                this.moveUp = false;\n                break;\n            case 70:\n                this.moveDown = false;\n                break;\n            }\n        };\n        this.lookAt = function (x, y, z) {\n            if (x.isVector3) {\n                target.copy(x);\n            } else {\n                target.set(x, y, z);\n            }\n            this.object.lookAt(target);\n            setOrientation(this);\n            return this;\n        };\n        this.update = function () {\n            var targetPosition = new THREE.Vector3();\n            return function update(delta) {\n                if (this.enabled === false)\n                    return;\n                if (this.heightSpeed) {\n                    var y = THREE.MathUtils.clamp(this.object.position.y, this.heightMin, this.heightMax);\n                    var heightDelta = y - this.heightMin;\n                    this.autoSpeedFactor = delta * (heightDelta * this.heightCoef);\n                } else {\n                    this.autoSpeedFactor = 0;\n                }\n                var actualMoveSpeed = delta * this.movementSpeed;\n                if (this.moveForward || this.autoForward && !this.moveBackward)\n                    this.object.translateZ(-(actualMoveSpeed + this.autoSpeedFactor));\n                if (this.moveBackward)\n                    this.object.translateZ(actualMoveSpeed);\n                if (this.moveLeft)\n                    this.object.translateX(-actualMoveSpeed);\n                if (this.moveRight)\n                    this.object.translateX(actualMoveSpeed);\n                if (this.moveUp)\n                    this.object.translateY(actualMoveSpeed);\n                if (this.moveDown)\n                    this.object.translateY(-actualMoveSpeed);\n                var actualLookSpeed = delta * this.lookSpeed;\n                if (!this.activeLook) {\n                    actualLookSpeed = 0;\n                }\n                var verticalLookRatio = 1;\n                if (this.constrainVertical) {\n                    verticalLookRatio = Math.PI / (this.verticalMax - this.verticalMin);\n                }\n                lon -= this.mouseX * actualLookSpeed;\n                if (this.lookVertical)\n                    lat -= this.mouseY * actualLookSpeed * verticalLookRatio;\n                lat = Math.max(-85, Math.min(85, lat));\n                var phi = THREE.MathUtils.degToRad(90 - lat);\n                var theta = THREE.MathUtils.degToRad(lon);\n                if (this.constrainVertical) {\n                    phi = THREE.MathUtils.mapLinear(phi, 0, Math.PI, this.verticalMin, this.verticalMax);\n                }\n                var position = this.object.position;\n                targetPosition.setFromSphericalCoords(1, phi, theta).add(position);\n                this.object.lookAt(targetPosition);\n            };\n        }();\n        function contextmenu(event) {\n            event.preventDefault();\n        }\n        this.dispose = function () {\n            this.domElement.removeEventListener('contextmenu', contextmenu, false);\n            this.domElement.removeEventListener('mousedown', _onMouseDown, false);\n            this.domElement.removeEventListener('mousemove', _onMouseMove, false);\n            this.domElement.removeEventListener('mouseup', _onMouseUp, false);\n            window.removeEventListener('keydown', _onKeyDown, false);\n            window.removeEventListener('keyup', _onKeyUp, false);\n        };\n        var _onMouseMove = bind(this, this.onMouseMove);\n        var _onMouseDown = bind(this, this.onMouseDown);\n        var _onMouseUp = bind(this, this.onMouseUp);\n        var _onKeyDown = bind(this, this.onKeyDown);\n        var _onKeyUp = bind(this, this.onKeyUp);\n        this.domElement.addEventListener('contextmenu', contextmenu, false);\n        this.domElement.addEventListener('mousemove', _onMouseMove, false);\n        this.domElement.addEventListener('mousedown', _onMouseDown, false);\n        this.domElement.addEventListener('mouseup', _onMouseUp, false);\n        window.addEventListener('keydown', _onKeyDown, false);\n        window.addEventListener('keyup', _onKeyUp, false);\n        function bind(scope, fn) {\n            return function () {\n                fn.apply(scope, arguments);\n            };\n        }\n        function setOrientation(controls) {\n            var quaternion = controls.object.quaternion;\n            lookDirection.set(0, 0, -1).applyQuaternion(quaternion);\n            spherical.setFromVector3(lookDirection);\n            lat = 90 - THREE.MathUtils.radToDeg(spherical.phi);\n            lon = THREE.MathUtils.radToDeg(spherical.theta);\n        }\n        this.handleResize();\n        setOrientation(this);\n    };\n    \n    return threex.controls.FirstPersonControls = FirstPersonControls;\n});"]}