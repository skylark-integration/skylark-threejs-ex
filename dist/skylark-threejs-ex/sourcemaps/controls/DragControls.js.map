{"version":3,"sources":["controls/DragControls.js"],"names":["define","THREE","DragControls","_objects","_camera","_domElement","_plane","Plane","_raycaster","Raycaster","_mouse","Vector2","_offset","Vector3","_intersection","_worldPosition","_inverseMatrix","Matrix4","_intersections","_selected","_hovered","scope","this","activate","addEventListener","onDocumentMouseMove","onDocumentMouseDown","onDocumentMouseCancel","onDocumentTouchMove","onDocumentTouchStart","onDocumentTouchEnd","deactivate","removeEventListener","event","preventDefault","rect","getBoundingClientRect","x","clientX","left","width","y","clientY","top","height","setFromCamera","enabled","ray","intersectPlane","position","copy","sub","applyMatrix4","dispatchEvent","type","object","length","intersectObjects","setFromNormalAndCoplanarPoint","getWorldDirection","normal","setFromMatrixPosition","matrixWorld","style","cursor","transformGroup","getInverse","parent","changedTouches","dispose","getObjects","prototype","Object","create","EventDispatcher","constructor"],"mappings":"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","file":"../../controls/DragControls.js","sourcesContent":["define([\n    \"skylark-threejs\"\n], function (THREE) {\n    'use strict';\n    var DragControls = function (_objects, _camera, _domElement) {\n        var _plane = new THREE.Plane();\n        var _raycaster = new THREE.Raycaster();\n        var _mouse = new THREE.Vector2();\n        var _offset = new THREE.Vector3();\n        var _intersection = new THREE.Vector3();\n        var _worldPosition = new THREE.Vector3();\n        var _inverseMatrix = new THREE.Matrix4();\n        var _intersections = [];\n        var _selected = null, _hovered = null;\n        var scope = this;\n        function activate() {\n            _domElement.addEventListener('mousemove', onDocumentMouseMove, false);\n            _domElement.addEventListener('mousedown', onDocumentMouseDown, false);\n            _domElement.addEventListener('mouseup', onDocumentMouseCancel, false);\n            _domElement.addEventListener('mouseleave', onDocumentMouseCancel, false);\n            _domElement.addEventListener('touchmove', onDocumentTouchMove, false);\n            _domElement.addEventListener('touchstart', onDocumentTouchStart, false);\n            _domElement.addEventListener('touchend', onDocumentTouchEnd, false);\n        }\n        function deactivate() {\n            _domElement.removeEventListener('mousemove', onDocumentMouseMove, false);\n            _domElement.removeEventListener('mousedown', onDocumentMouseDown, false);\n            _domElement.removeEventListener('mouseup', onDocumentMouseCancel, false);\n            _domElement.removeEventListener('mouseleave', onDocumentMouseCancel, false);\n            _domElement.removeEventListener('touchmove', onDocumentTouchMove, false);\n            _domElement.removeEventListener('touchstart', onDocumentTouchStart, false);\n            _domElement.removeEventListener('touchend', onDocumentTouchEnd, false);\n        }\n        function dispose() {\n            deactivate();\n        }\n        function getObjects() {\n            return _objects;\n        }\n        function onDocumentMouseMove(event) {\n            event.preventDefault();\n            var rect = _domElement.getBoundingClientRect();\n            _mouse.x = (event.clientX - rect.left) / rect.width * 2 - 1;\n            _mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n            _raycaster.setFromCamera(_mouse, _camera);\n            if (_selected && scope.enabled) {\n                if (_raycaster.ray.intersectPlane(_plane, _intersection)) {\n                    _selected.position.copy(_intersection.sub(_offset).applyMatrix4(_inverseMatrix));\n                }\n                scope.dispatchEvent({\n                    type: 'drag',\n                    object: _selected\n                });\n                return;\n            }\n            _intersections.length = 0;\n            _raycaster.setFromCamera(_mouse, _camera);\n            _raycaster.intersectObjects(_objects, true, _intersections);\n            if (_intersections.length > 0) {\n                var object = _intersections[0].object;\n                _plane.setFromNormalAndCoplanarPoint(_camera.getWorldDirection(_plane.normal), _worldPosition.setFromMatrixPosition(object.matrixWorld));\n                if (_hovered !== object) {\n                    scope.dispatchEvent({\n                        type: 'hoveron',\n                        object: object\n                    });\n                    _domElement.style.cursor = 'pointer';\n                    _hovered = object;\n                }\n            } else {\n                if (_hovered !== null) {\n                    scope.dispatchEvent({\n                        type: 'hoveroff',\n                        object: _hovered\n                    });\n                    _domElement.style.cursor = 'auto';\n                    _hovered = null;\n                }\n            }\n        }\n        function onDocumentMouseDown(event) {\n            event.preventDefault();\n            _intersections.length = 0;\n            _raycaster.setFromCamera(_mouse, _camera);\n            _raycaster.intersectObjects(_objects, true, _intersections);\n            if (_intersections.length > 0) {\n                _selected = scope.transformGroup === true ? _objects[0] : _intersections[0].object;\n                if (_raycaster.ray.intersectPlane(_plane, _intersection)) {\n                    _inverseMatrix.getInverse(_selected.parent.matrixWorld);\n                    _offset.copy(_intersection).sub(_worldPosition.setFromMatrixPosition(_selected.matrixWorld));\n                }\n                _domElement.style.cursor = 'move';\n                scope.dispatchEvent({\n                    type: 'dragstart',\n                    object: _selected\n                });\n            }\n        }\n        function onDocumentMouseCancel(event) {\n            event.preventDefault();\n            if (_selected) {\n                scope.dispatchEvent({\n                    type: 'dragend',\n                    object: _selected\n                });\n                _selected = null;\n            }\n            _domElement.style.cursor = _hovered ? 'pointer' : 'auto';\n        }\n        function onDocumentTouchMove(event) {\n            event.preventDefault();\n            event = event.changedTouches[0];\n            var rect = _domElement.getBoundingClientRect();\n            _mouse.x = (event.clientX - rect.left) / rect.width * 2 - 1;\n            _mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n            _raycaster.setFromCamera(_mouse, _camera);\n            if (_selected && scope.enabled) {\n                if (_raycaster.ray.intersectPlane(_plane, _intersection)) {\n                    _selected.position.copy(_intersection.sub(_offset).applyMatrix4(_inverseMatrix));\n                }\n                scope.dispatchEvent({\n                    type: 'drag',\n                    object: _selected\n                });\n                return;\n            }\n        }\n        function onDocumentTouchStart(event) {\n            event.preventDefault();\n            event = event.changedTouches[0];\n            var rect = _domElement.getBoundingClientRect();\n            _mouse.x = (event.clientX - rect.left) / rect.width * 2 - 1;\n            _mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n            _intersections.length = 0;\n            _raycaster.setFromCamera(_mouse, _camera);\n            _raycaster.intersectObjects(_objects, true, _intersections);\n            if (_intersections.length > 0) {\n                _selected = scope.transformGroup === true ? _objects[0] : _intersections[0].object;\n                _plane.setFromNormalAndCoplanarPoint(_camera.getWorldDirection(_plane.normal), _worldPosition.setFromMatrixPosition(_selected.matrixWorld));\n                if (_raycaster.ray.intersectPlane(_plane, _intersection)) {\n                    _inverseMatrix.getInverse(_selected.parent.matrixWorld);\n                    _offset.copy(_intersection).sub(_worldPosition.setFromMatrixPosition(_selected.matrixWorld));\n                }\n                _domElement.style.cursor = 'move';\n                scope.dispatchEvent({\n                    type: 'dragstart',\n                    object: _selected\n                });\n            }\n        }\n        function onDocumentTouchEnd(event) {\n            event.preventDefault();\n            if (_selected) {\n                scope.dispatchEvent({\n                    type: 'dragend',\n                    object: _selected\n                });\n                _selected = null;\n            }\n            _domElement.style.cursor = 'auto';\n        }\n        activate();\n        this.enabled = true;\n        this.transformGroup = false;\n        this.activate = activate;\n        this.deactivate = deactivate;\n        this.dispose = dispose;\n        this.getObjects = getObjects;\n    };\n    DragControls.prototype = Object.create(THREE.EventDispatcher.prototype);\n    DragControls.prototype.constructor = DragControls;\n    return DragControls;\n});"]}