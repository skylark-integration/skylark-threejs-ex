{"version":3,"sources":["misc/GPUComputationRenderer.js"],"names":["define","THREE","threex","misc","GPUComputationRenderer","sizeX","sizeY","renderer","this","variables","currentTextureIndex","scene","Scene","camera","Camera","position","z","passThruUniforms","passThruTexture","value","passThruShader","createShaderMaterial","mesh","Mesh","PlaneBufferGeometry","addResolutionDefine","materialShader","defines","resolution","toFixed","computeFragmentShader","uniforms","material","ShaderMaterial","vertexShader","fragmentShader","add","addVariable","variableName","initialValueTexture","variable","name","dependencies","renderTargets","wrapS","wrapT","minFilter","NearestFilter","magFilter","push","setVariableDependencies","init","capabilities","isWebGL2","extensions","get","maxVertexTextures","i","length","createRenderTarget","renderTexture","d","depVar","found","j","compute","nextTextureIndex","il","dl","texture","doRenderTarget","getCurrentRenderTarget","getAlternateRenderTarget","sizeXTexture","sizeYTexture","ClampToEdgeWrapping","WebGLRenderTarget","format","RGBAFormat","type","test","navigator","userAgent","HalfFloatType","FloatType","stencilBuffer","depthBuffer","createTexture","data","Float32Array","DataTexture","input","output","currentRenderTarget","getRenderTarget","setRenderTarget","render"],"mappings":";;;;;;;AAAAA,QACI,kBACA,aACD,SACCC,EACAC,GAEA,aAqJA,OAAOA,EAAOC,KAAKC,uBApJU,SAAUC,EAAOC,EAAOC,GACjDC,KAAKC,aACLD,KAAKE,oBAAsB,EAC3B,IAAIC,EAAQ,IAAIV,EAAMW,MAClBC,EAAS,IAAIZ,EAAMa,OACvBD,EAAOE,SAASC,EAAI,EACpB,IAAIC,GAAqBC,iBAAmBC,MAAO,OAC/CC,EAAiBC,EAyIV,mKAzI+DJ,GACtEK,EAAO,IAAIrB,EAAMsB,KAAK,IAAItB,EAAMuB,oBAAoB,EAAG,GAAIJ,GAiF/D,SAASK,EAAoBC,GACzBA,EAAeC,QAAQC,WAAa,SAAWvB,EAAMwB,QAAQ,GAAK,KAAOvB,EAAMuB,QAAQ,GAAK,KAGhG,SAASR,EAAqBS,EAAuBC,GACjDA,EAAWA,MACX,IAAIC,EAAW,IAAI/B,EAAMgC,gBACrBF,SAAUA,EACVG,aA4CG,kEA3CHC,eAAgBL,IAGpB,OADAL,EAAoBO,GACbA,EA5FXrB,EAAMyB,IAAId,GACVd,KAAK6B,YAAc,SAAUC,EAAcR,EAAuBS,GAC9D,IACIC,GACAC,KAAMH,EACNC,oBAAqBA,EACrBP,SAJWxB,KAAKa,qBAAqBS,GAKrCY,aAAc,KACdC,iBACAC,MAAO,KACPC,MAAO,KACPC,UAAW7C,EAAM8C,cACjBC,UAAW/C,EAAM8C,eAGrB,OADAvC,KAAKC,UAAUwC,KAAKT,GACbA,GAEXhC,KAAK0C,wBAA0B,SAAUV,EAAUE,GAC/CF,EAASE,aAAeA,GAE5BlC,KAAK2C,KAAO,WACR,IAAK5C,EAAS6C,aAAaC,WAAa9C,EAAS+C,WAAWC,IAAI,qBAC5D,MAAO,mDAEX,GAAgD,IAA5ChD,EAAS6C,aAAaI,kBACtB,MAAO,yCAEX,IAAK,IAAIC,EAAI,EAAGA,EAAIjD,KAAKC,UAAUiD,OAAQD,IAAK,CAC5C,IAAIjB,EAAWhC,KAAKC,UAAUgD,GAC9BjB,EAASG,cAAc,GAAKnC,KAAKmD,mBAAmBtD,EAAOC,EAAOkC,EAASI,MAAOJ,EAASK,MAAOL,EAASM,UAAWN,EAASQ,WAC/HR,EAASG,cAAc,GAAKnC,KAAKmD,mBAAmBtD,EAAOC,EAAOkC,EAASI,MAAOJ,EAASK,MAAOL,EAASM,UAAWN,EAASQ,WAC/HxC,KAAKoD,cAAcpB,EAASD,oBAAqBC,EAASG,cAAc,IACxEnC,KAAKoD,cAAcpB,EAASD,oBAAqBC,EAASG,cAAc,IACxE,IAAIX,EAAWQ,EAASR,SACpBD,EAAWC,EAASD,SACxB,GAA8B,OAA1BS,EAASE,aACT,IAAK,IAAImB,EAAI,EAAGA,EAAIrB,EAASE,aAAagB,OAAQG,IAAK,CACnD,IAAIC,EAAStB,EAASE,aAAamB,GACnC,GAAIC,EAAOrB,OAASD,EAASC,KAAM,CAE/B,IADA,IAAIsB,GAAQ,EACHC,EAAI,EAAGA,EAAIxD,KAAKC,UAAUiD,OAAQM,IACvC,GAAIF,EAAOrB,OAASjC,KAAKC,UAAUuD,GAAGvB,KAAM,CACxCsB,GAAQ,EACR,MAGR,IAAKA,EACD,MAAO,2CAA6CvB,EAASC,KAAO,gBAAkBqB,EAAOrB,KAGrGV,EAAS+B,EAAOrB,OAAUtB,MAAO,MACjCa,EAASG,eAAiB,uBAAyB2B,EAAOrB,KAAO,MAAQT,EAASG,gBAK9F,OADA3B,KAAKE,oBAAsB,EACpB,MAEXF,KAAKyD,QAAU,WAGX,IAFA,IAAIvD,EAAsBF,KAAKE,oBAC3BwD,EAAgD,IAA7B1D,KAAKE,oBAA4B,EAAI,EACnD+C,EAAI,EAAGU,EAAK3D,KAAKC,UAAUiD,OAAQD,EAAIU,EAAIV,IAAK,CACrD,IAAIjB,EAAWhC,KAAKC,UAAUgD,GAC9B,GAA8B,OAA1BjB,EAASE,aAET,IADA,IAAIX,EAAWS,EAASR,SAASD,SACxB8B,EAAI,EAAGO,EAAK5B,EAASE,aAAagB,OAAQG,EAAIO,EAAIP,IAAK,CAC5D,IAAIC,EAAStB,EAASE,aAAamB,GACnC9B,EAAS+B,EAAOrB,MAAMtB,MAAQ2C,EAAOnB,cAAcjC,GAAqB2D,QAGhF7D,KAAK8D,eAAe9B,EAASR,SAAUQ,EAASG,cAAcuB,IAElE1D,KAAKE,oBAAsBwD,GAE/B1D,KAAK+D,uBAAyB,SAAU/B,GACpC,OAAOA,EAASG,cAAcnC,KAAKE,sBAEvCF,KAAKgE,yBAA2B,SAAUhC,GACtC,OAAOA,EAASG,cAA2C,IAA7BnC,KAAKE,oBAA4B,EAAI,IAKvEF,KAAKiB,oBAAsBA,EAW3BjB,KAAKa,qBAAuBA,EAC5Bb,KAAKmD,mBAAqB,SAAUc,EAAcC,EAAc9B,EAAOC,EAAOC,EAAWE,GAiBrF,OAhBAyB,EAAeA,GAAgBpE,EAC/BqE,EAAeA,GAAgBpE,EAC/BsC,EAAQA,GAAS3C,EAAM0E,oBACvB9B,EAAQA,GAAS5C,EAAM0E,oBACvB7B,EAAYA,GAAa7C,EAAM8C,cAC/BC,EAAYA,GAAa/C,EAAM8C,cACZ,IAAI9C,EAAM2E,kBAAkBH,EAAcC,GACzD9B,MAAOA,EACPC,MAAOA,EACPC,UAAWA,EACXE,UAAWA,EACX6B,OAAQ5E,EAAM6E,WACdC,KAAM,sBAAsBC,KAAKC,UAAUC,WAAajF,EAAMkF,cAAgBlF,EAAMmF,UACpFC,eAAe,EACfC,aAAa,KAIrB9E,KAAK+E,cAAgB,WACjB,IAAIC,EAAO,IAAIC,aAAapF,EAAQC,EAAQ,GAC5C,OAAO,IAAIL,EAAMyF,YAAYF,EAAMnF,EAAOC,EAAOL,EAAM6E,WAAY7E,EAAMmF,YAE7E5E,KAAKoD,cAAgB,SAAU+B,EAAOC,GAClC3E,EAAiBC,gBAAgBC,MAAQwE,EACzCnF,KAAK8D,eAAelD,EAAgBwE,GACpC3E,EAAiBC,gBAAgBC,MAAQ,MAE7CX,KAAK8D,eAAiB,SAAUtC,EAAU4D,GACtC,IAAIC,EAAsBtF,EAASuF,kBACnCxE,EAAKU,SAAWA,EAChBzB,EAASwF,gBAAgBH,GACzBrF,EAASyF,OAAOrF,EAAOE,GACvBS,EAAKU,SAAWZ,EAChBb,EAASwF,gBAAgBF","file":"../../misc/GPUComputationRenderer.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var GPUComputationRenderer = function (sizeX, sizeY, renderer) {\r\n        this.variables = [];\r\n        this.currentTextureIndex = 0;\r\n        var scene = new THREE.Scene();\r\n        var camera = new THREE.Camera();\r\n        camera.position.z = 1;\r\n        var passThruUniforms = { passThruTexture: { value: null } };\r\n        var passThruShader = createShaderMaterial(getPassThroughFragmentShader(), passThruUniforms);\r\n        var mesh = new THREE.Mesh(new THREE.PlaneBufferGeometry(2, 2), passThruShader);\r\n        scene.add(mesh);\r\n        this.addVariable = function (variableName, computeFragmentShader, initialValueTexture) {\r\n            var material = this.createShaderMaterial(computeFragmentShader);\r\n            var variable = {\r\n                name: variableName,\r\n                initialValueTexture: initialValueTexture,\r\n                material: material,\r\n                dependencies: null,\r\n                renderTargets: [],\r\n                wrapS: null,\r\n                wrapT: null,\r\n                minFilter: THREE.NearestFilter,\r\n                magFilter: THREE.NearestFilter\r\n            };\r\n            this.variables.push(variable);\r\n            return variable;\r\n        };\r\n        this.setVariableDependencies = function (variable, dependencies) {\r\n            variable.dependencies = dependencies;\r\n        };\r\n        this.init = function () {\r\n            if (!renderer.capabilities.isWebGL2 && !renderer.extensions.get('OES_texture_float')) {\r\n                return 'No OES_texture_float support for float textures.';\r\n            }\r\n            if (renderer.capabilities.maxVertexTextures === 0) {\r\n                return 'No support for vertex shader textures.';\r\n            }\r\n            for (var i = 0; i < this.variables.length; i++) {\r\n                var variable = this.variables[i];\r\n                variable.renderTargets[0] = this.createRenderTarget(sizeX, sizeY, variable.wrapS, variable.wrapT, variable.minFilter, variable.magFilter);\r\n                variable.renderTargets[1] = this.createRenderTarget(sizeX, sizeY, variable.wrapS, variable.wrapT, variable.minFilter, variable.magFilter);\r\n                this.renderTexture(variable.initialValueTexture, variable.renderTargets[0]);\r\n                this.renderTexture(variable.initialValueTexture, variable.renderTargets[1]);\r\n                var material = variable.material;\r\n                var uniforms = material.uniforms;\r\n                if (variable.dependencies !== null) {\r\n                    for (var d = 0; d < variable.dependencies.length; d++) {\r\n                        var depVar = variable.dependencies[d];\r\n                        if (depVar.name !== variable.name) {\r\n                            var found = false;\r\n                            for (var j = 0; j < this.variables.length; j++) {\r\n                                if (depVar.name === this.variables[j].name) {\r\n                                    found = true;\r\n                                    break;\r\n                                }\r\n                            }\r\n                            if (!found) {\r\n                                return 'Variable dependency not found. Variable=' + variable.name + ', dependency=' + depVar.name;\r\n                            }\r\n                        }\r\n                        uniforms[depVar.name] = { value: null };\r\n                        material.fragmentShader = '\\nuniform sampler2D ' + depVar.name + ';\\n' + material.fragmentShader;\r\n                    }\r\n                }\r\n            }\r\n            this.currentTextureIndex = 0;\r\n            return null;\r\n        };\r\n        this.compute = function () {\r\n            var currentTextureIndex = this.currentTextureIndex;\r\n            var nextTextureIndex = this.currentTextureIndex === 0 ? 1 : 0;\r\n            for (var i = 0, il = this.variables.length; i < il; i++) {\r\n                var variable = this.variables[i];\r\n                if (variable.dependencies !== null) {\r\n                    var uniforms = variable.material.uniforms;\r\n                    for (var d = 0, dl = variable.dependencies.length; d < dl; d++) {\r\n                        var depVar = variable.dependencies[d];\r\n                        uniforms[depVar.name].value = depVar.renderTargets[currentTextureIndex].texture;\r\n                    }\r\n                }\r\n                this.doRenderTarget(variable.material, variable.renderTargets[nextTextureIndex]);\r\n            }\r\n            this.currentTextureIndex = nextTextureIndex;\r\n        };\r\n        this.getCurrentRenderTarget = function (variable) {\r\n            return variable.renderTargets[this.currentTextureIndex];\r\n        };\r\n        this.getAlternateRenderTarget = function (variable) {\r\n            return variable.renderTargets[this.currentTextureIndex === 0 ? 1 : 0];\r\n        };\r\n        function addResolutionDefine(materialShader) {\r\n            materialShader.defines.resolution = 'vec2( ' + sizeX.toFixed(1) + ', ' + sizeY.toFixed(1) + ' )';\r\n        }\r\n        this.addResolutionDefine = addResolutionDefine;\r\n        function createShaderMaterial(computeFragmentShader, uniforms) {\r\n            uniforms = uniforms || {};\r\n            var material = new THREE.ShaderMaterial({\r\n                uniforms: uniforms,\r\n                vertexShader: getPassThroughVertexShader(),\r\n                fragmentShader: computeFragmentShader\r\n            });\r\n            addResolutionDefine(material);\r\n            return material;\r\n        }\r\n        this.createShaderMaterial = createShaderMaterial;\r\n        this.createRenderTarget = function (sizeXTexture, sizeYTexture, wrapS, wrapT, minFilter, magFilter) {\r\n            sizeXTexture = sizeXTexture || sizeX;\r\n            sizeYTexture = sizeYTexture || sizeY;\r\n            wrapS = wrapS || THREE.ClampToEdgeWrapping;\r\n            wrapT = wrapT || THREE.ClampToEdgeWrapping;\r\n            minFilter = minFilter || THREE.NearestFilter;\r\n            magFilter = magFilter || THREE.NearestFilter;\r\n            var renderTarget = new THREE.WebGLRenderTarget(sizeXTexture, sizeYTexture, {\r\n                wrapS: wrapS,\r\n                wrapT: wrapT,\r\n                minFilter: minFilter,\r\n                magFilter: magFilter,\r\n                format: THREE.RGBAFormat,\r\n                type: /(iPad|iPhone|iPod)/g.test(navigator.userAgent) ? THREE.HalfFloatType : THREE.FloatType,\r\n                stencilBuffer: false,\r\n                depthBuffer: false\r\n            });\r\n            return renderTarget;\r\n        };\r\n        this.createTexture = function () {\r\n            var data = new Float32Array(sizeX * sizeY * 4);\r\n            return new THREE.DataTexture(data, sizeX, sizeY, THREE.RGBAFormat, THREE.FloatType);\r\n        };\r\n        this.renderTexture = function (input, output) {\r\n            passThruUniforms.passThruTexture.value = input;\r\n            this.doRenderTarget(passThruShader, output);\r\n            passThruUniforms.passThruTexture.value = null;\r\n        };\r\n        this.doRenderTarget = function (material, output) {\r\n            var currentRenderTarget = renderer.getRenderTarget();\r\n            mesh.material = material;\r\n            renderer.setRenderTarget(output);\r\n            renderer.render(scene, camera);\r\n            mesh.material = passThruShader;\r\n            renderer.setRenderTarget(currentRenderTarget);\r\n        };\r\n        function getPassThroughVertexShader() {\r\n            return 'void main()\\t{\\n' + '\\n' + '\\tgl_Position = vec4( position, 1.0 );\\n' + '\\n' + '}\\n';\r\n        }\r\n        function getPassThroughFragmentShader() {\r\n            return 'uniform sampler2D passThruTexture;\\n' + '\\n' + 'void main() {\\n' + '\\n' + '\\tvec2 uv = gl_FragCoord.xy / resolution.xy;\\n' + '\\n' + '\\tgl_FragColor = texture2D( passThruTexture, uv );\\n' + '\\n' + '}\\n';\r\n        }\r\n    };\r\n\r\n    return threex.misc.GPUComputationRenderer = GPUComputationRenderer;\r\n});"]}