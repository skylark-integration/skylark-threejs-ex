{"version":3,"sources":["misc/Volume.js"],"names":["define","THREE","VolumeSlice","Volume","xLength","yLength","zLength","type","arrayBuffer","arguments","length","this","Number","data","Uint8Array","Int8Array","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","spacing","offset","matrix","Matrix3","identity","lowerThreshold","Infinity","Object","defineProperty","get","set","value","sliceList","forEach","slice","geometryNeedsUpdate","upperThreshold","prototype","constructor","getData","i","j","k","access","reverseAccess","index","z","Math","floor","y","map","functionToMap","context","call","extractPerpendicularPlane","axis","RASIndex","iLength","jLength","sliceAccess","planeMatrix","Matrix4","volume","planeWidth","planeHeight","firstSpacing","secondSpacing","positionOffset","IJKIndex","axisInIJK","Vector3","firstDirection","secondDirection","dimensions","multiply","makeRotationY","PI","RASDimensions","setPosition","makeRotationX","applyMatrix4","inverseMatrix","normalize","argVar","abs","dot","round","base","iDirection","find","x","jDirection","kDirection","argumentsWithInversion","argArray","direction","n","argString","join","eval","extractSlice","push","repaintAllSlices","repaint","computeMinMax","min","max","datasize","isNaN"],"mappings":"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","file":"../../misc/Volume.js","sourcesContent":["define([\n    \"skylark-threejs\",\n    '../misc/VolumeSlice'\n], function (\n    THREE, \n    VolumeSlice\n) {\n    'use strict';\n    var Volume = function (xLength, yLength, zLength, type, arrayBuffer) {\n        if (arguments.length > 0) {\n            this.xLength = Number(xLength) || 1;\n            this.yLength = Number(yLength) || 1;\n            this.zLength = Number(zLength) || 1;\n            switch (type) {\n            case 'Uint8':\n            case 'uint8':\n            case 'uchar':\n            case 'unsigned char':\n            case 'uint8_t':\n                this.data = new Uint8Array(arrayBuffer);\n                break;\n            case 'Int8':\n            case 'int8':\n            case 'signed char':\n            case 'int8_t':\n                this.data = new Int8Array(arrayBuffer);\n                break;\n            case 'Int16':\n            case 'int16':\n            case 'short':\n            case 'short int':\n            case 'signed short':\n            case 'signed short int':\n            case 'int16_t':\n                this.data = new Int16Array(arrayBuffer);\n                break;\n            case 'Uint16':\n            case 'uint16':\n            case 'ushort':\n            case 'unsigned short':\n            case 'unsigned short int':\n            case 'uint16_t':\n                this.data = new Uint16Array(arrayBuffer);\n                break;\n            case 'Int32':\n            case 'int32':\n            case 'int':\n            case 'signed int':\n            case 'int32_t':\n                this.data = new Int32Array(arrayBuffer);\n                break;\n            case 'Uint32':\n            case 'uint32':\n            case 'uint':\n            case 'unsigned int':\n            case 'uint32_t':\n                this.data = new Uint32Array(arrayBuffer);\n                break;\n            case 'longlong':\n            case 'long long':\n            case 'long long int':\n            case 'signed long long':\n            case 'signed long long int':\n            case 'int64':\n            case 'int64_t':\n            case 'ulonglong':\n            case 'unsigned long long':\n            case 'unsigned long long int':\n            case 'uint64':\n            case 'uint64_t':\n                throw 'Error in Volume constructor : this type is not supported in JavaScript';\n                break;\n            case 'Float32':\n            case 'float32':\n            case 'float':\n                this.data = new Float32Array(arrayBuffer);\n                break;\n            case 'Float64':\n            case 'float64':\n            case 'double':\n                this.data = new Float64Array(arrayBuffer);\n                break;\n            default:\n                this.data = new Uint8Array(arrayBuffer);\n            }\n            if (this.data.length !== this.xLength * this.yLength * this.zLength) {\n                throw 'Error in Volume constructor, lengths are not matching arrayBuffer size';\n            }\n        }\n        this.spacing = [\n            1,\n            1,\n            1\n        ];\n        this.offset = [\n            0,\n            0,\n            0\n        ];\n        this.matrix = new THREE.Matrix3();\n        this.matrix.identity();\n        var lowerThreshold = -Infinity;\n        Object.defineProperty(this, 'lowerThreshold', {\n            get: function () {\n                return lowerThreshold;\n            },\n            set: function (value) {\n                lowerThreshold = value;\n                this.sliceList.forEach(function (slice) {\n                    slice.geometryNeedsUpdate = true;\n                });\n            }\n        });\n        var upperThreshold = Infinity;\n        Object.defineProperty(this, 'upperThreshold', {\n            get: function () {\n                return upperThreshold;\n            },\n            set: function (value) {\n                upperThreshold = value;\n                this.sliceList.forEach(function (slice) {\n                    slice.geometryNeedsUpdate = true;\n                });\n            }\n        });\n        this.sliceList = [];\n    };\n    Volume.prototype = {\n        constructor: Volume,\n        getData: function (i, j, k) {\n            return this.data[k * this.xLength * this.yLength + j * this.xLength + i];\n        },\n        access: function (i, j, k) {\n            return k * this.xLength * this.yLength + j * this.xLength + i;\n        },\n        reverseAccess: function (index) {\n            var z = Math.floor(index / (this.yLength * this.xLength));\n            var y = Math.floor((index - z * this.yLength * this.xLength) / this.xLength);\n            var x = index - z * this.yLength * this.xLength - y * this.xLength;\n            return [\n                x,\n                y,\n                z\n            ];\n        },\n        map: function (functionToMap, context) {\n            var length = this.data.length;\n            context = context || this;\n            for (var i = 0; i < length; i++) {\n                this.data[i] = functionToMap.call(context, this.data[i], i, this.data);\n            }\n            return this;\n        },\n        extractPerpendicularPlane: function (axis, RASIndex) {\n            var iLength, jLength, sliceAccess, planeMatrix = new THREE.Matrix4().identity(), volume = this, planeWidth, planeHeight, firstSpacing, secondSpacing, positionOffset, IJKIndex;\n            var axisInIJK = new THREE.Vector3(), firstDirection = new THREE.Vector3(), secondDirection = new THREE.Vector3();\n            var dimensions = new THREE.Vector3(this.xLength, this.yLength, this.zLength);\n            switch (axis) {\n            case 'x':\n                axisInIJK.set(1, 0, 0);\n                firstDirection.set(0, 0, -1);\n                secondDirection.set(0, -1, 0);\n                firstSpacing = this.spacing[2];\n                secondSpacing = this.spacing[1];\n                IJKIndex = new THREE.Vector3(RASIndex, 0, 0);\n                planeMatrix.multiply(new THREE.Matrix4().makeRotationY(Math.PI / 2));\n                positionOffset = (volume.RASDimensions[0] - 1) / 2;\n                planeMatrix.setPosition(new THREE.Vector3(RASIndex - positionOffset, 0, 0));\n                break;\n            case 'y':\n                axisInIJK.set(0, 1, 0);\n                firstDirection.set(1, 0, 0);\n                secondDirection.set(0, 0, 1);\n                firstSpacing = this.spacing[0];\n                secondSpacing = this.spacing[2];\n                IJKIndex = new THREE.Vector3(0, RASIndex, 0);\n                planeMatrix.multiply(new THREE.Matrix4().makeRotationX(-Math.PI / 2));\n                positionOffset = (volume.RASDimensions[1] - 1) / 2;\n                planeMatrix.setPosition(new THREE.Vector3(0, RASIndex - positionOffset, 0));\n                break;\n            case 'z':\n            default:\n                axisInIJK.set(0, 0, 1);\n                firstDirection.set(1, 0, 0);\n                secondDirection.set(0, -1, 0);\n                firstSpacing = this.spacing[0];\n                secondSpacing = this.spacing[1];\n                IJKIndex = new THREE.Vector3(0, 0, RASIndex);\n                positionOffset = (volume.RASDimensions[2] - 1) / 2;\n                planeMatrix.setPosition(new THREE.Vector3(0, 0, RASIndex - positionOffset));\n                break;\n            }\n            firstDirection.applyMatrix4(volume.inverseMatrix).normalize();\n            firstDirection.argVar = 'i';\n            secondDirection.applyMatrix4(volume.inverseMatrix).normalize();\n            secondDirection.argVar = 'j';\n            axisInIJK.applyMatrix4(volume.inverseMatrix).normalize();\n            iLength = Math.floor(Math.abs(firstDirection.dot(dimensions)));\n            jLength = Math.floor(Math.abs(secondDirection.dot(dimensions)));\n            planeWidth = Math.abs(iLength * firstSpacing);\n            planeHeight = Math.abs(jLength * secondSpacing);\n            IJKIndex = Math.abs(Math.round(IJKIndex.applyMatrix4(volume.inverseMatrix).dot(axisInIJK)));\n            var base = [\n                new THREE.Vector3(1, 0, 0),\n                new THREE.Vector3(0, 1, 0),\n                new THREE.Vector3(0, 0, 1)\n            ];\n            var iDirection = [\n                firstDirection,\n                secondDirection,\n                axisInIJK\n            ].find(function (x) {\n                return Math.abs(x.dot(base[0])) > 0.9;\n            });\n            var jDirection = [\n                firstDirection,\n                secondDirection,\n                axisInIJK\n            ].find(function (x) {\n                return Math.abs(x.dot(base[1])) > 0.9;\n            });\n            var kDirection = [\n                firstDirection,\n                secondDirection,\n                axisInIJK\n            ].find(function (x) {\n                return Math.abs(x.dot(base[2])) > 0.9;\n            });\n            var argumentsWithInversion = [\n                'volume.xLength-1-',\n                'volume.yLength-1-',\n                'volume.zLength-1-'\n            ];\n            var argArray = [\n                iDirection,\n                jDirection,\n                kDirection\n            ].map(function (direction, n) {\n                return (direction.dot(base[n]) > 0 ? '' : argumentsWithInversion[n]) + (direction === axisInIJK ? 'IJKIndex' : direction.argVar);\n            });\n            var argString = argArray.join(',');\n            sliceAccess = eval('(function sliceAccess (i,j) {return volume.access( ' + argString + ');})');\n            return {\n                iLength: iLength,\n                jLength: jLength,\n                sliceAccess: sliceAccess,\n                matrix: planeMatrix,\n                planeWidth: planeWidth,\n                planeHeight: planeHeight\n            };\n        },\n        extractSlice: function (axis, index) {\n            var slice = new VolumeSlice(this, index, axis);\n            this.sliceList.push(slice);\n            return slice;\n        },\n        repaintAllSlices: function () {\n            this.sliceList.forEach(function (slice) {\n                slice.repaint();\n            });\n            return this;\n        },\n        computeMinMax: function () {\n            var min = Infinity;\n            var max = -Infinity;\n            var datasize = this.data.length;\n            var i = 0;\n            for (i = 0; i < datasize; i++) {\n                if (!isNaN(this.data[i])) {\n                    var value = this.data[i];\n                    min = Math.min(min, value);\n                    max = Math.max(max, value);\n                }\n            }\n            this.min = min;\n            this.max = max;\n            return [\n                min,\n                max\n            ];\n        }\n    };\n    return Volume;\n});"]}