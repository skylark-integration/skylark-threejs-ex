{"version":3,"sources":["csm/CSMHelper.js"],"names":["define","THREE","threex","csm","CSMHelper","Group","[object Object]","super","this","displayFrustum","displayPlanes","displayShadowBounds","indices","Uint16Array","positions","Float32Array","frustumGeometry","BufferGeometry","setIndex","BufferAttribute","setAttribute","frustumLines","LineSegments","LineBasicMaterial","add","cascadeLines","cascadePlanes","shadowLines","i","l","length","cascadeLine","cascadePlane","shadowLineGroup","visible","camera","cascades","mainFrustum","frustums","lights","frustumLinePositions","geometry","getAttribute","position","copy","quaternion","scale","updateMatrixWorld","remove","pop","Box3Helper","Box3","planeMat","MeshBasicMaterial","transparent","opacity","depthWrite","side","DoubleSide","Mesh","PlaneBufferGeometry","shadowLine","push","frustum","shadowCam","shadow","farVerts","vertices","far","children","box","min","max","z","addVectors","multiplyScalar","subVectors","attach","set","bottom","left","top","right","near","nearVerts","setXYZ","x","y","needsUpdate"],"mappings":"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","file":"../../csm/CSMHelper.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    class CSMHelper extends THREE.Group {\r\n        constructor(csm) {\r\n            super();\r\n            this.csm = csm;\r\n            this.displayFrustum = true;\r\n            this.displayPlanes = true;\r\n            this.displayShadowBounds = true;\r\n            const indices = new Uint16Array([\r\n                0,\r\n                1,\r\n                1,\r\n                2,\r\n                2,\r\n                3,\r\n                3,\r\n                0,\r\n                4,\r\n                5,\r\n                5,\r\n                6,\r\n                6,\r\n                7,\r\n                7,\r\n                4,\r\n                0,\r\n                4,\r\n                1,\r\n                5,\r\n                2,\r\n                6,\r\n                3,\r\n                7\r\n            ]);\r\n            const positions = new Float32Array(24);\r\n            const frustumGeometry = new THREE.BufferGeometry();\r\n            frustumGeometry.setIndex(new THREE.BufferAttribute(indices, 1));\r\n            frustumGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3, false));\r\n            const frustumLines = new THREE.LineSegments(frustumGeometry, new THREE.LineBasicMaterial());\r\n            this.add(frustumLines);\r\n            this.frustumLines = frustumLines;\r\n            this.cascadeLines = [];\r\n            this.cascadePlanes = [];\r\n            this.shadowLines = [];\r\n        }\r\n        updateVisibility() {\r\n            const displayFrustum = this.displayFrustum;\r\n            const displayPlanes = this.displayPlanes;\r\n            const displayShadowBounds = this.displayShadowBounds;\r\n            const frustumLines = this.frustumLines;\r\n            const cascadeLines = this.cascadeLines;\r\n            const cascadePlanes = this.cascadePlanes;\r\n            const shadowLines = this.shadowLines;\r\n            for (let i = 0, l = cascadeLines.length; i < l; i++) {\r\n                const cascadeLine = cascadeLines[i];\r\n                const cascadePlane = cascadePlanes[i];\r\n                const shadowLineGroup = shadowLines[i];\r\n                cascadeLine.visible = displayFrustum;\r\n                cascadePlane.visible = displayFrustum && displayPlanes;\r\n                shadowLineGroup.visible = displayShadowBounds;\r\n            }\r\n            frustumLines.visible = displayFrustum;\r\n        }\r\n        update() {\r\n            const csm = this.csm;\r\n            const camera = csm.camera;\r\n            const cascades = csm.cascades;\r\n            const mainFrustum = csm.mainFrustum;\r\n            const frustums = csm.frustums;\r\n            const lights = csm.lights;\r\n            const frustumLines = this.frustumLines;\r\n            const frustumLinePositions = frustumLines.geometry.getAttribute('position');\r\n            const cascadeLines = this.cascadeLines;\r\n            const cascadePlanes = this.cascadePlanes;\r\n            const shadowLines = this.shadowLines;\r\n            this.position.copy(camera.position);\r\n            this.quaternion.copy(camera.quaternion);\r\n            this.scale.copy(camera.scale);\r\n            this.updateMatrixWorld(true);\r\n            while (cascadeLines.length > cascades) {\r\n                this.remove(cascadeLines.pop());\r\n                this.remove(cascadePlanes.pop());\r\n                this.remove(shadowLines.pop());\r\n            }\r\n            while (cascadeLines.length < cascades) {\r\n                const cascadeLine = new THREE.Box3Helper(new THREE.Box3(), 16777215);\r\n                const planeMat = new THREE.MeshBasicMaterial({\r\n                    transparent: true,\r\n                    opacity: 0.1,\r\n                    depthWrite: false,\r\n                    side: THREE.DoubleSide\r\n                });\r\n                const cascadePlane = new THREE.Mesh(new THREE.PlaneBufferGeometry(), planeMat);\r\n                const shadowLineGroup = new THREE.Group();\r\n                const shadowLine = new THREE.Box3Helper(new THREE.Box3(), 16776960);\r\n                shadowLineGroup.add(shadowLine);\r\n                this.add(cascadeLine);\r\n                this.add(cascadePlane);\r\n                this.add(shadowLineGroup);\r\n                cascadeLines.push(cascadeLine);\r\n                cascadePlanes.push(cascadePlane);\r\n                shadowLines.push(shadowLineGroup);\r\n            }\r\n            for (let i = 0; i < cascades; i++) {\r\n                const frustum = frustums[i];\r\n                const light = lights[i];\r\n                const shadowCam = light.shadow.camera;\r\n                const farVerts = frustum.vertices.far;\r\n                const cascadeLine = cascadeLines[i];\r\n                const cascadePlane = cascadePlanes[i];\r\n                const shadowLineGroup = shadowLines[i];\r\n                const shadowLine = shadowLineGroup.children[0];\r\n                cascadeLine.box.min.copy(farVerts[2]);\r\n                cascadeLine.box.max.copy(farVerts[0]);\r\n                cascadeLine.box.max.z += 0.0001;\r\n                cascadePlane.position.addVectors(farVerts[0], farVerts[2]);\r\n                cascadePlane.position.multiplyScalar(0.5);\r\n                cascadePlane.scale.subVectors(farVerts[0], farVerts[2]);\r\n                cascadePlane.scale.z = 0.0001;\r\n                this.remove(shadowLineGroup);\r\n                shadowLineGroup.position.copy(shadowCam.position);\r\n                shadowLineGroup.quaternion.copy(shadowCam.quaternion);\r\n                shadowLineGroup.scale.copy(shadowCam.scale);\r\n                shadowLineGroup.updateMatrixWorld(true);\r\n                this.attach(shadowLineGroup);\r\n                shadowLine.box.min.set(shadowCam.bottom, shadowCam.left, -shadowCam.far);\r\n                shadowLine.box.max.set(shadowCam.top, shadowCam.right, -shadowCam.near);\r\n            }\r\n            const nearVerts = mainFrustum.vertices.near;\r\n            const farVerts = mainFrustum.vertices.far;\r\n            frustumLinePositions.setXYZ(0, farVerts[0].x, farVerts[0].y, farVerts[0].z);\r\n            frustumLinePositions.setXYZ(1, farVerts[3].x, farVerts[3].y, farVerts[3].z);\r\n            frustumLinePositions.setXYZ(2, farVerts[2].x, farVerts[2].y, farVerts[2].z);\r\n            frustumLinePositions.setXYZ(3, farVerts[1].x, farVerts[1].y, farVerts[1].z);\r\n            frustumLinePositions.setXYZ(4, nearVerts[0].x, nearVerts[0].y, nearVerts[0].z);\r\n            frustumLinePositions.setXYZ(5, nearVerts[3].x, nearVerts[3].y, nearVerts[3].z);\r\n            frustumLinePositions.setXYZ(6, nearVerts[2].x, nearVerts[2].y, nearVerts[2].z);\r\n            frustumLinePositions.setXYZ(7, nearVerts[1].x, nearVerts[1].y, nearVerts[1].z);\r\n            frustumLinePositions.needsUpdate = true;\r\n        }\r\n    }\r\n\r\n    return threex.csm.CSMHelper = CSMHelper;\r\n});"]}