{"version":3,"sources":["utils/ShadowMapViewer.js"],"names":["define","THREE","threex","UnpackDepthRGBAShader","ShadowMapViewer","light","userAutoClearSetting","scope","this","doRenderLabel","undefined","name","frame","camera","OrthographicCamera","window","innerWidth","innerHeight","position","set","labelCanvas","labelMesh","scene","Scene","shader","uniforms","UniformsUtils","clone","material","ShaderMaterial","vertexShader","fragmentShader","plane","PlaneBufferGeometry","mesh","Mesh","add","context","document","createElement","getContext","font","labelWidth","measureText","width","height","fillStyle","fillText","labelTexture","Texture","magFilter","LinearFilter","minFilter","needsUpdate","labelMaterial","MeshBasicMaterial","map","side","DoubleSide","transparent","labelPlane","enabled","size","scale","x","y","render","renderer","tDiffuse","value","shadow","texture","autoClear","clearDepth","updateForWindowResize","left","right","top","bottom","updateProjectionMatrix","update","prototype","constructor","utils"],"mappings":"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","file":"../../utils/ShadowMapViewer.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\",\r\n    '../shaders/UnpackDepthRGBAShader'\r\n], function (\r\n    THREE,\r\n    threex,\r\n    UnpackDepthRGBAShader\r\n) {\r\n    'use strict';\r\n    var ShadowMapViewer = function (light) {\r\n        var scope = this;\r\n        var doRenderLabel = light.name !== undefined && light.name !== '';\r\n        var userAutoClearSetting;\r\n        var frame = {\r\n            x: 10,\r\n            y: 10,\r\n            width: 256,\r\n            height: 256\r\n        };\r\n        var camera = new THREE.OrthographicCamera(window.innerWidth / -2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / -2, 1, 10);\r\n        camera.position.set(0, 0, 2);\r\n        var scene = new THREE.Scene();\r\n        var shader = UnpackDepthRGBAShader;\r\n        var uniforms = THREE.UniformsUtils.clone(shader.uniforms);\r\n        var material = new THREE.ShaderMaterial({\r\n            uniforms: uniforms,\r\n            vertexShader: shader.vertexShader,\r\n            fragmentShader: shader.fragmentShader\r\n        });\r\n        var plane = new THREE.PlaneBufferGeometry(frame.width, frame.height);\r\n        var mesh = new THREE.Mesh(plane, material);\r\n        scene.add(mesh);\r\n        var labelCanvas, labelMesh;\r\n        if (doRenderLabel) {\r\n            labelCanvas = document.createElement('canvas');\r\n            var context = labelCanvas.getContext('2d');\r\n            context.font = 'Bold 20px Arial';\r\n            var labelWidth = context.measureText(light.name).width;\r\n            labelCanvas.width = labelWidth;\r\n            labelCanvas.height = 25;\r\n            context.font = 'Bold 20px Arial';\r\n            context.fillStyle = 'rgba( 255, 0, 0, 1 )';\r\n            context.fillText(light.name, 0, 20);\r\n            var labelTexture = new THREE.Texture(labelCanvas);\r\n            labelTexture.magFilter = THREE.LinearFilter;\r\n            labelTexture.minFilter = THREE.LinearFilter;\r\n            labelTexture.needsUpdate = true;\r\n            var labelMaterial = new THREE.MeshBasicMaterial({\r\n                map: labelTexture,\r\n                side: THREE.DoubleSide\r\n            });\r\n            labelMaterial.transparent = true;\r\n            var labelPlane = new THREE.PlaneBufferGeometry(labelCanvas.width, labelCanvas.height);\r\n            labelMesh = new THREE.Mesh(labelPlane, labelMaterial);\r\n            scene.add(labelMesh);\r\n        }\r\n        function resetPosition() {\r\n            scope.position.set(scope.position.x, scope.position.y);\r\n        }\r\n        this.enabled = true;\r\n        this.size = {\r\n            width: frame.width,\r\n            height: frame.height,\r\n            set: function (width, height) {\r\n                this.width = width;\r\n                this.height = height;\r\n                mesh.scale.set(this.width / frame.width, this.height / frame.height, 1);\r\n                resetPosition();\r\n            }\r\n        };\r\n        this.position = {\r\n            x: frame.x,\r\n            y: frame.y,\r\n            set: function (x, y) {\r\n                this.x = x;\r\n                this.y = y;\r\n                var width = scope.size.width;\r\n                var height = scope.size.height;\r\n                mesh.position.set(-window.innerWidth / 2 + width / 2 + this.x, window.innerHeight / 2 - height / 2 - this.y, 0);\r\n                if (doRenderLabel)\r\n                    labelMesh.position.set(mesh.position.x, mesh.position.y - scope.size.height / 2 + labelCanvas.height / 2, 0);\r\n            }\r\n        };\r\n        this.render = function (renderer) {\r\n            if (this.enabled) {\r\n                uniforms.tDiffuse.value = light.shadow.map.texture;\r\n                userAutoClearSetting = renderer.autoClear;\r\n                renderer.autoClear = false;\r\n                renderer.clearDepth();\r\n                renderer.render(scene, camera);\r\n                renderer.autoClear = userAutoClearSetting;\r\n            }\r\n        };\r\n        this.updateForWindowResize = function () {\r\n            if (this.enabled) {\r\n                camera.left = window.innerWidth / -2;\r\n                camera.right = window.innerWidth / 2;\r\n                camera.top = window.innerHeight / 2;\r\n                camera.bottom = window.innerHeight / -2;\r\n                camera.updateProjectionMatrix();\r\n                this.update();\r\n            }\r\n        };\r\n        this.update = function () {\r\n            this.position.set(this.position.x, this.position.y);\r\n            this.size.set(this.size.width, this.size.height);\r\n        };\r\n        this.update();\r\n    };\r\n    ShadowMapViewer.prototype.constructor = ShadowMapViewer;\r\n\r\n    return threex.utils.ShadowMapViewer = ShadowMapViewer;\r\n});"]}