{"version":3,"sources":["postprocessing/SSAARenderPass.js"],"names":["define","THREE","threex","Pass","CopyShader","SSAARenderPass","scene","camera","clearColor","clearAlpha","call","this","sampleLevel","unbiased","undefined","console","error","copyShader","copyUniforms","UniformsUtils","clone","uniforms","copyMaterial","ShaderMaterial","vertexShader","fragmentShader","premultipliedAlpha","transparent","blending","AdditiveBlending","depthTest","depthWrite","fsQuad","FullScreenQuad","prototype","Object","assign","create","constructor","dispose","sampleRenderTarget","setSize","width","height","render","renderer","writeBuffer","readBuffer","WebGLRenderTarget","minFilter","LinearFilter","magFilter","format","RGBAFormat","texture","name","jitterOffsets","JitterVectors","Math","max","min","autoClear","oldClearColor","getClearColor","getHex","oldClearAlpha","getClearAlpha","baseSampleWeight","length","value","i","jitterOffset","setViewOffset","sampleWeight","setClearColor","setRenderTarget","clear","renderToScreen","clearViewOffset","postprocessing"],"mappings":"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","file":"../../postprocessing/SSAARenderPass.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\",\r\n    './Pass',\r\n    '../shaders/CopyShader'\r\n], function (\r\n    THREE, \r\n    threex,\r\n    Pass, \r\n    CopyShader\r\n) {\r\n    'use strict';\r\n    var SSAARenderPass = function (scene, camera, clearColor, clearAlpha) {\r\n        Pass.call(this);\r\n        this.scene = scene;\r\n        this.camera = camera;\r\n        this.sampleLevel = 4;\r\n        this.unbiased = true;\r\n        this.clearColor = clearColor !== undefined ? clearColor : 0;\r\n        this.clearAlpha = clearAlpha !== undefined ? clearAlpha : 0;\r\n        if (CopyShader === undefined)\r\n            console.error('SSAARenderPass relies on CopyShader');\r\n        var copyShader = CopyShader;\r\n        this.copyUniforms = THREE.UniformsUtils.clone(copyShader.uniforms);\r\n        this.copyMaterial = new THREE.ShaderMaterial({\r\n            uniforms: this.copyUniforms,\r\n            vertexShader: copyShader.vertexShader,\r\n            fragmentShader: copyShader.fragmentShader,\r\n            premultipliedAlpha: true,\r\n            transparent: true,\r\n            blending: THREE.AdditiveBlending,\r\n            depthTest: false,\r\n            depthWrite: false\r\n        });\r\n        this.fsQuad = new Pass.FullScreenQuad(this.copyMaterial);\r\n    };\r\n    SSAARenderPass.prototype = Object.assign(Object.create(Pass.prototype), {\r\n        constructor: SSAARenderPass,\r\n        dispose: function () {\r\n            if (this.sampleRenderTarget) {\r\n                this.sampleRenderTarget.dispose();\r\n                this.sampleRenderTarget = null;\r\n            }\r\n        },\r\n        setSize: function (width, height) {\r\n            if (this.sampleRenderTarget)\r\n                this.sampleRenderTarget.setSize(width, height);\r\n        },\r\n        render: function (renderer, writeBuffer, readBuffer) {\r\n            if (!this.sampleRenderTarget) {\r\n                this.sampleRenderTarget = new THREE.WebGLRenderTarget(readBuffer.width, readBuffer.height, {\r\n                    minFilter: THREE.LinearFilter,\r\n                    magFilter: THREE.LinearFilter,\r\n                    format: THREE.RGBAFormat\r\n                });\r\n                this.sampleRenderTarget.texture.name = 'SSAARenderPass.sample';\r\n            }\r\n            var jitterOffsets = SSAARenderPass.JitterVectors[Math.max(0, Math.min(this.sampleLevel, 5))];\r\n            var autoClear = renderer.autoClear;\r\n            renderer.autoClear = false;\r\n            var oldClearColor = renderer.getClearColor().getHex();\r\n            var oldClearAlpha = renderer.getClearAlpha();\r\n            var baseSampleWeight = 1 / jitterOffsets.length;\r\n            var roundingRange = 1 / 32;\r\n            this.copyUniforms['tDiffuse'].value = this.sampleRenderTarget.texture;\r\n            var width = readBuffer.width, height = readBuffer.height;\r\n            for (var i = 0; i < jitterOffsets.length; i++) {\r\n                var jitterOffset = jitterOffsets[i];\r\n                if (this.camera.setViewOffset) {\r\n                    this.camera.setViewOffset(width, height, jitterOffset[0] * 0.0625, jitterOffset[1] * 0.0625, width, height);\r\n                }\r\n                var sampleWeight = baseSampleWeight;\r\n                if (this.unbiased) {\r\n                    var uniformCenteredDistribution = -0.5 + (i + 0.5) / jitterOffsets.length;\r\n                    sampleWeight += roundingRange * uniformCenteredDistribution;\r\n                }\r\n                this.copyUniforms['opacity'].value = sampleWeight;\r\n                renderer.setClearColor(this.clearColor, this.clearAlpha);\r\n                renderer.setRenderTarget(this.sampleRenderTarget);\r\n                renderer.clear();\r\n                renderer.render(this.scene, this.camera);\r\n                renderer.setRenderTarget(this.renderToScreen ? null : writeBuffer);\r\n                if (i === 0) {\r\n                    renderer.setClearColor(0, 0);\r\n                    renderer.clear();\r\n                }\r\n                this.fsQuad.render(renderer);\r\n            }\r\n            if (this.camera.clearViewOffset)\r\n                this.camera.clearViewOffset();\r\n            renderer.autoClear = autoClear;\r\n            renderer.setClearColor(oldClearColor, oldClearAlpha);\r\n        }\r\n    });\r\n    SSAARenderPass.JitterVectors = [\r\n        [[\r\n                0,\r\n                0\r\n            ]],\r\n        [\r\n            [\r\n                4,\r\n                4\r\n            ],\r\n            [\r\n                -4,\r\n                -4\r\n            ]\r\n        ],\r\n        [\r\n            [\r\n                -2,\r\n                -6\r\n            ],\r\n            [\r\n                6,\r\n                -2\r\n            ],\r\n            [\r\n                -6,\r\n                2\r\n            ],\r\n            [\r\n                2,\r\n                6\r\n            ]\r\n        ],\r\n        [\r\n            [\r\n                1,\r\n                -3\r\n            ],\r\n            [\r\n                -1,\r\n                3\r\n            ],\r\n            [\r\n                5,\r\n                1\r\n            ],\r\n            [\r\n                -3,\r\n                -5\r\n            ],\r\n            [\r\n                -5,\r\n                5\r\n            ],\r\n            [\r\n                -7,\r\n                -1\r\n            ],\r\n            [\r\n                3,\r\n                7\r\n            ],\r\n            [\r\n                7,\r\n                -7\r\n            ]\r\n        ],\r\n        [\r\n            [\r\n                1,\r\n                1\r\n            ],\r\n            [\r\n                -1,\r\n                -3\r\n            ],\r\n            [\r\n                -3,\r\n                2\r\n            ],\r\n            [\r\n                4,\r\n                -1\r\n            ],\r\n            [\r\n                -5,\r\n                -2\r\n            ],\r\n            [\r\n                2,\r\n                5\r\n            ],\r\n            [\r\n                5,\r\n                3\r\n            ],\r\n            [\r\n                3,\r\n                -5\r\n            ],\r\n            [\r\n                -2,\r\n                6\r\n            ],\r\n            [\r\n                0,\r\n                -7\r\n            ],\r\n            [\r\n                -4,\r\n                -6\r\n            ],\r\n            [\r\n                -6,\r\n                4\r\n            ],\r\n            [\r\n                -8,\r\n                0\r\n            ],\r\n            [\r\n                7,\r\n                -4\r\n            ],\r\n            [\r\n                6,\r\n                7\r\n            ],\r\n            [\r\n                -7,\r\n                -8\r\n            ]\r\n        ],\r\n        [\r\n            [\r\n                -4,\r\n                -7\r\n            ],\r\n            [\r\n                -7,\r\n                -5\r\n            ],\r\n            [\r\n                -3,\r\n                -5\r\n            ],\r\n            [\r\n                -5,\r\n                -4\r\n            ],\r\n            [\r\n                -1,\r\n                -4\r\n            ],\r\n            [\r\n                -2,\r\n                -2\r\n            ],\r\n            [\r\n                -6,\r\n                -1\r\n            ],\r\n            [\r\n                -4,\r\n                0\r\n            ],\r\n            [\r\n                -7,\r\n                1\r\n            ],\r\n            [\r\n                -1,\r\n                2\r\n            ],\r\n            [\r\n                -6,\r\n                3\r\n            ],\r\n            [\r\n                -3,\r\n                3\r\n            ],\r\n            [\r\n                -7,\r\n                6\r\n            ],\r\n            [\r\n                -3,\r\n                6\r\n            ],\r\n            [\r\n                -5,\r\n                7\r\n            ],\r\n            [\r\n                -1,\r\n                7\r\n            ],\r\n            [\r\n                5,\r\n                -7\r\n            ],\r\n            [\r\n                1,\r\n                -6\r\n            ],\r\n            [\r\n                6,\r\n                -5\r\n            ],\r\n            [\r\n                4,\r\n                -4\r\n            ],\r\n            [\r\n                2,\r\n                -3\r\n            ],\r\n            [\r\n                7,\r\n                -2\r\n            ],\r\n            [\r\n                1,\r\n                -1\r\n            ],\r\n            [\r\n                4,\r\n                -1\r\n            ],\r\n            [\r\n                2,\r\n                1\r\n            ],\r\n            [\r\n                6,\r\n                2\r\n            ],\r\n            [\r\n                0,\r\n                4\r\n            ],\r\n            [\r\n                4,\r\n                4\r\n            ],\r\n            [\r\n                2,\r\n                5\r\n            ],\r\n            [\r\n                7,\r\n                5\r\n            ],\r\n            [\r\n                5,\r\n                6\r\n            ],\r\n            [\r\n                3,\r\n                7\r\n            ]\r\n        ]\r\n    ];\r\n    return threex.postprocessing.SSAARenderPass = SSAARenderPass;\r\n});"]}