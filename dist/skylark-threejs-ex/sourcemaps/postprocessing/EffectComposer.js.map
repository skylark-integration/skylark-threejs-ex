{"version":3,"sources":["postprocessing/EffectComposer.js"],"names":["define","THREE","threex","CopyShader","ShaderPass","MaskPass","EffectComposer","renderer","renderTarget","this","undefined","parameters","minFilter","LinearFilter","magFilter","format","RGBAFormat","stencilBuffer","size","getSize","Vector2","_pixelRatio","getPixelRatio","_width","width","_height","height","WebGLRenderTarget","texture","name","renderTarget1","renderTarget2","clone","writeBuffer","readBuffer","renderToScreen","passes","console","error","copyPass","clock","Clock","Object","assign","prototype","swapBuffers","tmp","addPass","pass","push","setSize","insertPass","index","splice","isLastEnabledPass","passIndex","i","length","enabled","render","deltaTime","getDelta","currentRenderTarget","getRenderTarget","maskActive","il","needsSwap","context","getContext","stencil","state","buffers","setFunc","NOTEQUAL","EQUAL","ClearMaskPass","setRenderTarget","reset","dispose","effectiveWidth","effectiveHeight","setPixelRatio","pixelRatio","postprocessing"],"mappings":"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","file":"../../postprocessing/EffectComposer.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\",\r\n    '../shaders/CopyShader',\r\n    '../postprocessing/ShaderPass',\r\n    '../postprocessing/MaskPass'\r\n], function (\r\n    THREE, \r\n    threex,\r\n    CopyShader, \r\n    ShaderPass, \r\n    MaskPass\r\n) {\r\n    'use strict';\r\n    var EffectComposer = function (renderer, renderTarget) {\r\n        this.renderer = renderer;\r\n        if (renderTarget === undefined) {\r\n            var parameters = {\r\n                minFilter: THREE.LinearFilter,\r\n                magFilter: THREE.LinearFilter,\r\n                format: THREE.RGBAFormat,\r\n                stencilBuffer: false\r\n            };\r\n            var size = renderer.getSize(new THREE.Vector2());\r\n            this._pixelRatio = renderer.getPixelRatio();\r\n            this._width = size.width;\r\n            this._height = size.height;\r\n            renderTarget = new THREE.WebGLRenderTarget(this._width * this._pixelRatio, this._height * this._pixelRatio, parameters);\r\n            renderTarget.texture.name = 'EffectComposer.rt1';\r\n        } else {\r\n            this._pixelRatio = 1;\r\n            this._width = renderTarget.width;\r\n            this._height = renderTarget.height;\r\n        }\r\n        this.renderTarget1 = renderTarget;\r\n        this.renderTarget2 = renderTarget.clone();\r\n        this.renderTarget2.texture.name = 'EffectComposer.rt2';\r\n        this.writeBuffer = this.renderTarget1;\r\n        this.readBuffer = this.renderTarget2;\r\n        this.renderToScreen = true;\r\n        this.passes = [];\r\n        if (CopyShader === undefined) {\r\n            console.error('THREE.EffectComposer relies on CopyShader');\r\n        }\r\n        if (ShaderPass === undefined) {\r\n            console.error('THREE.EffectComposer relies on ShaderPass');\r\n        }\r\n        this.copyPass = new ShaderPass(CopyShader);\r\n        this.clock = new THREE.Clock();\r\n    };\r\n    Object.assign(EffectComposer.prototype, {\r\n        swapBuffers: function () {\r\n            var tmp = this.readBuffer;\r\n            this.readBuffer = this.writeBuffer;\r\n            this.writeBuffer = tmp;\r\n        },\r\n        addPass: function (pass) {\r\n            this.passes.push(pass);\r\n            pass.setSize(this._width * this._pixelRatio, this._height * this._pixelRatio);\r\n        },\r\n        insertPass: function (pass, index) {\r\n            this.passes.splice(index, 0, pass);\r\n        },\r\n        isLastEnabledPass: function (passIndex) {\r\n            for (var i = passIndex + 1; i < this.passes.length; i++) {\r\n                if (this.passes[i].enabled) {\r\n                    return false;\r\n                }\r\n            }\r\n            return true;\r\n        },\r\n        render: function (deltaTime) {\r\n            if (deltaTime === undefined) {\r\n                deltaTime = this.clock.getDelta();\r\n            }\r\n            var currentRenderTarget = this.renderer.getRenderTarget();\r\n            var maskActive = false;\r\n            var pass, i, il = this.passes.length;\r\n            for (i = 0; i < il; i++) {\r\n                pass = this.passes[i];\r\n                if (pass.enabled === false)\r\n                    continue;\r\n                pass.renderToScreen = this.renderToScreen && this.isLastEnabledPass(i);\r\n                pass.render(this.renderer, this.writeBuffer, this.readBuffer, deltaTime, maskActive);\r\n                if (pass.needsSwap) {\r\n                    if (maskActive) {\r\n                        var context = this.renderer.getContext();\r\n                        var stencil = this.renderer.state.buffers.stencil;\r\n                        stencil.setFunc(context.NOTEQUAL, 1, 4294967295);\r\n                        this.copyPass.render(this.renderer, this.writeBuffer, this.readBuffer, deltaTime);\r\n                        stencil.setFunc(context.EQUAL, 1, 4294967295);\r\n                    }\r\n                    this.swapBuffers();\r\n                }\r\n                if (MaskPass !== undefined) {\r\n                    if (pass instanceof MaskPass) {\r\n                        maskActive = true;\r\n                    } else if (pass instanceof ClearMaskPass) {\r\n                        maskActive = false;\r\n                    }\r\n                }\r\n            }\r\n            this.renderer.setRenderTarget(currentRenderTarget);\r\n        },\r\n        reset: function (renderTarget) {\r\n            if (renderTarget === undefined) {\r\n                var size = this.renderer.getSize(new THREE.Vector2());\r\n                this._pixelRatio = this.renderer.getPixelRatio();\r\n                this._width = size.width;\r\n                this._height = size.height;\r\n                renderTarget = this.renderTarget1.clone();\r\n                renderTarget.setSize(this._width * this._pixelRatio, this._height * this._pixelRatio);\r\n            }\r\n            this.renderTarget1.dispose();\r\n            this.renderTarget2.dispose();\r\n            this.renderTarget1 = renderTarget;\r\n            this.renderTarget2 = renderTarget.clone();\r\n            this.writeBuffer = this.renderTarget1;\r\n            this.readBuffer = this.renderTarget2;\r\n        },\r\n        setSize: function (width, height) {\r\n            this._width = width;\r\n            this._height = height;\r\n            var effectiveWidth = this._width * this._pixelRatio;\r\n            var effectiveHeight = this._height * this._pixelRatio;\r\n            this.renderTarget1.setSize(effectiveWidth, effectiveHeight);\r\n            this.renderTarget2.setSize(effectiveWidth, effectiveHeight);\r\n            for (var i = 0; i < this.passes.length; i++) {\r\n                this.passes[i].setSize(effectiveWidth, effectiveHeight);\r\n            }\r\n        },\r\n        setPixelRatio: function (pixelRatio) {\r\n            this._pixelRatio = pixelRatio;\r\n            this.setSize(this._width, this._height);\r\n        }\r\n    });\r\n\r\n    return  threex.postprocessing.EffectComposer = EffectComposer;\r\n});"]}