{"version":3,"sources":["lines/LineSegments2.js"],"names":["define","THREE","threex","LineSegmentsGeometry","LineMaterial","start","end","LineSegments2","geometry","material","Mesh","call","this","type","undefined","color","Math","random","prototype","Object","assign","create","constructor","isLineSegments2","computeLineDistances","Vector3","instanceStart","attributes","instanceEnd","lineDistances","Float32Array","data","count","i","j","l","fromBufferAttribute","distanceTo","instanceDistanceBuffer","InstancedInterleavedBuffer","setAttribute","InterleavedBufferAttribute","raycast","Vector4","ssOrigin","ssOrigin3","mvMatrix","Matrix4","line","Line3","closestPoint","raycaster","intersects","camera","console","error","ray","projectionMatrix","resolution","lineWidth","linewidth","at","w","applyMatrix4","matrixWorldInverse","multiplyScalar","x","y","z","copy","matrixWorld","multiplyMatrices","isBehindCameraNear","isPastCameraFar","param","closestPointToPointParameter","zPos","MathUtils","lerp","isInClipSpace","isInside","pointOnLine","point","distanceSqToSegment","push","distance","origin","object","face","faceIndex","uv","uv2","lines"],"mappings":"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","file":"../../lines/LineSegments2.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\",\r\n    './LineSegmentsGeometry',\r\n    './LineMaterial'\r\n], function (\r\n    THREE,\r\n    threex,\r\n    LineSegmentsGeometry, \r\n    LineMaterial\r\n) {\r\n    'use strict';\r\n    var LineSegments2 = function (geometry, material) {\r\n        THREE.Mesh.call(this);\r\n        this.type = 'LineSegments2';\r\n        this.geometry = geometry !== undefined ? geometry : new LineSegmentsGeometry();\r\n        this.material = material !== undefined ? material : new LineMaterial({ color: Math.random() * 16777215 });\r\n    };\r\n    LineSegments2.prototype = Object.assign(Object.create(THREE.Mesh.prototype), {\r\n        constructor: LineSegments2,\r\n        isLineSegments2: true,\r\n        computeLineDistances: function () {\r\n            var start = new THREE.Vector3();\r\n            var end = new THREE.Vector3();\r\n            return function computeLineDistances() {\r\n                var geometry = this.geometry;\r\n                var instanceStart = geometry.attributes.instanceStart;\r\n                var instanceEnd = geometry.attributes.instanceEnd;\r\n                var lineDistances = new Float32Array(2 * instanceStart.data.count);\r\n                for (var i = 0, j = 0, l = instanceStart.data.count; i < l; i++, j += 2) {\r\n                    start.fromBufferAttribute(instanceStart, i);\r\n                    end.fromBufferAttribute(instanceEnd, i);\r\n                    lineDistances[j] = j === 0 ? 0 : lineDistances[j - 1];\r\n                    lineDistances[j + 1] = lineDistances[j] + start.distanceTo(end);\r\n                }\r\n                var instanceDistanceBuffer = new THREE.InstancedInterleavedBuffer(lineDistances, 2, 1);\r\n                geometry.setAttribute('instanceDistanceStart', new THREE.InterleavedBufferAttribute(instanceDistanceBuffer, 1, 0));\r\n                geometry.setAttribute('instanceDistanceEnd', new THREE.InterleavedBufferAttribute(instanceDistanceBuffer, 1, 1));\r\n                return this;\r\n            };\r\n        }(),\r\n        raycast: function () {\r\n            var start = new THREE.Vector4();\r\n            var end = new THREE.Vector4();\r\n            var ssOrigin = new THREE.Vector4();\r\n            var ssOrigin3 = new THREE.Vector3();\r\n            var mvMatrix = new THREE.Matrix4();\r\n            var line = new THREE.Line3();\r\n            var closestPoint = new THREE.Vector3();\r\n            return function raycast(raycaster, intersects) {\r\n                if (raycaster.camera === null) {\r\n                    console.error('LineSegments2: \"Raycaster.camera\" needs to be set in order to raycast against LineSegments2.');\r\n                }\r\n                var ray = raycaster.ray;\r\n                var camera = raycaster.camera;\r\n                var projectionMatrix = camera.projectionMatrix;\r\n                var geometry = this.geometry;\r\n                var material = this.material;\r\n                var resolution = material.resolution;\r\n                var lineWidth = material.linewidth;\r\n                var instanceStart = geometry.attributes.instanceStart;\r\n                var instanceEnd = geometry.attributes.instanceEnd;\r\n                ray.at(1, ssOrigin);\r\n                ssOrigin.w = 1;\r\n                ssOrigin.applyMatrix4(camera.matrixWorldInverse);\r\n                ssOrigin.applyMatrix4(projectionMatrix);\r\n                ssOrigin.multiplyScalar(1 / ssOrigin.w);\r\n                ssOrigin.x *= resolution.x / 2;\r\n                ssOrigin.y *= resolution.y / 2;\r\n                ssOrigin.z = 0;\r\n                ssOrigin3.copy(ssOrigin);\r\n                var matrixWorld = this.matrixWorld;\r\n                mvMatrix.multiplyMatrices(camera.matrixWorldInverse, matrixWorld);\r\n                for (var i = 0, l = instanceStart.count; i < l; i++) {\r\n                    start.fromBufferAttribute(instanceStart, i);\r\n                    end.fromBufferAttribute(instanceEnd, i);\r\n                    start.w = 1;\r\n                    end.w = 1;\r\n                    start.applyMatrix4(mvMatrix);\r\n                    end.applyMatrix4(mvMatrix);\r\n                    start.applyMatrix4(projectionMatrix);\r\n                    end.applyMatrix4(projectionMatrix);\r\n                    start.multiplyScalar(1 / start.w);\r\n                    end.multiplyScalar(1 / end.w);\r\n                    var isBehindCameraNear = start.z < -1 && end.z < -1;\r\n                    var isPastCameraFar = start.z > 1 && end.z > 1;\r\n                    if (isBehindCameraNear || isPastCameraFar) {\r\n                        continue;\r\n                    }\r\n                    start.x *= resolution.x / 2;\r\n                    start.y *= resolution.y / 2;\r\n                    end.x *= resolution.x / 2;\r\n                    end.y *= resolution.y / 2;\r\n                    line.start.copy(start);\r\n                    line.start.z = 0;\r\n                    line.end.copy(end);\r\n                    line.end.z = 0;\r\n                    var param = line.closestPointToPointParameter(ssOrigin3, true);\r\n                    line.at(param, closestPoint);\r\n                    var zPos = THREE.MathUtils.lerp(start.z, end.z, param);\r\n                    var isInClipSpace = zPos >= -1 && zPos <= 1;\r\n                    var isInside = ssOrigin3.distanceTo(closestPoint) < lineWidth * 0.5;\r\n                    if (isInClipSpace && isInside) {\r\n                        line.start.fromBufferAttribute(instanceStart, i);\r\n                        line.end.fromBufferAttribute(instanceEnd, i);\r\n                        line.start.applyMatrix4(matrixWorld);\r\n                        line.end.applyMatrix4(matrixWorld);\r\n                        var pointOnLine = new THREE.Vector3();\r\n                        var point = new THREE.Vector3();\r\n                        ray.distanceSqToSegment(line.start, line.end, point, pointOnLine);\r\n                        intersects.push({\r\n                            point: point,\r\n                            pointOnLine: pointOnLine,\r\n                            distance: ray.origin.distanceTo(point),\r\n                            object: this,\r\n                            face: null,\r\n                            faceIndex: i,\r\n                            uv: null,\r\n                            uv2: null\r\n                        });\r\n                    }\r\n                }\r\n            };\r\n        }()\r\n    });\r\n\r\n    return threex.lines.LineSegments2 = LineSegments2;\r\n});"]}