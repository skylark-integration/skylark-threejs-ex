{"version":3,"sources":["exporters/STLExporter.js"],"names":["define","THREE","threex","vector","normalMatrixWorld","STLExporter","prototype","constructor","parse","Vector3","Matrix3","scene","options","undefined","binary","objects","triangles","traverse","object","isMesh","geometry","isBufferGeometry","Geometry","fromBufferGeometry","isGeometry","faces","length","push","matrixWorld","offset","arrayBuffer","ArrayBuffer","output","DataView","setUint32","i","il","vertices","getNormalMatrix","j","jl","face","copy","normal","applyMatrix3","normalize","setFloat32","x","y","z","indices","a","b","c","k","applyMatrix4","setUint16","exporters"],"mappings":"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","file":"../../exporters/STLExporter.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var STLExporter = function () {\r\n    };\r\n    STLExporter.prototype = {\r\n        constructor: STLExporter,\r\n        parse: function () {\r\n            var vector = new THREE.Vector3();\r\n            var normalMatrixWorld = new THREE.Matrix3();\r\n            return function parse(scene, options) {\r\n                if (options === undefined)\r\n                    options = {};\r\n                var binary = options.binary !== undefined ? options.binary : false;\r\n                var objects = [];\r\n                var triangles = 0;\r\n                scene.traverse(function (object) {\r\n                    if (object.isMesh) {\r\n                        var geometry = object.geometry;\r\n                        if (geometry.isBufferGeometry) {\r\n                            geometry = new THREE.Geometry().fromBufferGeometry(geometry);\r\n                        }\r\n                        if (geometry.isGeometry) {\r\n                            triangles += geometry.faces.length;\r\n                            objects.push({\r\n                                geometry: geometry,\r\n                                matrixWorld: object.matrixWorld\r\n                            });\r\n                        }\r\n                    }\r\n                });\r\n                if (binary) {\r\n                    var offset = 80;\r\n                    var bufferLength = triangles * 2 + triangles * 3 * 4 * 4 + 80 + 4;\r\n                    var arrayBuffer = new ArrayBuffer(bufferLength);\r\n                    var output = new DataView(arrayBuffer);\r\n                    output.setUint32(offset, triangles, true);\r\n                    offset += 4;\r\n                    for (var i = 0, il = objects.length; i < il; i++) {\r\n                        var object = objects[i];\r\n                        var vertices = object.geometry.vertices;\r\n                        var faces = object.geometry.faces;\r\n                        var matrixWorld = object.matrixWorld;\r\n                        normalMatrixWorld.getNormalMatrix(matrixWorld);\r\n                        for (var j = 0, jl = faces.length; j < jl; j++) {\r\n                            var face = faces[j];\r\n                            vector.copy(face.normal).applyMatrix3(normalMatrixWorld).normalize();\r\n                            output.setFloat32(offset, vector.x, true);\r\n                            offset += 4;\r\n                            output.setFloat32(offset, vector.y, true);\r\n                            offset += 4;\r\n                            output.setFloat32(offset, vector.z, true);\r\n                            offset += 4;\r\n                            var indices = [\r\n                                face.a,\r\n                                face.b,\r\n                                face.c\r\n                            ];\r\n                            for (var k = 0; k < 3; k++) {\r\n                                vector.copy(vertices[indices[k]]).applyMatrix4(matrixWorld);\r\n                                output.setFloat32(offset, vector.x, true);\r\n                                offset += 4;\r\n                                output.setFloat32(offset, vector.y, true);\r\n                                offset += 4;\r\n                                output.setFloat32(offset, vector.z, true);\r\n                                offset += 4;\r\n                            }\r\n                            output.setUint16(offset, 0, true);\r\n                            offset += 2;\r\n                        }\r\n                    }\r\n                    return output;\r\n                } else {\r\n                    var output = '';\r\n                    output += 'solid exported\\n';\r\n                    for (var i = 0, il = objects.length; i < il; i++) {\r\n                        var object = objects[i];\r\n                        var vertices = object.geometry.vertices;\r\n                        var faces = object.geometry.faces;\r\n                        var matrixWorld = object.matrixWorld;\r\n                        normalMatrixWorld.getNormalMatrix(matrixWorld);\r\n                        for (var j = 0, jl = faces.length; j < jl; j++) {\r\n                            var face = faces[j];\r\n                            vector.copy(face.normal).applyMatrix3(normalMatrixWorld).normalize();\r\n                            output += '\\tfacet normal ' + vector.x + ' ' + vector.y + ' ' + vector.z + '\\n';\r\n                            output += '\\t\\touter loop\\n';\r\n                            var indices = [\r\n                                face.a,\r\n                                face.b,\r\n                                face.c\r\n                            ];\r\n                            for (var k = 0; k < 3; k++) {\r\n                                vector.copy(vertices[indices[k]]).applyMatrix4(matrixWorld);\r\n                                output += '\\t\\t\\tvertex ' + vector.x + ' ' + vector.y + ' ' + vector.z + '\\n';\r\n                            }\r\n                            output += '\\t\\tendloop\\n';\r\n                            output += '\\tendfacet\\n';\r\n                        }\r\n                    }\r\n                    output += 'endsolid exported\\n';\r\n                    return output;\r\n                }\r\n            };\r\n        }()\r\n    };\r\n    return threex.exporters.STLExporter = STLExporter;\r\n});"]}