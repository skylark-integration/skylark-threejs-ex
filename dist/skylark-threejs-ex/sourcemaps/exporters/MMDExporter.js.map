{"version":3,"sources":["exporters/MMDExporter.js"],"names":["define","THREE","threex","MMDParser","exporters","MMDExporter","u2sTable","this","parseVpd","skin","outputShiftJis","useOriginalBones","isSkinnedMesh","console","warn","toStringsFromNumber","num","Math","abs","a","toString","indexOf","index","slice","toStringsFromArray","array","i","il","length","push","join","updateMatrixWorld","bones","skeleton","bones2","poseSkin","clone","pose","getBindBones","position","Vector3","quaternion","Quaternion","quaternion2","matrix","Matrix4","name","replace","bone","bone2","undefined","userData","ik","originalMatrix","fromArray","copy","setFromMatrixPosition","setFromRotationMatrix","pArray","sub","toArray","qArray","conjugate","multiply","lines","str","table","CharsetEncoder","s2uTable","keys","Object","key","value","parseInt","code","charCodeAt","Uint8Array","unicodeToShiftjis"],"mappings":"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","file":"../../exporters/MMDExporter.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\",\r\n    '../utils/mmdparser'\r\n], function (\r\n    THREE,\r\n    threex, \r\n    MMDParser\r\n) {\r\n    'use strict';\r\n    var MMDExporter = function () {\r\n        var u2sTable;\r\n        function unicodeToShiftjis(str) {\r\n            if (u2sTable === undefined) {\r\n                var encoder = new MMDParser.CharsetEncoder();\r\n                var table = encoder.s2uTable;\r\n                u2sTable = {};\r\n                var keys = Object.keys(table);\r\n                for (var i = 0, il = keys.length; i < il; i++) {\r\n                    var key = keys[i];\r\n                    var value = table[key];\r\n                    key = parseInt(key);\r\n                    u2sTable[value] = key;\r\n                }\r\n            }\r\n            var array = [];\r\n            for (var i = 0, il = str.length; i < il; i++) {\r\n                var code = str.charCodeAt(i);\r\n                var value = u2sTable[code];\r\n                if (value === undefined) {\r\n                    throw 'cannot convert charcode 0x' + code.toString(16);\r\n                } else if (value > 255) {\r\n                    array.push(value >> 8 & 255);\r\n                    array.push(value & 255);\r\n                } else {\r\n                    array.push(value & 255);\r\n                }\r\n            }\r\n            return new Uint8Array(array);\r\n        }\r\n        function getBindBones(skin) {\r\n            var poseSkin = skin.clone();\r\n            poseSkin.pose();\r\n            return poseSkin.skeleton.bones;\r\n        }\r\n        this.parseVpd = function (skin, outputShiftJis, useOriginalBones) {\r\n            if (skin.isSkinnedMesh !== true) {\r\n                console.warn('THREE.MMDExporter: parseVpd() requires SkinnedMesh instance.');\r\n                return null;\r\n            }\r\n            function toStringsFromNumber(num) {\r\n                if (Math.abs(num) < 0.000001)\r\n                    num = 0;\r\n                var a = num.toString();\r\n                if (a.indexOf('.') === -1) {\r\n                    a += '.';\r\n                }\r\n                a += '000000';\r\n                var index = a.indexOf('.');\r\n                var d = a.slice(0, index);\r\n                var p = a.slice(index + 1, index + 7);\r\n                return d + '.' + p;\r\n            }\r\n            function toStringsFromArray(array) {\r\n                var a = [];\r\n                for (var i = 0, il = array.length; i < il; i++) {\r\n                    a.push(toStringsFromNumber(array[i]));\r\n                }\r\n                return a.join(',');\r\n            }\r\n            skin.updateMatrixWorld(true);\r\n            var bones = skin.skeleton.bones;\r\n            var bones2 = getBindBones(skin);\r\n            var position = new THREE.Vector3();\r\n            var quaternion = new THREE.Quaternion();\r\n            var quaternion2 = new THREE.Quaternion();\r\n            var matrix = new THREE.Matrix4();\r\n            var array = [];\r\n            array.push('Vocaloid Pose Data file');\r\n            array.push('');\r\n            array.push((skin.name !== '' ? skin.name.replace(/\\s/g, '_') : 'skin') + '.osm;');\r\n            array.push(bones.length + ';');\r\n            array.push('');\r\n            for (var i = 0, il = bones.length; i < il; i++) {\r\n                var bone = bones[i];\r\n                var bone2 = bones2[i];\r\n                if (useOriginalBones === true && bone.userData.ik !== undefined && bone.userData.ik.originalMatrix !== undefined) {\r\n                    matrix.fromArray(bone.userData.ik.originalMatrix);\r\n                } else {\r\n                    matrix.copy(bone.matrix);\r\n                }\r\n                position.setFromMatrixPosition(matrix);\r\n                quaternion.setFromRotationMatrix(matrix);\r\n                var pArray = position.sub(bone2.position).toArray();\r\n                var qArray = quaternion2.copy(bone2.quaternion).conjugate().multiply(quaternion).toArray();\r\n                pArray[2] = -pArray[2];\r\n                qArray[0] = -qArray[0];\r\n                qArray[1] = -qArray[1];\r\n                array.push('Bone' + i + '{' + bone.name);\r\n                array.push('  ' + toStringsFromArray(pArray) + ';');\r\n                array.push('  ' + toStringsFromArray(qArray) + ';');\r\n                array.push('}');\r\n                array.push('');\r\n            }\r\n            array.push('');\r\n            var lines = array.join('\\n');\r\n            return outputShiftJis === true ? unicodeToShiftjis(lines) : lines;\r\n        };\r\n    };\r\n\r\n    return threex.exporters.MMDExporter = MMDExporter;\r\n});"]}