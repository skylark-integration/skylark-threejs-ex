{"version":3,"sources":["physics/CannonPhysics.js"],"names":["define","THREE","threex","compose","position","quaternion","array","index","x","y","z","w","x2","y2","z2","xx","xy","xz","yy","yz","zz","wx","wy","wz","physics","CannonPhysics","frameRate","frameTime","world","CANNON","World","gravity","set","broadphase","SAPBroadphase","meshes","meshMap","WeakMap","lastTime","setInterval","time","performance","now","delta","step","i","l","length","mesh","isInstancedMesh","instanceMatrix","bodies","get","j","body","needsUpdate","isMesh","copy","addMesh","mass","shape","geometry","parameters","type","halfExtents","Vec3","undefined","width","height","depth","Box","Plane","radius","Sphere","getShape","count","Body","addBody","push","setUsage","handleInstancedMesh","Quaternion","handleMesh","setMeshPosition"],"mappings":";;;;;;;AAAAA,QACI,kBACA,aACD,SACCC,EACAC,GAEA,aACA,SAASC,EAAQC,EAAUC,EAAYC,EAAOC,GAC1C,IAAIC,EAAIH,EAAWG,EAAGC,EAAIJ,EAAWI,EAAGC,EAAIL,EAAWK,EAAGC,EAAIN,EAAWM,EACrEC,EAAKJ,EAAIA,EAAGK,EAAKJ,EAAIA,EAAGK,EAAKJ,EAAIA,EACjCK,EAAKP,EAAII,EAAII,EAAKR,EAAIK,EAAII,EAAKT,EAAIM,EACnCI,EAAKT,EAAII,EAAIM,EAAKV,EAAIK,EAAIM,EAAKV,EAAII,EACnCO,EAAKV,EAAIC,EAAIU,EAAKX,EAAIE,EAAIU,EAAKZ,EAAIG,EACvCR,EAAMC,EAAQ,GAAK,GAAKW,EAAKE,GAC7Bd,EAAMC,EAAQ,GAAKS,EAAKO,EACxBjB,EAAMC,EAAQ,GAAKU,EAAKK,EACxBhB,EAAMC,EAAQ,GAAK,EACnBD,EAAMC,EAAQ,GAAKS,EAAKO,EACxBjB,EAAMC,EAAQ,GAAK,GAAKQ,EAAKK,GAC7Bd,EAAMC,EAAQ,GAAKY,EAAKE,EACxBf,EAAMC,EAAQ,GAAK,EACnBD,EAAMC,EAAQ,GAAKU,EAAKK,EACxBhB,EAAMC,EAAQ,GAAKY,EAAKE,EACxBf,EAAMC,EAAQ,IAAM,GAAKQ,EAAKG,GAC9BZ,EAAMC,EAAQ,IAAM,EACpBD,EAAMC,EAAQ,IAAMH,EAASI,EAC7BF,EAAMC,EAAQ,IAAMH,EAASK,EAC7BH,EAAMC,EAAQ,IAAMH,EAASM,EAC7BJ,EAAMC,EAAQ,IAAM,EAmHxB,OAAOL,EAAOsB,QAAQC,cAjHtB,WACI,IAAIC,EAAY,GACZC,EAAY,EAAID,EAChBE,EAAQ,IAAIC,OAAOC,MACvBF,EAAMG,QAAQC,IAAI,GAAI,IAAK,GAC3BJ,EAAMK,WAAa,IAAIJ,OAAOK,cAAcN,GAkB5C,IAAIO,KACAC,EAAU,IAAIC,QA0DdC,EAAW,EA0Bf,OADAC,YAxBA,WACI,IAAIC,EAAOC,YAAYC,MACvB,GAAIJ,EAAW,EAAG,CACd,IAAIK,GAASH,EAAOF,GAAY,IAChCV,EAAMgB,KAAKjB,EAAWgB,EAAOjB,GAEjCY,EAAWE,EACX,IAAK,IAAIK,EAAI,EAAGC,EAAIX,EAAOY,OAAQF,EAAIC,EAAGD,IAAK,CAC3C,IAAIG,EAAOb,EAAOU,GAClB,GAAIG,EAAKC,gBAAiB,CAGtB,IAFA,IAAI3C,EAAQ0C,EAAKE,eAAe5C,MAC5B6C,EAASf,EAAQgB,IAAIJ,GAChBK,EAAI,EAAGA,EAAIF,EAAOJ,OAAQM,IAE/BlD,GADImD,EAAOH,EAAOE,IACLjD,SAAUkD,EAAKjD,WAAYC,EAAW,GAAJ+C,GAEnDL,EAAKE,eAAeK,aAAc,OAC/B,GAAIP,EAAKQ,OAAQ,CACpB,IAAIF,EAAOlB,EAAQgB,IAAIJ,GACvBA,EAAK5C,SAASqD,KAAKH,EAAKlD,UACxB4C,EAAK3C,WAAWoD,KAAKH,EAAKjD,eAIpB,IAAOqB,IAErBgC,QApFJ,SAAiBV,EAAMW,EAAO,GAC1B,IAAIC,EApBR,SAAkBC,GACd,IAAIC,EAAaD,EAASC,WAC1B,OAAQD,EAASE,MACjB,IAAK,oBACD,IAAIC,EAAc,IAAInC,OAAOoC,KAI7B,OAHAD,EAAYxD,OAAyB0D,IAArBJ,EAAWK,MAAsBL,EAAWK,MAAQ,EAAI,GACxEH,EAAYvD,OAA0ByD,IAAtBJ,EAAWM,OAAuBN,EAAWM,OAAS,EAAI,GAC1EJ,EAAYtD,OAAyBwD,IAArBJ,EAAWO,MAAsBP,EAAWO,MAAQ,EAAI,GACjE,IAAIxC,OAAOyC,IAAIN,GAC1B,IAAK,sBACD,OAAO,IAAInC,OAAO0C,MACtB,IAAK,uBACD,IAAIC,EAASV,EAAWU,OACxB,OAAO,IAAI3C,OAAO4C,OAAOD,GAE7B,OAAO,KAKKE,CAAS1B,EAAKa,UACZ,OAAVD,IACIZ,EAAKC,gBAwBjB,SAA6BD,EAAMW,EAAMC,GAGrC,IAFA,IAAItD,EAAQ0C,EAAKE,eAAe5C,MAC5B6C,KACKN,EAAI,EAAGA,EAAIG,EAAK2B,MAAO9B,IAAK,CACjC,IAAItC,EAAY,GAAJsC,EACRzC,EAAW,IAAIyB,OAAOoC,KAC1B7D,EAAS4B,IAAI1B,EAAMC,EAAQ,IAAKD,EAAMC,EAAQ,IAAKD,EAAMC,EAAQ,KACjE,IAAI+C,EAAO,IAAIzB,OAAO+C,MAClBxE,SAAUA,EACVuD,KAAMA,EACNC,MAAOA,IAEXhC,EAAMiD,QAAQvB,GACdH,EAAO2B,KAAKxB,GAEZK,EAAO,IACPX,EAAKE,eAAe6B,SAAS,OAC7B5C,EAAO2C,KAAK9B,GACZZ,EAAQJ,IAAIgB,EAAMG,IAzCd6B,CAAoBhC,EAAMW,EAAMC,GACzBZ,EAAKQ,QAKxB,SAAoBR,EAAMW,EAAMC,GAC5B,IAAIxD,EAAW,IAAIyB,OAAOoC,KAC1B7D,EAASqD,KAAKT,EAAK5C,UACnB,IAAIC,EAAa,IAAIwB,OAAOoD,WAC5B5E,EAAWoD,KAAKT,EAAK3C,YACrB,IAAIiD,EAAO,IAAIzB,OAAO+C,MAClBxE,SAAUA,EACVC,WAAYA,EACZsD,KAAMA,EACNC,MAAOA,IAEXhC,EAAMiD,QAAQvB,GACVK,EAAO,IACPxB,EAAO2C,KAAK9B,GACZZ,EAAQJ,IAAIgB,EAAMM,IAlBd4B,CAAWlC,EAAMW,EAAMC,KA+E/BuB,gBArCJ,SAAyBnC,EAAM5C,EAAUG,EAAQ,GACzCyC,EAAKC,gBACQb,EAAQgB,IAAIJ,GAClBzC,GAAOH,SAASqD,KAAKrD,GACrB4C,EAAKQ,QACDpB,EAAQgB,IAAIJ,GAClB5C,SAASqD,KAAKrD","file":"../../physics/CannonPhysics.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    function compose(position, quaternion, array, index) {\r\n        var x = quaternion.x, y = quaternion.y, z = quaternion.z, w = quaternion.w;\r\n        var x2 = x + x, y2 = y + y, z2 = z + z;\r\n        var xx = x * x2, xy = x * y2, xz = x * z2;\r\n        var yy = y * y2, yz = y * z2, zz = z * z2;\r\n        var wx = w * x2, wy = w * y2, wz = w * z2;\r\n        array[index + 0] = 1 - (yy + zz);\r\n        array[index + 1] = xy + wz;\r\n        array[index + 2] = xz - wy;\r\n        array[index + 3] = 0;\r\n        array[index + 4] = xy - wz;\r\n        array[index + 5] = 1 - (xx + zz);\r\n        array[index + 6] = yz + wx;\r\n        array[index + 7] = 0;\r\n        array[index + 8] = xz + wy;\r\n        array[index + 9] = yz - wx;\r\n        array[index + 10] = 1 - (xx + yy);\r\n        array[index + 11] = 0;\r\n        array[index + 12] = position.x;\r\n        array[index + 13] = position.y;\r\n        array[index + 14] = position.z;\r\n        array[index + 15] = 1;\r\n    }\r\n    function CannonPhysics() {\r\n        var frameRate = 60;\r\n        var frameTime = 1 / frameRate;\r\n        var world = new CANNON.World();\r\n        world.gravity.set(0, -9.8, 0);\r\n        world.broadphase = new CANNON.SAPBroadphase(world);\r\n        function getShape(geometry) {\r\n            var parameters = geometry.parameters;\r\n            switch (geometry.type) {\r\n            case 'BoxBufferGeometry':\r\n                var halfExtents = new CANNON.Vec3();\r\n                halfExtents.x = parameters.width !== undefined ? parameters.width / 2 : 0.5;\r\n                halfExtents.y = parameters.height !== undefined ? parameters.height / 2 : 0.5;\r\n                halfExtents.z = parameters.depth !== undefined ? parameters.depth / 2 : 0.5;\r\n                return new CANNON.Box(halfExtents);\r\n            case 'PlaneBufferGeometry':\r\n                return new CANNON.Plane();\r\n            case 'SphereBufferGeometry':\r\n                var radius = parameters.radius;\r\n                return new CANNON.Sphere(radius);\r\n            }\r\n            return null;\r\n        }\r\n        var meshes = [];\r\n        var meshMap = new WeakMap();\r\n        function addMesh(mesh, mass = 0) {\r\n            var shape = getShape(mesh.geometry);\r\n            if (shape !== null) {\r\n                if (mesh.isInstancedMesh) {\r\n                    handleInstancedMesh(mesh, mass, shape);\r\n                } else if (mesh.isMesh) {\r\n                    handleMesh(mesh, mass, shape);\r\n                }\r\n            }\r\n        }\r\n        function handleMesh(mesh, mass, shape) {\r\n            var position = new CANNON.Vec3();\r\n            position.copy(mesh.position);\r\n            var quaternion = new CANNON.Quaternion();\r\n            quaternion.copy(mesh.quaternion);\r\n            var body = new CANNON.Body({\r\n                position: position,\r\n                quaternion: quaternion,\r\n                mass: mass,\r\n                shape: shape\r\n            });\r\n            world.addBody(body);\r\n            if (mass > 0) {\r\n                meshes.push(mesh);\r\n                meshMap.set(mesh, body);\r\n            }\r\n        }\r\n        function handleInstancedMesh(mesh, mass, shape) {\r\n            var array = mesh.instanceMatrix.array;\r\n            var bodies = [];\r\n            for (var i = 0; i < mesh.count; i++) {\r\n                var index = i * 16;\r\n                var position = new CANNON.Vec3();\r\n                position.set(array[index + 12], array[index + 13], array[index + 14]);\r\n                var body = new CANNON.Body({\r\n                    position: position,\r\n                    mass: mass,\r\n                    shape: shape\r\n                });\r\n                world.addBody(body);\r\n                bodies.push(body);\r\n            }\r\n            if (mass > 0) {\r\n                mesh.instanceMatrix.setUsage(35048);\r\n                meshes.push(mesh);\r\n                meshMap.set(mesh, bodies);\r\n            }\r\n        }\r\n        function setMeshPosition(mesh, position, index = 0) {\r\n            if (mesh.isInstancedMesh) {\r\n                var bodies = meshMap.get(mesh);\r\n                bodies[index].position.copy(position);\r\n            } else if (mesh.isMesh) {\r\n                var body = meshMap.get(mesh);\r\n                body.position.copy(position);\r\n            }\r\n        }\r\n        var lastTime = 0;\r\n        function step() {\r\n            var time = performance.now();\r\n            if (lastTime > 0) {\r\n                var delta = (time - lastTime) / 1000;\r\n                world.step(frameTime, delta, frameRate);\r\n            }\r\n            lastTime = time;\r\n            for (var i = 0, l = meshes.length; i < l; i++) {\r\n                var mesh = meshes[i];\r\n                if (mesh.isInstancedMesh) {\r\n                    var array = mesh.instanceMatrix.array;\r\n                    var bodies = meshMap.get(mesh);\r\n                    for (var j = 0; j < bodies.length; j++) {\r\n                        var body = bodies[j];\r\n                        compose(body.position, body.quaternion, array, j * 16);\r\n                    }\r\n                    mesh.instanceMatrix.needsUpdate = true;\r\n                } else if (mesh.isMesh) {\r\n                    var body = meshMap.get(mesh);\r\n                    mesh.position.copy(body.position);\r\n                    mesh.quaternion.copy(body.quaternion);\r\n                }\r\n            }\r\n        }\r\n        setInterval(step, 1000 / frameRate);\r\n        return {\r\n            addMesh: addMesh,\r\n            setMeshPosition: setMeshPosition\r\n        };\r\n    }\r\n    return threex.physics.CannonPhysics = CannonPhysics;\r\n});"]}