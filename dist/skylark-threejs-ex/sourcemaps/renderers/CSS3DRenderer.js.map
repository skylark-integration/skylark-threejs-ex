{"version":3,"sources":["renderers/CSS3DRenderer.js"],"names":["define","THREE","CSS3DObject","element","Object3D","call","this","style","position","pointerEvents","addEventListener","traverse","object","Element","parentNode","removeChild","prototype","Object","create","constructor","CSS3DSprite","CSS3DRenderer","_width","_height","_widthHalf","_heightHalf","_this","matrix","Matrix4","cache","camera","fov","objects","WeakMap","domElement","document","createElement","overflow","cameraElement","WebkitTransformStyle","transformStyle","appendChild","isIE","test","navigator","userAgent","epsilon","value","Math","abs","getCameraCSSMatrix","elements","getObjectCSSMatrix","cameraCSSMatrix","matrix3d","getSize","width","height","setSize","a","b","getDistanceToSquared","Vector3","object1","object2","setFromMatrixPosition","matrixWorld","distanceToSquared","zOrder","scene","sorted","result","push","filterAndFlatten","sort","get","distanceToCameraSquared","zMax","length","i","l","zIndex","render","projectionMatrix","isPerspectiveCamera","WebkitPerspective","perspective","autoUpdate","updateMatrixWorld","parent","isOrthographicCamera","tx","right","left","ty","top","bottom","matrixWorldInverse","WebkitTransform","transform","renderObject","onBeforeRender","copy","transpose","copyPosition","scale","cachedObject","undefined","objectData","set","onAfterRender","children"],"mappings":";;;;;;;AAAAA,QACI,mBACD,SAAUC,GACT,aACA,IAAIC,EAAc,SAAUC,GACxBF,EAAMG,SAASC,KAAKC,MACpBA,KAAKH,QAAUA,EACfG,KAAKH,QAAQI,MAAMC,SAAW,WAC9BF,KAAKH,QAAQI,MAAME,cAAgB,OACnCH,KAAKI,iBAAiB,UAAW,WAC7BJ,KAAKK,SAAS,SAAUC,GAChBA,EAAOT,mBAAmBU,SAAyC,OAA9BD,EAAOT,QAAQW,YACpDF,EAAOT,QAAQW,WAAWC,YAAYH,EAAOT,cAK7DD,EAAYc,UAAYC,OAAOC,OAAOjB,EAAMG,SAASY,WACrDd,EAAYc,UAAUG,YAAcjB,EACpC,IAAIkB,EAAc,SAAUjB,GACxBD,EAAYG,KAAKC,KAAMH,IAE3BiB,EAAYJ,UAAYC,OAAOC,OAAOhB,EAAYc,WAClDI,EAAYJ,UAAUG,YAAcC,EACpC,IAAIC,EAAgB,WAChB,IACIC,EAAQC,EACRC,EAAYC,EAFZC,EAAQpB,KAGRqB,EAAS,IAAI1B,EAAM2B,QACnBC,GACAC,QACIC,IAAK,EACLxB,MAAO,IAEXyB,QAAS,IAAIC,SAEbC,EAAaC,SAASC,cAAc,OACxCF,EAAW3B,MAAM8B,SAAW,SAC5B/B,KAAK4B,WAAaA,EAClB,IAAII,EAAgBH,SAASC,cAAc,OAC3CE,EAAc/B,MAAMgC,qBAAuB,cAC3CD,EAAc/B,MAAMiC,eAAiB,cACrCF,EAAc/B,MAAME,cAAgB,OACpCyB,EAAWO,YAAYH,GACvB,IAAII,EAAO,WAAWC,KAAKC,UAAUC,WAiBrC,SAASC,EAAQC,GACb,OAAOC,KAAKC,IAAIF,GAAS,MAAQ,EAAIA,EAEzC,SAASG,EAAmBvB,GACxB,IAAIwB,EAAWxB,EAAOwB,SACtB,MAAO,YAAcL,EAAQK,EAAS,IAAM,IAAML,GAASK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,GAASK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,GAASK,EAAS,IAAM,IAAML,EAAQK,EAAS,KAAO,IAAML,EAAQK,EAAS,KAAO,IAAML,EAAQK,EAAS,KAAO,IAAML,GAASK,EAAS,KAAO,IAAML,EAAQK,EAAS,KAAO,IAAML,EAAQK,EAAS,KAAO,IAE7e,SAASC,EAAmBzB,EAAQ0B,GAChC,IAAIF,EAAWxB,EAAOwB,SAClBG,EAAW,YAAcR,EAAQK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,GAASK,EAAS,IAAM,IAAML,GAASK,EAAS,IAAM,IAAML,GAASK,EAAS,IAAM,IAAML,GAASK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,EAAQK,EAAS,IAAM,IAAML,EAAQK,EAAS,KAAO,IAAML,EAAQK,EAAS,KAAO,IAAML,EAAQK,EAAS,KAAO,IAAML,EAAQK,EAAS,KAAO,IAAML,EAAQK,EAAS,KAAO,IAAML,EAAQK,EAAS,KAAO,IACjf,OAAIT,EACO,iCAAwClB,EAAa,MAAQC,EAAc,MAAQ4B,EAAkBC,EAEzG,uBAAyBA,EA7BpChD,KAAKiD,QAAU,WACX,OACIC,MAAOlC,EACPmC,OAAQlC,IAGhBjB,KAAKoD,QAAU,SAAUF,EAAOC,GAG5BjC,GAFAF,EAASkC,GAEa,EACtB/B,GAFAF,EAAUkC,GAEc,EACxBvB,EAAW3B,MAAMiD,MAAQA,EAAQ,KACjCtB,EAAW3B,MAAMkD,OAASA,EAAS,KACnCnB,EAAc/B,MAAMiD,MAAQA,EAAQ,KACpClB,EAAc/B,MAAMkD,OAASA,EAAS,MAsD1C,IACQE,EACAC,EAFJC,GACIF,EAAI,IAAI1D,EAAM6D,QACdF,EAAI,IAAI3D,EAAM6D,QACX,SAAUC,EAASC,GAGtB,OAFAL,EAAEM,sBAAsBF,EAAQG,aAChCN,EAAEK,sBAAsBD,EAAQE,aACzBP,EAAEQ,kBAAkBP,KAWnC,SAASQ,EAAOC,GAOZ,IANA,IAAIC,EATR,SAA0BD,GACtB,IAAIE,KAKJ,OAJAF,EAAM1D,SAAS,SAAUC,GACjBA,aAAkBV,GAClBqE,EAAOC,KAAK5D,KAEb2D,EAGME,CAAiBJ,GAAOK,KAAK,SAAUf,EAAGC,GAGnD,OAFgB/B,EAAMG,QAAQ2C,IAAIhB,GAAGiB,wBACrB/C,EAAMG,QAAQ2C,IAAIf,GAAGgB,0BAGrCC,EAAOP,EAAOQ,OACTC,EAAI,EAAGC,EAAIV,EAAOQ,OAAQC,EAAIC,EAAGD,IACtCT,EAAOS,GAAG5E,QAAQI,MAAM0E,OAASJ,EAAOE,EAGhDzE,KAAK4E,OAAS,SAAUb,EAAOvC,GAC3B,IAAIC,EAAMD,EAAOqD,iBAAiBhC,SAAS,GAAK1B,EAehD,GAdII,EAAMC,OAAOC,MAAQA,IACjBD,EAAOsD,qBACPlD,EAAW3B,MAAM8E,kBAAoBtD,EAAM,KAC3CG,EAAW3B,MAAM+E,YAAcvD,EAAM,OAErCG,EAAW3B,MAAM8E,kBAAoB,GACrCnD,EAAW3B,MAAM+E,YAAc,IAEnCzD,EAAMC,OAAOC,IAAMA,IAEE,IAArBsC,EAAMkB,YACNlB,EAAMmB,oBACY,OAAlB1D,EAAO2D,QACP3D,EAAO0D,oBACP1D,EAAO4D,qBACP,IAAIC,IAAO7D,EAAO8D,MAAQ9D,EAAO+D,MAAQ,EACrCC,GAAMhE,EAAOiE,IAAMjE,EAAOkE,QAAU,EAE5C,IAAI3C,EAAkBvB,EAAO4D,qBAAuB,SAAW3D,EAAM,cAAqBe,EAAQ6C,GAAM,MAAQ7C,EAAQgD,GAAM,MAAQ5C,EAAmBpB,EAAOmE,oBAAsB,cAAgBlE,EAAM,MAAQmB,EAAmBpB,EAAOmE,oBAC1O1F,EAAQ8C,EAAkB,aAAe7B,EAAa,MAAQC,EAAc,MAC5EI,EAAMC,OAAOvB,QAAUA,GAAUmC,IACjCJ,EAAc/B,MAAM2F,gBAAkB3F,EACtC+B,EAAc/B,MAAM4F,UAAY5F,EAChCsB,EAAMC,OAAOvB,MAAQA,GA1F7B,SAAS6F,EAAaxF,EAAQyD,EAAOvC,EAAQuB,GACzC,GAAIzC,aAAkBV,EAAa,CAE/B,IAAIK,EADJK,EAAOyF,eAAe3E,EAAO2C,EAAOvC,GAEhClB,aAAkBQ,GAClBO,EAAO2E,KAAKxE,EAAOmE,oBACnBtE,EAAO4E,YACP5E,EAAO6E,aAAa5F,EAAOsD,aAC3BvC,EAAO8E,MAAM7F,EAAO6F,OACpB9E,EAAOwB,SAAS,GAAK,EACrBxB,EAAOwB,SAAS,GAAK,EACrBxB,EAAOwB,SAAS,IAAM,EACtBxB,EAAOwB,SAAS,IAAM,EACtB5C,EAAQ6C,EAAmBzB,EAAQ0B,IAEnC9C,EAAQ6C,EAAmBxC,EAAOsD,YAAab,GAEnD,IAAIlD,EAAUS,EAAOT,QACjBuG,EAAe7E,EAAMG,QAAQ2C,IAAI/D,GACrC,QAAqB+F,IAAjBD,GAA8BA,EAAanG,QAAUA,EAAO,CAC5DJ,EAAQI,MAAM2F,gBAAkB3F,EAChCJ,EAAQI,MAAM4F,UAAY5F,EAC1B,IAAIqG,GAAerG,MAAOA,GACtBmC,IACAkE,EAAWhC,wBAA0Bf,EAAqB/B,EAAQlB,IAEtEiB,EAAMG,QAAQ6E,IAAIjG,EAAQgG,GAE1BzG,EAAQW,aAAewB,GACvBA,EAAcG,YAAYtC,GAE9BS,EAAOkG,cAAcpF,EAAO2C,EAAOvC,GAEvC,IAAK,IAAIiD,EAAI,EAAGC,EAAIpE,EAAOmG,SAASjC,OAAQC,EAAIC,EAAGD,IAC/CqB,EAAaxF,EAAOmG,SAAShC,GAAIV,EAAOvC,EAAQuB,GA0DpD+C,CAAa/B,EAAOA,EAAOvC,EAAQuB,GAC/BX,GACA0B,EAAOC,KAQnB,OAHAhD,EAAcnB,YAAcA,EAC5BmB,EAAcD,YAAcA,EAErBC","file":"../../renderers/CSS3DRenderer.js","sourcesContent":["define([\n    \"skylark-threejs\"\n], function (THREE) {\n    'use strict';\n    var CSS3DObject = function (element) {\n        THREE.Object3D.call(this);\n        this.element = element;\n        this.element.style.position = 'absolute';\n        this.element.style.pointerEvents = 'auto';\n        this.addEventListener('removed', function () {\n            this.traverse(function (object) {\n                if (object.element instanceof Element && object.element.parentNode !== null) {\n                    object.element.parentNode.removeChild(object.element);\n                }\n            });\n        });\n    };\n    CSS3DObject.prototype = Object.create(THREE.Object3D.prototype);\n    CSS3DObject.prototype.constructor = CSS3DObject;\n    var CSS3DSprite = function (element) {\n        CSS3DObject.call(this, element);\n    };\n    CSS3DSprite.prototype = Object.create(CSS3DObject.prototype);\n    CSS3DSprite.prototype.constructor = CSS3DSprite;\n    var CSS3DRenderer = function () {\n        var _this = this;\n        var _width, _height;\n        var _widthHalf, _heightHalf;\n        var matrix = new THREE.Matrix4();\n        var cache = {\n            camera: {\n                fov: 0,\n                style: ''\n            },\n            objects: new WeakMap()\n        };\n        var domElement = document.createElement('div');\n        domElement.style.overflow = 'hidden';\n        this.domElement = domElement;\n        var cameraElement = document.createElement('div');\n        cameraElement.style.WebkitTransformStyle = 'preserve-3d';\n        cameraElement.style.transformStyle = 'preserve-3d';\n        cameraElement.style.pointerEvents = 'none';\n        domElement.appendChild(cameraElement);\n        var isIE = /Trident/i.test(navigator.userAgent);\n        this.getSize = function () {\n            return {\n                width: _width,\n                height: _height\n            };\n        };\n        this.setSize = function (width, height) {\n            _width = width;\n            _height = height;\n            _widthHalf = _width / 2;\n            _heightHalf = _height / 2;\n            domElement.style.width = width + 'px';\n            domElement.style.height = height + 'px';\n            cameraElement.style.width = width + 'px';\n            cameraElement.style.height = height + 'px';\n        };\n        function epsilon(value) {\n            return Math.abs(value) < 1e-10 ? 0 : value;\n        }\n        function getCameraCSSMatrix(matrix) {\n            var elements = matrix.elements;\n            return 'matrix3d(' + epsilon(elements[0]) + ',' + epsilon(-elements[1]) + ',' + epsilon(elements[2]) + ',' + epsilon(elements[3]) + ',' + epsilon(elements[4]) + ',' + epsilon(-elements[5]) + ',' + epsilon(elements[6]) + ',' + epsilon(elements[7]) + ',' + epsilon(elements[8]) + ',' + epsilon(-elements[9]) + ',' + epsilon(elements[10]) + ',' + epsilon(elements[11]) + ',' + epsilon(elements[12]) + ',' + epsilon(-elements[13]) + ',' + epsilon(elements[14]) + ',' + epsilon(elements[15]) + ')';\n        }\n        function getObjectCSSMatrix(matrix, cameraCSSMatrix) {\n            var elements = matrix.elements;\n            var matrix3d = 'matrix3d(' + epsilon(elements[0]) + ',' + epsilon(elements[1]) + ',' + epsilon(elements[2]) + ',' + epsilon(elements[3]) + ',' + epsilon(-elements[4]) + ',' + epsilon(-elements[5]) + ',' + epsilon(-elements[6]) + ',' + epsilon(-elements[7]) + ',' + epsilon(elements[8]) + ',' + epsilon(elements[9]) + ',' + epsilon(elements[10]) + ',' + epsilon(elements[11]) + ',' + epsilon(elements[12]) + ',' + epsilon(elements[13]) + ',' + epsilon(elements[14]) + ',' + epsilon(elements[15]) + ')';\n            if (isIE) {\n                return 'translate(-50%,-50%)' + 'translate(' + _widthHalf + 'px,' + _heightHalf + 'px)' + cameraCSSMatrix + matrix3d;\n            }\n            return 'translate(-50%,-50%)' + matrix3d;\n        }\n        function renderObject(object, scene, camera, cameraCSSMatrix) {\n            if (object instanceof CSS3DObject) {\n                object.onBeforeRender(_this, scene, camera);\n                var style;\n                if (object instanceof CSS3DSprite) {\n                    matrix.copy(camera.matrixWorldInverse);\n                    matrix.transpose();\n                    matrix.copyPosition(object.matrixWorld);\n                    matrix.scale(object.scale);\n                    matrix.elements[3] = 0;\n                    matrix.elements[7] = 0;\n                    matrix.elements[11] = 0;\n                    matrix.elements[15] = 1;\n                    style = getObjectCSSMatrix(matrix, cameraCSSMatrix);\n                } else {\n                    style = getObjectCSSMatrix(object.matrixWorld, cameraCSSMatrix);\n                }\n                var element = object.element;\n                var cachedObject = cache.objects.get(object);\n                if (cachedObject === undefined || cachedObject.style !== style) {\n                    element.style.WebkitTransform = style;\n                    element.style.transform = style;\n                    var objectData = { style: style };\n                    if (isIE) {\n                        objectData.distanceToCameraSquared = getDistanceToSquared(camera, object);\n                    }\n                    cache.objects.set(object, objectData);\n                }\n                if (element.parentNode !== cameraElement) {\n                    cameraElement.appendChild(element);\n                }\n                object.onAfterRender(_this, scene, camera);\n            }\n            for (var i = 0, l = object.children.length; i < l; i++) {\n                renderObject(object.children[i], scene, camera, cameraCSSMatrix);\n            }\n        }\n        var getDistanceToSquared = function () {\n            var a = new THREE.Vector3();\n            var b = new THREE.Vector3();\n            return function (object1, object2) {\n                a.setFromMatrixPosition(object1.matrixWorld);\n                b.setFromMatrixPosition(object2.matrixWorld);\n                return a.distanceToSquared(b);\n            };\n        }();\n        function filterAndFlatten(scene) {\n            var result = [];\n            scene.traverse(function (object) {\n                if (object instanceof CSS3DObject)\n                    result.push(object);\n            });\n            return result;\n        }\n        function zOrder(scene) {\n            var sorted = filterAndFlatten(scene).sort(function (a, b) {\n                var distanceA = cache.objects.get(a).distanceToCameraSquared;\n                var distanceB = cache.objects.get(b).distanceToCameraSquared;\n                return distanceA - distanceB;\n            });\n            var zMax = sorted.length;\n            for (var i = 0, l = sorted.length; i < l; i++) {\n                sorted[i].element.style.zIndex = zMax - i;\n            }\n        }\n        this.render = function (scene, camera) {\n            var fov = camera.projectionMatrix.elements[5] * _heightHalf;\n            if (cache.camera.fov !== fov) {\n                if (camera.isPerspectiveCamera) {\n                    domElement.style.WebkitPerspective = fov + 'px';\n                    domElement.style.perspective = fov + 'px';\n                } else {\n                    domElement.style.WebkitPerspective = '';\n                    domElement.style.perspective = '';\n                }\n                cache.camera.fov = fov;\n            }\n            if (scene.autoUpdate === true)\n                scene.updateMatrixWorld();\n            if (camera.parent === null)\n                camera.updateMatrixWorld();\n            if (camera.isOrthographicCamera) {\n                var tx = -(camera.right + camera.left) / 2;\n                var ty = (camera.top + camera.bottom) / 2;\n            }\n            var cameraCSSMatrix = camera.isOrthographicCamera ? 'scale(' + fov + ')' + 'translate(' + epsilon(tx) + 'px,' + epsilon(ty) + 'px)' + getCameraCSSMatrix(camera.matrixWorldInverse) : 'translateZ(' + fov + 'px)' + getCameraCSSMatrix(camera.matrixWorldInverse);\n            var style = cameraCSSMatrix + 'translate(' + _widthHalf + 'px,' + _heightHalf + 'px)';\n            if (cache.camera.style !== style && !isIE) {\n                cameraElement.style.WebkitTransform = style;\n                cameraElement.style.transform = style;\n                cache.camera.style = style;\n            }\n            renderObject(scene, scene, camera, cameraCSSMatrix);\n            if (isIE) {\n                zOrder(scene);\n            }\n        };\n    };\n\n    CSS3DRenderer.CSS3DObject = CSS3DObject;\n    CSS3DRenderer.CSS3DSprite = CSS3DSprite;\n\n    return CSS3DRenderer;\n});"]}