{"version":3,"sources":["renderers/CSS3DRenderer.js"],"names":["define","THREE","threex","CSS3DObject","element","Object3D","call","this","style","position","pointerEvents","addEventListener","traverse","object","Element","parentNode","removeChild","prototype","Object","create","constructor","CSS3DSprite","CSS3DRenderer","_width","_height","_widthHalf","_heightHalf","_this","matrix","Matrix4","cache","camera","fov","objects","WeakMap","domElement","document","createElement","overflow","cameraElement","WebkitTransformStyle","transformStyle","appendChild","isIE","test","navigator","userAgent","epsilon","value","Math","abs","getCameraCSSMatrix","elements","getObjectCSSMatrix","cameraCSSMatrix","matrix3d","getSize","width","height","setSize","a","b","getDistanceToSquared","Vector3","object1","object2","setFromMatrixPosition","matrixWorld","distanceToSquared","zOrder","scene","sorted","result","push","filterAndFlatten","sort","get","distanceToCameraSquared","zMax","length","i","l","zIndex","render","projectionMatrix","isPerspectiveCamera","WebkitPerspective","perspective","autoUpdate","updateMatrixWorld","parent","isOrthographicCamera","tx","right","left","ty","top","bottom","matrixWorldInverse","WebkitTransform","transform","renderObject","onBeforeRender","copy","transpose","copyPosition","scale","cachedObject","undefined","objectData","set","onAfterRender","children","renderers"],"mappings":"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","file":"../../renderers/CSS3DRenderer.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n    var CSS3DObject = function (element) {\r\n        THREE.Object3D.call(this);\r\n        this.element = element;\r\n        this.element.style.position = 'absolute';\r\n        this.element.style.pointerEvents = 'auto';\r\n        this.addEventListener('removed', function () {\r\n            this.traverse(function (object) {\r\n                if (object.element instanceof Element && object.element.parentNode !== null) {\r\n                    object.element.parentNode.removeChild(object.element);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    CSS3DObject.prototype = Object.create(THREE.Object3D.prototype);\r\n    CSS3DObject.prototype.constructor = CSS3DObject;\r\n    var CSS3DSprite = function (element) {\r\n        CSS3DObject.call(this, element);\r\n    };\r\n    CSS3DSprite.prototype = Object.create(CSS3DObject.prototype);\r\n    CSS3DSprite.prototype.constructor = CSS3DSprite;\r\n    var CSS3DRenderer = function () {\r\n        var _this = this;\r\n        var _width, _height;\r\n        var _widthHalf, _heightHalf;\r\n        var matrix = new THREE.Matrix4();\r\n        var cache = {\r\n            camera: {\r\n                fov: 0,\r\n                style: ''\r\n            },\r\n            objects: new WeakMap()\r\n        };\r\n        var domElement = document.createElement('div');\r\n        domElement.style.overflow = 'hidden';\r\n        this.domElement = domElement;\r\n        var cameraElement = document.createElement('div');\r\n        cameraElement.style.WebkitTransformStyle = 'preserve-3d';\r\n        cameraElement.style.transformStyle = 'preserve-3d';\r\n        cameraElement.style.pointerEvents = 'none';\r\n        domElement.appendChild(cameraElement);\r\n        var isIE = /Trident/i.test(navigator.userAgent);\r\n        this.getSize = function () {\r\n            return {\r\n                width: _width,\r\n                height: _height\r\n            };\r\n        };\r\n        this.setSize = function (width, height) {\r\n            _width = width;\r\n            _height = height;\r\n            _widthHalf = _width / 2;\r\n            _heightHalf = _height / 2;\r\n            domElement.style.width = width + 'px';\r\n            domElement.style.height = height + 'px';\r\n            cameraElement.style.width = width + 'px';\r\n            cameraElement.style.height = height + 'px';\r\n        };\r\n        function epsilon(value) {\r\n            return Math.abs(value) < 1e-10 ? 0 : value;\r\n        }\r\n        function getCameraCSSMatrix(matrix) {\r\n            var elements = matrix.elements;\r\n            return 'matrix3d(' + epsilon(elements[0]) + ',' + epsilon(-elements[1]) + ',' + epsilon(elements[2]) + ',' + epsilon(elements[3]) + ',' + epsilon(elements[4]) + ',' + epsilon(-elements[5]) + ',' + epsilon(elements[6]) + ',' + epsilon(elements[7]) + ',' + epsilon(elements[8]) + ',' + epsilon(-elements[9]) + ',' + epsilon(elements[10]) + ',' + epsilon(elements[11]) + ',' + epsilon(elements[12]) + ',' + epsilon(-elements[13]) + ',' + epsilon(elements[14]) + ',' + epsilon(elements[15]) + ')';\r\n        }\r\n        function getObjectCSSMatrix(matrix, cameraCSSMatrix) {\r\n            var elements = matrix.elements;\r\n            var matrix3d = 'matrix3d(' + epsilon(elements[0]) + ',' + epsilon(elements[1]) + ',' + epsilon(elements[2]) + ',' + epsilon(elements[3]) + ',' + epsilon(-elements[4]) + ',' + epsilon(-elements[5]) + ',' + epsilon(-elements[6]) + ',' + epsilon(-elements[7]) + ',' + epsilon(elements[8]) + ',' + epsilon(elements[9]) + ',' + epsilon(elements[10]) + ',' + epsilon(elements[11]) + ',' + epsilon(elements[12]) + ',' + epsilon(elements[13]) + ',' + epsilon(elements[14]) + ',' + epsilon(elements[15]) + ')';\r\n            if (isIE) {\r\n                return 'translate(-50%,-50%)' + 'translate(' + _widthHalf + 'px,' + _heightHalf + 'px)' + cameraCSSMatrix + matrix3d;\r\n            }\r\n            return 'translate(-50%,-50%)' + matrix3d;\r\n        }\r\n        function renderObject(object, scene, camera, cameraCSSMatrix) {\r\n            if (object instanceof CSS3DObject) {\r\n                object.onBeforeRender(_this, scene, camera);\r\n                var style;\r\n                if (object instanceof CSS3DSprite) {\r\n                    matrix.copy(camera.matrixWorldInverse);\r\n                    matrix.transpose();\r\n                    matrix.copyPosition(object.matrixWorld);\r\n                    matrix.scale(object.scale);\r\n                    matrix.elements[3] = 0;\r\n                    matrix.elements[7] = 0;\r\n                    matrix.elements[11] = 0;\r\n                    matrix.elements[15] = 1;\r\n                    style = getObjectCSSMatrix(matrix, cameraCSSMatrix);\r\n                } else {\r\n                    style = getObjectCSSMatrix(object.matrixWorld, cameraCSSMatrix);\r\n                }\r\n                var element = object.element;\r\n                var cachedObject = cache.objects.get(object);\r\n                if (cachedObject === undefined || cachedObject.style !== style) {\r\n                    element.style.WebkitTransform = style;\r\n                    element.style.transform = style;\r\n                    var objectData = { style: style };\r\n                    if (isIE) {\r\n                        objectData.distanceToCameraSquared = getDistanceToSquared(camera, object);\r\n                    }\r\n                    cache.objects.set(object, objectData);\r\n                }\r\n                if (element.parentNode !== cameraElement) {\r\n                    cameraElement.appendChild(element);\r\n                }\r\n                object.onAfterRender(_this, scene, camera);\r\n            }\r\n            for (var i = 0, l = object.children.length; i < l; i++) {\r\n                renderObject(object.children[i], scene, camera, cameraCSSMatrix);\r\n            }\r\n        }\r\n        var getDistanceToSquared = function () {\r\n            var a = new THREE.Vector3();\r\n            var b = new THREE.Vector3();\r\n            return function (object1, object2) {\r\n                a.setFromMatrixPosition(object1.matrixWorld);\r\n                b.setFromMatrixPosition(object2.matrixWorld);\r\n                return a.distanceToSquared(b);\r\n            };\r\n        }();\r\n        function filterAndFlatten(scene) {\r\n            var result = [];\r\n            scene.traverse(function (object) {\r\n                if (object instanceof CSS3DObject)\r\n                    result.push(object);\r\n            });\r\n            return result;\r\n        }\r\n        function zOrder(scene) {\r\n            var sorted = filterAndFlatten(scene).sort(function (a, b) {\r\n                var distanceA = cache.objects.get(a).distanceToCameraSquared;\r\n                var distanceB = cache.objects.get(b).distanceToCameraSquared;\r\n                return distanceA - distanceB;\r\n            });\r\n            var zMax = sorted.length;\r\n            for (var i = 0, l = sorted.length; i < l; i++) {\r\n                sorted[i].element.style.zIndex = zMax - i;\r\n            }\r\n        }\r\n        this.render = function (scene, camera) {\r\n            var fov = camera.projectionMatrix.elements[5] * _heightHalf;\r\n            if (cache.camera.fov !== fov) {\r\n                if (camera.isPerspectiveCamera) {\r\n                    domElement.style.WebkitPerspective = fov + 'px';\r\n                    domElement.style.perspective = fov + 'px';\r\n                } else {\r\n                    domElement.style.WebkitPerspective = '';\r\n                    domElement.style.perspective = '';\r\n                }\r\n                cache.camera.fov = fov;\r\n            }\r\n            if (scene.autoUpdate === true)\r\n                scene.updateMatrixWorld();\r\n            if (camera.parent === null)\r\n                camera.updateMatrixWorld();\r\n            if (camera.isOrthographicCamera) {\r\n                var tx = -(camera.right + camera.left) / 2;\r\n                var ty = (camera.top + camera.bottom) / 2;\r\n            }\r\n            var cameraCSSMatrix = camera.isOrthographicCamera ? 'scale(' + fov + ')' + 'translate(' + epsilon(tx) + 'px,' + epsilon(ty) + 'px)' + getCameraCSSMatrix(camera.matrixWorldInverse) : 'translateZ(' + fov + 'px)' + getCameraCSSMatrix(camera.matrixWorldInverse);\r\n            var style = cameraCSSMatrix + 'translate(' + _widthHalf + 'px,' + _heightHalf + 'px)';\r\n            if (cache.camera.style !== style && !isIE) {\r\n                cameraElement.style.WebkitTransform = style;\r\n                cameraElement.style.transform = style;\r\n                cache.camera.style = style;\r\n            }\r\n            renderObject(scene, scene, camera, cameraCSSMatrix);\r\n            if (isIE) {\r\n                zOrder(scene);\r\n            }\r\n        };\r\n    };\r\n\r\n    CSS3DRenderer.CSS3DObject = CSS3DObject;\r\n    CSS3DRenderer.CSS3DSprite = CSS3DSprite;\r\n\r\n    return threex.renderers.CSS3DRenderer = CSS3DRenderer;\r\n});"]}