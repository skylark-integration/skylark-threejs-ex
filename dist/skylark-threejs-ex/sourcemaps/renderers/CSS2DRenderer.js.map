{"version":3,"sources":["renderers/CSS2DRenderer.js"],"names":["define","THREE","threex","CSS2DObject","element","Object3D","call","this","style","position","addEventListener","traverse","object","Element","parentNode","removeChild","prototype","Object","create","constructor","CSS2DRenderer","_width","_height","_widthHalf","_heightHalf","_this","vector","Vector3","viewMatrix","Matrix4","viewProjectionMatrix","cache","objects","WeakMap","domElement","document","createElement","overflow","getSize","width","height","setSize","a","b","renderObject","scene","camera","onBeforeRender","setFromMatrixPosition","matrixWorld","applyMatrix4","x","y","WebkitTransform","MozTransform","oTransform","transform","display","visible","z","objectData","distanceToCameraSquared","getDistanceToSquared","set","appendChild","onAfterRender","i","l","children","length","object1","object2","distanceToSquared","zOrder","sorted","result","push","filterAndFlatten","sort","get","zMax","zIndex","render","autoUpdate","updateMatrixWorld","parent","copy","matrixWorldInverse","multiplyMatrices","projectionMatrix","renderers"],"mappings":"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","file":"../../renderers/CSS2DRenderer.js","sourcesContent":["define([\r\n    \"skylark-threejs\",\r\n    \"../threex\"\r\n], function (\r\n    THREE,\r\n    threex\r\n) {\r\n    'use strict';\r\n\r\n    var CSS2DObject = function (element) {\r\n        THREE.Object3D.call(this);\r\n        this.element = element;\r\n        this.element.style.position = 'absolute';\r\n        this.addEventListener('removed', function () {\r\n            this.traverse(function (object) {\r\n                if (object.element instanceof Element && object.element.parentNode !== null) {\r\n                    object.element.parentNode.removeChild(object.element);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    CSS2DObject.prototype = Object.create(THREE.Object3D.prototype);\r\n    CSS2DObject.prototype.constructor = CSS2DObject;\r\n\r\n\r\n    var CSS2DRenderer = function () {\r\n        var _this = this;\r\n        var _width, _height;\r\n        var _widthHalf, _heightHalf;\r\n        var vector = new THREE.Vector3();\r\n        var viewMatrix = new THREE.Matrix4();\r\n        var viewProjectionMatrix = new THREE.Matrix4();\r\n        var cache = { objects: new WeakMap() };\r\n        var domElement = document.createElement('div');\r\n        domElement.style.overflow = 'hidden';\r\n        this.domElement = domElement;\r\n        this.getSize = function () {\r\n            return {\r\n                width: _width,\r\n                height: _height\r\n            };\r\n        };\r\n        this.setSize = function (width, height) {\r\n            _width = width;\r\n            _height = height;\r\n            _widthHalf = _width / 2;\r\n            _heightHalf = _height / 2;\r\n            domElement.style.width = width + 'px';\r\n            domElement.style.height = height + 'px';\r\n        };\r\n        var renderObject = function (object, scene, camera) {\r\n            if (object instanceof CSS2DObject) {\r\n                object.onBeforeRender(_this, scene, camera);\r\n                vector.setFromMatrixPosition(object.matrixWorld);\r\n                vector.applyMatrix4(viewProjectionMatrix);\r\n                var element = object.element;\r\n                var style = 'translate(-50%,-50%) translate(' + (vector.x * _widthHalf + _widthHalf) + 'px,' + (-vector.y * _heightHalf + _heightHalf) + 'px)';\r\n                element.style.WebkitTransform = style;\r\n                element.style.MozTransform = style;\r\n                element.style.oTransform = style;\r\n                element.style.transform = style;\r\n                element.style.display = object.visible && vector.z >= -1 && vector.z <= 1 ? '' : 'none';\r\n                var objectData = { distanceToCameraSquared: getDistanceToSquared(camera, object) };\r\n                cache.objects.set(object, objectData);\r\n                if (element.parentNode !== domElement) {\r\n                    domElement.appendChild(element);\r\n                }\r\n                object.onAfterRender(_this, scene, camera);\r\n            }\r\n            for (var i = 0, l = object.children.length; i < l; i++) {\r\n                renderObject(object.children[i], scene, camera);\r\n            }\r\n        };\r\n        var getDistanceToSquared = function () {\r\n            var a = new THREE.Vector3();\r\n            var b = new THREE.Vector3();\r\n            return function (object1, object2) {\r\n                a.setFromMatrixPosition(object1.matrixWorld);\r\n                b.setFromMatrixPosition(object2.matrixWorld);\r\n                return a.distanceToSquared(b);\r\n            };\r\n        }();\r\n        var filterAndFlatten = function (scene) {\r\n            var result = [];\r\n            scene.traverse(function (object) {\r\n                if (object instanceof CSS2DObject)\r\n                    result.push(object);\r\n            });\r\n            return result;\r\n        };\r\n        var zOrder = function (scene) {\r\n            var sorted = filterAndFlatten(scene).sort(function (a, b) {\r\n                var distanceA = cache.objects.get(a).distanceToCameraSquared;\r\n                var distanceB = cache.objects.get(b).distanceToCameraSquared;\r\n                return distanceA - distanceB;\r\n            });\r\n            var zMax = sorted.length;\r\n            for (var i = 0, l = sorted.length; i < l; i++) {\r\n                sorted[i].element.style.zIndex = zMax - i;\r\n            }\r\n        };\r\n        this.render = function (scene, camera) {\r\n            if (scene.autoUpdate === true)\r\n                scene.updateMatrixWorld();\r\n            if (camera.parent === null)\r\n                camera.updateMatrixWorld();\r\n            viewMatrix.copy(camera.matrixWorldInverse);\r\n            viewProjectionMatrix.multiplyMatrices(camera.projectionMatrix, viewMatrix);\r\n            renderObject(scene, scene, camera);\r\n            zOrder(scene);\r\n        };\r\n    };\r\n\r\n    CSS2DRenderer.CSS2DObject = CSS2DObject;\r\n    \r\n    return   threex.renderers.CSS2DRenderer = CSS2DRenderer;\r\n});"]}