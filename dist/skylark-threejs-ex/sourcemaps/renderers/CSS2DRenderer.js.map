{"version":3,"sources":["renderers/CSS2DRenderer.js"],"names":["define","THREE","CSS2DObject","element","Object3D","call","this","style","position","addEventListener","traverse","object","Element","parentNode","removeChild","prototype","Object","create","constructor","CSS2DRenderer","_width","_height","_widthHalf","_heightHalf","_this","vector","Vector3","viewMatrix","Matrix4","viewProjectionMatrix","cache","objects","WeakMap","domElement","document","createElement","overflow","getSize","width","height","setSize","a","b","renderObject","scene","camera","onBeforeRender","setFromMatrixPosition","matrixWorld","applyMatrix4","x","y","WebkitTransform","MozTransform","oTransform","transform","display","visible","z","objectData","distanceToCameraSquared","getDistanceToSquared","set","appendChild","onAfterRender","i","l","children","length","object1","object2","distanceToSquared","zOrder","sorted","result","push","filterAndFlatten","sort","get","zMax","zIndex","render","autoUpdate","updateMatrixWorld","parent","copy","matrixWorldInverse","multiplyMatrices","projectionMatrix"],"mappings":"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","file":"../../renderers/CSS2DRenderer.js","sourcesContent":["define([\n    \"skylark-threejs\"\n], function (THREE) {\n    'use strict';\n\n    var CSS2DObject = function (element) {\n        THREE.Object3D.call(this);\n        this.element = element;\n        this.element.style.position = 'absolute';\n        this.addEventListener('removed', function () {\n            this.traverse(function (object) {\n                if (object.element instanceof Element && object.element.parentNode !== null) {\n                    object.element.parentNode.removeChild(object.element);\n                }\n            });\n        });\n    };\n    CSS2DObject.prototype = Object.create(THREE.Object3D.prototype);\n    CSS2DObject.prototype.constructor = CSS2DObject;\n\n\n    var CSS2DRenderer = function () {\n        var _this = this;\n        var _width, _height;\n        var _widthHalf, _heightHalf;\n        var vector = new THREE.Vector3();\n        var viewMatrix = new THREE.Matrix4();\n        var viewProjectionMatrix = new THREE.Matrix4();\n        var cache = { objects: new WeakMap() };\n        var domElement = document.createElement('div');\n        domElement.style.overflow = 'hidden';\n        this.domElement = domElement;\n        this.getSize = function () {\n            return {\n                width: _width,\n                height: _height\n            };\n        };\n        this.setSize = function (width, height) {\n            _width = width;\n            _height = height;\n            _widthHalf = _width / 2;\n            _heightHalf = _height / 2;\n            domElement.style.width = width + 'px';\n            domElement.style.height = height + 'px';\n        };\n        var renderObject = function (object, scene, camera) {\n            if (object instanceof CSS2DObject) {\n                object.onBeforeRender(_this, scene, camera);\n                vector.setFromMatrixPosition(object.matrixWorld);\n                vector.applyMatrix4(viewProjectionMatrix);\n                var element = object.element;\n                var style = 'translate(-50%,-50%) translate(' + (vector.x * _widthHalf + _widthHalf) + 'px,' + (-vector.y * _heightHalf + _heightHalf) + 'px)';\n                element.style.WebkitTransform = style;\n                element.style.MozTransform = style;\n                element.style.oTransform = style;\n                element.style.transform = style;\n                element.style.display = object.visible && vector.z >= -1 && vector.z <= 1 ? '' : 'none';\n                var objectData = { distanceToCameraSquared: getDistanceToSquared(camera, object) };\n                cache.objects.set(object, objectData);\n                if (element.parentNode !== domElement) {\n                    domElement.appendChild(element);\n                }\n                object.onAfterRender(_this, scene, camera);\n            }\n            for (var i = 0, l = object.children.length; i < l; i++) {\n                renderObject(object.children[i], scene, camera);\n            }\n        };\n        var getDistanceToSquared = function () {\n            var a = new THREE.Vector3();\n            var b = new THREE.Vector3();\n            return function (object1, object2) {\n                a.setFromMatrixPosition(object1.matrixWorld);\n                b.setFromMatrixPosition(object2.matrixWorld);\n                return a.distanceToSquared(b);\n            };\n        }();\n        var filterAndFlatten = function (scene) {\n            var result = [];\n            scene.traverse(function (object) {\n                if (object instanceof CSS2DObject)\n                    result.push(object);\n            });\n            return result;\n        };\n        var zOrder = function (scene) {\n            var sorted = filterAndFlatten(scene).sort(function (a, b) {\n                var distanceA = cache.objects.get(a).distanceToCameraSquared;\n                var distanceB = cache.objects.get(b).distanceToCameraSquared;\n                return distanceA - distanceB;\n            });\n            var zMax = sorted.length;\n            for (var i = 0, l = sorted.length; i < l; i++) {\n                sorted[i].element.style.zIndex = zMax - i;\n            }\n        };\n        this.render = function (scene, camera) {\n            if (scene.autoUpdate === true)\n                scene.updateMatrixWorld();\n            if (camera.parent === null)\n                camera.updateMatrixWorld();\n            viewMatrix.copy(camera.matrixWorldInverse);\n            viewProjectionMatrix.multiplyMatrices(camera.projectionMatrix, viewMatrix);\n            renderObject(scene, scene, camera);\n            zOrder(scene);\n        };\n    };\n\n    CSS2DRenderer.CSS2DObject = CSS2DObject;\n    \n    return   CSS2DRenderer;\n});"]}